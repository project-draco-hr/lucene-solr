{
  Codec cp=_TestUtil.alwaysPostingsFormat(new NestedPulsingPostingsFormat());
  MockDirectoryWrapper dir=newDirectory();
  dir.setCheckIndexOnClose(false);
  RandomIndexWriter iw=new RandomIndexWriter(random,dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setCodec(cp));
  Document doc=new Document();
  doc.add(new Field("foo","a b b c c c d e f g g g h i i j j k l l m m m",TextField.TYPE_UNSTORED));
  iw.addDocument(doc);
  IndexReader ir=iw.getReader();
  iw.close();
  IndexReader segment=ir.getSequentialSubReaders()[0];
  DocsEnum reuse=null;
  Map<DocsEnum,Boolean> allEnums=new IdentityHashMap<DocsEnum,Boolean>();
  TermsEnum te=segment.terms("foo").iterator(null);
  while (te.next() != null) {
    reuse=te.docs(null,reuse,false);
    allEnums.put(reuse,true);
  }
  assertEquals(4,allEnums.size());
  allEnums.clear();
  DocsAndPositionsEnum posReuse=null;
  te=segment.terms("foo").iterator(null);
  while (te.next() != null) {
    posReuse=te.docsAndPositions(null,posReuse);
    allEnums.put(posReuse,true);
  }
  assertEquals(4,allEnums.size());
  ir.close();
  CheckIndex ci=new CheckIndex(dir);
  ci.checkIndex(null);
  dir.close();
}
