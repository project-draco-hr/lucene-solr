{
  int code=500;
  if (ex instanceof SolrException) {
    SolrException solrExc=(SolrException)ex;
    code=solrExc.code();
    NamedList<String> errorMetadata=solrExc.getMetadata();
    if (errorMetadata == null) {
      errorMetadata=new NamedList<>();
    }
    errorMetadata.add(SolrException.ERROR_CLASS,ex.getClass().getName());
    errorMetadata.add(SolrException.ROOT_ERROR_CLASS,SolrException.getRootCause(ex).getClass().getName());
    info.add("metadata",errorMetadata);
  }
  for (Throwable th=ex; th != null; th=th.getCause()) {
    String msg=th.getMessage();
    if (msg != null) {
      info.add("msg",msg);
      break;
    }
  }
  if (code == 500 || code < 100) {
    StringWriter sw=new StringWriter();
    ex.printStackTrace(new PrintWriter(sw));
    SolrException.log(log,null,ex);
    info.add("trace",sw.toString());
    if (code < 100) {
      log.warn("invalid return code: " + code);
      code=500;
    }
  }
  info.add("code",code);
  return code;
}
