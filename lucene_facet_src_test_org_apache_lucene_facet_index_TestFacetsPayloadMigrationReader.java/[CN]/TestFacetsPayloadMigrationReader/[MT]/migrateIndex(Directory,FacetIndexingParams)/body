{
  final Map<String,Term> fieldTerms=FacetsPayloadMigrationReader.buildFieldTermsMap(indexDir,fip);
  DirectoryReader reader=DirectoryReader.open(indexDir);
  List<AtomicReaderContext> leaves=reader.leaves();
  int numReaders=leaves.size();
  AtomicReader wrappedLeaves[]=new AtomicReader[numReaders];
  for (int i=0; i < numReaders; i++) {
    wrappedLeaves[i]=new FacetsPayloadMigrationReader(leaves.get(i).reader(),fieldTerms);
  }
  IndexWriter writer=new IndexWriter(indexDir,newIndexWriterConfig(TEST_VERSION_CURRENT,null));
  writer.deleteAll();
  try {
    writer.addIndexes(new MultiReader(wrappedLeaves));
    writer.commit();
  }
  finally {
    reader.close();
    writer.close();
  }
}
