{
  ThreadState state=acquireThreadState(documentsWriter,doc);
  boolean success=false;
  try {
    T result=task.process(state.perThread);
    success=true;
    return result;
  }
  finally {
    boolean abort=false;
    if (!success && state.perThread.aborting) {
      state.perThread.aborting=false;
      abort=true;
    }
    returnDocumentsWriterPerThread(state,task.doClearThreadBindings());
    if (abort) {
      documentsWriter.abort();
    }
  }
}
