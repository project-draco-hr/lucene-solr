{
  Map<String,Document> docs=new HashMap<>();
  IndexWriter w=RandomIndexWriter.mockIndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setOpenMode(OpenMode.CREATE).setRAMBufferSizeMB(0.1).setMaxBufferedDocs(maxBufferedDocs).setMergePolicy(newLogMergePolicy()),new YieldTestPoint());
  w.commit();
  LogMergePolicy lmp=(LogMergePolicy)w.getConfig().getMergePolicy();
  lmp.setNoCFSRatio(0.0);
  lmp.setMergeFactor(mergeFactor);
  threads=new IndexingThread[nThreads];
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=new IndexingThread();
    th.w=w;
    th.base=1000000 * i;
    th.range=range;
    th.iterations=iterations;
    threads[i]=th;
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].start();
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].join();
  }
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=threads[i];
synchronized (th) {
      docs.putAll(th.docs);
    }
  }
  TestUtil.checkIndex(dir);
  DocsAndWriter dw=new DocsAndWriter();
  dw.docs=docs;
  dw.writer=w;
  return dw;
}
