{
  checkRequired(message,COLLECTION_PROP,SHARD_ID_PROP,REPLICA_PROP);
  String collectionName=message.getStr(COLLECTION_PROP);
  String shard=message.getStr(SHARD_ID_PROP);
  String replicaName=message.getStr(REPLICA_PROP);
  DocCollection coll=clusterState.getCollection(collectionName);
  Slice slice=coll.getSlice(shard);
  if (slice == null) {
    throw new SolrException(ErrorCode.BAD_REQUEST,"Invalid shard name : " + shard + " in collection : "+ collectionName);
  }
  Replica replica=slice.getReplica(replicaName);
  if (replica == null) {
    ArrayList<String> l=new ArrayList<>();
    for (    Replica r : slice.getReplicas())     l.add(r.getName());
    throw new SolrException(ErrorCode.BAD_REQUEST,"Invalid replica : " + replicaName + " in shard/collection : "+ shard+ "/"+ collectionName+ " available replicas are "+ StrUtils.join(l,','));
  }
  if (Boolean.parseBoolean(message.getStr(ONLY_IF_DOWN)) && replica.getState() != Replica.State.DOWN) {
    throw new SolrException(ErrorCode.BAD_REQUEST,"Attempted to remove replica : " + collectionName + "/"+ shard+ "/"+ replicaName+ " with onlyIfDown='true', but state is '"+ replica.getStr(ZkStateReader.STATE_PROP)+ "'");
  }
  ShardHandler shardHandler=shardHandlerFactory.getShardHandler();
  String core=replica.getStr(ZkStateReader.CORE_NAME_PROP);
  String asyncId=message.getStr(ASYNC);
  Map<String,String> requestMap=null;
  if (asyncId != null) {
    requestMap=new HashMap<>(1,1.0f);
  }
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.add(CoreAdminParams.ACTION,CoreAdminAction.UNLOAD.toString());
  params.add(CoreAdminParams.CORE,core);
  params.add(CoreAdminParams.DELETE_INSTANCE_DIR,"true");
  params.add(CoreAdminParams.DELETE_DATA_DIR,"true");
  sendShardRequest(replica.getNodeName(),params,shardHandler,asyncId,requestMap);
  processResponses(results,shardHandler,false,null,asyncId,requestMap);
  if (waitForCoreNodeGone(collectionName,shard,replicaName,5000))   return;
  deleteCoreNode(collectionName,replicaName,replica,core);
  if (waitForCoreNodeGone(collectionName,shard,replicaName,30000))   return;
  throw new SolrException(ErrorCode.SERVER_ERROR,"Could not  remove replica : " + collectionName + "/"+ shard+ "/"+ replicaName);
}
