{
  final String collectionName=message.getStr(COLLECTION_PROP);
  long now=System.nanoTime();
  long timeout=now + TimeUnit.NANOSECONDS.convert(30,TimeUnit.SECONDS);
  boolean firstLoop=true;
  while (System.nanoTime() < timeout) {
    DocCollection collection=zkStateReader.getClusterState().getCollection(collectionName);
    if (collection == null) {
      throw new SolrException(ErrorCode.BAD_REQUEST,"Collection: " + collectionName + " not found");
    }
    if (collection.getStateFormat() == 2) {
      results.add("success",new SimpleOrderedMap<>());
      return;
    }
    if (firstLoop) {
      firstLoop=false;
      ZkNodeProps m=new ZkNodeProps(Overseer.QUEUE_OPERATION,MIGRATESTATEFORMAT.toLower(),COLLECTION_PROP,collectionName);
      Overseer.getInQueue(zkStateReader.getZkClient()).offer(Utils.toJSON(m));
    }
    Thread.sleep(100);
  }
  throw new SolrException(ErrorCode.SERVER_ERROR,"Could not migrate state format for collection: " + collectionName);
}
