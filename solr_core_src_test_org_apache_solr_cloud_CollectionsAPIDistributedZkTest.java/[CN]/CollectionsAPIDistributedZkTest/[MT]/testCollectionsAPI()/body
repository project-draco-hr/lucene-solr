{
  boolean disableLegacy=random().nextBoolean();
  CloudSolrClient client1=null;
  if (disableLegacy) {
    log.info("legacyCloud=false");
    client1=createCloudClient(null);
    setClusterProp(client1,ZkStateReader.LEGACY_CLOUD,"false");
  }
  Map<String,List<Integer>> collectionInfos=new HashMap<>();
  int cnt=random().nextInt(TEST_NIGHTLY ? 6 : 1) + 1;
  for (int i=0; i < cnt; i++) {
    int numShards=TestUtil.nextInt(random(),0,shardCount) + 1;
    int replicationFactor=TestUtil.nextInt(random(),0,3) + 1;
    int maxShardsPerNode=(((numShards * replicationFactor) / getCommonCloudSolrClient().getZkStateReader().getClusterState().getLiveNodes().size())) + 1;
    CloudSolrClient client=null;
    try {
      if (i == 0) {
        client=createCloudClient(null);
      }
 else       if (i == 1) {
        client=createCloudClient("awholynewcollection_" + i);
      }
      if (secondConfigSet) {
        createCollection(collectionInfos,"awholynewcollection_" + i,numShards,replicationFactor,maxShardsPerNode,client,null,"conf2");
      }
 else {
        createCollection(collectionInfos,"awholynewcollection_" + i,numShards,replicationFactor,maxShardsPerNode,client,null);
      }
    }
  finally {
      if (client != null)       client.shutdown();
    }
  }
  Set<Entry<String,List<Integer>>> collectionInfosEntrySet=collectionInfos.entrySet();
  for (  Entry<String,List<Integer>> entry : collectionInfosEntrySet) {
    String collection=entry.getKey();
    List<Integer> list=entry.getValue();
    checkForCollection(collection,list,null);
    String url=getUrlFromZk(collection);
    HttpSolrClient collectionClient=new HttpSolrClient(url);
    waitForNon403or404or503(collectionClient);
    collectionClient.shutdown();
  }
  if (random().nextBoolean()) {
    JettySolrRunner jetty=jettys.get(random().nextInt(jettys.size()));
    ChaosMonkey.stop(jetty);
    ChaosMonkey.start(jetty);
    for (    Entry<String,List<Integer>> entry : collectionInfosEntrySet) {
      String collection=entry.getKey();
      List<Integer> list=entry.getValue();
      checkForCollection(collection,list,null);
      String url=getUrlFromZk(collection);
      HttpSolrClient collectionClient=new HttpSolrClient(url);
      waitForNon403or404or503(collectionClient);
      collectionClient.shutdown();
    }
  }
  if (random().nextBoolean()) {
    zkServer.shutdown();
    zkServer=new ZkTestServer(zkServer.getZkDir(),zkServer.getPort());
    zkServer.run();
  }
  if (random().nextBoolean()) {
    JettySolrRunner jetty=jettys.get(random().nextInt(jettys.size()));
    ChaosMonkey.causeConnectionLoss(jetty);
  }
  ZkStateReader zkStateReader=getCommonCloudSolrClient().getZkStateReader();
  for (int j=0; j < cnt; j++) {
    waitForRecoveriesToFinish("awholynewcollection_" + j,zkStateReader,false);
    if (secondConfigSet) {
      byte[] data=zkStateReader.getZkClient().getData(ZkStateReader.COLLECTIONS_ZKNODE + "/" + "awholynewcollection_"+ j,null,null,true);
      assertNotNull(data);
      ZkNodeProps props=ZkNodeProps.load(data);
      String configName=props.getStr(ZkController.CONFIGNAME_PROP);
      assertEquals("conf2",configName);
    }
  }
  checkInstanceDirs(jettys.get(0));
  List<String> collectionNameList=new ArrayList<>();
  collectionNameList.addAll(collectionInfos.keySet());
  String collectionName=collectionNameList.get(random().nextInt(collectionNameList.size()));
  String url=getUrlFromZk(collectionName);
  HttpSolrClient collectionClient=new HttpSolrClient(url);
  SolrInputDocument doc1=getDoc(id,6,i1,-600,tlong,600,t1,"humpty dumpy sat on a wall");
  SolrInputDocument doc2=getDoc(id,7,i1,-600,tlong,600,t1,"humpty dumpy3 sat on a walls");
  SolrInputDocument doc3=getDoc(id,8,i1,-600,tlong,600,t1,"humpty dumpy2 sat on a walled");
  collectionClient.add(doc1);
  collectionClient.add(doc2);
  collectionClient.add(doc3);
  collectionClient.commit();
  assertEquals(3,collectionClient.query(new SolrQuery("*:*")).getResults().getNumFound());
  collectionClient.shutdown();
  collectionClient=null;
  Map<String,Long> urlToTimeBefore=new HashMap<>();
  collectStartTimes(collectionName,urlToTimeBefore);
  assertTrue(urlToTimeBefore.size() > 0);
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set("action",CollectionAction.RELOAD.toString());
  params.set("name",collectionName);
  QueryRequest request=new QueryRequest(params);
  request.setPath("/admin/collections");
  final String baseUrl=getBaseUrl((HttpSolrClient)clients.get(0));
  makeRequest(baseUrl,request);
  boolean allTimesAreCorrect=waitForReloads(collectionName,urlToTimeBefore);
  assertTrue("some core start times did not change on reload",allTimesAreCorrect);
  waitForRecoveriesToFinish("awholynewcollection_" + (cnt - 1),zkStateReader,false);
  params=new ModifiableSolrParams();
  params.set("action",CollectionAction.DELETE.toString());
  params.set("name",collectionName);
  request=new QueryRequest(params);
  request.setPath("/admin/collections");
  makeRequest(baseUrl,request);
  checkForMissingCollection(collectionName);
  params=new ModifiableSolrParams();
  params.set("action",CollectionAction.DELETE.toString());
  params.set("name","unknown_collection");
  request=new QueryRequest(params);
  request.setPath("/admin/collections");
  boolean exp=false;
  try {
    makeRequest(baseUrl,request);
  }
 catch (  SolrException e) {
    exp=true;
  }
  assertTrue("Expected exception",exp);
  params=new ModifiableSolrParams();
  params.set("action",CollectionAction.CREATE.toString());
  params.set("numShards",1);
  params.set(REPLICATION_FACTOR,2);
  collectionName="acollectionafterbaddelete";
  params.set("name",collectionName);
  if (secondConfigSet) {
    params.set("collection.configName","conf1");
  }
  request=new QueryRequest(params);
  request.setPath("/admin/collections");
  makeRequest(baseUrl,request);
  List<Integer> list=new ArrayList<>(2);
  list.add(1);
  list.add(2);
  checkForCollection(collectionName,list,null);
  url=getUrlFromZk(collectionName);
  collectionClient=new HttpSolrClient(url);
  waitForNon403or404or503(collectionClient);
  collectionClient.shutdown();
  collectionClient=null;
  for (int j=0; j < cnt; j++) {
    waitForRecoveriesToFinish(collectionName,zkStateReader,false);
  }
  int numLiveNodes=getCommonCloudSolrClient().getZkStateReader().getClusterState().getLiveNodes().size();
  int numShards=(numLiveNodes / 2) + 1;
  int replicationFactor=2;
  int maxShardsPerNode=1;
  collectionInfos=new HashMap<>();
  CloudSolrClient client=createCloudClient("awholynewcollection_" + cnt);
  try {
    exp=false;
    try {
      createCollection(collectionInfos,"awholynewcollection_" + cnt,numShards,replicationFactor,maxShardsPerNode,client,null,"conf1");
    }
 catch (    SolrException e) {
      exp=true;
    }
    assertTrue("expected exception",exp);
  }
  finally {
    client.shutdown();
  }
  numLiveNodes=getCommonCloudSolrClient().getZkStateReader().getClusterState().getLiveNodes().size();
  List<String> createNodeList=new ArrayList<>();
  int numOfCreateNodes=numLiveNodes / 2;
  assertFalse("createNodeSet test is pointless with only " + numLiveNodes + " nodes running",numOfCreateNodes == 0);
  int i=0;
  for (  String liveNode : getCommonCloudSolrClient().getZkStateReader().getClusterState().getLiveNodes()) {
    if (i < numOfCreateNodes) {
      createNodeList.add(liveNode);
      i++;
    }
 else {
      break;
    }
  }
  maxShardsPerNode=2;
  numShards=createNodeList.size() * maxShardsPerNode;
  replicationFactor=1;
  collectionInfos=new HashMap<>();
  client=createCloudClient("awholynewcollection_" + (cnt + 1));
  try {
    CollectionAdminResponse res=createCollection(collectionInfos,"awholynewcollection_" + (cnt + 1),numShards,replicationFactor,maxShardsPerNode,client,StrUtils.join(createNodeList,','),"conf1");
    assertTrue(res.isSuccess());
  }
  finally {
    client.shutdown();
  }
  checkForCollection(collectionInfos.keySet().iterator().next(),collectionInfos.entrySet().iterator().next().getValue(),createNodeList);
  checkNoTwoShardsUseTheSameIndexDir();
  if (disableLegacy) {
    setClusterProp(client1,ZkStateReader.LEGACY_CLOUD,null);
    client1.shutdown();
  }
}
