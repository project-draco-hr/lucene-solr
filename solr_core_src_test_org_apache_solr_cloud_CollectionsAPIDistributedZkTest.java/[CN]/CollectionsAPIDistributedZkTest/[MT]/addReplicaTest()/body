{
  String collectionName="addReplicaColl";
  try (CloudSolrClient client=createCloudClient(null)){
    createCollection(collectionName,client,2,2);
    String newReplicaName=Assign.assignNode(collectionName,client.getZkStateReader().getClusterState());
    ArrayList<String> nodeList=new ArrayList<>(client.getZkStateReader().getClusterState().getLiveNodes());
    Collections.shuffle(nodeList,random());
    CollectionAdminRequest.AddReplica addReplica=new CollectionAdminRequest.AddReplica();
    addReplica.setCollectionName(collectionName);
    addReplica.setShardName("shard1");
    addReplica.setNode(nodeList.get(0));
    client.request(addReplica);
    long timeout=System.currentTimeMillis() + 3000;
    Replica newReplica=null;
    for (; System.currentTimeMillis() < timeout; ) {
      Slice slice=client.getZkStateReader().getClusterState().getSlice(collectionName,"shard1");
      newReplica=slice.getReplica(newReplicaName);
    }
    assertNotNull(newReplica);
    log.info("newReplica {},\n{} ",newReplica,client.getZkStateReader().getBaseUrlForNodeName(nodeList.get(0)));
    assertEquals("Replica should be created on the right node",client.getZkStateReader().getBaseUrlForNodeName(nodeList.get(0)),newReplica.getStr(ZkStateReader.BASE_URL_PROP));
    newReplicaName=Assign.assignNode(collectionName,client.getZkStateReader().getClusterState());
    addReplica=new CollectionAdminRequest.AddReplica();
    addReplica.setCollectionName(collectionName);
    addReplica.setShardName("shard2");
    Properties props=new Properties();
    String instancePathStr=createTempDir().toString();
    props.put(CoreAdminParams.INSTANCE_DIR,instancePathStr);
    addReplica.setProperties(props);
    client.request(addReplica);
    timeout=System.currentTimeMillis() + 3000;
    newReplica=null;
    for (; System.currentTimeMillis() < timeout; ) {
      Slice slice=client.getZkStateReader().getClusterState().getSlice(collectionName,"shard2");
      newReplica=slice.getReplica(newReplicaName);
    }
    assertNotNull(newReplica);
    HttpSolrClient coreclient=new HttpSolrClient(newReplica.getStr(ZkStateReader.BASE_URL_PROP));
    CoreAdminResponse status=CoreAdminRequest.getStatus(newReplica.getStr("core"),coreclient);
    NamedList<Object> coreStatus=status.getCoreStatus(newReplica.getStr("core"));
    String instanceDirStr=(String)coreStatus.get("instanceDir");
    assertEquals(Paths.get(instanceDirStr).toString(),instancePathStr);
  }
 }
