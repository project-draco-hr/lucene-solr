{
  String collectionName="addReplicaColl";
  try (CloudSolrClient client=createCloudClient(null)){
    createCollection(collectionName,client,2,2);
    String newReplicaName=Assign.assignNode(collectionName,client.getZkStateReader().getClusterState());
    ArrayList<String> nodeList=new ArrayList<>(client.getZkStateReader().getClusterState().getLiveNodes());
    Collections.shuffle(nodeList,random());
    Replica newReplica=doAddReplica(collectionName,"shard1",Assign.assignNode(collectionName,client.getZkStateReader().getClusterState()),nodeList.get(0),client,null);
    log.info("newReplica {},\n{} ",newReplica,client.getZkStateReader().getBaseUrlForNodeName(nodeList.get(0)));
    assertEquals("Replica should be created on the right node",client.getZkStateReader().getBaseUrlForNodeName(nodeList.get(0)),newReplica.getStr(ZkStateReader.BASE_URL_PROP));
    Properties props=new Properties();
    String instancePathStr=createTempDir().toString();
    props.put(CoreAdminParams.INSTANCE_DIR,instancePathStr);
    newReplica=doAddReplica(collectionName,"shard2",Assign.assignNode(collectionName,client.getZkStateReader().getClusterState()),null,client,props);
    assertNotNull(newReplica);
    HttpSolrClient coreclient=new HttpSolrClient(newReplica.getStr(ZkStateReader.BASE_URL_PROP));
    CoreAdminResponse status=CoreAdminRequest.getStatus(newReplica.getStr("core"),coreclient);
    NamedList<Object> coreStatus=status.getCoreStatus(newReplica.getStr("core"));
    String instanceDirStr=(String)coreStatus.get("instanceDir");
    assertEquals(Paths.get(instanceDirStr).toString(),instancePathStr);
    String coreName=newReplica.getStr(CORE_NAME_PROP);
    ModifiableSolrParams params=new ModifiableSolrParams();
    params.set("action","addreplica");
    params.set("collection",collectionName);
    params.set("shard","shard1");
    params.set("name",coreName);
    QueryRequest request=new QueryRequest(params);
    request.setPath("/admin/collections");
    try {
      client.request(request);
      fail("AddReplica call should not have been successful");
    }
 catch (    SolrException e) {
      assertTrue(e.getMessage().contains("Another replica with the same core name already exists for this collection"));
    }
    props=new Properties();
    props.put(CoreAdminParams.NAME,"propertyDotName");
    newReplica=doAddReplica(collectionName,"shard1",Assign.assignNode(collectionName,client.getZkStateReader().getClusterState()),nodeList.get(0),client,props);
    assertEquals("'core' should be 'propertyDotName' ","propertyDotName",newReplica.getStr("core"));
  }
 }
