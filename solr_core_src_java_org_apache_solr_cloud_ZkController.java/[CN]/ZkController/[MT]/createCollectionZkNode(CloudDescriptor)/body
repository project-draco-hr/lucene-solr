{
  String collection=cd.getCollectionName();
  log.info("Check for collection zkNode:" + collection);
  String collectionPath=ZkStateReader.COLLECTIONS_ZKNODE + "/" + collection;
  try {
    if (!zkClient.exists(collectionPath)) {
      log.info("Creating collection in ZooKeeper:" + collection);
      SolrParams params=cd.getParams();
      try {
        ZkNodeProps collectionProps=new ZkNodeProps();
        String defaultConfigName=System.getProperty(COLLECTION_PARAM_PREFIX + CONFIGNAME_PROP,"configuration1");
        if (params != null) {
          Iterator<String> iter=params.getParameterNamesIterator();
          while (iter.hasNext()) {
            String paramName=iter.next();
            if (paramName.startsWith(COLLECTION_PARAM_PREFIX)) {
              collectionProps.put(paramName.substring(COLLECTION_PARAM_PREFIX.length()),params.get(paramName));
            }
          }
          if (!collectionProps.containsKey(CONFIGNAME_PROP))           collectionProps.put(CONFIGNAME_PROP,defaultConfigName);
        }
 else         if (System.getProperty("bootstrap_confdir") != null) {
          log.info("Setting config for collection:" + collection + " to "+ defaultConfigName);
          Properties sysProps=System.getProperties();
          for (          String sprop : System.getProperties().stringPropertyNames()) {
            if (sprop.startsWith(COLLECTION_PARAM_PREFIX)) {
              collectionProps.put(sprop.substring(COLLECTION_PARAM_PREFIX.length()),sysProps.getProperty(sprop));
            }
          }
          if (!collectionProps.containsKey(CONFIGNAME_PROP))           collectionProps.put(CONFIGNAME_PROP,defaultConfigName);
        }
 else {
          log.info("Looking for collection configName");
          int retry=1;
          for (; retry < 6; retry++) {
            if (zkClient.exists(collectionPath)) {
              collectionProps=new ZkNodeProps();
              collectionProps.load(zkClient.getData(collectionPath,null,null));
              if (collectionProps.containsKey(CONFIGNAME_PROP)) {
                break;
              }
            }
            log.info("Could not find collection configName - pausing for 2 seconds and trying again - try: " + retry);
            Thread.sleep(2000);
          }
          if (retry == 6) {
            log.error("Could not find configName for collection " + collection);
            throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"Could not find configName for collection " + collection);
          }
        }
        zkClient.makePath(collectionPath,collectionProps.store(),CreateMode.PERSISTENT,null,true);
        zkClient.setData(ZkStateReader.COLLECTIONS_ZKNODE,(byte[])null);
      }
 catch (      KeeperException e) {
        if (e.code() != KeeperException.Code.NODEEXISTS) {
          throw e;
        }
      }
    }
 else {
      log.info("Collection zkNode exists");
    }
  }
 catch (  KeeperException e) {
    if (e.code() != KeeperException.Code.NODEEXISTS) {
      throw e;
    }
  }
}
