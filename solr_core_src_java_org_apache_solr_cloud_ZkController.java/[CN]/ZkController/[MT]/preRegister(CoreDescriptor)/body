{
  String coreNodeName=getCoreNodeName(cd);
  if (cd.getCloudDescriptor().getCoreNodeName() == null) {
    cd.getCloudDescriptor().setCoreNodeName(coreNodeName);
  }
  try {
    if (cd.getCloudDescriptor().getCollectionName() != null && cd.getCloudDescriptor().getCoreNodeName() != null) {
      if (zkStateReader.getClusterState().hasCollection(cd.getCloudDescriptor().getCollectionName())) {
        DocCollection coll=zkStateReader.getClusterState().getCollection(cd.getCloudDescriptor().getCollectionName());
        if (!"true".equals(coll.getStr("autoCreated"))) {
          Slice slice=coll.getSlice(cd.getCloudDescriptor().getShardId());
          if (slice != null) {
            if (slice.getReplica(cd.getCloudDescriptor().getCoreNodeName()) == null) {
              log.info("core_removed This core is removed from ZK");
              throw new SolrException(ErrorCode.NOT_FOUND,coreNodeName + " is removed");
            }
          }
        }
      }
    }
    publish(cd,ZkStateReader.DOWN,false);
  }
 catch (  KeeperException e) {
    log.error("",e);
    throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
  }
catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
    log.error("",e);
    throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
  }
  if (cd.getCloudDescriptor().getShardId() == null && needsToBeAssignedShardId(cd,zkStateReader.getClusterState(),coreNodeName)) {
    doGetShardIdAndNodeNameProcess(cd);
  }
 else {
    doGetShardIdAndNodeNameProcess(cd);
  }
}
