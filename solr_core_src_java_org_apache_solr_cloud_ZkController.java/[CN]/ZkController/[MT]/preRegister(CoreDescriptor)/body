{
  String coreNodeName=getCoreNodeName(cd);
  try {
    checkStateInZk(cd);
    CloudDescriptor cloudDesc=cd.getCloudDescriptor();
    if (cloudDesc.getCoreNodeName() == null) {
      cloudDesc.setCoreNodeName(coreNodeName);
    }
    publish(cd,Replica.State.DOWN,false,true);
    String collectionName=cd.getCloudDescriptor().getCollectionName();
    DocCollection collection=zkStateReader.getClusterState().getCollectionOrNull(collectionName);
    log.info(collection == null ? "Collection {} not visible yet, but flagging it so a watch is registered when it becomes visible" : "Registering watch for collection {}",collectionName);
    zkStateReader.addCollectionWatch(collectionName);
  }
 catch (  KeeperException e) {
    log.error("",e);
    throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
  }
catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
    log.error("",e);
    throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
  }
  if (cd.getCloudDescriptor().getShardId() == null && needsToBeAssignedShardId(cd,zkStateReader.getClusterState(),coreNodeName)) {
    doGetShardIdAndNodeNameProcess(cd);
  }
 else {
    doGetShardIdAndNodeNameProcess(cd);
  }
}
