{
  if (collection == null || shardId == null || coreNodeName == null) {
    log.warn("Cannot set leader-initiated recovery state znode to " + state.toString() + " using: collection="+ collection+ "; shardId="+ shardId+ "; coreNodeName="+ coreNodeName);
    return;
  }
  String znodePath=getLeaderInitiatedRecoveryZnodePath(collection,shardId,coreNodeName);
  if (state == Replica.State.ACTIVE) {
    try {
      zkClient.delete(znodePath,-1,retryOnConnLoss);
    }
 catch (    Exception justLogIt) {
      log.warn("Failed to delete znode " + znodePath,justLogIt);
    }
    return;
  }
  Map<String,Object> stateObj=null;
  try {
    stateObj=getLeaderInitiatedRecoveryStateObject(collection,shardId,coreNodeName);
  }
 catch (  Exception exc) {
    log.warn(exc.getMessage(),exc);
  }
  if (stateObj == null) {
    stateObj=Utils.makeMap();
  }
  stateObj.put(ZkStateReader.STATE_PROP,state.toString());
  if (stateObj.get("createdByNodeName") == null) {
    stateObj.put("createdByNodeName",this.nodeName);
  }
  if (stateObj.get("createdByCoreNodeName") == null && leaderCoreNodeName != null) {
    stateObj.put("createdByCoreNodeName",leaderCoreNodeName);
  }
  byte[] znodeData=Utils.toJSON(stateObj);
  try {
    if (state == Replica.State.DOWN) {
      markShardAsDownIfLeader(collection,shardId,leaderCoreNodeName,znodePath,znodeData,retryOnConnLoss);
    }
 else {
      if (zkClient.exists(znodePath,true)) {
        zkClient.setData(znodePath,znodeData,retryOnConnLoss);
      }
 else {
        zkClient.makePath(znodePath,znodeData,retryOnConnLoss);
      }
    }
    log.info("Wrote {} to {}",state.toString(),znodePath);
  }
 catch (  Exception exc) {
    if (exc instanceof SolrException) {
      throw (SolrException)exc;
    }
 else {
      throw new SolrException(ErrorCode.SERVER_ERROR,"Failed to update data to " + state.toString() + " for znode: "+ znodePath,exc);
    }
  }
}
