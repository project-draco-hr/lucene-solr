{
  List fields=new ArrayList();
  fields.add(AbstractDataImportHandlerTest.createMap("column","id"));
  fields.add(AbstractDataImportHandlerTest.createMap("column","desc"));
  String q="select * from x where id=${x.id}";
  Map<String,String> entityAttrs=AbstractDataImportHandlerTest.createMap("query",q,"transformer",DoubleTransformer.class.getName());
  MockDataSource ds=new MockDataSource();
  VariableResolverImpl vr=new VariableResolverImpl();
  vr.addNamespace("x",AbstractDataImportHandlerTest.createMap("id",1));
  Context context=AbstractDataImportHandlerTest.getContext(null,vr,ds,Context.FULL_DUMP,fields,entityAttrs);
  List<Map<String,Object>> rows=new ArrayList<Map<String,Object>>();
  rows.add(AbstractDataImportHandlerTest.createMap("id",1,"desc","one"));
  rows.add(AbstractDataImportHandlerTest.createMap("id",1,"desc","another one"));
  MockDataSource.setIterator(vr.replaceTokens(q),rows.iterator());
  EntityProcessor csep=new EntityProcessorWrapper(new CachedSqlEntityProcessor(),null);
  csep.init(context);
  rows=new ArrayList<Map<String,Object>>();
  while (true) {
    Map<String,Object> r=csep.nextRow();
    if (r == null)     break;
    rows.add(r);
  }
  Assert.assertEquals(4,rows.size());
  ds.close();
  csep.init(context);
  rows=new ArrayList<Map<String,Object>>();
  while (true) {
    Map<String,Object> r=csep.nextRow();
    if (r == null)     break;
    rows.add(r);
  }
  Assert.assertEquals(4,rows.size());
  Assert.assertEquals(2,rows.get(0).size());
  Assert.assertEquals(2,rows.get(1).size());
}
