{
  long t=System.currentTimeMillis();
  while (System.currentTimeMillis() - t <= timeout) {
    boolean done=true;
    for (    Thread thread : threads) {
      if (thread.getState() != state) {
        done=false;
      }
    }
    if (done) {
      return;
    }
    if (random().nextBoolean()) {
      Thread.yield();
    }
 else {
      Thread.sleep(1);
    }
  }
  fail("timed out waiting for state: " + state + " timeout: "+ timeout+ " ms");
}
