{
  DocumentsWriterStallControl ctrl=new DocumentsWriterStallControl();
  SimpleMemCtrl memCtrl=new SimpleMemCtrl();
  memCtrl.limit=1000;
  memCtrl.netBytes=1000;
  memCtrl.flushBytes=20;
  ctrl.updateStalled(memCtrl);
  Thread[] waitThreads=waitThreads(atLeast(1),ctrl);
  start(waitThreads);
  assertFalse(ctrl.hasBlocked());
  assertFalse(ctrl.anyStalledThreads());
  join(waitThreads,10);
  memCtrl.netBytes=1001;
  memCtrl.flushBytes=100;
  ctrl.updateStalled(memCtrl);
  waitThreads=waitThreads(atLeast(1),ctrl);
  start(waitThreads);
  awaitState(100,Thread.State.WAITING,waitThreads);
  assertTrue(ctrl.hasBlocked());
  assertTrue(ctrl.anyStalledThreads());
  memCtrl.netBytes=50;
  memCtrl.flushBytes=0;
  ctrl.updateStalled(memCtrl);
  assertFalse(ctrl.anyStalledThreads());
  join(waitThreads,500);
}
