{
  Directory dir=getDirectory(createTempDir());
  try {
    Lock lock=dir.obtainLock("test.lock");
    lock.ensureValid();
    try {
      dir.deleteFile("test.lock");
    }
 catch (    Exception e) {
      IOUtils.closeWhileHandlingException(lock);
      assumeNoException("test requires the ability to delete a locked file",e);
    }
    try {
      lock.ensureValid();
      fail("no exception");
    }
 catch (    IOException expected) {
    }
 finally {
      IOUtils.closeWhileHandlingException(lock);
    }
  }
  finally {
    dir.close();
  }
}
