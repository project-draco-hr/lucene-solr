{
  boolean testsSuccesful=false;
  try {
    handle.clear();
    handle.put("QTime",SKIPVAL);
    handle.put("timestamp",SKIPVAL);
    ZkStateReader zkStateReader=cloudClient.getZkStateReader();
    for (int j=1; j < sliceCount; j++) {
      zkStateReader.getLeaderRetry(DEFAULT_COLLECTION,"shard" + j,10000);
    }
    waitForRecoveriesToFinish(false);
    del("*:*");
    List<StopableThread> threads=new ArrayList<StopableThread>();
    int threadCount=1;
    int i=0;
    for (i=0; i < threadCount; i++) {
      StopableIndexingThread indexThread=new StopableIndexingThread((i + 1) * 50000,true);
      threads.add(indexThread);
      indexThread.start();
    }
    threadCount=1;
    i=0;
    for (i=0; i < threadCount; i++) {
      StopableSearchThread searchThread=new StopableSearchThread();
      threads.add(searchThread);
      searchThread.start();
    }
    boolean runFullThrottle=random().nextBoolean();
    if (runFullThrottle) {
      FullThrottleStopableIndexingThread ftIndexThread=new FullThrottleStopableIndexingThread(clients,(i + 1) * 50000,true);
      threads.add(ftIndexThread);
      ftIndexThread.start();
    }
    chaosMonkey.startTheMonkey(true,10000);
    long runLength;
    if (RUN_LENGTH != -1) {
      runLength=RUN_LENGTH;
    }
 else {
      int[] runTimes=new int[]{5000,6000,10000,15000,15000,30000,30000,45000,90000,120000};
      runLength=runTimes[random().nextInt(runTimes.length - 1)];
    }
    try {
      Thread.sleep(runLength);
    }
  finally {
      chaosMonkey.stopTheMonkey();
    }
    for (    StopableThread indexThread : threads) {
      indexThread.safeStop();
    }
    for (    StopableThread indexThread : threads) {
      indexThread.join();
    }
    Thread.sleep(2000);
    waitForThingsToLevelOut(Integer.MAX_VALUE);
    for (int j=1; j < sliceCount; j++) {
      zkStateReader.getLeaderRetry(DEFAULT_COLLECTION,"shard" + j,30000);
    }
    commit();
    zkStateReader.updateClusterState(true);
    assertTrue(zkStateReader.getClusterState().getLiveNodes().size() > 0);
    checkShardConsistency(!runFullThrottle,true);
    long ctrlDocs=controlClient.query(new SolrQuery("*:*")).getResults().getNumFound();
    long cloudClientDocs=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
    assertTrue("Found " + ctrlDocs + " control docs",cloudClientDocs > 0);
    if (VERBOSE)     System.out.println("control docs:" + controlClient.query(new SolrQuery("*:*")).getResults().getNumFound() + "\n\n");
    testsSuccesful=true;
  }
  finally {
    if (!testsSuccesful) {
      printLayout();
    }
  }
}
