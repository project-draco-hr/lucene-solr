{
  Set<String> liveNodes=cloudSolrClient.getZkStateReader().getClusterState().getLiveNodes();
  if (liveNodes.isEmpty())   throw new IllegalStateException("No live nodes found! Cannot create a collection until " + "there is at least 1 live node in the cluster.");
  String baseUrl=cli.getOptionValue("solrUrl");
  if (baseUrl == null) {
    String firstLiveNode=liveNodes.iterator().next();
    baseUrl=cloudSolrClient.getZkStateReader().getBaseUrlForNodeName(firstLiveNode);
  }
  String collectionName=cli.getOptionValue(NAME);
  int numShards=optionAsInt(cli,"shards",1);
  int replicationFactor=optionAsInt(cli,"replicationFactor",1);
  int maxShardsPerNode=-1;
  if (cli.hasOption("maxShardsPerNode")) {
    maxShardsPerNode=Integer.parseInt(cli.getOptionValue("maxShardsPerNode"));
  }
 else {
    int numNodes=liveNodes.size();
    maxShardsPerNode=((numShards * replicationFactor) + numNodes - 1) / numNodes;
  }
  String confname=cli.getOptionValue("confname",collectionName);
  boolean configExistsInZk=cloudSolrClient.getZkStateReader().getZkClient().exists("/configs/" + confname,true);
  if (".system".equals(collectionName)) {
  }
 else   if (configExistsInZk) {
    echo("Re-using existing configuration directory " + confname);
  }
 else {
    Path confPath=ZkConfigManager.getConfigsetPath(confname,cli.getOptionValue("confdir",DEFAULT_CONFIG_SET),cli.getOptionValue("configsetsDir"));
    echo("Uploading " + confPath.toAbsolutePath().toString() + " for config "+ confname+ " to ZooKeeper at "+ cloudSolrClient.getZkHost());
    cloudSolrClient.uploadConfig(confPath,confname);
  }
  String collectionListUrl=baseUrl + "/admin/collections?action=list";
  if (safeCheckCollectionExists(collectionListUrl,collectionName)) {
    throw new IllegalStateException("\nCollection '" + collectionName + "' already exists!\nChecked collection existence using Collections API command:\n"+ collectionListUrl);
  }
  String createCollectionUrl=String.format(Locale.ROOT,"%s/admin/collections?action=CREATE&name=%s&numShards=%d&replicationFactor=%d&maxShardsPerNode=%d&collection.configName=%s",baseUrl,collectionName,numShards,replicationFactor,maxShardsPerNode,confname);
  echo("\nCreating new collection '" + collectionName + "' using command:\n"+ createCollectionUrl+ "\n");
  Map<String,Object> json=null;
  try {
    json=getJson(createCollectionUrl);
  }
 catch (  SolrServerException sse) {
    throw new Exception("Failed to create collection '" + collectionName + "' due to: "+ sse.getMessage());
  }
  CharArr arr=new CharArr();
  new JSONWriter(arr,2).write(json);
  echo(arr.toString());
}
