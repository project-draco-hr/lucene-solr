{
  final Directory dir=newDirectory();
  final LineFileDocs docs=new LineFileDocs(random);
  for (int r=0; r < 3; r++) {
    final IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMaxBufferedDocs(2));
    w.setInfoStream(VERBOSE ? System.out : null);
    final int numUpdates=atLeast(20);
    int numThreads=_TestUtil.nextInt(random,2,6);
    IndexingThread[] threads=new IndexingThread[numThreads];
    for (int i=0; i < numThreads; i++) {
      threads[i]=new IndexingThread(docs,w,numUpdates);
      threads[i].start();
    }
    for (int i=0; i < numThreads; i++) {
      threads[i].join();
    }
    w.close();
  }
  IndexReader open=IndexReader.open(dir);
  assertEquals(1,open.numDocs());
  open.close();
  docs.close();
  dir.close();
}
