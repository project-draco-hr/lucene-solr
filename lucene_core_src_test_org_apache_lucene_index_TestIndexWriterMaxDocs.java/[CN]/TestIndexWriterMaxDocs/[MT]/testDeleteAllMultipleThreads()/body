{
  int limit=TestUtil.nextInt(random(),2,10);
  setIndexWriterMaxDocs(limit);
  try {
    Directory dir=newDirectory();
    IndexWriter w=new IndexWriter(dir,new IndexWriterConfig(null));
    CountDownLatch startingGun=new CountDownLatch(1);
    Thread[] threads=new Thread[limit];
    for (int i=0; i < limit; i++) {
      threads[i]=new Thread(){
        @Override public void run(){
          try {
            startingGun.await();
            w.addDocument(new Document());
          }
 catch (          Exception e) {
            throw new RuntimeException(e);
          }
        }
      }
;
      threads[i].start();
    }
    startingGun.countDown();
    for (    Thread thread : threads) {
      thread.join();
    }
    try {
      w.addDocument(new Document());
      fail("didn't hit exception");
    }
 catch (    IllegalArgumentException iae) {
    }
    w.deleteAll();
    for (int i=0; i < limit; i++) {
      w.addDocument(new Document());
    }
    try {
      w.addDocument(new Document());
      fail("didn't hit exception");
    }
 catch (    IllegalArgumentException iae) {
    }
    w.close();
    dir.close();
  }
  finally {
    restoreIndexWriterMaxDocs();
  }
}
