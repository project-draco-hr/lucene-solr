{
  final Query contents=this.contents[0];
  if (contents instanceof TermQuery) {
    return contents;
  }
  int numNegatives=0;
  if (!(contents instanceof BooleanQuery)) {
    throw new IllegalArgumentException("Unknown query type \"" + contents.getClass().getName() + "\" found in phrase query string \""+ phrasedQueryStringContents+ "\"");
  }
  BooleanQuery bq=(BooleanQuery)contents;
  SpanQuery[] allSpanClauses=new SpanQuery[bq.clauses().size()];
  int i=0;
  for (  BooleanClause clause : bq) {
    Query qc=clause.getQuery();
    qc=qc.rewrite(reader);
    if (clause.getOccur().equals(BooleanClause.Occur.MUST_NOT)) {
      numNegatives++;
    }
    if (qc instanceof BooleanQuery) {
      ArrayList<SpanQuery> sc=new ArrayList<>();
      addComplexPhraseClause(sc,(BooleanQuery)qc);
      if (sc.size() > 0) {
        allSpanClauses[i]=sc.get(0);
      }
 else {
        allSpanClauses[i]=new SpanTermQuery(new Term(field,"Dummy clause because no terms found - must match nothing"));
      }
    }
 else {
      if (qc instanceof TermQuery) {
        TermQuery tq=(TermQuery)qc;
        allSpanClauses[i]=new SpanTermQuery(tq.getTerm());
      }
 else {
        throw new IllegalArgumentException("Unknown query type \"" + qc.getClass().getName() + "\" found in phrase query string \""+ phrasedQueryStringContents+ "\"");
      }
    }
    i+=1;
  }
  if (numNegatives == 0) {
    return new SpanNearQuery(allSpanClauses,slopFactor,inOrder);
  }
  ArrayList<SpanQuery> positiveClauses=new ArrayList<>();
  i=0;
  for (  BooleanClause clause : bq) {
    if (!clause.getOccur().equals(BooleanClause.Occur.MUST_NOT)) {
      positiveClauses.add(allSpanClauses[i]);
    }
    i+=1;
  }
  SpanQuery[] includeClauses=positiveClauses.toArray(new SpanQuery[positiveClauses.size()]);
  SpanQuery include=null;
  if (includeClauses.length == 1) {
    include=includeClauses[0];
  }
 else {
    include=new SpanNearQuery(includeClauses,slopFactor + numNegatives,inOrder);
  }
  SpanNearQuery exclude=new SpanNearQuery(allSpanClauses,slopFactor,inOrder);
  SpanNotQuery snot=new SpanNotQuery(include,exclude);
  return snot;
}
