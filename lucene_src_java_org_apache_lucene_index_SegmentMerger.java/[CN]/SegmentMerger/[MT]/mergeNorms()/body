{
  IndexOutput output=null;
  boolean success=false;
  try {
    for (    FieldInfo fi : mergeState.fieldInfos) {
      if (fi.isIndexed && !fi.omitNorms) {
        if (output == null) {
          output=directory.createOutput(IndexFileNames.segmentFileName(segment,"",IndexFileNames.NORMS_EXTENSION),context);
          output.writeBytes(Lucene40NormsWriter.NORMS_HEADER,Lucene40NormsWriter.NORMS_HEADER.length);
        }
        for (        MergeState.IndexReaderAndLiveDocs reader : mergeState.readers) {
          final int maxDoc=reader.reader.maxDoc();
          byte normBuffer[]=reader.reader.norms(fi.name);
          if (normBuffer == null) {
            normBuffer=new byte[maxDoc];
            Arrays.fill(normBuffer,(byte)0);
          }
          if (reader.liveDocs == null) {
            output.writeBytes(normBuffer,maxDoc);
          }
 else {
            final Bits liveDocs=reader.liveDocs;
            for (int k=0; k < maxDoc; k++) {
              if (liveDocs.get(k)) {
                output.writeByte(normBuffer[k]);
              }
            }
          }
          mergeState.checkAbort.work(maxDoc);
        }
      }
    }
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(output);
    }
 else {
      IOUtils.closeWhileHandlingException(output);
    }
  }
}
