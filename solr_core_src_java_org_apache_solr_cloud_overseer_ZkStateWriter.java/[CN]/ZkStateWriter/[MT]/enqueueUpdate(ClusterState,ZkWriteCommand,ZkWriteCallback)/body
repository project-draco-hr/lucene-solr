{
  if (invalidState) {
    throw new IllegalStateException("ZkStateWriter has seen a tragic error, this instance can no longer be used");
  }
  if (cmd == NO_OP)   return prevState;
  if (maybeFlushBefore(cmd)) {
    prevState=clusterState=writePendingUpdates();
    if (callback != null) {
      callback.onWrite();
    }
  }
  if (callback != null) {
    callback.onEnqueue();
  }
  DocCollection previousCollection=prevState.getCollectionOrNull(cmd.name);
  boolean wasPreviouslyStateFormat1=previousCollection != null && previousCollection.getStateFormat() == 1;
  boolean isCurrentlyStateFormat1=cmd.collection != null && cmd.collection.getStateFormat() == 1;
  if (cmd.collection == null) {
    if (wasPreviouslyStateFormat1) {
      isClusterStateModified=true;
    }
    clusterState=prevState.copyWith(cmd.name,null);
    updates.put(cmd.name,null);
  }
 else {
    if (!isCurrentlyStateFormat1) {
      updates.put(cmd.name,cmd.collection);
    }
    if (isCurrentlyStateFormat1 || wasPreviouslyStateFormat1) {
      isClusterStateModified=true;
    }
    clusterState=prevState.copyWith(cmd.name,cmd.collection);
  }
  if (maybeFlushAfter(cmd)) {
    ClusterState state=writePendingUpdates();
    if (callback != null) {
      callback.onWrite();
    }
    return state;
  }
  return clusterState;
}
