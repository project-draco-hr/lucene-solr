{
  Directory dir=newDirectory();
  RandomIndexWriter writer=new RandomIndexWriter(random,dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergeScheduler(new SerialMergeScheduler()).setMergePolicy(newLogMergePolicy(10)));
  IndexReader reader=IndexReader.open(writer.w,true);
  IndexSearcher searcher=newSearcher(reader,false);
  Document doc=new Document();
  doc.add(newField("id","1",StringField.TYPE_STORED));
  writer.addDocument(doc);
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  TopDocs docs=searcher.search(new MatchAllDocsQuery(),1);
  assertEquals("Should find a hit...",1,docs.totalHits);
  final Filter startFilter=new QueryWrapperFilter(new TermQuery(new Term("id","1")));
  CachingWrapperFilter filter=new CachingWrapperFilter(startFilter,CachingWrapperFilter.DeletesMode.IGNORE);
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals("[query + filter] Should find a hit...",1,docs.totalHits);
  ConstantScoreQuery constantScore=new ConstantScoreQuery(filter);
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should find a hit...",1,docs.totalHits);
  _TestUtil.keepFullyDeletedSegments(writer.w);
  writer.deleteDocuments(new Term("id","1"));
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals("[query + filter] Should *not* find a hit...",0,docs.totalHits);
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should find a hit...",1,docs.totalHits);
  filter=new CachingWrapperFilter(startFilter,CachingWrapperFilter.DeletesMode.RECACHE);
  writer.addDocument(doc);
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals("[query + filter] Should find a hit...",1,docs.totalHits);
  constantScore=new ConstantScoreQuery(filter);
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should find a hit...",1,docs.totalHits);
  IndexReader oldReader=reader;
  reader=refreshReader(reader);
  assertTrue(reader != oldReader);
  searcher.close();
  searcher=newSearcher(reader,false);
  int missCount=filter.missCount;
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should find a hit...",1,docs.totalHits);
  assertEquals(missCount,filter.missCount);
  writer.deleteDocuments(new Term("id","1"));
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  missCount=filter.missCount;
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals(missCount + 1,filter.missCount);
  assertEquals("[query + filter] Should *not* find a hit...",0,docs.totalHits);
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should *not* find a hit...",0,docs.totalHits);
  filter=new CachingWrapperFilter(startFilter,CachingWrapperFilter.DeletesMode.DYNAMIC);
  writer.addDocument(doc);
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals("[query + filter] Should find a hit...",1,docs.totalHits);
  constantScore=new ConstantScoreQuery(filter);
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should find a hit...",1,docs.totalHits);
  writer.deleteDocuments(new Term("id","1"));
  reader=refreshReader(reader);
  searcher.close();
  searcher=newSearcher(reader,false);
  docs=searcher.search(new MatchAllDocsQuery(),filter,1);
  assertEquals("[query + filter] Should *not* find a hit...",0,docs.totalHits);
  missCount=filter.missCount;
  docs=searcher.search(constantScore,1);
  assertEquals("[just filter] Should *not* find a hit...",0,docs.totalHits);
  assertEquals(missCount,filter.missCount);
  assertTrue(oldReader != null);
  searcher.close();
  reader.close();
  writer.close();
  dir.close();
}
