{
  assumeTrue("merge is not stable",mergeIsStable());
  Directory dir=newDirectory();
  MergePolicy mp=newTieredMergePolicy();
  mp.setNoCFSRatio(0);
  IndexWriterConfig cfg=new IndexWriterConfig(new MockAnalyzer(random())).setUseCompoundFile(false).setMergePolicy(mp);
  IndexWriter w=new IndexWriter(dir,cfg);
  final int numDocs=atLeast(500);
  for (int i=0; i < numDocs; ++i) {
    Document d=new Document();
    addRandomFields(d);
    w.addDocument(d);
  }
  w.forceMerge(1);
  w.commit();
  w.close();
  DirectoryReader reader=DirectoryReader.open(dir);
  Directory dir2=newDirectory();
  mp=newTieredMergePolicy();
  mp.setNoCFSRatio(0);
  cfg=new IndexWriterConfig(new MockAnalyzer(random())).setUseCompoundFile(false).setMergePolicy(mp);
  w=new IndexWriter(dir2,cfg);
  TestUtil.addIndexesSlowly(w,reader);
  w.commit();
  w.close();
  assertEquals(bytesUsedByExtension(dir),bytesUsedByExtension(dir2));
  reader.close();
  dir.close();
  dir2.close();
}
