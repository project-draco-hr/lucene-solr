{
  StringBuilder sb=new StringBuilder(128);
  try {
    boolean first=true;
    for (    Map.Entry<String,String> entry : map.entrySet()) {
      String key=entry.getKey();
      Object val=entry.getValue();
      if (val instanceof String[]) {
        String[] strings=(String[])val;
        val=StrUtils.join(Arrays.asList(strings),',');
      }
      if (!first)       sb.append('&');
      first=false;
      sb.append(key);
      sb.append('=');
      StrUtils.partialURLEncodeVal(sb,val == null ? "" : String.valueOf(val));
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  return sb.toString();
}
