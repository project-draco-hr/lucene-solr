{
  Directory dir=newDirectory();
  Analyzer analyzer=new MockAnalyzer();
  RandomIndexWriter w=new RandomIndexWriter(random,dir,newIndexWriterConfig(TEST_VERSION_CURRENT,analyzer).setMergePolicy(newInOrderLogMergePolicy()));
  List<List<String>> docs=new ArrayList<List<String>>();
  Document d=new Document();
  Field f=newField("f","",Field.Store.NO,Field.Index.ANALYZED);
  d.add(f);
  Random r=random;
  int NUM_DOCS=10 * RANDOM_MULTIPLIER;
  for (int i=0; i < NUM_DOCS; i++) {
    int termCount=_TestUtil.nextInt(r,10000,30000);
    List<String> doc=new ArrayList<String>();
    StringBuilder sb=new StringBuilder();
    while (doc.size() < termCount) {
      if (r.nextInt(5) == 1 || docs.size() == 0) {
        String term;
        while (true) {
          term=_TestUtil.randomUnicodeString(r);
          if (term.length() > 0) {
            break;
          }
        }
        TokenStream ts=analyzer.reusableTokenStream("ignore",new StringReader(term));
        CharTermAttribute termAttr=ts.addAttribute(CharTermAttribute.class);
        while (ts.incrementToken()) {
          String text=termAttr.toString();
          doc.add(text);
          sb.append(text).append(' ');
        }
      }
 else {
        List<String> lastDoc=docs.get(r.nextInt(docs.size()));
        int len=_TestUtil.nextInt(r,1,10);
        int start=r.nextInt(lastDoc.size() - len);
        for (int k=start; k < start + len; k++) {
          String t=lastDoc.get(k);
          doc.add(t);
          sb.append(t).append(' ');
        }
      }
    }
    docs.add(doc);
    f.setValue(sb.toString());
    w.addDocument(d);
  }
  IndexReader reader=w.getReader();
  IndexSearcher s=new IndexSearcher(reader);
  w.close();
  int num=100 * RANDOM_MULTIPLIER;
  for (int i=0; i < num; i++) {
    int docID=r.nextInt(docs.size());
    List<String> doc=docs.get(docID);
    final int numTerm=_TestUtil.nextInt(r,2,20);
    final int start=r.nextInt(doc.size() - numTerm);
    PhraseQuery pq=new PhraseQuery();
    StringBuilder sb=new StringBuilder();
    for (int t=start; t < start + numTerm; t++) {
      pq.add(new Term("f",doc.get(t)));
      sb.append(doc.get(t)).append(' ');
    }
    TopDocs hits=s.search(pq,NUM_DOCS);
    boolean found=false;
    for (int j=0; j < hits.scoreDocs.length; j++) {
      if (hits.scoreDocs[j].doc == docID) {
        found=true;
        break;
      }
    }
    assertTrue("phrase '" + sb + "' not found; start="+ start,found);
  }
  reader.close();
  s.close();
  dir.close();
}
