{
  Similarity similarity=Similarity.getDefault();
  IndexWriter writer=new IndexWriter(dir,new SimpleAnalyzer(),true);
  Document doc=new Document();
  doc.add(new Field("preanalyzed",new TokenStream(){
    private String[] tokens=new String[]{"term1","term2","term3","term2"};
    private int index=0;
    public Token next() throws IOException {
      if (index == tokens.length) {
        return null;
      }
 else {
        return new Token(tokens[index++],0,0);
      }
    }
  }
,TermVector.NO));
  writer.addDocument(doc);
  writer.flush();
  SegmentInfo info=writer.segmentInfos.info(writer.segmentInfos.size() - 1);
  writer.close();
  SegmentReader reader=SegmentReader.get(info);
  TermPositions termPositions=reader.termPositions(new Term("preanalyzed","term1"));
  assertTrue(termPositions.next());
  assertEquals(1,termPositions.freq());
  assertEquals(0,termPositions.nextPosition());
  termPositions.seek(new Term("preanalyzed","term2"));
  assertTrue(termPositions.next());
  assertEquals(2,termPositions.freq());
  assertEquals(1,termPositions.nextPosition());
  assertEquals(3,termPositions.nextPosition());
  termPositions.seek(new Term("preanalyzed","term3"));
  assertTrue(termPositions.next());
  assertEquals(1,termPositions.freq());
  assertEquals(2,termPositions.nextPosition());
}
