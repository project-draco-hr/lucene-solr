{
  Analyzer analyzer=new Analyzer(){
    public TokenStream tokenStream(    String fieldName,    Reader reader){
      return new TokenFilter(new WhitespaceTokenizer(reader)){
        boolean first=true;
        Token buffered;
        public Token next(        final Token reusableToken) throws IOException {
          if (buffered != null) {
            Token nextToken=buffered;
            buffered=null;
            return nextToken;
          }
          Token nextToken=input.next(reusableToken);
          if (nextToken == null)           return null;
          if (Character.isDigit(nextToken.termBuffer()[0])) {
            nextToken.setPositionIncrement(nextToken.termBuffer()[0] - '0');
          }
          if (first) {
            nextToken.setPayload(new Payload(new byte[]{100}));
            first=false;
          }
          buffered=(Token)nextToken.clone();
          buffered.setPayload(null);
          buffered.setPositionIncrement(0);
          buffered.setTermBuffer(new char[]{'b'},0,1);
          return nextToken;
        }
      }
;
    }
  }
;
  IndexWriter writer=new IndexWriter(dir,analyzer,true,IndexWriter.MaxFieldLength.LIMITED);
  Document doc=new Document();
  doc.add(new Field("f1","a 5 a a",Field.Store.YES,Field.Index.TOKENIZED));
  writer.addDocument(doc);
  writer.flush();
  SegmentInfo info=writer.newestSegment();
  writer.close();
  SegmentReader reader=SegmentReader.get(info);
  TermPositions termPositions=reader.termPositions(new Term("f1","a"));
  assertTrue(termPositions.next());
  int freq=termPositions.freq();
  assertEquals(3,freq);
  assertEquals(0,termPositions.nextPosition());
  assertEquals(true,termPositions.isPayloadAvailable());
  assertEquals(6,termPositions.nextPosition());
  assertEquals(false,termPositions.isPayloadAvailable());
  assertEquals(7,termPositions.nextPosition());
  assertEquals(false,termPositions.isPayloadAvailable());
}
