{
  SolrQueryRequest sr=req();
  IndexReader r=sr.getSearcher().getTopReaderContext().reader;
  Directory d=r.directory();
  assertU(adoc("id","1"));
  int nFiles=d.listAll().length;
  updateJ("",params("prepareCommit","true"));
  assertTrue(d.listAll().length > nFiles);
  assertJQ(req("q","id:1"),"/response/numFound==0");
  updateJ("",params("rollback","true"));
  assertU(commit());
  assertJQ(req("q","id:1"),"/response/numFound==0");
  assertU(adoc("id","1"));
  updateJ("",params("prepareCommit","true"));
  assertJQ(req("q","id:1"),"/response/numFound==0");
  assertU(commit());
  assertJQ(req("q","id:1"),"/response/numFound==1");
  sr.close();
}
