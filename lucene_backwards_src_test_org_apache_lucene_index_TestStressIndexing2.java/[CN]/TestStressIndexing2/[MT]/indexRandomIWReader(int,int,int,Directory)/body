{
  Map docs=new HashMap();
  IndexWriter w=new MockIndexWriter(dir,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.UNLIMITED);
  w.setUseCompoundFile(false);
  w.setMergeFactor(mergeFactor);
  w.setRAMBufferSizeMB(.1);
  w.setMaxBufferedDocs(maxBufferedDocs);
  threads=new IndexingThread[nThreads];
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=new IndexingThread();
    th.w=w;
    th.base=1000000 * i;
    th.range=range;
    th.iterations=iterations;
    threads[i]=th;
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].start();
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].join();
  }
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=threads[i];
synchronized (th) {
      docs.putAll(th.docs);
    }
  }
  _TestUtil.checkIndex(dir);
  DocsAndWriter dw=new DocsAndWriter();
  dw.docs=docs;
  dw.writer=w;
  return dw;
}
