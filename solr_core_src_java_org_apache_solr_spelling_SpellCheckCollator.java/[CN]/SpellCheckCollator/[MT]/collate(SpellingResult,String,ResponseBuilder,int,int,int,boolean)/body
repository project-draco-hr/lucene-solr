{
  List<SpellCheckCollation> collations=new ArrayList<SpellCheckCollation>();
  QueryComponent queryComponent=null;
  if (ultimateResponse.components != null) {
    for (    SearchComponent sc : ultimateResponse.components) {
      if (sc instanceof QueryComponent) {
        queryComponent=(QueryComponent)sc;
        break;
      }
    }
  }
  boolean verifyCandidateWithQuery=true;
  int maxNumberToIterate=maxTries;
  if (maxTries < 1) {
    maxTries=1;
    maxNumberToIterate=maxCollations;
    verifyCandidateWithQuery=false;
  }
  if (queryComponent == null && verifyCandidateWithQuery) {
    LOG.info("Could not find an instance of QueryComponent.  Disabling collation verification against the index.");
    maxTries=1;
    verifyCandidateWithQuery=false;
  }
  int tryNo=0;
  int collNo=0;
  PossibilityIterator possibilityIter=new PossibilityIterator(result.getSuggestions(),maxNumberToIterate,maxEvaluations,suggestionsMayOverlap);
  while (tryNo < maxTries && collNo < maxCollations && possibilityIter.hasNext()) {
    PossibilityIterator.RankedSpellPossibility possibility=possibilityIter.next();
    String collationQueryStr=getCollation(originalQuery,possibility.corrections);
    int hits=0;
    if (verifyCandidateWithQuery) {
      tryNo++;
      SolrParams origParams=ultimateResponse.req.getParams();
      ModifiableSolrParams params=new ModifiableSolrParams(origParams);
      Iterator<String> origParamIterator=origParams.getParameterNamesIterator();
      int pl=SpellingParams.SPELLCHECK_COLLATE_PARAM_OVERRIDE.length();
      while (origParamIterator.hasNext()) {
        String origParamName=origParamIterator.next();
        if (origParamName.startsWith(SpellingParams.SPELLCHECK_COLLATE_PARAM_OVERRIDE) && origParamName.length() > pl) {
          String[] val=origParams.getParams(origParamName);
          if (val.length == 1 && val[0].length() == 0) {
            params.set(origParamName.substring(pl),(String[])null);
          }
 else {
            params.set(origParamName.substring(pl),val);
          }
        }
      }
      params.set(CommonParams.Q,collationQueryStr);
      params.remove(CommonParams.START);
      params.set(CommonParams.FL,"id");
      params.set(CommonParams.ROWS,"0");
      params.remove(GroupParams.GROUP);
      ResponseBuilder checkResponse=new ResponseBuilder(new LocalSolrQueryRequest(ultimateResponse.req.getCore(),params),new SolrQueryResponse(),Arrays.<SearchComponent>asList(queryComponent));
      checkResponse.setQparser(ultimateResponse.getQparser());
      checkResponse.setFilters(ultimateResponse.getFilters());
      checkResponse.setQueryString(collationQueryStr);
      checkResponse.components=Arrays.<SearchComponent>asList(queryComponent);
      try {
        queryComponent.prepare(checkResponse);
        queryComponent.process(checkResponse);
        hits=(Integer)checkResponse.rsp.getToLog().get("hits");
      }
 catch (      Exception e) {
        LOG.warn("Exception trying to re-query to check if a spell check possibility would return any hits.",e);
      }
 finally {
        checkResponse.req.close();
      }
    }
    if (hits > 0 || !verifyCandidateWithQuery) {
      collNo++;
      SpellCheckCollation collation=new SpellCheckCollation();
      collation.setCollationQuery(collationQueryStr);
      collation.setHits(hits);
      collation.setInternalRank(suggestionsMayOverlap ? ((possibility.rank * 1000) + possibility.index) : possibility.rank);
      NamedList<String> misspellingsAndCorrections=new NamedList<String>();
      for (      SpellCheckCorrection corr : possibility.corrections) {
        misspellingsAndCorrections.add(corr.getOriginal().toString(),corr.getCorrection());
      }
      collation.setMisspellingsAndCorrections(misspellingsAndCorrections);
      collations.add(collation);
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Collation: " + collationQueryStr + (verifyCandidateWithQuery ? (" will return " + hits + " hits.") : ""));
    }
  }
  return collations;
}
