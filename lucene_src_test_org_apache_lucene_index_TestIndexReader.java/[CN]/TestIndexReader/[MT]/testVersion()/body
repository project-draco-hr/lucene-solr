{
  Directory dir=new MockRAMDirectory();
  assertFalse(IndexReader.indexExists(dir));
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()));
  addDocumentWithFields(writer);
  assertTrue(IndexWriter.isLocked(dir));
  writer.close();
  assertTrue(IndexReader.indexExists(dir));
  IndexReader reader=IndexReader.open(dir,false);
  assertFalse(IndexWriter.isLocked(dir));
  long version=IndexReader.getCurrentVersion(dir);
  reader.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE));
  addDocumentWithFields(writer);
  writer.close();
  reader=IndexReader.open(dir,false);
  assertTrue("old version is " + version + "; new version is "+ IndexReader.getCurrentVersion(dir),version < IndexReader.getCurrentVersion(dir));
  reader.close();
  dir.close();
}
