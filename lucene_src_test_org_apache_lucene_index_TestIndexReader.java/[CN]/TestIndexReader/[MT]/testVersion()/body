{
  Directory dir=newDirectory();
  assertFalse(DirectoryReader.indexExists(dir));
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  addDocumentWithFields(writer);
  assertTrue(IndexWriter.isLocked(dir));
  writer.close();
  assertTrue(DirectoryReader.indexExists(dir));
  IndexReader reader=IndexReader.open(dir);
  assertFalse(IndexWriter.isLocked(dir));
  long version=DirectoryReader.getCurrentVersion(dir);
  reader.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE));
  addDocumentWithFields(writer);
  writer.close();
  reader=IndexReader.open(dir);
  assertTrue("old version is " + version + "; new version is "+ DirectoryReader.getCurrentVersion(dir),version < IndexReader.getCurrentVersion(dir));
  reader.close();
  dir.close();
}
