{
  Directory d=newDirectory();
  Map<String,String> commitUserData=new HashMap<String,String>();
  commitUserData.put("foo","fighters");
  IndexWriter writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMaxBufferedDocs(2));
  for (int i=0; i < 27; i++)   addDocumentWithFields(writer);
  writer.close();
  IndexReader r=IndexReader.open(d,false);
  r.deleteDocument(5);
  r.flush(commitUserData);
  IndexCommit c=r.getIndexCommit();
  r.close();
  SegmentInfos sis=new SegmentInfos();
  sis.read(d);
  IndexReader r2=IndexReader.open(d,false);
  assertEquals(c.getUserData(),commitUserData);
  assertEquals(sis.getCurrentSegmentFileName(),c.getSegmentsFileName());
  writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setMaxBufferedDocs(2));
  for (int i=0; i < 7; i++)   addDocumentWithFields(writer);
  writer.close();
  IndexReader r3=IndexReader.openIfChanged(r2);
  assertNotNull(r3);
  assertFalse(c.equals(r3.getIndexCommit()));
  assertFalse(r2.getIndexCommit().getSegmentCount() == 1 && !r2.hasDeletions());
  r3.close();
  writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND));
  writer.forceMerge(1);
  writer.close();
  r3=IndexReader.openIfChanged(r2);
  assertNotNull(r3);
  assertEquals(1,r3.getIndexCommit().getSegmentCount());
  r2.close();
  r3.close();
  d.close();
}
