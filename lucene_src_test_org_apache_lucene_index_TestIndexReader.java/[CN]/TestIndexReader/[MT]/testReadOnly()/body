{
  Directory d=newDirectory();
  IndexWriter writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  addDocumentWithFields(writer);
  writer.commit();
  addDocumentWithFields(writer);
  writer.close();
  IndexReader r=IndexReader.open(d,true);
  try {
    r.deleteDocument(0);
    fail();
  }
 catch (  UnsupportedOperationException uoe) {
  }
  writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setMergePolicy(newLogMergePolicy(10)));
  addDocumentWithFields(writer);
  writer.close();
  IndexReader r2=IndexReader.openIfChanged(r);
  assertNotNull(r2);
  r.close();
  assertFalse(r == r2);
  try {
    r2.deleteDocument(0);
    fail();
  }
 catch (  UnsupportedOperationException uoe) {
  }
  writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND));
  writer.forceMerge(1);
  writer.close();
  IndexReader r3=IndexReader.openIfChanged(r2);
  assertNotNull(r3);
  assertFalse(r3 == r2);
  r2.close();
  assertFalse(r == r2);
  try {
    r3.deleteDocument(0);
    fail();
  }
 catch (  UnsupportedOperationException uoe) {
  }
  writer=new IndexWriter(d,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND));
  writer.close();
  r3.close();
  d.close();
}
