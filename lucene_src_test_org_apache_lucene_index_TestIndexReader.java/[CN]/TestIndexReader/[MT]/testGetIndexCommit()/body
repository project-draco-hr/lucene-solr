{
  RAMDirectory d=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(d,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(2));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  for (int i=0; i < 27; i++)   addDocumentWithFields(writer);
  writer.close();
  SegmentInfos sis=new SegmentInfos();
  sis.read(d,CodecProvider.getDefault());
  IndexReader r=IndexReader.open(d,false);
  IndexCommit c=r.getIndexCommit();
  assertEquals(sis.getCurrentSegmentFileName(),c.getSegmentsFileName());
  assertTrue(c.equals(r.getIndexCommit()));
  writer=new IndexWriter(d,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND).setMaxBufferedDocs(2));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  for (int i=0; i < 7; i++)   addDocumentWithFields(writer);
  writer.close();
  IndexReader r2=r.reopen();
  assertFalse(c.equals(r2.getIndexCommit()));
  assertFalse(r2.getIndexCommit().isOptimized());
  r2.close();
  writer=new IndexWriter(d,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  writer.optimize();
  writer.close();
  r2=r.reopen();
  assertTrue(r2.getIndexCommit().isOptimized());
  r.close();
  r2.close();
  d.close();
}
