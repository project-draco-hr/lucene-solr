{
  for (int i=0; i < 2; i++) {
    final Directory dir=newDirectory();
    assertFalse(DirectoryReader.indexExists(dir));
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE));
    addDocumentWithFields(writer);
    assertTrue(IndexWriter.isLocked(dir));
    writer.close();
    assertTrue(DirectoryReader.indexExists(dir));
    IndexReader reader=IndexReader.open(dir);
    assertFalse(IndexWriter.isLocked(dir));
    long version=DirectoryReader.lastModified(dir);
    if (i == 1) {
      long version2=DirectoryReader.lastModified(dir);
      assertEquals(version,version2);
    }
    reader.close();
    Thread.sleep(1000);
    writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE));
    addDocumentWithFields(writer);
    writer.close();
    reader=IndexReader.open(dir);
    assertTrue("old lastModified is " + version + "; new lastModified is "+ DirectoryReader.lastModified(dir),version <= IndexReader.lastModified(dir));
    reader.close();
    dir.close();
  }
}
