{
  Directory dir=newDirectory(random);
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()));
  addDocumentWithFields(writer);
  writer.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  IndexReader reader=IndexReader.open(dir,false);
  try {
    reader.deleteDocument(0);
    fail("expected lock");
  }
 catch (  IOException e) {
  }
  try {
    IndexWriter.unlock(dir);
  }
 catch (  LockReleaseFailedException lrfe) {
    writer.close();
  }
  reader.deleteDocument(0);
  reader.close();
  writer.close();
  dir.close();
}
