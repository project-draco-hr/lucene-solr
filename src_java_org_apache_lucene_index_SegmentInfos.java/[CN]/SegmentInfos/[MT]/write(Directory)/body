{
  String segmentFileName=getNextSegmentFileName();
  if (generation == -1) {
    generation=1;
  }
 else {
    generation++;
  }
  ChecksumIndexOutput output=new ChecksumIndexOutput(directory.createOutput(segmentFileName));
  boolean success=false;
  try {
    output.writeInt(CURRENT_FORMAT);
    output.writeLong(++version);
    output.writeInt(counter);
    output.writeInt(size());
    for (int i=0; i < size(); i++) {
      info(i).write(output);
    }
    final long checksum=output.getChecksum();
    output.writeLong(checksum);
    success=true;
  }
  finally {
    boolean success2=false;
    try {
      if (!success) {
        try {
          output.close();
          success2=true;
        }
 catch (        Throwable t) {
        }
      }
 else {
        output.close();
        success2=true;
      }
    }
  finally {
      if (!success || !success2) {
        try {
          directory.deleteFile(segmentFileName);
        }
 catch (        Throwable t) {
        }
      }
    }
  }
  try {
    IndexOutput genOutput=directory.createOutput(IndexFileNames.SEGMENTS_GEN);
    try {
      genOutput.writeInt(FORMAT_LOCKLESS);
      genOutput.writeLong(generation);
      genOutput.writeLong(generation);
    }
  finally {
      genOutput.close();
    }
  }
 catch (  IOException e) {
  }
  lastGeneration=generation;
}
