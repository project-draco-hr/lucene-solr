{
  if (generation == -1) {
    generation=1;
  }
 else {
    generation++;
  }
  String segmentFileName=getCurrentSegmentFileName();
  IndexOutput output=directory.createOutput(segmentFileName);
  try {
    output.writeInt(FORMAT_LOCKLESS);
    output.writeLong(++version);
    output.writeInt(counter);
    output.writeInt(size());
    for (int i=0; i < size(); i++) {
      SegmentInfo si=info(i);
      si.write(output);
    }
  }
  finally {
    output.close();
  }
  try {
    output=directory.createOutput(IndexFileNames.SEGMENTS_GEN);
    output.writeInt(FORMAT_LOCKLESS);
    output.writeLong(generation);
    output.writeLong(generation);
    output.close();
  }
 catch (  IOException e) {
  }
}
