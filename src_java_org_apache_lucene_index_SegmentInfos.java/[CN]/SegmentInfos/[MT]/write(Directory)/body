{
  String segmentFileName=getNextSegmentFileName();
  if (generation == -1) {
    generation=1;
  }
 else {
    generation++;
  }
  IndexOutput output=directory.createOutput(segmentFileName);
  try {
    output.writeInt(FORMAT_SINGLE_NORM_FILE);
    output.writeLong(++version);
    output.writeInt(counter);
    output.writeInt(size());
    for (int i=0; i < size(); i++) {
      info(i).write(output);
    }
  }
  finally {
    output.close();
  }
  try {
    output=directory.createOutput(IndexFileNames.SEGMENTS_GEN);
    try {
      output.writeInt(FORMAT_LOCKLESS);
      output.writeLong(generation);
      output.writeLong(generation);
    }
  finally {
      output.close();
    }
  }
 catch (  IOException e) {
  }
  lastGeneration=generation;
}
