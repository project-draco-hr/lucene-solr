{
  OutputStream output=directory.createFile("segments.new");
  try {
    output.writeInt(counter);
    output.writeInt(size());
    for (int i=0; i < size(); i++) {
      SegmentInfo si=info(i);
      output.writeString(si.name);
      output.writeInt(si.docCount);
    }
    output.writeLong(++version);
  }
  finally {
    output.close();
  }
  directory.renameFile("segments.new","segments");
}
