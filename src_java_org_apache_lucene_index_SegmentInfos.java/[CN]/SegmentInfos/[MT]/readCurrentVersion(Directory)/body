{
  return ((Long)new FindSegmentsFile(directory){
    protected Object doBody(    String segmentFileName) throws CorruptIndexException, IOException {
      IndexInput input=directory.openInput(segmentFileName);
      int format=0;
      long version=0;
      try {
        format=input.readInt();
        if (format < 0) {
          if (format < FORMAT_SINGLE_NORM_FILE)           throw new CorruptIndexException("Unknown format version: " + format);
          version=input.readLong();
        }
      }
  finally {
        input.close();
      }
      if (format < 0)       return new Long(version);
      SegmentInfos sis=new SegmentInfos();
      sis.read(directory,segmentFileName);
      return new Long(sis.getVersion());
    }
  }
.run()).longValue();
}
