{
  String segmentFileName=null;
  long lastGen=-1;
  long gen=0;
  int genLookaheadCount=0;
  IOException exc=null;
  boolean retry=false;
  int method=0;
  while (true) {
    String[] files=null;
    if (0 == method) {
      if (directory != null) {
        files=directory.list();
        if (files == null)         throw new FileNotFoundException("cannot read directory " + directory + ": list() returned null");
      }
 else {
        files=fileDirectory.list();
        if (files == null)         throw new FileNotFoundException("cannot read directory " + fileDirectory + ": list() returned null");
      }
      gen=getCurrentSegmentGeneration(files);
      if (gen == -1) {
        String s="";
        for (int i=0; i < files.length; i++) {
          s+=" " + files[i];
        }
        throw new FileNotFoundException("no segments* file found in " + directory + ": files:"+ s);
      }
    }
    if (1 == method || (0 == method && lastGen == gen && retry)) {
      method=1;
      for (int i=0; i < defaultGenFileRetryCount; i++) {
        IndexInput genInput=null;
        try {
          genInput=directory.openInput(IndexFileNames.SEGMENTS_GEN);
        }
 catch (        IOException e) {
          message("segments.gen open: IOException " + e);
        }
        if (genInput != null) {
          try {
            int version=genInput.readInt();
            if (version == FORMAT_LOCKLESS) {
              long gen0=genInput.readLong();
              long gen1=genInput.readLong();
              message("fallback check: " + gen0 + "; "+ gen1);
              if (gen0 == gen1) {
                if (gen0 > gen) {
                  message("fallback to '" + IndexFileNames.SEGMENTS_GEN + "' check: now try generation "+ gen0+ " > "+ gen);
                  gen=gen0;
                }
                break;
              }
            }
          }
 catch (          IOException err2) {
          }
 finally {
            genInput.close();
          }
        }
        try {
          Thread.sleep(defaultGenFileRetryPauseMsec);
        }
 catch (        InterruptedException e) {
        }
      }
    }
    if (2 == method || (1 == method && lastGen == gen && retry)) {
      method=2;
      if (genLookaheadCount < defaultGenLookaheadCount) {
        gen++;
        genLookaheadCount++;
        message("look ahead increment gen to " + gen);
      }
    }
    if (lastGen == gen) {
      if (retry) {
        throw exc;
      }
 else {
        retry=true;
      }
    }
 else {
      retry=false;
    }
    lastGen=gen;
    segmentFileName=IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",gen);
    try {
      Object v=doBody(segmentFileName);
      if (exc != null) {
        message("success on " + segmentFileName);
      }
      return v;
    }
 catch (    IOException err) {
      if (exc == null) {
        exc=err;
      }
      message("primary Exception on '" + segmentFileName + "': "+ err+ "'; will retry: retry="+ retry+ "; gen = "+ gen);
      if (!retry && gen > 1) {
        String prevSegmentFileName=IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",gen - 1);
        if (directory.fileExists(prevSegmentFileName)) {
          message("fallback to prior segment file '" + prevSegmentFileName + "'");
          try {
            Object v=doBody(prevSegmentFileName);
            if (exc != null) {
              message("success on fallback " + prevSegmentFileName);
            }
            return v;
          }
 catch (          IOException err2) {
            message("secondary Exception on '" + prevSegmentFileName + "': "+ err2+ "'; will retry");
          }
        }
      }
    }
  }
}
