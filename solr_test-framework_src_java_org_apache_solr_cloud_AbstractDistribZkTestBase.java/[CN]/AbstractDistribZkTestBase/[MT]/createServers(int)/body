{
  File controlHome=new File(new File(getSolrHome()).getParentFile(),"control" + homeCount.incrementAndGet());
  FileUtils.copyDirectory(new File(getSolrHome()),controlHome);
  System.setProperty("collection","control_collection");
  String numShardsS=System.getProperty(ZkStateReader.NUM_SHARDS_PROP);
  System.setProperty(ZkStateReader.NUM_SHARDS_PROP,"1");
  controlJetty=createJetty(controlHome,null);
  System.clearProperty("collection");
  if (numShardsS != null) {
    System.setProperty(ZkStateReader.NUM_SHARDS_PROP,numShardsS);
  }
 else {
    System.clearProperty(ZkStateReader.NUM_SHARDS_PROP);
  }
  controlClient=createNewSolrServer(controlJetty.getLocalPort());
  StringBuilder sb=new StringBuilder();
  for (int i=1; i <= numShards; i++) {
    if (sb.length() > 0)     sb.append(',');
    File jettyHome=new File(new File(getSolrHome()).getParentFile(),"jetty" + homeCount.incrementAndGet());
    FileUtils.copyDirectory(new File(getSolrHome()),jettyHome);
    JettySolrRunner j=createJetty(jettyHome,null,"shard" + (i + 2));
    jettys.add(j);
    clients.add(createNewSolrServer(j.getLocalPort()));
    sb.append("127.0.0.1:").append(j.getLocalPort()).append(context);
  }
  shards=sb.toString();
  for (int i=1; i <= numShards; i++) {
    ZkStateReader zkStateReader=((SolrDispatchFilter)jettys.get(0).getDispatchFilter().getFilter()).getCores().getZkController().getZkStateReader();
    zkStateReader.getLeaderRetry("collection1","shard" + (i + 2),15000);
  }
}
