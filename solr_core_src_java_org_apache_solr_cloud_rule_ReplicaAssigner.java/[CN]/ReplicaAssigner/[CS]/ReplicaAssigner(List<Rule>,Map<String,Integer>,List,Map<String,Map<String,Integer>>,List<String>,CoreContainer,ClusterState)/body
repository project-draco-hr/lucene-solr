{
  this.rules=rules;
  for (  Rule rule : rules)   tagNames.add(rule.tag.name);
  this.shardVsReplicaCount=shardVsReplicaCount;
  this.participatingLiveNodes=new ArrayList<>(participatingLiveNodes);
  this.nodeVsTags=getTagsForNodes(cc,snitches);
  this.shardVsNodes=getDeepCopy(shardVsNodes,2);
  validateTags(nodeVsTags);
  if (clusterState != null) {
    Map<String,DocCollection> collections=clusterState.getCollectionsMap();
    for (    Map.Entry<String,DocCollection> entry : collections.entrySet()) {
      DocCollection coll=entry.getValue();
      for (      Slice slice : coll.getSlices()) {
        for (        Replica replica : slice.getReplicas()) {
          AtomicInteger count=nodeVsCores.get(replica.getNodeName());
          if (count == null)           nodeVsCores.put(replica.getNodeName(),count=new AtomicInteger());
          count.incrementAndGet();
        }
      }
    }
  }
}
