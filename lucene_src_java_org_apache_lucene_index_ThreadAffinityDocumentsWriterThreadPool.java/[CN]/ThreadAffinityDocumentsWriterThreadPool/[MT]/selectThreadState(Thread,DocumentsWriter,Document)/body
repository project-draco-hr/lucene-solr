{
  AffinityThreadState threadState=threadBindings.get(requestingThread);
  if (threadState == null) {
    AffinityThreadState minThreadState=null;
    for (int i=0; i < allThreadStates.length; i++) {
      AffinityThreadState ts=(AffinityThreadState)allThreadStates[i];
      if (minThreadState == null || ts.numAssignedThreads < minThreadState.numAssignedThreads)       minThreadState=ts;
    }
    if (minThreadState != null && (minThreadState.numAssignedThreads == 0 || allThreadStates.length >= maxNumThreadStates)) {
      threadState=minThreadState;
    }
 else {
      threadState=addNewThreadState(documentsWriter,new AffinityThreadState());
    }
    threadBindings.put(requestingThread,threadState);
  }
  threadState.numAssignedThreads++;
  return threadState;
}
