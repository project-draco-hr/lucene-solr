{
  localParams=QueryParsing.getLocalParams(param,req.getParams());
  base=docs;
  facetValue=param;
  key=param;
  threads=-1;
  if (localParams == null)   return;
  if (type != FacetParams.FACET_QUERY) {
    facetValue=localParams.get(CommonParams.VALUE);
  }
  key=facetValue;
  key=localParams.get(CommonParams.OUTPUT_KEY,key);
  String threadStr=localParams.get(CommonParams.THREADS);
  if (threadStr != null) {
    threads=Integer.parseInt(threadStr);
  }
  String excludeStr=localParams.get(CommonParams.EXCLUDE);
  if (excludeStr == null)   return;
  Map tagMap=(Map)req.getContext().get("tags");
  if (tagMap != null && rb != null) {
    List<String> excludeTagList=StrUtils.splitSmart(excludeStr,',');
    IdentityHashMap<Query,Boolean> excludeSet=new IdentityHashMap<Query,Boolean>();
    for (    String excludeTag : excludeTagList) {
      Object olst=tagMap.get(excludeTag);
      if (!(olst instanceof Collection))       continue;
      for (      Object o : (Collection)olst) {
        if (!(o instanceof QParser))         continue;
        QParser qp=(QParser)o;
        excludeSet.put(qp.getQuery(),Boolean.TRUE);
      }
    }
    if (excludeSet.size() == 0)     return;
    List<Query> qlist=new ArrayList<Query>();
    if (!excludeSet.containsKey(rb.getQuery())) {
      qlist.add(rb.getQuery());
    }
    if (rb.getFilters() != null) {
      for (      Query q : rb.getFilters()) {
        if (!excludeSet.containsKey(q)) {
          qlist.add(q);
        }
      }
    }
    base=searcher.getDocSet(qlist);
  }
}
