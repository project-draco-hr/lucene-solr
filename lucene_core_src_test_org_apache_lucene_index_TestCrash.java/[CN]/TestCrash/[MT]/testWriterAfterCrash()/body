{
  if (VERBOSE) {
    System.out.println("TEST: initIndex");
  }
  IndexWriter writer=initIndex(random(),true);
  if (VERBOSE) {
    System.out.println("TEST: done initIndex");
  }
  MockDirectoryWrapper dir=(MockDirectoryWrapper)writer.getDirectory();
  dir.setAssertNoUnrefencedFilesOnClose(false);
  dir.setPreventDoubleWrite(false);
  if (VERBOSE) {
    System.out.println("TEST: now crash");
  }
  crash(writer);
  writer=initIndex(random(),dir,false,true);
  writer.close();
  IndexReader reader=DirectoryReader.open(dir);
  assertTrue(reader.numDocs() < 314);
  reader.close();
  Directory dir2=newDirectory(dir);
  dir.close();
  new RandomIndexWriter(random(),dir2).close();
  dir2.close();
}
