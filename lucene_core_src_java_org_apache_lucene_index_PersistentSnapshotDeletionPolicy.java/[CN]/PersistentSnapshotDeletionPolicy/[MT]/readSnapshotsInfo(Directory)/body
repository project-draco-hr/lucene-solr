{
  IndexReader r=DirectoryReader.open(dir);
  Map<String,String> snapshots=new HashMap<String,String>();
  try {
    int numDocs=r.numDocs();
    if (numDocs == 1) {
      StoredDocument doc=r.document(r.maxDoc() - 1);
      if (doc.getField(SNAPSHOTS_ID) == null) {
        throw new IllegalStateException("directory is not a valid snapshots store!");
      }
      for (      StorableField f : doc) {
        if (!f.name().equals(SNAPSHOTS_ID))         snapshots.put(f.name(),f.stringValue());
      }
    }
 else     if (numDocs != 0) {
      throw new IllegalStateException("should be at most 1 document in the snapshots directory: " + numDocs);
    }
  }
  finally {
    r.close();
  }
  return snapshots;
}
