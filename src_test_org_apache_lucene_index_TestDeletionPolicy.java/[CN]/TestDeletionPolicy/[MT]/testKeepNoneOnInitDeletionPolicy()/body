{
  for (int pass=0; pass < 2; pass++) {
    boolean useCompoundFile=(pass % 2) != 0;
    KeepNoneOnInitDeletionPolicy policy=new KeepNoneOnInitDeletionPolicy();
    Directory dir=new RAMDirectory();
    IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(TEST_VERSION_CURRENT),true,policy,IndexWriter.MaxFieldLength.UNLIMITED);
    writer.setMaxBufferedDocs(10);
    writer.setUseCompoundFile(useCompoundFile);
    for (int i=0; i < 107; i++) {
      addDoc(writer);
    }
    writer.close();
    writer=new IndexWriter(dir,new WhitespaceAnalyzer(TEST_VERSION_CURRENT),false,policy,IndexWriter.MaxFieldLength.UNLIMITED);
    writer.setUseCompoundFile(useCompoundFile);
    writer.optimize();
    writer.close();
    assertEquals(2,policy.numOnInit);
    assertEquals(2,policy.numOnCommit);
    IndexReader reader=IndexReader.open(dir,true);
    reader.close();
    dir.close();
  }
}
