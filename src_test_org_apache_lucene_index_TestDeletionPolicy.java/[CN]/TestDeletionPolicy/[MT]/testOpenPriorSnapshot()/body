{
  KeepAllDeletionPolicy policy=new KeepAllDeletionPolicy();
  Directory dir=new MockRAMDirectory();
  policy.dir=dir;
  IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),policy,IndexWriter.MaxFieldLength.LIMITED);
  writer.setMaxBufferedDocs(2);
  for (int i=0; i < 10; i++) {
    addDoc(writer);
    if ((1 + i) % 2 == 0)     writer.commit();
  }
  writer.close();
  Collection<IndexCommit> commits=IndexReader.listCommits(dir);
  assertEquals(6,commits.size());
  IndexCommit lastCommit=null;
  for (  final IndexCommit commit : commits) {
    if (lastCommit == null || commit.getGeneration() > lastCommit.getGeneration())     lastCommit=commit;
  }
  assertTrue(lastCommit != null);
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),policy,IndexWriter.MaxFieldLength.LIMITED);
  addDoc(writer);
  assertEquals(11,writer.numDocs());
  writer.optimize();
  writer.close();
  assertEquals(7,IndexReader.listCommits(dir).size());
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),policy,IndexWriter.MaxFieldLength.LIMITED,lastCommit);
  assertEquals(10,writer.numDocs());
  writer.rollback();
  IndexReader r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(11,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),policy,IndexWriter.MaxFieldLength.LIMITED,lastCommit);
  assertEquals(10,writer.numDocs());
  writer.close();
  assertEquals(8,IndexReader.listCommits(dir).size());
  r=IndexReader.open(dir,true);
  assertTrue(!r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),policy,IndexWriter.MaxFieldLength.LIMITED);
  writer.optimize();
  writer.close();
  r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),new KeepOnlyLastCommitDeletionPolicy(),IndexWriter.MaxFieldLength.LIMITED,lastCommit);
  assertEquals(10,writer.numDocs());
  r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer.close();
  r=IndexReader.open(dir,true);
  assertTrue(!r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  dir.close();
}
