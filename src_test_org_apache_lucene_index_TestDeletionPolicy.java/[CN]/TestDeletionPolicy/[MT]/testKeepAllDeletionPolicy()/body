{
  for (int pass=0; pass < 2; pass++) {
    boolean useCompoundFile=(pass % 2) != 0;
    KeepAllDeletionPolicy policy=new KeepAllDeletionPolicy();
    Directory dir=new RAMDirectory();
    policy.dir=dir;
    IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT).setIndexDeletionPolicy(policy).setMaxBufferedDocs(10).setMergeScheduler(new SerialMergeScheduler()));
    LogMergePolicy lmp=(LogMergePolicy)writer.getMergePolicy();
    lmp.setUseCompoundFile(useCompoundFile);
    lmp.setUseCompoundDocStore(useCompoundFile);
    for (int i=0; i < 107; i++) {
      addDoc(writer);
    }
    writer.close();
    writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT).setOpenMode(OpenMode.APPEND).setIndexDeletionPolicy(policy));
    lmp=(LogMergePolicy)writer.getMergePolicy();
    lmp.setUseCompoundFile(useCompoundFile);
    lmp.setUseCompoundDocStore(useCompoundFile);
    writer.optimize();
    writer.close();
    assertEquals(2,policy.numOnInit);
    assertEquals(2,policy.numOnCommit);
    Collection<IndexCommit> commits=IndexReader.listCommits(dir);
    assertEquals(3,commits.size());
    for (    final IndexCommit commit : commits) {
      IndexReader r=IndexReader.open(commit,null,false);
      r.close();
    }
    dir.deleteFile(IndexFileNames.SEGMENTS_GEN);
    long gen=SegmentInfos.getCurrentSegmentGeneration(dir);
    while (gen > 0) {
      IndexReader reader=IndexReader.open(dir,true);
      reader.close();
      dir.deleteFile(IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",gen));
      gen--;
      if (gen > 0) {
        int preCount=dir.listAll().length;
        writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT).setOpenMode(OpenMode.APPEND).setIndexDeletionPolicy(policy));
        writer.close();
        int postCount=dir.listAll().length;
        assertTrue(postCount < preCount);
      }
    }
    dir.close();
  }
}
