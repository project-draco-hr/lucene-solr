{
  Directory ram=new RAMDirectory();
  PayloadAnalyzer analyzer=new PayloadAnalyzer();
  IndexWriter writer=new IndexWriter(ram,analyzer,true);
  Document d=new Document();
  d.add(new Field("f1","This field has no payloads",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f2","This field has payloads in all docs",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f2","This field has payloads in all docs",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f3","This field has payloads in some docs",Field.Store.NO,Field.Index.TOKENIZED));
  analyzer.setPayloadData("f2",1,"somedata".getBytes(),0,1);
  writer.addDocument(d);
  writer.close();
  SegmentReader reader=(SegmentReader)IndexReader.open(ram);
  FieldInfos fi=reader.fieldInfos();
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f1").storePayloads);
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f2").storePayloads);
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f3").storePayloads);
  reader.close();
  writer=new IndexWriter(ram,analyzer,true);
  d=new Document();
  d.add(new Field("f1","This field has no payloads",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f2","This field has payloads in all docs",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f2","This field has payloads in all docs",Field.Store.NO,Field.Index.TOKENIZED));
  d.add(new Field("f3","This field has payloads in some docs",Field.Store.NO,Field.Index.TOKENIZED));
  analyzer.setPayloadData("f2","somedata".getBytes(),0,1);
  analyzer.setPayloadData("f3","somedata".getBytes(),0,3);
  writer.addDocument(d);
  writer.optimize();
  writer.close();
  reader=(SegmentReader)IndexReader.open(ram);
  fi=reader.fieldInfos();
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f1").storePayloads);
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f2").storePayloads);
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f3").storePayloads);
  reader.close();
}
