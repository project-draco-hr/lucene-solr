{
  if (firstPassGroupingCollector.getClass().isAssignableFrom(TermFirstPassGroupingCollector.class)) {
    @SuppressWarnings("unchecked") Collection<SearchGroup<BytesRef>> searchGroups=firstPassGroupingCollector.getTopGroups(groupOffset,fillSortFields);
    return new TermSecondPassGroupingCollector(groupField,searchGroups,groupSort,sortWithinGroup,maxDocsPerGroup,getScores,getMaxScores,fillSortFields);
  }
 else {
    ValueSource vs=new BytesRefFieldSource(groupField);
    @SuppressWarnings("unchecked") Collection<SearchGroup<MutableValue>> searchGroups=firstPassGroupingCollector.getTopGroups(groupOffset,fillSortFields);
    return new FunctionSecondPassGroupingCollector(searchGroups,groupSort,sortWithinGroup,maxDocsPerGroup,getScores,getMaxScores,fillSortFields,vs,new HashMap());
  }
}
