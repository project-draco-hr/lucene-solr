{
  FacetComponentState facetState=getFacetComponentState(rb);
  if (facetState == null)   return;
  boolean isShard=rb.req.getParams().getBool(ShardParams.IS_SHARD,false);
  FacetContext fcontext=new FacetContext();
  fcontext.base=rb.getResults().docSet;
  fcontext.req=rb.req;
  fcontext.searcher=rb.req.getSearcher();
  fcontext.qcontext=QueryContext.newContext(fcontext.searcher);
  if (isShard) {
    fcontext.flags|=FacetContext.IS_SHARD;
  }
  FacetProcessor fproc=facetState.facetRequest.createFacetProcessor(fcontext);
  fproc.process();
  rb.rsp.add("facets",fproc.getResponse());
}
