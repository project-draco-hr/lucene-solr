{
  Directory dir=new RAMDirectory();
  Directory aux=new RAMDirectory();
  Directory aux2=new RAMDirectory();
  IndexWriter writer=null;
  writer=newWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE));
  addDocs(writer,100);
  assertEquals(100,writer.maxDoc());
  writer.close();
  _TestUtil.checkIndex(dir);
  writer=newWriter(aux,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE));
  ((LogMergePolicy)writer.getConfig().getMergePolicy()).setUseCompoundFile(false);
  ((LogMergePolicy)writer.getConfig().getMergePolicy()).setUseCompoundDocStore(false);
  addDocs(writer,40);
  assertEquals(40,writer.maxDoc());
  writer.close();
  writer=newWriter(aux2,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE));
  addDocs2(writer,50);
  assertEquals(50,writer.maxDoc());
  writer.close();
  writer=newWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  assertEquals(100,writer.maxDoc());
  writer.addIndexes(new Directory[]{aux,aux2});
  assertEquals(190,writer.maxDoc());
  writer.close();
  _TestUtil.checkIndex(dir);
  verifyNumDocs(aux,40);
  verifyNumDocs(dir,190);
  Directory aux3=new RAMDirectory();
  writer=newWriter(aux3,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()));
  addDocs(writer,40);
  assertEquals(40,writer.maxDoc());
  writer.close();
  writer=newWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  assertEquals(190,writer.maxDoc());
  writer.addIndexes(new Directory[]{aux3});
  assertEquals(230,writer.maxDoc());
  writer.close();
  verifyNumDocs(dir,230);
  verifyTermDocs(dir,new Term("content","aaa"),180);
  verifyTermDocs(dir,new Term("content","bbb"),50);
  writer=newWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  writer.optimize();
  writer.close();
  verifyNumDocs(dir,230);
  verifyTermDocs(dir,new Term("content","aaa"),180);
  verifyTermDocs(dir,new Term("content","bbb"),50);
  Directory aux4=new RAMDirectory();
  writer=newWriter(aux4,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()));
  addDocs2(writer,1);
  writer.close();
  writer=newWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  assertEquals(230,writer.maxDoc());
  writer.addIndexes(new Directory[]{aux4});
  assertEquals(231,writer.maxDoc());
  writer.close();
  verifyNumDocs(dir,231);
  verifyTermDocs(dir,new Term("content","bbb"),51);
}
