{
  final Directory dir=newDirectory();
  final IndexWriterConfig config=newIndexWriterConfig(Version.LUCENE_31,new MockAnalyzer(random));
  config.setCodecProvider(new MockSepCodecs());
  final IndexWriter writer=new IndexWriter(dir,config);
  try {
    final PhraseQuery pq=new PhraseQuery();
    pq.add(new Term("content","bbb"));
    pq.add(new Term("content","ccc"));
    final Document doc=new Document();
    doc.add(newField("content","aaa bbb ccc ddd",Store.NO,Field.Index.ANALYZED_NO_NORMS));
    writer.addDocument(doc);
    writer.commit();
    ScoreDoc[] results=this.search(writer,pq,5);
    assertEquals(1,results.length);
    assertEquals(0,results[0].doc);
    writer.addDocument(doc);
    writer.commit();
    results=this.search(writer,pq,5);
    assertEquals(2,results.length);
    assertEquals(0,results[0].doc);
    writer.optimize();
    results=this.search(writer,pq,5);
    assertEquals(2,results.length);
    assertEquals(0,results[0].doc);
  }
  finally {
    writer.close();
    dir.close();
  }
}
