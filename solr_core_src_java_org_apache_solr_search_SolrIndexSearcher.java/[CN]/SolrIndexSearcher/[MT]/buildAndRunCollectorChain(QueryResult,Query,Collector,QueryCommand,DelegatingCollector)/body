{
  final boolean terminateEarly=cmd.getTerminateEarly();
  if (terminateEarly) {
    collector=new EarlyTerminatingCollector(collector,cmd.getLen());
  }
  final long timeAllowed=cmd.getTimeAllowed();
  if (timeAllowed > 0) {
    collector=new TimeLimitingCollector(collector,TimeLimitingCollector.getGlobalCounter(),timeAllowed);
  }
  if (postFilter != null) {
    postFilter.setLastDelegate(collector);
    collector=postFilter;
  }
  try {
    super.search(query,collector);
  }
 catch (  TimeLimitingCollector.TimeExceededException|ExitableDirectoryReader.ExitingReaderException x) {
    log.warn("Query: " + query + "; "+ x.getMessage());
    qr.setPartialResults(true);
  }
catch (  EarlyTerminatingCollectorException etce) {
    if (collector instanceof DelegatingCollector) {
      ((DelegatingCollector)collector).finish();
    }
    throw etce;
  }
  if (collector instanceof DelegatingCollector) {
    ((DelegatingCollector)collector).finish();
  }
}
