{
  DocSetCollector collector=new DocSetCollector(maxDoc() >> 6,maxDoc());
  if (filter == null) {
    if (query instanceof TermQuery) {
      Term t=((TermQuery)query).getTerm();
      final AtomicReaderContext[] leaves=leafContexts;
      for (int i=0; i < leaves.length; i++) {
        final AtomicReaderContext leaf=leaves[i];
        final IndexReader reader=leaf.reader;
        collector.setNextReader(leaf);
        Fields fields=reader.fields();
        Terms terms=fields.terms(t.field());
        BytesRef termBytes=t.bytes();
        Bits liveDocs=reader.getLiveDocs();
        DocsEnum docsEnum=null;
        if (terms != null) {
          final TermsEnum termsEnum=terms.iterator(null);
          if (termsEnum.seekExact(termBytes,false)) {
            docsEnum=termsEnum.docs(MultiFields.getLiveDocs(reader),null);
          }
        }
        if (docsEnum != null) {
          int docid;
          while ((docid=docsEnum.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
            collector.collect(docid);
          }
        }
      }
    }
 else {
      super.search(query,null,collector);
    }
    return collector.getDocSet();
  }
 else {
    Filter luceneFilter=filter.getTopFilter();
    super.search(query,luceneFilter,collector);
    return collector.getDocSet();
  }
}
