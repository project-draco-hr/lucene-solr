{
  MultiPhraseQuery mpq=newMultiPhraseQuery();
  mpq.setSlop(slop);
  TermToBytesRefAttribute termAtt=stream.getAttribute(TermToBytesRefAttribute.class);
  BytesRef bytes=termAtt.getBytesRef();
  PositionIncrementAttribute posIncrAtt=stream.getAttribute(PositionIncrementAttribute.class);
  int position=-1;
  List<Term> multiTerms=new ArrayList<>();
  stream.reset();
  while (stream.incrementToken()) {
    termAtt.fillBytesRef();
    int positionIncrement=posIncrAtt.getPositionIncrement();
    if (positionIncrement > 0 && multiTerms.size() > 0) {
      if (enablePositionIncrements) {
        mpq.add(multiTerms.toArray(new Term[0]),position);
      }
 else {
        mpq.add(multiTerms.toArray(new Term[0]));
      }
      multiTerms.clear();
    }
    position+=positionIncrement;
    multiTerms.add(new Term(field,BytesRef.deepCopyOf(bytes)));
  }
  if (enablePositionIncrements) {
    mpq.add(multiTerms.toArray(new Term[0]),position);
  }
 else {
    mpq.add(multiTerms.toArray(new Term[0]));
  }
  return mpq;
}
