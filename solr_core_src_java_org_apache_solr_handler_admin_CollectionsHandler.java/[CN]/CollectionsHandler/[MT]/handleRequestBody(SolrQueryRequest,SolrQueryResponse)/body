{
  CoreContainer cores=getCoreContainer();
  if (cores == null) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Core container instance missing");
  }
  if (!cores.isZooKeeperAware()) {
    throw new SolrException(ErrorCode.BAD_REQUEST,"Solr instance is not running in SolrCloud mode.");
  }
  SolrParams params=req.getParams();
  String a=params.get(CoreAdminParams.ACTION);
  if (a != null) {
    CollectionAction action=CollectionAction.get(a);
    if (action == null) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Unknown action: " + a);
    }
    CollectionOperation operation=CollectionOperation.get(action);
    log.info("Invoked Collection Action :{} with params {} and sendToOCPQueue={}",action.toLower(),req.getParamString(),operation.sendToOCPQueue);
    SolrResponse response=null;
    Map<String,Object> props=operation.call(req,rsp,this);
    String asyncId=req.getParams().get(ASYNC);
    if (props != null) {
      if (asyncId != null) {
        props.put(ASYNC,asyncId);
      }
      props.put(QUEUE_OPERATION,operation.action.toLower());
      ZkNodeProps zkProps=new ZkNodeProps(props);
      if (operation.sendToOCPQueue) {
        response=handleResponse(operation.action.toLower(),zkProps,rsp,operation.timeOut);
      }
 else       Overseer.getStateUpdateQueue(coreContainer.getZkController().getZkClient()).offer(Utils.toJSON(props));
      final String collectionName=zkProps.getStr(NAME);
      if (action.equals(CollectionAction.CREATE) && asyncId == null) {
        if (rsp.getException() == null) {
          waitForActiveCollection(collectionName,zkProps,cores,response);
        }
      }
    }
  }
 else {
    throw new SolrException(ErrorCode.BAD_REQUEST,"action is a required param");
  }
  rsp.setHttpCaching(false);
}
