{
  final Codec codec=si.getCodec();
  final SegmentWriteState state=new SegmentWriteState(InfoStream.getDefault(),dir,si,fieldInfos,null,newIOContext(random()));
  Arrays.sort(fields);
  FieldsConsumer consumer=codec.postingsFormat().fieldsConsumer(state);
  boolean success=false;
  try {
    consumer.write(new DataFields(fields));
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(consumer);
    }
 else {
      IOUtils.closeWhileHandlingException(consumer);
    }
  }
}
