{
  final int termIndexInterval=_TestUtil.nextInt(random(),13,27);
  final Codec codec=Codec.getDefault();
  final SegmentInfo si=new SegmentInfo(dir,Constants.LUCENE_MAIN_VERSION,SEGMENT,10000,-1,SEGMENT,false,null,false,codec,null,null);
  final SegmentWriteState state=new SegmentWriteState(InfoStream.getDefault(),dir,si,fieldInfos,termIndexInterval,null,newIOContext(random()));
  final FieldsConsumer consumer=codec.postingsFormat().fieldsConsumer(state);
  Arrays.sort(fields);
  for (  final FieldData field : fields) {
    if (!allowPreFlex && codec instanceof Lucene3xCodec) {
      continue;
    }
    field.write(consumer);
  }
  consumer.close();
}
