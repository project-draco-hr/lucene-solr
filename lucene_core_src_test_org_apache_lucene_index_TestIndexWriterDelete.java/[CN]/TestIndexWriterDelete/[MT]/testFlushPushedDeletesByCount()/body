{
  Directory dir=newDirectory();
  final int flushAtDelCount=atLeast(1020);
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDeleteTerms(flushAtDelCount).setMaxBufferedDocs(1000).setRAMBufferSizeMB(IndexWriterConfig.DISABLE_AUTO_FLUSH).setMergePolicy(NoMergePolicy.INSTANCE).setReaderPooling(false));
  int count=0;
  while (true) {
    Document doc=new Document();
    doc.add(new StringField("id",count + "",Field.Store.NO));
    final Term delTerm;
    if (count == 1010) {
      delTerm=new Term("id","" + 0);
    }
 else {
      delTerm=new Term("id","x" + count);
    }
    w.updateDocument(delTerm,doc);
    if (slowFileExists(dir,"_0_1.del") || slowFileExists(dir,"_0_1.liv")) {
      break;
    }
    count++;
    if (count > flushAtDelCount) {
      fail("delete's were not applied at count=" + flushAtDelCount);
    }
  }
  w.shutdown();
  dir.close();
}
