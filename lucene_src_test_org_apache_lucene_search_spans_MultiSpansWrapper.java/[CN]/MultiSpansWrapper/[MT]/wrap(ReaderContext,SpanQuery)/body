{
  Map<Term,TermContext> termContexts=new HashMap<Term,TermContext>();
  TreeSet<Term> terms=new TreeSet<Term>();
  query.extractTerms(terms);
  for (  Term term : terms) {
    termContexts.put(term,TermContext.build(topLevelReaderContext,term,true));
  }
  AtomicReaderContext[] leaves=ReaderUtil.leaves(topLevelReaderContext);
  if (leaves.length == 1) {
    return query.getSpans(leaves[0],leaves[0].reader.getLiveDocs(),termContexts);
  }
  return new MultiSpansWrapper(leaves,query,termContexts);
}
