{
  final AtomicReference<Exception> exp=new AtomicReference<Exception>();
  final BlockingQueue<Map<String,Object>> blockingQueue=new ArrayBlockingQueue<Map<String,Object>>(batchSz);
  final AtomicBoolean isEnd=new AtomicBoolean(false);
  new Thread(){
    public void run(){
      try {
        xpathReader.streamRecords(data,new XPathRecordReader.Handler(){
          @SuppressWarnings("unchecked") public void handle(          Map<String,Object> record,          String xpath){
            if (isEnd.get())             return;
            try {
              blockingQueue.offer(readRow(record,xpath),10,TimeUnit.SECONDS);
            }
 catch (            Exception e) {
              isEnd.set(true);
            }
          }
        }
);
      }
 catch (      Exception e) {
        exp.set(e);
      }
 finally {
        closeIt(data);
        try {
          blockingQueue.offer(Collections.EMPTY_MAP,10,TimeUnit.SECONDS);
        }
 catch (        Exception e) {
        }
      }
    }
  }
.start();
  return new Iterator<Map<String,Object>>(){
    private Map<String,Object> lastRow;
    int count=0;
    public boolean hasNext(){
      return !isEnd.get();
    }
    public Map<String,Object> next(){
      try {
        Map<String,Object> row=blockingQueue.poll(10,TimeUnit.SECONDS);
        if (row == null || row == Collections.EMPTY_MAP) {
          isEnd.set(true);
          if (exp.get() != null) {
            String msg="Parsing failed for xml, url:" + s + " rows processed in this xml:"+ count;
            if (lastRow != null)             msg+=" last row in this xml:" + lastRow;
            if (ABORT.equals(onError)) {
              wrapAndThrow(SEVERE,exp.get(),msg);
            }
 else             if (SKIP.equals(onError)) {
              wrapAndThrow(DataImportHandlerException.SKIP,exp.get());
            }
 else {
              LOG.warn(msg,exp.get());
            }
          }
          return null;
        }
        count++;
        return lastRow=row;
      }
 catch (      InterruptedException e) {
        isEnd.set(true);
        return null;
      }
    }
    public void remove(){
    }
  }
;
}
