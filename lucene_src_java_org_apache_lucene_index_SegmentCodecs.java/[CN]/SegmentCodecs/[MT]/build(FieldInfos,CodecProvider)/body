{
  final int size=infos.size();
  final Map<Codec,Integer> codecRegistry=new IdentityHashMap<Codec,Integer>();
  final ArrayList<Codec> codecs=new ArrayList<Codec>();
  for (int i=0; i < size; i++) {
    final FieldInfo info=infos.fieldInfo(i);
    if (info.isIndexed || info.hasDocValues()) {
      final Codec fieldCodec=provider.lookup(provider.getFieldCodec(info.name));
      Integer ord=codecRegistry.get(fieldCodec);
      if (ord == null) {
        ord=Integer.valueOf(codecs.size());
        codecRegistry.put(fieldCodec,ord);
        codecs.add(fieldCodec);
      }
      info.codecId=ord.intValue();
    }
  }
  return new SegmentCodecs(provider,codecs.toArray(Codec.EMPTY));
}
