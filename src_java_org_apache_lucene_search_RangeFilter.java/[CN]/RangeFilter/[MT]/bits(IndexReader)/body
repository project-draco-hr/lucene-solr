{
  BitSet bits=new BitSet(reader.maxDoc());
  TermEnum enumerator=(null != lowerTerm ? reader.terms(new Term(fieldName,lowerTerm)) : reader.terms(new Term(fieldName)));
  try {
    if (enumerator.term() == null) {
      return bits;
    }
    boolean checkLower=false;
    if (!includeLower)     checkLower=true;
    TermDocs termDocs=reader.termDocs();
    try {
      do {
        Term term=enumerator.term();
        if (term != null && term.field().equals(fieldName)) {
          if (!checkLower || null == lowerTerm || term.text().compareTo(lowerTerm) > 0) {
            checkLower=false;
            if (upperTerm != null) {
              int compare=upperTerm.compareTo(term.text());
              if ((compare < 0) || (!includeUpper && compare == 0)) {
                break;
              }
            }
            termDocs.seek(enumerator.term());
            while (termDocs.next()) {
              bits.set(termDocs.doc());
            }
          }
        }
 else {
          break;
        }
      }
 while (enumerator.next());
    }
  finally {
      termDocs.close();
    }
  }
  finally {
    enumerator.close();
  }
  return bits;
}
