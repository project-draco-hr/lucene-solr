{
  deleteByQueryCommands.incrementAndGet();
  deleteByQueryCommandsCumulative.incrementAndGet();
  if (!cmd.fromPending && !cmd.fromCommitted) {
    numErrors.incrementAndGet();
    numErrorsCumulative.incrementAndGet();
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"meaningless command: " + cmd);
  }
  if (!cmd.fromPending || !cmd.fromCommitted) {
    numErrors.incrementAndGet();
    numErrorsCumulative.incrementAndGet();
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"operation not supported" + cmd);
  }
  boolean madeIt=false;
  boolean delAll=false;
  try {
    Query q=QueryParsing.parseQuery(cmd.query,schema);
    delAll=MatchAllDocsQuery.class == q.getClass();
    int totDeleted=0;
    iwCommit.lock();
    try {
      if (delAll) {
        deleteAll();
      }
 else {
        doDeletions();
        closeWriter();
        openSearcher();
        final DeleteHitCollector deleter=new DeleteHitCollector(searcher);
        searcher.search(q,null,deleter);
        totDeleted=deleter.deleted;
      }
    }
  finally {
      iwCommit.unlock();
    }
    if (!delAll) {
      if (SolrCore.log.isLoggable(Level.FINE)) {
        SolrCore.log.fine("docs deleted by query:" + totDeleted);
      }
      numDocsDeleted.getAndAdd(totDeleted);
    }
    madeIt=true;
    if (tracker.timeUpperBound > 0) {
      tracker.scheduleCommitWithin(tracker.timeUpperBound);
    }
  }
  finally {
    if (!madeIt) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
  }
}
