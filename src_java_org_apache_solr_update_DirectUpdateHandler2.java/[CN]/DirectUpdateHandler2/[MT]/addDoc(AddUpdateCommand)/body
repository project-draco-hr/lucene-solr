{
  addCommands.incrementAndGet();
  addCommandsCumulative.incrementAndGet();
  int rc=-1;
  iwAccess.lock();
  try {
synchronized (this) {
      if (!cmd.allowDups && !cmd.overwritePending && !cmd.overwriteCommitted) {
        throw new SolrException(400,"unsupported param combo:" + cmd);
      }
 else       if (!cmd.allowDups && !cmd.overwritePending && cmd.overwriteCommitted) {
        rc=addConditionally(cmd);
      }
 else       if (!cmd.allowDups && cmd.overwritePending && !cmd.overwriteCommitted) {
        throw new SolrException(400,"unsupported param combo:" + cmd);
      }
 else       if (!cmd.allowDups && cmd.overwritePending && cmd.overwriteCommitted) {
        rc=overwriteBoth(cmd);
      }
 else       if (cmd.allowDups && !cmd.overwritePending && !cmd.overwriteCommitted) {
        rc=allowDups(cmd);
      }
 else       if (cmd.allowDups && !cmd.overwritePending && cmd.overwriteCommitted) {
        throw new SolrException(400,"unsupported param combo:" + cmd);
      }
 else       if (cmd.allowDups && cmd.overwritePending && !cmd.overwriteCommitted) {
        throw new SolrException(400,"unsupported param combo:" + cmd);
      }
 else       if (cmd.allowDups && cmd.overwritePending && cmd.overwriteCommitted) {
        rc=overwriteBoth(cmd);
      }
      if (rc == -1)       throw new SolrException(400,"unsupported param combo:" + cmd);
      if (rc == 1) {
        closeSearcher();
        openWriter();
        tracker.increment(1);
      }
 else {
        return rc;
      }
    }
    assert(rc == 1);
    writer.addDocument(cmd.doc);
  }
  finally {
    iwAccess.unlock();
    if (rc != 1) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
 else {
      numDocsPending.incrementAndGet();
    }
  }
  checkCommit(true);
  return rc;
}
