{
  if (searcherMgr != null) {
    searcherMgr.close();
    searcherMgr=null;
  }
  if (writer != null) {
    writer.shutdown();
    writer=null;
  }
  boolean success=false;
  try {
    writer=new IndexWriter(dir,getIndexWriterConfig(matchVersion,getGramAnalyzer(),IndexWriterConfig.OpenMode.CREATE));
    BytesRef text;
    while ((text=iter.next()) != null) {
      BytesRef payload;
      if (iter.hasPayloads()) {
        payload=iter.payload();
      }
 else {
        payload=null;
      }
      add(text,iter.contexts(),iter.weight(),payload);
    }
    searcherMgr=new SearcherManager(writer,true,null);
    success=true;
  }
  finally {
    if (success == false) {
      writer.rollback();
      writer=null;
    }
  }
}
