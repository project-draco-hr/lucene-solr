{
  TokenStream ts=queryAnalyzer.tokenStream("text",new StringReader(text));
  CharTermAttribute termAtt=ts.addAttribute(CharTermAttribute.class);
  OffsetAttribute offsetAtt=ts.addAttribute(OffsetAttribute.class);
  ts.reset();
  StringBuilder sb=new StringBuilder();
  int upto=0;
  while (ts.incrementToken()) {
    String token=termAtt.toString();
    int startOffset=offsetAtt.startOffset();
    int endOffset=offsetAtt.endOffset();
    if (upto < startOffset) {
      sb.append(text.substring(upto,startOffset));
      upto=startOffset;
    }
 else     if (upto > startOffset) {
      continue;
    }
    if (matchedTokens.contains(token)) {
      addWholeMatch(sb,text.substring(startOffset,endOffset),token);
      upto=endOffset;
    }
 else     if (prefixToken != null && token.startsWith(prefixToken)) {
      addPrefixMatch(sb,text.substring(startOffset,endOffset),token,prefixToken);
      upto=endOffset;
    }
  }
  ts.end();
  int endOffset=offsetAtt.endOffset();
  if (upto < endOffset) {
    sb.append(text.substring(upto));
  }
  ts.close();
  return sb.toString();
}
