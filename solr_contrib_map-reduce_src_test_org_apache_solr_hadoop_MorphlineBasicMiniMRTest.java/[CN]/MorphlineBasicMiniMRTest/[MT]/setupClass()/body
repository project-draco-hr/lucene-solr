{
  solrHomeDirectory=createTempDir().toFile();
  assumeTrue("Currently this test can only be run without the lucene test security policy in place",System.getProperty("java.security.manager","").equals(""));
  assumeFalse("HDFS tests were disabled by -Dtests.disableHdfs",Boolean.parseBoolean(System.getProperty("tests.disableHdfs","false")));
  assumeFalse("FIXME: This test does not work with Windows because of native library requirements",Constants.WINDOWS);
  assumeFalse("FIXME: This test fails under Java 8 due to the Saxon dependency - see SOLR-1301",Constants.JRE_IS_MINIMUM_JAVA8);
  assumeFalse("FIXME: This test fails under J9 due to the Saxon dependency - see SOLR-1301",System.getProperty("java.vm.info","<?>").contains("IBM J9"));
  AbstractZkTestCase.SOLRHOME=solrHomeDirectory;
  FileUtils.copyDirectory(MINIMR_CONF_DIR,solrHomeDirectory);
  File dataDir=createTempDir().toFile();
  tempDir=dataDir.getAbsolutePath();
  new File(tempDir).mkdirs();
  FileUtils.copyFile(new File(RESOURCES_DIR + "/custom-mimetypes.xml"),new File(tempDir + "/custom-mimetypes.xml"));
  AbstractSolrMorphlineTestBase.setupMorphline(tempDir,"test-morphlines/solrCellDocumentTypes",true);
  System.setProperty("hadoop.log.dir",new File(solrHomeDirectory,"logs").getAbsolutePath());
  int taskTrackers=1;
  int dataNodes=2;
  new File(dataDir,"nm-local-dirs").mkdirs();
  System.setProperty("solr.hdfs.blockcache.enabled","false");
  System.setProperty("test.build.dir",dataDir + File.separator + "hdfs"+ File.separator+ "test-build-dir");
  System.setProperty("test.build.data",dataDir + File.separator + "hdfs"+ File.separator+ "build");
  System.setProperty("test.cache.data",dataDir + File.separator + "hdfs"+ File.separator+ "cache");
  SEARCH_ARCHIVES_JAR=JarFinder.getJar(MapReduceIndexerTool.class);
  JobConf conf=new JobConf();
  conf.set("dfs.block.access.token.enable","false");
  conf.set("dfs.permissions","true");
  conf.set("hadoop.security.authentication","simple");
  conf.set(YarnConfiguration.NM_LOCAL_DIRS,dataDir.getPath() + File.separator + "nm-local-dirs");
  conf.set(YarnConfiguration.DEFAULT_NM_LOG_DIRS,dataDir + File.separator + "nm-logs");
  conf.set("testWorkDir",dataDir.getPath() + File.separator + "testWorkDir");
  dfsCluster=new MiniDFSCluster(conf,dataNodes,true,null);
  FileSystem fileSystem=dfsCluster.getFileSystem();
  fileSystem.mkdirs(new Path("/tmp"));
  fileSystem.mkdirs(new Path("/user"));
  fileSystem.mkdirs(new Path("/hadoop/mapred/system"));
  fileSystem.setPermission(new Path("/tmp"),FsPermission.valueOf("-rwxrwxrwx"));
  fileSystem.setPermission(new Path("/user"),FsPermission.valueOf("-rwxrwxrwx"));
  fileSystem.setPermission(new Path("/hadoop/mapred/system"),FsPermission.valueOf("-rwx------"));
  String nnURI=fileSystem.getUri().toString();
  int numDirs=1;
  String[] racks=null;
  String[] hosts=null;
  mrCluster=new MiniMRCluster(0,0,taskTrackers,nnURI,numDirs,racks,hosts,null,conf);
  ProxyUsers.refreshSuperUserGroupsConfiguration(conf);
}
