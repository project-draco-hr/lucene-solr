{
  do {
    while (controller.netBytes() > controller.stallLimitBytes()) {
      if (sync.trySetStalled()) {
        assert wasStalled=true;
        return;
      }
    }
  }
 while (!sync.tryReset());
}
