{
  Directory dir=newDirectory();
  int delID=0;
  for (int i=0; i < 20; i++) {
    if (VERBOSE) {
      System.out.println("TEST: iter=" + i);
    }
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMaxBufferedDocs(2).setMergePolicy(newLogMergePolicy()));
    writer.setInfoStream(VERBOSE ? System.out : null);
    Document doc=new Document();
    String contents="aa bb cc dd ee ff gg hh ii jj kk";
    FieldType customType=new FieldType(TextField.TYPE_STORED);
    FieldType type=null;
    if (i == 7) {
      doc.add(newField("content3","",TextField.TYPE_UNSTORED));
    }
 else {
      if (i % 2 == 0) {
        doc.add(newField("content4",contents,customType));
        type=customType;
      }
 else       type=TextField.TYPE_UNSTORED;
      doc.add(newField("content1",contents,TextField.TYPE_UNSTORED));
      doc.add(newField("content3","",customType));
      doc.add(newField("content5","",type));
    }
    for (int j=0; j < 4; j++)     writer.addDocument(doc);
    writer.close();
    IndexReader reader=IndexReader.open(dir,false);
    reader.deleteDocument(delID++);
    reader.close();
    if (0 == i % 4) {
      writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
      writer.optimize();
      writer.close();
    }
  }
  dir.close();
}
