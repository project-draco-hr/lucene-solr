{
  MockRAMDirectory dir=new MockRAMDirectory();
  int delID=0;
  for (int i=0; i < 20; i++) {
    IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)).setMaxBufferedDocs(2));
    LogMergePolicy lmp=(LogMergePolicy)writer.getConfig().getMergePolicy();
    lmp.setMergeFactor(2);
    lmp.setUseCompoundFile(false);
    lmp.setUseCompoundDocStore(false);
    Document doc=new Document();
    String contents="aa bb cc dd ee ff gg hh ii jj kk";
    if (i == 7) {
      doc.add(new Field("content3","",Field.Store.NO,Field.Index.ANALYZED));
    }
 else {
      Field.Store storeVal;
      if (i % 2 == 0) {
        doc.add(new Field("content4",contents,Field.Store.YES,Field.Index.ANALYZED));
        storeVal=Field.Store.YES;
      }
 else       storeVal=Field.Store.NO;
      doc.add(new Field("content1",contents,storeVal,Field.Index.ANALYZED));
      doc.add(new Field("content3","",Field.Store.YES,Field.Index.ANALYZED));
      doc.add(new Field("content5","",storeVal,Field.Index.ANALYZED));
    }
    for (int j=0; j < 4; j++)     writer.addDocument(doc);
    writer.close();
    IndexReader reader=IndexReader.open(dir,false);
    reader.deleteDocument(delID++);
    reader.close();
    if (0 == i % 4) {
      writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)));
      LogMergePolicy lmp2=(LogMergePolicy)writer.getConfig().getMergePolicy();
      lmp2.setUseCompoundFile(false);
      lmp2.setUseCompoundDocStore(false);
      writer.optimize();
      writer.close();
    }
  }
}
