{
  MockDirectoryWrapper dir=newDirectory(random);
  FailOnlyInSync failure=new FailOnlyInSync();
  dir.failOn(failure);
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(2).setMergeScheduler(new ConcurrentMergeScheduler()));
  failure.setDoFail();
  ((LogMergePolicy)writer.getConfig().getMergePolicy()).setMergeFactor(5);
  for (int i=0; i < 23; i++) {
    addDoc(writer);
    if ((i - 1) % 2 == 0) {
      try {
        writer.commit();
      }
 catch (      IOException ioe) {
      }
    }
  }
  ((ConcurrentMergeScheduler)writer.getConfig().getMergeScheduler()).sync();
  assertTrue(failure.didFail);
  failure.clearDoFail();
  writer.close();
  IndexReader reader=IndexReader.open(dir,true);
  assertEquals(23,reader.numDocs());
  reader.close();
  dir.close();
}
