{
  MockDirectoryWrapper dir=newDirectory();
  final Document doc=new Document();
  doc.add(newField("content","aaa",Field.Store.YES,Field.Index.ANALYZED));
  LogDocMergePolicy ldmp=new LogDocMergePolicy();
  ldmp.setMinMergeDocs(1);
  ldmp.setMergeFactor(4);
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(2).setMergePolicy(ldmp).setMergeScheduler(new ConcurrentMergeScheduler()));
  for (int iter=0; iter < 10; iter++) {
    for (int i=0; i < 19; i++)     writer.addDocument(doc);
    ((ConcurrentMergeScheduler)writer.getConfig().getMergeScheduler()).sync();
    writer.commit();
    SegmentInfos sis=new SegmentInfos();
    sis.read(dir);
    final int segCount=sis.size();
    writer.optimize(7);
    writer.commit();
    sis=new SegmentInfos();
    ((ConcurrentMergeScheduler)writer.getConfig().getMergeScheduler()).sync();
    sis.read(dir);
    final int optSegCount=sis.size();
    if (segCount < 7)     assertEquals(segCount,optSegCount);
 else     assertEquals(7,optSegCount);
  }
  writer.close();
  dir.close();
}
