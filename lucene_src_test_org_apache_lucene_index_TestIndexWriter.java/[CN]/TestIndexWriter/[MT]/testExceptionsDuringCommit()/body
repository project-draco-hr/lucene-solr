{
  MockRAMDirectory dir=new MockRAMDirectory();
  FailOnlyInCommit failure=new FailOnlyInCommit();
  IndexWriter w=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()));
  Document doc=new Document();
  doc.add(new Field("field","a field",Field.Store.YES,Field.Index.ANALYZED));
  w.addDocument(doc);
  dir.failOn(failure);
  try {
    w.close();
    fail();
  }
 catch (  IOException ioe) {
    fail("expected only RuntimeException");
  }
catch (  RuntimeException re) {
  }
  assertTrue(failure.fail1 && failure.fail2);
  w.rollback();
  dir.close();
}
