{
  MockDirectoryWrapper dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(10).setReaderPooling(false));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  for (int j=0; j < 30; j++) {
    addDocWithIndex(writer,j);
  }
  writer.close();
  dir.resetMaxUsedSizeInBytes();
  dir.setTrackDiskUsage(true);
  long startDiskUsage=dir.getMaxUsedSizeInBytes();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND).setMaxBufferedDocs(10).setMergeScheduler(new SerialMergeScheduler()).setReaderPooling(false));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  for (int j=0; j < 1470; j++) {
    addDocWithIndex(writer,j);
  }
  long midDiskUsage=dir.getMaxUsedSizeInBytes();
  dir.resetMaxUsedSizeInBytes();
  writer.optimize();
  writer.close();
  IndexReader.open(dir,true).close();
  long endDiskUsage=dir.getMaxUsedSizeInBytes();
  assertTrue("writer used too much space while adding documents: mid=" + midDiskUsage + " start="+ startDiskUsage+ " end="+ endDiskUsage,midDiskUsage < 100 * startDiskUsage);
  assertTrue("writer used too much space after close: endDiskUsage=" + endDiskUsage + " startDiskUsage="+ startDiskUsage,endDiskUsage < 100 * startDiskUsage);
  dir.close();
}
