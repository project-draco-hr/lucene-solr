{
  final Random r=random;
  Directory dir=newDirectory();
  FlushCountingIndexWriter w=new FlushCountingIndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(MockTokenizer.WHITESPACE,true,false)).setRAMBufferSizeMB(1.0).setMaxBufferedDocs(-1).setMaxBufferedDeleteTerms(-1));
  w.setInfoStream(VERBOSE ? System.out : null);
  Document doc=new Document();
  doc.add(newField("field","go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20",Field.Store.NO,Field.Index.ANALYZED));
  int num=TEST_NIGHTLY ? 6 * RANDOM_MULTIPLIER : 3 * RANDOM_MULTIPLIER;
  for (int iter=0; iter < num; iter++) {
    int count=0;
    final boolean doIndexing=r.nextBoolean();
    if (VERBOSE) {
      System.out.println("TEST: iter doIndexing=" + doIndexing);
    }
    if (doIndexing) {
      final int startFlushCount=w.flushCount;
      while (w.flushCount == startFlushCount) {
        w.addDocument(doc);
        count++;
      }
    }
 else {
      final int startFlushCount=w.flushCount;
      while (w.flushCount == startFlushCount) {
        w.deleteDocuments(new Term("foo","" + count));
        count++;
      }
    }
    assertTrue("flush happened too quickly during " + (doIndexing ? "indexing" : "deleting") + " count="+ count,count > 3000);
  }
  w.close();
  dir.close();
}
