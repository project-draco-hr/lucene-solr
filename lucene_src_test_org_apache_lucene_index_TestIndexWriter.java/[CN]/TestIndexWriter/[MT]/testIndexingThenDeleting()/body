{
  final Random r=newRandom();
  Directory dir=new MockRAMDirectory();
  FlushCountingIndexWriter w=new FlushCountingIndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setRAMBufferSizeMB(0.5));
  Document doc=new Document();
  doc.add(new Field("field","go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20",Field.Store.NO,Field.Index.ANALYZED));
  int num=6 * RANDOM_MULTIPLIER;
  for (int iter=0; iter < num; iter++) {
    int count=0;
    final boolean doIndexing=r.nextBoolean();
    if (doIndexing) {
      final int startFlushCount=w.flushCount;
      while (w.flushCount == startFlushCount) {
        w.addDocument(doc);
        count++;
      }
    }
 else {
      final int startFlushCount=w.flushCount;
      while (w.flushCount == startFlushCount) {
        w.deleteDocuments(new Term("foo","" + count));
        count++;
      }
    }
    assertTrue("flush happened too quickly during " + (doIndexing ? "indexing" : "deleting") + " count="+ count,count > 2500);
  }
  w.close();
  dir.close();
}
