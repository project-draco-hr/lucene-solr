{
  Directory dir=newDirectory();
  SnapshotDeletionPolicy sdp=new SnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy());
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(sdp));
  Document doc=new Document();
  doc.add(new Field("c","val",Store.YES,Index.ANALYZED,TermVector.WITH_POSITIONS_OFFSETS));
  writer.addDocument(doc);
  writer.commit();
  assertEquals(1,IndexReader.listCommits(dir).size());
  sdp.snapshot("id");
  doc=new Document();
  doc.add(new Field("c","val",Store.YES,Index.ANALYZED,TermVector.WITH_POSITIONS_OFFSETS));
  writer.addDocument(doc);
  writer.commit();
  assertEquals(2,IndexReader.listCommits(dir).size());
  sdp.release("id");
  writer.deleteUnusedFiles();
  assertEquals(1,IndexReader.listCommits(dir).size());
  writer.close();
  dir.close();
}
