{
  Directory dir=newDirectory();
  IndexWriter writer=null;
  IndexReader reader=null;
  int i;
  long savedWriteLockTimeout=IndexWriterConfig.getDefaultWriteLockTimeout();
  try {
    IndexWriterConfig.setDefaultWriteLockTimeout(2000);
    assertEquals(2000,IndexWriterConfig.getDefaultWriteLockTimeout());
    writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  }
  finally {
    IndexWriterConfig.setDefaultWriteLockTimeout(savedWriteLockTimeout);
  }
  for (i=0; i < 100; i++) {
    addDocWithIndex(writer,i);
  }
  assertEquals(100,writer.maxDoc());
  writer.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(NoMergePolicy.NO_COMPOUND_FILES));
  for (i=0; i < 40; i++) {
    writer.deleteDocuments(new Term("id","" + i));
  }
  writer.close();
  reader=IndexReader.open(dir);
  assertEquals(60,reader.numDocs());
  reader.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  assertEquals(60,writer.numDocs());
  writer.forceMerge(1);
  assertEquals(60,writer.maxDoc());
  assertEquals(60,writer.numDocs());
  writer.close();
  reader=IndexReader.open(dir);
  assertEquals(60,reader.maxDoc());
  assertEquals(60,reader.numDocs());
  reader.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE));
  assertEquals(0,writer.maxDoc());
  assertEquals(0,writer.numDocs());
  writer.close();
  dir.close();
}
