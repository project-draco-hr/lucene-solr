{
  MockRAMDirectory directory=newDirectory(random);
  final Document doc=new Document();
  Field idField=new Field("id","",Field.Store.YES,Field.Index.NOT_ANALYZED);
  doc.add(idField);
  for (int pass=0; pass < 2; pass++) {
    IndexWriterConfig conf=newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE).setMaxBufferedDocs(2);
    if (pass == 2) {
      conf.setMergeScheduler(new SerialMergeScheduler());
    }
    IndexWriter writer=new IndexWriter(directory,conf);
    ((LogMergePolicy)writer.getConfig().getMergePolicy()).setMergeFactor(100);
    for (int iter=0; iter < 10; iter++) {
      for (int j=0; j < 199; j++) {
        idField.setValue(Integer.toString(iter * 201 + j));
        writer.addDocument(doc);
      }
      int delID=iter * 199;
      for (int j=0; j < 20; j++) {
        writer.deleteDocuments(new Term("id",Integer.toString(delID)));
        delID+=5;
      }
      ((LogMergePolicy)writer.getConfig().getMergePolicy()).setMergeFactor(2);
      final IndexWriter finalWriter=writer;
      final ArrayList<Throwable> failure=new ArrayList<Throwable>();
      Thread t1=new Thread(){
        @Override public void run(){
          boolean done=false;
          while (!done) {
            for (int i=0; i < 100; i++) {
              try {
                finalWriter.addDocument(doc);
              }
 catch (              AlreadyClosedException e) {
                done=true;
                break;
              }
catch (              NullPointerException e) {
                done=true;
                break;
              }
catch (              Throwable e) {
                e.printStackTrace(System.out);
                failure.add(e);
                done=true;
                break;
              }
            }
            Thread.yield();
          }
        }
      }
;
      if (failure.size() > 0)       throw failure.get(0);
      t1.start();
      writer.close(false);
      t1.join();
      IndexReader reader=IndexReader.open(directory,true);
      reader.close();
      writer=new IndexWriter(directory,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
    }
    writer.close();
  }
  directory.close();
}
