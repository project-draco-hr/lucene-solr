{
  File index=_TestUtil.getTempDir("lucenerandfields");
  Directory dir=FSDirectory.open(index);
  Random rand=random;
  RandomIndexWriter w=new RandomIndexWriter(rand,dir,newIndexWriterConfig(rand,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(_TestUtil.nextInt(rand,5,20)));
  if (VERBOSE) {
    w.w.setInfoStream(System.out);
  }
  final int docCount=200 * RANDOM_MULTIPLIER;
  final int fieldCount=_TestUtil.nextInt(rand,1,5);
  final List<Integer> fieldIDs=new ArrayList<Integer>();
  Field idField=new Field("id","",Field.Store.YES,Field.Index.NOT_ANALYZED);
  for (int i=0; i < fieldCount; i++) {
    fieldIDs.add(i);
  }
  final Map<String,Document> docs=new HashMap<String,Document>();
  if (VERBOSE) {
    System.out.println("TEST: build index docCount=" + docCount);
  }
  for (int i=0; i < docCount; i++) {
    Document doc=new Document();
    doc.add(idField);
    final String id="" + i;
    idField.setValue(id);
    docs.put(id,doc);
    for (    int field : fieldIDs) {
      final String s;
      if (rand.nextInt(4) != 3) {
        s=_TestUtil.randomUnicodeString(rand,1000);
        doc.add(new Field("f" + field,s,Field.Store.YES,Field.Index.NO));
      }
 else {
        s=null;
      }
    }
    w.addDocument(doc);
    if (rand.nextInt(50) == 17) {
      Collections.shuffle(fieldIDs);
    }
    if (rand.nextInt(5) == 3 && i > 0) {
      final String delID="" + rand.nextInt(i);
      if (VERBOSE) {
        System.out.println("TEST: delete doc " + delID);
      }
      w.deleteDocuments(new Term("id",delID));
      docs.remove(delID);
    }
  }
  if (VERBOSE) {
    System.out.println("TEST: " + docs.size() + " docs in index; now load fields");
  }
  if (docs.size() > 0) {
    String[] idsList=docs.keySet().toArray(new String[docs.size()]);
    for (int x=0; x < 2; x++) {
      IndexReader r=w.getReader();
      IndexSearcher s=new IndexSearcher(r);
      if (VERBOSE) {
        System.out.println("TEST: cycle x=" + x + " r="+ r);
      }
      for (int iter=0; iter < 1000 * RANDOM_MULTIPLIER; iter++) {
        String testID=idsList[rand.nextInt(idsList.length)];
        TopDocs hits=s.search(new TermQuery(new Term("id",testID)),1);
        assertEquals(1,hits.totalHits);
        Document doc=r.document(hits.scoreDocs[0].doc);
        Document docExp=docs.get(testID);
        for (int i=0; i < fieldCount; i++) {
          assertEquals("doc " + testID + ", field f"+ fieldCount+ " is wrong",docExp.get("f" + i),doc.get("f" + i));
        }
      }
      r.close();
      w.optimize();
    }
  }
  w.close();
  dir.close();
  _TestUtil.rmDir(index);
}
