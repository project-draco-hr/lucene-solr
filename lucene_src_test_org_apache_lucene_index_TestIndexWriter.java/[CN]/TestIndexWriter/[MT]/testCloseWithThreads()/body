{
  int NUM_THREADS=3;
  for (int iter=0; iter < 7; iter++) {
    MockRAMDirectory dir=new MockRAMDirectory();
    IndexWriterConfig conf=new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)).setMaxBufferedDocs(10);
    ((ConcurrentMergeScheduler)conf.getMergeScheduler()).setSuppressExceptions();
    IndexWriter writer=new IndexWriter(dir,conf);
    ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(4);
    IndexerThread[] threads=new IndexerThread[NUM_THREADS];
    for (int i=0; i < NUM_THREADS; i++)     threads[i]=new IndexerThread(writer,false);
    for (int i=0; i < NUM_THREADS; i++)     threads[i].start();
    boolean done=false;
    while (!done) {
      Thread.sleep(100);
      for (int i=0; i < NUM_THREADS; i++)       if (threads[i].addCount > 0) {
        done=true;
        break;
      }
    }
    writer.close(false);
    for (int i=0; i < NUM_THREADS; i++) {
      threads[i].join();
      if (threads[i].isAlive())       fail("thread seems to be hung");
    }
    IndexReader reader=IndexReader.open(dir,true);
    TermDocs tdocs=reader.termDocs(new Term("field","aaa"));
    int count=0;
    while (tdocs.next()) {
      count++;
    }
    assertTrue(count > 0);
    reader.close();
    dir.close();
  }
}
