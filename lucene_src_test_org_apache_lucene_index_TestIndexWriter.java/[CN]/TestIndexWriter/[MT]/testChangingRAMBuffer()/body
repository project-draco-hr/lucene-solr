{
  RAMDirectory dir=new RAMDirectory();
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(10).setRAMBufferSizeMB(IndexWriterConfig.DISABLE_AUTO_FLUSH));
  int lastFlushCount=-1;
  for (int j=1; j < 52; j++) {
    Document doc=new Document();
    doc.add(new Field("field","aaa" + j,Field.Store.YES,Field.Index.ANALYZED));
    writer.addDocument(doc);
    _TestUtil.syncConcurrentMerges(writer);
    int flushCount=writer.getFlushCount();
    if (j == 1)     lastFlushCount=flushCount;
 else     if (j < 10)     assertEquals(flushCount,lastFlushCount);
 else     if (10 == j) {
      assertTrue(flushCount > lastFlushCount);
      lastFlushCount=flushCount;
      writer.setRAMBufferSizeMB(0.000001);
      writer.setMaxBufferedDocs(IndexWriterConfig.DISABLE_AUTO_FLUSH);
    }
 else     if (j < 20) {
      assertTrue(flushCount > lastFlushCount);
      lastFlushCount=flushCount;
    }
 else     if (20 == j) {
      writer.setRAMBufferSizeMB(16);
      writer.setMaxBufferedDocs(IndexWriterConfig.DISABLE_AUTO_FLUSH);
      lastFlushCount=flushCount;
    }
 else     if (j < 30) {
      assertEquals(flushCount,lastFlushCount);
    }
 else     if (30 == j) {
      writer.setRAMBufferSizeMB(0.000001);
      writer.setMaxBufferedDocs(IndexWriterConfig.DISABLE_AUTO_FLUSH);
    }
 else     if (j < 40) {
      assertTrue(flushCount > lastFlushCount);
      lastFlushCount=flushCount;
    }
 else     if (40 == j) {
      writer.setMaxBufferedDocs(10);
      writer.setRAMBufferSizeMB(IndexWriterConfig.DISABLE_AUTO_FLUSH);
      lastFlushCount=flushCount;
    }
 else     if (j < 50) {
      assertEquals(flushCount,lastFlushCount);
      writer.setMaxBufferedDocs(10);
      writer.setRAMBufferSizeMB(IndexWriterConfig.DISABLE_AUTO_FLUSH);
    }
 else     if (50 == j) {
      assertTrue(flushCount > lastFlushCount);
    }
  }
  writer.close();
  dir.close();
}
