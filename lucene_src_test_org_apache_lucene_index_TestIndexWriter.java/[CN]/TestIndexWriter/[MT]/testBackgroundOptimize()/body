{
  Directory dir=new MockRAMDirectory();
  for (int pass=0; pass < 2; pass++) {
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE).setMaxBufferedDocs(2));
    ((LogMergePolicy)writer.getConfig().getMergePolicy()).setMergeFactor(101);
    Document doc=new Document();
    doc.add(new Field("field","aaa",Field.Store.YES,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
    for (int i=0; i < 200; i++)     writer.addDocument(doc);
    writer.optimize(false);
    if (0 == pass) {
      writer.close();
      IndexReader reader=IndexReader.open(dir,true);
      assertTrue(reader.isOptimized());
      reader.close();
    }
 else {
      writer.addDocument(doc);
      writer.addDocument(doc);
      writer.close();
      IndexReader reader=IndexReader.open(dir,true);
      assertTrue(!reader.isOptimized());
      reader.close();
      SegmentInfos infos=new SegmentInfos();
      infos.read(dir);
      assertEquals(2,infos.size());
    }
  }
  dir.close();
}
