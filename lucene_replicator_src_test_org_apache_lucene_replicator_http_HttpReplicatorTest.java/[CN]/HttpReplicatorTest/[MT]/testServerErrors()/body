{
  BasicClientConnectionManager conMgr=new BasicClientConnectionManager();
  Replicator replicator=new HttpReplicator(host,port,ReplicationService.REPLICATION_CONTEXT + "/s1",conMgr);
  ReplicationClient client=new ReplicationClient(replicator,new IndexReplicationHandler(handlerIndexDir,null),new PerSessionDirectoryFactory(clientWorkDir));
  try {
    publishRevision(5);
    try {
      replicationServlet.setRespondWithError(true);
      client.updateNow();
      fail("expected exception");
    }
 catch (    Throwable t) {
    }
    replicationServlet.setRespondWithError(false);
    client.updateNow();
    reopenReader();
    assertEquals(5,Integer.parseInt(reader.getIndexCommit().getUserData().get("ID"),16));
    client.close();
  }
  finally {
    replicationServlet.setRespondWithError(false);
  }
}
