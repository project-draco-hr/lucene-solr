{
  TimerContext time=stats.time(dir + "_offer");
  try {
    String watchID=createResponseNode();
    Object lock=new Object();
    LatchWatcher watcher=new LatchWatcher(lock);
    Stat stat=zookeeper.exists(watchID,watcher,true);
    createRequestNode(data,watchID);
synchronized (lock) {
      if (stat != null && watcher.getWatchedEvent() == null) {
        watcher.await(timeout);
      }
    }
    byte[] bytes=zookeeper.getData(watchID,null,null,true);
    QueueEvent event=new QueueEvent(watchID,bytes,watcher.getWatchedEvent());
    zookeeper.delete(watchID,-1,true);
    return event;
  }
  finally {
    time.stop();
  }
}
