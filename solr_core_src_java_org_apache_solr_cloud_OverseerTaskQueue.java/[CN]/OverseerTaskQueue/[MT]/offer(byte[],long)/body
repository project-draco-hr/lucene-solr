{
  TimerContext time=stats.time(dir + "_offer");
  try {
    String watchID=createData(dir + "/" + response_prefix,null,CreateMode.EPHEMERAL_SEQUENTIAL);
    Object lock=new Object();
    LatchWatcher watcher=new LatchWatcher(lock);
    Stat stat=zookeeper.exists(watchID,watcher,true);
    createData(dir + "/" + PREFIX+ watchID.substring(watchID.lastIndexOf("-") + 1),data,CreateMode.PERSISTENT);
synchronized (lock) {
      if (stat != null && watcher.getWatchedEvent() == null) {
        watcher.await(timeout);
      }
    }
    byte[] bytes=zookeeper.getData(watchID,null,null,true);
    QueueEvent event=new QueueEvent(watchID,bytes,watcher.getWatchedEvent());
    zookeeper.delete(watchID,-1,true);
    return event;
  }
  finally {
    time.stop();
  }
}
