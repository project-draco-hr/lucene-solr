{
  boolean success=false;
  try {
    for (    FieldInfo fi : readState.fieldInfos) {
      if (fi.isIndexed()) {
        final String fieldName=fi.name;
        final String formatName=fi.getAttribute(PER_FIELD_FORMAT_KEY);
        if (formatName != null) {
          PostingsFormat format=PostingsFormat.forName(formatName);
          if (!formats.containsKey(format)) {
            formats.put(format,format.fieldsProducer(new SegmentReadState(readState,formatName)));
          }
          fields.put(fieldName,formats.get(format));
        }
      }
    }
    success=true;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(formats.values());
    }
  }
}
