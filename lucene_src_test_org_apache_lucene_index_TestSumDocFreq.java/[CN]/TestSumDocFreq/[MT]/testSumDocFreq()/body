{
  final int numDocs=atLeast(500);
  Directory dir=newDirectory();
  RandomIndexWriter writer=new RandomIndexWriter(random,dir);
  Document doc=new Document();
  Field field1=newField("foo","",TextField.TYPE_UNSTORED);
  Field field2=newField("bar","",TextField.TYPE_UNSTORED);
  doc.add(field1);
  doc.add(field2);
  for (int i=0; i < numDocs; i++) {
    char ch1=(char)_TestUtil.nextInt(random,'a','z');
    char ch2=(char)_TestUtil.nextInt(random,'a','z');
    field1.setValue("" + ch1 + " "+ ch2);
    ch1=(char)_TestUtil.nextInt(random,'a','z');
    ch2=(char)_TestUtil.nextInt(random,'a','z');
    field2.setValue("" + ch1 + " "+ ch2);
    writer.addDocument(doc);
  }
  IndexReader ir=writer.getReader();
  writer.close();
  assertSumDocFreq(ir);
  ir.close();
  ir=IndexReader.open(dir,false);
  int numDeletions=atLeast(20);
  for (int i=0; i < numDeletions; i++) {
    ir.deleteDocument(random.nextInt(ir.maxDoc()));
  }
  ir.close();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  w.forceMerge(1);
  w.close();
  ir=IndexReader.open(dir,true);
  assertSumDocFreq(ir);
  ir.close();
  dir.close();
}
