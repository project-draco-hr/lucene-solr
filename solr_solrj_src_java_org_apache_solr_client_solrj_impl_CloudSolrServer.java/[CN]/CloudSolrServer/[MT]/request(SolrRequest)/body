{
  connect();
  ClusterState clusterState=zkStateReader.getClusterState();
  boolean sendToLeaders=false;
  if (request instanceof IsUpdateRequest && updatesToLeaders) {
    sendToLeaders=true;
  }
  SolrParams reqParams=request.getParams();
  if (reqParams == null) {
    reqParams=new ModifiableSolrParams();
  }
  String collection=reqParams.get("collection",defaultCollection);
  if (collection == null) {
    throw new SolrServerException("No collection param specified on request and no default collection has been set.");
  }
  List<String> collectionList=StrUtils.splitSmart(collection,",",true);
  Map<String,Slice> slices=new HashMap<String,Slice>();
  for (int i=0; i < collectionList.size(); i++) {
    String coll=collectionList.get(i);
    ClientUtils.appendMap(coll,slices,clusterState.getSlices(coll));
  }
  Set<String> liveNodes=clusterState.getLiveNodes();
  if (sendToLeaders && leaderUrlList == null || !sendToLeaders && urlList == null || clusterState.hashCode() != this.lastClusterStateHashCode) {
    Map<String,ZkNodeProps> nodes=new HashMap<String,ZkNodeProps>();
    List<String> urlList=new ArrayList<String>();
    for (    Slice slice : slices.values()) {
      for (      ZkNodeProps nodeProps : slice.getShards().values()) {
        ZkCoreNodeProps coreNodeProps=new ZkCoreNodeProps(nodeProps);
        String node=coreNodeProps.getNodeName();
        if (!liveNodes.contains(coreNodeProps.getNodeName()) || !coreNodeProps.getState().equals(ZkStateReader.ACTIVE))         continue;
        if (nodes.put(node,nodeProps) == null) {
          if (!sendToLeaders || (sendToLeaders && coreNodeProps.isLeader())) {
            String url=coreNodeProps.getCoreUrl();
            urlList.add(url);
          }
        }
      }
    }
    if (sendToLeaders) {
      this.leaderUrlList=urlList;
    }
 else {
      this.urlList=urlList;
    }
    this.lastClusterStateHashCode=clusterState.hashCode();
  }
  List<String> theUrlList;
  if (sendToLeaders) {
    theUrlList=new ArrayList<String>(leaderUrlList.size());
    theUrlList.addAll(leaderUrlList);
  }
 else {
    theUrlList=new ArrayList<String>(urlList.size());
    theUrlList.addAll(urlList);
  }
  Collections.shuffle(theUrlList,rand);
  LBHttpSolrServer.Req req=new LBHttpSolrServer.Req(request,theUrlList);
  LBHttpSolrServer.Rsp rsp=lbServer.request(req);
  return rsp.getResponse();
}
