{
  if (openFiles == null) {
    openFiles=new HashMap();
  }
synchronized (openFiles) {
    if (noDeleteOpenFile && openFiles.containsKey(name))     throw new IOException("MockRAMDirectory: file \"" + name + "\" is still open: cannot overwrite");
  }
  RAMFile file=new RAMFile(this);
synchronized (this) {
    RAMFile existing=(RAMFile)fileMap.get(name);
    if (existing != null && !name.equals("segments.gen"))     throw new IOException("file " + name + " already exists");
 else {
      if (existing != null) {
        sizeInBytes-=existing.sizeInBytes;
        existing.directory=null;
      }
      fileMap.put(name,file);
    }
  }
  return new MockRAMOutputStream(this,file);
}
