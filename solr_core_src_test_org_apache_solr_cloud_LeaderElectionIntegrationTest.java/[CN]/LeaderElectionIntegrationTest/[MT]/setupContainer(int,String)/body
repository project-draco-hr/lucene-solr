{
  Path data=createTempDir();
  System.setProperty("hostPort",Integer.toString(port));
  System.setProperty("shard",shard);
  System.setProperty("solr.data.dir",data.toString());
  System.setProperty("solr.solr.home",TEST_HOME());
  Set<Integer> ports=shardPorts.get(shard);
  if (ports == null) {
    ports=new HashSet<>();
    shardPorts.put(shard,ports);
  }
  ports.add(port);
  SolrResourceLoader loader=new SolrResourceLoader(createTempDir());
  Files.copy(TEST_PATH().resolve("solr.xml"),loader.getInstancePath().resolve("solr.xml"));
  CoreContainer container=new CoreContainer(loader);
  container.load();
  container.create("collection1_" + shard,ImmutableMap.of("collection","collection1"));
  containerMap.put(port,container);
  System.clearProperty("solr.solr.home");
  System.clearProperty("hostPort");
}
