{
  for (  final LeafReaderContext leafCtx : context.leaves()) {
    Bits leafAcceptDocs;
    if (filter == null) {
      leafAcceptDocs=leafCtx.reader().getLiveDocs();
    }
 else {
      final DocIdSet docIdSet=filter.getDocIdSet(leafCtx,leafCtx.reader().getLiveDocs());
      if (docIdSet == null) {
        continue;
      }
      leafAcceptDocs=docIdSet.bits();
      if (leafAcceptDocs == null) {
        final DocIdSetIterator iterator=docIdSet.iterator();
        if (iterator == null) {
          continue;
        }
        SparseFixedBitSet bitSet=new SparseFixedBitSet(leafCtx.reader().maxDoc());
        bitSet.or(iterator);
        leafAcceptDocs=bitSet;
      }
    }
    compute(strategy,leafCtx,leafAcceptDocs,queryShape,facetLevel,facetVisitor);
  }
}
