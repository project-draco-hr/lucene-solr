{
  IndexWriter testWriter=new IndexWriter(testIndex,new IndexWriterConfig(analyzer));
  IndexWriter cvWriter=new IndexWriter(crossValidationIndex,new IndexWriterConfig(analyzer));
  IndexWriter trainingWriter=new IndexWriter(trainingIndex,new IndexWriterConfig(analyzer));
  try {
    int size=originalIndex.maxDoc();
    IndexSearcher indexSearcher=new IndexSearcher(originalIndex);
    TopDocs topDocs=indexSearcher.search(new MatchAllDocsQuery(),Integer.MAX_VALUE);
    FieldType ft=new FieldType(TextField.TYPE_STORED);
    ft.setStoreTermVectors(true);
    ft.setStoreTermVectorOffsets(true);
    ft.setStoreTermVectorPositions(true);
    int b=0;
    for (    ScoreDoc scoreDoc : topDocs.scoreDocs) {
      Document doc=new Document();
      StoredDocument document=originalIndex.document(scoreDoc.doc);
      if (fieldNames != null && fieldNames.length > 0) {
        for (        String fieldName : fieldNames) {
          StorableField field=document.getField(fieldName);
          if (field != null) {
            doc.add(new Field(fieldName,field.stringValue(),ft));
          }
        }
      }
 else {
        for (        StorableField storableField : document.getFields()) {
          if (storableField.readerValue() != null) {
            doc.add(new Field(storableField.name(),storableField.readerValue(),ft));
          }
 else           if (storableField.binaryValue() != null) {
            doc.add(new Field(storableField.name(),storableField.binaryValue(),ft));
          }
 else           if (storableField.stringValue() != null) {
            doc.add(new Field(storableField.name(),storableField.stringValue(),ft));
          }
 else           if (storableField.numericValue() != null) {
            doc.add(new Field(storableField.name(),storableField.numericValue().toString(),ft));
          }
        }
      }
      if (b % 2 == 0 && testWriter.maxDoc() < size * testRatio) {
        testWriter.addDocument(doc);
      }
 else       if (cvWriter.maxDoc() < size * crossValidationRatio) {
        cvWriter.addDocument(doc);
      }
 else {
        trainingWriter.addDocument(doc);
      }
      b++;
    }
    testWriter.commit();
    cvWriter.commit();
    trainingWriter.commit();
    testWriter.forceMerge(3);
    cvWriter.forceMerge(3);
    trainingWriter.forceMerge(3);
  }
 catch (  Exception e) {
    throw new IOException(e);
  }
 finally {
    testWriter.close();
    cvWriter.close();
    trainingWriter.close();
  }
}
