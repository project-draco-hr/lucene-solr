{
  IndexWriter testWriter=new IndexWriter(testIndex,new IndexWriterConfig(analyzer));
  IndexWriter cvWriter=new IndexWriter(crossValidationIndex,new IndexWriterConfig(analyzer));
  IndexWriter trainingWriter=new IndexWriter(trainingIndex,new IndexWriterConfig(analyzer));
  Terms terms=originalIndex.terms(classFieldName);
  long noOfClasses=-1;
  if (terms != null) {
    noOfClasses=terms.size();
  }
  if (noOfClasses == -1) {
    noOfClasses=10000;
  }
  HashMap<String,UninvertingReader.Type> mapping=new HashMap<>();
  mapping.put(classFieldName,UninvertingReader.Type.SORTED);
  UninvertingReader uninvertingReader=new UninvertingReader(originalIndex,mapping);
  try {
    IndexSearcher indexSearcher=new IndexSearcher(uninvertingReader);
    GroupingSearch gs=new GroupingSearch(classFieldName);
    gs.setGroupSort(Sort.INDEXORDER);
    gs.setSortWithinGroup(Sort.INDEXORDER);
    gs.setAllGroups(true);
    gs.setGroupDocsLimit(originalIndex.maxDoc());
    TopGroups<Object> topGroups=gs.search(indexSearcher,new MatchAllDocsQuery(),0,(int)noOfClasses);
    FieldType ft=new FieldType(TextField.TYPE_STORED);
    if (termVectors) {
      ft.setStoreTermVectors(true);
      ft.setStoreTermVectorOffsets(true);
      ft.setStoreTermVectorPositions(true);
    }
    int b=0;
    for (    GroupDocs group : topGroups.groups) {
      int totalHits=group.totalHits;
      double testSize=totalHits * testRatio;
      int tc=0;
      double cvSize=totalHits * crossValidationRatio;
      int cvc=0;
      for (      ScoreDoc scoreDoc : group.scoreDocs) {
        Document doc=createNewDoc(originalIndex,ft,scoreDoc,fieldNames);
        if (b % 2 == 0 && tc < testSize) {
          testWriter.addDocument(doc);
          tc++;
        }
 else         if (cvc < cvSize) {
          cvWriter.addDocument(doc);
          cvc++;
        }
 else {
          trainingWriter.addDocument(doc);
        }
        b++;
      }
    }
    testWriter.commit();
    cvWriter.commit();
    trainingWriter.commit();
    testWriter.forceMerge(3);
    cvWriter.forceMerge(3);
    trainingWriter.forceMerge(3);
  }
 catch (  Exception e) {
    throw new IOException(e);
  }
 finally {
    testWriter.close();
    cvWriter.close();
    trainingWriter.close();
    uninvertingReader.close();
  }
}
