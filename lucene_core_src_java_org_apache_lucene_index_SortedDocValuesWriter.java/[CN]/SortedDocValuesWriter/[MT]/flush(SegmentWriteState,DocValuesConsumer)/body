{
  final int maxDoc=state.segmentInfo.getDocCount();
  final int emptyOrd;
  if (pending.size() < maxDoc) {
    int ord=hash.add(EMPTY);
    if (ord < 0) {
      emptyOrd=-ord - 1;
    }
 else {
      emptyOrd=ord;
    }
  }
 else {
    emptyOrd=-1;
  }
  final int valueCount=hash.size();
  final int[] sortedValues=hash.sort(BytesRef.getUTF8SortedAsUnicodeComparator());
  final int sortedValueRamUsage=RamUsageEstimator.NUM_BYTES_ARRAY_HEADER + RamUsageEstimator.NUM_BYTES_INT * valueCount;
  final int[] ordMap=new int[valueCount];
  for (int ord=0; ord < valueCount; ord++) {
    ordMap[sortedValues[ord]]=ord;
  }
  dvConsumer.addSortedField(fieldInfo,new Iterable<BytesRef>(){
    @Override public Iterator<BytesRef> iterator(){
      return new ValuesIterator(sortedValues,valueCount);
    }
  }
,new Iterable<Number>(){
    @Override public Iterator<Number> iterator(){
      return new OrdsIterator(ordMap,maxDoc,emptyOrd);
    }
  }
);
}
