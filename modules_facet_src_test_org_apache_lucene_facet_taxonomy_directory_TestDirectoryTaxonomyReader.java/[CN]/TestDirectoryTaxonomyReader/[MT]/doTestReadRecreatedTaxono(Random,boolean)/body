{
  Directory dir=null;
  TaxonomyWriter tw=null;
  TaxonomyReader tr=null;
  int n=10;
  CategoryPath[] cp=new CategoryPath[n];
  for (int i=0; i < n; i++) {
    cp[i]=new CategoryPath("a",Integer.toString(i));
  }
  try {
    dir=newDirectory();
    tw=new DirectoryTaxonomyWriter(dir);
    tw.addCategory(new CategoryPath("a"));
    tw.close();
    tr=new DirectoryTaxonomyReader(dir);
    int baseNumcategories=tr.getSize();
    for (int i=0; i < n; i++) {
      int k=random.nextInt(n);
      tw=new DirectoryTaxonomyWriter(dir,OpenMode.CREATE);
      for (int j=0; j <= k; j++) {
        tw.addCategory(new CategoryPath(cp[j]));
      }
      tw.close();
      if (closeReader) {
        tr.close();
        tr=new DirectoryTaxonomyReader(dir);
      }
 else {
        try {
          tr.refresh();
          fail("Expected InconsistentTaxonomyException");
        }
 catch (        InconsistentTaxonomyException e) {
          tr.close();
          tr=new DirectoryTaxonomyReader(dir);
        }
      }
      assertEquals("Wrong #categories in taxonomy (i=" + i + ", k="+ k+ ")",baseNumcategories + 1 + k,tr.getSize());
    }
  }
  finally {
    IOUtils.close(tr,tw,dir);
  }
}
