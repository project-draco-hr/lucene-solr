{
  final IndexInput is=fileEntry.dir.openInput(fileEntry.file,IOContext.READONCE);
  boolean success=false;
  try {
    final long startPtr=dataOut.getFilePointer();
    final long length=fileEntry.length;
    dataOut.copyBytes(is,length);
    long endPtr=dataOut.getFilePointer();
    long diff=endPtr - startPtr;
    if (diff != length)     throw new IOException("Difference in the output file offsets " + diff + " does not match the original file length "+ length);
    fileEntry.offset=startPtr;
    success=true;
    return length;
  }
  finally {
    if (success) {
      IOUtils.close(is);
      IOUtils.deleteFilesIgnoringExceptions(fileEntry.dir,fileEntry.file);
    }
 else {
      IOUtils.closeWhileHandlingException(is);
    }
  }
}
