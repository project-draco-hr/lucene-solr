{
  RefCounted<SolrIndexSearcher> ref=h.getCore().getSearcher();
  DocList docList;
  try {
    SolrIndexSearcher searcher=ref.get();
    docList=searcher.getDocList(query,(Query)null,new Sort(),0,numberOfDocs);
    assertEquals("docList size",expectedNumDocs,docList.matches());
    ModifiableSolrParams solrParams=new ModifiableSolrParams();
    solrParams.add(CarrotParams.PRODUCE_SUMMARY,"true");
    solrParams.add(clusteringParams);
    LocalSolrQueryRequest req=new LocalSolrQueryRequest(h.getCore(),solrParams);
    Map<SolrDocument,Integer> docIds=new HashMap<SolrDocument,Integer>(docList.size());
    SolrDocumentList solrDocList=SolrPluginUtils.docListToSolrDocumentList(docList,searcher,engine.getFieldsToLoad(req),docIds);
    List results=(List)engine.cluster(query,solrDocList,docIds,req);
    req.close();
    assertEquals("number of clusters: " + results,expectedNumClusters,results.size());
    checkClusters(results,false);
    return results;
  }
  finally {
    ref.decref();
  }
}
