{
  config=conf.clone();
  directory=d;
  analyzer=conf.getAnalyzer();
  infoStream=conf.getInfoStream();
  mergePolicy=conf.getMergePolicy();
  mergePolicy.setIndexWriter(this);
  mergeScheduler=conf.getMergeScheduler();
  codec=conf.getCodec();
  bufferedDeletesStream=new BufferedDeletesStream(infoStream);
  poolReaders=conf.getReaderPooling();
  writeLock=directory.makeLock(WRITE_LOCK_NAME);
  if (!writeLock.obtain(conf.getWriteLockTimeout()))   throw new LockObtainFailedException("Index locked for write: " + writeLock);
  boolean success=false;
  try {
    OpenMode mode=conf.getOpenMode();
    boolean create;
    if (mode == OpenMode.CREATE) {
      create=true;
    }
 else     if (mode == OpenMode.APPEND) {
      create=false;
    }
 else {
      create=!DirectoryReader.indexExists(directory);
    }
    segmentInfos=new SegmentInfos();
    if (create) {
      try {
        segmentInfos.read(directory);
        segmentInfos.clear();
      }
 catch (      IOException e) {
      }
      changeCount++;
      segmentInfos.changed();
    }
 else {
      segmentInfos.read(directory);
      IndexCommit commit=conf.getIndexCommit();
      if (commit != null) {
        if (commit.getDirectory() != directory)         throw new IllegalArgumentException("IndexCommit's directory doesn't match my directory");
        SegmentInfos oldInfos=new SegmentInfos();
        oldInfos.read(directory,commit.getSegmentsFileName());
        segmentInfos.replace(oldInfos);
        changeCount++;
        segmentInfos.changed();
        if (infoStream.isEnabled("IW")) {
          infoStream.message("IW","init: loaded commit \"" + commit.getSegmentsFileName() + "\"");
        }
      }
    }
    rollbackSegments=segmentInfos.createBackupSegmentInfos(true);
    globalFieldNumberMap=segmentInfos.getOrLoadGlobalFieldNumberMap();
    docWriter=new DocumentsWriter(codec,config,directory,this,globalFieldNumberMap,bufferedDeletesStream);
synchronized (this) {
      deleter=new IndexFileDeleter(directory,conf.getIndexDeletionPolicy(),segmentInfos,infoStream,this);
    }
    if (deleter.startingCommitDeleted) {
      changeCount++;
      segmentInfos.changed();
    }
    if (infoStream.isEnabled("IW")) {
      infoStream.message("IW","init: create=" + create);
      messageState();
    }
    success=true;
  }
  finally {
    if (!success) {
      if (infoStream.isEnabled("IW")) {
        infoStream.message("IW","init: hit exception on init; releasing write lock");
      }
      try {
        writeLock.release();
      }
 catch (      Throwable t) {
      }
      writeLock=null;
    }
  }
}
