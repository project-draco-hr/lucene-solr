{
  if (pendingCommit != null) {
    throw new IllegalStateException("cannot close: prepareCommit was already called with no corresponding call to commit");
  }
  if (shouldClose(true)) {
    boolean success=false;
    try {
      if (infoStream.isEnabled("IW")) {
        infoStream.message("IW","now flush at close");
      }
      flush(true,true);
      waitForMerges();
      commitInternal(config.getMergePolicy());
      rollbackInternal();
      success=true;
    }
  finally {
      if (success == false) {
        try {
          rollbackInternal();
        }
 catch (        Throwable t) {
        }
      }
    }
  }
}
