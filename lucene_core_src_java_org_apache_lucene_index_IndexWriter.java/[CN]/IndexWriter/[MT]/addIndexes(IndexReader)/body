{
  ensureOpen();
  int numDocs=0;
  try {
    if (infoStream.isEnabled("IW")) {
      infoStream.message("IW","flush at addIndexes(IndexReader...)");
    }
    flush(false,true);
    String mergedName=newSegmentName();
    for (    IndexReader indexReader : readers) {
      numDocs+=indexReader.numDocs();
    }
    final IOContext context=new IOContext(new MergeInfo(numDocs,-1,true,-1));
    TrackingDirectoryWrapper trackingDir=new TrackingDirectoryWrapper(directory);
    SegmentMerger merger=new SegmentMerger(infoStream,trackingDir,config.getTermIndexInterval(),mergedName,MergeState.CheckAbort.NONE,payloadProcessorProvider,new FieldInfos.Builder(globalFieldNumberMap),codec,context);
    for (    IndexReader reader : readers) {
      merger.add(reader);
    }
    MergeState mergeState=merger.merge();
    SegmentInfo info=new SegmentInfo(directory,Constants.LUCENE_MAIN_VERSION,mergedName,mergeState.mergedDocCount,-1,mergedName,false,null,false,0,codec,null);
    info.setFiles(new HashSet<String>(trackingDir.getCreatedFiles()));
    trackingDir.getCreatedFiles().clear();
    setDiagnostics(info,"addIndexes(IndexReader...)");
    boolean useCompoundFile;
synchronized (this) {
      if (stopMerges) {
        deleter.deleteNewFiles(info.files());
        return;
      }
      ensureOpen();
      useCompoundFile=mergePolicy.useCompoundFile(segmentInfos,info);
    }
    if (useCompoundFile) {
      Collection<String> filesToDelete=info.files();
      createCompoundFile(infoStream,directory,MergeState.CheckAbort.NONE,info,context);
synchronized (this) {
        deleter.deleteNewFiles(filesToDelete);
      }
      info.setUseCompoundFile(true);
    }
    codec.segmentInfosFormat().getSegmentInfosWriter().write(trackingDir,info,mergeState.fieldInfos,context);
    info.getFiles().addAll(trackingDir.getCreatedFiles());
synchronized (this) {
      if (stopMerges) {
        deleter.deleteNewFiles(info.files());
        return;
      }
      ensureOpen();
      segmentInfos.add(info);
      checkpoint();
    }
  }
 catch (  OutOfMemoryError oom) {
    handleOOM(oom,"addIndexes(IndexReader...)");
  }
}
