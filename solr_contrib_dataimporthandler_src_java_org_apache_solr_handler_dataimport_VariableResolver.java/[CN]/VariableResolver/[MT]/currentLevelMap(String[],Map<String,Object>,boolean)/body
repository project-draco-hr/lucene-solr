{
  int j=includeLastLevel ? keyParts.length : keyParts.length - 1;
  for (int i=0; i < j; i++) {
    Object o=currentLevel.get(keyParts[i]);
    if (o == null) {
      Map<String,Object> nextLevel=new HashMap<String,Object>();
      currentLevel.put(keyParts[i],nextLevel);
      currentLevel=nextLevel;
    }
 else     if (o instanceof Map<?,?>) {
      @SuppressWarnings("unchecked") Map<String,Object> nextLevel=(Map<String,Object>)o;
      currentLevel=nextLevel;
    }
 else {
      throw new AssertionError("Non-leaf nodes should be of type java.util.Map");
    }
  }
  return currentLevel;
}
