{
  int j=includeLastLevel ? keyParts.length : keyParts.length - 1;
  for (int i=0; i < j; i++) {
    Object o=currentLevel.get(keyParts[i]);
    if (o == null) {
      if (i == j - 1) {
        Map<String,Object> nextLevel=new HashMap<>();
        currentLevel.put(keyParts[i],nextLevel);
        currentLevel=nextLevel;
      }
 else {
        return new CurrentLevel(i,currentLevel);
      }
    }
 else     if (o instanceof Map<?,?>) {
      @SuppressWarnings("unchecked") Map<String,Object> nextLevel=(Map<String,Object>)o;
      currentLevel=nextLevel;
    }
 else {
      throw new AssertionError("Non-leaf nodes should be of type java.util.Map");
    }
  }
  return new CurrentLevel(j - 1,currentLevel);
}
