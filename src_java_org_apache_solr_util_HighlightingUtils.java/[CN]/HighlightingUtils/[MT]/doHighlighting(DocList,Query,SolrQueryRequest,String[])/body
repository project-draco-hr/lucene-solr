{
  if (!isHighlightingEnabled(req))   return null;
  SolrIndexSearcher searcher=req.getSearcher();
  NamedList fragments=new NamedList();
  String[] fieldNames=getHighlightFields(query,req,defaultFields);
  Document[] readDocs=new Document[docs.size()];
{
    Set<String> fset=new HashSet<String>();
    for (    String f : fieldNames) {
      fset.add(f);
    }
    SchemaField keyField=req.getSearcher().getSchema().getUniqueKeyField();
    if (null != keyField)     fset.add(keyField.getName());
    searcher.readDocs(readDocs,docs,fset);
  }
  DocIterator iterator=docs.iterator();
  for (int i=0; i < docs.size(); i++) {
    int docId=iterator.nextDoc();
    Document doc=readDocs[i];
    NamedList docSummaries=new NamedList();
    for (    String fieldName : fieldNames) {
      fieldName=fieldName.trim();
      String[] docTexts=doc.getValues(fieldName);
      if (docTexts == null)       continue;
      Highlighter highlighter=getHighlighter(query,fieldName,req);
      int numFragments=getMaxSnippets(fieldName,req);
      String[] summaries;
      TextFragment[] frag;
      if (docTexts.length == 1) {
        TokenStream tstream;
        try {
          tstream=TokenSources.getTokenStream(searcher.getReader(),docId,fieldName);
        }
 catch (        IllegalArgumentException e) {
          tstream=new TokenOrderingFilter(searcher.getSchema().getAnalyzer().tokenStream(fieldName,new StringReader(docTexts[0])),10);
        }
        frag=highlighter.getBestTextFragments(tstream,docTexts[0],false,numFragments);
      }
 else {
        MultiValueTokenStream tstream;
        tstream=new MultiValueTokenStream(fieldName,docTexts,searcher.getSchema().getAnalyzer(),true);
        frag=highlighter.getBestTextFragments(tstream,tstream.asSingleValue(),false,numFragments);
      }
      if (frag.length > 0) {
        ArrayList<String> fragTexts=new ArrayList<String>();
        for (int j=0; j < frag.length; j++) {
          if ((frag[j] != null) && (frag[j].getScore() > 0)) {
            fragTexts.add(frag[j].toString());
          }
        }
        summaries=fragTexts.toArray(new String[0]);
        if (summaries.length > 0)         docSummaries.add(fieldName,summaries);
      }
    }
    String printId=searcher.getSchema().printableUniqueKey(doc);
    fragments.add(printId == null ? null : printId,docSummaries);
  }
  return fragments;
}
