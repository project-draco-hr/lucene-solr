{
  dir=new PreventCloseDirectoryWrapper(dir);
  try (MockDirectoryWrapper wrapped=new MockDirectoryWrapper(random(),dir)){
    wrapped.alwaysCorrupt=true;
    RandomIndexWriter iw=new RandomIndexWriter(random(),dir);
    iw.addDocument(new Document());
    iw.close();
    try (IndexOutput out=wrapped.createOutput("foo",IOContext.DEFAULT)){
      for (int i=0; i < 100; i++) {
        out.writeInt(i);
      }
    }
   }
   boolean changed=false;
  IndexInput in=null;
  try {
    in=dir.openInput("foo",IOContext.DEFAULT);
  }
 catch (  NoSuchFileException|FileNotFoundException fnfe) {
    changed=true;
  }
  if (in != null) {
    for (int i=0; i < 100; i++) {
      int x;
      try {
        x=in.readInt();
      }
 catch (      EOFException eofe) {
        changed=true;
        break;
      }
      if (x != i) {
        changed=true;
        break;
      }
    }
    in.close();
  }
  assertTrue("MockDirectoryWrapper on dir=" + dir + " failed to corrupt an unsync'd file",changed);
}
