{
  boolean optimize=true;
  Directory dir1=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(dir1,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  createIndexNoClose(!optimize,"index1",writer);
  IndexReader r1=writer.getReader();
  String id10=r1.document(10).getField("id").stringValue();
  Document newDoc=r1.document(10);
  newDoc.removeField("id");
  newDoc.add(new Field("id",Integer.toString(8000),Store.YES,Index.NOT_ANALYZED));
  writer.updateDocument(new Term("id",id10),newDoc);
  IndexReader r2=writer.getReader();
  assertEquals(0,count(new Term("id",id10),r2));
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r2));
  r1.close();
  r2.close();
  writer.close();
  IndexReader r3=IndexReader.open(dir1,true);
  assertEquals(0,count(new Term("id",id10),r3));
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r3));
  r3.close();
  dir1.close();
}
