{
  Directory dir1=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(dir1,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  writer.setInfoStream(infoStream);
  DirectoryIndexReader r1=(DirectoryIndexReader)writer.getReader();
  assertEquals(0,r1.maxDoc());
  createIndexNoClose(false,"index1",writer);
  writer.flush(!optimize,true,true);
  DirectoryIndexReader iwr1=(DirectoryIndexReader)writer.getReader();
  assertEquals(100,iwr1.maxDoc());
  DirectoryIndexReader r2=(DirectoryIndexReader)writer.getReader();
  assertEquals(r2.maxDoc(),100);
  for (int x=10000; x < 10000 + 100; x++) {
    Document d=createDocument(x,"index1",5);
    writer.addDocument(d);
  }
  writer.flush(false,true,true);
  IndexReader iwr2=writer.getReader();
  assertTrue(iwr2 != r1);
  assertEquals(200,iwr2.maxDoc());
  IndexReader r3=writer.getReader();
  assertTrue(r2 != r3);
  assertEquals(200,r3.maxDoc());
  r1.close();
  iwr1.close();
  r2.close();
  r3.close();
  iwr2.close();
  writer.close();
  writer=new IndexWriter(dir1,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  IndexReader w2r1=writer.getReader();
  assertEquals(200,w2r1.maxDoc());
  w2r1.close();
  writer.close();
  dir1.close();
}
