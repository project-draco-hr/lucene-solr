{
  boolean optimize=false;
  Directory dir1=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(dir1,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.LIMITED);
  writer.setInfoStream(infoStream);
  createIndexNoClose(!optimize,"index1",writer);
  writer.flush(false,true,true);
  Directory dir2=new MockRAMDirectory();
  IndexWriter writer2=new IndexWriter(dir2,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.LIMITED);
  writer2.setInfoStream(infoStream);
  createIndexNoClose(!optimize,"index2",writer2);
  writer2.close();
  IndexReader r0=writer.getReader();
  assertTrue(r0.isCurrent());
  writer.addIndexesNoOptimize(new Directory[]{dir2});
  assertFalse(r0.isCurrent());
  r0.close();
  IndexReader r1=writer.getReader();
  assertTrue(r1.isCurrent());
  writer.commit();
  assertTrue(r1.isCurrent());
  assertEquals(200,r1.maxDoc());
  int index2df=r1.docFreq(new Term("indexname","index2"));
  assertEquals(100,index2df);
  Document doc5=r1.document(5);
  assertEquals("index1",doc5.get("indexname"));
  Document doc150=r1.document(150);
  assertEquals("index2",doc150.get("indexname"));
  r1.close();
  writer.close();
  dir1.close();
}
