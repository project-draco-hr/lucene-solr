{
  try {
    long ramSize=0;
    while (pendingDocs.decrementAndGet() > -1) {
      Document doc=docs.nextDoc();
      writer.addDocument(doc);
      long newRamSize=writer.ramSizeInBytes();
      if (newRamSize != ramSize) {
        ramSize=newRamSize;
      }
      if (doRandomCommit) {
        if (rarely()) {
          writer.commit();
        }
      }
    }
    writer.commit();
  }
 catch (  Throwable ex) {
    throw new RuntimeException(ex);
  }
}
