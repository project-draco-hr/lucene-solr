{
  final Random random=random();
  int numWords=atLeast(1000);
  final TreeMap<String,Long> slowCompletor=new TreeMap<>();
  final TreeSet<String> allPrefixes=new TreeSet<>();
  final PositiveIntOutputs outputs=PositiveIntOutputs.getSingleton();
  final Builder<Long> builder=new Builder<>(FST.INPUT_TYPE.BYTE1,outputs);
  final IntsRefBuilder scratch=new IntsRefBuilder();
  for (int i=0; i < numWords; i++) {
    String s;
    while (true) {
      s=TestUtil.randomSimpleString(random);
      if (!slowCompletor.containsKey(s)) {
        break;
      }
    }
    for (int j=1; j < s.length(); j++) {
      allPrefixes.add(s.substring(0,j));
    }
    int weight=TestUtil.nextInt(random,1,100);
    slowCompletor.put(s,(long)weight);
  }
  for (  Map.Entry<String,Long> e : slowCompletor.entrySet()) {
    builder.add(Util.toIntsRef(new BytesRef(e.getKey()),scratch),e.getValue());
  }
  final FST<Long> fst=builder.finish();
  BytesReader reader=fst.getBytesReader();
  for (  String prefix : allPrefixes) {
    long prefixOutput=0;
    FST.Arc<Long> arc=fst.getFirstArc(new FST.Arc<Long>());
    for (int idx=0; idx < prefix.length(); idx++) {
      if (fst.findTargetArc((int)prefix.charAt(idx),arc,arc,reader) == null) {
        fail();
      }
      prefixOutput+=arc.output;
    }
    final int topN=TestUtil.nextInt(random,1,10);
    Util.TopResults<Long> r=Util.shortestPaths(fst,arc,fst.outputs.getNoOutput(),minLongComparator,topN,true);
    assertTrue(r.isComplete);
    final List<Result<Long>> matches=new ArrayList<>();
    for (    Map.Entry<String,Long> e : slowCompletor.entrySet()) {
      if (e.getKey().startsWith(prefix)) {
        matches.add(new Result<>(Util.toIntsRef(new BytesRef(e.getKey().substring(prefix.length())),new IntsRefBuilder()),e.getValue() - prefixOutput));
      }
    }
    assertTrue(matches.size() > 0);
    Collections.sort(matches,new TieBreakByInputComparator<>(minLongComparator));
    if (matches.size() > topN) {
      matches.subList(topN,matches.size()).clear();
    }
    assertEquals(matches.size(),r.topN.size());
    for (int hit=0; hit < r.topN.size(); hit++) {
      assertEquals(matches.get(hit).input,r.topN.get(hit).input);
      assertEquals(matches.get(hit).output,r.topN.get(hit).output);
    }
  }
}
