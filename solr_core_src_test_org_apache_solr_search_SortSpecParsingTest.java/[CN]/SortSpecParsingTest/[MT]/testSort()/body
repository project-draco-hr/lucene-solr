{
  Sort sort;
  SortSpec spec;
  SolrQueryRequest req=req();
  sort=SortSpecParsing.parseSortSpec("score desc",req).getSort();
  assertNull("sort",sort);
  spec=SortSpecParsing.parseSortSpec("score desc",req);
  assertNotNull("spec",spec);
  assertNull(spec.getSort());
  assertNotNull(spec.getSchemaFields());
  assertEquals(0,spec.getSchemaFields().size());
  sort=SortSpecParsing.parseSortSpec("score aSc",req).getSort();
  SortField[] flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.SCORE);
  assertTrue(flds[0].getReverse());
  spec=SortSpecParsing.parseSortSpec("score aSc",req);
  flds=spec.getSort().getSort();
  assertEquals(1,flds.length);
  assertEquals(flds[0].getType(),SortField.Type.SCORE);
  assertTrue(flds[0].getReverse());
  assertEquals(1,spec.getSchemaFields().size());
  assertNull(spec.getSchemaFields().get(0));
  sort=SortSpecParsing.parseSortSpec("weight dEsC",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[0].getReverse(),true);
  spec=SortSpecParsing.parseSortSpec("weight dEsC",req);
  flds=spec.getSort().getSort();
  assertEquals(1,flds.length);
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[0].getReverse(),true);
  assertEquals(1,spec.getSchemaFields().size());
  assertNotNull(spec.getSchemaFields().get(0));
  assertEquals("weight",spec.getSchemaFields().get(0).getName());
  sort=SortSpecParsing.parseSortSpec("weight desc,bday ASC",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[0].getReverse(),true);
  assertEquals(flds[1].getType(),SortField.Type.LONG);
  assertEquals(flds[1].getField(),"bday");
  assertEquals(flds[1].getReverse(),false);
  sort=SortSpecParsing.parseSortSpec("weight top,bday asc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[0].getReverse(),true);
  assertEquals(flds[1].getType(),SortField.Type.LONG);
  assertEquals(flds[1].getField(),"bday");
  assertEquals(flds[1].getReverse(),false);
  sort=SortSpecParsing.parseSortSpec("weight top,bday bottom",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[0].getReverse(),true);
  assertEquals(flds[1].getType(),SortField.Type.LONG);
  assertEquals(flds[1].getField(),"bday");
  assertEquals(flds[1].getReverse(),false);
  sort=SortSpecParsing.parseSortSpec("weight         DESC,            bday         asc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  assertEquals(flds[1].getField(),"bday");
  assertEquals(flds[1].getType(),SortField.Type.LONG);
  sort=SortSpecParsing.parseSortSpec("weight desc,",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  sort=SortSpecParsing.parseSortSpec("pow(weight, 2) desc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.REWRITEABLE);
  assertEquals(flds[0].getField(),"pow(float(weight),const(2))");
  sort=SortSpecParsing.parseSortSpec("sum(product(r_f1,sum(d_f1,t_f1,1.0)),a_f1) asc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.REWRITEABLE);
  assertEquals(flds[0].getField(),"sum(product(float(r_f1),sum(float(d_f1),float(t_f1),const(1.0))),float(a_f1))");
  sort=SortSpecParsing.parseSortSpec("pow(weight,                 2.0)         desc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.REWRITEABLE);
  assertEquals(flds[0].getField(),"pow(float(weight),const(2.0))");
  spec=SortSpecParsing.parseSortSpec("pow(weight, 2.0) desc, weight    desc,   bday    asc",req);
  flds=spec.getSort().getSort();
  List<SchemaField> schemaFlds=spec.getSchemaFields();
  assertEquals(3,flds.length);
  assertEquals(3,schemaFlds.size());
  assertEquals(flds[0].getType(),SortField.Type.REWRITEABLE);
  assertEquals(flds[0].getField(),"pow(float(weight),const(2.0))");
  assertNull(schemaFlds.get(0));
  assertEquals(flds[1].getType(),SortField.Type.FLOAT);
  assertEquals(flds[1].getField(),"weight");
  assertNotNull(schemaFlds.get(1));
  assertEquals("weight",schemaFlds.get(1).getName());
  assertEquals(flds[2].getField(),"bday");
  assertEquals(flds[2].getType(),SortField.Type.LONG);
  assertNotNull(schemaFlds.get(2));
  assertEquals("bday",schemaFlds.get(2).getName());
  sort=SortSpecParsing.parseSortSpec("weight desc,",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.FLOAT);
  assertEquals(flds[0].getField(),"weight");
  sort=SortSpecParsing.parseSortSpec("strdist(foo_s1, \"junk\", jw) desc",req).getSort();
  flds=sort.getSort();
  assertEquals(flds[0].getType(),SortField.Type.REWRITEABLE);
  assertEquals(flds[0].getField(),"strdist(str(foo_s1),literal(junk), dist=org.apache.lucene.search.spell.JaroWinklerDistance)");
  sort=SortSpecParsing.parseSortSpec("",req).getSort();
  assertNull(sort);
  spec=SortSpecParsing.parseSortSpec("",req);
  assertNotNull(spec);
  assertNull(spec.getSort());
  req.close();
}
