{
  Map<DocValuesConsumer,Collection<String>> consumersToField=new IdentityHashMap<>();
  for (  FieldInfo fi : mergeState.mergeFieldInfos) {
    DocValuesConsumer consumer=getInstance(fi);
    Collection<String> fieldsForConsumer=consumersToField.get(consumer);
    if (fieldsForConsumer == null) {
      fieldsForConsumer=new ArrayList<>();
      consumersToField.put(consumer,fieldsForConsumer);
    }
    fieldsForConsumer.add(fi.name);
  }
  PerFieldMergeState pfMergeState=new PerFieldMergeState(mergeState);
  try {
    for (    Map.Entry<DocValuesConsumer,Collection<String>> e : consumersToField.entrySet()) {
      e.getKey().merge(pfMergeState.apply(e.getValue()));
    }
  }
  finally {
    pfMergeState.reset();
  }
}
