{
  int optionalClauses=0;
  int maxDisjunctsSize=0;
  int optionalDismaxClauses=0;
  for (  BooleanClause c : q.build().clauses()) {
    if (c.getOccur() == Occur.SHOULD) {
      if (mmAutoRelax && c.getQuery() instanceof DisjunctionMaxQuery) {
        int numDisjuncts=((DisjunctionMaxQuery)c.getQuery()).getDisjuncts().size();
        if (numDisjuncts > maxDisjunctsSize) {
          maxDisjunctsSize=numDisjuncts;
          optionalDismaxClauses=1;
        }
 else         if (numDisjuncts == maxDisjunctsSize) {
          optionalDismaxClauses++;
        }
      }
 else {
        optionalClauses++;
      }
    }
  }
  int msm=calculateMinShouldMatch(optionalClauses + optionalDismaxClauses,spec);
  if (0 < msm) {
    q.setMinimumNumberShouldMatch(msm);
  }
}
