{
  String bucketName=_buckets[level].toString();
  NamedList nl=(NamedList)facets.get(bucketName);
  List allBuckets=(List)nl.get("buckets");
  for (int b=0; b < allBuckets.size(); b++) {
    NamedList bucket=(NamedList)allBuckets.get(b);
    Object val=bucket.get("val");
    Tuple t=currentTuple.clone();
    t.put(bucketName,val);
    int nextLevel=level + 1;
    if (nextLevel < _buckets.length) {
      fillTuples(nextLevel,tuples,t.clone(),bucket,_buckets,_metrics);
    }
 else {
      int m=0;
      for (      Metric metric : _metrics) {
        String identifier=metric.getIdentifier();
        if (!identifier.startsWith("count(")) {
          double d=(double)bucket.get("facet_" + m);
          t.put(identifier,d);
          ++m;
        }
 else {
          long l=(long)bucket.get("count");
          t.put("count(*)",l);
        }
      }
      tuples.add(t);
    }
  }
}
