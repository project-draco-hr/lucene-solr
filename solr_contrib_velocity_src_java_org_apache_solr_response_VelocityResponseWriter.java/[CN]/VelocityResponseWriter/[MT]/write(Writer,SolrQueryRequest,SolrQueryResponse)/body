{
  VelocityEngine engine=getEngine(request);
  Template template=getTemplate(engine,request);
  VelocityContext context=new VelocityContext();
  context.put("request",request);
  SolrResponse rsp=new QueryResponse();
  NamedList<Object> parsedResponse=BinaryResponseWriter.getParsedResponse(request,response);
  try {
    rsp.setResponse(parsedResponse);
    context.put("page",new PageTool(request,response));
  }
 catch (  ClassCastException e) {
    rsp=new SolrResponseBase();
    rsp.setResponse(parsedResponse);
  }
  context.put("response",rsp);
  context.put("esc",new EscapeTool());
  context.put("date",new ComparisonDateTool());
  context.put("list",new ListTool());
  context.put("math",new MathTool());
  context.put("number",new NumberTool());
  context.put("sort",new SortTool());
  context.put("display",new DisplayTool());
  context.put("engine",engine);
  String layout_template=request.getParams().get("v.layout");
  String json_wrapper=request.getParams().get("v.json");
  boolean wrap_response=(layout_template != null) || (json_wrapper != null);
  if (wrap_response) {
    StringWriter stringWriter=new StringWriter();
    template.merge(context,stringWriter);
    if (layout_template != null) {
      context.put("content",stringWriter.toString());
      stringWriter=new StringWriter();
      try {
        engine.getTemplate(layout_template + ".vm").merge(context,stringWriter);
      }
 catch (      Exception e) {
        throw new IOException(e.getMessage());
      }
    }
    if (json_wrapper != null) {
      writer.write(request.getParams().get("v.json") + "(");
      writer.write(getJSONWrap(stringWriter.toString()));
      writer.write(')');
    }
 else {
      writer.write(stringWriter.toString());
    }
  }
 else {
    template.merge(context,writer);
  }
}
