{
  VelocityEngine engine=createEngine(request);
  Template template=getTemplate(engine,request);
  VelocityContext context=createContext(request,response);
  context.put("engine",engine);
  String layoutTemplate=request.getParams().get(LAYOUT);
  boolean layoutEnabled=request.getParams().getBool(LAYOUT_ENABLED,true) && layoutTemplate != null;
  String jsonWrapper=request.getParams().get(JSON);
  boolean wrapResponse=layoutEnabled || jsonWrapper != null;
  if (!wrapResponse) {
    template.merge(context,writer);
  }
 else {
    StringWriter stringWriter=new StringWriter();
    template.merge(context,stringWriter);
    if (layoutEnabled) {
      context.put("content",stringWriter.toString());
      stringWriter=new StringWriter();
      try {
        engine.getTemplate(layoutTemplate + TEMPLATE_EXTENSION).merge(context,stringWriter);
      }
 catch (      Exception e) {
        throw new IOException(e.getMessage());
      }
    }
    if (jsonWrapper != null) {
      writer.write(jsonWrapper + "(");
      writer.write(getJSONWrap(stringWriter.toString()));
      writer.write(')');
    }
 else {
      writer.write(stringWriter.toString());
    }
  }
}
