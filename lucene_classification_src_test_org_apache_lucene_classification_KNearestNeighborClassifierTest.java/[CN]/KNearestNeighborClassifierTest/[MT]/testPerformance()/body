{
  MockAnalyzer analyzer=new MockAnalyzer(random());
  LeafReader leafReader=getRandomIndex(analyzer,100);
  try {
    long trainStart=System.currentTimeMillis();
    KNearestNeighborClassifier kNearestNeighborClassifier=new KNearestNeighborClassifier(leafReader,null,analyzer,null,1,1,1,categoryFieldName,textFieldName);
    long trainEnd=System.currentTimeMillis();
    long trainTime=trainEnd - trainStart;
    assertTrue("training took more than 10s: " + trainTime / 1000 + "s",trainTime < 10000);
    long evaluationStart=System.currentTimeMillis();
    ConfusionMatrixGenerator.ConfusionMatrix confusionMatrix=ConfusionMatrixGenerator.getConfusionMatrix(leafReader,kNearestNeighborClassifier,categoryFieldName,textFieldName);
    assertNotNull(confusionMatrix);
    long evaluationEnd=System.currentTimeMillis();
    long evaluationTime=evaluationEnd - evaluationStart;
    assertTrue("evaluation took more than 2m: " + evaluationTime / 1000 + "s",evaluationTime < 120000);
    double avgClassificationTime=confusionMatrix.getAvgClassificationTime();
    assertTrue(5000 > avgClassificationTime);
    double accuracy=confusionMatrix.getAccuracy();
    assertTrue(accuracy > 0d);
  }
  finally {
    leafReader.close();
  }
}
