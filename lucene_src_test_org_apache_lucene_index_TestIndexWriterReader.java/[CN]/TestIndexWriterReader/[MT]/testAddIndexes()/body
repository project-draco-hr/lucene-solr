{
  boolean optimize=false;
  Directory dir1=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer());
  if (iwc.getMaxBufferedDocs() < 20) {
    iwc.setMaxBufferedDocs(20);
  }
  if (random.nextBoolean()) {
    iwc.setMergePolicy(NoMergePolicy.NO_COMPOUND_FILES);
  }
 else {
    iwc.setMergePolicy(NoMergePolicy.COMPOUND_FILES);
  }
  IndexWriter writer=new IndexWriter(dir1,iwc);
  writer.setInfoStream(infoStream);
  createIndexNoClose(!optimize,"index1",writer);
  writer.flush(false,true,true);
  Directory dir2=newDirectory();
  IndexWriter writer2=new IndexWriter(dir2,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()));
  writer2.setInfoStream(infoStream);
  createIndexNoClose(!optimize,"index2",writer2);
  writer2.close();
  IndexReader r0=writer.getReader();
  assertTrue(r0.isCurrent());
  writer.addIndexes(new Directory[]{dir2});
  assertFalse(r0.isCurrent());
  r0.close();
  IndexReader r1=writer.getReader();
  assertTrue(r1.isCurrent());
  writer.commit();
  assertFalse(r1.isCurrent());
  assertEquals(200,r1.maxDoc());
  int index2df=r1.docFreq(new Term("indexname","index2"));
  assertEquals(100,index2df);
  Document doc5=r1.document(5);
  assertEquals("index1",doc5.get("indexname"));
  Document doc150=r1.document(150);
  assertEquals("index2",doc150.get("indexname"));
  r1.close();
  writer.close();
  dir1.close();
  dir2.close();
}
