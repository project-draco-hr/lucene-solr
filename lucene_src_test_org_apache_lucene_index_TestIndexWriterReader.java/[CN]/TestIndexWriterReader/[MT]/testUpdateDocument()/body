{
  boolean optimize=true;
  Directory dir1=newDirectory();
  IndexWriter writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  createIndexNoClose(!optimize,"index1",writer);
  IndexReader r1=writer.getReader();
  assertTrue(r1.isCurrent());
  String id10=r1.document(10).getField("id").stringValue();
  Document newDoc=r1.document(10);
  newDoc.removeField("id");
  newDoc.add(newField("id",Integer.toString(8000),Store.YES,Index.NOT_ANALYZED));
  writer.updateDocument(new Term("id",id10),newDoc);
  assertFalse(r1.isCurrent());
  IndexReader r2=writer.getReader();
  assertTrue(r2.isCurrent());
  assertEquals(0,count(new Term("id",id10),r2));
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r2));
  r1.close();
  writer.close();
  assertTrue(r2.isCurrent());
  IndexReader r3=IndexReader.open(dir1,true);
  assertTrue(r3.isCurrent());
  assertTrue(r2.isCurrent());
  assertEquals(0,count(new Term("id",id10),r3));
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r3));
  writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()));
  Document doc=new Document();
  doc.add(newField("field","a b c",Field.Store.NO,Field.Index.ANALYZED));
  writer.addDocument(doc);
  assertTrue(r2.isCurrent());
  assertTrue(r3.isCurrent());
  writer.close();
  assertFalse(r2.isCurrent());
  assertTrue(!r3.isCurrent());
  r2.close();
  r3.close();
  dir1.close();
}
