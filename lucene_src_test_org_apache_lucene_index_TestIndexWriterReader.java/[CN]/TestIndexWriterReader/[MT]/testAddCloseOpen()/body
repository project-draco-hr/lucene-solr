{
  Directory dir1=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer());
  IndexWriter writer=new IndexWriter(dir1,iwc);
  for (int i=0; i < 97; i++) {
    IndexReader reader=writer.getReader();
    if (i == 0) {
      writer.addDocument(createDocument(i,"x",1 + random.nextInt(5)));
    }
 else {
      int previous=random.nextInt(i);
switch (random.nextInt(5)) {
case 0:
case 1:
case 2:
        writer.addDocument(createDocument(i,"x",1 + random.nextInt(5)));
      break;
case 3:
    writer.updateDocument(new Term("id","" + previous),createDocument(previous,"x",1 + random.nextInt(5)));
  break;
case 4:
writer.deleteDocuments(new Term("id","" + previous));
}
}
assertFalse(reader.isCurrent());
reader.close();
}
writer.optimize();
IndexReader reader=writer.getReader();
writer.commit();
assertTrue(reader.isCurrent());
writer.close();
assertTrue(reader.isCurrent());
iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer());
writer=new IndexWriter(dir1,iwc);
assertTrue(reader.isCurrent());
writer.addDocument(createDocument(1,"x",1 + random.nextInt(5)));
assertTrue(reader.isCurrent());
writer.close();
assertFalse(reader.isCurrent());
reader.close();
dir1.close();
}
