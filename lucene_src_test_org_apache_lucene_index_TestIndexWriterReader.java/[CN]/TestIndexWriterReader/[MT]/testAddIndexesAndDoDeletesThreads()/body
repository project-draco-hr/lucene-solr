{
  final int numIter=2;
  int numDirs=3;
  Directory mainDir=newDirectory();
  IndexWriter mainWriter=new IndexWriter(mainDir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(newLogMergePolicy()));
  _TestUtil.reduceOpenFiles(mainWriter);
  AddDirectoriesThreads addDirThreads=new AddDirectoriesThreads(numIter,mainWriter);
  addDirThreads.launchThreads(numDirs);
  addDirThreads.joinThreads();
  assertEquals(addDirThreads.count.intValue(),addDirThreads.mainWriter.numDocs());
  addDirThreads.close(true);
  assertTrue(addDirThreads.failures.size() == 0);
  _TestUtil.checkIndex(mainDir);
  IndexReader reader=IndexReader.open(mainDir,true);
  assertEquals(addDirThreads.count.intValue(),reader.numDocs());
  reader.close();
  addDirThreads.closeDir();
  mainDir.close();
}
