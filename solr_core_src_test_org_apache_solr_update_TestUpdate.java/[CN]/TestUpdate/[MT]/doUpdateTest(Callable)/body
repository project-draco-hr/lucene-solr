{
  clearIndex();
  afterUpdate.call();
  long version;
  version=addAndGetVersion(sdoc("id","1","val_i",5,"copyfield_source","a"),null);
  afterUpdate.call();
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",10),"copyfield_source",map("add","b")),null);
  afterUpdate.call();
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",5)),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,*_i,*_is,copyfield_*"),"=={'doc':{'id':'1', 'val_i':5, 'val_is':[10,5], 'copyfield_source':['a','b']}}");
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",-1),"val_i",map("set",100)),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,*_i,*_is"),"=={'doc':{'id':'1', 'val_i':100, 'val_is':[10,5,-1]}}");
  assertU(commit("softCommit","true"));
  assertJQ(req("q","*:*","fl","id,*_i,*_is,copyfield_*"),"/response/docs/[0]=={'id':'1', 'val_i':100, 'val_is':[10,5,-1], 'copyfield_source':['a','b'], 'copyfield_dest_ss':['a','b']}");
  long version2;
  try {
    version2=addAndGetVersion(sdoc("id","1","val_is",map("add",-100),"_version_",2),null);
    fail();
  }
 catch (  SolrException se) {
    assertEquals(409,se.code());
  }
  try {
    version2=addAndGetVersion(sdoc("id","1","val_is",map("add",-100)),params("_version_","2"));
    fail();
  }
 catch (  SolrException se) {
    assertEquals(409,se.code());
  }
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",-100),"_version_",version),null);
  afterUpdate.call();
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",-200)),params("_version_",Long.toString(version)));
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,*_i,*_is"),"=={'doc':{'id':'1', 'val_i':100, 'val_is':[10,5,-1,-100,-200]}}");
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",-300),"val_i",2),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,*_i,*_is"),"=={'doc':{'id':'1', 'val_i':2, 'val_is':[10,5,-1,-100,-200,-300]}}");
  version=addAndGetVersion(sdoc("id","1","val_is",map("add",-400),"val_i",null),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,*_i,*_is"),"=={'doc':{'id':'1', 'val_is':[10,5,-1,-100,-200,-300,-400]}}");
  version=deleteAndGetVersion("1",null);
  afterUpdate.call();
  try {
    version2=addAndGetVersion(sdoc("id","1","val_is",map("add",-101),"_version_","1"),null);
    fail();
  }
 catch (  SolrException se) {
    assertEquals(409,se.code());
  }
  version=addAndGetVersion(sdoc("id","1","val_i",102,"val_is",map("add",-102)),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,val*"),"=={'doc':{'id':'1', 'val_i':102, 'val_is':[-102]}}");
  version=addAndGetVersion(sdoc("id","1","val_i",5),null);
  afterUpdate.call();
  version=addAndGetVersion(sdoc("id","1","val_is",map("inc",1),"val2_i",map("inc","1"),"val2_f",map("inc",1),"val2_d",map("inc","1.0"),"val2_l",map("inc",1)),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,val*"),"=={'doc':{'id':'1', 'val_i':5, 'val_is':[1], 'val2_i':1, 'val2_f':1.0, 'val2_d':1.0, 'val2_l':1}}");
  version=addAndGetVersion(sdoc("id","1","val_is",map("inc","-5"),"val2_i",map("inc",-5),"val2_f",map("inc","-5.0"),"val2_d",map("inc",-5),"val2_l",map("inc","-5")),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,val*"),"=={'doc':{'id':'1', 'val_i':5, 'val_is':[-4], 'val2_i':-4, 'val2_f':-4.0, 'val2_d':-4.0, 'val2_l':-4}}");
  version=addAndGetVersion(sdoc("id","1","val_is",map("inc","2000000000"),"val2_i",map("inc",-2000000000),"val2_f",map("inc","1e+20"),"val2_d",map("inc",-1.2345678901e+100),"val2_l",map("inc","5000000000")),null);
  afterUpdate.call();
  assertJQ(req("qt","/get","id","1","fl","id,val*"),"=={'doc':{'id':'1', 'val_i':5, 'val_is':[1999999996], 'val2_i':-2000000004, 'val2_f':1.0E20, 'val2_d':-1.2345678901e+100, 'val2_l':4999999996}}");
}
