{
  if (segmentFacetCounts != null) {
    segmentResults.add(createSegmentResult());
  }
  groupFieldTermsIndex=FieldCache.DEFAULT.getTermsIndex(context.reader(),groupField);
  facetFieldTermsIndex=FieldCache.DEFAULT.getTermsIndex(context.reader(),facetField);
  segmentFacetCounts=new int[facetFieldTermsIndex.numOrd()];
  segmentTotalCount=0;
  segmentGroupedFacetHits.clear();
  for (  GroupedFacetHit groupedFacetHit : groupedFacetHits) {
    int facetOrd=facetFieldTermsIndex.binarySearchLookup(groupedFacetHit.facetValue,spare);
    if (facetOrd < 0) {
      continue;
    }
    int groupOrd=groupFieldTermsIndex.binarySearchLookup(groupedFacetHit.groupValue,spare);
    if (groupOrd < 0) {
      continue;
    }
    int segmentGroupedFacetsIndex=(groupOrd * facetFieldTermsIndex.numOrd()) + facetOrd;
    segmentGroupedFacetHits.put(segmentGroupedFacetsIndex);
  }
  if (facetPrefix != null) {
    startFacetOrd=facetFieldTermsIndex.binarySearchLookup(facetPrefix,spare);
    if (startFacetOrd < 0) {
      startFacetOrd=-startFacetOrd - 1;
    }
    BytesRef facetEndPrefix=BytesRef.deepCopyOf(facetPrefix);
    facetEndPrefix.append(UnicodeUtil.BIG_TERM);
    endFacetOrd=facetFieldTermsIndex.binarySearchLookup(facetEndPrefix,spare);
    endFacetOrd=-endFacetOrd - 1;
  }
 else {
    startFacetOrd=0;
    endFacetOrd=facetFieldTermsIndex.numOrd();
  }
}
