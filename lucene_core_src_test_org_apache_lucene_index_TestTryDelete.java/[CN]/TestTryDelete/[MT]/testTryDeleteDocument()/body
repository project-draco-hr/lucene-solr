{
  Directory directory=createIndex();
  IndexWriter writer=getWriter(directory);
  ReferenceManager<IndexSearcher> mgr=new SearcherManager(writer,new SearcherFactory());
  TrackingIndexWriter mgrWriter=new TrackingIndexWriter(writer);
  IndexSearcher searcher=mgr.acquire();
  TopDocs topDocs=searcher.search(new TermQuery(new Term("foo","0")),100);
  assertEquals(1,topDocs.totalHits);
  long result;
  if (random().nextBoolean()) {
    IndexReader r=DirectoryReader.open(writer);
    result=mgrWriter.tryDeleteDocument(r,0);
    r.close();
  }
 else {
    result=mgrWriter.tryDeleteDocument(searcher.getIndexReader(),0);
  }
  assertTrue(result != -1);
  assertTrue(writer.hasDeletions());
  if (random().nextBoolean()) {
    writer.commit();
  }
  assertTrue(writer.hasDeletions());
  mgr.maybeRefresh();
  searcher=mgr.acquire();
  topDocs=searcher.search(new TermQuery(new Term("foo","0")),100);
  assertEquals(0,topDocs.totalHits);
}
