{
  if (infoStream != null) {
    message("now checkpoint \"" + segmentInfos.getCurrentSegmentFileName() + "\" ["+ segmentInfos.size()+ " segments "+ "; isCommit = "+ isCommit+ "]");
  }
  if (deletable != null) {
    List oldDeletable=deletable;
    deletable=null;
    int size=oldDeletable.size();
    for (int i=0; i < size; i++) {
      deleteFile((String)oldDeletable.get(i));
    }
  }
  incRef(segmentInfos,isCommit);
  if (docWriter != null)   incRef(docWriter.files());
  if (isCommit) {
    commits.add(new CommitPoint(segmentInfos));
    policy.onCommit(commits);
    deleteCommits();
  }
  int size=lastFiles.size();
  if (size > 0) {
    for (int i=0; i < size; i++)     decRef((List)lastFiles.get(i));
    lastFiles.clear();
  }
  if (!isCommit) {
    size=segmentInfos.size();
    for (int i=0; i < size; i++) {
      SegmentInfo segmentInfo=segmentInfos.info(i);
      if (segmentInfo.dir == directory) {
        lastFiles.add(segmentInfo.files());
      }
    }
    if (docWriter != null)     lastFiles.add(docWriter.files());
  }
}
