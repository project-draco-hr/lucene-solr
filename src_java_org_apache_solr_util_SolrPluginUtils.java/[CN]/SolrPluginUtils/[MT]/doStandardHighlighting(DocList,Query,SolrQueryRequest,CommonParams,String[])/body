{
  if (!getBooleanParam(req,params.HIGHLIGHT,params.highlight))   return null;
  String fieldParam=getParam(req,params.HIGHLIGHT_FIELDS,params.highlightFields);
  String fields[];
  if (fieldParam == null || fieldParam.trim().equals("")) {
    if (defaultFields == null || defaultFields.length == 0 || defaultFields[0] == null) {
      fields=new String[]{req.getSchema().getDefaultSearchFieldName()};
    }
 else     fields=defaultFields;
  }
 else   fields=splitList.split(fieldParam.trim());
  Highlighter highlighter;
  String formatterSpec=getParam(req,params.HIGHLIGHT_FORMATTER_CLASS,params.highlightFormatterClass);
  if (formatterSpec == null || formatterSpec.equals("")) {
    highlighter=getDefaultHighlighter(query);
  }
 else {
    highlighter=new Highlighter((Formatter)Config.newInstance(formatterSpec),new QueryScorer(query));
    highlighter.setTextFragmenter(new GapFragmenter());
  }
  int numFragments=getNumberParam(req,params.MAX_SNIPPETS,params.maxSnippets).intValue();
  return getHighlights(docs,fields,req.getSearcher(),highlighter,numFragments);
}
