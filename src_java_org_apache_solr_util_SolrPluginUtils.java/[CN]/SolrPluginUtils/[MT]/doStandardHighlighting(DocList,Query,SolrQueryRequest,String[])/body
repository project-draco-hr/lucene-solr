{
  SolrParams p=req.getParams();
  if (!p.getBool(SolrParams.HIGHLIGHT,false))   return null;
  String fieldParam=p.get(SolrParams.HIGHLIGHT_FIELDS);
  String fields[];
  if (fieldParam == null || fieldParam.trim().equals("")) {
    if (defaultFields == null || defaultFields.length == 0 || defaultFields[0] == null) {
      fields=new String[]{req.getSchema().getDefaultSearchFieldName()};
    }
 else     fields=defaultFields;
  }
 else   fields=splitList.split(fieldParam.trim());
  Highlighter highlighter;
  String formatterSpec=p.get(SolrParams.HIGHLIGHT_FORMATTER_CLASS);
  if (formatterSpec == null) {
    highlighter=getDefaultHighlighter(query);
  }
 else {
    highlighter=new Highlighter((Formatter)Config.newInstance(formatterSpec),new QueryScorer(query));
    highlighter.setTextFragmenter(new GapFragmenter());
  }
  int numFragments=p.getInt(SolrParams.MAX_SNIPPETS,1);
  return getHighlights(docs,fields,req.getSearcher(),highlighter,numFragments);
}
