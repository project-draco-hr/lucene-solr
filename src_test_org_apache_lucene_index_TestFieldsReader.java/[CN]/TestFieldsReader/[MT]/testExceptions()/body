{
  String tempDir=System.getProperty("java.io.tmpdir");
  if (tempDir == null)   throw new IOException("java.io.tmpdir undefined, cannot run test");
  File indexDir=new File(tempDir,"testfieldswriterexceptions");
  try {
    Directory dir=new FaultyFSDirectory(indexDir);
    IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT).setOpenMode(OpenMode.CREATE));
    for (int i=0; i < 2; i++)     writer.addDocument(testDoc);
    writer.optimize();
    writer.close();
    IndexReader reader=IndexReader.open(dir,true);
    FaultyIndexInput.doFail=true;
    boolean exc=false;
    for (int i=0; i < 2; i++) {
      try {
        reader.document(i);
      }
 catch (      IOException ioe) {
        exc=true;
      }
      try {
        reader.document(i);
      }
 catch (      IOException ioe) {
        exc=true;
      }
    }
    assertTrue(exc);
    reader.close();
    dir.close();
  }
  finally {
    _TestUtil.rmDir(indexDir);
  }
}
