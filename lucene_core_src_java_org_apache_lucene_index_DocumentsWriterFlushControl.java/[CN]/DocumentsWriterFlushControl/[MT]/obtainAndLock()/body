{
  final ThreadState perThread=perThreadPool.getAndLock(Thread.currentThread(),documentsWriter);
  boolean success=false;
  try {
    if (perThread.isActive() && perThread.perThread.deleteQueue != documentsWriter.deleteQueue) {
      addFlushableState(perThread);
    }
    success=true;
    return perThread;
  }
  finally {
    if (!success) {
      perThread.unlock();
    }
  }
}
