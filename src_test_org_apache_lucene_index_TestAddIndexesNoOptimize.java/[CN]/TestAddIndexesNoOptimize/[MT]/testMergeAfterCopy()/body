{
  Directory dir=new RAMDirectory();
  Directory aux=new RAMDirectory();
  setUpDirs(dir,aux);
  IndexReader reader=IndexReader.open(aux);
  for (int i=0; i < 20; i++) {
    reader.deleteDocument(i);
  }
  assertEquals(10,reader.numDocs());
  reader.close();
  IndexWriter writer=newWriter(dir,false);
  writer.setMaxBufferedDocs(4);
  writer.setMergeFactor(4);
  writer.addIndexesNoOptimize(new Directory[]{aux,new RAMDirectory(aux)});
  assertEquals(1020,writer.docCount());
  assertEquals(1000,writer.getDocCount(0));
  writer.close();
  verifyNumDocs(dir,1020);
}
