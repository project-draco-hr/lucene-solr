{
  Exception exp=null;
  SolrCore localCore=null;
  try {
    SolrQueryResponse solrResp=new SolrQueryResponse();
    if (ex instanceof Exception) {
      solrResp.setException((Exception)ex);
    }
 else {
      solrResp.setException(new RuntimeException(ex));
    }
    localCore=core;
    if (solrReq == null) {
      final SolrParams solrParams;
      if (req != null) {
        solrParams=SolrRequestParsers.parseQueryString(req.getQueryString());
      }
 else {
        solrParams=new MapSolrParams(Collections.<String,String>emptyMap());
      }
      solrReq=new SolrQueryRequestBase(core,solrParams){
      }
;
    }
    QueryResponseWriter writer=core.getQueryResponseWriter(solrReq);
    writeResponse(solrResp,writer,Method.GET);
  }
 catch (  Exception e) {
    exp=e;
  }
 finally {
    try {
      if (exp != null) {
        SimpleOrderedMap info=new SimpleOrderedMap();
        int code=ResponseUtils.getErrorInfo(ex,info,SolrDispatchFilter.log);
        sendError(code,info.toString());
      }
    }
  finally {
      if (core == null && localCore != null) {
        localCore.close();
      }
    }
  }
}
