{
  SolrParams p=req.getParams();
  String words=p.get("q");
  String cmd=p.get("cmd");
  if (cmd != null) {
    cmd=cmd.trim();
    if (cmd.equals("rebuild")) {
      rebuild(req);
      rsp.add("cmdExecuted","rebuild");
    }
 else     if (cmd.equals("reopen")) {
      reopen();
      rsp.add("cmdExecuted","reopen");
    }
 else {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Unrecognized Command: " + cmd);
    }
  }
  IndexReader indexReader=null;
  String suggestionField=null;
  Float accuracy;
  int numSug;
  try {
    accuracy=p.getFloat("accuracy",DEFAULT_ACCURACY);
    spellChecker.setAccuracy(accuracy);
  }
 catch (  NumberFormatException e) {
    throw new RuntimeException("Accuracy must be a valid positive float",e);
  }
  try {
    numSug=p.getInt("suggestionCount",DEFAULT_NUM_SUGGESTIONS);
  }
 catch (  NumberFormatException e) {
    throw new RuntimeException("Spelling suggestion count must be a valid positive integer",e);
  }
  try {
    onlyMorePopular=p.getBool("onlyMorePopular",DEFAULT_MORE_POPULAR);
  }
 catch (  NumberFormatException e) {
    throw new RuntimeException("'Only more popular' must be a valid boolean",e);
  }
  if (onlyMorePopular) {
    indexReader=req.getSearcher().getReader();
    suggestionField=termSourceField;
  }
  if (null != words && !"".equals(words.trim())) {
    String[] suggestions=spellChecker.suggestSimilar(words,numSug,indexReader,suggestionField,onlyMorePopular);
    rsp.add("suggestions",Arrays.asList(suggestions));
  }
}
