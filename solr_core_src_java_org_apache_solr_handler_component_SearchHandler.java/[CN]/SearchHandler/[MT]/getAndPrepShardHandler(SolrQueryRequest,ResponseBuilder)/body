{
  ShardHandler shardHandler=null;
  CoreContainer cc=req.getCore().getCoreDescriptor().getCoreContainer();
  boolean isZkAware=cc.isZooKeeperAware();
  rb.isDistrib=req.getParams().getBool("distrib",isZkAware);
  if (!rb.isDistrib) {
    final String shards=req.getParams().get(ShardParams.SHARDS);
    rb.isDistrib=((shards != null) && (shards.indexOf('/') > 0));
  }
  if (rb.isDistrib) {
    shardHandler=shardHandlerFactory.getShardHandler();
    shardHandler.prepDistributed(rb);
    if (!rb.isDistrib) {
      shardHandler=null;
    }
  }
  if (isZkAware) {
    ZkController zkController=cc.getZkController();
    NamedList<Object> headers=rb.rsp.getResponseHeader();
    if (headers != null) {
      headers.add("zkConnected",zkController != null ? !zkController.getZkClient().getConnectionManager().isLikelyExpired() : false);
    }
  }
  return shardHandler;
}
