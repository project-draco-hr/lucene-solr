{
  List<SearchComponent> components=getComponents();
  ResponseBuilder rb=new ResponseBuilder(req,rsp,components);
  if (rb.requestInfo != null) {
    rb.requestInfo.setResponseBuilder(rb);
  }
  boolean dbg=req.getParams().getBool(CommonParams.DEBUG_QUERY,false);
  rb.setDebug(dbg);
  if (dbg == false) {
    SolrPluginUtils.getDebugInterests(req.getParams().getParams(CommonParams.DEBUG),rb);
  }
  final RTimer timer=rb.isDebug() ? req.getRequestTimer() : null;
  ShardHandler shardHandler1=shardHandlerFactory.getShardHandler();
  shardHandler1.checkDistributed(rb);
  if (timer == null) {
    for (    SearchComponent c : components) {
      c.prepare(rb);
    }
  }
 else {
    RTimer subt=timer.sub("prepare");
    for (    SearchComponent c : components) {
      rb.setTimer(subt.sub(c.getName()));
      c.prepare(rb);
      rb.getTimer().stop();
    }
    subt.stop();
  }
  if (!rb.isDistrib) {
    long timeAllowed=req.getParams().getLong(CommonParams.TIME_ALLOWED,-1L);
    if (timeAllowed > 0L) {
      SolrQueryTimeoutImpl.set(timeAllowed);
    }
    try {
      if (!rb.isDebug()) {
        for (        SearchComponent c : components) {
          c.process(rb);
        }
      }
 else {
        RTimer subt=timer.sub("process");
        for (        SearchComponent c : components) {
          rb.setTimer(subt.sub(c.getName()));
          c.process(rb);
          rb.getTimer().stop();
        }
        subt.stop();
        if (rb.isDebugTimings()) {
          rb.addDebugInfo("timing",timer.asNamedList());
        }
      }
    }
 catch (    ExitableDirectoryReader.ExitingReaderException ex) {
      log.warn("Query: " + req.getParamString() + "; "+ ex.getMessage());
      SolrDocumentList r=(SolrDocumentList)rb.rsp.getValues().get("response");
      if (r == null)       r=new SolrDocumentList();
      r.setNumFound(0);
      rb.rsp.add("response",r);
      if (rb.isDebug()) {
        NamedList debug=new NamedList();
        debug.add("explain",new NamedList());
        rb.rsp.add("debug",debug);
      }
      rb.rsp.getResponseHeader().add("partialResults",Boolean.TRUE);
    }
 finally {
      SolrQueryTimeoutImpl.reset();
    }
  }
 else {
    if (rb.outgoing == null) {
      rb.outgoing=new LinkedList<>();
    }
    rb.finished=new ArrayList<>();
    int nextStage=0;
    do {
      rb.stage=nextStage;
      nextStage=ResponseBuilder.STAGE_DONE;
      for (      SearchComponent c : components) {
        nextStage=Math.min(nextStage,c.distributedProcess(rb));
      }
      while (rb.outgoing.size() > 0) {
        while (rb.outgoing.size() > 0) {
          ShardRequest sreq=rb.outgoing.remove(0);
          sreq.actualShards=sreq.shards;
          if (sreq.actualShards == ShardRequest.ALL_SHARDS) {
            sreq.actualShards=rb.shards;
          }
          sreq.responses=new ArrayList<>();
          for (          String shard : sreq.actualShards) {
            ModifiableSolrParams params=new ModifiableSolrParams(sreq.params);
            params.remove(ShardParams.SHARDS);
            params.set(CommonParams.DISTRIB,"false");
            params.remove("indent");
            params.remove(CommonParams.HEADER_ECHO_PARAMS);
            params.set(ShardParams.IS_SHARD,true);
            params.set(ShardParams.SHARDS_PURPOSE,sreq.purpose);
            params.set(ShardParams.SHARD_URL,shard);
            if (rb.requestInfo != null) {
              params.set("NOW",Long.toString(rb.requestInfo.getNOW().getTime()));
            }
            String shardQt=params.get(ShardParams.SHARDS_QT);
            if (shardQt != null) {
              params.set(CommonParams.QT,shardQt);
            }
 else {
              if (req.getCore().getSolrConfig().luceneMatchVersion.onOrAfter(Version.LUCENE_5_1_0)) {
                String reqPath=(String)req.getContext().get(PATH);
                if (!"/select".equals(reqPath)) {
                  params.set(CommonParams.QT,reqPath);
                }
              }
 else {
                params.remove(CommonParams.QT);
              }
            }
            shardHandler1.submit(sreq,shard,params);
          }
        }
        boolean tolerant=rb.req.getParams().getBool(ShardParams.SHARDS_TOLERANT,false);
        while (rb.outgoing.size() == 0) {
          ShardResponse srsp=tolerant ? shardHandler1.takeCompletedIncludingErrors() : shardHandler1.takeCompletedOrError();
          if (srsp == null)           break;
          if (srsp.getException() != null) {
            if (!tolerant) {
              shardHandler1.cancelAll();
              if (srsp.getException() instanceof SolrException) {
                throw (SolrException)srsp.getException();
              }
 else {
                throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,srsp.getException());
              }
            }
 else {
              if (rsp.getResponseHeader().get("partialResults") == null) {
                rsp.getResponseHeader().add("partialResults",Boolean.TRUE);
              }
            }
          }
          rb.finished.add(srsp.getShardRequest());
          for (          SearchComponent c : components) {
            c.handleResponses(rb,srsp.getShardRequest());
          }
        }
      }
      for (      SearchComponent c : components) {
        c.finishStage(rb);
      }
    }
 while (nextStage != Integer.MAX_VALUE);
  }
  if (!rb.isDistrib && req.getParams().getBool(ShardParams.SHARDS_INFO,false) && rb.shortCircuitedURL != null) {
    NamedList<Object> shardInfo=new SimpleOrderedMap<Object>();
    SimpleOrderedMap<Object> nl=new SimpleOrderedMap<Object>();
    if (rsp.getException() != null) {
      Throwable cause=rsp.getException();
      if (cause instanceof SolrServerException) {
        cause=((SolrServerException)cause).getRootCause();
      }
 else {
        if (cause.getCause() != null) {
          cause=cause.getCause();
        }
      }
      nl.add("error",cause.toString());
      StringWriter trace=new StringWriter();
      cause.printStackTrace(new PrintWriter(trace));
      nl.add("trace",trace.toString());
    }
 else {
      nl.add("numFound",rb.getResults().docList.matches());
      nl.add("maxScore",rb.getResults().docList.maxScore());
    }
    nl.add("shardAddress",rb.shortCircuitedURL);
    nl.add("time",req.getRequestTimer().getTime());
    int pos=rb.shortCircuitedURL.indexOf("://");
    String shardInfoName=pos != -1 ? rb.shortCircuitedURL.substring(pos + 3) : rb.shortCircuitedURL;
    shardInfo.add(shardInfoName,nl);
    rsp.getValues().add(ShardParams.SHARDS_INFO,shardInfo);
  }
}
