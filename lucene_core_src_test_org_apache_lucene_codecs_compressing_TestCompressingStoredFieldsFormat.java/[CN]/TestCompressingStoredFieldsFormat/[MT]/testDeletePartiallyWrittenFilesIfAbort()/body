{
  Directory dir=newDirectory();
  IndexWriterConfig iwConf=newIndexWriterConfig(new MockAnalyzer(random()));
  iwConf.setMaxBufferedDocs(RandomInts.randomIntBetween(random(),2,30));
  iwConf.setCodec(CompressingCodec.randomInstance(random()));
  iwConf.setMergePolicy(newLogMergePolicy(false));
  iwConf.setUseCompoundFile(false);
  IndexWriter iw=new IndexWriter(dir,iwConf);
  final Document validDoc=new Document();
  validDoc.add(new IntField("id",0,Store.YES));
  iw.addDocument(validDoc);
  iw.commit();
  final Document invalidDoc=new Document();
  FieldType fieldType=new FieldType();
  fieldType.setStored(true);
  invalidDoc.add(new Field("invalid",fieldType){
    @Override public String stringValue(){
      return null;
    }
  }
);
  try {
    iw.addDocument(invalidDoc);
    iw.commit();
  }
  finally {
    int counter=0;
    for (    String fileName : dir.listAll()) {
      if (fileName.endsWith(".fdt") || fileName.endsWith(".fdx")) {
        counter++;
      }
    }
    assertEquals(2,counter);
    iw.shutdown();
    dir.close();
  }
}
