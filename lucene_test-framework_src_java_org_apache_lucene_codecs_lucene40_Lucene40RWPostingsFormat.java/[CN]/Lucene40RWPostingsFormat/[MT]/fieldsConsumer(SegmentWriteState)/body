{
  if (!LuceneTestCase.OLD_FORMAT_IMPERSONATION_IS_ACTIVE) {
    return super.fieldsConsumer(state);
  }
 else {
    PostingsWriterBase docs=new Lucene40PostingsWriter(state);
    boolean success=false;
    try {
      FieldsConsumer ret=new BlockTreeTermsWriter(state,docs,minBlockSize,maxBlockSize);
      success=true;
      return ret;
    }
  finally {
      if (!success) {
        docs.close();
      }
    }
  }
}
