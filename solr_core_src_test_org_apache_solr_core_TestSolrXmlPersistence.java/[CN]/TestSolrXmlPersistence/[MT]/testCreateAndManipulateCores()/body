{
  CoreContainer cc=init(SOLR_XML_LOTS_SYSVARS,"SystemVars1","SystemVars2","new_one","new_two");
  try {
    final CoreAdminHandler admin=new CoreAdminHandler(cc);
    String instPathOne=new File(solrHomeDirectory,"new_one").getAbsolutePath();
    SolrQueryResponse resp=new SolrQueryResponse();
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.CREATE.toString(),CoreAdminParams.INSTANCE_DIR,instPathOne,CoreAdminParams.NAME,"new_one"),resp);
    assertNull("Exception on create",resp.getException());
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.CREATE.toString(),CoreAdminParams.NAME,"new_two"),resp);
    assertNull("Exception on create",resp.getException());
    File persistXml1=new File(solrHomeDirectory,"create_man_1.xml");
    origContainedInPersist(cc,persistXml1);
    String[] expressions=new String[2];
    String instHome=new File(solrHomeDirectory,"new_one").getAbsolutePath();
    expressions[0]="/solr/cores/core[@name='new_one' and @instanceDir='" + instHome + "']";
    expressions[1]="/solr/cores/core[@name='new_two' and @instanceDir='new_two" + File.separator + "']";
    assertXmlFile(persistXml1,expressions);
    resp=new SolrQueryResponse();
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.SWAP.toString(),CoreAdminParams.CORE,"new_one",CoreAdminParams.OTHER,"SystemVars2"),resp);
    assertNull("Exception on swap",resp.getException());
    File persistXml2=new File(solrHomeDirectory,"create_man_2.xml");
    cc.persistFile(persistXml2);
    String[] persistList=getAllNodes(persistXml2);
    expressions=new String[persistList.length];
    for (int idx=0; idx < persistList.length; ++idx) {
      String fromName="@name='new_one'";
      String toName="@name='SystemVars2'";
      if (persistList[idx].contains(fromName)) {
        expressions[idx]=persistList[idx].replace(fromName,toName);
      }
 else {
        expressions[idx]=persistList[idx].replace(toName,fromName);
      }
    }
    assertXmlFile(persistXml1,expressions);
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.RENAME.toString(),CoreAdminParams.CORE,"new_two",CoreAdminParams.OTHER,"RenamedCore"),resp);
    assertNull("Exception on rename",resp.getException());
    File persistXml3=new File(solrHomeDirectory,"create_man_3.xml");
    cc.persistFile(persistXml3);
    persistList=getAllNodes(persistXml3);
    expressions=new String[persistList.length];
    for (int idx=0; idx < persistList.length; ++idx) {
      expressions[idx]=persistList[idx].replaceAll("RenamedCore","new_two");
    }
    assertXmlFile(persistXml2,expressions);
    persistList=getAllNodes(persistXml2);
    expressions=new String[persistList.length];
    for (int idx=0; idx < persistList.length; ++idx) {
      expressions[idx]=persistList[idx].replace("@name='new_two'","@name='RenamedCore'");
    }
    assertXmlFile(persistXml3,expressions);
  }
  finally {
    cc.shutdown();
    if (solrHomeDirectory.exists()) {
      FileUtils.deleteDirectory(solrHomeDirectory);
    }
  }
}
