{
  if (!zkEnabled) {
    isLeader=getNonZkLeaderAssumption(req);
  }
 else {
    zkCheck();
  }
  DistribPhase phase=DistribPhase.parseParam(req.getParams().get(DISTRIB_UPDATE_PARAM));
  DocCollection coll=zkEnabled ? zkController.getClusterState().getCollection(collection) : null;
  if (zkEnabled && DistribPhase.NONE == phase) {
    boolean leaderForAnyShard=false;
    ModifiableSolrParams outParams=new ModifiableSolrParams(filterParams(req.getParams()));
    outParams.set(DISTRIB_UPDATE_PARAM,DistribPhase.TOLEADER.toString());
    outParams.set(DISTRIB_FROM,ZkCoreNodeProps.getCoreUrl(zkController.getBaseUrl(),req.getCore().getName()));
    SolrParams params=req.getParams();
    String route=params.get(ShardParams._ROUTE_);
    Collection<Slice> slices=coll.getRouter().getSearchSlices(route,params,coll);
    List<Node> leaders=new ArrayList<>(slices.size());
    for (    Slice slice : slices) {
      String sliceName=slice.getName();
      Replica leader;
      try {
        leader=zkController.getZkStateReader().getLeaderRetry(collection,sliceName);
      }
 catch (      InterruptedException e) {
        throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"Exception finding leader for shard " + sliceName,e);
      }
      ZkCoreNodeProps coreLeaderProps=new ZkCoreNodeProps(leader);
      String leaderCoreNodeName=leader.getName();
      String coreNodeName=req.getCore().getCoreDescriptor().getCloudDescriptor().getCoreNodeName();
      isLeader=coreNodeName.equals(leaderCoreNodeName);
      if (isLeader) {
        leaderForAnyShard=true;
      }
 else {
        leaders.add(new RetryNode(coreLeaderProps,zkController.getZkStateReader(),collection,sliceName));
      }
    }
    outParams.remove("commit");
    cmdDistrib.distribDelete(cmd,leaders,outParams);
    if (!leaderForAnyShard) {
      return;
    }
    phase=DistribPhase.TOLEADER;
  }
  List<Node> replicas=null;
  if (zkEnabled && DistribPhase.TOLEADER == phase) {
    isLeader=true;
    replicas=setupRequest();
  }
 else   if (DistribPhase.FROMLEADER == phase) {
    isLeader=false;
  }
  if (vinfo == null) {
    super.processDelete(cmd);
    return;
  }
  boolean isReplayOrPeersync=(cmd.getFlags() & (UpdateCommand.REPLAY | UpdateCommand.PEER_SYNC)) != 0;
  boolean leaderLogic=isLeader && !isReplayOrPeersync;
  versionDeleteByQuery(cmd);
  if (zkEnabled) {
    ModifiableSolrParams params=new ModifiableSolrParams(filterParams(req.getParams()));
    params.set(VERSION_FIELD,Long.toString(cmd.getVersion()));
    params.set(DISTRIB_UPDATE_PARAM,DistribPhase.FROMLEADER.toString());
    params.set(DISTRIB_FROM,ZkCoreNodeProps.getCoreUrl(zkController.getBaseUrl(),req.getCore().getName()));
    boolean someReplicas=false;
    boolean subShardLeader=false;
    try {
      subShardLeader=amISubShardLeader(coll,null,null,null);
      if (subShardLeader) {
        String myShardId=req.getCore().getCoreDescriptor().getCloudDescriptor().getShardId();
        Replica leaderReplica=zkController.getZkStateReader().getLeaderRetry(collection,myShardId);
        List<ZkCoreNodeProps> replicaProps=zkController.getZkStateReader().getReplicaProps(collection,myShardId,leaderReplica.getName(),null,Replica.State.DOWN);
        if (replicaProps != null) {
          final List<Node> myReplicas=new ArrayList<>(replicaProps.size());
          for (          ZkCoreNodeProps replicaProp : replicaProps) {
            myReplicas.add(new StdNode(replicaProp,collection,myShardId));
          }
          cmdDistrib.distribDelete(cmd,myReplicas,params);
          someReplicas=true;
        }
      }
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      throw new ZooKeeperException(ErrorCode.SERVER_ERROR,"",e);
    }
    if (leaderLogic) {
      List<Node> subShardLeaders=getSubShardLeaders(coll,cloudDesc.getShardId(),null,null);
      if (subShardLeaders != null) {
        cmdDistrib.distribDelete(cmd,subShardLeaders,params,true);
      }
      final List<Node> nodesByRoutingRules=getNodesByRoutingRules(zkController.getClusterState(),coll,null,null);
      if (nodesByRoutingRules != null && !nodesByRoutingRules.isEmpty()) {
        params=new ModifiableSolrParams(filterParams(req.getParams()));
        params.set(DISTRIB_UPDATE_PARAM,DistribPhase.FROMLEADER.toString());
        params.set(DISTRIB_FROM,ZkCoreNodeProps.getCoreUrl(zkController.getBaseUrl(),req.getCore().getName()));
        params.set(DISTRIB_FROM_COLLECTION,req.getCore().getCoreDescriptor().getCloudDescriptor().getCollectionName());
        params.set(DISTRIB_FROM_SHARD,req.getCore().getCoreDescriptor().getCloudDescriptor().getShardId());
        cmdDistrib.distribDelete(cmd,nodesByRoutingRules,params,true);
      }
      if (replicas != null) {
        cmdDistrib.distribDelete(cmd,replicas,params);
        someReplicas=true;
      }
    }
    if (someReplicas) {
      cmdDistrib.blockAndDoRetries();
    }
  }
  if (returnVersions && rsp != null) {
    if (deleteByQueryResponse == null) {
      deleteByQueryResponse=new NamedList<String>(1);
      rsp.add("deleteByQuery",deleteByQueryResponse);
    }
    deleteByQueryResponse.add(cmd.getQuery(),cmd.getVersion());
  }
}
