{
  int hash=0;
  if (zkEnabled) {
    zkCheck();
    hash=hash(cmd);
    nodes=setupRequest(hash);
  }
 else {
    isLeader=getNonZkLeaderAssumption(req);
  }
  boolean dropCmd=false;
  if (!forwardToLeader) {
    SolrInputDocument clonedDoc=cmd.solrDoc.deepCopy();
    dropCmd=versionAdd(cmd,clonedDoc);
    cmd.solrDoc=clonedDoc;
  }
  if (dropCmd) {
    return;
  }
  ModifiableSolrParams params=null;
  if (nodes != null) {
    params=new ModifiableSolrParams(req.getParams());
    params.set(DISTRIB_UPDATE_PARAM,(isLeader ? DistribPhase.FROMLEADER.toString() : DistribPhase.TOLEADER.toString()));
    if (isLeader) {
      params.set("distrib.from",ZkCoreNodeProps.getCoreUrl(zkController.getBaseUrl(),req.getCore().getName()));
    }
    params.remove("commit");
    params.set("distrib.from",ZkCoreNodeProps.getCoreUrl(zkController.getBaseUrl(),req.getCore().getName()));
    cmdDistrib.distribAdd(cmd,nodes,params);
  }
  if (returnVersions && rsp != null && idField != null) {
    if (addsResponse == null) {
      addsResponse=new NamedList<String>();
      rsp.add("adds",addsResponse);
    }
    if (scratch == null)     scratch=new CharsRef();
    idField.getType().indexedToReadable(cmd.getIndexedId(),scratch);
    addsResponse.add(scratch.toString(),cmd.getVersion());
  }
}
