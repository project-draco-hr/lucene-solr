{
  String from=req.getParams().get("distrib.from");
  boolean logReplay=req.getParams().getBool(LOG_REPLAY,false);
  boolean localIsLeader=req.getCore().getCoreDescriptor().getCloudDescriptor().isLeader();
  if (!logReplay && DistribPhase.FROMLEADER == phase && localIsLeader && from != null) {
    log.error("Request says it is coming from leader, but we are the leader: " + req.getParamString());
    throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"Request says it is coming from leader, but we are the leader");
  }
  if (isLeader && !localIsLeader) {
    log.error("ClusterState says we are the leader, but locally we don't think so");
    throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"ClusterState says we are the leader, but locally we don't think so");
  }
}
