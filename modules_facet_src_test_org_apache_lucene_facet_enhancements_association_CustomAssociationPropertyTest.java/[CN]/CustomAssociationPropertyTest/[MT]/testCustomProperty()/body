{
class CustomProperty extends AssociationIntProperty {
    public CustomProperty(    int value){
      super(value);
    }
    @Override public void merge(    CategoryProperty other){
      throw new UnsupportedOperationException();
    }
  }
  final int NUM_CATEGORIES=10;
  EnhancementsIndexingParams iParams=new DefaultEnhancementsIndexingParams(new AssociationEnhancement());
  Directory iDir=newDirectory();
  Directory tDir=newDirectory();
  RandomIndexWriter w=new RandomIndexWriter(random,iDir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random,MockTokenizer.KEYWORD,false)));
  DirectoryTaxonomyWriter taxoW=new DirectoryTaxonomyWriter(tDir);
  CategoryContainer cc=new CategoryContainer();
  EnhancementsDocumentBuilder builder=new EnhancementsDocumentBuilder(taxoW,iParams);
  for (int i=1; i <= NUM_CATEGORIES; i++) {
    CategoryAttributeImpl ca=new CategoryAttributeImpl(new CategoryPath(Integer.toString(i)));
    ca.addProperty(new CustomProperty(i));
    cc.addCategory(ca);
  }
  builder.setCategories(cc);
  w.addDocument(builder.build(new Document()));
  taxoW.close();
  IndexReader reader=w.getReader();
  w.close();
  DirectoryTaxonomyReader taxo=new DirectoryTaxonomyReader(tDir);
  String field=iParams.getCategoryListParams(new CategoryPath("0")).getTerm().field();
  AssociationsPayloadIterator api=new AssociationsPayloadIterator(reader,field);
  api.setNextDoc(0);
  boolean flag=false;
  for (int i=1; i <= NUM_CATEGORIES; i++) {
    int ordinal=taxo.getOrdinal(new CategoryPath(Integer.toString(i)));
    flag=true;
    long association=api.getAssociation(ordinal);
    assertTrue("Association expected for ordinal " + ordinal + " but none was found",association <= Integer.MAX_VALUE);
    assertEquals("Wrong association value for category '" + i + "'",i,(int)association);
  }
  assertTrue("No categories found for doc #0",flag);
  reader.close();
  taxo.close();
  iDir.close();
  tDir.close();
}
