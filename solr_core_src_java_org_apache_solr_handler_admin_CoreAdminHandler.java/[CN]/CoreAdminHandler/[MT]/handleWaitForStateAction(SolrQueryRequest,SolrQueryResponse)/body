{
  final SolrParams params=req.getParams();
  String cname=params.get(CoreAdminParams.CORE);
  if (cname == null) {
    cname="";
  }
  String nodeName=params.get("nodeName");
  String coreNodeName=params.get("coreNodeName");
  String waitForState=params.get("state");
  Boolean checkLive=params.getBool("checkLive");
  Boolean onlyIfLeader=params.getBool("onlyIfLeader");
  String state=null;
  boolean live=false;
  int retry=0;
  while (true) {
    SolrCore core=null;
    try {
      core=coreContainer.getCore(cname);
      if (core == null && retry == 30) {
        throw new SolrException(ErrorCode.BAD_REQUEST,"core not found:" + cname);
      }
      if (core != null) {
        if (onlyIfLeader != null && onlyIfLeader) {
          if (!core.getCoreDescriptor().getCloudDescriptor().isLeader()) {
            throw new SolrException(ErrorCode.BAD_REQUEST,"We are not the leader");
          }
        }
        CloudDescriptor cloudDescriptor=core.getCoreDescriptor().getCloudDescriptor();
        if (retry == 15 || retry == 60) {
          coreContainer.getZkController().getZkStateReader().updateClusterState(true);
        }
        ClusterState clusterState=coreContainer.getZkController().getClusterState();
        String collection=cloudDescriptor.getCollectionName();
        Slice slice=clusterState.getSlice(collection,cloudDescriptor.getShardId());
        if (slice != null) {
          ZkNodeProps nodeProps=slice.getReplicasMap().get(coreNodeName);
          if (nodeProps != null) {
            state=nodeProps.getStr(ZkStateReader.STATE_PROP);
            live=clusterState.liveNodesContain(nodeName);
            if (nodeProps != null && state.equals(waitForState)) {
              if (checkLive == null) {
                break;
              }
 else               if (checkLive && live) {
                break;
              }
 else               if (!checkLive && !live) {
                break;
              }
            }
          }
        }
      }
      if (retry++ == 120) {
        throw new SolrException(ErrorCode.BAD_REQUEST,"I was asked to wait on state " + waitForState + " for "+ nodeName+ " but I still do not see the requested state. I see state: "+ state+ " live:"+ live);
      }
      if (coreContainer.isShutDown()) {
        throw new SolrException(ErrorCode.BAD_REQUEST,"Solr is shutting down");
      }
    }
  finally {
      if (core != null) {
        core.close();
      }
    }
    Thread.sleep(1000);
  }
}
