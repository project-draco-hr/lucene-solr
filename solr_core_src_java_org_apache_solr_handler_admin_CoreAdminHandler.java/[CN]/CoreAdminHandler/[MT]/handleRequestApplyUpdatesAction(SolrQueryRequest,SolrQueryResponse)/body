{
  SolrParams params=req.getParams();
  String cname=params.get(CoreAdminParams.NAME,"");
  log.info("Applying buffered updates on core: " + cname);
  try (SolrCore core=coreContainer.getCore(cname)){
    if (core == null)     throw new SolrException(ErrorCode.BAD_REQUEST,"Core [" + cname + "] not found");
    UpdateLog updateLog=core.getUpdateHandler().getUpdateLog();
    if (updateLog.getState() != UpdateLog.State.BUFFERING) {
      throw new SolrException(ErrorCode.SERVER_ERROR,"Core " + cname + " not in buffering state");
    }
    Future<UpdateLog.RecoveryInfo> future=updateLog.applyBufferedUpdates();
    if (future == null) {
      log.info("No buffered updates available. core=" + cname);
      rsp.add("core",cname);
      rsp.add("status","EMPTY_BUFFER");
      return;
    }
    UpdateLog.RecoveryInfo report=future.get();
    if (report.failed) {
      SolrException.log(log,"Replay failed");
      throw new SolrException(ErrorCode.SERVER_ERROR,"Replay failed");
    }
    coreContainer.getZkController().publish(core.getCoreDescriptor(),Replica.State.ACTIVE);
    rsp.add("core",cname);
    rsp.add("status","BUFFER_APPLIED");
  }
 catch (  InterruptedException e) {
    Thread.currentThread().interrupt();
    log.warn("Recovery was interrupted",e);
  }
catch (  Exception e) {
    if (e instanceof SolrException)     throw (SolrException)e;
 else     throw new SolrException(ErrorCode.SERVER_ERROR,"Could not apply buffered updates",e);
  }
 finally {
    if (req != null)     req.close();
  }
}
