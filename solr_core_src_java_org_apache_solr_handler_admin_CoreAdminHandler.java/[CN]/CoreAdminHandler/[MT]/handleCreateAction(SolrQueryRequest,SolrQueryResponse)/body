{
  SolrParams params=req.getParams();
  String name=params.get(CoreAdminParams.NAME);
  if (null == name || "".equals(name)) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Core name is mandatory to CREATE a SolrCore");
  }
  try {
    if (coreContainer.getZkController() != null) {
      if (coreContainer.getCore(name) != null) {
        log.info("Re-creating a core with existing name is not allowed in cloud mode");
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Core with name '" + name + "' already exists.");
      }
    }
    String instanceDir=params.get(CoreAdminParams.INSTANCE_DIR);
    if (instanceDir == null) {
      instanceDir=name;
    }
    CoreDescriptor dcore=new CoreDescriptor(coreContainer,name,instanceDir);
    String opts=params.get(CoreAdminParams.CONFIG);
    if (opts != null)     dcore.setConfigName(opts);
    opts=params.get(CoreAdminParams.SCHEMA);
    if (opts != null)     dcore.setSchemaName(opts);
    opts=params.get(CoreAdminParams.DATA_DIR);
    if (opts != null)     dcore.setDataDir(opts);
    opts=params.get(CoreAdminParams.ULOG_DIR);
    if (opts != null)     dcore.setUlogDir(opts);
    CloudDescriptor cd=dcore.getCloudDescriptor();
    if (cd != null) {
      cd.setParams(req.getParams());
      opts=params.get(CoreAdminParams.COLLECTION);
      if (opts != null)       cd.setCollectionName(opts);
      opts=params.get(CoreAdminParams.SHARD);
      if (opts != null)       cd.setShardId(opts);
      opts=params.get(CoreAdminParams.ROLES);
      if (opts != null)       cd.setRoles(opts);
      Integer numShards=params.getInt(ZkStateReader.NUM_SHARDS_PROP);
      if (numShards != null)       cd.setNumShards(numShards);
    }
    Properties coreProperties=new Properties();
    Iterator<String> parameterNamesIterator=params.getParameterNamesIterator();
    while (parameterNamesIterator.hasNext()) {
      String parameterName=parameterNamesIterator.next();
      if (parameterName.startsWith(CoreAdminParams.PROPERTY_PREFIX)) {
        String parameterValue=params.get(parameterName);
        String propertyName=parameterName.substring(CoreAdminParams.PROPERTY_PREFIX.length());
        coreProperties.put(propertyName,parameterValue);
      }
    }
    dcore.setCoreProperties(coreProperties);
    SolrCore core=coreContainer.create(dcore);
    coreContainer.register(name,core,false);
    rsp.add("core",core.getName());
    return coreContainer.isPersistent();
  }
 catch (  Exception ex) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Error CREATEing SolrCore '" + name + "': "+ ex.getMessage(),ex);
  }
}
