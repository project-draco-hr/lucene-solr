{
  SolrParams params=req.getParams();
  String name=params.get(CoreAdminParams.NAME);
  if (null == name || "".equals(name)) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Core name is mandatory to CREATE a SolrCore");
  }
  try {
    if (coreContainer.getAllCoreNames().contains(name)) {
      log.warn("Re-creating a core with existing name is not allowed");
      throw new SolrException(ErrorCode.SERVER_ERROR,"Core with name '" + name + "' already exists.");
    }
    String instanceDir=params.get(CoreAdminParams.INSTANCE_DIR);
    if (instanceDir == null) {
      instanceDir=name;
    }
    CoreDescriptor dcore=new CoreDescriptor(coreContainer,name,instanceDir);
    String opts=params.get(CoreAdminParams.CONFIG);
    if (opts != null)     dcore.setConfigName(opts);
    opts=params.get(CoreAdminParams.SCHEMA);
    if (opts != null)     dcore.setSchemaName(opts);
    opts=params.get(CoreAdminParams.DATA_DIR);
    if (opts != null)     dcore.setDataDir(opts);
    opts=params.get(CoreAdminParams.ULOG_DIR);
    if (opts != null)     dcore.setUlogDir(opts);
    opts=params.get(CoreAdminParams.LOAD_ON_STARTUP);
    if (opts != null) {
      Boolean value=Boolean.valueOf(opts);
      dcore.setLoadOnStartup(value);
    }
    opts=params.get(CoreAdminParams.TRANSIENT);
    if (opts != null) {
      Boolean value=Boolean.valueOf(opts);
      dcore.setTransient(value);
    }
    CloudDescriptor cd=dcore.getCloudDescriptor();
    if (cd != null) {
      cd.setParams(req.getParams());
      opts=params.get(CoreAdminParams.COLLECTION);
      if (opts != null)       cd.setCollectionName(opts);
      opts=params.get(CoreAdminParams.SHARD);
      if (opts != null)       cd.setShardId(opts);
      opts=params.get(CoreAdminParams.SHARD_RANGE);
      if (opts != null)       cd.setShardRange(opts);
      opts=params.get(CoreAdminParams.SHARD_STATE);
      if (opts != null)       cd.setShardState(opts);
      opts=params.get(CoreAdminParams.ROLES);
      if (opts != null)       cd.setRoles(opts);
      opts=params.get(CoreAdminParams.CORE_NODE_NAME);
      if (opts != null)       cd.setCoreNodeName(opts);
      Integer numShards=params.getInt(ZkStateReader.NUM_SHARDS_PROP);
      if (numShards != null)       cd.setNumShards(numShards);
    }
    Properties coreProperties=new Properties();
    Iterator<String> parameterNamesIterator=params.getParameterNamesIterator();
    while (parameterNamesIterator.hasNext()) {
      String parameterName=parameterNamesIterator.next();
      if (parameterName.startsWith(CoreAdminParams.PROPERTY_PREFIX)) {
        String parameterValue=params.get(parameterName);
        String propertyName=parameterName.substring(CoreAdminParams.PROPERTY_PREFIX.length());
        coreProperties.put(propertyName,parameterValue);
      }
    }
    dcore.setCoreProperties(coreProperties);
    SolrCore core=coreContainer.create(dcore);
    String sameDirCore=coreContainer.checkUniqueDataDir(core.getDataDir());
    if (sameDirCore != null) {
      if (core != null)       core.close();
      log.warn("Creating a core that points to the same data dir as core {} is not allowed",sameDirCore);
      throw new SolrException(ErrorCode.SERVER_ERROR,"Core with same data dir '" + sameDirCore + "' already exists.");
    }
    coreContainer.register(name,core,false);
    rsp.add("core",core.getName());
    return coreContainer.isPersistent();
  }
 catch (  Exception ex) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Error CREATEing SolrCore '" + name + "': "+ ex.getMessage(),ex);
  }
}
