{
  SolrParams params=req.getParams();
  String name=params.get(CoreAdminParams.NAME);
  if (null == name || "".equals(name)) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Core name is mandatory to CREATE a SolrCore");
  }
  CoreDescriptor dcore=null;
  try {
    if (coreContainer.getAllCoreNames().contains(name)) {
      log.warn("Creating a core with existing name is not allowed");
      throw new SolrException(ErrorCode.SERVER_ERROR,"Core with name '" + name + "' already exists.");
    }
    String instanceDir=params.get(CoreAdminParams.INSTANCE_DIR);
    if (instanceDir == null) {
      instanceDir=name;
    }
    dcore=new CoreDescriptor(coreContainer,name,instanceDir);
    String opts=params.get(CoreAdminParams.CONFIG);
    if (opts != null)     dcore.setConfigName(opts);
    opts=params.get(CoreAdminParams.SCHEMA);
    if (opts != null)     dcore.setSchemaName(opts);
    opts=params.get(CoreAdminParams.DATA_DIR);
    if (opts != null)     dcore.setDataDir(opts);
    opts=params.get(CoreAdminParams.ULOG_DIR);
    if (opts != null)     dcore.setUlogDir(opts);
    opts=params.get(CoreAdminParams.LOAD_ON_STARTUP);
    if (opts != null) {
      Boolean value=Boolean.valueOf(opts);
      dcore.setLoadOnStartup(value);
    }
    opts=params.get(CoreAdminParams.TRANSIENT);
    if (opts != null) {
      Boolean value=Boolean.valueOf(opts);
      dcore.setTransient(value);
    }
    CloudDescriptor cd=dcore.getCloudDescriptor();
    if (cd != null) {
      cd.setParams(req.getParams());
      opts=params.get(CoreAdminParams.COLLECTION);
      if (opts != null)       cd.setCollectionName(opts);
      opts=params.get(CoreAdminParams.SHARD);
      if (opts != null)       cd.setShardId(opts);
      opts=params.get(CoreAdminParams.SHARD_RANGE);
      if (opts != null)       cd.setShardRange(opts);
      opts=params.get(CoreAdminParams.SHARD_STATE);
      if (opts != null)       cd.setShardState(opts);
      opts=params.get(CoreAdminParams.ROLES);
      if (opts != null)       cd.setRoles(opts);
      opts=params.get(CoreAdminParams.CORE_NODE_NAME);
      if (opts != null)       cd.setCoreNodeName(opts);
      Integer numShards=params.getInt(ZkStateReader.NUM_SHARDS_PROP);
      if (numShards != null)       cd.setNumShards(numShards);
    }
    Properties coreProperties=new Properties();
    Iterator<String> parameterNamesIterator=params.getParameterNamesIterator();
    while (parameterNamesIterator.hasNext()) {
      String parameterName=parameterNamesIterator.next();
      if (parameterName.startsWith(CoreAdminParams.PROPERTY_PREFIX)) {
        String parameterValue=params.get(parameterName);
        String propertyName=parameterName.substring(CoreAdminParams.PROPERTY_PREFIX.length());
        coreProperties.put(propertyName,parameterValue);
      }
    }
    dcore.setCoreProperties(coreProperties);
    if (coreContainer.getZkController() != null) {
      coreContainer.preRegisterInZk(dcore);
    }
    SolrCore core=coreContainer.create(dcore);
    coreContainer.register(name,core,false);
    rsp.add("core",core.getName());
    return coreContainer.isPersistent();
  }
 catch (  Exception ex) {
    if (coreContainer.isZooKeeperAware() && dcore != null) {
      try {
        coreContainer.getZkController().unregister(name,dcore);
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        SolrException.log(log,null,e);
      }
catch (      KeeperException e) {
        SolrException.log(log,null,e);
      }
    }
    Throwable tc=ex;
    Throwable c=null;
    do {
      tc=tc.getCause();
      if (tc != null) {
        c=tc;
      }
    }
 while (tc != null);
    String rootMsg="";
    if (c != null) {
      rootMsg=" Caused by: " + c.getMessage();
    }
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Error CREATEing SolrCore '" + name + "': "+ ex.getMessage()+ rootMsg,ex);
  }
}
