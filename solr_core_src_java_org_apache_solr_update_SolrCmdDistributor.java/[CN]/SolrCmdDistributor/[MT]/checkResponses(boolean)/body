{
  while (pending != null && pending.size() > 0) {
    try {
      Future<Request> future=block ? completionService.take() : completionService.poll();
      if (future == null)       return;
      pending.remove(future);
      try {
        Request sreq=future.get();
        if (sreq.rspCode != 0) {
          boolean isRetry=sreq.node.checkRetry();
          boolean doRetry=false;
          int rspCode=sreq.rspCode;
          if (isRetry && (rspCode == 404 || rspCode == 403 || rspCode == 503 || rspCode == 500)) {
            doRetry=true;
          }
          if (isRetry && sreq.exception instanceof IOException) {
            doRetry=true;
          }
          if (isRetry && sreq.retries < MAX_RETRIES_ON_FORWARD && doRetry) {
            sreq.retries++;
            sreq.rspCode=0;
            sreq.exception=null;
            SolrException.log(SolrCmdDistributor.log,"forwarding update to " + sreq.node.getUrl() + " failed - retrying ... ",null);
            Thread.sleep(500);
            submit(sreq);
            checkResponses(block);
          }
 else {
            Exception e=sreq.exception;
            Error error=new Error();
            error.e=e;
            error.node=sreq.node;
            response.errors.add(error);
            response.sreq=sreq;
            SolrException.log(SolrCmdDistributor.log,"shard update error " + sreq.node,sreq.exception);
          }
        }
      }
 catch (      ExecutionException e) {
        SolrException.log(SolrCore.log,"error sending update request to shard",e);
      }
    }
 catch (    InterruptedException e) {
      throw new SolrException(SolrException.ErrorCode.SERVICE_UNAVAILABLE,"interrupted waiting for shard update response",e);
    }
  }
}
