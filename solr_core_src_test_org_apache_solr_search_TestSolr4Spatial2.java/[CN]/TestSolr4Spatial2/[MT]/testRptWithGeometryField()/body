{
  String fieldName="srptgeom";
  assertU(adoc("id","0",fieldName,"ENVELOPE(-10, 20, 15, 10)"));
  assertU(adoc("id","1",fieldName,"BUFFER(POINT(-10 15), 5)"));
  assertU(optimize());
  assertU(commit());
  final SolrQueryRequest sameReq=req("q","{!cache=false field f=" + fieldName + "}Intersects(ENVELOPE(-20, -10.0001, 30, 15.0001))","sort","id asc");
  assertJQ(sameReq,"/response/numFound==1","/response/docs/[0]/id=='1'");
  SolrCache cache=(SolrCache)h.getCore().getInfoRegistry().get("perSegSpatialFieldCache_srptgeom");
  assertEquals("1",cache.getStatistics().get("cumulative_inserts").toString());
  assertEquals("0",cache.getStatistics().get("cumulative_hits").toString());
  assertJQ(sameReq,"/response/numFound==1","/response/docs/[0]/id=='1'");
  assertEquals("1",cache.getStatistics().get("cumulative_hits").toString());
  assertEquals("1 segment",1,getSearcher().getRawReader().leaves().size());
  Object leafKey1=getFirstLeafReaderKey();
  assertU(adoc("id","3"));
  assertU(commit());
  assertJQ(sameReq,"/response/numFound==1","/response/docs/[0]/id=='1'");
  Object leafKey2=getFirstLeafReaderKey();
  assertEquals(leafKey1.equals(leafKey2) ? "2" : "1",cache.getStatistics().get("cumulative_hits").toString());
  assertJQ(req("q","*:*","facet","true",FacetParams.FACET_HEATMAP,fieldName,"json.nl","map"),"/facet_counts/facet_heatmaps/" + fieldName + "/minX==-180.0");
}
