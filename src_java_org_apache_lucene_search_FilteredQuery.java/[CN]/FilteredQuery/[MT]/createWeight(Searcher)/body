{
  final Weight weight=query.createWeight(searcher);
  final Similarity similarity=query.getSimilarity(searcher);
  return new Weight(){
    private float value;
    public float getValue(){
      return value;
    }
    public float sumOfSquaredWeights() throws IOException {
      return weight.sumOfSquaredWeights() * getBoost() * getBoost();
    }
    public void normalize(    float v){
      weight.normalize(v);
      value=weight.getValue() * getBoost();
    }
    public Explanation explain(    IndexReader ir,    int i) throws IOException {
      Explanation inner=weight.explain(ir,i);
      inner.setValue(getBoost() * inner.getValue());
      Filter f=FilteredQuery.this.filter;
      BitSet matches=f.bits(ir);
      if (matches.get(i))       return inner;
      Explanation result=new Explanation(0.0f,"failure to match filter: " + f.toString());
      result.addDetail(inner);
      return result;
    }
    public Query getQuery(){
      return FilteredQuery.this;
    }
    public Scorer scorer(    IndexReader indexReader) throws IOException {
      final Scorer scorer=weight.scorer(indexReader);
      final BitSet bitset=filter.bits(indexReader);
      return new Scorer(similarity){
        public boolean next() throws IOException {
          do {
            if (!scorer.next()) {
              return false;
            }
          }
 while (!bitset.get(scorer.doc()));
          return true;
        }
        public int doc(){
          return scorer.doc();
        }
        public boolean skipTo(        int i) throws IOException {
          if (!scorer.skipTo(i)) {
            return false;
          }
          while (!bitset.get(scorer.doc())) {
            int nextFiltered=bitset.nextSetBit(scorer.doc() + 1);
            if (nextFiltered == -1) {
              return false;
            }
 else             if (!scorer.skipTo(nextFiltered)) {
              return false;
            }
          }
          return true;
        }
        public float score() throws IOException {
          return getBoost() * scorer.score();
        }
        public Explanation explain(        int i) throws IOException {
          Explanation exp=scorer.explain(i);
          exp.setValue(getBoost() * exp.getValue());
          if (bitset.get(i))           exp.setDescription("allowed by filter: " + exp.getDescription());
 else           exp.setDescription("removed by filter: " + exp.getDescription());
          return exp;
        }
      }
;
    }
  }
;
}
