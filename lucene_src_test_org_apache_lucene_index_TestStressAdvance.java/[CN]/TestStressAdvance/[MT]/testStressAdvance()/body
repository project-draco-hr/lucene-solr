{
  for (int iter=0; iter < 3; iter++) {
    if (VERBOSE) {
      System.out.println("\nTEST: iter=" + iter);
    }
    Directory dir=newDirectory();
    RandomIndexWriter w=new RandomIndexWriter(random,dir);
    final Set<Integer> aDocs=new HashSet<Integer>();
    final Document doc=new Document();
    final Field f=newField("field","",Field.Index.NOT_ANALYZED_NO_NORMS);
    doc.add(f);
    final Field idField=newField("id","",Field.Store.YES,Field.Index.NOT_ANALYZED_NO_NORMS);
    doc.add(idField);
    int num=atLeast(5000);
    for (int id=0; id < num; id++) {
      if (random.nextInt(4) == 3) {
        f.setValue("a");
        aDocs.add(id);
      }
 else {
        f.setValue("b");
      }
      idField.setValue("" + id);
      w.addDocument(doc);
    }
    w.optimize();
    final List<Integer> aDocIDs=new ArrayList<Integer>();
    final List<Integer> bDocIDs=new ArrayList<Integer>();
    final IndexReader r=w.getReader();
    final int[] idToDocID=new int[r.maxDoc()];
    for (int docID=0; docID < idToDocID.length; docID++) {
      int id=Integer.parseInt(r.document(docID).get("id"));
      if (aDocs.contains(id)) {
        aDocIDs.add(docID);
      }
 else {
        bDocIDs.add(docID);
      }
    }
    final TermsEnum te=r.getSequentialSubReaders()[0].fields().terms("field").iterator();
    DocsEnum de=null;
    for (int iter2=0; iter2 < 10; iter2++) {
      if (VERBOSE) {
        System.out.println("\nTEST: iter=" + iter + " iter2="+ iter2);
      }
      assertEquals(TermsEnum.SeekStatus.FOUND,te.seekCeil(new BytesRef("a")));
      de=te.docs(null,de);
      testOne(de,aDocIDs);
      assertEquals(TermsEnum.SeekStatus.FOUND,te.seekCeil(new BytesRef("b")));
      de=te.docs(null,de);
      testOne(de,bDocIDs);
    }
    w.close();
    r.close();
    dir.close();
  }
}
