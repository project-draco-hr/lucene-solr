{
  byte[] normBuffer=null;
  for (int i=0; i < fieldInfos.size(); i++) {
    FieldInfo fi=fieldInfos.fieldInfo(i);
    if (fi.isIndexed && !fi.omitNorms) {
      IndexOutput output=directory.createOutput(segment + ".f" + i);
      try {
        for (int j=0; j < readers.size(); j++) {
          IndexReader reader=(IndexReader)readers.elementAt(j);
          int maxDoc=reader.maxDoc();
          if (normBuffer == null || normBuffer.length < maxDoc) {
            normBuffer=new byte[maxDoc];
          }
          reader.norms(fi.name,normBuffer,0);
          if (!reader.hasDeletions()) {
            output.writeBytes(normBuffer,maxDoc);
          }
 else {
            for (int k=0; k < maxDoc; k++) {
              if (!reader.isDeleted(k)) {
                output.writeByte(normBuffer[k]);
              }
            }
          }
        }
      }
  finally {
        output.close();
      }
    }
  }
}
