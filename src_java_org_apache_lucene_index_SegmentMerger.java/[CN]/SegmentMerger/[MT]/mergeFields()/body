{
  fieldInfos=new FieldInfos();
  for (int i=0; i < readers.size(); i++) {
    SegmentReader reader=(SegmentReader)readers.elementAt(i);
    fieldInfos.add(reader.fieldInfos);
  }
  fieldInfos.write(directory,segment + ".fnm");
  FieldsWriter fieldsWriter=new FieldsWriter(directory,segment,fieldInfos);
  try {
    for (int i=0; i < readers.size(); i++) {
      SegmentReader reader=(SegmentReader)readers.elementAt(i);
      BitVector deletedDocs=reader.deletedDocs;
      int maxDoc=reader.maxDoc();
      for (int j=0; j < maxDoc; j++)       if (deletedDocs == null || !deletedDocs.get(j))       fieldsWriter.addDocument(reader.document(j));
    }
  }
  finally {
    fieldsWriter.close();
  }
}
