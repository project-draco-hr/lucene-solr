{
  long timeout=System.nanoTime() + TimeUnit.NANOSECONDS.convert(timeoutInMs,TimeUnit.MILLISECONDS);
  while (System.nanoTime() < timeout) {
    log.debug("waiting to see replica just created live collection={} replica={} baseUrl={}",collection,coreNodeName,baseUrl);
    ClusterState clusterState=zkStateReader.getClusterState();
    if (clusterState != null) {
      DocCollection docCollection=clusterState.getCollection(collection);
      Collection<Slice> slices=docCollection.getSlices();
      for (      Slice slice : slices) {
        if (slice.getState().equals(Slice.ACTIVE)) {
          Collection<Replica> replicas=slice.getReplicas();
          for (          Replica replica : replicas) {
            boolean live=clusterState.liveNodesContain(replica.getNodeName());
            String rcoreNodeName=replica.getName();
            String rbaseUrl=replica.getStr(ZkStateReader.BASE_URL_PROP);
            if (live && coreNodeName.equals(rcoreNodeName) && baseUrl.equals(rbaseUrl)) {
              return true;
            }
          }
        }
      }
      try {
        Thread.sleep(TIMEOUT_POLL_MS);
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        throw new SolrException(ErrorCode.SERVER_ERROR,"Interrupted");
      }
    }
  }
  log.error("Timed out waiting to see replica just created in cluster state. Continuing...");
  return false;
}
