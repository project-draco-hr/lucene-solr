{
  int[][][] dpf=new int[reader.maxDoc()][][];
  int numPartitions=(int)Math.ceil(taxo.getSize() / (double)iparams.getPartitionSize());
  IntsRef ordinals=new IntsRef(32);
  for (int part=0; part < numPartitions; part++) {
    for (    AtomicReaderContext context : reader.leaves()) {
      CategoryListIterator cli=clp.createCategoryListIterator(part);
      if (cli.setNextReader(context)) {
        final int maxDoc=context.reader().maxDoc();
        for (int i=0; i < maxDoc; i++) {
          cli.getOrdinals(i,ordinals);
          if (ordinals.length > 0) {
            int doc=i + context.docBase;
            if (dpf[doc] == null) {
              dpf[doc]=new int[numPartitions][];
            }
            if (dpf[doc][part] == null) {
              dpf[doc][part]=new int[ordinals.length];
            }
            for (int j=0; j < ordinals.length; j++) {
              dpf[doc][part][j]=ordinals.ints[j];
            }
          }
        }
      }
    }
  }
  docPartitionCategories=dpf;
}
