{
  Directory dir=newDirectory();
  IndexWriterConfig conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setMaxBufferedDocs(2).setMergePolicy(newLogMergePolicy());
  ConcurrentMergeScheduler cms=new ConcurrentMergeScheduler();
  cms.setSuppressExceptions();
  conf.setMergeScheduler(cms);
  ((LogMergePolicy)conf.getMergePolicy()).setMergeFactor(2);
  MockIndexWriter3 w=new MockIndexWriter3(dir,conf);
  w.doFail=true;
  Document doc=new Document();
  doc.add(newTextField("field","a field",Field.Store.YES));
  for (int i=0; i < 10; i++)   try {
    w.addDocument(doc);
  }
 catch (  RuntimeException re) {
    break;
  }
  ((ConcurrentMergeScheduler)w.getConfig().getMergeScheduler()).sync();
  assertTrue(w.failed);
  w.close();
  dir.close();
}
