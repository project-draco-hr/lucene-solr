{
  MockDirectoryWrapper dir=newMockDirectory();
  FailOnlyOnFlush failure=new FailOnlyOnFlush();
  failure.setDoFail();
  dir.failOn(failure);
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDocs(2));
  Document doc=new Document();
  String contents="aa bb cc dd ee ff gg hh ii jj kk";
  doc.add(newTextField("content",contents,Field.Store.NO));
  boolean hitError=false;
  writer.addDocument(doc);
  try {
    writer.addDocument(doc);
    fail("did not hit exception");
  }
 catch (  IOException ioe) {
    assertFalse(hitError);
    hitError=true;
    assertTrue(writer.deleter.isClosed());
    assertTrue(writer.isClosed());
  }
  assertFalse(DirectoryReader.indexExists(dir));
  dir.close();
}
