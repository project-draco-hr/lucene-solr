{
  MockDirectoryWrapper.Failure failure=new MockDirectoryWrapper.Failure(){
    @Override public MockDirectoryWrapper.Failure reset(){
      doFail=false;
      return this;
    }
    @Override public void eval(    MockDirectoryWrapper dir) throws IOException {
      if (doFail) {
        if (random().nextBoolean()) {
          throw new FileNotFoundException("some/file/name.ext (Too many open files)");
        }
      }
    }
  }
;
  MockDirectoryWrapper dir=newMockDirectory();
  dir.setFailOnOpenInput(true);
  dir.failOn(failure);
  IndexWriterConfig iwc=new IndexWriterConfig(new MockAnalyzer(random()));
  IndexWriter iw=new IndexWriter(dir,iwc);
  Document doc=new Document();
  doc.add(new StringField("foo","bar",Field.Store.NO));
  iw.addDocument(doc);
  iw.commit();
  DirectoryReader ir=DirectoryReader.open(dir);
  assertEquals(1,ir.numDocs());
  ir.close();
  iw.close();
  for (int i=0; i < 10; i++) {
    failure.setDoFail();
    iwc=new IndexWriterConfig(new MockAnalyzer(random()));
    try {
      iw=new IndexWriter(dir,iwc);
    }
 catch (    AssertionError ex) {
      assertTrue(ex.getMessage().matches("file .* does not exist; files=\\[.*\\]"));
    }
catch (    CorruptIndexException ex) {
      continue;
    }
catch (    FileNotFoundException|NoSuchFileException ex) {
      continue;
    }
    failure.clearDoFail();
    iw.close();
    ir=DirectoryReader.open(dir);
    assertEquals("lost document after iteration: " + i,1,ir.numDocs());
    ir.close();
  }
  failure.clearDoFail();
  ir=DirectoryReader.open(dir);
  assertEquals(1,ir.numDocs());
  ir.close();
  dir.close();
}
