{
  Directory startDir=newDirectory();
  IndexWriterConfig conf=newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDocs(2).setMergePolicy(newLogMergePolicy());
  ((LogMergePolicy)conf.getMergePolicy()).setMergeFactor(100);
  IndexWriter w=new IndexWriter(startDir,conf);
  for (int i=0; i < 27; i++)   addDoc(w);
  w.close();
  int iter=TEST_NIGHTLY ? 200 : 10;
  for (int i=0; i < iter; i++) {
    if (VERBOSE) {
      System.out.println("TEST: iter " + i);
    }
    MockDirectoryWrapper dir=new MockDirectoryWrapper(random(),new RAMDirectory(startDir,newIOContext(random())));
    conf=newIndexWriterConfig(new MockAnalyzer(random())).setMergeScheduler(new ConcurrentMergeScheduler());
    ((ConcurrentMergeScheduler)conf.getMergeScheduler()).setSuppressExceptions();
    w=new IndexWriter(dir,conf);
    dir.setRandomIOExceptionRate(0.5);
    try {
      w.forceMerge(1);
    }
 catch (    IOException ioe) {
      if (ioe.getCause() == null)       fail("forceMerge threw IOException without root cause");
    }
    dir.setRandomIOExceptionRate(0);
    w.close();
    dir.close();
  }
  startDir.close();
}
