{
  Analyzer analyzer=new Analyzer(Analyzer.PER_FIELD_REUSE_STRATEGY){
    @Override public TokenStreamComponents createComponents(    String fieldName){
      MockTokenizer tokenizer=new MockTokenizer(MockTokenizer.WHITESPACE,false);
      tokenizer.setEnableChecks(false);
      return new TokenStreamComponents(tokenizer,new CrashingFilter(fieldName,tokenizer));
    }
  }
;
  final int NUM_THREAD=3;
  final int NUM_ITER=100;
  for (int i=0; i < 2; i++) {
    Directory dir=newDirectory();
{
      final IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(analyzer).setMaxBufferedDocs(-1).setMergePolicy(NoMergePolicy.INSTANCE));
      final int finalI=i;
      Thread[] threads=new Thread[NUM_THREAD];
      for (int t=0; t < NUM_THREAD; t++) {
        threads[t]=new Thread(){
          @Override public void run(){
            try {
              for (int iter=0; iter < NUM_ITER; iter++) {
                Document doc=new Document();
                doc.add(newField("contents","here are some contents",DocCopyIterator.custom5));
                writer.addDocument(doc);
                writer.addDocument(doc);
                doc.add(newField("crash","this should crash after 4 terms",DocCopyIterator.custom5));
                doc.add(newField("other","this will not get indexed",DocCopyIterator.custom5));
                try {
                  writer.addDocument(doc);
                  fail("did not hit expected exception");
                }
 catch (                IOException ioe) {
                }
                if (0 == finalI) {
                  doc=new Document();
                  doc.add(newField("contents","here are some contents",DocCopyIterator.custom5));
                  writer.addDocument(doc);
                  writer.addDocument(doc);
                }
              }
            }
 catch (            Throwable t) {
synchronized (this) {
                System.out.println(Thread.currentThread().getName() + ": ERROR: hit unexpected exception");
                t.printStackTrace(System.out);
              }
              fail();
            }
          }
        }
;
        threads[t].start();
      }
      for (int t=0; t < NUM_THREAD; t++)       threads[t].join();
      writer.shutdown();
    }
    IndexReader reader=DirectoryReader.open(dir);
    int expected=(3 + (1 - i) * 2) * NUM_THREAD * NUM_ITER;
    assertEquals("i=" + i,expected,reader.docFreq(new Term("contents","here")));
    assertEquals(expected,reader.maxDoc());
    int numDel=0;
    final Bits liveDocs=MultiFields.getLiveDocs(reader);
    assertNotNull(liveDocs);
    for (int j=0; j < reader.maxDoc(); j++) {
      if (!liveDocs.get(j))       numDel++;
 else {
        reader.document(j);
        reader.getTermVectors(j);
      }
    }
    reader.close();
    assertEquals(NUM_THREAD * NUM_ITER,numDel);
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(analyzer).setMaxBufferedDocs(10));
    Document doc=new Document();
    doc.add(newField("contents","here are some contents",DocCopyIterator.custom5));
    for (int j=0; j < 17; j++)     writer.addDocument(doc);
    writer.forceMerge(1);
    writer.shutdown();
    reader=DirectoryReader.open(dir);
    expected+=17 - NUM_THREAD * NUM_ITER;
    assertEquals(expected,reader.docFreq(new Term("contents","here")));
    assertEquals(expected,reader.maxDoc());
    assertNull(MultiFields.getLiveDocs(reader));
    for (int j=0; j < reader.maxDoc(); j++) {
      reader.document(j);
      reader.getTermVectors(j);
    }
    reader.close();
    dir.close();
  }
}
