{
  Directory dir=newDirectory();
  if (dir instanceof MockDirectoryWrapper) {
    ((MockDirectoryWrapper)dir).setPreventDoubleWrite(false);
  }
  IndexWriter writer=null;
  writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())));
  for (int i=0; i < 100; i++) {
    addDoc(writer);
  }
  writer.close();
  long gen=SegmentInfos.getLastCommitGeneration(dir);
  assertTrue("segment generation should be > 0 but got " + gen,gen > 0);
  String fileNameIn=SegmentInfos.getLastCommitSegmentsFileName(dir);
  String fileNameOut=IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",1 + gen);
  IndexInput in=dir.openInput(fileNameIn,newIOContext(random()));
  IndexOutput out=dir.createOutput(fileNameOut,newIOContext(random()));
  long length=in.length();
  for (int i=0; i < length - 1; i++) {
    out.writeByte(in.readByte());
  }
  in.close();
  out.close();
  IndexReader reader=null;
  try {
    reader=DirectoryReader.open(dir);
  }
 catch (  Exception e) {
    fail("reader failed to open on a crashed index");
  }
  reader.close();
  try {
    writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setOpenMode(OpenMode.CREATE));
  }
 catch (  Exception e) {
    e.printStackTrace(System.out);
    fail("writer failed to open on a crashed index");
  }
  for (int i=0; i < 100; i++) {
    addDoc(writer);
  }
  writer.close();
  dir.close();
}
