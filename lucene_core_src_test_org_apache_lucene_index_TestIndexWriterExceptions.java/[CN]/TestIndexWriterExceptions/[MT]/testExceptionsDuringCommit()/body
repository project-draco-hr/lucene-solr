{
  FailOnlyInCommit[] failures=new FailOnlyInCommit[]{new FailOnlyInCommit(false,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(true,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(false,FailOnlyInCommit.FINISH_STAGE)};
  for (  FailOnlyInCommit failure : failures) {
    MockDirectoryWrapper dir=newMockDirectory();
    dir.setFailOnCreateOutput(false);
    dir.setEnableVirusScanner(false);
    IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())));
    Document doc=new Document();
    doc.add(newTextField("field","a field",Field.Store.YES));
    w.addDocument(doc);
    dir.failOn(failure);
    try {
      w.close();
      fail();
    }
 catch (    IOException ioe) {
      fail("expected only RuntimeException");
    }
catch (    RuntimeException re) {
    }
    assertTrue(failure.failOnCommit && failure.failOnDeleteFile);
    w.rollback();
    String files[]=dir.listAll();
    assertTrue(files.length == 0 || Arrays.equals(files,new String[]{IndexWriter.WRITE_LOCK_NAME}));
    dir.close();
  }
}
