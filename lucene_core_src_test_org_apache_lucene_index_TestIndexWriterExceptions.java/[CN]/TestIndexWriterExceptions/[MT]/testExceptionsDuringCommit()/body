{
  FailOnlyInCommit[] failures=new FailOnlyInCommit[]{new FailOnlyInCommit(false,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(true,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(false,FailOnlyInCommit.FINISH_STAGE)};
  for (  FailOnlyInCommit failure : failures) {
    MockDirectoryWrapper dir=newMockDirectory();
    dir.setFailOnCreateOutput(false);
    int fileCount=dir.listAll().length;
    IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())));
    Document doc=new Document();
    doc.add(newTextField("field","a field",Field.Store.YES));
    w.addDocument(doc);
    dir.failOn(failure);
    try {
      w.close();
      fail();
    }
 catch (    IOException ioe) {
      fail("expected only RuntimeException");
    }
catch (    RuntimeException re) {
    }
    assertTrue("failOnCommit=" + failure.failOnCommit + " failOnDeleteFile="+ failure.failOnDeleteFile,failure.failOnCommit && failure.failOnDeleteFile);
    w.rollback();
    String files[]=dir.listAll();
    assertTrue(files.length == fileCount || (files.length == fileCount + 1 && Arrays.asList(files).contains(IndexWriter.WRITE_LOCK_NAME)));
    dir.close();
  }
}
