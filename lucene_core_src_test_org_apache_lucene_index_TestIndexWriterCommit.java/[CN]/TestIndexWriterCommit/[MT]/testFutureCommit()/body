{
  Directory dir=newDirectory();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setIndexDeletionPolicy(NoDeletionPolicy.INSTANCE));
  Document doc=new Document();
  w.addDocument(doc);
  Map<String,String> commitData=new HashMap<>();
  commitData.put("tag","first");
  w.setCommitData(commitData);
  w.commit();
  w.addDocument(doc);
  commitData.put("tag","second");
  w.setCommitData(commitData);
  w.close();
  IndexCommit commit=null;
  for (  IndexCommit c : DirectoryReader.listCommits(dir)) {
    if (c.getUserData().get("tag").equals("first")) {
      commit=c;
      break;
    }
  }
  assertNotNull(commit);
  w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setIndexDeletionPolicy(NoDeletionPolicy.INSTANCE).setIndexCommit(commit));
  assertEquals(1,w.numDocs());
  w.addDocument(doc);
  commitData.put("tag","third");
  w.setCommitData(commitData);
  w.close();
  commit=null;
  for (  IndexCommit c : DirectoryReader.listCommits(dir)) {
    if (c.getUserData().get("tag").equals("second")) {
      commit=c;
      break;
    }
  }
  assertNotNull(commit);
  dir.close();
}
