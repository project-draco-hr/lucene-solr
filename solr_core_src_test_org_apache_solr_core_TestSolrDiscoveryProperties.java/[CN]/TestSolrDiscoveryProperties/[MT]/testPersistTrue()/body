{
  setMeUp();
  addSolrPropertiesFile();
  System.setProperty("solr.persistent","true");
  Properties special=makeCorePropFile("core1",false,true);
  special.put(CoreDescriptor.CORE_INSTDIR,"${core1inst:anothersillypath}");
  addCoreWithProps(special);
  addCoreWithProps(makeCorePropFile("core2",false,false));
  addCoreWithProps(makeCorePropFile("lazy1",true,true));
  addCoreWithProps(makeCorePropFile("lazy2",true,true));
  addCoreWithProps(makeCorePropFile("lazy3",true,false));
  System.setProperty("core1inst","core1");
  CoreContainer cc=init();
  SolrCore coreC1=cc.getCore("core1");
  addCoreProps(coreC1,"addedPropC1=addedC1","addedPropC1B=foo","addedPropC1C=bar");
  SolrCore coreC2=cc.getCore("core2");
  addCoreProps(coreC2,"addedPropC2=addedC2","addedPropC2B=foo","addedPropC2C=bar");
  SolrCore coreL1=cc.getCore("lazy1");
  addCoreProps(coreL1,"addedPropL1=addedL1","addedPropL1B=foo","addedPropL1C=bar");
  SolrCore coreL2=cc.getCore("lazy2");
  addCoreProps(coreL2,"addedPropL2=addedL2","addedPropL2B=foo","addedPropL2C=bar");
  SolrCore coreL3=cc.getCore("lazy3");
  addCoreProps(coreL3,"addedPropL3=addedL3","addedPropL3B=foo","addedPropL3C=bar");
  try {
    cc.persist();
    TestLazyCores.checkInCores(cc,"core1","core2","lazy2","lazy3");
    TestLazyCores.checkNotInCores(cc,"lazy1");
    checkSolrProperties(cc);
    File xmlFile=new File(solrHomeDirectory,"solr.xml");
    assertFalse("Solr.xml should NOT exist",xmlFile.exists());
    Properties orig=makeCorePropFile("core1",false,true);
    orig.put(CoreDescriptor.CORE_INSTDIR,"${core1inst:anothersillypath}");
    checkCoreProps(orig,"addedPropC1=addedC1","addedPropC1B=foo","addedPropC1C=bar");
    orig=makeCorePropFile("core2",false,false);
    checkCoreProps(orig,"addedPropC2=addedC2","addedPropC2B=foo","addedPropC2C=bar");
    orig=makeCorePropFile("lazy1",true,true);
    checkCoreProps(orig,"addedPropL1=addedL1","addedPropL1B=foo","addedPropL1C=bar");
    orig=makeCorePropFile("lazy2",true,true);
    checkCoreProps(orig,"addedPropL2=addedL2","addedPropL2B=foo","addedPropL2C=bar");
    orig=makeCorePropFile("lazy3",true,false);
    checkCoreProps(orig,"addedPropL3=addedL3","addedPropL3B=foo","addedPropL3C=bar");
    coreC1.close();
    coreC2.close();
    coreL1.close();
    coreL2.close();
    coreL3.close();
  }
  finally {
    cc.shutdown();
  }
}
