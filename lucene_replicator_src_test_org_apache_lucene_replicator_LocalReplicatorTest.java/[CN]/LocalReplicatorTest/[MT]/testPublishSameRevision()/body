{
  if (sourceDir instanceof MockDirectoryWrapper) {
    ((MockDirectoryWrapper)sourceDir).setEnableVirusScanner(false);
  }
  try {
    Revision rev=createRevision(1);
    replicator.publish(rev);
    SessionToken res=replicator.checkForUpdate(null);
    assertNotNull(res);
    assertEquals(rev.getVersion(),res.version);
    replicator.release(res.id);
    replicator.publish(new IndexRevision(sourceWriter));
    res=replicator.checkForUpdate(res.version);
    assertNull(res);
    replicator.publish(createRevision(2));
    assertEquals(1,DirectoryReader.listCommits(sourceDir).size());
  }
  finally {
    if (sourceDir instanceof MockDirectoryWrapper) {
      ((MockDirectoryWrapper)sourceDir).setEnableVirusScanner(true);
    }
  }
}
