{
  if (filter == null) {
    DocSetHitCollector hc=new DocSetHitCollector(HASHSET_INVERSE_LOAD_FACTOR,HASHDOCSET_MAXSIZE,maxDoc());
    if (query instanceof TermQuery) {
      Term t=((TermQuery)query).getTerm();
      TermDocs tdocs=null;
      try {
        tdocs=reader.termDocs(t);
        while (tdocs.next())         hc.collect(tdocs.doc(),0.0f);
      }
  finally {
        if (tdocs != null)         tdocs.close();
      }
    }
 else {
      super.search(query,null,hc);
    }
    return hc.getDocSet();
  }
 else {
    final DocSetHitCollector hc=new DocSetHitCollector(HASHSET_INVERSE_LOAD_FACTOR,HASHDOCSET_MAXSIZE,maxDoc());
    final DocSet filt=filter;
    super.search(query,null,new HitCollector(){
      public void collect(      int doc,      float score){
        if (filt.exists(doc))         hc.collect(doc,score);
      }
    }
);
    return hc.getDocSet();
  }
}
