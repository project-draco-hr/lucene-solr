{
  if (filter == null) {
    DocSetCollector hc=new DocSetCollector(maxDoc() >> 6,maxDoc());
    if (query instanceof TermQuery) {
      Term t=((TermQuery)query).getTerm();
      SolrIndexReader[] readers=reader.getLeafReaders();
      int[] offsets=reader.getLeafOffsets();
      int[] arr=new int[256];
      int[] freq=new int[256];
      for (int i=0; i < readers.length; i++) {
        SolrIndexReader sir=readers[i];
        int offset=offsets[i];
        hc.setNextReader(sir,offset);
        TermDocs tdocs=sir.termDocs(t);
        for (; ; ) {
          int num=tdocs.read(arr,freq);
          if (num == 0)           break;
          while (--num >= 0) {
            hc.collect(arr[num]);
          }
        }
        tdocs.close();
      }
    }
 else {
      searcher.search(query,null,hc);
    }
    return hc.getDocSet();
  }
 else {
    final DocSetCollector hc=new DocSetCollector(maxDoc() >> 6,maxDoc());
    final DocSet filt=filter;
    super.search(query,null,new Collector(){
      int base=0;
      public void collect(      int doc){
        doc+=base;
        if (filt.exists(doc))         hc.collect(doc);
      }
      public void setNextReader(      IndexReader reader,      int docBase) throws IOException {
        this.base=docBase;
      }
      public void setScorer(      Scorer scorer) throws IOException {
      }
    }
);
    return hc.getDocSet();
  }
}
