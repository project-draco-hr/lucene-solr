{
  assertU(adoc("id","1","v_t","Hello Dude","v_s1","string1"));
  assertU(adoc("id","2","v_t","Hello Yonik","v_s1","string2"));
  assertU(commit());
  SolrQueryRequest sr1=req("q","foo");
  ReaderContext rCtx1=sr1.getSearcher().getTopReaderContext();
  String sval1=getStringVal(sr1,"v_s1",0);
  assertEquals("string1",sval1);
  assertU(adoc("id","3","v_s1","{!literal}"));
  assertU(adoc("id","4","v_s1","other stuff"));
  assertU(commit());
  SolrQueryRequest sr2=req("q","foo");
  ReaderContext rCtx2=sr2.getSearcher().getTopReaderContext();
  assertEquals(ReaderUtil.leaves(rCtx1)[0].reader,ReaderUtil.leaves(rCtx2)[0].reader);
  assertU(adoc("id","5","v_f","3.14159"));
  assertU(adoc("id","6","v_f","8983","v_s1","string6"));
  assertU(commit());
  SolrQueryRequest sr3=req("q","foo");
  ReaderContext rCtx3=sr3.getSearcher().getTopReaderContext();
  assertEquals(ReaderUtil.leaves(rCtx2)[0].reader,ReaderUtil.leaves(rCtx3)[0].reader);
  assertEquals(ReaderUtil.leaves(rCtx2)[1].reader,ReaderUtil.leaves(rCtx3)[1].reader);
  sr1.close();
  sr2.close();
  int baseRefCount=rCtx3.reader.getRefCount();
  assertEquals(1,baseRefCount);
  assertU(commit());
  SolrQueryRequest sr4=req("q","foo");
  ReaderContext rCtx4=sr4.getSearcher().getTopReaderContext();
  assertU(adoc("id","7","v_f","7574"));
  assertU(commit());
  assertEquals(rCtx3.reader,rCtx4.reader);
  assertEquals(baseRefCount + 1,rCtx4.reader.getRefCount());
  sr3.close();
  assertEquals(baseRefCount,rCtx4.reader.getRefCount());
  sr4.close();
  assertEquals(baseRefCount - 1,rCtx4.reader.getRefCount());
  SolrQueryRequest sr5=req("q","foo");
  ReaderContext rCtx5=sr5.getSearcher().getTopReaderContext();
  assertU(delI("1"));
  assertU(commit());
  SolrQueryRequest sr6=req("q","foo");
  ReaderContext rCtx6=sr6.getSearcher().getTopReaderContext();
  assertEquals(1,ReaderUtil.leaves(rCtx6)[0].reader.numDocs());
  assertTrue(!ReaderUtil.leaves(rCtx5)[0].reader.equals(ReaderUtil.leaves(rCtx6)[0].reader));
  sr5.close();
  sr6.close();
}
