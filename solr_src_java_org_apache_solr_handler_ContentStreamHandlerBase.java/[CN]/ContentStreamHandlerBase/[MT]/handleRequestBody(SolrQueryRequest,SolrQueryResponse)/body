{
  SolrParams params=req.getParams();
  UpdateRequestProcessorChain processorChain=req.getCore().getUpdateProcessingChain(params.get(UpdateParams.UPDATE_PROCESSOR));
  UpdateRequestProcessor processor=processorChain.createProcessor(req,rsp);
  try {
    ContentStreamLoader documentLoader=newLoader(req,processor);
    Iterable<ContentStream> streams=req.getContentStreams();
    if (streams == null) {
      if (!RequestHandlerUtils.handleCommit(req,processor,params,false) && !RequestHandlerUtils.handleRollback(req,processor,params,false)) {
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"missing content stream");
      }
    }
 else {
      for (      ContentStream stream : streams) {
        documentLoader.load(req,rsp,stream);
      }
      RequestHandlerUtils.handleCommit(req,processor,params,false);
      RequestHandlerUtils.handleRollback(req,processor,params,false);
    }
  }
  finally {
    processor.finish();
  }
}
