{
  Directory dir=newDirectory();
  final AtomicBoolean didWarm=new AtomicBoolean();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDocs(2).setReaderPooling(true).setMergedSegmentWarmer(new IndexWriter.IndexReaderWarmer(){
    @Override public void warm(    AtomicReader r) throws IOException {
      IndexSearcher s=newSearcher(r);
      TopDocs hits=s.search(new TermQuery(new Term("foo","bar")),10);
      assertEquals(20,hits.totalHits);
      didWarm.set(true);
    }
  }
).setMergePolicy(newLogMergePolicy(10)));
  Document doc=new Document();
  doc.add(newStringField("foo","bar",Field.Store.NO));
  for (int i=0; i < 20; i++) {
    w.addDocument(doc);
  }
  w.waitForMerges();
  w.shutdown();
  dir.close();
  assertTrue(didWarm.get());
}
