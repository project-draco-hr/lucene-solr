{
  boolean doFullMerge=true;
  Directory dir1=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random()));
  if (iwc.getMaxBufferedDocs() < 20) {
    iwc.setMaxBufferedDocs(20);
  }
  if (random().nextBoolean()) {
    iwc.setMergePolicy(NoMergePolicy.NO_COMPOUND_FILES);
  }
 else {
    iwc.setMergePolicy(NoMergePolicy.COMPOUND_FILES);
  }
  if (VERBOSE) {
    System.out.println("TEST: make index");
  }
  IndexWriter writer=new IndexWriter(dir1,iwc);
  createIndexNoClose(!doFullMerge,"index1",writer);
  DirectoryReader r1=writer.getReader();
  assertTrue(r1.isCurrent());
  String id10=r1.document(10).getField("id").stringValue();
  Document newDoc=new Document(r1.document(10));
  newDoc.removeField("id");
  newDoc.add(newStringField("id",Integer.toString(8000),Field.Store.YES));
  writer.updateDocument(new Term("id",id10),newDoc);
  assertFalse(r1.isCurrent());
  DirectoryReader r2=writer.getReader();
  assertTrue(r2.isCurrent());
  assertEquals(0,count(new Term("id",id10),r2));
  if (VERBOSE) {
    System.out.println("TEST: verify id");
  }
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r2));
  r1.close();
  writer.close();
  assertTrue(r2.isCurrent());
  DirectoryReader r3=DirectoryReader.open(dir1);
  assertTrue(r3.isCurrent());
  assertTrue(r2.isCurrent());
  assertEquals(0,count(new Term("id",id10),r3));
  assertEquals(1,count(new Term("id",Integer.toString(8000)),r3));
  writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  Document doc=new Document();
  doc.add(newTextField("field","a b c",Field.Store.NO));
  writer.addDocument(doc);
  assertTrue(r2.isCurrent());
  assertTrue(r3.isCurrent());
  writer.close();
  assertFalse(r2.isCurrent());
  assertTrue(!r3.isCurrent());
  r2.close();
  r3.close();
  dir1.close();
}
