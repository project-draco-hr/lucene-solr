{
  Directory dir1=getAssertNoDeletesDirectory(newDirectory());
  IndexWriter writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  IndexReader r1=writer.getReader();
  assertEquals(0,r1.maxDoc());
  createIndexNoClose(false,"index1",writer);
  writer.flush(!doFullMerge,true);
  IndexReader iwr1=writer.getReader();
  assertEquals(100,iwr1.maxDoc());
  IndexReader r2=writer.getReader();
  assertEquals(r2.maxDoc(),100);
  for (int x=10000; x < 10000 + 100; x++) {
    Document d=DocHelper.createDocument(x,"index1",5);
    writer.addDocument(d);
  }
  writer.flush(false,true);
  IndexReader iwr2=writer.getReader();
  assertTrue(iwr2 != r1);
  assertEquals(200,iwr2.maxDoc());
  IndexReader r3=writer.getReader();
  assertTrue(r2 != r3);
  assertEquals(200,r3.maxDoc());
  r1.close();
  iwr1.close();
  r2.close();
  r3.close();
  iwr2.close();
  writer.shutdown();
  writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  IndexReader w2r1=writer.getReader();
  assertEquals(200,w2r1.maxDoc());
  w2r1.close();
  writer.shutdown();
  dir1.close();
}
