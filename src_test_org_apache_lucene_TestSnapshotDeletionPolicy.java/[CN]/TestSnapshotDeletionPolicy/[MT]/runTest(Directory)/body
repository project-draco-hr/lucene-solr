{
  final long stopTime=System.currentTimeMillis() + 7000;
  SnapshotDeletionPolicy dp=new SnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy());
  final IndexWriter writer=new IndexWriter(dir,true,new StandardAnalyzer(),dp,IndexWriter.MaxFieldLength.LIMITED);
  writer.setMaxBufferedDocs(2);
  final Thread t=new Thread(){
    public void run(){
      Document doc=new Document();
      doc.add(new Field("content","aaa",Field.Store.YES,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
      while (System.currentTimeMillis() < stopTime) {
        for (int i=0; i < 27; i++) {
          try {
            writer.addDocument(doc);
          }
 catch (          Throwable t) {
            t.printStackTrace(System.out);
            fail("addDocument failed");
          }
        }
        try {
          Thread.sleep(1);
        }
 catch (        InterruptedException ie) {
          Thread.currentThread().interrupt();
        }
      }
    }
  }
;
  t.start();
  while (System.currentTimeMillis() < stopTime) {
    backupIndex(dir,dp);
    try {
      Thread.sleep(20);
    }
 catch (    InterruptedException ie) {
      Thread.currentThread().interrupt();
    }
    if (!t.isAlive())     break;
  }
  try {
    t.join();
  }
 catch (  InterruptedException ie) {
    Thread.currentThread().interrupt();
  }
  Document doc=new Document();
  doc.add(new Field("content","aaa",Field.Store.YES,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
  writer.addDocument(doc);
  writer.close();
  TestIndexWriter.assertNoUnreferencedFiles(dir,"some files were not deleted but should have been");
}
