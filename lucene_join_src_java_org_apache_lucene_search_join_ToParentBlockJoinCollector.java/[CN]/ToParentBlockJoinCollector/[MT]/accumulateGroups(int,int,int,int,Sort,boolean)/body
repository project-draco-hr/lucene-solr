{
  final GroupDocs<Integer>[] groups=new GroupDocs[sortedGroups.length - offset];
  final FakeScorer fakeScorer=new FakeScorer();
  int totalGroupedHitCount=0;
  for (int groupIDX=offset; groupIDX < sortedGroups.length; groupIDX++) {
    final OneGroup og=sortedGroups[groupIDX];
    final int numChildDocs;
    if (slot == -1 || slot >= og.counts.length) {
      numChildDocs=0;
    }
 else {
      numChildDocs=og.counts[slot];
    }
    final int numDocsInGroup=Math.max(1,Math.min(numChildDocs,maxDocsPerGroup));
    final TopDocsCollector<?> collector;
    if (withinGroupSort == null) {
      if (!trackScores) {
        throw new IllegalArgumentException("cannot sort by relevance within group: trackScores=false");
      }
      collector=TopScoreDocCollector.create(numDocsInGroup,true);
    }
 else {
      collector=TopFieldCollector.create(withinGroupSort,numDocsInGroup,fillSortFields,trackScores,trackMaxScore,true);
    }
    LeafCollector leafCollector=collector.getLeafCollector(og.readerContext);
    leafCollector.setScorer(fakeScorer);
    for (int docIDX=0; docIDX < numChildDocs; docIDX++) {
      final int doc=og.docs[slot][docIDX];
      fakeScorer.doc=doc;
      if (trackScores) {
        fakeScorer.score=og.scores[slot][docIDX];
      }
      leafCollector.collect(doc);
    }
    totalGroupedHitCount+=numChildDocs;
    final Object[] groupSortValues;
    if (fillSortFields) {
      groupSortValues=new Object[comparators.length];
      for (int sortFieldIDX=0; sortFieldIDX < comparators.length; sortFieldIDX++) {
        groupSortValues[sortFieldIDX]=comparators[sortFieldIDX].value(og.slot);
      }
    }
 else {
      groupSortValues=null;
    }
    final TopDocs topDocs=collector.topDocs(withinGroupOffset,numDocsInGroup);
    groups[groupIDX - offset]=new GroupDocs<>(og.score,topDocs.getMaxScore(),numChildDocs,topDocs.scoreDocs,og.doc,groupSortValues);
  }
  return new TopGroups<>(new TopGroups<>(sort.getSort(),withinGroupSort == null ? null : withinGroupSort.getSort(),0,totalGroupedHitCount,groups,maxScore),totalHitCount);
}
