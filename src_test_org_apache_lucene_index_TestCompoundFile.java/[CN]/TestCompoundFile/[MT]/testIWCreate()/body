{
  IndexWriter iw=new IndexWriter(dir,new WhitespaceAnalyzer(),true);
  int created=0;
  for (int i=0; i < 150; i++) {
    iw.addDocument(createTestDoc(String.valueOf(i)));
    created++;
  }
  assertEquals(created,iw.docCount());
  iw.close();
  IndexReader reader=IndexReader.open(dir);
  int deleted=0;
  for (int i=10; i < created - 7; i+=7) {
    reader.delete(i);
    deleted++;
  }
  reader.close();
  int remains=created - deleted;
  iw=new IndexWriter(dir,new WhitespaceAnalyzer(),false);
  assertEquals(created,iw.docCount());
  iw.close();
  reader=IndexReader.open(dir);
  assertEquals(created,reader.maxDoc());
  assertEquals(remains,reader.numDocs());
  for (int i=10; i < created - 7; i+=7) {
    assertTrue("deleted: " + i,reader.isDeleted(i));
    assertFalse("deleted+1: " + i,reader.isDeleted(i + 1));
    assertFalse("deleted-1: " + i,reader.isDeleted(i - 1));
  }
  reader.close();
  iw=new IndexWriter(dir,new WhitespaceAnalyzer(),false);
  iw.optimize();
  assertEquals(remains,iw.docCount());
  iw.close();
  reader=IndexReader.open(dir);
  assertEquals(remains,reader.maxDoc());
  assertEquals(remains,reader.numDocs());
  reader.close();
}
