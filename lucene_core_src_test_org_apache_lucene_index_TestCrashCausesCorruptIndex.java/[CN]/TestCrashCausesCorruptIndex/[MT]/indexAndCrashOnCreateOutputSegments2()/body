{
  Directory realDirectory=FSDirectory.open(path);
  CrashAfterCreateOutput crashAfterCreateOutput=new CrashAfterCreateOutput(realDirectory);
  IndexWriter indexWriter=new IndexWriter(crashAfterCreateOutput,newIndexWriterConfig(new MockAnalyzer(random())));
  indexWriter.addDocument(getDocument());
  indexWriter.commit();
  crashAfterCreateOutput.setCrashAfterCreateOutput("segments_2");
  indexWriter.addDocument(getDocument());
  try {
    indexWriter.commit();
    fail("should have hit CrashingException");
  }
 catch (  CrashingException e) {
  }
  indexWriter.shutdown();
  assertFalse(slowFileExists(realDirectory,"segments_2"));
  crashAfterCreateOutput.close();
}
