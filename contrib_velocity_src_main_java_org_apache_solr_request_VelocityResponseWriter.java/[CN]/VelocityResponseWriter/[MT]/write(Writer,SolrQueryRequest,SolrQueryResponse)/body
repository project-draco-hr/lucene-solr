{
  VelocityEngine engine=getEngine(request);
  Template template=getTemplate(engine,request);
  VelocityContext context=new VelocityContext();
  context.put("request",request);
  context.put("response",response);
  context.put("page",new PageTool(request,response));
  context.put("esc",new EscapeTool());
  if (request.getParams().get("v.json") != null) {
    StringWriter stringWriter=new StringWriter();
    template.merge(context,stringWriter);
    writer.write(request.getParams().get("v.json") + "(");
    writer.write(getJSONWrap(stringWriter.toString()));
    writer.write(')');
  }
 else {
    template.merge(context,writer);
  }
}
