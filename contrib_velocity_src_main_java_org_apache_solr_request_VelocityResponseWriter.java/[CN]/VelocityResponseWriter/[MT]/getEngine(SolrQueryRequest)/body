{
  VelocityEngine engine=new VelocityEngine();
  String template_root=request.getParams().get("v.base_dir");
  File baseDir=new File(request.getCore().getResourceLoader().getConfigDir(),"velocity");
  if (template_root != null) {
    baseDir=new File(template_root);
  }
  engine.setProperty(VelocityEngine.FILE_RESOURCE_LOADER_PATH,baseDir.getAbsolutePath());
  engine.setProperty("params.resource.loader.instance",new SolrParamResourceLoader(request));
  engine.setProperty("solr.resource.loader.instance",new SolrVelocityResourceLoader(request.getCore().getSolrConfig().getResourceLoader()));
  engine.setProperty(VelocityEngine.RESOURCE_LOADER,"params,file,solr");
  return engine;
}
