{
  while (true) {
    final Node<?> currentTail=tail;
    final Node<?> tailNext=currentTail.next;
    if (tail == currentTail && tailNext == null) {
      if (currentTail.casNext(null,newNode)) {
        long seqNo=getNextSequenceNumber();
        boolean result=tailUpdater.compareAndSet(this,currentTail,newNode);
        assert result;
        return seqNo;
      }
    }
  }
}
