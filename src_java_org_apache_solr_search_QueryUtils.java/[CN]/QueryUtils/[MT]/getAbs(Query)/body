{
  if (!(q instanceof BooleanQuery))   return q;
  BooleanQuery bq=(BooleanQuery)q;
  BooleanClause[] clauses=bq.getClauses();
  if (clauses.length == 0)   return q;
  for (  BooleanClause clause : clauses) {
    if (!clause.isProhibited())     return q;
  }
  if (clauses.length == 1) {
    Query negClause=clauses[0].getQuery();
    return negClause;
  }
 else {
    BooleanQuery newBq=new BooleanQuery(bq.isCoordDisabled());
    newBq.setBoost(bq.getBoost());
    for (    BooleanClause clause : clauses) {
      newBq.add(clause.getQuery(),BooleanClause.Occur.SHOULD);
    }
    return newBq;
  }
}
