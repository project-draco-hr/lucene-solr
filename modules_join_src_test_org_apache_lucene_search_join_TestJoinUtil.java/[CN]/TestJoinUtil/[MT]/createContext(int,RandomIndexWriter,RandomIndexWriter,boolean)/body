{
  IndexIterationContext context=new IndexIterationContext();
  int numRandomValues=nDocs / 2;
  context.randomUniqueValues=new String[numRandomValues];
  Set<String> trackSet=new HashSet<String>();
  context.randomFrom=new boolean[numRandomValues];
  for (int i=0; i < numRandomValues; i++) {
    String uniqueRandomValue;
    do {
      uniqueRandomValue=_TestUtil.randomRealisticUnicodeString(random());
    }
 while ("".equals(uniqueRandomValue) || trackSet.contains(uniqueRandomValue));
    trackSet.add(uniqueRandomValue);
    context.randomFrom[i]=random().nextBoolean();
    context.randomUniqueValues[i]=uniqueRandomValue;
  }
  for (int i=0; i < nDocs; i++) {
    String id=Integer.toString(i);
    int randomI=random().nextInt(context.randomUniqueValues.length);
    String value=context.randomUniqueValues[randomI];
    Document document=new Document();
    document.add(newField(random(),"id",id,TextField.TYPE_STORED));
    document.add(newField(random(),"value",value,TextField.TYPE_STORED));
    boolean from=context.randomFrom[randomI];
    int numberOfLinkValues=multipleValuesPerDocument ? 2 + random().nextInt(10) : 1;
    RandomDoc doc=new RandomDoc(id,numberOfLinkValues,value);
    for (int j=0; j < numberOfLinkValues; j++) {
      String linkValue=context.randomUniqueValues[random().nextInt(context.randomUniqueValues.length)];
      doc.linkValues.add(linkValue);
      if (from) {
        if (!context.fromDocuments.containsKey(linkValue)) {
          context.fromDocuments.put(linkValue,new ArrayList<RandomDoc>());
        }
        if (!context.randomValueFromDocs.containsKey(value)) {
          context.randomValueFromDocs.put(value,new ArrayList<RandomDoc>());
        }
        context.fromDocuments.get(linkValue).add(doc);
        context.randomValueFromDocs.get(value).add(doc);
        document.add(newField(random(),"from",linkValue,TextField.TYPE_STORED));
      }
 else {
        if (!context.toDocuments.containsKey(linkValue)) {
          context.toDocuments.put(linkValue,new ArrayList<RandomDoc>());
        }
        if (!context.randomValueToDocs.containsKey(value)) {
          context.randomValueToDocs.put(value,new ArrayList<RandomDoc>());
        }
        context.toDocuments.get(linkValue).add(doc);
        context.randomValueToDocs.get(value).add(doc);
        document.add(newField(random(),"to",linkValue,TextField.TYPE_STORED));
      }
    }
    final RandomIndexWriter w;
    if (from) {
      w=fromWriter;
    }
 else {
      w=toWriter;
    }
    w.addDocument(document);
    if (random().nextInt(10) == 4) {
      w.commit();
    }
    if (VERBOSE) {
      System.out.println("Added document[" + i + "]: "+ document);
    }
  }
  return context;
}
