{
  final DocState ds=reuseFields ? getDocState() : localDocState;
  final Document doc=reuseFields ? ds.doc : new Document();
  doc.getFields().clear();
  Field idField=ds.getField(ID_FIELD,storeVal,Index.NOT_ANALYZED_NO_NORMS,termVecVal);
  idField.setValue("doc" + (r != null ? r.nextInt(updateDocIDLimit) : incrNumDocsCreated()));
  doc.add(idField);
  String name=docData.getName();
  if (name == null)   name="";
  name=cnt < 0 ? name : name + "_" + cnt;
  Field nameField=ds.getField(NAME_FIELD,storeVal,indexVal,termVecVal);
  nameField.setValue(name);
  doc.add(nameField);
  String date=docData.getDate();
  if (date == null) {
    date="";
  }
  Field dateField=ds.getField(DATE_FIELD,storeVal,indexVal,termVecVal);
  dateField.setValue(date);
  doc.add(dateField);
  String title=docData.getTitle();
  Field titleField=ds.getField(TITLE_FIELD,storeVal,indexVal,termVecVal);
  titleField.setValue(title == null ? "" : title);
  doc.add(titleField);
  String body=docData.getBody();
  if (body != null && body.length() > 0) {
    String bdy;
    if (size <= 0 || size >= body.length()) {
      bdy=body;
      docData.setBody("");
    }
 else {
      for (int n=size - 1; n < size + 20 && n < body.length(); n++) {
        if (Character.isWhitespace(body.charAt(n))) {
          size=n;
          break;
        }
      }
      bdy=body.substring(0,size);
      docData.setBody(body.substring(size));
    }
    Field bodyField=ds.getField(BODY_FIELD,storeVal,bodyIndexVal,termVecVal);
    bodyField.setValue(bdy);
    doc.add(bodyField);
    if (storeBytes) {
      Field bytesField=ds.getField(BYTES_FIELD,Store.YES,Index.NOT_ANALYZED_NO_NORMS,TermVector.NO);
      bytesField.setValue(bdy.getBytes("UTF-8"));
      doc.add(bytesField);
    }
  }
  if (indexProperties) {
    Properties props=docData.getProps();
    if (props != null) {
      for (Iterator iterator=props.entrySet().iterator(); iterator.hasNext(); ) {
        Entry entry=(Entry)iterator.next();
        Field f=ds.getField((String)entry.getKey(),storeVal,indexVal,termVecVal);
        f.setValue((String)entry.getValue());
        doc.add(f);
      }
      docData.setProps(null);
    }
  }
  return doc;
}
