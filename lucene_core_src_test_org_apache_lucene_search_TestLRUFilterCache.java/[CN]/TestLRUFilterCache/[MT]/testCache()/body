{
  Directory dir=newDirectory();
  final RandomIndexWriter w=new RandomIndexWriter(random(),dir);
  Document doc=new Document();
  StringField f=new StringField("color","",Store.NO);
  doc.add(f);
  final int numDocs=atLeast(10);
  for (int i=0; i < numDocs; ++i) {
    f.setStringValue(RandomPicks.randomFrom(random(),Arrays.asList("blue","red","green")));
    w.addDocument(doc);
  }
  final DirectoryReader reader=w.getReader();
  final LeafReaderContext leaf1=reader.leaves().get(0);
  Filter filter1=new QueryWrapperFilter(new TermQuery(new Term("color","blue")));
  Filter filter2=new QueryWrapperFilter(new TermQuery(new Term("color","blue")));
  final LRUFilterCache filterCache=new LRUFilterCache(Integer.MAX_VALUE,Long.MAX_VALUE);
  final Filter cachedFilter1=filterCache.doCache(filter1,FilterCachingPolicy.ALWAYS_CACHE);
  DocIdSet cached1=cachedFilter1.getDocIdSet(leaf1,null);
  final Filter cachedFilter2=filterCache.doCache(filter2,NEVER_CACHE);
  DocIdSet cached2=cachedFilter2.getDocIdSet(leaf1,null);
  assertSame(cached1,cached2);
  filterCache.assertConsistent();
  reader.close();
  w.close();
  dir.close();
}
