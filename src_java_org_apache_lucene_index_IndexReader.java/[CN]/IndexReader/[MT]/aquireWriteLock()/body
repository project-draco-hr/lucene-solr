{
  if (stale)   throw new IOException("IndexReader out of date and no longer valid for delete, undelete, or setNorm operations");
  if (writeLock == null) {
    Lock writeLock=directory.makeLock(IndexWriter.WRITE_LOCK_NAME);
    if (!writeLock.obtain(IndexWriter.WRITE_LOCK_TIMEOUT))     throw new IOException("Index locked for write: " + writeLock);
    this.writeLock=writeLock;
    if (SegmentInfos.readCurrentVersion(directory) > segmentInfos.getVersion()) {
      stale=true;
      this.writeLock.release();
      this.writeLock=null;
      throw new IOException("IndexReader out of date and no longer valid for delete, undelete, or setNorm operations");
    }
  }
}
