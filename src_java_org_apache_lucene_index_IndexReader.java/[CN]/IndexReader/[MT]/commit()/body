{
  if (hasChanges) {
    if (directoryOwner) {
synchronized (directory) {
        new Lock.With(directory.makeLock(IndexWriter.COMMIT_LOCK_NAME),IndexWriter.COMMIT_LOCK_TIMEOUT){
          public Object doBody() throws IOException {
            doCommit();
            segmentInfos.write(directory);
            return null;
          }
        }
.run();
      }
      if (writeLock != null) {
        writeLock.release();
        writeLock=null;
      }
    }
 else     doCommit();
  }
  hasChanges=false;
}
