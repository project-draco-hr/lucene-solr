{
  if (hasChanges) {
    if (deleter == null) {
      setDeleter(new IndexFileDeleter(segmentInfos,directory));
      deleter.deleteFiles();
    }
    if (directoryOwner) {
      deleter.clearPendingFiles();
      doCommit();
      String oldInfoFileName=segmentInfos.getCurrentSegmentFileName();
      segmentInfos.write(directory);
      deleter.deleteFile(oldInfoFileName);
      deleter.commitPendingFiles();
      deleter.deleteFiles();
      if (writeLock != null) {
        writeLock.release();
        writeLock=null;
      }
    }
 else     doCommit();
  }
  hasChanges=false;
}
