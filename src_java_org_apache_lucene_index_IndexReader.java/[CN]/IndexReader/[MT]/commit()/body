{
  if (hasChanges) {
    if (deleter == null) {
      setDeleter(new IndexFileDeleter(segmentInfos,directory));
      deleter.deleteFiles();
    }
    if (directoryOwner) {
      deleter.clearPendingFiles();
      String oldInfoFileName=segmentInfos.getCurrentSegmentFileName();
      String nextSegmentsFileName=segmentInfos.getNextSegmentFileName();
      startCommit();
      boolean success=false;
      try {
        doCommit();
        segmentInfos.write(directory);
        success=true;
      }
  finally {
        if (!success) {
          rollbackCommit();
          deleter.clearPendingFiles();
          deleter.deleteFile(nextSegmentsFileName);
          deleter.findDeletableFiles();
          deleter.deleteFiles();
        }
      }
      deleter.deleteFile(oldInfoFileName);
      deleter.commitPendingFiles();
      if (writeLock != null) {
        writeLock.release();
        writeLock=null;
      }
    }
 else     doCommit();
  }
  hasChanges=false;
}
