{
  if (hasChanges) {
    if (directoryOwner) {
      IndexFileDeleter deleter=new IndexFileDeleter(directory,deletionPolicy == null ? new KeepOnlyLastCommitDeletionPolicy() : deletionPolicy,segmentInfos,null,null);
      startCommit();
      boolean success=false;
      try {
        doCommit();
        segmentInfos.write(directory);
        success=true;
      }
  finally {
        if (!success) {
          rollbackCommit();
          deleter.refresh();
        }
      }
      deleter.checkpoint(segmentInfos,true);
      if (writeLock != null) {
        writeLock.release();
        writeLock=null;
      }
    }
 else     doCommit();
  }
  hasChanges=false;
}
