{
synchronized (directory) {
    return (IndexReader)new Lock.With(directory.makeLock("commit.lock")){
      public Object doBody() throws IOException {
        SegmentInfos infos=new SegmentInfos();
        infos.read(directory);
        if (infos.size() == 1)         return new SegmentReader(infos.info(0),true);
        SegmentReader[] readers=new SegmentReader[infos.size()];
        for (int i=0; i < infos.size(); i++)         readers[i]=new SegmentReader(infos.info(i),i == infos.size() - 1);
        return new SegmentsReader(readers);
      }
    }
.run();
  }
}
