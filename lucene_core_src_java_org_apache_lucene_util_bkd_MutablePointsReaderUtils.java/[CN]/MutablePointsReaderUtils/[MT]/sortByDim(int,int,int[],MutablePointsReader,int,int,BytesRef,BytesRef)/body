{
  final int offset=sortedDim * bytesPerDim + commonPrefixLengths[sortedDim];
  final int numBytesToCompare=bytesPerDim - commonPrefixLengths[sortedDim];
  new IntroSorter(){
    final BytesRef pivot=scratch1;
    int pivotDoc=-1;
    @Override protected void swap(    int i,    int j){
      reader.swap(i,j);
    }
    @Override protected void setPivot(    int i){
      reader.getValue(i,pivot);
      pivotDoc=reader.getDocID(i);
    }
    @Override protected int comparePivot(    int j){
      reader.getValue(j,scratch2);
      int cmp=StringHelper.compare(numBytesToCompare,pivot.bytes,pivot.offset + offset,scratch2.bytes,scratch2.offset + offset);
      if (cmp == 0) {
        cmp=pivotDoc - reader.getDocID(j);
      }
      return cmp;
    }
  }
.sort(from,to);
}
