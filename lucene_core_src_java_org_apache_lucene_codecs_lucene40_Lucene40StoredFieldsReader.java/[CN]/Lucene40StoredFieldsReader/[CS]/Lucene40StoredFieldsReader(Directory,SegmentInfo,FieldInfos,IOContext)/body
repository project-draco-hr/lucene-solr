{
  final String segment=si.name;
  boolean success=false;
  fieldInfos=fn;
  try {
    fieldsStream=d.openInput(IndexFileNames.segmentFileName(segment,"",Lucene40StoredFieldsWriter.FIELDS_EXTENSION),context);
    final String indexStreamFN=IndexFileNames.segmentFileName(segment,"",Lucene40StoredFieldsWriter.FIELDS_INDEX_EXTENSION);
    indexStream=d.openInput(indexStreamFN,context);
    if (Lucene40StoredFieldsWriter.FORMAT_CURRENT != indexStream.readInt()) {
      throw new CorruptIndexException("unexpected fdx header: " + indexStream);
    }
    final long indexSize=indexStream.length() - FORMAT_SIZE;
    this.size=(int)(indexSize >> 3);
    if (this.size != si.docCount) {
      throw new CorruptIndexException("doc counts differ for segment " + segment + ": fieldsReader shows "+ this.size+ " but segmentInfo shows "+ si.docCount);
    }
    numTotalDocs=(int)(indexSize >> 3);
    success=true;
  }
  finally {
    if (!success) {
      close();
    }
  }
}
