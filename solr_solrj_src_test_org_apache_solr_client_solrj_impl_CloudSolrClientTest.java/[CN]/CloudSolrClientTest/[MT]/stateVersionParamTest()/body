{
  try (CloudSolrClient client=createCloudClient(null)){
    String collectionName="checkStateVerCol";
    createCollection(collectionName,client,1,3);
    waitForRecoveriesToFinish(collectionName,false);
    DocCollection coll=client.getZkStateReader().getClusterState().getCollection(collectionName);
    Replica r=coll.getSlices().iterator().next().getReplicas().iterator().next();
    SolrQuery q=new SolrQuery().setQuery("*:*");
    HttpSolrClient.RemoteSolrException sse=null;
    try (HttpSolrClient solrClient=new HttpSolrClient(r.getStr(ZkStateReader.BASE_URL_PROP) + "/" + collectionName)){
      log.info("should work query, result {}",solrClient.query(q));
      q.setParam(CloudSolrClient.STATE_VERSION,collectionName + ":" + coll.getZNodeVersion());
      log.info("2nd query , result {}",solrClient.query(q));
      q.setParam(CloudSolrClient.STATE_VERSION,collectionName + ":" + (coll.getZNodeVersion() - 1));
      QueryResponse rsp=solrClient.query(q);
      Map m=(Map)rsp.getResponse().get(CloudSolrClient.STATE_VERSION,rsp.getResponse().size() - 1);
      assertNotNull("Expected an extra information from server with the list of invalid collection states",m);
      assertNotNull(m.get(collectionName));
    }
     Set<String> allNodesOfColl=new HashSet<>();
    for (    Slice slice : coll.getSlices()) {
      for (      Replica replica : slice.getReplicas()) {
        allNodesOfColl.add(replica.getStr(ZkStateReader.BASE_URL_PROP));
      }
    }
    String theNode=null;
    Set<String> liveNodes=client.getZkStateReader().getClusterState().getLiveNodes();
    for (    String s : liveNodes) {
      String n=client.getZkStateReader().getBaseUrlForNodeName(s);
      if (!allNodesOfColl.contains(n)) {
        theNode=n;
        break;
      }
    }
    log.info("the node which does not serve this collection{} ",theNode);
    assertNotNull(theNode);
    try (SolrClient solrClient=new HttpSolrClient(theNode + "/" + collectionName)){
      q.setParam(CloudSolrClient.STATE_VERSION,collectionName + ":" + (coll.getZNodeVersion() - 1));
      try {
        QueryResponse rsp=solrClient.query(q);
        log.info("error was expected");
      }
 catch (      HttpSolrClient.RemoteSolrException e) {
        sse=e;
      }
      assertNotNull(sse);
      assertEquals(" Error code should be 510",SolrException.ErrorCode.INVALID_STATE.code,sse.code());
    }
   }
 }
