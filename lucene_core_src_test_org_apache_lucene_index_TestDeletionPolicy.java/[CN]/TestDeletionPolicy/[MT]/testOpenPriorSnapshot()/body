{
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexDeletionPolicy(new KeepAllDeletionPolicy(dir)).setMaxBufferedDocs(2).setMergePolicy(newLogMergePolicy(10)));
  KeepAllDeletionPolicy policy=(KeepAllDeletionPolicy)writer.getConfig().getIndexDeletionPolicy();
  for (int i=0; i < 10; i++) {
    addDoc(writer);
    if ((1 + i) % 2 == 0)     writer.commit();
  }
  writer.shutdown();
  Collection<IndexCommit> commits=DirectoryReader.listCommits(dir);
  assertEquals(5,commits.size());
  IndexCommit lastCommit=null;
  for (  final IndexCommit commit : commits) {
    if (lastCommit == null || commit.getGeneration() > lastCommit.getGeneration())     lastCommit=commit;
  }
  assertTrue(lastCommit != null);
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexDeletionPolicy(policy));
  addDoc(writer);
  assertEquals(11,writer.numDocs());
  writer.forceMerge(1);
  writer.shutdown();
  assertEquals(6,DirectoryReader.listCommits(dir).size());
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.rollback();
  DirectoryReader r=DirectoryReader.open(dir);
  assertEquals(1,r.leaves().size());
  assertEquals(11,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.shutdown();
  assertEquals(7,DirectoryReader.listCommits(dir).size());
  r=DirectoryReader.open(dir);
  assertTrue(r.leaves().size() > 1);
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexDeletionPolicy(policy));
  writer.forceMerge(1);
  writer.shutdown();
  r=DirectoryReader.open(dir);
  assertEquals(1,r.leaves().size());
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  r=DirectoryReader.open(dir);
  assertEquals(1,r.leaves().size());
  assertEquals(10,r.numDocs());
  r.close();
  writer.shutdown();
  r=DirectoryReader.open(dir);
  assertTrue(r.leaves().size() > 1);
  assertEquals(10,r.numDocs());
  r.close();
  dir.close();
}
