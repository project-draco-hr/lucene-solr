{
  if (pendingCommit == false) {
    throw new IllegalStateException("prepareCommit was not called");
  }
  boolean success=false;
  try {
    final String src=IndexFileNames.fileNameFromGeneration(IndexFileNames.PENDING_SEGMENTS,"",generation);
    final String dest=IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",generation);
    dir.renameFile(src,dest);
    success=true;
  }
  finally {
    if (!success) {
      rollbackCommit(dir);
    }
  }
  pendingCommit=false;
  lastGeneration=generation;
}
