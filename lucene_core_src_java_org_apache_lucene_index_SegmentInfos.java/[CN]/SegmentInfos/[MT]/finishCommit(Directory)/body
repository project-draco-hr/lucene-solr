{
  if (pendingCommit == false) {
    throw new IllegalStateException("prepareCommit was not called");
  }
  boolean success=false;
  final String dest;
  try {
    final String src=IndexFileNames.fileNameFromGeneration(IndexFileNames.PENDING_SEGMENTS,"",generation);
    dest=IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",generation);
    dir.rename(src,dest);
    dir.syncMetaData();
    success=true;
  }
  finally {
    if (!success) {
      rollbackCommit(dir);
    }
  }
  pendingCommit=false;
  lastGeneration=generation;
  return dest;
}
