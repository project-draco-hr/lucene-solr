{
  long nextGeneration=getNextPendingGeneration();
  String segmentFileName=IndexFileNames.fileNameFromGeneration(IndexFileNames.PENDING_SEGMENTS,"",nextGeneration);
  generation=nextGeneration;
  IndexOutput segnOutput=null;
  boolean success=false;
  try {
    segnOutput=directory.createOutput(segmentFileName,IOContext.DEFAULT);
    write(directory,segnOutput);
    segnOutput.close();
    directory.sync(Collections.singleton(segmentFileName));
    success=true;
  }
  finally {
    if (success) {
      pendingCommit=true;
    }
 else {
      IOUtils.closeWhileHandlingException(segnOutput);
      IOUtils.deleteFilesIgnoringExceptions(directory,segmentFileName);
    }
  }
}
