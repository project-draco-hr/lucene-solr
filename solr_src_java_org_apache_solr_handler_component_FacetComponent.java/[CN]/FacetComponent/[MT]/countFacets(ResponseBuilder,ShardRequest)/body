{
  FacetInfo fi=rb._facetInfo;
  for (  ShardResponse srsp : sreq.responses) {
    int shardNum=rb.getShardNum(srsp.getShard());
    NamedList facet_counts=(NamedList)srsp.getSolrResponse().getResponse().get("facet_counts");
    @SuppressWarnings("unchecked") List<String> excepts=(List<String>)facet_counts.get("exception");
    fi.addExceptions(excepts);
    NamedList facet_queries=(NamedList)facet_counts.get("facet_queries");
    if (facet_queries != null) {
      for (int i=0; i < facet_queries.size(); i++) {
        String returnedKey=facet_queries.getName(i);
        long count=((Number)facet_queries.getVal(i)).longValue();
        QueryFacet qf=fi.queryFacets.get(returnedKey);
        qf.count+=count;
      }
    }
    NamedList facet_fields=(NamedList)facet_counts.get("facet_fields");
    if (facet_fields != null) {
      for (      DistribFieldFacet dff : fi.facets.values()) {
        dff.add(shardNum,(NamedList)facet_fields.get(dff.getKey()),dff.initialLimit);
      }
    }
  }
  for (  DistribFieldFacet dff : fi.facets.values()) {
    if (dff.initialLimit <= 0 && dff.initialMincount == 0)     continue;
    if (dff.minCount == 0 && dff.sort.equals(FacetParams.FACET_SORT_INDEX))     continue;
    @SuppressWarnings("unchecked") List<String>[] tmp=(List<String>[])new List[rb.shards.length];
    dff._toRefine=tmp;
    ShardFacetCount[] counts=dff.getCountSorted();
    int ntop=Math.min(counts.length,dff.limit >= 0 ? dff.offset + dff.limit : Integer.MAX_VALUE);
    long smallestCount=counts.length == 0 ? 0 : counts[ntop - 1].count;
    for (int i=0; i < counts.length; i++) {
      ShardFacetCount sfc=counts[i];
      boolean needRefinement=false;
      if (i < ntop) {
        needRefinement=true;
      }
 else {
        long maxCount=sfc.count;
        for (int shardNum=0; shardNum < rb.shards.length; shardNum++) {
          OpenBitSet obs=dff.counted[shardNum];
          if (!obs.get(sfc.termNum)) {
            maxCount+=dff.maxPossible(sfc,shardNum);
          }
        }
        if (maxCount >= smallestCount) {
          needRefinement=true;
        }
      }
      if (needRefinement) {
        for (int shardNum=0; shardNum < rb.shards.length; shardNum++) {
          OpenBitSet obs=dff.counted[shardNum];
          if (!obs.get(sfc.termNum) && dff.maxPossible(sfc,shardNum) > 0) {
            dff.needRefinements=true;
            List<String> lst=dff._toRefine[shardNum];
            if (lst == null) {
              lst=dff._toRefine[shardNum]=new ArrayList<String>();
            }
            lst.add(sfc.name);
          }
        }
      }
    }
  }
}
