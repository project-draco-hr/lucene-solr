{
  if (!rb.doFacets) {
    return ResponseBuilder.STAGE_DONE;
  }
  if (rb.stage == ResponseBuilder.STAGE_GET_FIELDS) {
    for (int shardNum=0; shardNum < rb.shards.length; shardNum++) {
      List<String> refinements=null;
      for (      DistribFieldFacet dff : rb._facetInfo.facets.values()) {
        if (!dff.needRefinements)         continue;
        List<String> refList=dff._toRefine[shardNum];
        if (refList == null || refList.size() == 0)         continue;
        String key=dff.getKey();
        String termsKey=key + "__terms";
        String termsVal=StrUtils.join(refList,',');
        String facetCommand;
        if (dff.localParams != null) {
          facetCommand=commandPrefix + termsKey + " "+ dff.facetStr.substring(2);
        }
 else {
          facetCommand=commandPrefix + termsKey + '}'+ dff.field;
        }
        if (refinements == null) {
          refinements=new ArrayList<String>();
        }
        refinements.add(facetCommand);
        refinements.add(termsKey);
        refinements.add(termsVal);
      }
      if (refinements == null)       continue;
      String shard=rb.shards[shardNum];
      ShardRequest refine=null;
      boolean newRequest=false;
      for (      ShardRequest sreq : rb.outgoing) {
        if ((sreq.purpose & ShardRequest.PURPOSE_GET_FIELDS) != 0 && sreq.shards != null && sreq.shards.length == 1 && sreq.shards[0].equals(shard)) {
          refine=sreq;
          break;
        }
      }
      if (refine == null) {
        newRequest=true;
        refine=new ShardRequest();
        refine.shards=new String[]{rb.shards[shardNum]};
        refine.params=new ModifiableSolrParams(rb.req.getParams());
        refine.params.remove(CommonParams.START);
        refine.params.set(CommonParams.ROWS,"0");
      }
      refine.purpose|=ShardRequest.PURPOSE_REFINE_FACETS;
      refine.params.set(FacetParams.FACET,"true");
      refine.params.remove(FacetParams.FACET_FIELD);
      refine.params.remove(FacetParams.FACET_QUERY);
      for (int i=0; i < refinements.size(); ) {
        String facetCommand=refinements.get(i++);
        String termsKey=refinements.get(i++);
        String termsVal=refinements.get(i++);
        refine.params.add(FacetParams.FACET_FIELD,facetCommand);
        refine.params.set(termsKey,termsVal);
      }
      if (newRequest) {
        rb.addRequest(this,refine);
      }
    }
  }
  return ResponseBuilder.STAGE_DONE;
}
