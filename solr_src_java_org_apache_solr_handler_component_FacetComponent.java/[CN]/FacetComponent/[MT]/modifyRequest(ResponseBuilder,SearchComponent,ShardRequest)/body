{
  if (!rb.doFacets)   return;
  if ((sreq.purpose & ShardRequest.PURPOSE_GET_TOP_IDS) != 0) {
    sreq.purpose|=ShardRequest.PURPOSE_GET_FACETS;
    FacetInfo fi=rb._facetInfo;
    if (fi == null) {
      rb._facetInfo=fi=new FacetInfo();
      fi.parse(rb.req.getParams(),rb);
    }
    sreq.params.remove(FacetParams.FACET_MINCOUNT);
    sreq.params.remove(FacetParams.FACET_OFFSET);
    sreq.params.remove(FacetParams.FACET_LIMIT);
    for (    DistribFieldFacet dff : fi.facets.values()) {
      String paramStart="f." + dff.field + '.';
      sreq.params.remove(paramStart + FacetParams.FACET_MINCOUNT);
      sreq.params.remove(paramStart + FacetParams.FACET_OFFSET);
      dff.initialLimit=dff.offset + dff.limit;
      if (dff.sort.equals(FacetParams.FACET_SORT_COUNT) && dff.limit > 0) {
        dff.initialLimit=(int)(dff.initialLimit * 1.5) + 10;
      }
      dff.initialLimit=rb.req.getParams().getInt("facet.shard.limit",dff.initialLimit);
      sreq.params.set(paramStart + FacetParams.FACET_LIMIT,dff.initialLimit);
    }
  }
 else {
    sreq.params.set(FacetParams.FACET,"false");
  }
}
