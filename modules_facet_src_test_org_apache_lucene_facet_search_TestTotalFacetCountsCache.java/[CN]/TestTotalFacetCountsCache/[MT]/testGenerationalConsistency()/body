{
  Directory[][] dirs=FacetTestUtils.createIndexTaxonomyDirs(1);
  IndexTaxonomyWriterPair[] writers=FacetTestUtils.createIndexTaxonomyWriterPair(dirs);
  DefaultFacetIndexingParams iParams=new DefaultFacetIndexingParams();
  addFacets(iParams,writers[0].indexWriter,writers[0].taxWriter,"a","b");
  writers[0].indexWriter.commit();
  writers[0].taxWriter.commit();
  IndexTaxonomyReaderPair[] readers=FacetTestUtils.createIndexTaxonomyReaderPair(dirs);
  TotalFacetCounts totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  int prevGen=assertRecomputed(totalCounts,0,"after first attempt to get it!");
  assertTrue("Should be obtained from cache at 2nd attempt",totalCounts == TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null));
  initCache();
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertRecomputed(totalCounts,prevGen,"after cache clear, 3rd attempt to get it!");
  File outputFile=_TestUtil.createTempFile("test","tmp",TEMP_DIR);
  initCache();
  TFC.store(outputFile,readers[0].indexReader,readers[0].taxReader,iParams,null);
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertRecomputed(totalCounts,prevGen,"after cache clear, 4th attempt to get it!");
  initCache();
  TFC.load(outputFile,readers[0].indexReader,readers[0].taxReader,iParams);
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertReadFromDisc(totalCounts,prevGen,"after 5th attempt to get it!");
  addFacets(iParams,writers[0].indexWriter,writers[0].taxWriter,"c","d");
  writers[0].indexWriter.close();
  writers[0].taxWriter.close();
  readers[0].taxReader.refresh();
  IndexReader r2=readers[0].indexReader.reopen();
  IndexReader origReader=null;
  assertTrue("Reader must be updated!",readers[0].indexReader != r2);
  origReader=readers[0].indexReader;
  readers[0].indexReader=r2;
  assertTrue("Should be obtained from cache at 6th attempt",totalCounts == TFC.getTotalCounts(origReader,readers[0].taxReader,iParams,null));
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertRecomputed(totalCounts,prevGen,"after updating the index - 7th attempt!");
  assertTrue("Should be obtained from cache at 8th attempt",totalCounts == TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null));
  origReader.close();
  origReader=readers[0].indexReader;
  readers[0].indexReader=IndexReader.open(origReader.directory(),false);
  initCache();
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertRecomputed(totalCounts,prevGen,"after opening a writable reader - 9th attempt!");
  readers[0].indexReader.deleteDocument(1);
  readers[0].indexReader.commit(null);
  totalCounts=TFC.getTotalCounts(readers[0].indexReader,readers[0].taxReader,iParams,null);
  prevGen=assertRecomputed(totalCounts,prevGen,"after deleting docs the index - 10th attempt!");
  origReader.close();
  readers[0].close();
  r2.close();
  outputFile.delete();
}
