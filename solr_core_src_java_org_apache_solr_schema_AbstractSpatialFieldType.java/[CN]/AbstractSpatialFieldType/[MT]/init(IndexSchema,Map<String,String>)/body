{
  super.init(schema,args);
  if (ctx == null) {
    MapListener<String,String> argsWrap=new MapListener<>(args);
    ctx=SpatialContextFactory.makeSpatialContext(argsWrap,schema.getResourceLoader().getClassLoader());
    args.keySet().removeAll(argsWrap.getSeenKeys());
  }
  final String distanceUnitsStr=args.remove("distanceUnits");
  if (distanceUnitsStr == null) {
    this.distanceUnits=ctx.isGeo() ? DistanceUnits.KILOMETERS : DistanceUnits.DEGREES;
  }
 else {
    this.distanceUnits=parseDistanceUnits(distanceUnitsStr);
    if (this.distanceUnits == null)     throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Must specify distanceUnits as one of " + DistanceUnits.getSupportedUnits() + " on field types with class "+ getClass().getSimpleName());
  }
  final SupportedFormats fmts=ctx.getFormats();
  final String format=args.remove(FORMAT);
  if (format != null) {
    shapeWriter=fmts.getWriter(format);
    shapeReader=fmts.getReader(format);
    if (shapeWriter == null) {
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Unknown Shape Format: " + format);
    }
    if (shapeReader == null) {
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Unknown Shape Format: " + format);
    }
  }
 else {
    shapeWriter=fmts.getWriters().get(0);
    shapeReader=fmts.getReaders().get(0);
  }
  argsParser=newSpatialArgsParser();
}
