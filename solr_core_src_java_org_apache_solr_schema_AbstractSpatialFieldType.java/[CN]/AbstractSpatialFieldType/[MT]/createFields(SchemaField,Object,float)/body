{
  String shapeStr=null;
  Shape shape=null;
  if (val instanceof Shape) {
    shape=((Shape)val);
  }
 else {
    shapeStr=val.toString();
    shape=ctx.readShape(shapeStr);
  }
  if (shape == null) {
    log.debug("Field {}: null shape for input: {}",field,val);
    return null;
  }
  Field[] indexableFields=null;
  if (field.indexed()) {
    T strategy=getStrategy(field.getName());
    indexableFields=strategy.createIndexableFields(shape);
  }
  StoredField storedField=null;
  if (field.stored()) {
    if (shapeStr == null)     shapeStr=shapeToString(shape);
    storedField=new StoredField(field.getName(),shapeStr);
  }
  if (indexableFields == null) {
    if (storedField == null)     return null;
    return new Field[]{storedField};
  }
 else {
    if (storedField == null)     return indexableFields;
    Field[] result=new Field[indexableFields.length + 1];
    System.arraycopy(indexableFields,0,result,0,indexableFields.length);
    result[result.length - 1]=storedField;
    return result;
  }
}
