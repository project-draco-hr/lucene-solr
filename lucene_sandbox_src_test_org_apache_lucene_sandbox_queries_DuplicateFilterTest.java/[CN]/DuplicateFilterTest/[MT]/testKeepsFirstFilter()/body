{
  DuplicateFilter df=new DuplicateFilter(KEY_FIELD);
  df.setKeepMode(DuplicateFilter.KeepMode.KM_USE_FIRST_OCCURRENCE);
  ScoreDoc[] hits=searcher.search(new FilteredQuery(tq,df),1000).scoreDocs;
  assertTrue("Filtered searching should have found some matches",hits.length > 0);
  for (  ScoreDoc hit : hits) {
    StoredDocument d=searcher.doc(hit.doc);
    String url=d.get(KEY_FIELD);
    PostingsEnum td=TestUtil.docs(random(),reader,KEY_FIELD,new BytesRef(url),MultiFields.getLiveDocs(reader),null,0);
    int lastDoc=0;
    td.nextDoc();
    lastDoc=td.docID();
    assertEquals("Duplicate urls should return first doc",lastDoc,hit.doc);
  }
}
