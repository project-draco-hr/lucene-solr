{
  Iterable<BytesRef> values=LegacyDocValuesIterables.valuesIterable(valuesProducer.getSortedSet(field));
  Iterable<Number> docToOrdCount=LegacyDocValuesIterables.sortedSetOrdCountIterable(valuesProducer,field,maxDoc);
  Iterable<Number> ords=LegacyDocValuesIterables.sortedSetOrdsIterable(valuesProducer,field);
  meta.writeVInt(field.number);
  meta.writeByte(Lucene70DocValuesFormat.SORTED_SET);
  if (isSingleValued(docToOrdCount)) {
    meta.writeVInt(SORTED_SINGLE_VALUED);
    addSortedField(field,values,singletonView(docToOrdCount,ords,-1L));
  }
 else {
    final SortedSet<LongsRef> uniqueValueSets=uniqueValueSets(docToOrdCount,ords);
    if (uniqueValueSets != null) {
      meta.writeVInt(SORTED_SET_TABLE);
      writeDictionary(uniqueValueSets);
      addTermsDict(field,values);
      addNumericField(field,docToSetId(uniqueValueSets,docToOrdCount,ords),NumberType.ORDINAL);
    }
 else {
      meta.writeVInt(SORTED_WITH_ADDRESSES);
      addTermsDict(field,values);
      addNumericField(field,ords,NumberType.ORDINAL);
      addOrdIndex(field,docToOrdCount);
    }
  }
}
