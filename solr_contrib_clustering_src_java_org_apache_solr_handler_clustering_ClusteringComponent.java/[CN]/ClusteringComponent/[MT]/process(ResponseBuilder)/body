{
  SolrParams params=rb.req.getParams();
  if (!params.getBool(COMPONENT_NAME,false)) {
    return;
  }
  String name=getClusteringEngineName(rb);
  boolean useResults=params.getBool(ClusteringParams.USE_SEARCH_RESULTS,false);
  if (useResults == true) {
    SearchClusteringEngine engine=getSearchClusteringEngine(rb);
    if (engine != null) {
      DocListAndSet results=rb.getResults();
      Map<SolrDocument,Integer> docIds=new HashMap<SolrDocument,Integer>(results.docList.size());
      SolrDocumentList solrDocList=engine.getSolrDocumentList(results.docList,rb.req,docIds);
      Object clusters=engine.cluster(rb.getQuery(),solrDocList,docIds,rb.req);
      rb.rsp.add("clusters",clusters);
    }
 else {
      log.warn("No engine for: " + name);
    }
  }
  boolean useCollection=params.getBool(ClusteringParams.USE_COLLECTION,false);
  if (useCollection == true) {
    DocumentClusteringEngine engine=documentClusteringEngines.get(name);
    if (engine != null) {
      boolean useDocSet=params.getBool(ClusteringParams.USE_DOC_SET,false);
      NamedList nl=null;
      if (useDocSet == true) {
        nl=engine.cluster(rb.getResults().docSet,params);
      }
 else {
        nl=engine.cluster(params);
      }
      rb.rsp.add("clusters",nl);
    }
 else {
      log.warn("No engine for " + name);
    }
  }
}
