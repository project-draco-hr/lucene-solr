{
  SolrParams params=rb.req.getParams();
  if (!params.getBool(COMPONENT_NAME,false) || !params.getBool(ClusteringParams.USE_SEARCH_RESULTS,false)) {
    return;
  }
  if (rb.stage == ResponseBuilder.STAGE_GET_FIELDS) {
    SearchClusteringEngine engine=getSearchClusteringEngine(rb);
    if (engine != null) {
      SolrDocumentList solrDocList=(SolrDocumentList)rb.rsp.getValues().get("response");
      Map<SolrDocument,Integer> docIds=null;
      Object clusters=engine.cluster(rb.getQuery(),solrDocList,docIds,rb.req);
      rb.rsp.add("clusters",clusters);
    }
 else {
      String name=getClusteringEngineName(rb);
      log.warn("No engine for: " + name);
    }
  }
}
