{
  String collection1="solrj_collection";
  Create createCollectionRequest=new Create().setCollectionName(collection1).setNumShards(2).setReplicationFactor(2).setMaxShardsPerNode(2).setConfigName("conf1").setRouterField("myOwnField").setAutoAddReplicas(true);
  CollectionAdminResponse response=createCollectionRequest.process(cloudClient);
  assertEquals(0,response.getStatus());
  assertTrue(response.isSuccess());
  waitForRecoveriesToFinish(collection1,false);
  String collection2="solrj_collection2";
  createCollectionRequest=new Create().setCollectionName(collection2).setNumShards(2).setReplicationFactor(2).setMaxShardsPerNode(2).setConfigName("conf1").setRouterField("myOwnField").setAutoAddReplicas(false);
  CollectionAdminResponse response2=createCollectionRequest.process(getCommonCloudSolrClient());
  assertEquals(0,response2.getStatus());
  assertTrue(response2.isSuccess());
  waitForRecoveriesToFinish(collection2,false);
  String collection3="solrj_collection3";
  createCollectionRequest=new Create().setCollectionName(collection3).setNumShards(5).setReplicationFactor(1).setMaxShardsPerNode(1).setConfigName("conf1").setRouterField("myOwnField").setAutoAddReplicas(true);
  CollectionAdminResponse response3=createCollectionRequest.process(getCommonCloudSolrClient());
  assertEquals(0,response3.getStatus());
  assertTrue(response3.isSuccess());
  waitForRecoveriesToFinish(collection3,false);
  ChaosMonkey.stop(jettys.get(1));
  ChaosMonkey.stop(jettys.get(2));
  Thread.sleep(5000);
  assertTrue("Timeout waiting for all live and active",ClusterStateUtil.waitForAllActiveAndLiveReplicas(cloudClient.getZkStateReader(),collection1,120000));
  assertSliceAndReplicaCount(collection1);
  assertEquals(4,ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection1));
  assertTrue(ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection2) < 4);
  ClusterStateUtil.waitForLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection3,3,30000);
  assertEquals(4,ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection1));
  assertTrue(ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection2) < 4);
  ChaosMonkey.stop(jettys);
  ChaosMonkey.stop(controlJetty);
  assertTrue("Timeout waiting for all not live",ClusterStateUtil.waitForAllReplicasNotLive(cloudClient.getZkStateReader(),45000));
  ChaosMonkey.start(jettys);
  ChaosMonkey.start(controlJetty);
  assertTrue("Timeout waiting for all live and active",ClusterStateUtil.waitForAllActiveAndLiveReplicas(cloudClient.getZkStateReader(),collection1,120000));
  assertSliceAndReplicaCount(collection1);
  assertSingleReplicationAndShardSize(collection3,5);
  int jettyIndex=random().nextInt(jettys.size());
  ChaosMonkey.stop(jettys.get(jettyIndex));
  ChaosMonkey.start(jettys.get(jettyIndex));
  assertTrue("Timeout waiting for all live and active",ClusterStateUtil.waitForAllActiveAndLiveReplicas(cloudClient.getZkStateReader(),collection1,60000));
  assertSliceAndReplicaCount(collection1);
  assertSingleReplicationAndShardSize(collection3,5);
  ClusterStateUtil.waitForLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection3,5,30000);
  Map m=makeMap("action",CollectionParams.CollectionAction.CLUSTERPROP.toLower(),"name",ZkStateReader.AUTO_ADD_REPLICAS,"val","false");
  SolrRequest request=new QueryRequest(new MapSolrParams(m));
  request.setPath("/admin/collections");
  cloudClient.request(request);
  int currentCount=ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection1);
  ChaosMonkey.stop(jettys.get(3));
  Thread.sleep(30000);
  assertTrue(currentCount > ClusterStateUtil.getLiveAndActiveReplicaCount(cloudClient.getZkStateReader(),collection1));
  m=makeMap("action",CollectionParams.CollectionAction.CLUSTERPROP.toLower(),"name",ZkStateReader.AUTO_ADD_REPLICAS);
  request=new QueryRequest(new MapSolrParams(m));
  request.setPath("/admin/collections");
  cloudClient.request(request);
  assertTrue("Timeout waiting for all live and active",ClusterStateUtil.waitForAllActiveAndLiveReplicas(cloudClient.getZkStateReader(),collection1,60000));
  assertSliceAndReplicaCount(collection1);
}
