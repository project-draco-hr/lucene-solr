{
  int NUM_THREADS=3;
  for (int iter=0; iter < 2; iter++) {
    if (VERBOSE) {
      System.out.println("TEST: iter=" + iter);
    }
    MockDirectoryWrapper dir=newMockDirectory();
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDocs(2).setMergeScheduler(new ConcurrentMergeScheduler()).setMergePolicy(newLogMergePolicy(4)));
    ((ConcurrentMergeScheduler)writer.getConfig().getMergeScheduler()).setSuppressExceptions();
    IndexerThread[] threads=new IndexerThread[NUM_THREADS];
    for (int i=0; i < NUM_THREADS; i++)     threads[i]=new IndexerThread(writer,true);
    for (int i=0; i < NUM_THREADS; i++)     threads[i].start();
    Thread.sleep(10);
    dir.failOn(failure);
    failure.setDoFail();
    for (int i=0; i < NUM_THREADS; i++) {
      threads[i].join();
      assertTrue("hit unexpected Throwable",threads[i].error == null);
    }
    boolean success=false;
    try {
      writer.shutdown(false);
      success=true;
    }
 catch (    IOException ioe) {
      failure.clearDoFail();
      writer.close();
    }
    if (VERBOSE) {
      System.out.println("TEST: success=" + success);
    }
    if (success) {
      IndexReader reader=DirectoryReader.open(dir);
      final Bits delDocs=MultiFields.getLiveDocs(reader);
      for (int j=0; j < reader.maxDoc(); j++) {
        if (delDocs == null || !delDocs.get(j)) {
          reader.document(j);
          reader.getTermVectors(j);
        }
      }
      reader.close();
    }
    dir.close();
  }
}
