{
  final MockDirectoryWrapper dir=newDirectory();
  CountDownLatch oneIWConstructed=new CountDownLatch(1);
  DelayedIndexAndCloseRunnable thread1=new DelayedIndexAndCloseRunnable(dir,oneIWConstructed);
  DelayedIndexAndCloseRunnable thread2=new DelayedIndexAndCloseRunnable(dir,oneIWConstructed);
  thread1.start();
  thread2.start();
  oneIWConstructed.await();
  thread1.startIndexing();
  thread2.startIndexing();
  thread1.join();
  thread2.join();
  assertFalse("Failed due to: " + thread1.failure,thread1.failed);
  assertFalse("Failed due to: " + thread2.failure,thread2.failed);
  IndexReader reader=DirectoryReader.open(dir);
  assertEquals("IndexReader should have one document per thread running",2,reader.numDocs());
  reader.close();
  dir.close();
}
