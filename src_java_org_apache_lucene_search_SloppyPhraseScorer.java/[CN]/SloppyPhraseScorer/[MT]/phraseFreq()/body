{
  int end=initPhrasePositions();
  float freq=0.0f;
  boolean done=(end < 0);
  while (!done) {
    PhrasePositions pp=(PhrasePositions)pq.pop();
    int start=pp.position;
    int next=((PhrasePositions)pq.top()).position;
    boolean tpsDiffer=true;
    for (int pos=start; pos <= next || !tpsDiffer; pos=pp.position) {
      if (pos <= next && tpsDiffer)       start=pos;
      if (!pp.nextPosition()) {
        done=true;
        break;
      }
      PhrasePositions pp2=null;
      tpsDiffer=!pp.repeats || (pp2=termPositionsDiffer(pp)) == null;
      if (pp2 != null && pp2 != pp) {
        pp=flip(pp,pp2);
      }
    }
    int matchLength=end - start;
    if (matchLength <= slop)     freq+=getSimilarity().sloppyFreq(matchLength);
    if (pp.position > end)     end=pp.position;
    pq.put(pp);
  }
  return freq;
}
