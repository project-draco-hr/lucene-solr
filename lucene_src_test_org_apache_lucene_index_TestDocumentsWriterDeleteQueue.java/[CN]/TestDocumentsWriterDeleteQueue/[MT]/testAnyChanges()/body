{
  DocumentsWriterDeleteQueue queue=new DocumentsWriterDeleteQueue();
  Term template=new Term("id");
  final int size=200 + random.nextInt(500) * RANDOM_MULTIPLIER;
  int termsSinceFreeze=0;
  int queriesSinceFreeze=0;
  for (int i=0; i < size; i++) {
    Term term=template.createTerm("" + i);
    if (random.nextInt(10) == 0) {
      queue.addDelete(new TermQuery(term));
      queriesSinceFreeze++;
    }
 else {
      queue.addDelete(term);
      termsSinceFreeze++;
    }
    assertTrue(queue.anyChanges());
    if (random.nextInt(5) == 0) {
      FrozenBufferedDeletes freezeGlobalBuffer=queue.freezeGlobalBuffer(null);
      assertEquals(termsSinceFreeze,freezeGlobalBuffer.terms.length);
      assertEquals(queriesSinceFreeze,freezeGlobalBuffer.queries.length);
      queriesSinceFreeze=0;
      termsSinceFreeze=0;
      assertFalse(queue.anyChanges());
    }
  }
}
