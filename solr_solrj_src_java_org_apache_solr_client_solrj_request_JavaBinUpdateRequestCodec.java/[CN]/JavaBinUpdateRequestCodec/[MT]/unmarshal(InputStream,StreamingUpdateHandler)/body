{
  final UpdateRequest updateRequest=new UpdateRequest();
  List<List<NamedList>> doclist;
  Map<SolrInputDocument,Map<String,Object>> docMap;
  List<String> delById;
  Map<String,Long> delByIdMap;
  List<String> delByQ;
  final NamedList[] namedList=new NamedList[1];
  JavaBinCodec codec=new JavaBinCodec(){
    private boolean seenOuterMostDocIterator=false;
    @Override public NamedList readNamedList(    DataInputInputStream dis) throws IOException {
      int sz=readSize(dis);
      NamedList nl=new NamedList();
      if (namedList[0] == null) {
        namedList[0]=nl;
      }
      for (int i=0; i < sz; i++) {
        String name=(String)readVal(dis);
        Object val=readVal(dis);
        nl.add(name,val);
      }
      return nl;
    }
    @Override public List readIterator(    DataInputInputStream fis) throws IOException {
      if (seenOuterMostDocIterator)       return super.readIterator(fis);
      seenOuterMostDocIterator=true;
      return readOuterMostDocIterator(fis);
    }
    private List readOuterMostDocIterator(    DataInputInputStream fis) throws IOException {
      NamedList params=(NamedList)namedList[0].getVal(0);
      updateRequest.setParams(new ModifiableSolrParams(SolrParams.toSolrParams(params)));
      if (handler == null)       return super.readIterator(fis);
      while (true) {
        Object o=readVal(fis);
        if (o == END_OBJ)         break;
        SolrInputDocument sdoc=null;
        if (o instanceof List) {
          sdoc=listToSolrInputDocument((List<NamedList>)o);
        }
 else         if (o instanceof NamedList) {
          UpdateRequest req=new UpdateRequest();
          req.setParams(new ModifiableSolrParams(SolrParams.toSolrParams((NamedList)o)));
          handler.update(null,req);
        }
 else {
          sdoc=(SolrInputDocument)o;
        }
        handler.update(sdoc,updateRequest);
      }
      return Collections.EMPTY_LIST;
    }
  }
;
  codec.unmarshal(is);
  if (updateRequest.getParams() == null) {
    NamedList params=(NamedList)namedList[0].get("params");
    if (params != null) {
      updateRequest.setParams(new ModifiableSolrParams(SolrParams.toSolrParams(params)));
    }
  }
  delById=(List<String>)namedList[0].get("delById");
  delByIdMap=(Map<String,Long>)namedList[0].get("delByIdMap");
  delByQ=(List<String>)namedList[0].get("delByQ");
  doclist=(List)namedList[0].get("docs");
  docMap=(Map<SolrInputDocument,Map<String,Object>>)namedList[0].get("docsMap");
  if (doclist != null && !doclist.isEmpty()) {
    List<SolrInputDocument> solrInputDocs=new ArrayList<SolrInputDocument>();
    for (    Object o : doclist) {
      if (o instanceof List) {
        solrInputDocs.add(listToSolrInputDocument((List<NamedList>)o));
      }
 else {
        solrInputDocs.add((SolrInputDocument)o);
      }
    }
    updateRequest.add(solrInputDocs);
  }
  if (docMap != null && !docMap.isEmpty()) {
    Set<Entry<SolrInputDocument,Map<String,Object>>> entries=docMap.entrySet();
    for (    Entry<SolrInputDocument,Map<String,Object>> entry : entries) {
      Map<String,Object> map=entry.getValue();
      Boolean overwrite=null;
      Integer commitWithin=null;
      if (map != null) {
        overwrite=(Boolean)map.get(UpdateRequest.OVERWRITE);
        commitWithin=(Integer)map.get(UpdateRequest.COMMIT_WITHIN);
      }
      updateRequest.add(entry.getKey(),commitWithin,overwrite);
    }
  }
  if (delById != null) {
    for (    String s : delById) {
      updateRequest.deleteById(s);
    }
  }
  if (delByIdMap != null) {
    for (    Map.Entry<String,Long> entry : delByIdMap.entrySet()) {
      updateRequest.deleteById(entry.getKey(),entry.getValue());
    }
  }
  if (delByQ != null) {
    for (    String s : delByQ) {
      updateRequest.deleteByQuery(s);
    }
  }
  return updateRequest;
}
