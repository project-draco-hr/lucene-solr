{
  CloudSolrClient destinationCollectionClient=createCloudClient("destinationCollection");
  createCollection("destinationCollection",destinationCollectionClient,2,2);
  indexr(id,"0","a_s","hello0","a_i","0","a_f","0","s_multi","aaaa","s_multi","bbbb","i_multi","4","i_multi","7");
  indexr(id,"2","a_s","hello2","a_i","2","a_f","0","s_multi","aaaa1","s_multi","bbbb1","i_multi","44","i_multi","77");
  indexr(id,"3","a_s","hello3","a_i","3","a_f","3","s_multi","aaaa2","s_multi","bbbb2","i_multi","444","i_multi","777");
  indexr(id,"4","a_s","hello4","a_i","4","a_f","4","s_multi","aaaa3","s_multi","bbbb3","i_multi","4444","i_multi","7777");
  indexr(id,"1","a_s","hello1","a_i","1","a_f","1","s_multi","aaaa4","s_multi","bbbb4","i_multi","44444","i_multi","77777");
  commit();
  waitForRecoveriesToFinish("destinationCollection",false);
  StreamExpression expression;
  TupleStream stream;
  Tuple t;
  StreamFactory factory=new StreamFactory().withCollectionZkHost("collection1",zkServer.getZkAddress()).withCollectionZkHost("destinationCollection",zkServer.getZkAddress()).withFunctionName("search",CloudSolrStream.class).withFunctionName("update",UpdateStream.class);
  expression=StreamExpressionParser.parse("update(destinationCollection, batchSize=5, search(collection1, q=*:*, fl=\"id,a_s,a_i,a_f,s_multi,i_multi\", sort=\"a_f asc, a_i asc\"))");
  stream=new UpdateStream(expression,factory);
  List<Tuple> tuples=getTuples(stream);
  destinationCollectionClient.commit();
  assert(tuples.size() == 1);
  t=tuples.get(0);
  assert(t.EOF == false);
  assertEquals(5,t.get("batchIndexed"));
  expression=StreamExpressionParser.parse("search(destinationCollection, q=*:*, fl=\"id,a_s,a_i,a_f,s_multi,i_multi\", sort=\"a_i asc\")");
  stream=new CloudSolrStream(expression,factory);
  tuples=getTuples(stream);
  assertEquals(5,tuples.size());
  Tuple tuple=tuples.get(0);
  assert(tuple.getLong("id") == 0);
  assert(tuple.get("a_s").equals("hello0"));
  assert(tuple.getLong("a_i") == 0);
  assert(tuple.getDouble("a_f") == 0.0);
  assertList(tuple.getStrings("s_multi"),"aaaa","bbbb");
  assertList(tuple.getLongs("i_multi"),Long.parseLong("4"),Long.parseLong("7"));
  tuple=tuples.get(1);
  assert(tuple.getLong("id") == 1);
  assert(tuple.get("a_s").equals("hello1"));
  assert(tuple.getLong("a_i") == 1);
  assert(tuple.getDouble("a_f") == 1.0);
  assertList(tuple.getStrings("s_multi"),"aaaa4","bbbb4");
  assertList(tuple.getLongs("i_multi"),Long.parseLong("44444"),Long.parseLong("77777"));
  tuple=tuples.get(2);
  assert(tuple.getLong("id") == 2);
  assert(tuple.get("a_s").equals("hello2"));
  assert(tuple.getLong("a_i") == 2);
  assert(tuple.getDouble("a_f") == 0.0);
  assertList(tuple.getStrings("s_multi"),"aaaa1","bbbb1");
  assertList(tuple.getLongs("i_multi"),Long.parseLong("44"),Long.parseLong("77"));
  tuple=tuples.get(3);
  assert(tuple.getLong("id") == 3);
  assert(tuple.get("a_s").equals("hello3"));
  assert(tuple.getLong("a_i") == 3);
  assert(tuple.getDouble("a_f") == 3.0);
  assertList(tuple.getStrings("s_multi"),"aaaa2","bbbb2");
  assertList(tuple.getLongs("i_multi"),Long.parseLong("444"),Long.parseLong("777"));
  tuple=tuples.get(4);
  assert(tuple.getLong("id") == 4);
  assert(tuple.get("a_s").equals("hello4"));
  assert(tuple.getLong("a_i") == 4);
  assert(tuple.getDouble("a_f") == 4.0);
  assertList(tuple.getStrings("s_multi"),"aaaa3","bbbb3");
  assertList(tuple.getLongs("i_multi"),Long.parseLong("4444"),Long.parseLong("7777"));
  destinationCollectionClient.deleteByQuery("*:*");
  destinationCollectionClient.commit();
  destinationCollectionClient.close();
  del("*:*");
  commit();
}
