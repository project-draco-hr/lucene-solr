{
  super(searcher,docs,request);
  this.analyticsRequest=request;
  this.queryRequest=queryRequest;
  basicsAndFieldFacetsComputed=false;
  List<FieldFacetRequest> fieldFreqs=request.getFieldFacets();
  List<RangeFacetRequest> rangeFreqs=request.getRangeFacets();
  List<QueryFacetRequest> queryFreqs=request.getQueryFacets();
  this.fieldFacetExpressions=new LinkedHashMap<String,Map<String,Expression[]>>(fieldFreqs.size());
  this.rangeFacetExpressions=new LinkedHashMap<String,Map<String,Expression[]>>(rangeFreqs.size());
  this.queryFacetExpressions=new LinkedHashMap<String,Map<String,Expression[]>>(queryFreqs.size());
  this.fieldFacetCollectors=new LinkedHashMap<String,Map<String,StatsCollector[]>>(fieldFreqs.size());
  this.rangeFacetCollectors=new LinkedHashMap<String,Map<String,StatsCollector[]>>(rangeFreqs.size());
  this.queryFacetCollectors=new LinkedHashMap<String,Map<String,StatsCollector[]>>(queryFreqs.size());
  this.facetAccumulators=new ArrayList<FieldFacetAccumulator>();
  this.hiddenFieldFacets=new HashSet<String>();
  for (  FieldFacetRequest freq : fieldFreqs) {
    final FieldFacetRequest fr=(FieldFacetRequest)freq;
    if (fr.isHidden()) {
      hiddenFieldFacets.add(fr.getName());
    }
    final SchemaField ff=fr.getField();
    final FieldFacetAccumulator facc=FieldFacetAccumulator.create(searcher,this,ff);
    facetAccumulators.add(facc);
    fieldFacetExpressions.put(freq.getName(),new LinkedHashMap<String,Expression[]>());
    fieldFacetCollectors.put(freq.getName(),new LinkedHashMap<String,StatsCollector[]>());
  }
  for (  RangeFacetRequest freq : rangeFreqs) {
    if (rangeFacets == null)     rangeFacets=new ArrayList<RangeFacetRequest>();
    rangeFacets.add(freq);
    rangeFacetExpressions.put(freq.getName(),new LinkedHashMap<String,Expression[]>());
    rangeFacetCollectors.put(freq.getName(),new LinkedHashMap<String,StatsCollector[]>());
  }
  for (  QueryFacetRequest freq : queryFreqs) {
    if (queryFacets == null)     queryFacets=new ArrayList<QueryFacetRequest>();
    queryFacets.add(freq);
    queryFacetExpressions.put(freq.getName(),new LinkedHashMap<String,Expression[]>());
    queryFacetCollectors.put(freq.getName(),new LinkedHashMap<String,StatsCollector[]>());
  }
  this.queryCount=0l;
}
