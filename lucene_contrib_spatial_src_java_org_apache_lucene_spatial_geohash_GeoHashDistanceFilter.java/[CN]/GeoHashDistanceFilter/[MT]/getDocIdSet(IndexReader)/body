{
  final DocTerms geoHashValues=FieldCache.DEFAULT.getTerms(reader,geoHashField);
  final BytesRef br=new BytesRef();
  final int docBase=nextDocBase;
  nextDocBase+=reader.maxDoc();
  return new FilteredDocIdSet(startingFilter.getDocIdSet(reader)){
    @Override public boolean match(    int doc){
      String geoHash=geoHashValues.getTerm(doc,br).utf8ToString();
      double[] coords=GeoHashUtils.decode(geoHash);
      double x=coords[0];
      double y=coords[1];
      Double cachedDistance=distanceLookupCache.get(geoHash);
      double d;
      if (cachedDistance != null) {
        d=cachedDistance.doubleValue();
      }
 else {
        d=DistanceUtils.getDistanceMi(lat,lng,x,y);
        distanceLookupCache.put(geoHash,d);
      }
      if (d < distance) {
        distances.put(doc + docBase,d);
        return true;
      }
 else {
        return false;
      }
    }
  }
;
}
