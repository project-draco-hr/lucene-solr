{
  Map<FieldInfo,DocFieldConsumerPerField> childFields=new HashMap<FieldInfo,DocFieldConsumerPerField>();
  Collection<DocFieldConsumerPerField> fields=fields();
  for (  DocFieldConsumerPerField f : fields) {
    childFields.put(f.getFieldInfo(),f);
  }
  fieldsWriter.flush(state);
  consumer.flush(childFields,state);
  for (  DocValuesConsumerAndDocID consumer : docValues.values()) {
    consumer.docValuesConsumer.finish(state.numDocs);
  }
  FieldInfosWriter infosWriter=codec.fieldInfosFormat().getFieldInfosWriter();
  infosWriter.write(state.directory,state.segmentName,state.fieldInfos,IOContext.DEFAULT);
  IOUtils.close(perDocConsumer);
}
