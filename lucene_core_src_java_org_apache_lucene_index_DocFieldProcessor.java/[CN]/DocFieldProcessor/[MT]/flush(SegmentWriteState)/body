{
  Map<String,DocFieldConsumerPerField> childFields=new HashMap<String,DocFieldConsumerPerField>();
  Collection<DocFieldConsumerPerField> fields=fields();
  for (  DocFieldConsumerPerField f : fields) {
    childFields.put(f.getFieldInfo().name,f);
  }
  fieldsWriter.flush(state);
  consumer.flush(childFields,state);
  for (  DocValuesConsumerHolder consumer : docValues.values()) {
    consumer.docValuesConsumer.finish(state.segmentInfo.getDocCount());
  }
  IOUtils.close(perDocConsumer);
  FieldInfosWriter infosWriter=codec.fieldInfosFormat().getFieldInfosWriter();
  infosWriter.write(state.directory,state.segmentInfo.name,state.fieldInfos,IOContext.DEFAULT);
}
