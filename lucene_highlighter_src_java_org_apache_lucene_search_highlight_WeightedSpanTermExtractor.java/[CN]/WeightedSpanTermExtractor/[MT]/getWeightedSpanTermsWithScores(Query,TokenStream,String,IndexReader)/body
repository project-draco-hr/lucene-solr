{
  if (fieldName != null) {
    this.fieldName=fieldName;
  }
 else {
    this.fieldName=null;
  }
  this.tokenStream=tokenStream;
  Map<String,WeightedSpanTerm> terms=new PositionCheckingMap<String>();
  extract(query,terms);
  int totalNumDocs=reader.maxDoc();
  Set<String> weightedTerms=terms.keySet();
  Iterator<String> it=weightedTerms.iterator();
  try {
    while (it.hasNext()) {
      WeightedSpanTerm weightedSpanTerm=terms.get(it.next());
      int docFreq=reader.docFreq(new Term(fieldName,weightedSpanTerm.term));
      float idf=(float)(Math.log(totalNumDocs / (double)(docFreq + 1)) + 1.0);
      weightedSpanTerm.weight*=idf;
    }
  }
  finally {
    IOUtils.close(reader);
  }
  return terms;
}
