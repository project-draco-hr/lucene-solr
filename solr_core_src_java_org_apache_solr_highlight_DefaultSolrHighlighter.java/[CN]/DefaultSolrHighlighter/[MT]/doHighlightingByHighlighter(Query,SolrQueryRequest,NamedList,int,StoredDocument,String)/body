{
  final SolrIndexSearcher searcher=req.getSearcher();
  final IndexSchema schema=searcher.getSchema();
  final SchemaField schemaField=schema.getFieldOrNull(fieldName);
  if (schemaField != null && schemaField.getType() instanceof org.apache.solr.schema.TrieField)   return;
  SolrParams params=req.getParams();
  boolean preserveMulti=params.getFieldBool(fieldName,HighlightParams.PRESERVE_MULTI,false);
  List<StorableField> allFields=doc.getFields();
  if (allFields == null || allFields.isEmpty())   return;
  int numFragments=getMaxSnippets(fieldName,params);
  boolean mergeContiguousFragments=isMergeContiguousFragments(fieldName,params);
  String[] summaries=null;
  List<TextFragment> frags=new ArrayList<>();
  TokenStream tvStream=TokenSources.getTokenStreamWithOffsets(searcher.getIndexReader(),docId,fieldName);
  final OffsetWindowTokenFilter tvWindowStream;
  if (tvStream != null && schemaField.multiValued() && isActuallyMultiValued(allFields,fieldName)) {
    tvWindowStream=new OffsetWindowTokenFilter(tvStream);
  }
 else {
    tvWindowStream=null;
  }
  int mvToExamine=Integer.parseInt(req.getParams().get(HighlightParams.MAX_MULTIVALUED_TO_EXAMINE,Integer.toString(Integer.MAX_VALUE)));
  int mvToMatch=Integer.parseInt(req.getParams().get(HighlightParams.MAX_MULTIVALUED_TO_MATCH,Integer.toString(Integer.MAX_VALUE)));
  for (  StorableField thisField : allFields) {
    if (mvToExamine <= 0 || mvToMatch <= 0)     break;
    if (!thisField.name().equals(fieldName))     continue;
    --mvToExamine;
    String thisText=thisField.stringValue();
    TokenStream tstream;
    if (tvWindowStream != null) {
      tstream=tvWindowStream.advanceToNextWindowOfLength(thisText.length());
    }
 else     if (tvStream != null) {
      tstream=tvStream;
    }
 else {
      tstream=createAnalyzerTStream(schema,fieldName,thisText);
    }
    int maxCharsToAnalyze=params.getFieldInt(fieldName,HighlightParams.MAX_CHARS,Highlighter.DEFAULT_MAX_CHARS_TO_ANALYZE);
    Highlighter highlighter;
    if (Boolean.valueOf(req.getParams().get(HighlightParams.USE_PHRASE_HIGHLIGHTER,"true"))) {
      final TokenStream tempTokenStream;
      if (tstream != tvStream) {
        if (maxCharsToAnalyze < 0) {
          tempTokenStream=new CachingTokenFilter(tstream);
        }
 else {
          tempTokenStream=new CachingTokenFilter(new OffsetLimitTokenFilter(tstream,maxCharsToAnalyze));
        }
      }
 else {
        tempTokenStream=tstream;
      }
      highlighter=getPhraseHighlighter(query,fieldName,req,tempTokenStream);
      if (tempTokenStream instanceof CachingTokenFilter && ((CachingTokenFilter)tempTokenStream).isCached()) {
        tstream=tempTokenStream;
      }
    }
 else {
      highlighter=getHighlighter(query,fieldName,req);
    }
    if (maxCharsToAnalyze < 0) {
      highlighter.setMaxDocCharsToAnalyze(thisText.length());
    }
 else {
      highlighter.setMaxDocCharsToAnalyze(maxCharsToAnalyze);
    }
    try {
      TextFragment[] bestTextFragments=highlighter.getBestTextFragments(tstream,thisText,mergeContiguousFragments,numFragments);
      for (      TextFragment bestTextFragment : bestTextFragments) {
        if (preserveMulti) {
          if (bestTextFragment != null) {
            frags.add(bestTextFragment);
            --mvToMatch;
          }
        }
 else {
          if ((bestTextFragment != null) && (bestTextFragment.getScore() > 0)) {
            frags.add(bestTextFragment);
            --mvToMatch;
          }
        }
      }
    }
 catch (    InvalidTokenOffsetsException e) {
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,e);
    }
  }
  if (!preserveMulti) {
    Collections.sort(frags,new Comparator<TextFragment>(){
      @Override public int compare(      TextFragment arg0,      TextFragment arg1){
        return Math.round(arg1.getScore() - arg0.getScore());
      }
    }
);
  }
  if (frags.size() > 0) {
    ArrayList<String> fragTexts=new ArrayList<>();
    for (    TextFragment fragment : frags) {
      if (preserveMulti) {
        if (fragment != null) {
          fragTexts.add(fragment.toString());
        }
      }
 else {
        if ((fragment != null) && (fragment.getScore() > 0)) {
          fragTexts.add(fragment.toString());
        }
      }
      if (fragTexts.size() >= numFragments && !preserveMulti)       break;
    }
    summaries=fragTexts.toArray(new String[0]);
    if (summaries.length > 0)     docSummaries.add(fieldName,summaries);
  }
  if (summaries == null || summaries.length == 0) {
    alternateField(docSummaries,params,doc,fieldName);
  }
}
