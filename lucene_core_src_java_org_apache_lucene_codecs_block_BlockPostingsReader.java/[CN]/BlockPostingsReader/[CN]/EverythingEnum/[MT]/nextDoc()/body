{
  if (DEBUG) {
    System.out.println("  FPR.nextDoc");
  }
  while (true) {
    if (DEBUG) {
      System.out.println("    docUpto=" + docUpto + " (of df="+ docFreq+ ") docBufferUpto="+ docBufferUpto);
    }
    if (docUpto == docFreq) {
      return doc=NO_MORE_DOCS;
    }
    if (docBufferUpto == BLOCK_SIZE) {
      refillDocs();
    }
    if (DEBUG) {
      System.out.println("    accum=" + accum + " docDeltaBuffer["+ docBufferUpto+ "]="+ docDeltaBuffer[docBufferUpto]);
    }
    accum+=docDeltaBuffer[docBufferUpto];
    freq=freqBuffer[docBufferUpto];
    posPendingCount+=freq;
    docBufferUpto++;
    docUpto++;
    if (liveDocs == null || liveDocs.get(accum)) {
      doc=accum;
      if (DEBUG) {
        System.out.println("    return doc=" + doc + " freq="+ freq+ " posPendingCount="+ posPendingCount);
      }
      position=0;
      lastStartOffset=0;
      return doc;
    }
    if (DEBUG) {
      System.out.println("    doc=" + accum + " is deleted; try next doc");
    }
  }
}
