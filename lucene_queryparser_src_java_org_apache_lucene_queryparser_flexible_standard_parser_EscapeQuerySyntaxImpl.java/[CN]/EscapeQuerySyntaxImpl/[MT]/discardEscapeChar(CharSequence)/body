{
  char[] output=new char[input.length()];
  boolean[] wasEscaped=new boolean[input.length()];
  int length=0;
  boolean lastCharWasEscapeChar=false;
  int codePointMultiplier=0;
  int codePoint=0;
  for (int i=0; i < input.length(); i++) {
    char curChar=input.charAt(i);
    if (codePointMultiplier > 0) {
      codePoint+=hexToInt(curChar) * codePointMultiplier;
      codePointMultiplier>>>=4;
      if (codePointMultiplier == 0) {
        output[length++]=(char)codePoint;
        codePoint=0;
      }
    }
 else     if (lastCharWasEscapeChar) {
      if (curChar == 'u') {
        codePointMultiplier=16 * 16 * 16;
      }
 else {
        output[length]=curChar;
        wasEscaped[length]=true;
        length++;
      }
      lastCharWasEscapeChar=false;
    }
 else {
      if (curChar == '\\') {
        lastCharWasEscapeChar=true;
      }
 else {
        output[length]=curChar;
        length++;
      }
    }
  }
  if (codePointMultiplier > 0) {
    throw new ParseException(new MessageImpl(QueryParserMessages.INVALID_SYNTAX_ESCAPE_UNICODE_TRUNCATION));
  }
  if (lastCharWasEscapeChar) {
    throw new ParseException(new MessageImpl(QueryParserMessages.INVALID_SYNTAX_ESCAPE_CHARACTER));
  }
  return new UnescapedCharSequence(output,wasEscaped,0,length);
}
