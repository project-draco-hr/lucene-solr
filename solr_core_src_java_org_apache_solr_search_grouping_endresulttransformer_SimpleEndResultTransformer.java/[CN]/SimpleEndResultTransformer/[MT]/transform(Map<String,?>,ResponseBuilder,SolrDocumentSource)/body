{
  NamedList<Object> commands=new SimpleOrderedMap<>();
  for (  Map.Entry<String,?> entry : result.entrySet()) {
    Object value=entry.getValue();
    if (TopGroups.class.isInstance(value)) {
      @SuppressWarnings("unchecked") TopGroups<BytesRef> topGroups=(TopGroups<BytesRef>)value;
      NamedList<Object> command=new SimpleOrderedMap<>();
      command.add("matches",rb.totalHitCount);
      if (topGroups.totalGroupCount != null) {
        command.add("ngroups",topGroups.totalGroupCount);
      }
      SolrDocumentList docList=new SolrDocumentList();
      docList.setStart(rb.getGroupingSpec().getOffset());
      docList.setNumFound(topGroups.totalHitCount);
      Float maxScore=Float.NEGATIVE_INFINITY;
      for (      GroupDocs<BytesRef> group : topGroups.groups) {
        for (        ScoreDoc scoreDoc : group.scoreDocs) {
          if (maxScore < scoreDoc.score) {
            maxScore=scoreDoc.score;
          }
          docList.add(solrDocumentSource.retrieve(scoreDoc));
        }
      }
      if (maxScore != Float.NEGATIVE_INFINITY) {
        docList.setMaxScore(maxScore);
      }
      command.add("doclist",docList);
      commands.add(entry.getKey(),command);
    }
  }
  rb.rsp.add("grouped",commands);
}
