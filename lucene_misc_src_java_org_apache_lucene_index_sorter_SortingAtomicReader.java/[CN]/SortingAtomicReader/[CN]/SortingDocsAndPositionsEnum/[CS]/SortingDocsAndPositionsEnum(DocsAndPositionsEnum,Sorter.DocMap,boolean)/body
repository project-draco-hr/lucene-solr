{
  super(in);
  this.storeOffsets=storeOffsets;
  final RAMFile file=new RAMFile();
  final IndexOutput out=new RAMOutputStream(file);
  docs=new int[32];
  offsets=new long[32];
  int doc;
  int i=0;
  while ((doc=in.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
    if (i == docs.length) {
      docs=ArrayUtil.grow(docs,docs.length + 1);
      long[] tmp=new long[docs.length];
      System.arraycopy(offsets,0,tmp,0,offsets.length);
      offsets=tmp;
    }
    docs[i]=docMap.oldToNew(doc);
    offsets[i]=out.getFilePointer();
    addPositions(in,out);
    i++;
  }
  upto=i;
  SorterTemplate sorter=new DocOffsetSorterTemplate(docs,offsets);
  sorter.quickSort(0,upto - 1);
  out.close();
  this.postingInput=new RAMInputStream("",file);
}
