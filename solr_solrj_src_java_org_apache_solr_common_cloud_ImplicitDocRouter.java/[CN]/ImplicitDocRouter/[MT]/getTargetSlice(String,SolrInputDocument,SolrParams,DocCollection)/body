{
  String shard=null;
  if (sdoc != null) {
    Object o=sdoc.getFieldValue("_shard_");
    if (o != null) {
      shard=o.toString();
    }
  }
  if (shard == null) {
    shard=params.get("_shard_");
  }
  if (shard != null) {
    Slice slice=collection.getSlice(shard);
    if (slice == null) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"No _shard_=" + shard + " in "+ collection);
    }
    return slice;
  }
  return null;
}
