{
  Iterable<ContentStream> streams=req.getContentStreams();
  if (streams == null) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"missing content stream");
  }
  ArrayList<CommandOperation> ops=new ArrayList<>();
  for (  ContentStream stream : streams)   ops.addAll(CommandOperation.parse(stream.getReader()));
  List<Map> errList=CommandOperation.captureErrors(ops);
  if (!errList.isEmpty()) {
    resp.add(CommandOperation.ERR_MSGS,errList);
    return;
  }
  try {
    for (; ; ) {
      ArrayList<CommandOperation> opsCopy=new ArrayList<>(ops.size());
      for (      CommandOperation op : ops)       opsCopy.add(op.getCopy());
      try {
        if (parts.size() > 1 && RequestParams.NAME.equals(parts.get(1))) {
          RequestParams params=RequestParams.getFreshRequestParams(req.getCore().getResourceLoader(),req.getCore().getSolrConfig().getRequestParams());
          handleParams(opsCopy,params);
        }
 else {
          ConfigOverlay overlay=SolrConfig.getConfigOverlay(req.getCore().getResourceLoader());
          handleCommands(opsCopy,overlay);
        }
        break;
      }
 catch (      ZkController.ResourceModifiedInZkException e) {
        log.info("Race condition, the node is modified in ZK by someone else " + e.getMessage());
      }
    }
  }
 catch (  Exception e) {
    resp.setException(e);
    resp.add(CommandOperation.ERR_MSGS,singletonList(SchemaManager.getErrorStr(e)));
  }
}
