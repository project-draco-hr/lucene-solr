{
  EnumSet<HighlightFlag> highlightFlags=getFlags(field);
  BytesRef[] terms=filterExtractedTerms(field,allTerms);
  PhraseHelper phraseHelper=getPhraseHelper(field,query,highlightFlags);
  CharacterRunAutomaton[] automata=getAutomata(field,query,highlightFlags);
  OffsetSource offsetSource=getOptimizedOffsetSource(field,terms,phraseHelper,automata);
switch (offsetSource) {
case ANALYSIS:
    return new AnalysisOffsetStrategy(field,terms,phraseHelper,automata,getIndexAnalyzer());
case NONE_NEEDED:
  return NoOpOffsetStrategy.INSTANCE;
case TERM_VECTORS:
return new TermVectorOffsetStrategy(field,terms,phraseHelper,automata);
case POSTINGS:
return new PostingsOffsetStrategy(field,terms,phraseHelper,automata);
case POSTINGS_WITH_TERM_VECTORS:
return new PostingsWithTermVectorsOffsetStrategy(field,terms,phraseHelper,automata);
default :
throw new IllegalArgumentException("Unrecognized offset source " + offsetSource);
}
}
