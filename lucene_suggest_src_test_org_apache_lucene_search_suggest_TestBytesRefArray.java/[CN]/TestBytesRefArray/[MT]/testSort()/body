{
  Random random=random();
  BytesRefArray list=new BytesRefArray(Counter.newCounter());
  List<String> stringList=new ArrayList<String>();
  for (int j=0; j < 2; j++) {
    if (j > 0 && random.nextBoolean()) {
      list.clear();
      stringList.clear();
    }
    int entries=atLeast(500);
    BytesRef spare=new BytesRef();
    final int initSize=list.size();
    for (int i=0; i < entries; i++) {
      String randomRealisticUnicodeString=TestUtil.randomRealisticUnicodeString(random);
      spare.copyChars(randomRealisticUnicodeString);
      assertEquals(initSize + i,list.append(spare));
      stringList.add(randomRealisticUnicodeString);
    }
    Collections.sort(stringList);
    BytesRefIterator iter=list.iterator(BytesRef.getUTF8SortedAsUTF16Comparator());
    int i=0;
    while ((spare=iter.next()) != null) {
      assertEquals("entry " + i + " doesn't match",stringList.get(i),spare.utf8ToString());
      i++;
    }
    assertNull(iter.next());
    assertEquals(i,stringList.size());
  }
}
