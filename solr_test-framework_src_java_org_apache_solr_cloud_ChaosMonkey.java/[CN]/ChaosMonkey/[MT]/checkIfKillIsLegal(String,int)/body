{
  for (  CloudJettyRunner cloudJetty : shardToJetty.get(slice)) {
    zkStateReader.updateClusterState(true);
    Slice theShards=zkStateReader.getClusterState().getSlicesMap(collection).get(slice);
    ZkNodeProps props=theShards.getReplicasMap().get(cloudJetty.coreNodeName);
    if (props == null) {
      throw new RuntimeException("shard name " + cloudJetty.coreNodeName + " not found in "+ theShards.getReplicasMap().keySet());
    }
    String state=props.getStr(ZkStateReader.STATE_PROP);
    String nodeName=props.getStr(ZkStateReader.NODE_NAME_PROP);
    if (cloudJetty.jetty.isRunning() && state.equals(ZkStateReader.ACTIVE) && zkStateReader.getClusterState().liveNodesContain(nodeName)) {
      numActive++;
    }
  }
  return numActive;
}
