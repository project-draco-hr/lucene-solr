{
  validateSettings(minItemsInBlock,maxItemsInBlock);
  this.minItemsInBlock=minItemsInBlock;
  this.maxItemsInBlock=maxItemsInBlock;
  validateAutoPrefixSettings(minItemsInAutoPrefix,maxItemsInAutoPrefix);
  if (minItemsInAutoPrefix != 0) {
    prefixDocs=new FixedBitSet(state.segmentInfo.maxDoc());
    prefixFixedBitsTermsEnum=new BitSetTermsEnum(prefixDocs);
  }
 else {
    prefixDocs=null;
    prefixFixedBitsTermsEnum=null;
  }
  this.minItemsInAutoPrefix=minItemsInAutoPrefix;
  this.maxItemsInAutoPrefix=maxItemsInAutoPrefix;
  this.maxDoc=state.segmentInfo.maxDoc();
  this.fieldInfos=state.fieldInfos;
  this.postingsWriter=postingsWriter;
  final String termsName=IndexFileNames.segmentFileName(state.segmentInfo.name,state.segmentSuffix,BlockTreeTermsReader.TERMS_EXTENSION);
  termsOut=state.directory.createOutput(termsName,state.context);
  boolean success=false;
  IndexOutput indexOut=null;
  try {
    CodecUtil.writeIndexHeader(termsOut,BlockTreeTermsReader.TERMS_CODEC_NAME,BlockTreeTermsReader.VERSION_CURRENT,state.segmentInfo.getId(),state.segmentSuffix);
    if (minItemsInAutoPrefix == 0) {
      termsOut.writeByte((byte)0);
    }
 else {
      termsOut.writeByte((byte)1);
    }
    final String indexName=IndexFileNames.segmentFileName(state.segmentInfo.name,state.segmentSuffix,BlockTreeTermsReader.TERMS_INDEX_EXTENSION);
    indexOut=state.directory.createOutput(indexName,state.context);
    CodecUtil.writeIndexHeader(indexOut,BlockTreeTermsReader.TERMS_INDEX_CODEC_NAME,BlockTreeTermsReader.VERSION_CURRENT,state.segmentInfo.getId(),state.segmentSuffix);
    postingsWriter.init(termsOut,state);
    this.indexOut=indexOut;
    success=true;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(termsOut,indexOut);
    }
  }
}
