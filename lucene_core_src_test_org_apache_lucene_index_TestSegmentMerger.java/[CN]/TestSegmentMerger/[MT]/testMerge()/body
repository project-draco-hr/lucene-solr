{
  final Codec codec=Codec.getDefault();
  final SegmentInfo si=new SegmentInfo(mergedDir,Constants.LUCENE_MAIN_VERSION,mergedSegment,10000,-1,mergedSegment,false,null,false,codec,null,null);
  SegmentMerger merger=new SegmentMerger(si,InfoStream.getDefault(),mergedDir,IndexWriterConfig.DEFAULT_TERM_INDEX_INTERVAL,MergeState.CheckAbort.NONE,null,new FieldInfos.Builder(),codec,newIOContext(random()));
  merger.add(reader1);
  merger.add(reader2);
  MergeState mergeState=merger.merge();
  int docsMerged=mergeState.mergedDocCount;
  assertTrue(docsMerged == 2);
  SegmentReader mergedReader=new SegmentReader(new SegmentInfoPerCommit(new SegmentInfo(mergedDir,Constants.LUCENE_MAIN_VERSION,mergedSegment,docsMerged,-1,mergedSegment,false,null,false,codec,null,null),0,-1L),DirectoryReader.DEFAULT_TERMS_INDEX_DIVISOR,newIOContext(random()));
  assertTrue(mergedReader != null);
  assertTrue(mergedReader.numDocs() == 2);
  Document newDoc1=mergedReader.document(0);
  assertTrue(newDoc1 != null);
  assertTrue(DocHelper.numFields(newDoc1) == DocHelper.numFields(doc1) - DocHelper.unstored.size());
  Document newDoc2=mergedReader.document(1);
  assertTrue(newDoc2 != null);
  assertTrue(DocHelper.numFields(newDoc2) == DocHelper.numFields(doc2) - DocHelper.unstored.size());
  DocsEnum termDocs=_TestUtil.docs(random(),mergedReader,DocHelper.TEXT_FIELD_2_KEY,new BytesRef("field"),MultiFields.getLiveDocs(mergedReader),null,false);
  assertTrue(termDocs != null);
  assertTrue(termDocs.nextDoc() != DocIdSetIterator.NO_MORE_DOCS);
  int tvCount=0;
  for (  FieldInfo fieldInfo : mergedReader.getFieldInfos()) {
    if (fieldInfo.hasVectors()) {
      tvCount++;
    }
  }
  assertEquals("We do not have 3 fields that were indexed with term vector",3,tvCount);
  Terms vector=mergedReader.getTermVectors(0).terms(DocHelper.TEXT_FIELD_2_KEY);
  assertNotNull(vector);
  assertEquals(3,vector.size());
  TermsEnum termsEnum=vector.iterator(null);
  int i=0;
  while (termsEnum.next() != null) {
    String term=termsEnum.term().utf8ToString();
    int freq=(int)termsEnum.totalTermFreq();
    assertTrue(DocHelper.FIELD_2_TEXT.indexOf(term) != -1);
    assertTrue(DocHelper.FIELD_2_FREQS[i] == freq);
    i++;
  }
  TestSegmentReader.checkNorms(mergedReader);
  mergedReader.close();
}
