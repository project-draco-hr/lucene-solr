{
  if (isUsingComplements) {
    initArraysByTotalCounts(facetArrays,partition,docids.size());
  }
 else {
    facetArrays.free();
  }
  HashMap<CategoryListIterator,Aggregator> categoryLists=getCategoryListMap(facetArrays,partition);
  IntsRef ordinals=new IntsRef(32);
  for (  Entry<CategoryListIterator,Aggregator> entry : categoryLists.entrySet()) {
    CategoryListIterator categoryList=entry.getKey();
    if (!categoryList.init()) {
      continue;
    }
    Aggregator categorator=entry.getValue();
    ScoredDocIDsIterator iterator=docids.iterator();
    while (iterator.next()) {
      int docID=iterator.getDocID();
      categoryList.getOrdinals(docID,ordinals);
      if (ordinals.length == 0) {
        continue;
      }
      categorator.aggregate(docID,iterator.getScore(),ordinals);
    }
  }
}
