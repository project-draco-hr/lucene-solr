{
  if (isUsingComplements) {
    initArraysByTotalCounts(facetArrays,partition,docids.size());
  }
 else {
    facetArrays.free();
  }
  HashMap<CategoryListIterator,Aggregator> categoryLists=getCategoryListMap(facetArrays,partition);
  for (  Entry<CategoryListIterator,Aggregator> entry : categoryLists.entrySet()) {
    CategoryListIterator categoryList=entry.getKey();
    if (!categoryList.init()) {
      continue;
    }
    Aggregator categorator=entry.getValue();
    ScoredDocIDsIterator iterator=docids.iterator();
    while (iterator.next()) {
      int docID=iterator.getDocID();
      if (!categoryList.skipTo(docID)) {
        continue;
      }
      categorator.setNextDoc(docID,iterator.getScore());
      long ordinal;
      while ((ordinal=categoryList.nextCategory()) <= Integer.MAX_VALUE) {
        categorator.aggregate((int)ordinal);
      }
    }
  }
}
