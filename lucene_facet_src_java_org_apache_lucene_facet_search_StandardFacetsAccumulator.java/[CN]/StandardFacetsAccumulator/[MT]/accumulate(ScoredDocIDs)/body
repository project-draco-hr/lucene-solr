{
synchronized (accumulateGuard) {
    isUsingComplements=shouldComplement(docids);
    if (isUsingComplements) {
      try {
        totalFacetCounts=TotalFacetCountsCache.getSingleton().getTotalCounts(indexReader,taxonomyReader,searchParams.getFacetIndexingParams(),searchParams.getClCache());
        if (totalFacetCounts != null) {
          docids=ScoredDocIdsUtils.getComplementSet(docids,indexReader);
        }
 else {
          isUsingComplements=false;
        }
      }
 catch (      UnsupportedOperationException e) {
        if (logger.isLoggable(Level.FINEST)) {
          logger.log(Level.FINEST,"IndexReader used does not support completents: ",e);
        }
        isUsingComplements=false;
      }
catch (      IOException e) {
        if (logger.isLoggable(Level.FINEST)) {
          logger.log(Level.FINEST,"Failed to load/calculate total counts (complement counting disabled): ",e);
        }
        isUsingComplements=false;
      }
catch (      Exception e) {
        IOException ioEx=new IOException("PANIC: Got unexpected exception while trying to get/calculate total counts: " + e.getMessage());
        ioEx.initCause(e);
        throw ioEx;
      }
    }
    docids=actualDocsToAccumulate(docids);
    FacetArrays facetArrays=new FacetArrays(intArrayAllocator,floatArrayAllocator);
    HashMap<FacetRequest,IntermediateFacetResult> fr2tmpRes=new HashMap<FacetRequest,IntermediateFacetResult>();
    try {
      for (int part=0; part < maxPartitions; part++) {
        fillArraysForPartition(docids,facetArrays,part);
        int offset=part * partitionSize;
        for (        FacetRequest fr : searchParams.getFacetRequests()) {
          FacetResultsHandler frHndlr=fr.createFacetResultsHandler(taxonomyReader);
          IntermediateFacetResult res4fr=frHndlr.fetchPartitionResult(facetArrays,offset);
          IntermediateFacetResult oldRes=fr2tmpRes.get(fr);
          if (oldRes != null) {
            res4fr=frHndlr.mergeResults(oldRes,res4fr);
          }
          fr2tmpRes.put(fr,res4fr);
        }
      }
    }
  finally {
      facetArrays.free();
    }
    List<FacetResult> res=new ArrayList<FacetResult>();
    for (    FacetRequest fr : searchParams.getFacetRequests()) {
      FacetResultsHandler frHndlr=fr.createFacetResultsHandler(taxonomyReader);
      IntermediateFacetResult tmpResult=fr2tmpRes.get(fr);
      if (tmpResult == null) {
        continue;
      }
      FacetResult facetRes=frHndlr.renderFacetResult(tmpResult);
      if (isAllowLabeling()) {
        frHndlr.labelResult(facetRes);
      }
      res.add(facetRes);
    }
    return res;
  }
}
