{
  final WeakIdentityHashMap<String,String> map=new WeakIdentityHashMap<String,String>();
  String key1=new String("foo");
  String key2=new String("foo");
  String key3=new String("foo");
  assertNotSame(key1,key2);
  assertEquals(key1,key2);
  assertNotSame(key1,key3);
  assertEquals(key1,key3);
  assertNotSame(key2,key3);
  assertEquals(key2,key3);
  map.put(key1,"bar1");
  map.put(key2,"bar2");
  map.put(null,"null");
  assertEquals("bar1",map.get(key1));
  assertEquals("bar2",map.get(key2));
  assertEquals(null,map.get(key3));
  assertEquals("null",map.get(null));
  assertTrue(map.containsKey(key1));
  assertTrue(map.containsKey(key2));
  assertFalse(map.containsKey(key3));
  assertTrue(map.containsKey(null));
  assertEquals(3,map.size());
  map.remove(null);
  assertEquals(2,map.size());
  map.remove(key1);
  assertEquals(1,map.size());
  map.put(key1,"bar1");
  map.put(key2,"bar2");
  map.put(key3,"bar3");
  assertEquals(3,map.size());
  key1=key2=key3=null;
  for (int i=0; !map.isEmpty(); i++)   try {
    if (i > 40)     fail("The garbage collector did not reclaim all keys after 2 seconds, failing test!");
    System.runFinalization();
    System.gc();
    Thread.currentThread().sleep(50L);
  }
 catch (  InterruptedException ie) {
  }
}
