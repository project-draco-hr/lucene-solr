{
  final Directory dir=newDirectory();
  final RandomIndexWriter w=new RandomIndexWriter(random(),dir);
  final List<Document> docs=new ArrayList<>();
  docs.add(makeJob("java",2007));
  docs.add(makeJob("python",2010));
  Collections.shuffle(docs,random());
  docs.add(makeResume("Lisa","United Kingdom"));
  final List<Document> docs2=new ArrayList<>();
  docs2.add(makeJob("ruby",2005));
  docs2.add(makeJob("java",2006));
  Collections.shuffle(docs2,random());
  docs2.add(makeResume("Frank","United States"));
  addSkillless(w);
  boolean turn=random().nextBoolean();
  w.addDocuments(turn ? docs : docs2);
  addSkillless(w);
  w.addDocuments(!turn ? docs : docs2);
  addSkillless(w);
  IndexReader r=w.getReader();
  w.close();
  IndexSearcher s=newSearcher(r);
  BitSetProducer parentsFilter=new QueryBitSetProducer(new TermQuery(new Term("docType","resume")));
  CheckJoinIndex.check(r,parentsFilter);
  BooleanQuery.Builder childQuery=new BooleanQuery.Builder();
  childQuery.add(new BooleanClause(new TermQuery(new Term("skill","java")),Occur.MUST));
  childQuery.add(new BooleanClause(IntPoint.newRangeQuery("year",2006,2011),Occur.MUST));
  Query parentQuery=new TermQuery(new Term("country","United Kingdom"));
  ToParentBlockJoinQuery childJoinQuery=new ToParentBlockJoinQuery(childQuery.build(),parentsFilter,ScoreMode.Avg);
  assertEquals("no filter - both passed",2,s.search(childJoinQuery,10).totalHits);
  Query query=new BooleanQuery.Builder().add(childJoinQuery,Occur.MUST).add(new TermQuery(new Term("docType","resume")),Occur.FILTER).build();
  assertEquals("dummy filter passes everyone ",2,s.search(query,10).totalHits);
  query=new BooleanQuery.Builder().add(childJoinQuery,Occur.MUST).add(new TermQuery(new Term("docType","resume")),Occur.FILTER).build();
  assertEquals("dummy filter passes everyone ",2,s.search(query,10).totalHits);
  query=new BooleanQuery.Builder().add(childJoinQuery,Occur.MUST).add(new TermQuery(new Term("country","Oz")),Occur.FILTER).build();
  assertEquals("noone live there",0,s.search(query,1).totalHits);
  query=new BooleanQuery.Builder().add(childJoinQuery,Occur.MUST).add(parentQuery,Occur.FILTER).build();
  TopDocs ukOnly=s.search(query,1);
  assertEquals("has filter - single passed",1,ukOnly.totalHits);
  assertEquals("Lisa",r.document(ukOnly.scoreDocs[0].doc).get("name"));
  query=new BooleanQuery.Builder().add(childJoinQuery,Occur.MUST).add(new TermQuery(new Term("country","United States")),Occur.FILTER).build();
  TopDocs usThen=s.search(query,1);
  assertEquals("has filter - single passed",1,usThen.totalHits);
  assertEquals("Frank",r.document(usThen.scoreDocs[0].doc).get("name"));
  TermQuery us=new TermQuery(new Term("country","United States"));
  assertEquals("@ US we have java and ruby",2,s.search(new ToChildBlockJoinQuery(us,parentsFilter),10).totalHits);
  query=new BooleanQuery.Builder().add(new ToChildBlockJoinQuery(us,parentsFilter),Occur.MUST).add(skill("java"),Occur.FILTER).build();
  assertEquals("java skills in US",1,s.search(query,10).totalHits);
  BooleanQuery.Builder rubyPython=new BooleanQuery.Builder();
  rubyPython.add(new TermQuery(new Term("skill","ruby")),Occur.SHOULD);
  rubyPython.add(new TermQuery(new Term("skill","python")),Occur.SHOULD);
  query=new BooleanQuery.Builder().add(new ToChildBlockJoinQuery(us,parentsFilter),Occur.MUST).add(rubyPython.build(),Occur.FILTER).build();
  assertEquals("ruby skills in US",1,s.search(query,10).totalHits);
  r.close();
  dir.close();
}
