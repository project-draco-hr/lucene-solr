{
  Directory d=newDirectory();
  RandomIndexWriter w=new RandomIndexWriter(random(),d);
  Document parent=new Document();
  parent.add(new StoredField("parentID","0"));
  parent.add(newTextField("parentText","text",Field.Store.NO));
  parent.add(newStringField("isParent","yes",Field.Store.NO));
  List<Document> docs=new ArrayList<>();
  Document child=new Document();
  docs.add(child);
  child.add(new StoredField("childID","0"));
  child.add(newTextField("childText","text",Field.Store.NO));
  docs.add(parent);
  w.addDocuments(docs);
  docs.clear();
  parent=new Document();
  parent.add(newTextField("parentText","text",Field.Store.NO));
  parent.add(newStringField("isParent","yes",Field.Store.NO));
  parent.add(new StoredField("parentID","1"));
  docs.add(parent);
  w.addDocuments(docs);
  IndexReader r=w.getReader();
  w.close();
  Query childQuery=new TermQuery(new Term("parentText","text"));
  BitDocIdSetFilter parentsFilter=new BitDocIdSetCachingWrapperFilter(new QueryWrapperFilter(new TermQuery(new Term("isParent","yes"))));
  ToParentBlockJoinQuery childJoinQuery=new ToParentBlockJoinQuery(childQuery,parentsFilter,ScoreMode.Avg);
  BooleanQuery parentQuery=new BooleanQuery();
  parentQuery.add(childJoinQuery,Occur.SHOULD);
  parentQuery.add(new TermQuery(new Term("parentText","text")),Occur.SHOULD);
  ToParentBlockJoinCollector c=new ToParentBlockJoinCollector(new Sort(new SortField("parentID",SortField.Type.STRING)),10,true,true);
  try {
    newSearcher(r).search(parentQuery,c);
    fail("should have hit exception");
  }
 catch (  IllegalStateException ise) {
  }
  r.close();
  d.close();
}
