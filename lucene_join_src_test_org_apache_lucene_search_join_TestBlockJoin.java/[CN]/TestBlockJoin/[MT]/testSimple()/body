{
  final Directory dir=newDirectory();
  final RandomIndexWriter w=new RandomIndexWriter(random(),dir);
  final List<Document> docs=new ArrayList<>();
  docs.add(makeJob("java",2007));
  docs.add(makeJob("python",2010));
  docs.add(makeResume("Lisa","United Kingdom"));
  w.addDocuments(docs);
  docs.clear();
  docs.add(makeJob("ruby",2005));
  docs.add(makeJob("java",2006));
  docs.add(makeResume("Frank","United States"));
  w.addDocuments(docs);
  IndexReader r=w.getReader();
  w.close();
  IndexSearcher s=newSearcher(r);
  BitSetProducer parentsFilter=new QueryBitSetProducer(new TermQuery(new Term("docType","resume")));
  CheckJoinIndex.check(r,parentsFilter);
  BooleanQuery.Builder childQuery=new BooleanQuery.Builder();
  childQuery.add(new BooleanClause(new TermQuery(new Term("skill","java")),Occur.MUST));
  childQuery.add(new BooleanClause(NumericRangeQuery.newIntRange("year",2006,2011,true,true),Occur.MUST));
  Query parentQuery=new TermQuery(new Term("country","United Kingdom"));
  ToParentBlockJoinQuery childJoinQuery=new ToParentBlockJoinQuery(childQuery.build(),parentsFilter,ScoreMode.Avg);
  BooleanQuery.Builder fullQuery=new BooleanQuery.Builder();
  fullQuery.add(new BooleanClause(parentQuery,Occur.MUST));
  fullQuery.add(new BooleanClause(childJoinQuery,Occur.MUST));
  ToParentBlockJoinCollector c=new ToParentBlockJoinCollector(Sort.RELEVANCE,1,true,true);
  s.search(fullQuery.build(),c);
  TopGroups<Integer> results=c.getTopGroups(childJoinQuery,null,0,10,0,true);
  assertFalse(Float.isNaN(results.maxScore));
  assertEquals(1,results.totalGroupedHitCount);
  assertEquals(1,results.groups.length);
  final GroupDocs<Integer> group=results.groups[0];
  assertEquals(1,group.totalHits);
  assertFalse(Float.isNaN(group.score));
  StoredDocument childDoc=s.doc(group.scoreDocs[0].doc);
  assertEquals("java",childDoc.get("skill"));
  assertNotNull(group.groupValue);
  StoredDocument parentDoc=s.doc(group.groupValue);
  assertEquals("Lisa",parentDoc.get("name"));
  ToChildBlockJoinQuery parentJoinQuery=new ToChildBlockJoinQuery(parentQuery,parentsFilter);
  BooleanQuery.Builder fullChildQuery=new BooleanQuery.Builder();
  fullChildQuery.add(new BooleanClause(parentJoinQuery,Occur.MUST));
  fullChildQuery.add(new BooleanClause(childQuery.build(),Occur.MUST));
  TopDocs hits=s.search(fullChildQuery.build(),10);
  assertEquals(1,hits.totalHits);
  childDoc=s.doc(hits.scoreDocs[0].doc);
  assertEquals("java",childDoc.get("skill"));
  assertEquals(2007,childDoc.getField("year").numericValue());
  assertEquals("Lisa",getParentDoc(r,parentsFilter,hits.scoreDocs[0].doc).get("name"));
  fullChildQuery.add(new TermQuery(new Term("skill","foosball")),Occur.FILTER);
  assertEquals(0,s.search(fullChildQuery.build(),1).totalHits);
  r.close();
  dir.close();
}
