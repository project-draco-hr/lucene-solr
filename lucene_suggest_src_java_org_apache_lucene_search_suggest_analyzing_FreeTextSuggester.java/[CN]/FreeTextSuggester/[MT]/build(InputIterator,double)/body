{
  if (iterator.hasPayloads()) {
    throw new IllegalArgumentException("this suggester doesn't support payloads");
  }
  if (iterator.hasContexts()) {
    throw new IllegalArgumentException("this suggester doesn't support contexts");
  }
  String prefix=getClass().getSimpleName();
  File tempIndexPath=Files.createTempDirectory(prefix + ".index.").toFile();
  Directory dir=FSDirectory.open(tempIndexPath);
  IndexWriterConfig iwc=new IndexWriterConfig(indexAnalyzer);
  iwc.setOpenMode(IndexWriterConfig.OpenMode.CREATE);
  iwc.setRAMBufferSizeMB(ramBufferSizeMB);
  IndexWriter writer=new IndexWriter(dir,iwc);
  FieldType ft=new FieldType(TextField.TYPE_NOT_STORED);
  ft.setIndexOptions(IndexOptions.DOCS_AND_FREQS);
  ft.setOmitNorms(true);
  ft.freeze();
  Document doc=new Document();
  Field field=new Field("body","",ft);
  doc.add(field);
  totTokens=0;
  IndexReader reader=null;
  boolean success=false;
  count=0;
  try {
    while (true) {
      BytesRef surfaceForm=iterator.next();
      if (surfaceForm == null) {
        break;
      }
      field.setStringValue(surfaceForm.utf8ToString());
      writer.addDocument(doc);
      count++;
    }
    reader=DirectoryReader.open(writer,false);
    Terms terms=MultiFields.getTerms(reader,"body");
    if (terms == null) {
      throw new IllegalArgumentException("need at least one suggestion");
    }
    TermsEnum termsEnum=terms.iterator(null);
    Outputs<Long> outputs=PositiveIntOutputs.getSingleton();
    Builder<Long> builder=new Builder<>(FST.INPUT_TYPE.BYTE1,outputs);
    IntsRefBuilder scratchInts=new IntsRefBuilder();
    while (true) {
      BytesRef term=termsEnum.next();
      if (term == null) {
        break;
      }
      int ngramCount=countGrams(term);
      if (ngramCount > grams) {
        throw new IllegalArgumentException("tokens must not contain separator byte; got token=" + term + " but gramCount="+ ngramCount+ ", which is greater than expected max ngram size="+ grams);
      }
      if (ngramCount == 1) {
        totTokens+=termsEnum.totalTermFreq();
      }
      builder.add(Util.toIntsRef(term,scratchInts),encodeWeight(termsEnum.totalTermFreq()));
    }
    fst=builder.finish();
    if (fst == null) {
      throw new IllegalArgumentException("need at least one suggestion");
    }
    writer.rollback();
    success=true;
  }
  finally {
    try {
      if (success) {
        IOUtils.close(reader);
      }
 else {
        IOUtils.closeWhileHandlingException(reader,writer);
      }
    }
  finally {
      for (      String file : dir.listAll()) {
        File path=new File(tempIndexPath,file);
        if (path.delete() == false) {
          throw new IllegalStateException("failed to remove " + path);
        }
      }
      if (tempIndexPath.delete() == false) {
        throw new IllegalStateException("failed to remove " + tempIndexPath);
      }
      dir.close();
    }
  }
}
