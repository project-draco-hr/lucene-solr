{
  Collection<SolrCore> coreList=new ArrayList<>();
  do {
    coreList.clear();
synchronized (modifyLock) {
      coreList.addAll(cores.values());
      cores.clear();
      coreList.addAll(transientCores.values());
      transientCores.clear();
      coreList.addAll(pendingCloses);
      pendingCloses.clear();
    }
    ExecutorService coreCloseExecutor=ExecutorUtil.newMDCAwareFixedThreadPool(Integer.MAX_VALUE,new DefaultSolrThreadFactory("coreCloseExecutor"));
    try {
      for (      SolrCore core : coreList) {
        coreCloseExecutor.submit(new Callable<SolrCore>(){
          @Override public SolrCore call() throws Exception {
            MDCLoggingContext.setCore(core);
            try {
              core.close();
            }
 catch (            Throwable e) {
              SolrException.log(log,"Error shutting down core",e);
              if (e instanceof Error) {
                throw (Error)e;
              }
            }
 finally {
              MDCLoggingContext.clear();
            }
            return core;
          }
        }
);
      }
    }
  finally {
      ExecutorUtil.shutdownAndAwaitTermination(coreCloseExecutor);
    }
  }
 while (coreList.size() > 0);
}
