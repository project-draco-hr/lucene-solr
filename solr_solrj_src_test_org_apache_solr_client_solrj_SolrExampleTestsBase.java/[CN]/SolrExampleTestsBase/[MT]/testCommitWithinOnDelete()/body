{
  SolrServer server=getSolrServer();
  server.deleteByQuery("*:*");
  server.commit();
  QueryResponse rsp=server.query(new SolrQuery("*:*"));
  Assert.assertEquals(0,rsp.getResults().getNumFound());
  SolrInputDocument doc3=new SolrInputDocument();
  doc3.addField("id","id3",1.0f);
  doc3.addField("name","doc3",1.0f);
  doc3.addField("price",10);
  server.add(doc3);
  server.commit();
  rsp=server.query(new SolrQuery("id:id3"));
  Assert.assertEquals(1,rsp.getResults().getNumFound());
  UpdateRequest up=new UpdateRequest();
  up.setCommitWithin(1000);
  up.deleteById("id3");
  up.process(server);
  rsp=server.query(new SolrQuery("id:id3"));
  Assert.assertEquals(1,rsp.getResults().getNumFound());
  long timeout=System.currentTimeMillis() + 30000;
  do {
    Thread.sleep(250);
    rsp=server.query(new SolrQuery("id:id3"));
    if (rsp.getResults().getNumFound() == 0) {
      return;
    }
  }
 while (System.currentTimeMillis() < timeout);
  Assert.fail("commitWithin failed to commit");
}
