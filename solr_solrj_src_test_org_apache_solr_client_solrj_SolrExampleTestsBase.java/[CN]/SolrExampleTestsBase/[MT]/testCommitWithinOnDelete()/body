{
  SolrClient client=getSolrClient();
  client.deleteByQuery("*:*");
  client.commit();
  QueryResponse rsp=client.query(new SolrQuery("*:*"));
  Assert.assertEquals(0,rsp.getResults().getNumFound());
  SolrInputDocument doc3=new SolrInputDocument();
  doc3.addField("id","id3",1.0f);
  doc3.addField("name","doc3",1.0f);
  doc3.addField("price",10);
  client.add(doc3);
  client.commit();
  rsp=client.query(new SolrQuery("id:id3"));
  Assert.assertEquals(1,rsp.getResults().getNumFound());
  UpdateRequest up=new UpdateRequest();
  up.setCommitWithin(1000);
  up.deleteById("id3");
  up.process(client);
  rsp=client.query(new SolrQuery("id:id3"));
  Assert.assertEquals(1,rsp.getResults().getNumFound());
  TimeOut timeout=new TimeOut(30,TimeUnit.SECONDS);
  do {
    Thread.sleep(250);
    rsp=client.query(new SolrQuery("id:id3"));
    if (rsp.getResults().getNumFound() == 0) {
      return;
    }
  }
 while (!timeout.hasTimedOut());
  Assert.fail("commitWithin failed to commit");
}
