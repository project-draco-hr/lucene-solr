{
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set("action",CollectionAction.CREATE.toString());
  for (  Map.Entry<String,Object> entry : collectionProps.entrySet()) {
    if (entry.getValue() != null)     params.set(entry.getKey(),String.valueOf(entry.getValue()));
  }
  Integer numShards=(Integer)collectionProps.get(NUM_SLICES);
  if (numShards == null) {
    String shardNames=(String)collectionProps.get(SHARDS_PROP);
    numShards=StrUtils.splitSmart(shardNames,',').size();
  }
  Integer replicationFactor=(Integer)collectionProps.get(REPLICATION_FACTOR);
  if (numShards == null) {
    numShards=(Integer)OverseerCollectionProcessor.COLL_PROPS.get(REPLICATION_FACTOR);
  }
  if (confSetName != null) {
    params.set("collection.configName",confSetName);
  }
  int clientIndex=random().nextInt(2);
  List<Integer> list=new ArrayList<>();
  list.add(numShards);
  list.add(replicationFactor);
  if (collectionInfos != null) {
    collectionInfos.put(collectionName,list);
  }
  params.set("name",collectionName);
  SolrRequest request=new QueryRequest(params);
  request.setPath("/admin/collections");
  CollectionAdminResponse res=new CollectionAdminResponse();
  if (client == null) {
    final String baseUrl=getBaseUrl((HttpSolrServer)clients.get(clientIndex));
    SolrServer server=createNewSolrServer("",baseUrl);
    try {
      res.setResponse(server.request(request));
    }
  finally {
      if (server != null)       server.shutdown();
    }
  }
 else {
    res.setResponse(client.request(request));
  }
  return res;
}
