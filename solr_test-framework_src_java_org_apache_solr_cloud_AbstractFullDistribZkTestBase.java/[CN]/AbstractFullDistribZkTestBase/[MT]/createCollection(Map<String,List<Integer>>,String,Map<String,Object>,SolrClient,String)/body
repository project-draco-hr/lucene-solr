{
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set("action",CollectionAction.CREATE.toString());
  for (  Map.Entry<String,Object> entry : collectionProps.entrySet()) {
    if (entry.getValue() != null)     params.set(entry.getKey(),String.valueOf(entry.getValue()));
  }
  Integer numShards=(Integer)collectionProps.get(NUM_SLICES);
  if (numShards == null) {
    String shardNames=(String)collectionProps.get(SHARDS_PROP);
    numShards=StrUtils.splitSmart(shardNames,',').size();
  }
  Integer replicationFactor=(Integer)collectionProps.get(ZkStateReader.REPLICATION_FACTOR);
  if (replicationFactor == null) {
    replicationFactor=(Integer)OverseerCollectionProcessor.COLL_PROPS.get(ZkStateReader.REPLICATION_FACTOR);
  }
  if (confSetName != null) {
    params.set("collection.configName",confSetName);
  }
  int clientIndex=random().nextInt(2);
  List<Integer> list=new ArrayList<>();
  list.add(numShards);
  list.add(replicationFactor);
  if (collectionInfos != null) {
    collectionInfos.put(collectionName,list);
  }
  params.set("name",collectionName);
  if ("1".equals(getStateFormat())) {
    log.info("Creating collection with stateFormat=1: " + collectionName);
    params.set(DocCollection.STATE_FORMAT,"1");
  }
  SolrRequest request=new QueryRequest(params);
  request.setPath("/admin/collections");
  CollectionAdminResponse res=new CollectionAdminResponse();
  if (client == null) {
    final String baseUrl=getBaseUrl((HttpSolrClient)clients.get(clientIndex));
    try (SolrClient adminClient=createNewSolrClient("",baseUrl)){
      res.setResponse(adminClient.request(request));
    }
   }
 else {
    res.setResponse(client.request(request));
  }
  return res;
}
