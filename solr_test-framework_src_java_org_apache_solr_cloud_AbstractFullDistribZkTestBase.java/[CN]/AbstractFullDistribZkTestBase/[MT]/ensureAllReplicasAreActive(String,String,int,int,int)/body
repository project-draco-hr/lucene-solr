{
  long startMs=System.currentTimeMillis();
  Map<String,Replica> notLeaders=new HashMap<String,Replica>();
  ZkStateReader zkr=cloudClient.getZkStateReader();
  zkr.updateClusterState(true);
  ClusterState cs=zkr.getClusterState();
  Collection<Slice> slices=cs.getActiveSlices(testCollectionName);
  assertTrue(slices.size() == shards);
  boolean allReplicasUp=false;
  long waitMs=0L;
  long maxWaitMs=maxWaitSecs * 1000L;
  Replica leader=null;
  while (waitMs < maxWaitMs && !allReplicasUp) {
    if (waitMs % 2000 == 0)     cloudClient.getZkStateReader().updateClusterState(true);
    cs=cloudClient.getZkStateReader().getClusterState();
    assertNotNull(cs);
    Slice shard=cs.getSlice(testCollectionName,shardId);
    assertNotNull("No Slice for " + shardId,shard);
    allReplicasUp=true;
    Collection<Replica> replicas=shard.getReplicas();
    assertTrue("Did not find correct number of replicas. Expected:" + rf + " Found:"+ replicas.size(),replicas.size() == rf);
    leader=shard.getLeader();
    assertNotNull(leader);
    log.info("Found " + replicas.size() + " replicas and leader on "+ leader.getNodeName()+ " for "+ shardId+ " in "+ testCollectionName);
    for (    Replica replica : replicas) {
      String replicaState=replica.getStr(ZkStateReader.STATE_PROP);
      if (!ZkStateReader.ACTIVE.equals(replicaState)) {
        log.info("Replica " + replica.getName() + " is currently "+ replicaState);
        allReplicasUp=false;
      }
      if (!leader.equals(replica))       notLeaders.put(replica.getName(),replica);
    }
    if (!allReplicasUp) {
      try {
        Thread.sleep(500L);
      }
 catch (      Exception ignoreMe) {
      }
      waitMs+=500L;
    }
  }
  if (!allReplicasUp)   fail("Didn't see all replicas for shard " + shardId + " in "+ testCollectionName+ " come up within "+ maxWaitMs+ " ms! ClusterState: "+ printClusterStateInfo());
  if (notLeaders.isEmpty())   fail("Didn't isolate any replicas that are not the leader! ClusterState: " + printClusterStateInfo());
  long diffMs=(System.currentTimeMillis() - startMs);
  log.info("Took " + diffMs + " ms to see all replicas become active.");
  List<Replica> replicas=new ArrayList<Replica>();
  replicas.addAll(notLeaders.values());
  return replicas;
}
