{
  Directory indexDir=newDirectory();
  IndexWriterConfig conf=new IndexWriterConfig(null);
  conf.setIndexDeletionPolicy(new SnapshotDeletionPolicy(conf.getIndexDeletionPolicy()));
  IndexWriter indexWriter=new IndexWriter(indexDir,conf);
  Directory taxoDir=newDirectory();
  SnapshotDirectoryTaxonomyWriter taxoWriter=new SnapshotDirectoryTaxonomyWriter(taxoDir);
  if (indexDir instanceof MockDirectoryWrapper) {
    ((MockDirectoryWrapper)indexDir).setEnableVirusScanner(false);
  }
  try {
    indexWriter.addDocument(newDocument(taxoWriter));
    indexWriter.commit();
    taxoWriter.commit();
    Revision rev1=new IndexAndTaxonomyRevision(indexWriter,taxoWriter);
    rev1.release();
    assertTrue(slowFileExists(indexDir,IndexFileNames.SEGMENTS + "_1"));
    assertTrue(slowFileExists(taxoDir,IndexFileNames.SEGMENTS + "_1"));
    rev1=new IndexAndTaxonomyRevision(indexWriter,taxoWriter);
    indexWriter.addDocument(newDocument(taxoWriter));
    indexWriter.commit();
    taxoWriter.commit();
    assertNotNull(new IndexAndTaxonomyRevision(indexWriter,taxoWriter));
    rev1.release();
    assertFalse(slowFileExists(indexDir,IndexFileNames.SEGMENTS + "_1"));
    indexWriter.close();
  }
  finally {
    IOUtils.close(indexWriter,taxoWriter,taxoDir,indexDir);
    if (indexDir instanceof MockDirectoryWrapper) {
      ((MockDirectoryWrapper)indexDir).setEnableVirusScanner(true);
    }
  }
}
