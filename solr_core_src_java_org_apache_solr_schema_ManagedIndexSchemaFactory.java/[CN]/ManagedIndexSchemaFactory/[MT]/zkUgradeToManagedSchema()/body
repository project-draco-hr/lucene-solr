{
  schema.persistManagedSchemaToZooKeeper(true);
  if (resourceName.equals(managedSchemaResourceName)) {
    log.info("On upgrading to managed schema, did not rename non-managed schema " + resourceName + " because it's the same as the managed schema's name.");
  }
 else {
    ZkSolrResourceLoader zkLoader=(ZkSolrResourceLoader)loader;
    final String nonManagedSchemaPath=zkLoader.getCollectionZkPath() + "/" + resourceName;
    try {
      ZkController zkController=zkLoader.getZkController();
      ZkCmdExecutor zkCmdExecutor=new ZkCmdExecutor(zkController.getClientTimeout());
      if (zkController.pathExists(nonManagedSchemaPath)) {
        byte[] bytes=zkController.getZkClient().getData(nonManagedSchemaPath,null,null,true);
        final String upgradedSchemaPath=nonManagedSchemaPath + UPGRADED_SCHEMA_EXTENSION;
        zkCmdExecutor.ensureExists(upgradedSchemaPath,zkController.getZkClient());
        zkController.getZkClient().setData(upgradedSchemaPath,bytes,true);
        zkController.getZkClient().delete(nonManagedSchemaPath,-1,true);
        schema.setResourceName(managedSchemaResourceName);
        log.info("After upgrading to managed schema in ZooKeeper, renamed the non-managed schema " + nonManagedSchemaPath + " to "+ upgradedSchemaPath);
      }
 else {
        log.info("After upgrading to managed schema in ZooKeeper, the non-managed schema " + nonManagedSchemaPath + " no longer exists.");
      }
    }
 catch (    Exception e) {
      if (e instanceof InterruptedException) {
        Thread.currentThread().interrupt();
      }
      final String msg="Error persisting managed schema resource " + managedSchemaResourceName;
      log.warn(msg,e);
    }
  }
}
