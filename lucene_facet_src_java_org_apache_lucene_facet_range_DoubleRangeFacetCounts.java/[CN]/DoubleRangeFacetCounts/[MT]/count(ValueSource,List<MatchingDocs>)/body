{
  DoubleRange[] ranges=(DoubleRange[])this.ranges;
  LongRange[] longRanges=new LongRange[ranges.length];
  for (int i=0; i < ranges.length; i++) {
    DoubleRange range=ranges[i];
    longRanges[i]=new LongRange(range.label,NumericUtils.doubleToSortableLong(range.minIncl),true,NumericUtils.doubleToSortableLong(range.maxIncl),true);
  }
  LongRangeCounter counter=new LongRangeCounter(longRanges);
  int missingCount=0;
  for (  MatchingDocs hits : matchingDocs) {
    FunctionValues fv=valueSource.getValues(Collections.emptyMap(),hits.context);
    totCount+=hits.totalHits;
    Bits bits;
    if (fastMatchFilter != null) {
      DocIdSet dis=fastMatchFilter.getDocIdSet(hits.context,null);
      if (dis == null) {
        continue;
      }
      bits=dis.bits();
      if (bits == null) {
        throw new IllegalArgumentException("fastMatchFilter does not implement DocIdSet.bits");
      }
    }
 else {
      bits=null;
    }
    DocIdSetIterator docs=hits.bits.iterator();
    int doc;
    while ((doc=docs.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
      if (bits != null && bits.get(doc) == false) {
        doc++;
        continue;
      }
      if (fv.exists(doc)) {
        counter.add(NumericUtils.doubleToSortableLong(fv.doubleVal(doc)));
      }
 else {
        missingCount++;
      }
    }
  }
  missingCount+=counter.fillCounts(counts);
  totCount-=missingCount;
}
