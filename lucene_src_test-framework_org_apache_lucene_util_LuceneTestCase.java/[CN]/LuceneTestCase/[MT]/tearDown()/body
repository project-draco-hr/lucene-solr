{
  if (!testsFailed) {
    assertTrue("ensure your setUp() calls super.setUp()!!!",state == State.RANTEST || state == State.SETUP);
  }
  state=State.TEARDOWN;
  BooleanQuery.setMaxClauseCount(savedBoolMaxClauseCount);
  if ("perMethod".equals(TEST_CLEAN_THREADS)) {
    int rogueThreads=threadCleanup("test method: '" + getName() + "'");
    if (rogueThreads > 0) {
      System.err.println("RESOURCE LEAK: test method: '" + getName() + "' left "+ rogueThreads+ " thread(s) running");
      if (!testsFailed && uncaughtExceptions.isEmpty()) {
        reportAdditionalFailureInfo();
      }
    }
  }
  Thread.setDefaultUncaughtExceptionHandler(savedUncaughtExceptionHandler);
  try {
    if (!uncaughtExceptions.isEmpty()) {
      testsFailed=true;
      reportAdditionalFailureInfo();
      System.err.println("The following exceptions were thrown by threads:");
      for (      UncaughtExceptionEntry entry : uncaughtExceptions) {
        System.err.println("*** Thread: " + entry.thread.getName() + " ***");
        entry.exception.printStackTrace(System.err);
      }
      fail("Some threads threw uncaught exceptions!");
    }
    assertSaneFieldCaches(getTestLabel());
  }
  finally {
    purgeFieldCache(FieldCache.DEFAULT);
  }
}
