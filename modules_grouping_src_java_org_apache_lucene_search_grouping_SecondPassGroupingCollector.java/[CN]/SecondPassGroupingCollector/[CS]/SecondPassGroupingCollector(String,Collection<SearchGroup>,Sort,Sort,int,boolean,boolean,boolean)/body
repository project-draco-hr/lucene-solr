{
  if (groups.size() == 0) {
    throw new IllegalArgumentException("no groups to collect (groups.size() is 0)");
  }
  this.groupSort=groupSort;
  this.withinGroupSort=withinGroupSort;
  this.groups=groups;
  this.groupField=groupField;
  this.maxDocsPerGroup=maxDocsPerGroup;
  groupMap=new HashMap<BytesRef,SearchGroupDocs>(groups.size());
  for (  SearchGroup group : groups) {
    final TopDocsCollector collector;
    if (withinGroupSort == null) {
      collector=TopScoreDocCollector.create(maxDocsPerGroup,true);
    }
 else {
      collector=TopFieldCollector.create(withinGroupSort,maxDocsPerGroup,fillSortFields,getScores,getMaxScores,true);
    }
    groupMap.put(group.groupValue,new SearchGroupDocs(group.groupValue,collector));
  }
  ordSet=new SentinelIntSet(groupMap.size(),-1);
  groupDocs=new SearchGroupDocs[ordSet.keys.length];
}
