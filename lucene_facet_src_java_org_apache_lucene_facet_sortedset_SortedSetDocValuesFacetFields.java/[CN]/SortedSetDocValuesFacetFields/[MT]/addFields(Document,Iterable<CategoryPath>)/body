{
  if (categories == null) {
    throw new IllegalArgumentException("categories should not be null");
  }
  final Map<CategoryListParams,Iterable<CategoryPath>> categoryLists=createCategoryListMapping(categories);
  for (  Entry<CategoryListParams,Iterable<CategoryPath>> e : categoryLists.entrySet()) {
    CategoryListParams clp=e.getKey();
    String dvField=clp.field + SortedSetDocValuesReaderState.FACET_FIELD_EXTENSION;
    for (    CategoryPath cp : e.getValue()) {
      if (cp.length != 2) {
        throw new IllegalArgumentException("only flat facets (dimension + label) are currently supported; got " + cp);
      }
      doc.add(new SortedSetDocValuesField(dvField,new BytesRef(cp.toString(indexingParams.getFacetDelimChar()))));
    }
    DrillDownStream drillDownStream=getDrillDownStream(e.getValue());
    Field drillDown=new Field(clp.field,drillDownStream,drillDownFieldType());
    doc.add(drillDown);
  }
}
