{
  SolrCore core=h.getCore();
  UpdateHandler updater=core.getUpdateHandler();
  SolrQueryRequest req=req();
  AddUpdateCommand cmd=new AddUpdateCommand(req);
  for (int i=0; i < 99; i++) {
    cmd.solrDoc=new SolrInputDocument();
    cmd.solrDoc.addField("id","id_" + i);
    cmd.solrDoc.addField("subject","subject_" + i);
    updater.addDoc(cmd);
  }
  CommitUpdateCommand cmtCmd=new CommitUpdateCommand(req,false);
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  String indexDir=core.getIndexDir();
  assertNumSegments(indexDir,50);
  cmtCmd=new CommitUpdateCommand(req,true);
  cmtCmd.maxOptimizeSegments=25;
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  assertNumSegments(indexDir,25);
  cmtCmd.maxOptimizeSegments=-1;
  try {
    updater.commit(cmtCmd);
    assertTrue(false);
  }
 catch (  IllegalArgumentException e) {
  }
  cmtCmd.maxOptimizeSegments=1;
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  assertNumSegments(indexDir,1);
  req.close();
}
