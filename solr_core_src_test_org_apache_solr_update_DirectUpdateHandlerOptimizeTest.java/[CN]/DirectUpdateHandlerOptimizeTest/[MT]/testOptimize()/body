{
  SolrCore core=h.getCore();
  UpdateHandler updater=core.getUpdateHandler();
  SolrQueryRequest req=req();
  AddUpdateCommand cmd=new AddUpdateCommand(req);
  for (int i=0; i < 99; i++) {
    cmd.doc=new Document();
    cmd.doc.add(new Field("id","id_" + i,Field.Store.YES,Field.Index.NOT_ANALYZED));
    cmd.doc.add(new Field("subject","subject_" + i,Field.Store.NO,Field.Index.ANALYZED));
    updater.addDoc(cmd);
  }
  CommitUpdateCommand cmtCmd=new CommitUpdateCommand(req,false);
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  String indexDir=core.getIndexDir();
  assertNumSegments(indexDir,50);
  cmtCmd=new CommitUpdateCommand(req,true);
  cmtCmd.maxOptimizeSegments=25;
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  assertNumSegments(indexDir,25);
  cmtCmd.maxOptimizeSegments=-1;
  try {
    updater.commit(cmtCmd);
    assertTrue(false);
  }
 catch (  IllegalArgumentException e) {
  }
  cmtCmd.maxOptimizeSegments=1;
  updater.commit(cmtCmd);
  updater.commit(cmtCmd);
  assertNumSegments(indexDir,1);
  req.close();
}
