{
  Map<String,FunctionValues> valuesCache=(Map<String,FunctionValues>)context.get("valuesCache");
  if (valuesCache == null) {
    valuesCache=new HashMap<String,FunctionValues>();
    context=new HashMap(context);
    context.put("valuesCache",valuesCache);
  }
  FunctionValues[] externalValues=new FunctionValues[expression.variables.length];
  for (int i=0; i < variables.length; ++i) {
    String externalName=expression.variables[i];
    FunctionValues values=valuesCache.get(externalName);
    if (values == null) {
      values=variables[i].getValues(context,readerContext);
      if (values == null) {
        throw new RuntimeException("Internal error. External (" + externalName + ") does not exist.");
      }
      valuesCache.put(externalName,values);
    }
    externalValues[i]=values;
  }
  return new ExpressionFunctionValues(this,expression,externalValues);
}
