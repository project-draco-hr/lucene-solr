{
  if (part instanceof Message) {
    addEnvelopToDocument(part,row);
  }
  String ct=part.getContentType();
  ContentType ctype=new ContentType(ct);
  if (part.isMimeType("multipart/*")) {
    Multipart mp=(Multipart)part.getContent();
    int count=mp.getCount();
    if (part.isMimeType("multipart/alternative"))     count=1;
    for (int i=0; i < count; i++)     addPartToDocument(mp.getBodyPart(i),row,false);
  }
 else   if (part.isMimeType("message/rfc822")) {
    addPartToDocument((Part)part.getContent(),row,false);
  }
 else {
    String disp=part.getDisposition();
    if (!processAttachment || (disp != null && disp.equalsIgnoreCase(Part.ATTACHMENT)))     return;
    InputStream is=part.getInputStream();
    String fileName=part.getFileName();
    Metadata md=new Metadata();
    md.set(HttpHeaders.CONTENT_TYPE,ctype.getBaseType().toLowerCase(Locale.ROOT));
    md.set(TikaMetadataKeys.RESOURCE_NAME_KEY,fileName);
    String content=tika.parseToString(is,md);
    if (disp != null && disp.equalsIgnoreCase(Part.ATTACHMENT)) {
      if (row.get(ATTACHMENT) == null)       row.put(ATTACHMENT,new ArrayList<String>());
      List<String> contents=(List<String>)row.get(ATTACHMENT);
      contents.add(content);
      row.put(ATTACHMENT,contents);
      if (row.get(ATTACHMENT_NAMES) == null)       row.put(ATTACHMENT_NAMES,new ArrayList<String>());
      List<String> names=(List<String>)row.get(ATTACHMENT_NAMES);
      names.add(fileName);
      row.put(ATTACHMENT_NAMES,names);
    }
 else {
      if (row.get(CONTENT) == null)       row.put(CONTENT,new ArrayList<String>());
      List<String> contents=(List<String>)row.get(CONTENT);
      contents.add(content);
      row.put(CONTENT,contents);
    }
  }
}
