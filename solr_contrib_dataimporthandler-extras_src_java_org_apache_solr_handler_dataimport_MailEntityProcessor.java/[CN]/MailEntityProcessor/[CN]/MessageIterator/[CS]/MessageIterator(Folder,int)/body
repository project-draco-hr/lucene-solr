{
  super();
  try {
    this.folder=folder;
    this.batchSize=batchSize;
    SearchTerm st=getSearchTerm();
    LOG.info("SearchTerm=" + st);
    if (st != null || folder instanceof GmailFolder) {
      doBatching=false;
      LOG.info("Searching folder " + folder.getName() + " for messages");
      long searchAtMs=System.currentTimeMillis();
      if (folder instanceof GmailFolder && fetchMailsSince != null) {
        String afterCrit="after:" + afterFmt.format(fetchMailsSince);
        LOG.info("Added server-side gmail filter: " + afterCrit);
        Message[] afterMessages=folder.search(new GmailRawSearchTerm(afterCrit));
        LOG.info("GMail server-side filter found " + afterMessages.length + " messages received "+ afterCrit+ " in folder "+ folder.getName());
        messagesInCurBatch=folder.search((st != null ? st : this),afterMessages);
      }
 else {
        messagesInCurBatch=folder.search(st);
      }
      totalInFolder=messagesInCurBatch.length;
      folder.fetch(messagesInCurBatch,fp);
      current=0;
      long tookMs=(System.currentTimeMillis() - searchAtMs);
      LOG.info("Total messages : " + totalInFolder);
      LOG.info("Search criteria applied. Batching disabled. Took " + tookMs + " (ms)");
    }
 else {
      totalInFolder=folder.getMessageCount();
      LOG.info("Total messages : " + totalInFolder);
      getNextBatch(batchSize,folder);
    }
  }
 catch (  MessagingException e) {
    throw new DataImportHandlerException(DataImportHandlerException.SEVERE,"Message retreival failed",e);
  }
}
