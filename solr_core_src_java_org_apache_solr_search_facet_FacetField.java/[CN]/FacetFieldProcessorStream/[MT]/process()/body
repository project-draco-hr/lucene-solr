{
  fcontext.qcontext.addCloseHook(this);
  setup();
  response=new SimpleOrderedMap<>();
  response.add("buckets",new Iterator(){
    boolean retrieveNext=true;
    Object val;
    @Override public boolean hasNext(){
      if (retrieveNext) {
        val=nextBucket();
      }
      retrieveNext=false;
      return val != null;
    }
    @Override public Object next(){
      if (retrieveNext) {
        val=nextBucket();
      }
      retrieveNext=true;
      if (val == null) {
        boolean removed=fcontext.qcontext.removeCloseHook(FacetFieldProcessorStream.this);
        assert removed;
        try {
          close();
        }
 catch (        IOException e) {
          throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Error during facet streaming close",e);
        }
      }
      return val;
    }
    @Override public void remove(){
      throw new UnsupportedOperationException();
    }
  }
);
}
