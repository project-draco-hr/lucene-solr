{
  LOG.info("Creating embedded Solr server with solrHomeDir: " + solrHomeDir + ", fs: "+ fs+ ", outputShardDir: "+ outputShardDir);
  Path solrDataDir=new Path(outputShardDir,"data");
  String dataDirStr=solrDataDir.toUri().toString();
  SolrResourceLoader loader=new SolrResourceLoader(Paths.get(solrHomeDir.toString()),null,null);
  LOG.info(String.format(Locale.ENGLISH,"Constructed instance information solr.home %s (%s), instance dir %s, conf dir %s, writing index to solr.data.dir %s, with permdir %s",solrHomeDir,solrHomeDir.toUri(),loader.getInstancePath(),loader.getConfigDir(),dataDirStr,outputShardDir));
  System.setProperty("solr.directoryFactory",HdfsDirectoryFactory.class.getName());
  System.setProperty("solr.lock.type",DirectoryFactory.LOCK_TYPE_HDFS);
  System.setProperty("solr.hdfs.nrtcachingdirectory","false");
  System.setProperty("solr.hdfs.blockcache.enabled","false");
  System.setProperty("solr.autoCommit.maxTime","600000");
  System.setProperty("solr.autoSoftCommit.maxTime","-1");
  CoreContainer container=new CoreContainer(loader);
  container.load();
  SolrCore core=container.create("core1",ImmutableMap.of(CoreDescriptor.CORE_DATADIR,dataDirStr));
  if (!(core.getDirectoryFactory() instanceof HdfsDirectoryFactory)) {
    throw new UnsupportedOperationException("Invalid configuration. Currently, the only DirectoryFactory supported is " + HdfsDirectoryFactory.class.getSimpleName());
  }
  EmbeddedSolrServer solr=new EmbeddedSolrServer(container,"core1");
  return solr;
}
