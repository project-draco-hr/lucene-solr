{
  if (solrHomeDir == null) {
    throw new IOException("Unable to find solr home setting");
  }
  LOG.info("Creating embedded Solr server with solrHomeDir: " + solrHomeDir + ", fs: "+ fs+ ", outputShardDir: "+ outputShardDir);
  Properties props=new Properties();
  Path solrDataDir=new Path(outputShardDir,"data");
  if (!fs.exists(solrDataDir) && !fs.mkdirs(solrDataDir)) {
    throw new IOException("Unable to create " + solrDataDir);
  }
  String dataDirStr=solrDataDir.toUri().toString();
  props.setProperty("solr.data.dir",dataDirStr);
  props.setProperty("solr.home",solrHomeDir.toString());
  SolrResourceLoader loader=new SolrResourceLoader(solrHomeDir.toString(),null,props);
  LOG.info(String.format(Locale.ENGLISH,"Constructed instance information solr.home %s (%s), instance dir %s, conf dir %s, writing index to solr.data.dir %s, with permdir %s",solrHomeDir,solrHomeDir.toUri(),loader.getInstanceDir(),loader.getConfigDir(),dataDirStr,outputShardDir));
  CoreContainer container=new CoreContainer(loader);
  container.load();
  CoreDescriptor descr=new CoreDescriptor(container,"core1",".",props);
  SolrCore core=container.create(descr);
  container.register(core,false);
  System.setProperty("solr.hdfs.nrtcachingdirectory","false");
  System.setProperty("solr.hdfs.blockcache.enabled","false");
  System.setProperty("solr.autoCommit.maxTime","-1");
  System.setProperty("solr.autoSoftCommit.maxTime","-1");
  EmbeddedSolrServer solr=new EmbeddedSolrServer(container,"core1");
  return solr;
}
