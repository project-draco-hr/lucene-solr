{
  File path=File.createTempFile("mmap" + chunkSize,"tmp",workDir);
  path.delete();
  path.mkdirs();
  MMapDirectory dir=new MMapDirectory(path);
  dir.setMaxChunkSize(chunkSize);
  if (MMapDirectory.UNMAP_SUPPORTED)   dir.setUseUnmap(true);
  RandomIndexWriter writer=new RandomIndexWriter(random,dir);
  Document doc=new Document();
  Field docid=new Field("docid","0",Field.Store.YES,Field.Index.NOT_ANALYZED);
  Field junk=new Field("junk","",Field.Store.YES,Field.Index.NOT_ANALYZED);
  doc.add(docid);
  doc.add(junk);
  int numDocs=1000 * RANDOM_MULTIPLIER;
  for (int i=0; i < numDocs; i++) {
    docid.setValue("" + i);
    junk.setValue(_TestUtil.randomUnicodeString(random));
    writer.addDocument(doc);
  }
  IndexReader reader=writer.getReader();
  writer.close();
  int numAsserts=100 * RANDOM_MULTIPLIER;
  for (int i=0; i < numAsserts; i++) {
    int docID=random.nextInt(numDocs);
    assertEquals("" + docID,reader.document(docID).get("docid"));
  }
  reader.close();
  dir.close();
}
