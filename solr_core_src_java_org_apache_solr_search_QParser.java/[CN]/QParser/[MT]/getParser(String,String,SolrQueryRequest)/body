{
  String stringIncludingLocalParams=qstr;
  SolrParams localParams=null;
  SolrParams globalParams=req.getParams();
  boolean valFollowedParams=true;
  int localParamsEnd=-1;
  if (qstr != null && qstr.startsWith(QueryParsing.LOCALPARAM_START)) {
    Map<String,String> localMap=new HashMap<String,String>();
    localParamsEnd=QueryParsing.parseLocalParams(qstr,0,localMap,globalParams);
    String val=localMap.get(QueryParsing.V);
    if (val != null) {
      valFollowedParams=false;
    }
 else {
      valFollowedParams=true;
      val=qstr.substring(localParamsEnd);
      localMap.put(QueryParsing.V,val);
    }
    localParams=new MapSolrParams(localMap);
  }
  String parserName;
  if (localParams == null) {
    parserName=defaultParser;
  }
 else {
    parserName=localParams.get(QueryParsing.TYPE,defaultParser);
    qstr=localParams.get("v");
  }
  parserName=parserName == null ? QParserPlugin.DEFAULT_QTYPE : parserName;
  QParserPlugin qplug=req.getCore().getQueryPlugin(parserName);
  QParser parser=qplug.createParser(qstr,localParams,req.getParams(),req);
  parser.stringIncludingLocalParams=stringIncludingLocalParams;
  parser.valFollowedParams=valFollowedParams;
  parser.localParamsEnd=localParamsEnd;
  return parser;
}
