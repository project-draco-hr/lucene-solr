{
  SolrQueryRequest req=rb.req;
  SolrParams params=req.getParams();
  if (!params.getBool(QueryElevationParams.ENABLE,true)) {
    return;
  }
  boolean exclusive=params.getBool(QueryElevationParams.EXCLUSIVE,false);
  boolean force=params.getBool(QueryElevationParams.FORCE_ELEVATION,forceElevation);
  boolean markExcludes=params.getBool(QueryElevationParams.MARK_EXCLUDES,false);
  Query query=rb.getQuery();
  String qstr=rb.getQueryString();
  if (query == null || qstr == null) {
    return;
  }
  qstr=getAnalyzedQuery(qstr);
  IndexReader reader=req.getSearcher().getIndexReader();
  ElevationObj booster=null;
  try {
    booster=getElevationMap(reader,req.getCore()).get(qstr);
  }
 catch (  Exception ex) {
    throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Error loading elevation",ex);
  }
  if (booster != null) {
    rb.req.getContext().put(BOOSTED,booster.ids);
    if (exclusive == true) {
      rb.setQuery(booster.include);
    }
 else {
      BooleanQuery newq=new BooleanQuery(true);
      newq.add(query,BooleanClause.Occur.SHOULD);
      newq.add(booster.include,BooleanClause.Occur.SHOULD);
      if (booster.exclude != null) {
        if (markExcludes == false) {
          for (          TermQuery tq : booster.exclude) {
            newq.add(new BooleanClause(tq,BooleanClause.Occur.MUST_NOT));
          }
        }
 else {
          rb.req.getContext().put(EXCLUDED,booster.excludeIds);
        }
      }
      rb.setQuery(newq);
    }
    ElevationComparatorSource comparator=new ElevationComparatorSource(booster);
    SortSpec sortSpec=rb.getSortSpec();
    if (sortSpec.getSort() == null) {
      sortSpec.setSort(new Sort(new SortField[]{new SortField("_elevate_",comparator,true),new SortField(null,SortField.Type.SCORE,false)}));
    }
 else {
      boolean modify=false;
      SortField[] current=sortSpec.getSort().getSort();
      ArrayList<SortField> sorts=new ArrayList<SortField>(current.length + 1);
      if (force && current[0].getType() != SortField.Type.SCORE) {
        sorts.add(new SortField("_elevate_",comparator,true));
        modify=true;
      }
      for (      SortField sf : current) {
        if (sf.getType() == SortField.Type.SCORE) {
          sorts.add(new SortField("_elevate_",comparator,!sf.getReverse()));
          modify=true;
        }
        sorts.add(sf);
      }
      if (modify) {
        sortSpec.setSort(new Sort(sorts.toArray(new SortField[sorts.size()])));
      }
    }
  }
  if (rb.isDebug()) {
    List<String> match=null;
    if (booster != null) {
      match=new ArrayList<String>(booster.priority.size());
      for (      Object o : booster.include.clauses()) {
        TermQuery tq=(TermQuery)((BooleanClause)o).getQuery();
        match.add(tq.getTerm().text());
      }
    }
    SimpleOrderedMap<Object> dbg=new SimpleOrderedMap<Object>();
    dbg.add("q",qstr);
    dbg.add("match",match);
    if (rb.isDebugQuery()) {
      rb.addDebugInfo("queryBoosting",dbg);
    }
  }
}
