{
  if (!(request instanceof UpdateRequest)) {
    return client.request(request,collection);
  }
  UpdateRequest req=(UpdateRequest)request;
  if (streamDeletes) {
    if ((req.getDocuments() == null || req.getDocuments().isEmpty()) && (req.getDeleteById() == null || req.getDeleteById().isEmpty()) && (req.getDeleteByIdMap() == null || req.getDeleteByIdMap().isEmpty())) {
      if (req.getDeleteQuery() == null) {
        blockUntilFinished();
        return client.request(request,collection);
      }
    }
  }
 else {
    if ((req.getDocuments() == null || req.getDocuments().isEmpty())) {
      blockUntilFinished();
      return client.request(request,collection);
    }
  }
  SolrParams params=req.getParams();
  if (params != null) {
    if (params.getBool(UpdateParams.WAIT_SEARCHER,false)) {
      log.info("blocking for commit/optimize");
      blockUntilFinished();
      return client.request(request,collection);
    }
  }
  try {
    CountDownLatch tmpLock=lock;
    if (tmpLock != null) {
      tmpLock.await();
    }
    boolean success=queue.offer(req);
    for (; ; ) {
synchronized (runners) {
        if (runners.isEmpty() || (queue.remainingCapacity() < queue.size() && runners.size() < threadCount)) {
          MDC.put("ConcurrentUpdateSolrClient.url",client.getBaseURL());
          try {
            Runner r=new Runner();
            runners.add(r);
            scheduler.execute(r);
          }
  finally {
            MDC.remove("ConcurrentUpdateSolrClient.url");
          }
        }
 else {
          if (success)           break;
        }
      }
      if (!success) {
        success=queue.offer(req,100,TimeUnit.MILLISECONDS);
      }
    }
  }
 catch (  InterruptedException e) {
    log.error("interrupted",e);
    throw new IOException(e.getLocalizedMessage());
  }
  NamedList<Object> dummy=new NamedList<>();
  dummy.add("NOTE","the request is processed in a background stream");
  return dummy;
}
