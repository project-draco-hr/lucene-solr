{
  replicationStartTime=System.currentTimeMillis();
  try {
    NamedList response=null;
    try {
      response=getLatestVersion();
    }
 catch (    Exception e) {
      LOG.error("Master at: " + masterUrl + " is not available. Snappull failed. Exception: "+ e.getMessage());
    }
    long latestVersion=(Long)response.get(CMD_INDEX_VERSION);
    long latestGeneration=(Long)response.get(GENERATION);
    if (latestVersion == 0L) {
      return false;
    }
    IndexCommit commit;
    RefCounted<SolrIndexSearcher> searcherRefCounted=null;
    try {
      searcherRefCounted=core.getNewestSearcher(false);
      commit=searcherRefCounted.get().getReader().getIndexCommit();
    }
  finally {
      if (searcherRefCounted != null)       searcherRefCounted.decref();
    }
    if (commit.getVersion() == latestVersion && commit.getGeneration() == latestGeneration) {
      LOG.info("Slave in sync with master.");
      return false;
    }
    LOG.info("Master's version: " + latestVersion + ", generation: "+ latestGeneration);
    LOG.info("Slave's version: " + commit.getVersion() + ", generation: "+ commit.getGeneration());
    LOG.info("Starting replication process");
    fetchFileList(latestVersion);
    LOG.info("Number of files in latest snapshot in master: " + filesToDownload.size());
    filesDownloaded=Collections.synchronizedList(new ArrayList<Map<String,Object>>());
    boolean isSnapNeeded=commit.getGeneration() >= latestGeneration;
    File tmpIndexDir=createTempindexDir(core);
    if (isIndexStale())     isSnapNeeded=true;
    boolean successfulInstall=false;
    try {
      File indexDir=new File(core.getIndexDir());
      downloadIndexFiles(isSnapNeeded,tmpIndexDir,latestVersion);
      LOG.info("Total time taken for download : " + ((System.currentTimeMillis() - replicationStartTime) / 1000) + " secs");
      Collection<Map<String,Object>> modifiedConfFiles=getModifiedConfFiles(confFilesToDownload);
      if (modifiedConfFiles != null && !modifiedConfFiles.isEmpty()) {
        downloadConfFiles(confFilesToDownload,latestVersion);
        if (isSnapNeeded) {
          modifyIndexProps(tmpIndexDir.getName());
        }
 else {
          successfulInstall=copyIndexFiles(tmpIndexDir,indexDir);
        }
        if (successfulInstall) {
          LOG.info("Configuration files are modified, core will be reloaded");
          logReplicationTimeAndConfFiles(modifiedConfFiles);
          reloadCore();
        }
      }
 else {
        LOG.info("Conf files are not downloaded or are in sync");
        if (isSnapNeeded) {
          modifyIndexProps(tmpIndexDir.getName());
        }
 else {
          successfulInstall=copyIndexFiles(tmpIndexDir,indexDir);
        }
        if (successfulInstall) {
          logReplicationTimeAndConfFiles(modifiedConfFiles);
          doCommit();
        }
      }
      replicationStartTime=0;
      return successfulInstall;
    }
 catch (    ReplicationHandlerException e) {
      LOG.error("User aborted Replication");
    }
catch (    SolrException e) {
      throw e;
    }
catch (    Exception e) {
      delTree(tmpIndexDir);
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Snappull failed : ",e);
    }
 finally {
      delTree(tmpIndexDir);
    }
    return successfulInstall;
  }
  finally {
    filesToDownload=filesDownloaded=confFilesDownloaded=confFilesToDownload=null;
    replicationStartTime=0;
    fileFetcher=null;
    stop=false;
  }
}
