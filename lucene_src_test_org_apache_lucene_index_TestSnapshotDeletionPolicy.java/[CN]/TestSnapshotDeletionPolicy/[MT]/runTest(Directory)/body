{
  final long stopTime=System.currentTimeMillis() + 1000;
  SnapshotDeletionPolicy dp=new SnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy());
  final IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new StandardAnalyzer(TEST_VERSION_CURRENT)).setIndexDeletionPolicy(dp).setMaxBufferedDocs(2));
  writer.commit();
  final Thread t=new Thread(){
    @Override public void run(){
      Document doc=new Document();
      doc.add(new Field("content","aaa",Field.Store.YES,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
      do {
        for (int i=0; i < 27; i++) {
          try {
            writer.addDocument(doc);
          }
 catch (          Throwable t) {
            t.printStackTrace(System.out);
            fail("addDocument failed");
          }
          if (i % 2 == 0) {
            try {
              writer.commit();
            }
 catch (            Exception e) {
              throw new RuntimeException(e);
            }
          }
        }
        try {
          Thread.sleep(1);
        }
 catch (        InterruptedException ie) {
          throw new ThreadInterruptedException(ie);
        }
      }
 while (System.currentTimeMillis() < stopTime);
    }
  }
;
  t.start();
  do {
    backupIndex(dir,dp);
    Thread.sleep(20);
  }
 while (t.isAlive());
  t.join();
  Document doc=new Document();
  doc.add(new Field("content","aaa",Field.Store.YES,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
  writer.addDocument(doc);
  writer.close();
  TestIndexWriter.assertNoUnreferencedFiles(dir,"some files were not deleted but should have been");
}
