{
  if (!closed) {
    flushRamSegments();
    if (commitPending) {
      segmentInfos.write(directory);
      deleter.checkpoint(segmentInfos,true);
      commitPending=false;
      rollbackSegmentInfos=null;
    }
    ramDirectory.close();
    if (writeLock != null) {
      writeLock.release();
      writeLock=null;
    }
    closed=true;
    if (closeDir)     directory.close();
  }
}
