{
  flushRamSegments();
  while (segmentInfos.size() > 1 || (segmentInfos.size() == 1 && (SegmentReader.hasDeletions(segmentInfos.info(0)) || (useCompoundFile && !SegmentReader.usesCompoundFile(segmentInfos.info(0))) || segmentInfos.info(0).dir != directory))) {
    int minSegment=segmentInfos.size() - mergeFactor;
    mergeSegments(minSegment < 0 ? 0 : minSegment);
  }
}
