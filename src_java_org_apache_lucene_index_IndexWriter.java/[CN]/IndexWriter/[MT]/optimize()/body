{
  ensureOpen();
  flush();
  while (segmentInfos.size() > 1 || (segmentInfos.size() == 1 && (SegmentReader.hasDeletions(segmentInfos.info(0)) || SegmentReader.hasSeparateNorms(segmentInfos.info(0)) || segmentInfos.info(0).dir != directory || (useCompoundFile && !segmentInfos.info(0).getUseCompoundFile())))) {
    int minSegment=segmentInfos.size() - mergeFactor;
    mergeSegments(minSegment < 0 ? 0 : minSegment,segmentInfos.size());
  }
}
