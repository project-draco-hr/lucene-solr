{
  try {
    if (infoStream != null)     message("now flush at close");
    docWriter.close();
    flush(waitForMerges,true,true);
    if (waitForMerges)     mergeScheduler.merge(this);
    mergePolicy.close();
    finishMerges(waitForMerges);
    mergeScheduler.close();
    if (infoStream != null)     message("now call final commit()");
    commit(0);
    if (infoStream != null)     message("at close: " + segString());
synchronized (this) {
      docWriter=null;
      deleter.close();
    }
    if (closeDir)     directory.close();
    if (writeLock != null) {
      writeLock.release();
      writeLock=null;
    }
synchronized (this) {
      closed=true;
    }
  }
 catch (  OutOfMemoryError oom) {
    hitOOM=true;
    throw oom;
  }
 finally {
synchronized (this) {
      if (!closed) {
        closing=false;
        if (infoStream != null)         message("hit exception while closing");
      }
      notifyAll();
    }
  }
}
