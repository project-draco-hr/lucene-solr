{
  optimize();
  final String mergedName=newSegmentName();
  SegmentMerger merger=new SegmentMerger(this,mergedName);
  final Vector segmentsToDelete=new Vector();
  IndexReader sReader=null;
  if (segmentInfos.size() == 1) {
    sReader=SegmentReader.get(segmentInfos.info(0));
    merger.add(sReader);
    segmentsToDelete.addElement(sReader);
  }
  for (int i=0; i < readers.length; i++)   merger.add(readers[i]);
  int docCount=merger.merge();
  segmentInfos.setSize(0);
  SegmentInfo info=new SegmentInfo(mergedName,docCount,directory,false);
  segmentInfos.addElement(info);
  if (sReader != null)   sReader.close();
  String segmentsInfosFileName=segmentInfos.getCurrentSegmentFileName();
  segmentInfos.write(directory);
  deleter.deleteFile(segmentsInfosFileName);
  deleter.deleteSegments(segmentsToDelete);
  if (useCompoundFile) {
    Vector filesToDelete=merger.createCompoundFile(mergedName + ".cfs");
    segmentsInfosFileName=segmentInfos.getCurrentSegmentFileName();
    info.setUseCompoundFile(true);
    segmentInfos.write(directory);
    deleter.deleteFile(segmentsInfosFileName);
    deleter.deleteFiles(filesToDelete);
  }
}
