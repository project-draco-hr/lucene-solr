{
  optimize();
  final String mergedName=newSegmentName();
  SegmentMerger merger=new SegmentMerger(this,mergedName);
  SegmentInfo info;
  IndexReader sReader=null;
  try {
    if (segmentInfos.size() == 1) {
      sReader=SegmentReader.get(segmentInfos.info(0));
      merger.add(sReader);
    }
    for (int i=0; i < readers.length; i++)     merger.add(readers[i]);
    boolean success=false;
    startTransaction();
    try {
      int docCount=merger.merge();
      if (sReader != null) {
        sReader.close();
        sReader=null;
      }
      segmentInfos.setSize(0);
      info=new SegmentInfo(mergedName,docCount,directory,false,true);
      segmentInfos.addElement(info);
      success=true;
    }
  finally {
      if (!success) {
        rollbackTransaction();
      }
 else {
        commitTransaction();
      }
    }
  }
  finally {
    if (sReader != null) {
      sReader.close();
    }
  }
  if (useCompoundFile) {
    boolean success=false;
    startTransaction();
    try {
      merger.createCompoundFile(mergedName + ".cfs");
      info.setUseCompoundFile(true);
    }
  finally {
      if (!success) {
        rollbackTransaction();
      }
 else {
        commitTransaction();
      }
    }
  }
}
