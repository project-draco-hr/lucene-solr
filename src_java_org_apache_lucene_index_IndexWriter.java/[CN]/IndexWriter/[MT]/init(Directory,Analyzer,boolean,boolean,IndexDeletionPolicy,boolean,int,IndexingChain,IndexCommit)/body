{
  this.closeDir=closeDir;
  directory=d;
  analyzer=a;
  setMessageID(defaultInfoStream);
  this.maxFieldLength=maxFieldLength;
  if (indexingChain == null)   indexingChain=DocumentsWriter.DefaultIndexingChain;
  if (create) {
    directory.clearLock(WRITE_LOCK_NAME);
  }
  Lock writeLock=directory.makeLock(WRITE_LOCK_NAME);
  if (!writeLock.obtain(writeLockTimeout))   throw new LockObtainFailedException("Index locked for write: " + writeLock);
  this.writeLock=writeLock;
  try {
    if (create) {
      try {
        segmentInfos.read(directory);
        segmentInfos.clear();
      }
 catch (      IOException e) {
      }
      segmentInfos.commit(directory);
    }
 else {
      segmentInfos.read(directory);
      if (commit != null) {
        if (commit.getDirectory() != directory)         throw new IllegalArgumentException("IndexCommit's directory doesn't match my directory");
        SegmentInfos oldInfos=new SegmentInfos();
        oldInfos.read(directory,commit.getSegmentsFileName());
        segmentInfos.replace(oldInfos);
        changeCount++;
        message("init: loaded commit \"" + commit.getSegmentsFileName() + "\"");
      }
      for (int i=0; i < segmentInfos.size(); i++) {
        final SegmentInfo info=segmentInfos.info(i);
        List files=info.files();
        for (int j=0; j < files.size(); j++)         synced.add(files.get(j));
      }
    }
    this.autoCommit=autoCommit;
    setRollbackSegmentInfos(segmentInfos);
    docWriter=new DocumentsWriter(directory,this,indexingChain);
    docWriter.setInfoStream(infoStream);
    docWriter.setMaxFieldLength(maxFieldLength);
    deleter=new IndexFileDeleter(directory,deletionPolicy == null ? new KeepOnlyLastCommitDeletionPolicy() : deletionPolicy,segmentInfos,infoStream,docWriter);
    if (deleter.startingCommitDeleted)     changeCount++;
    pushMaxBufferedDocs();
    if (infoStream != null) {
      message("init: create=" + create);
      messageState();
    }
  }
 catch (  IOException e) {
    this.writeLock.release();
    this.writeLock=null;
    throw e;
  }
}
