{
  final HashMap bufferedDeleteTerms=docWriter.getBufferedDeleteTerms();
  int delCount=0;
  if (bufferedDeleteTerms.size() > 0) {
    if (infoStream != null)     message("flush " + docWriter.getNumBufferedDeleteTerms() + " buffered deleted terms on "+ segmentInfos.size()+ " segments.");
    if (flushedNewSegment) {
      IndexReader reader=null;
      try {
        reader=SegmentReader.get(segmentInfos.info(segmentInfos.size() - 1),false);
        delCount+=applyDeletesSelectively(bufferedDeleteTerms,reader);
      }
  finally {
        if (reader != null) {
          try {
            reader.doCommit();
          }
  finally {
            reader.doClose();
          }
        }
      }
    }
    int infosEnd=segmentInfos.size();
    if (flushedNewSegment) {
      infosEnd--;
    }
    for (int i=0; i < infosEnd; i++) {
      IndexReader reader=null;
      try {
        reader=SegmentReader.get(segmentInfos.info(i),false);
        delCount+=applyDeletes(bufferedDeleteTerms,reader);
      }
  finally {
        if (reader != null) {
          try {
            reader.doCommit();
          }
  finally {
            reader.doClose();
          }
        }
      }
    }
    docWriter.clearBufferedDeleteTerms();
  }
  return delCount;
}
