{
  directory=d;
  analyzer=a;
  Lock writeLock=directory.makeLock(IndexWriter.WRITE_LOCK_NAME);
  if (!writeLock.obtain(WRITE_LOCK_TIMEOUT))   throw new IOException("Index locked for write: " + writeLock);
  this.writeLock=writeLock;
synchronized (directory) {
    new Lock.With(directory.makeLock(IndexWriter.COMMIT_LOCK_NAME),COMMIT_LOCK_TIMEOUT){
      public Object doBody() throws IOException {
        if (create)         segmentInfos.write(directory);
 else         segmentInfos.read(directory);
        return null;
      }
    }
.run();
  }
}
