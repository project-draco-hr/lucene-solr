{
  directory=d;
  analyzer=a;
  Lock writeLock=directory.makeLock("write.lock");
  if (!writeLock.obtain())   throw new IOException("Index locked for write: " + writeLock);
synchronized (directory) {
    new Lock.With(directory.makeLock("commit.lock")){
      public Object doBody() throws IOException {
        if (create)         segmentInfos.write(directory);
 else         segmentInfos.read(directory);
        return null;
      }
    }
.run();
  }
}
