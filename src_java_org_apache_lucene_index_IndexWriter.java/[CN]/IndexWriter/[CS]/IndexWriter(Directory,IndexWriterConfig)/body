{
  config=(IndexWriterConfig)conf.clone();
  directory=d;
  analyzer=conf.getAnalyzer();
  setMessageID(defaultInfoStream);
  maxFieldLength=conf.getMaxFieldLength();
  termIndexInterval=conf.getTermIndexInterval();
  writeLockTimeout=conf.getWriteLockTimeout();
  similarity=conf.getSimilarity();
  mergeScheduler=conf.getMergeScheduler();
  mergedSegmentWarmer=conf.getMergedSegmentWarmer();
  OpenMode mode=conf.getOpenMode();
  boolean create;
  if (mode == OpenMode.CREATE) {
    create=true;
  }
 else   if (mode == OpenMode.APPEND) {
    create=false;
  }
 else {
    create=!IndexReader.indexExists(directory);
  }
  if (create) {
    directory.clearLock(WRITE_LOCK_NAME);
  }
  writeLock=directory.makeLock(WRITE_LOCK_NAME);
  if (!writeLock.obtain(writeLockTimeout))   throw new LockObtainFailedException("Index locked for write: " + writeLock);
  try {
    if (create) {
      boolean doCommit;
      try {
        segmentInfos.read(directory);
        segmentInfos.clear();
        doCommit=false;
      }
 catch (      IOException e) {
        doCommit=true;
      }
      if (doCommit) {
        segmentInfos.commit(directory);
        synced.addAll(segmentInfos.files(directory,true));
      }
 else {
        changeCount++;
      }
    }
 else {
      segmentInfos.read(directory);
      IndexCommit commit=conf.getIndexCommit();
      if (commit != null) {
        if (commit.getDirectory() != directory)         throw new IllegalArgumentException("IndexCommit's directory doesn't match my directory");
        SegmentInfos oldInfos=new SegmentInfos();
        oldInfos.read(directory,commit.getSegmentsFileName());
        segmentInfos.replace(oldInfos);
        changeCount++;
        if (infoStream != null)         message("init: loaded commit \"" + commit.getSegmentsFileName() + "\"");
      }
      synced.addAll(segmentInfos.files(directory,true));
    }
    setRollbackSegmentInfos(segmentInfos);
    docWriter=new DocumentsWriter(directory,this,conf.getIndexingChain());
    docWriter.setInfoStream(infoStream);
    docWriter.setMaxFieldLength(maxFieldLength);
    deleter=new IndexFileDeleter(directory,conf.getIndexDeletionPolicy(),segmentInfos,infoStream,docWriter);
    if (deleter.startingCommitDeleted)     changeCount++;
    docWriter.setMaxBufferedDeleteTerms(conf.getMaxBufferedDeleteTerms());
    docWriter.setRAMBufferSizeMB(conf.getRAMBufferSizeMB());
    docWriter.setMaxBufferedDocs(conf.getMaxBufferedDocs());
    pushMaxBufferedDocs();
    if (infoStream != null) {
      messageState();
    }
  }
 catch (  IOException e) {
    writeLock.release();
    writeLock=null;
    throw e;
  }
}
