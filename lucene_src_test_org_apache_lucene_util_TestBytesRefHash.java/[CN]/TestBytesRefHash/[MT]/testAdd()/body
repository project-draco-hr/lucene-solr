{
  BytesRef ref=new BytesRef();
  BytesRef scratch=new BytesRef();
  for (int j=0; j < 2 * RANDOM_MULTIPLIER; j++) {
    Set<String> strings=new HashSet<String>();
    int uniqueCount=0;
    for (int i=0; i < 797; i++) {
      String str;
      do {
        str=_TestUtil.randomRealisticUnicodeString(random,1000);
      }
 while (str.length() == 0);
      ref.copy(str);
      int count=hash.size();
      int key=hash.add(ref);
      if (key >= 0) {
        assertTrue(strings.add(str));
        assertEquals(uniqueCount,key);
        assertEquals(hash.size(),count + 1);
        uniqueCount++;
      }
 else {
        assertFalse(strings.add(str));
        assertTrue((-key) - 1 < count);
        assertEquals(str,hash.get((-key) - 1,scratch).utf8ToString());
        assertEquals(count,hash.size());
      }
    }
    assertAllIn(strings,hash);
    hash.clear();
    assertEquals(0,hash.size());
    hash.reinit();
  }
}
