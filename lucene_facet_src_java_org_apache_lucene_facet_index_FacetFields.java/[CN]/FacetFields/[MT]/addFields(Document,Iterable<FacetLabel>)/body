{
  if (categories == null) {
    throw new IllegalArgumentException("categories should not be null");
  }
  final Map<CategoryListParams,Iterable<FacetLabel>> categoryLists=createCategoryListMapping(categories);
  IntsRef ordinals=new IntsRef(32);
  for (  Entry<CategoryListParams,Iterable<FacetLabel>> e : categoryLists.entrySet()) {
    final CategoryListParams clp=e.getKey();
    final String field=clp.field;
    ordinals.length=0;
    int maxNumOrds=0;
    for (    FacetLabel cp : e.getValue()) {
      int ordinal=taxonomyWriter.addCategory(cp);
      maxNumOrds+=cp.length;
      if (ordinals.ints.length < maxNumOrds) {
        ordinals.grow(maxNumOrds);
      }
      ordinals.ints[ordinals.length++]=ordinal;
    }
    Map<String,BytesRef> categoriesData=getCategoryListData(clp,ordinals,e.getValue());
    addCountingListData(doc,categoriesData,field);
    DrillDownStream drillDownStream=getDrillDownStream(e.getValue());
    Field drillDown=new Field(field,drillDownStream,drillDownFieldType());
    doc.add(drillDown);
  }
}
