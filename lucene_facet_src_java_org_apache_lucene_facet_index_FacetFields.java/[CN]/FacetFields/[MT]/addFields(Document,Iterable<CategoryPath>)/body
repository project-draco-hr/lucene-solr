{
  if (categories == null) {
    throw new IllegalArgumentException("categories should not be null");
  }
  final Map<CategoryListParams,Iterable<CategoryPath>> categoryLists=createCategoryListMapping(categories);
  for (  Entry<CategoryListParams,Iterable<CategoryPath>> e : categoryLists.entrySet()) {
    final CategoryListParams clp=e.getKey();
    final String field=clp.getTerm().field();
    CategoryListBuilder categoriesPayloadBuilder=getCategoryListBuilder(clp,e.getValue());
    for (    CategoryPath cp : e.getValue()) {
      int ordinal=taxonomyWriter.addCategory(cp);
      categoriesPayloadBuilder.handle(ordinal,cp);
    }
    HashMap<String,BytesRef> categoriesData=categoriesPayloadBuilder.finish();
    CountingListStream ts=new CountingListStream();
    ts.setCategoriesData(categoriesData);
    doc.add(new Field(field,ts,COUNTING_LIST_PAYLOAD_TYPE));
    DrillDownStream drillDownStream=getDrillDownStream(e.getValue());
    Field drillDown=new Field(field,drillDownStream,fieldType());
    doc.add(drillDown);
  }
}
