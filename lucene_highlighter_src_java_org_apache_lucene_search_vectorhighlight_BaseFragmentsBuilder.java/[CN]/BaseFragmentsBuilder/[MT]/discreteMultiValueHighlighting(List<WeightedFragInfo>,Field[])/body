{
  Map<String,List<WeightedFragInfo>> fieldNameToFragInfos=new HashMap<>();
  for (  Field field : fields) {
    fieldNameToFragInfos.put(field.name(),new ArrayList<WeightedFragInfo>());
  }
  fragInfos:   for (  WeightedFragInfo fragInfo : fragInfos) {
    int fieldStart;
    int fieldEnd=0;
    for (    Field field : fields) {
      if (field.stringValue().isEmpty()) {
        fieldEnd++;
        continue;
      }
      fieldStart=fieldEnd;
      fieldEnd+=field.stringValue().length() + 1;
      if (fragInfo.getStartOffset() >= fieldStart && fragInfo.getEndOffset() >= fieldStart && fragInfo.getStartOffset() <= fieldEnd && fragInfo.getEndOffset() <= fieldEnd) {
        fieldNameToFragInfos.get(field.name()).add(fragInfo);
        continue fragInfos;
      }
      if (fragInfo.getSubInfos().isEmpty()) {
        continue fragInfos;
      }
      Toffs firstToffs=fragInfo.getSubInfos().get(0).getTermsOffsets().get(0);
      if (fragInfo.getStartOffset() >= fieldEnd || firstToffs.getStartOffset() >= fieldEnd) {
        continue;
      }
      int fragStart=fieldStart;
      if (fragInfo.getStartOffset() > fieldStart && fragInfo.getStartOffset() < fieldEnd) {
        fragStart=fragInfo.getStartOffset();
      }
      int fragEnd=fieldEnd;
      if (fragInfo.getEndOffset() > fieldStart && fragInfo.getEndOffset() < fieldEnd) {
        fragEnd=fragInfo.getEndOffset();
      }
      List<SubInfo> subInfos=new ArrayList<>();
      Iterator<SubInfo> subInfoIterator=fragInfo.getSubInfos().iterator();
      float boost=0.0f;
      while (subInfoIterator.hasNext()) {
        SubInfo subInfo=subInfoIterator.next();
        List<Toffs> toffsList=new ArrayList<>();
        Iterator<Toffs> toffsIterator=subInfo.getTermsOffsets().iterator();
        while (toffsIterator.hasNext()) {
          Toffs toffs=toffsIterator.next();
          if (toffs.getStartOffset() >= fieldEnd) {
            break;
          }
          boolean startsAfterField=toffs.getStartOffset() >= fieldStart;
          boolean endsBeforeField=toffs.getEndOffset() < fieldEnd;
          if (startsAfterField && endsBeforeField) {
            toffsList.add(toffs);
            toffsIterator.remove();
          }
 else           if (startsAfterField) {
            toffsList.add(new Toffs(toffs.getStartOffset(),fieldEnd - 1));
          }
 else           if (endsBeforeField) {
            toffsList.add(new Toffs(fieldStart,toffs.getEndOffset()));
            toffsIterator.remove();
          }
 else {
            toffsList.add(new Toffs(fieldStart,fieldEnd - 1));
          }
        }
        if (!toffsList.isEmpty()) {
          subInfos.add(new SubInfo(subInfo.getText(),toffsList,subInfo.getSeqnum(),subInfo.getBoost()));
          boost+=subInfo.getBoost();
        }
        if (subInfo.getTermsOffsets().isEmpty()) {
          subInfoIterator.remove();
        }
      }
      WeightedFragInfo weightedFragInfo=new WeightedFragInfo(fragStart,fragEnd,subInfos,boost);
      fieldNameToFragInfos.get(field.name()).add(weightedFragInfo);
    }
  }
  List<WeightedFragInfo> result=new ArrayList<>();
  for (  List<WeightedFragInfo> weightedFragInfos : fieldNameToFragInfos.values()) {
    result.addAll(weightedFragInfos);
  }
  Collections.sort(result,new Comparator<WeightedFragInfo>(){
    @Override public int compare(    FieldFragList.WeightedFragInfo info1,    FieldFragList.WeightedFragInfo info2){
      return info1.getStartOffset() - info2.getStartOffset();
    }
  }
);
  return result;
}
