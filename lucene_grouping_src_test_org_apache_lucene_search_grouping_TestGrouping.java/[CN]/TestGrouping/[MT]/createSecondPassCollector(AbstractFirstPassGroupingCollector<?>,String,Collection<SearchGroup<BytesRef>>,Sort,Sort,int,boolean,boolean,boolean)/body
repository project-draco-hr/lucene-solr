{
  if (firstPassGroupingCollector.getClass().isAssignableFrom(TermFirstPassGroupingCollector.class)) {
    return new TermSecondPassGroupingCollector(groupField,searchGroups,groupSort,sortWithinGroup,maxDocsPerGroup,getScores,getMaxScores,fillSortFields);
  }
 else {
    ValueSource vs=new BytesRefFieldSource(groupField);
    List<SearchGroup<MutableValue>> mvalSearchGroups=new ArrayList<>(searchGroups.size());
    for (    SearchGroup<BytesRef> mergedTopGroup : searchGroups) {
      SearchGroup<MutableValue> sg=new SearchGroup<>();
      MutableValueStr groupValue=new MutableValueStr();
      if (mergedTopGroup.groupValue != null) {
        groupValue.value.copyBytes(mergedTopGroup.groupValue);
      }
 else {
        groupValue.exists=false;
      }
      sg.groupValue=groupValue;
      sg.sortValues=mergedTopGroup.sortValues;
      mvalSearchGroups.add(sg);
    }
    return new FunctionSecondPassGroupingCollector(mvalSearchGroups,groupSort,sortWithinGroup,maxDocsPerGroup,getScores,getMaxScores,fillSortFields,vs,new HashMap<>());
  }
}
