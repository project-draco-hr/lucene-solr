{
  SolrCmdDistributor cmdDistrib=new SolrCmdDistributor(8);
  ModifiableSolrParams params=new ModifiableSolrParams();
  List<Node> nodes=new ArrayList<Node>();
  ZkNodeProps nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,((HttpSolrServer)controlClient).getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
  nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
  AddUpdateCommand cmd=new AddUpdateCommand(null);
  cmd.solrDoc=sdoc("id",1);
  cmdDistrib.distribAdd(cmd,nodes,params);
  CommitUpdateCommand ccmd=new CommitUpdateCommand(null,false);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  Response response=cmdDistrib.getResponse();
  assertEquals(response.errors.toString(),0,response.errors.size());
  long numFound=controlClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(1,numFound);
  HttpSolrServer client=(HttpSolrServer)clients.get(0);
  nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,client.getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
  nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
  cmdDistrib=new SolrCmdDistributor(8);
  cmd.solrDoc=sdoc("id",2);
  cmdDistrib.distribAdd(cmd,nodes,params);
  AddUpdateCommand cmd2=new AddUpdateCommand(null);
  cmd2.solrDoc=sdoc("id",3);
  cmdDistrib.distribAdd(cmd2,nodes,params);
  AddUpdateCommand cmd3=new AddUpdateCommand(null);
  cmd3.solrDoc=sdoc("id",4);
  cmdDistrib.distribAdd(cmd3,Collections.singletonList(nodes.get(1)),params);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  response=cmdDistrib.getResponse();
  assertEquals(response.errors.toString(),0,response.errors.size());
  SolrDocumentList results=controlClient.query(new SolrQuery("*:*")).getResults();
  numFound=results.getNumFound();
  assertEquals(results.toString(),3,numFound);
  numFound=client.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(3,numFound);
  DeleteUpdateCommand dcmd=new DeleteUpdateCommand(null);
  dcmd.id="2";
  cmdDistrib=new SolrCmdDistributor(8);
  cmdDistrib.distribDelete(dcmd,nodes,params);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  response=cmdDistrib.getResponse();
  assertEquals(response.errors.toString(),0,response.errors.size());
  results=controlClient.query(new SolrQuery("*:*")).getResults();
  numFound=results.getNumFound();
  assertEquals(results.toString(),2,numFound);
  numFound=client.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(results.toString(),2,numFound);
}
