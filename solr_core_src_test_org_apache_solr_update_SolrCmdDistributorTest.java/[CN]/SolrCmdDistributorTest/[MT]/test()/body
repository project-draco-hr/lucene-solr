{
  del("*:*");
  SolrCmdDistributor cmdDistrib=new SolrCmdDistributor(updateShardHandler);
  ModifiableSolrParams params=new ModifiableSolrParams();
  List<Node> nodes=new ArrayList<>();
  ZkNodeProps nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,((HttpSolrClient)controlClient).getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
  nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
  AddUpdateCommand cmd=new AddUpdateCommand(null);
  cmd.solrDoc=sdoc("id",id.incrementAndGet());
  params=new ModifiableSolrParams();
  cmdDistrib.distribAdd(cmd,nodes,params);
  CommitUpdateCommand ccmd=new CommitUpdateCommand(null,false);
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  List<Error> errors=cmdDistrib.getErrors();
  assertEquals(errors.toString(),0,errors.size());
  long numFound=controlClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(1,numFound);
  HttpSolrClient client=(HttpSolrClient)clients.get(0);
  nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,client.getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
  nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
  cmdDistrib=new SolrCmdDistributor(updateShardHandler);
  cmd.solrDoc=sdoc("id",id.incrementAndGet());
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribAdd(cmd,nodes,params);
  int id2=id.incrementAndGet();
  AddUpdateCommand cmd2=new AddUpdateCommand(null);
  cmd2.solrDoc=sdoc("id",id2);
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribAdd(cmd2,nodes,params);
  AddUpdateCommand cmd3=new AddUpdateCommand(null);
  cmd3.solrDoc=sdoc("id",id.incrementAndGet());
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribAdd(cmd3,Collections.singletonList(nodes.get(1)),params);
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  errors=cmdDistrib.getErrors();
  assertEquals(errors.toString(),0,errors.size());
  SolrDocumentList results=controlClient.query(new SolrQuery("*:*")).getResults();
  numFound=results.getNumFound();
  assertEquals(results.toString(),3,numFound);
  numFound=client.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(3,numFound);
  DeleteUpdateCommand dcmd=new DeleteUpdateCommand(null);
  dcmd.id=Integer.toString(id2);
  cmdDistrib=new SolrCmdDistributor(updateShardHandler);
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribDelete(dcmd,nodes,params);
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  errors=cmdDistrib.getErrors();
  assertEquals(errors.toString(),0,errors.size());
  results=controlClient.query(new SolrQuery("*:*")).getResults();
  numFound=results.getNumFound();
  assertEquals(results.toString(),2,numFound);
  numFound=client.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(results.toString(),2,numFound);
  for (  SolrClient c : clients) {
    c.optimize();
  }
  cmdDistrib=new SolrCmdDistributor(updateShardHandler);
  int cnt=atLeast(303);
  for (int i=0; i < cnt; i++) {
    nodes.clear();
    for (    SolrClient c : clients) {
      if (random().nextBoolean()) {
        continue;
      }
      HttpSolrClient httpClient=(HttpSolrClient)c;
      nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,httpClient.getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
      nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
    }
    AddUpdateCommand c=new AddUpdateCommand(null);
    c.solrDoc=sdoc("id",id.incrementAndGet());
    if (nodes.size() > 0) {
      params=new ModifiableSolrParams();
      cmdDistrib.distribAdd(c,nodes,params);
    }
  }
  nodes.clear();
  for (  SolrClient c : clients) {
    HttpSolrClient httpClient=(HttpSolrClient)c;
    nodeProps=new ZkNodeProps(ZkStateReader.BASE_URL_PROP,httpClient.getBaseURL(),ZkStateReader.CORE_NAME_PROP,"");
    nodes.add(new StdNode(new ZkCoreNodeProps(nodeProps)));
  }
  final AtomicInteger commits=new AtomicInteger();
  for (  JettySolrRunner jetty : jettys) {
    CoreContainer cores=jetty.getCoreContainer();
    try (SolrCore core=cores.getCore("collection1")){
      core.getUpdateHandler().registerCommitCallback(new SolrEventListener(){
        @Override public void init(        NamedList args){
        }
        @Override public void postSoftCommit(){
        }
        @Override public void postCommit(){
          commits.incrementAndGet();
        }
        @Override public void newSearcher(        SolrIndexSearcher newSearcher,        SolrIndexSearcher currentSearcher){
        }
      }
);
    }
   }
  params=new ModifiableSolrParams();
  params.set(DistributedUpdateProcessor.COMMIT_END_POINT,true);
  cmdDistrib.distribCommit(ccmd,nodes,params);
  cmdDistrib.finish();
  assertEquals(getShardCount(),commits.get());
  for (  SolrClient c : clients) {
    NamedList<Object> resp=c.request(new LukeRequest());
    assertEquals("SOLR-3428: We only did adds - there should be no deletes",((NamedList<Object>)resp.get("index")).get("numDocs"),((NamedList<Object>)resp.get("index")).get("maxDoc"));
  }
  testMaxRetries();
  testOneRetry();
  testRetryNodeAgainstBadAddress();
  testRetryNodeWontRetrySocketError();
  testDistribOpenSearcher();
}
