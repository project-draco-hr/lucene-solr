{
  String fromReplica=null;
  String nodeName=zkController.getNodeName();
  for (  Slice slice : zkController.getClusterState().getActiveSlices(fromIndex)) {
    if (fromReplica != null)     throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"SolrCloud join: multiple shards not yet supported " + fromIndex);
    for (    Replica replica : slice.getReplicas()) {
      if (replica.getNodeName().equals(nodeName)) {
        fromReplica=replica.getStr(ZkStateReader.CORE_NAME_PROP);
        if (replica.getState() != Replica.State.ACTIVE)         throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"SolrCloud join: " + fromIndex + " has a local replica ("+ fromReplica+ ") on "+ nodeName+ ", but it is "+ replica.getState());
        break;
      }
    }
  }
  if (fromReplica == null)   throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"SolrCloud join: No active replicas for " + fromIndex + " found in node "+ nodeName);
  return fromReplica;
}
