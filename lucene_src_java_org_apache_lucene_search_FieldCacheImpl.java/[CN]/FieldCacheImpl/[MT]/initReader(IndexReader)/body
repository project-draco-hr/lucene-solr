{
  if (reader instanceof SegmentReader) {
    ((SegmentReader)reader).addCoreClosedListener(purgeCore);
  }
 else   if (reader.getSequentialSubReaders() != null) {
    throw new UnsupportedOperationException("Please use SlowMultiReaderWrapper, if you really need a top level FieldCache");
  }
 else {
    Object key=reader.getCoreCacheKey();
    if (key instanceof IndexReader) {
      ((IndexReader)key).addReaderClosedListener(new IndexReader.ReaderClosedListener(){
        @Override public void onClose(        IndexReader reader){
          FieldCache.DEFAULT.purge(reader);
        }
      }
);
    }
  }
}
