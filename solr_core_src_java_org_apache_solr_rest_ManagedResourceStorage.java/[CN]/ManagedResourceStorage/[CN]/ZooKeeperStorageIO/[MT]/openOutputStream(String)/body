{
  final String znodePath=getZnodeForResource(storedResourceId);
  final boolean retryOnConnLoss=this.retryOnConnLoss;
  ByteArrayOutputStream baos=new ByteArrayOutputStream(){
    @Override public void close(){
      byte[] znodeData=toByteArray();
      try {
        if (zkClient.exists(znodePath,retryOnConnLoss)) {
          zkClient.setData(znodePath,znodeData,retryOnConnLoss);
          log.info("Wrote {} bytes to existing znode {}",znodeData.length,znodePath);
        }
 else {
          zkClient.makePath(znodePath,znodeData,retryOnConnLoss);
          log.info("Wrote {} bytes to new znode {}",znodeData.length,znodePath);
        }
      }
 catch (      Exception e) {
        if (e instanceof RuntimeException) {
          throw (RuntimeException)e;
        }
 else {
          throw new ResourceException(Status.SERVER_ERROR_INTERNAL,"Failed to save data to ZooKeeper znode: " + znodePath + " due to: "+ e,e);
        }
      }
    }
  }
;
  return baos;
}
