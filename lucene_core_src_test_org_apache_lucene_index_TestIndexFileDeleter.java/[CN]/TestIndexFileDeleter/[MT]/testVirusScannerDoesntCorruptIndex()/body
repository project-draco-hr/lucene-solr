{
  MockDirectoryWrapper dir=newMockDirectory();
  dir.setPreventDoubleWrite(false);
  new IndexWriter(dir,new IndexWriterConfig(null)).close();
  dir.createOutput("_0.si",IOContext.DEFAULT).close();
  final AtomicBoolean stopScanning=new AtomicBoolean();
  dir.failOn(new MockDirectoryWrapper.Failure(){
    @Override public void eval(    MockDirectoryWrapper dir) throws IOException {
      if (stopScanning.get()) {
        return;
      }
      for (      StackTraceElement f : new Exception().getStackTrace()) {
        if ("deleteFile".equals(f.getMethodName())) {
          throw new IOException("temporarily cannot delete file");
        }
      }
    }
  }
);
  IndexWriter iw=new IndexWriter(dir,new IndexWriterConfig(null));
  iw.addDocument(new Document());
  stopScanning.set(true);
  iw.commit();
  iw.close();
  dir.close();
}
