{
  RAMDirectory directory=new MockRAMDirectory();
  Document doc=new Document();
  Field idField=new Field("id","",Field.Store.YES,Field.Index.NOT_ANALYZED);
  doc.add(idField);
  for (int pass=0; pass < 2; pass++) {
    boolean autoCommit=pass == 0;
    IndexWriter writer=new IndexWriter(directory,autoCommit,ANALYZER,true);
    for (int iter=0; iter < 10; iter++) {
      ConcurrentMergeScheduler cms=new ConcurrentMergeScheduler();
      writer.setMergeScheduler(cms);
      writer.setMaxBufferedDocs(2);
      writer.setMergeFactor(100);
      for (int j=0; j < 201; j++) {
        idField.setValue(Integer.toString(iter * 201 + j));
        writer.addDocument(doc);
      }
      int delID=iter * 201;
      for (int j=0; j < 20; j++) {
        writer.deleteDocuments(new Term("id",Integer.toString(delID)));
        delID+=5;
      }
      writer.setMergeFactor(3);
      writer.addDocument(doc);
      writer.flush();
      writer.close(false);
      IndexReader reader=IndexReader.open(directory,true);
      assertEquals((1 + iter) * 182,reader.numDocs());
      reader.close();
      writer=new IndexWriter(directory,autoCommit,ANALYZER,false);
    }
    writer.close();
  }
  directory.close();
}
