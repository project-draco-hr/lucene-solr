{
  Directory indexDir=newDirectory();
  Directory taxoDir=newDirectory();
  DirectoryTaxonomyWriter taxoWriter=new DirectoryTaxonomyWriter(taxoDir);
  IndexWriter iw=new IndexWriter(indexDir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  FacetsConfig config=new FacetsConfig(taxoWriter);
  for (int i=atLeast(30); i > 0; --i) {
    Document doc=new Document();
    if (random().nextBoolean()) {
      doc.add(new StringField("f","v",Field.Store.NO));
    }
    doc.add(new FacetField("dim","a"));
    iw.addDocument(config.build(doc));
  }
  DirectoryReader r=DirectoryReader.open(iw,true);
  DirectoryTaxonomyReader taxoReader=new DirectoryTaxonomyReader(taxoWriter);
  SimpleFacetsCollector fc=new SimpleFacetsCollector(true);
  TopScoreDocCollector topDocs=TopScoreDocCollector.create(10,false);
  ConstantScoreQuery csq=new ConstantScoreQuery(new MatchAllDocsQuery());
  csq.setBoost(2.0f);
  newSearcher(r).search(csq,MultiCollector.wrap(fc,topDocs));
  Facets facets=new TaxonomyFacetSumValueSource(taxoReader,config,fc,new TaxonomyFacetSumValueSource.ScoreValueSource());
  TopDocs td=topDocs.topDocs();
  int expected=(int)(td.getMaxScore() * td.totalHits);
  assertEquals(expected,facets.getSpecificValue("dim","a").intValue());
  IOUtils.close(iw,taxoWriter,taxoReader,taxoDir,r,indexDir);
}
