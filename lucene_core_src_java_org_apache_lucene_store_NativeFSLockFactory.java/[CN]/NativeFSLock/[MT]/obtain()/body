{
  if (lock != null) {
    return false;
  }
  Files.createDirectories(lockDir);
  try {
    Files.createFile(path);
  }
 catch (  IOException ignore) {
  }
  final Path canonicalPath=path.toRealPath();
  boolean obtained=false;
  if (LOCK_HELD.add(canonicalPath.toString())) {
    try {
      channel=FileChannel.open(path,StandardOpenOption.CREATE,StandardOpenOption.WRITE);
      try {
        lock=channel.tryLock();
        obtained=lock != null;
      }
 catch (      IOException|OverlappingFileLockException e) {
        failureReason=e;
      }
    }
  finally {
      if (obtained == false) {
        clearLockHeld(path);
        final FileChannel toClose=channel;
        channel=null;
        IOUtils.closeWhileHandlingException(toClose);
      }
    }
  }
  return obtained;
}
