{
  if (lock != null) {
    return false;
  }
  if (!lockDir.exists()) {
    if (!lockDir.mkdirs())     throw new IOException("Cannot create directory: " + lockDir.getAbsolutePath());
  }
 else   if (!lockDir.isDirectory()) {
    throw new IOException("Found regular file where directory expected: " + lockDir.getAbsolutePath());
  }
  channel=FileChannel.open(path.toPath(),StandardOpenOption.CREATE,StandardOpenOption.WRITE);
  boolean success=false;
  try {
    lock=channel.tryLock();
    success=lock != null;
  }
 catch (  IOException|OverlappingFileLockException e) {
    failureReason=e;
  }
 finally {
    if (!success) {
      try {
        IOUtils.closeWhileHandlingException(channel);
      }
  finally {
        channel=null;
      }
    }
  }
  return lock != null;
}
