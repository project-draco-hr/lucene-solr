{
  SolrParams params=rb.req.getParams();
  if (params.getBool(TermsParams.TERMS,false)) {
    String lowerStr=params.get(TermsParams.TERMS_LOWER,null);
    String[] fields=params.getParams(TermsParams.TERMS_FIELD);
    if (fields != null && fields.length > 0) {
      NamedList terms=new NamedList();
      rb.rsp.add("terms",terms);
      int rows=params.getInt(TermsParams.TERMS_LIMIT,10);
      if (rows < 0) {
        rows=Integer.MAX_VALUE;
      }
      String upperStr=params.get(TermsParams.TERMS_UPPER);
      boolean upperIncl=params.getBool(TermsParams.TERMS_UPPER_INCLUSIVE,false);
      boolean lowerIncl=params.getBool(TermsParams.TERMS_LOWER_INCLUSIVE,true);
      int freqmin=params.getInt(TermsParams.TERMS_MINCOUNT,1);
      int freqmax=params.getInt(TermsParams.TERMS_MAXCOUNT,UNLIMITED_MAX_COUNT);
      String prefix=params.get(TermsParams.TERMS_PREFIX_STR);
      boolean raw=params.getBool(TermsParams.TERMS_RAW,false);
      for (int j=0; j < fields.length; j++) {
        String field=fields[j];
        FieldType ft=raw ? null : rb.req.getSchema().getFieldTypeNoEx(field);
        if (ft == null)         ft=new StrField();
        String lower=lowerStr == null ? "" : ft.toInternal(lowerStr);
        String upper=upperStr == null ? null : ft.toInternal(upperStr);
        Term lowerTerm=new Term(field,lower);
        Term upperTerm=upper != null ? new Term(field,upper) : null;
        TermEnum termEnum=rb.req.getSearcher().getReader().terms(lowerTerm);
        int i=0;
        NamedList fieldTerms=new NamedList();
        terms.add(field,fieldTerms);
        boolean hasMore=true;
        Term lowerTestTerm=termEnum.term();
        if (lowerIncl == false && lowerTestTerm.field().equals(field) == true && lowerTestTerm.text().equals(lower)) {
          hasMore=termEnum.next();
        }
        if (hasMore == true) {
          do {
            Term theTerm=termEnum.term();
            String indexedText=theTerm.text();
            String readableText=ft.indexedToReadable(indexedText);
            int upperCmp=upperTerm != null ? theTerm.compareTo(upperTerm) : -1;
            if (theTerm != null && theTerm.field().equals(field) && ((upperIncl == true && upperCmp <= 0) || (upperIncl == false && upperCmp < 0)) && (prefix == null || readableText.startsWith(prefix))) {
              int docFreq=termEnum.docFreq();
              if (docFreq >= freqmin && (freqmax == UNLIMITED_MAX_COUNT || (docFreq <= freqmax))) {
                fieldTerms.add(readableText,docFreq);
                i++;
              }
            }
 else {
              break;
            }
          }
 while (i < rows && termEnum.next());
        }
        termEnum.close();
      }
    }
 else {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"No terms.fl parameter specified");
    }
  }
}
