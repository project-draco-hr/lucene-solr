{
  int maxIterations=100;
  String coreState=null;
  while (maxIterations-- > 0) {
    Slice slice=reader.getClusterState().getSlice("collection1","shard1");
    if (slice != null) {
      coreState=slice.getShards().get("node1_core1").get(ZkStateReader.STATE_PROP);
      if (coreState.equals(expectedState)) {
        return;
      }
    }
    Thread.sleep(50);
  }
  fail("Illegal state, was:" + coreState + " expected:"+ expectedState+ "clusterState:"+ reader.getClusterState());
}
