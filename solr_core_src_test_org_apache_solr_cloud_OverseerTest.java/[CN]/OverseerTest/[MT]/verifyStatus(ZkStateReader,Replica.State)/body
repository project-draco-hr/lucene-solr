{
  int maxIterations=100;
  Replica.State coreState=null;
  while (maxIterations-- > 0) {
    Slice slice=reader.getClusterState().getSlice("collection1","shard1");
    if (slice != null) {
      coreState=slice.getReplicasMap().get("core_node1").getState();
      if (coreState == expectedState) {
        return;
      }
    }
    Thread.sleep(50);
  }
  fail("Illegal state, was:" + coreState + " expected:"+ expectedState+ "clusterState:"+ reader.getClusterState());
}
