{
  String zkDir=dataDir.getAbsolutePath() + File.separator + "zookeeper/server1/data";
  ZkTestServer server=new ZkTestServer(zkDir);
  MockZKController zkController=null;
  SolrZkClient zkClient=null;
  SolrZkClient overseerClient=null;
  try {
    server.run();
    AbstractZkTestCase.tryCleanSolrZkNode(server.getZkHost());
    AbstractZkTestCase.makeSolrZkNode(server.getZkHost());
    zkClient=new SolrZkClient(server.getZkAddress(),TIMEOUT);
    zkClient.makePath(ZkStateReader.LIVE_NODES_ZKNODE,true);
    overseerClient=electNewOverseer(server.getZkAddress());
    ZkStateReader reader=new ZkStateReader(zkClient);
    reader.createClusterStateWatchersAndUpdate();
    zkController=new MockZKController(server.getZkAddress(),"127.0.0.1","collection1");
    final int numShards=6;
    for (int i=0; i < numShards; i++) {
      assertNotNull("shard got no id?",zkController.publishState("core" + (i + 1),ZkStateReader.ACTIVE,3));
    }
    assertEquals(2,reader.getClusterState().getSlice("collection1","shard1").getReplicasMap().size());
    assertEquals(2,reader.getClusterState().getSlice("collection1","shard2").getReplicasMap().size());
    assertEquals(2,reader.getClusterState().getSlice("collection1","shard3").getReplicasMap().size());
    assertNotNull(reader.getLeaderUrl("collection1","shard1",15000));
    assertNotNull(reader.getLeaderUrl("collection1","shard2",15000));
    assertNotNull(reader.getLeaderUrl("collection1","shard3",15000));
  }
  finally {
    if (DEBUG) {
      if (zkController != null) {
        zkClient.printLayoutToStdOut();
      }
    }
    close(zkClient);
    if (zkController != null) {
      zkController.close();
    }
    close(overseerClient);
    server.shutdown();
  }
}
