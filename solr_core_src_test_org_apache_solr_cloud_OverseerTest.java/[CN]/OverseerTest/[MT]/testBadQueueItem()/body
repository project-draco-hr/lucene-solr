{
  String zkDir=createTempDir("zkData").getAbsolutePath();
  ZkTestServer server=new ZkTestServer(zkDir);
  MockZKController zkController=null;
  SolrZkClient zkClient=null;
  SolrZkClient overseerClient=null;
  try {
    server.run();
    AbstractZkTestCase.tryCleanSolrZkNode(server.getZkHost());
    AbstractZkTestCase.makeSolrZkNode(server.getZkHost());
    zkClient=new SolrZkClient(server.getZkAddress(),TIMEOUT);
    zkClient.makePath(ZkStateReader.LIVE_NODES_ZKNODE,true);
    overseerClient=electNewOverseer(server.getZkAddress());
    ZkStateReader reader=new ZkStateReader(zkClient);
    reader.createClusterStateWatchersAndUpdate();
    zkController=new MockZKController(server.getZkAddress(),"127.0.0.1");
    final int numShards=3;
    for (int i=0; i < numShards; i++) {
      assertNotNull("shard got no id?",zkController.publishState(collection,"core" + (i + 1),"node" + (i + 1),ZkStateReader.ACTIVE,3));
    }
    assertEquals(1,reader.getClusterState().getSlice(collection,"shard1").getReplicasMap().size());
    assertEquals(1,reader.getClusterState().getSlice(collection,"shard2").getReplicasMap().size());
    assertEquals(1,reader.getClusterState().getSlice(collection,"shard3").getReplicasMap().size());
    assertNotNull(reader.getLeaderUrl(collection,"shard1",15000));
    assertNotNull(reader.getLeaderUrl(collection,"shard2",15000));
    assertNotNull(reader.getLeaderUrl(collection,"shard3",15000));
    String emptyCollectionName="";
    zkController.publishState(emptyCollectionName,"core0","node0",ZkStateReader.ACTIVE,1);
    zkController.publishState(emptyCollectionName,"core0","node0",null,1);
    for (int i=0; i < numShards; i++) {
      assertNotNull("shard got no id?",zkController.publishState("collection2","core" + (i + 1),"node" + (i + 1),ZkStateReader.ACTIVE,3));
    }
    assertEquals(1,reader.getClusterState().getSlice("collection2","shard1").getReplicasMap().size());
    assertEquals(1,reader.getClusterState().getSlice("collection2","shard2").getReplicasMap().size());
    assertEquals(1,reader.getClusterState().getSlice("collection2","shard3").getReplicasMap().size());
    assertNotNull(reader.getLeaderUrl("collection2","shard1",15000));
    assertNotNull(reader.getLeaderUrl("collection2","shard2",15000));
    assertNotNull(reader.getLeaderUrl("collection2","shard3",15000));
  }
  finally {
    if (DEBUG) {
      if (zkController != null) {
        zkClient.printLayoutToStdOut();
      }
    }
    close(zkClient);
    if (zkController != null) {
      zkController.close();
    }
    close(overseerClient);
    server.shutdown();
  }
}
