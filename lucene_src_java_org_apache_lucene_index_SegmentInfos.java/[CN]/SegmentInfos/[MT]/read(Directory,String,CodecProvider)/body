{
  boolean success=false;
  clear();
  ChecksumIndexInput input=new ChecksumIndexInput(directory.openInput(segmentFileName));
  generation=generationFromSegmentsFileName(segmentFileName);
  lastGeneration=generation;
  try {
    int format=input.readInt();
    if (format < CURRENT_FORMAT)     throw new CorruptIndexException("Unknown (newer than us?) format version: " + format);
    version=input.readLong();
    counter=input.readInt();
    for (int i=input.readInt(); i > 0; i--) {
      add(new SegmentInfo(directory,format,input,codecs));
    }
    userData=input.readStringStringMap();
    final long checksumNow=input.getChecksum();
    final long checksumThen=input.readLong();
    if (checksumNow != checksumThen)     throw new CorruptIndexException("checksum mismatch in segments file");
    success=true;
  }
  finally {
    input.close();
    if (!success) {
      clear();
    }
  }
}
