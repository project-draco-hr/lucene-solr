{
  if (idx > 0) {
    writeArraySeparator();
  }
  indent();
  writeMapOpener(doc.size());
  incLevel();
  boolean first=true;
  for (  String fname : doc.getFieldNames()) {
    if (returnFields != null && !returnFields.wantsField(fname)) {
      continue;
    }
    if (first) {
      first=false;
    }
 else {
      writeMapSeparator();
    }
    indent();
    writeKey(fname,true);
    Object val=doc.getFieldValue(fname);
    if (val instanceof List) {
      writeArray(name,((Iterable)val).iterator());
    }
 else {
      writeVal(fname,val);
    }
  }
  if (doc.hasChildDocuments()) {
    if (first == false) {
      writeMapSeparator();
      indent();
    }
    writeKey("_childDocuments_",true);
    writeArrayOpener(doc.getChildDocumentCount());
    List<SolrDocument> childDocs=doc.getChildDocuments();
    for (int i=0; i < childDocs.size(); i++) {
      writeSolrDocument(null,childDocs.get(i),null,i);
    }
    writeArrayCloser();
  }
  decLevel();
  writeMapCloser();
}
