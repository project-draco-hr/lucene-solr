{
  if (idx > 0) {
    writeArraySeparator();
  }
  indent();
  writeMapOpener(doc.size());
  incLevel();
  boolean first=true;
  for (  String fname : doc.getFieldNames()) {
    if (!returnFields.wantsField(fname)) {
      continue;
    }
    if (first) {
      first=false;
    }
 else {
      writeMapSeparator();
    }
    indent();
    writeKey(fname,true);
    Object val=doc.getFieldValue(fname);
    if (val instanceof List) {
      writeArray(name,((Iterable)val).iterator());
    }
 else {
      writeVal(fname,val);
    }
  }
  decLevel();
  writeMapCloser();
}
