{
  final SolrParams params=req.getParams();
  final String wrapperFunction=params.get(JSONWriter.JSON_WRAPPER_FUNCTION);
  final String namedListStyle=params.get(JSONWriter.JSON_NL_STYLE,JSONWriter.JSON_NL_FLAT).intern();
  final JSONWriter w;
  if (namedListStyle.equals(JSONWriter.JSON_NL_ARROFNVP)) {
    w=new ArrayOfNamedValuePairJSONWriter(writer,req,rsp,wrapperFunction,namedListStyle);
  }
 else {
    w=new JSONWriter(writer,req,rsp,wrapperFunction,namedListStyle);
  }
  try {
    w.writeResponse();
  }
  finally {
    w.close();
  }
}
