{
  if (merged)   throw new IllegalStateException("Merge already performed");
  if (entries.isEmpty())   throw new IllegalStateException("No entries to merge have been defined");
  merged=true;
  IndexOutput os=null;
  try {
    os=directory.createOutput(fileName);
    os.writeVInt(entries.size());
    Iterator it=entries.iterator();
    while (it.hasNext()) {
      FileEntry fe=(FileEntry)it.next();
      fe.directoryOffset=os.getFilePointer();
      os.writeLong(0);
      os.writeString(fe.file);
    }
    byte buffer[]=new byte[1024];
    it=entries.iterator();
    while (it.hasNext()) {
      FileEntry fe=(FileEntry)it.next();
      fe.dataOffset=os.getFilePointer();
      copyFile(fe,os,buffer);
    }
    it=entries.iterator();
    while (it.hasNext()) {
      FileEntry fe=(FileEntry)it.next();
      os.seek(fe.directoryOffset);
      os.writeLong(fe.dataOffset);
    }
    IndexOutput tmp=os;
    os=null;
    tmp.close();
  }
  finally {
    if (os != null)     try {
      os.close();
    }
 catch (    IOException e) {
    }
  }
}
