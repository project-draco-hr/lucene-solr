{
  for (int mode=0; mode <= 1; mode++) {
    Directory dir1=newDirectory();
    createIndex(random,dir1,false);
    Directory dir2=newDirectory();
    createIndex(random,dir2,true);
    IndexReader reader1=IndexReader.open(dir1,false);
    assertRefCountEquals(1,reader1);
    ParallelReader parallelReader1=new ParallelReader(mode == 0);
    parallelReader1.add(reader1);
    IndexReader initReader2=IndexReader.open(dir2,false);
    parallelReader1.add(initReader2);
    modifyIndex(1,dir2);
    assertRefCountEquals(1 + mode,reader1);
    IndexReader parallelReader2=IndexReader.openIfChanged(parallelReader1);
    assertNotNull(parallelReader2);
    assertNull(IndexReader.openIfChanged(parallelReader2));
    assertRefCountEquals(2 + mode,reader1);
    modifyIndex(0,dir1);
    modifyIndex(0,dir2);
    IndexReader reader2=IndexReader.openIfChanged(reader1);
    assertNotNull(reader2);
    assertRefCountEquals(2 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    modifyIndex(4,dir1);
    IndexReader reader3=IndexReader.openIfChanged(reader2);
    assertNotNull(reader3);
    assertRefCountEquals(2 + mode,reader1);
    assertRefCountEquals(1,reader2);
    parallelReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    parallelReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    reader1.close();
    assertRefCountEquals(1,reader1);
    parallelReader2.close();
    assertRefCountEquals(0,reader1);
    parallelReader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,true);
    dir1.close();
    dir2.close();
  }
}
