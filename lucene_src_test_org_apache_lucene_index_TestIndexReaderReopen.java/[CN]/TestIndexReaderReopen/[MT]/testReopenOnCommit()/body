{
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(new KeepAllCommits()).setMaxBufferedDocs(-1).setMergePolicy(newLogMergePolicy(10)));
  for (int i=0; i < 4; i++) {
    Document doc=new Document();
    doc.add(newField("id","" + i,StringField.TYPE_UNSTORED));
    writer.addDocument(doc);
    Map<String,String> data=new HashMap<String,String>();
    data.put("index",i + "");
    writer.commit(data);
  }
  for (int i=0; i < 4; i++) {
    writer.deleteDocuments(new Term("id","" + i));
    Map<String,String> data=new HashMap<String,String>();
    data.put("index",(4 + i) + "");
    writer.commit(data);
  }
  writer.close();
  IndexReader r=IndexReader.open(dir);
  assertEquals(0,r.numDocs());
  Collection<IndexCommit> commits=DirectoryReader.listCommits(dir);
  for (  final IndexCommit commit : commits) {
    IndexReader r2=IndexReader.openIfChanged(r,commit);
    assertNotNull(r2);
    assertTrue(r2 != r);
    final Map<String,String> s=commit.getUserData();
    final int v;
    if (s.size() == 0) {
      v=-1;
    }
 else {
      v=Integer.parseInt(s.get("index"));
    }
    if (v < 4) {
      assertEquals(1 + v,r2.numDocs());
    }
 else {
      assertEquals(7 - v,r2.numDocs());
    }
    r.close();
    r=r2;
  }
  r.close();
  dir.close();
}
