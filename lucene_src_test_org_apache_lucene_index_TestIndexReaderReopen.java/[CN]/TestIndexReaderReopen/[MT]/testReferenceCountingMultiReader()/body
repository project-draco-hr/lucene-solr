{
  for (int mode=0; mode <= 1; mode++) {
    Directory dir1=newDirectory();
    createIndex(random,dir1,false);
    Directory dir2=newDirectory();
    createIndex(random,dir2,true);
    IndexReader reader1=IndexReader.open(dir1);
    assertRefCountEquals(1,reader1);
    IndexReader initReader2=IndexReader.open(dir2);
    IndexReader multiReader1=new MultiReader(new IndexReader[]{reader1,initReader2},(mode == 0));
    modifyIndex(0,dir2);
    assertRefCountEquals(1 + mode,reader1);
    IndexReader multiReader2=IndexReader.openIfChanged(multiReader1);
    assertNotNull(multiReader2);
    assertRefCountEquals(2 + mode,reader1);
    modifyIndex(0,dir1);
    IndexReader reader2=IndexReader.openIfChanged(reader1);
    assertNotNull(reader2);
    assertNull(IndexReader.openIfChanged(reader2));
    assertRefCountEquals(2 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    modifyIndex(1,dir1);
    IndexReader reader3=IndexReader.openIfChanged(reader2);
    assertNotNull(reader3);
    assertRefCountEquals(2 + mode,reader1);
    assertRefCountEquals(1,reader2);
    multiReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    multiReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    reader1.close();
    assertRefCountEquals(1,reader1);
    multiReader2.close();
    assertRefCountEquals(0,reader1);
    multiReader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,true);
    dir1.close();
    dir2.close();
  }
}
