{
synchronized (createReaderMutex) {
    IndexReader r=null;
    if (test != null) {
      test.modifyIndex(modify);
      r=test.openReader();
    }
    IndexReader refreshed=null;
    try {
      refreshed=IndexReader.openIfChanged(reader);
      if (refreshed == null) {
        refreshed=reader;
      }
    }
  finally {
      if (refreshed == null && r != null) {
        r.close();
      }
    }
    if (hasChanges) {
      if (refreshed == reader) {
        fail("No new IndexReader instance created during refresh.");
      }
    }
 else {
      if (refreshed != reader) {
        fail("New IndexReader instance created during refresh even though index had no changes.");
      }
    }
    return new ReaderCouple(r,refreshed);
  }
}
