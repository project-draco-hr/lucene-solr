{
  IndexWriter iwriter=new IndexWriter(dir,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE).setMergeScheduler(new SerialMergeScheduler()));
  iwriter.commit();
  IndexReader reader=IndexReader.open(dir,false);
  try {
    int M=3;
    for (int i=0; i < 4; i++) {
      for (int j=0; j < M; j++) {
        Document doc=new Document();
        doc.add(new Field("id",i + "_" + j,Store.YES,Index.NOT_ANALYZED));
        doc.add(new Field("id2",i + "_" + j,Store.YES,Index.NOT_ANALYZED_NO_NORMS));
        doc.add(new Field("id3",i + "_" + j,Store.YES,Index.NO));
        iwriter.addDocument(doc);
        if (i > 0) {
          int k=i - 1;
          int n=j + k * M;
          Document prevItereationDoc=reader.document(n);
          assertNotNull(prevItereationDoc);
          String id=prevItereationDoc.get("id");
          assertEquals(k + "_" + j,id);
        }
      }
      iwriter.commit();
      if (withReopen) {
        IndexReader r2=reader.reopen();
        if (reader != r2) {
          reader.close();
          reader=r2;
        }
      }
 else {
        reader.close();
        reader=IndexReader.open(dir,false);
      }
    }
  }
  finally {
    iwriter.close();
    reader.close();
  }
}
