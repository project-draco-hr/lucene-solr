{
  Directory dir=new RAMDirectory();
  IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),true);
  for (int i=0; i < 35; i++) {
    addDoc(writer,i);
  }
  writer.close();
  IndexReader reader=IndexReader.open(dir);
  Term searchTerm=new Term("id","7");
  int delCount=reader.deleteDocuments(searchTerm);
  assertEquals("didn't delete the right number of documents",1,delCount);
  reader.setNorm(21,"content",(float)1.5);
  reader.close();
  String[] files=dir.list();
  copyFile(dir,"_2_1.s0","_2_2.s0");
  copyFile(dir,"_2_1.s0","_2_2.f0");
  copyFile(dir,"_2_1.s0","_1_1.s0");
  copyFile(dir,"_2_1.s0","_1_1.f0");
  copyFile(dir,"_0_1.del","_0_2.del");
  copyFile(dir,"_0_1.del","_1_1.del");
  copyFile(dir,"_0_1.del","_188_1.del");
  copyFile(dir,"_0.cfs","_188.cfs");
  copyFile(dir,"_0.cfs","_0.fnm");
  copyFile(dir,"_0.cfs","deletable");
  copyFile(dir,"segments_a","segments");
  copyFile(dir,"segments_a","segments_2");
  String[] filesPre=dir.list();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(),false);
  writer.close();
  String[] files2=dir.list();
  Arrays.sort(files);
  Arrays.sort(files2);
  if (!Arrays.equals(files,files2)) {
    fail("IndexFileDeleter failed to delete unreferenced extra files: should have deleted " + (filesPre.length - files.length) + " files but only deleted "+ (filesPre.length - files2.length)+ "; expected files:\n    "+ asString(files)+ "\n  actual files:\n    "+ asString(files2));
  }
}
