{
  IndexOutput out=createOutput(dir,segmentFileName,new IOContext(new FlushInfo(infos.size(),infos.totalDocCount())));
  boolean success=false;
  try {
    out.writeInt(FORMAT_CURRENT);
    out.writeString(codecID);
    out.writeLong(infos.version);
    out.writeInt(infos.counter);
    out.writeInt(infos.size());
    for (    SegmentInfo si : infos) {
      writeInfo(out,si);
    }
    out.writeStringStringMap(infos.getUserData());
    success=true;
    return out;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(out);
    }
  }
}
