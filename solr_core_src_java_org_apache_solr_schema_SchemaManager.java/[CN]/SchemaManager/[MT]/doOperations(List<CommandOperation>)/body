{
  int timeout=req.getParams().getInt(BaseSolrResource.UPDATE_TIMEOUT_SECS,600);
  if (timeout < 1) {
    timeout=600;
  }
  TimeOut timeOut=new TimeOut(timeout,TimeUnit.SECONDS);
  SolrCore core=req.getCore();
  String errorMsg="Unable to persist managed schema. ";
  while (!timeOut.hasTimedOut()) {
    managedIndexSchema=getFreshManagedSchema();
    for (    CommandOperation op : operations) {
      OpType opType=OpType.get(op.name);
      if (opType != null) {
        opType.perform(op,this);
      }
 else {
        op.addError("No such operation : " + op.name);
      }
    }
    List errs=CommandOperation.captureErrors(operations);
    if (!errs.isEmpty())     return errs;
    SolrResourceLoader loader=req.getCore().getResourceLoader();
    if (loader instanceof ZkSolrResourceLoader) {
      ZkSolrResourceLoader zkLoader=(ZkSolrResourceLoader)loader;
      StringWriter sw=new StringWriter();
      try {
        managedIndexSchema.persist(sw);
      }
 catch (      IOException e) {
        throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"unable to serialize schema");
      }
      try {
        ZkController.persistConfigResourceToZooKeeper(zkLoader,managedIndexSchema.getSchemaZkVersion(),managedIndexSchema.getResourceName(),sw.toString().getBytes(StandardCharsets.UTF_8),true);
        waitForOtherReplicasToUpdate(timeOut);
        core.setLatestSchema(managedIndexSchema);
        return Collections.emptyList();
      }
 catch (      ZkController.ResourceModifiedInZkException e) {
        log.info("Schema was modified by another node. Retrying..");
      }
    }
 else {
      try {
        managedIndexSchema.persistManagedSchema(false);
        core.setLatestSchema(managedIndexSchema);
        return Collections.emptyList();
      }
 catch (      SolrException e) {
        log.warn(errorMsg);
        return singletonList(errorMsg + e.getMessage());
      }
    }
  }
  log.warn(errorMsg + "Timed out.");
  return singletonList(errorMsg + "Timed out.");
}
