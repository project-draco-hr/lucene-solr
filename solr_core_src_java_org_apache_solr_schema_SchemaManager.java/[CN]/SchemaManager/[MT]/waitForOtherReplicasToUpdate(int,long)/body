{
  if (timeout > 0 && managedIndexSchema.getResourceLoader() instanceof ZkSolrResourceLoader) {
    CoreDescriptor cd=req.getCore().getCoreDescriptor();
    String collection=cd.getCollectionName();
    if (collection != null) {
      ZkSolrResourceLoader zkLoader=(ZkSolrResourceLoader)managedIndexSchema.getResourceLoader();
      long timeLeftSecs1=timeout - ((System.nanoTime() - startTime) / 1000000);
      int secsLeft=(int)(timeLeftSecs1 > 0 ? timeLeftSecs1 : -1);
      if (secsLeft <= 0)       throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Not enough time left to update replicas. However the schema is updated already");
      long timeLeftSecs=timeout - ((System.nanoTime() - startTime) / 1000000);
      ManagedIndexSchema.waitForSchemaZkVersionAgreement(collection,cd.getCloudDescriptor().getCoreNodeName(),(managedIndexSchema).getSchemaZkVersion(),zkLoader.getZkController(),(int)(timeLeftSecs > 0 ? timeLeftSecs : -1));
    }
  }
}
