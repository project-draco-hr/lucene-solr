{
  if (timeout > 0 && managedIndexSchema.getResourceLoader() instanceof ZkSolrResourceLoader) {
    CoreDescriptor cd=req.getCore().getCoreDescriptor();
    String collection=cd.getCollectionName();
    if (collection != null) {
      ZkSolrResourceLoader zkLoader=(ZkSolrResourceLoader)managedIndexSchema.getResourceLoader();
      long timeLeftSecs=timeout - TimeUnit.SECONDS.convert(System.nanoTime() - startTime,TimeUnit.NANOSECONDS);
      if (timeLeftSecs <= 0)       throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Not enough time left to update replicas. However the schema is updated already");
      ManagedIndexSchema.waitForSchemaZkVersionAgreement(collection,cd.getCloudDescriptor().getCoreNodeName(),(managedIndexSchema).getSchemaZkVersion(),zkLoader.getZkController(),(int)timeLeftSecs);
    }
  }
}
