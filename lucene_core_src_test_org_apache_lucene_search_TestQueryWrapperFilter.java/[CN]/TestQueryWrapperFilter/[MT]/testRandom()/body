{
  final Directory d=newDirectory();
  final RandomIndexWriter w=new RandomIndexWriter(random(),d);
  w.w.getConfig().setMaxBufferedDocs(17);
  final int numDocs=atLeast(100);
  final Set<String> aDocs=new HashSet<>();
  for (int i=0; i < numDocs; i++) {
    final Document doc=new Document();
    final String v;
    if (random().nextInt(5) == 4) {
      v="a";
      aDocs.add("" + i);
    }
 else {
      v="b";
    }
    final Field f=newStringField("field",v,Field.Store.NO);
    doc.add(f);
    doc.add(newStringField("id","" + i,Field.Store.YES));
    w.addDocument(doc);
  }
  final int numDelDocs=atLeast(10);
  for (int i=0; i < numDelDocs; i++) {
    final String delID="" + random().nextInt(numDocs);
    w.deleteDocuments(new Term("id",delID));
    aDocs.remove(delID);
  }
  final IndexReader r=w.getReader();
  w.close();
  final TopDocs hits=newSearcher(r).search(new FilteredQuery(new MatchAllDocsQuery(),new QueryWrapperFilter(new TermQuery(new Term("field","a")))),numDocs);
  assertEquals(aDocs.size(),hits.totalHits);
  for (  ScoreDoc sd : hits.scoreDocs) {
    assertTrue(aDocs.contains(r.document(sd.doc).get("id")));
  }
  r.close();
  d.close();
}
