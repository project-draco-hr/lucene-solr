{
  final Directory d=newDirectory();
  final RandomIndexWriter w=new RandomIndexWriter(random,d);
  w.w.getConfig().setMaxBufferedDocs(17);
  final int numDocs=atLeast(100);
  final Set<String> aDocs=new HashSet<String>();
  for (int i=0; i < numDocs; i++) {
    final Document doc=new Document();
    final String v;
    if (random.nextInt(5) == 4) {
      v="a";
      aDocs.add("" + i);
    }
 else {
      v="b";
    }
    final Field f=newField("field",v,StringField.TYPE_UNSTORED);
    doc.add(f);
    doc.add(newField("id","" + i,StringField.TYPE_STORED));
    w.addDocument(doc);
  }
  final int numDelDocs=atLeast(10);
  for (int i=0; i < numDelDocs; i++) {
    final String delID="" + random.nextInt(numDocs);
    w.deleteDocuments(new Term("id",delID));
    aDocs.remove(delID);
  }
  final IndexReader r=w.getReader();
  w.close();
  final TopDocs hits=new IndexSearcher(r).search(new MatchAllDocsQuery(),new QueryWrapperFilter(new TermQuery(new Term("field","a"))),numDocs);
  assertEquals(aDocs.size(),hits.totalHits);
  for (  ScoreDoc sd : hits.scoreDocs) {
    assertTrue(aDocs.contains(r.document(sd.doc).get("id")));
  }
  r.close();
  d.close();
}
