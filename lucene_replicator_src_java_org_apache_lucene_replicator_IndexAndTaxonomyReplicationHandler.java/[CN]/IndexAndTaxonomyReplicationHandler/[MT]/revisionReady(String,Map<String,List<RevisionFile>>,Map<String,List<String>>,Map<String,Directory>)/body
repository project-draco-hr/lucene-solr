{
  Directory taxoClientDir=sourceDirectory.get(IndexAndTaxonomyRevision.TAXONOMY_SOURCE);
  Directory indexClientDir=sourceDirectory.get(IndexAndTaxonomyRevision.INDEX_SOURCE);
  List<String> taxoFiles=copiedFiles.get(IndexAndTaxonomyRevision.TAXONOMY_SOURCE);
  List<String> indexFiles=copiedFiles.get(IndexAndTaxonomyRevision.INDEX_SOURCE);
  String taxoSegmentsFile=IndexReplicationHandler.getSegmentsFile(taxoFiles,true);
  String indexSegmentsFile=IndexReplicationHandler.getSegmentsFile(indexFiles,false);
  String taxoPendingFile=taxoSegmentsFile == null ? null : "pending_" + taxoSegmentsFile;
  String indexPendingFile="pending_" + indexSegmentsFile;
  boolean success=false;
  try {
    IndexReplicationHandler.copyFiles(taxoClientDir,taxoDir,taxoFiles);
    IndexReplicationHandler.copyFiles(indexClientDir,indexDir,indexFiles);
    if (!taxoFiles.isEmpty()) {
      taxoDir.sync(taxoFiles);
    }
    indexDir.sync(indexFiles);
    if (taxoSegmentsFile != null) {
      taxoDir.copyFrom(taxoClientDir,taxoSegmentsFile,taxoPendingFile,IOContext.READONCE);
    }
    indexDir.copyFrom(indexClientDir,indexSegmentsFile,indexPendingFile,IOContext.READONCE);
    if (taxoSegmentsFile != null) {
      taxoDir.sync(Collections.singletonList(taxoPendingFile));
    }
    indexDir.sync(Collections.singletonList(indexPendingFile));
    if (taxoSegmentsFile != null) {
      taxoDir.renameFile(taxoPendingFile,taxoSegmentsFile);
    }
    indexDir.renameFile(indexPendingFile,indexSegmentsFile);
    success=true;
  }
  finally {
    if (!success) {
      if (taxoSegmentsFile != null) {
        taxoFiles.add(taxoSegmentsFile);
        taxoFiles.add(taxoPendingFile);
      }
      IndexReplicationHandler.cleanupFilesOnFailure(taxoDir,taxoFiles);
      indexFiles.add(indexSegmentsFile);
      indexFiles.add(indexPendingFile);
      IndexReplicationHandler.cleanupFilesOnFailure(indexDir,indexFiles);
    }
  }
  currentRevisionFiles=revisionFiles;
  currentVersion=version;
  if (infoStream.isEnabled(INFO_STREAM_COMPONENT)) {
    infoStream.message(INFO_STREAM_COMPONENT,"revisionReady(): currentVersion=" + currentVersion + " currentRevisionFiles="+ currentRevisionFiles);
  }
  IndexReplicationHandler.cleanupOldIndexFiles(indexDir,indexSegmentsFile,infoStream);
  IndexReplicationHandler.cleanupOldIndexFiles(taxoDir,taxoSegmentsFile,infoStream);
  if (callback != null) {
    try {
      callback.call();
    }
 catch (    Exception e) {
      throw new IOException(e);
    }
  }
}
