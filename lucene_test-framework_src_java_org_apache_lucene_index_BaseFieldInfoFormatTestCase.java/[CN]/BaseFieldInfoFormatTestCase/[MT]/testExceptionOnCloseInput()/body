{
  Failure fail=new Failure(){
    @Override public void eval(    MockDirectoryWrapper dir) throws IOException {
      for (      StackTraceElement e : Thread.currentThread().getStackTrace()) {
        if (doFail && "close".equals(e.getMethodName())) {
          throw new FakeIOException();
        }
      }
    }
  }
;
  MockDirectoryWrapper dir=newMockDirectory();
  dir.failOn(fail);
  Codec codec=getCodec();
  SegmentInfo segmentInfo=newSegmentInfo(dir,"_123");
  FieldInfos.Builder builder=new FieldInfos.Builder();
  FieldInfo fi=builder.getOrAdd("field");
  fi.setIndexOptions(TextField.TYPE_STORED.indexOptions());
  addAttributes(fi);
  FieldInfos infos=builder.finish();
  codec.fieldInfosFormat().write(dir,segmentInfo,"",infos,IOContext.DEFAULT);
  fail.setDoFail();
  try {
    codec.fieldInfosFormat().read(dir,segmentInfo,"",IOContext.DEFAULT);
    fail("didn't get expected exception");
  }
 catch (  FakeIOException expected) {
  }
 finally {
    fail.clearDoFail();
  }
  dir.close();
}
