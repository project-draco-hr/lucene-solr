{
  super(query);
  this.similarity=searcher.getSimilarity();
  this.query=query;
  this.collectorFactory=collectorFactory;
  termContexts=new HashMap<>();
  TreeSet<Term> terms=new TreeSet<>();
  query.extractTerms(terms);
  final IndexReaderContext context=searcher.getTopReaderContext();
  final TermStatistics termStats[]=new TermStatistics[terms.size()];
  int i=0;
  for (  Term term : terms) {
    TermContext state=TermContext.build(context,term);
    termStats[i]=searcher.termStatistics(term,state);
    termContexts.put(term,state);
    i++;
  }
  final String field=query.getField();
  if (field != null) {
    stats=similarity.computeWeight(query.getBoost(),searcher.collectionStatistics(query.getField()),termStats);
  }
}
