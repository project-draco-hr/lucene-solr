{
  ensureOpen();
  boolean maybeMerge=false;
  if (flushControl.anyStalledThreads() || flushControl.numQueuedFlushes() > 0) {
    if (infoStream != null) {
      message("DocumentsWriter has queued dwpt; will hijack this thread to flush pending segment(s)");
    }
    do {
      DocumentsWriterPerThread flushingDWPT;
      while ((flushingDWPT=flushControl.nextPendingFlush()) != null) {
        maybeMerge|=doFlush(flushingDWPT);
      }
      if (infoStream != null && flushControl.anyStalledThreads()) {
        message("WARNING DocumentsWriter has stalled threads; waiting");
      }
      flushControl.waitIfStalled();
    }
 while (flushControl.numQueuedFlushes() != 0);
    if (infoStream != null) {
      message("continue indexing after helpling out flushing DocumentsWriter is healthy");
    }
  }
  return maybeMerge;
}
