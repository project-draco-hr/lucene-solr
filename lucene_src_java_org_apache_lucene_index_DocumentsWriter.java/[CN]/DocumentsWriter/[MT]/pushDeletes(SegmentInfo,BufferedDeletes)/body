{
synchronized (indexWriter) {
    final long delGen=bufferedDeletesStream.getNextGen();
    if (segmentDeletes.any()) {
      if (indexWriter.segmentInfos.size() > 0 || segmentInfo != null) {
        final FrozenBufferedDeletes packet=new FrozenBufferedDeletes(segmentDeletes,delGen);
        if (infoStream != null) {
          message("flush: push buffered deletes");
        }
        bufferedDeletesStream.push(packet);
        if (infoStream != null) {
          message("flush: delGen=" + packet.gen);
        }
        if (segmentInfo != null) {
          segmentInfo.setBufferedDeletesGen(packet.gen);
        }
      }
 else {
        if (infoStream != null) {
          message("flush: drop buffered deletes: no segments");
        }
      }
    }
 else     if (segmentInfo != null) {
      segmentInfo.setBufferedDeletesGen(delGen);
    }
  }
}
