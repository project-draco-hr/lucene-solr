{
  perThread.pushDeletes(newSegment,indexWriter.segmentInfos);
  if (indexWriter.useCompoundFile(newSegment)) {
    String compoundFileName=IndexFileNames.segmentFileName(newSegment.name,"",IndexFileNames.COMPOUND_FILE_EXTENSION);
    message("creating compound file " + compoundFileName);
    boolean success=false;
    try {
      createCompoundFile(compoundFileName,perThread);
      success=true;
    }
  finally {
      if (!success) {
        if (infoStream != null) {
          message("hit exception " + "reating compound file for newly flushed segment " + newSegment.name);
        }
        indexWriter.deleter.deleteFile(IndexFileNames.segmentFileName(newSegment.name,"",IndexFileNames.COMPOUND_FILE_EXTENSION));
        for (        String file : perThread.flushState.flushedFiles) {
          indexWriter.deleter.deleteFile(file);
        }
      }
    }
    for (    String file : perThread.flushState.flushedFiles) {
      indexWriter.deleter.deleteFile(file);
    }
    newSegment.setUseCompoundFile(true);
  }
  indexWriter.addNewSegment(newSegment);
}
