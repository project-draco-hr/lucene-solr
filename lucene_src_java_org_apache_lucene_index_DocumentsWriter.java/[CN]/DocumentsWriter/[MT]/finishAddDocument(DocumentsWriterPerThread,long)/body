{
  int numDocsPerThread=perThread.getNumDocsInRAM();
  boolean flushed=maybeFlushPerThread(perThread);
  if (flushed) {
    int oldValue=numDocsInRAM.get();
    while (!numDocsInRAM.compareAndSet(oldValue,oldValue - numDocsPerThread)) {
      oldValue=numDocsInRAM.get();
    }
  }
  long deltaRAM=perThread.bytesUsed() - perThreadRAMUsedBeforeAdd;
  long oldValue=ramUsed.get();
  while (!ramUsed.compareAndSet(oldValue,oldValue + deltaRAM)) {
    oldValue=ramUsed.get();
  }
  return flushed;
}
