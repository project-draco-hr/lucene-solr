{
  FlushedSegment newSegment=null;
  final int maxBufferedDocs=config.getMaxBufferedDocs();
  if (maxBufferedDocs != IndexWriterConfig.DISABLE_AUTO_FLUSH && perThread.getNumDocsInRAM() >= maxBufferedDocs) {
    newSegment=perThread.flush();
  }
  long deltaRAM=perThread.bytesUsed() - perThreadRAMUsedBeforeAdd;
  long oldValue=ramUsed.get();
  while (!ramUsed.compareAndSet(oldValue,oldValue + deltaRAM)) {
    oldValue=ramUsed.get();
  }
  return newSegment;
}
