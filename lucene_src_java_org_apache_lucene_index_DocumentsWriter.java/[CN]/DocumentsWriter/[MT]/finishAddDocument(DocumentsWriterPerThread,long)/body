{
  SegmentInfo newSegment=null;
  int numDocsPerThread=perThread.getNumDocsInRAM();
  if (perThread.getNumDocsInRAM() == maxBufferedDocs) {
    newSegment=perThread.flush();
    int oldValue=numDocsInRAM.get();
    while (!numDocsInRAM.compareAndSet(oldValue,oldValue - numDocsPerThread)) {
      oldValue=numDocsInRAM.get();
    }
  }
  long deltaRAM=perThread.bytesUsed() - perThreadRAMUsedBeforeAdd;
  long oldValue=ramUsed.get();
  while (!ramUsed.compareAndSet(oldValue,oldValue + deltaRAM)) {
    oldValue=ramUsed.get();
  }
  return newSegment;
}
