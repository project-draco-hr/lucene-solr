{
  int numDocsPerThread=perThread.getNumDocsInRAM();
  boolean flushed=maybeFlushPerThread(perThread);
  if (flushed) {
    int oldValue=numDocsInRAM.get();
    while (!numDocsInRAM.compareAndSet(oldValue,oldValue - numDocsPerThread)) {
      oldValue=numDocsInRAM.get();
    }
    sequenceIDLock.lock();
    try {
      minSequenceIDsPerThread.remove(perThread);
      updateFlushedSequenceID();
    }
  finally {
      sequenceIDLock.unlock();
    }
  }
  long deltaRAM=perThread.numBytesUsed - perThreadRAMUsedBeforeAdd;
  long oldValue=ramUsed.get();
  while (!ramUsed.compareAndSet(oldValue,oldValue + deltaRAM)) {
    oldValue=ramUsed.get();
  }
  return flushed;
}
