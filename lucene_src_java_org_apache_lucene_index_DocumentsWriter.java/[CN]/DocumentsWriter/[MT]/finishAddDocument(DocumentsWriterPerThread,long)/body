{
  FlushedSegment newSegment=null;
  if (perThread.getNumDocsInRAM() == maxBufferedDocs) {
    newSegment=perThread.flush();
  }
  long deltaRAM=perThread.bytesUsed() - perThreadRAMUsedBeforeAdd;
  long oldValue=ramUsed.get();
  while (!ramUsed.compareAndSet(oldValue,oldValue + deltaRAM)) {
    oldValue=ramUsed.get();
  }
  return newSegment;
}
