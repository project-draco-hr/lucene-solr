{
  final IndexReader reader=searcher.getIndexReader();
  query=rewrite(query);
  SortedSet<Term> queryTerms=new TreeSet<Term>();
  query.extractTerms(queryTerms);
  IndexReaderContext readerContext=reader.getContext();
  List<AtomicReaderContext> leaves=readerContext.leaves();
  int[] docids=new int[docidsIn.length];
  System.arraycopy(docidsIn,0,docids,0,docidsIn.length);
  Arrays.sort(docids);
  Arrays.sort(fields);
  String[][] contents=loadFieldValues(searcher,fields,docids,maxLength);
  Map<String,String[]> highlights=new HashMap<String,String[]>();
  for (int i=0; i < fields.length; i++) {
    String field=fields[i];
    Term floor=new Term(field,"");
    Term ceiling=new Term(field,UnicodeUtil.BIG_TERM);
    SortedSet<Term> fieldTerms=queryTerms.subSet(floor,ceiling);
    BytesRef terms[]=new BytesRef[fieldTerms.size()];
    int termUpto=0;
    for (    Term term : fieldTerms) {
      terms[termUpto++]=term.bytes();
    }
    Map<Integer,String> fieldHighlights=highlightField(field,contents[i],getBreakIterator(field),terms,docids,leaves,maxPassages);
    String[] result=new String[docids.length];
    for (int j=0; j < docidsIn.length; j++) {
      result[j]=fieldHighlights.get(docidsIn[j]);
    }
    highlights.put(field,result);
  }
  return highlights;
}
