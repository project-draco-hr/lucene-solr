{
  Map<Integer,String> highlights=new HashMap<Integer,String>();
  DocsAndPositionsEnum postings[]=null;
  TermsEnum termsEnum=null;
  int lastLeaf=-1;
  for (int i=0; i < docids.length; i++) {
    String content=contents[i];
    if (content.length() == 0) {
      continue;
    }
    bi.setText(content);
    int doc=docids[i];
    int leaf=ReaderUtil.subIndex(doc,leaves);
    AtomicReaderContext subContext=leaves.get(leaf);
    AtomicReader r=subContext.reader();
    Terms t=r.terms(field);
    if (t == null) {
      continue;
    }
    if (leaf != lastLeaf) {
      termsEnum=t.iterator(null);
      postings=new DocsAndPositionsEnum[terms.length];
    }
    Passage passages[]=highlightDoc(field,terms,content.length(),bi,doc - subContext.docBase,termsEnum,postings,maxPassages);
    if (passages.length > 0) {
      highlights.put(doc,formatter.format(passages,content));
    }
    lastLeaf=leaf;
  }
  return highlights;
}
