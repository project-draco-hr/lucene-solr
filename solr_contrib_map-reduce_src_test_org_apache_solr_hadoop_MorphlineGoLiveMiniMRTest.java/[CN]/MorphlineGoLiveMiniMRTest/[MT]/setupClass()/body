{
  System.setProperty("solr.hdfs.blockcache.global",Boolean.toString(LuceneTestCase.random().nextBoolean()));
  System.setProperty("solr.hdfs.blockcache.enabled",Boolean.toString(LuceneTestCase.random().nextBoolean()));
  System.setProperty("solr.hdfs.blockcache.blocksperbank","2048");
  solrHomeDirectory=createTempDir().toFile();
  assumeFalse("HDFS tests were disabled by -Dtests.disableHdfs",Boolean.parseBoolean(System.getProperty("tests.disableHdfs","false")));
  assumeFalse("FIXME: This test does not work with Windows because of native library requirements",Constants.WINDOWS);
  AbstractZkTestCase.SOLRHOME=solrHomeDirectory;
  FileUtils.copyDirectory(MINIMR_INSTANCE_DIR,AbstractZkTestCase.SOLRHOME);
  tempDir=createTempDir().toFile().getAbsolutePath();
  new File(tempDir).mkdirs();
  FileUtils.copyFile(new File(RESOURCES_DIR + "/custom-mimetypes.xml"),new File(tempDir + "/custom-mimetypes.xml"));
  AbstractSolrMorphlineTestBase.setupMorphline(tempDir,"test-morphlines/solrCellDocumentTypes",true);
  System.setProperty("hadoop.log.dir",new File(tempDir,"logs").getAbsolutePath());
  int dataNodes=2;
  JobConf conf=new JobConf();
  conf.set("dfs.block.access.token.enable","false");
  conf.set("dfs.permissions","true");
  conf.set("hadoop.security.authentication","simple");
  conf.set("mapreduce.jobhistory.minicluster.fixed.ports","false");
  conf.set("mapreduce.jobhistory.admin.address","0.0.0.0:0");
  conf.set(YarnConfiguration.NM_LOCAL_DIRS,tempDir + File.separator + "nm-local-dirs");
  conf.set(YarnConfiguration.DEFAULT_NM_LOG_DIRS,tempDir + File.separator + "nm-logs");
  new File(tempDir + File.separator + "nm-local-dirs").mkdirs();
  System.setProperty("test.build.dir",tempDir + File.separator + "hdfs"+ File.separator+ "test-build-dir");
  System.setProperty("test.build.data",tempDir + File.separator + "hdfs"+ File.separator+ "build");
  System.setProperty("test.cache.data",tempDir + File.separator + "hdfs"+ File.separator+ "cache");
  SEARCH_ARCHIVES_JAR=JarFinder.getJar(MapReduceIndexerTool.class);
  dfsCluster=new MiniDFSCluster(conf,dataNodes,true,null);
  FileSystem fileSystem=dfsCluster.getFileSystem();
  fileSystem.mkdirs(new Path("/tmp"));
  fileSystem.mkdirs(new Path("/user"));
  fileSystem.mkdirs(new Path("/hadoop/mapred/system"));
  fileSystem.setPermission(new Path("/tmp"),FsPermission.valueOf("-rwxrwxrwx"));
  fileSystem.setPermission(new Path("/user"),FsPermission.valueOf("-rwxrwxrwx"));
  fileSystem.setPermission(new Path("/hadoop/mapred/system"),FsPermission.valueOf("-rwx------"));
  mrCluster=MiniMRClientClusterFactory.create(MorphlineGoLiveMiniMRTest.class,1,conf,new File(tempDir,"mrCluster"));
  ProxyUsers.refreshSuperUserGroupsConfiguration(conf);
}
