{
  File indexDir=_TestUtil.getTempDir("testSetBufferSize");
  MockFSDirectory dir=new MockFSDirectory(indexDir,random);
  try {
    IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setMergePolicy(newLogMergePolicy(false)));
    for (int i=0; i < 37; i++) {
      Document doc=new Document();
      doc.add(newField("content","aaa bbb ccc ddd" + i,Field.Store.YES,Field.Index.ANALYZED));
      doc.add(newField("id","" + i,Field.Store.YES,Field.Index.ANALYZED));
      writer.addDocument(doc);
    }
    writer.close();
    dir.allIndexInputs.clear();
    IndexReader reader=IndexReader.open(dir,false);
    Term aaa=new Term("content","aaa");
    Term bbb=new Term("content","bbb");
    Term ccc=new Term("content","ccc");
    assertEquals(37,reader.docFreq(ccc));
    reader.deleteDocument(0);
    assertEquals(37,reader.docFreq(aaa));
    dir.tweakBufferSizes();
    reader.deleteDocument(4);
    assertEquals(reader.docFreq(bbb),37);
    dir.tweakBufferSizes();
    IndexSearcher searcher=newSearcher(reader);
    ScoreDoc[] hits=searcher.search(new TermQuery(bbb),null,1000).scoreDocs;
    dir.tweakBufferSizes();
    assertEquals(35,hits.length);
    dir.tweakBufferSizes();
    hits=searcher.search(new TermQuery(new Term("id","33")),null,1000).scoreDocs;
    dir.tweakBufferSizes();
    assertEquals(1,hits.length);
    hits=searcher.search(new TermQuery(aaa),null,1000).scoreDocs;
    dir.tweakBufferSizes();
    assertEquals(35,hits.length);
    searcher.close();
    reader.close();
  }
  finally {
    _TestUtil.rmDir(indexDir);
  }
}
