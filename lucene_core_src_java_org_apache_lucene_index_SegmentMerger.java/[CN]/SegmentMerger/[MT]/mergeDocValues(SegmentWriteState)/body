{
  DocValuesConsumer consumer=codec.docValuesFormat().fieldsConsumer(segmentWriteState);
  boolean success=false;
  try {
    for (    FieldInfo field : mergeState.fieldInfos) {
      DocValuesType type=field.getDocValuesType();
      if (type != null) {
        if (type == DocValuesType.NUMERIC) {
          List<NumericDocValues> toMerge=new ArrayList<>();
          List<Bits> docsWithField=new ArrayList<>();
          for (          AtomicReader reader : mergeState.readers) {
            NumericDocValues values=reader.getNumericDocValues(field.name);
            Bits bits=reader.getDocsWithField(field.name);
            if (values == null) {
              values=DocValues.emptyNumeric();
              bits=new Bits.MatchNoBits(reader.maxDoc());
            }
            toMerge.add(values);
            docsWithField.add(bits);
          }
          consumer.mergeNumericField(field,mergeState,toMerge,docsWithField);
        }
 else         if (type == DocValuesType.BINARY) {
          List<BinaryDocValues> toMerge=new ArrayList<>();
          List<Bits> docsWithField=new ArrayList<>();
          for (          AtomicReader reader : mergeState.readers) {
            BinaryDocValues values=reader.getBinaryDocValues(field.name);
            Bits bits=reader.getDocsWithField(field.name);
            if (values == null) {
              values=DocValues.emptyBinary();
              bits=new Bits.MatchNoBits(reader.maxDoc());
            }
            toMerge.add(values);
            docsWithField.add(bits);
          }
          consumer.mergeBinaryField(field,mergeState,toMerge,docsWithField);
        }
 else         if (type == DocValuesType.SORTED) {
          List<SortedDocValues> toMerge=new ArrayList<>();
          for (          AtomicReader reader : mergeState.readers) {
            SortedDocValues values=reader.getSortedDocValues(field.name);
            if (values == null) {
              values=DocValues.emptySorted();
            }
            toMerge.add(values);
          }
          consumer.mergeSortedField(field,mergeState,toMerge);
        }
 else         if (type == DocValuesType.SORTED_SET) {
          List<SortedSetDocValues> toMerge=new ArrayList<>();
          for (          AtomicReader reader : mergeState.readers) {
            SortedSetDocValues values=reader.getSortedSetDocValues(field.name);
            if (values == null) {
              values=DocValues.emptySortedSet();
            }
            toMerge.add(values);
          }
          consumer.mergeSortedSetField(field,mergeState,toMerge);
        }
 else         if (type == DocValuesType.SORTED_NUMERIC) {
          List<SortedNumericDocValues> toMerge=new ArrayList<>();
          for (          AtomicReader reader : mergeState.readers) {
            SortedNumericDocValues values=reader.getSortedNumericDocValues(field.name);
            if (values == null) {
              values=DocValues.emptySortedNumeric();
            }
            toMerge.add(values);
          }
          consumer.mergeSortedNumericField(field,mergeState,toMerge);
        }
 else {
          throw new AssertionError("type=" + type);
        }
      }
    }
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(consumer);
    }
 else {
      IOUtils.closeWhileHandlingException(consumer);
    }
  }
}
