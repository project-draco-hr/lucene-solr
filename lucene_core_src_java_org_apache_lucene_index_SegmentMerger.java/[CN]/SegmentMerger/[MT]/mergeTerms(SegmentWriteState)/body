{
  final List<Fields> fields=new ArrayList<>();
  final List<ReaderSlice> slices=new ArrayList<>();
  int docBase=0;
  for (int readerIndex=0; readerIndex < mergeState.readers.size(); readerIndex++) {
    final AtomicReader reader=mergeState.readers.get(readerIndex);
    final Fields f=reader.fields();
    final int maxDoc=reader.maxDoc();
    if (f != null) {
      slices.add(new ReaderSlice(docBase,maxDoc,readerIndex));
      fields.add(f);
    }
    docBase+=maxDoc;
  }
  Fields mergedFields=new MappedMultiFields(mergeState,new MultiFields(fields.toArray(Fields.EMPTY_ARRAY),slices.toArray(ReaderSlice.EMPTY_ARRAY)));
  codec.postingsFormat().fieldsConsumer(segmentWriteState).write(mergedFields);
}
