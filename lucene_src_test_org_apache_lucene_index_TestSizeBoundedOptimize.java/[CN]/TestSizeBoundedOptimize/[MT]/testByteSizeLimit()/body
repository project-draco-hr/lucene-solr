{
  Directory dir=new RAMDirectory();
  IndexWriterConfig conf=new IndexWriterConfig(TEST_VERSION_CURRENT,null);
  conf.setMergePolicy(NoMergePolicy.COMPOUND_FILES);
  IndexWriter writer=new IndexWriter(dir,conf);
  final int numSegments=15;
  for (int i=0; i < numSegments; i++) {
    int numDocs=i == 7 ? 30 : 1;
    addDocs(writer,numDocs);
  }
  writer.close();
  SegmentInfos sis=new SegmentInfos();
  sis.read(dir);
  double min=sis.info(0).sizeInBytes();
  conf=new IndexWriterConfig(TEST_VERSION_CURRENT,null);
  LogByteSizeMergePolicy lmp=new LogByteSizeMergePolicy();
  lmp.setMaxMergeMB((min + 1) / (1 << 20));
  conf.setMergePolicy(lmp);
  writer=new IndexWriter(dir,conf);
  writer.optimize();
  writer.close();
  sis=new SegmentInfos();
  sis.read(dir);
  assertEquals(3,sis.size());
}
