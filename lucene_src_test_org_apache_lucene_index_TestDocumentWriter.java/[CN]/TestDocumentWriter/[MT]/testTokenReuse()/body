{
  Analyzer analyzer=new Analyzer(){
    @Override public TokenStreamComponents createComponents(    String fieldName,    Reader reader){
      Tokenizer tokenizer=new MockTokenizer(reader,MockTokenizer.WHITESPACE,false);
      return new TokenStreamComponents(tokenizer,new TokenFilter(tokenizer){
        boolean first=true;
        AttributeSource.State state;
        @Override public boolean incrementToken() throws IOException {
          if (state != null) {
            restoreState(state);
            payloadAtt.setPayload(null);
            posIncrAtt.setPositionIncrement(0);
            termAtt.setEmpty().append("b");
            state=null;
            return true;
          }
          boolean hasNext=input.incrementToken();
          if (!hasNext)           return false;
          if (Character.isDigit(termAtt.buffer()[0])) {
            posIncrAtt.setPositionIncrement(termAtt.buffer()[0] - '0');
          }
          if (first) {
            payloadAtt.setPayload(new Payload(new byte[]{100}));
            first=false;
          }
          state=captureState();
          return true;
        }
        @Override public void reset() throws IOException {
          super.reset();
          first=true;
          state=null;
        }
        final CharTermAttribute termAtt=addAttribute(CharTermAttribute.class);
        final PayloadAttribute payloadAtt=addAttribute(PayloadAttribute.class);
        final PositionIncrementAttribute posIncrAtt=addAttribute(PositionIncrementAttribute.class);
      }
);
    }
  }
;
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,analyzer));
  Document doc=new Document();
  doc.add(newField("f1","a 5 a a",TextField.TYPE_STORED));
  writer.addDocument(doc);
  writer.commit();
  SegmentInfo info=writer.newestSegment();
  writer.close();
  SegmentReader reader=SegmentReader.get(info,IndexReader.DEFAULT_TERMS_INDEX_DIVISOR,newIOContext(random));
  DocsAndPositionsEnum termPositions=MultiFields.getTermPositionsEnum(reader,reader.getLiveDocs(),"f1",new BytesRef("a"));
  assertTrue(termPositions.nextDoc() != termPositions.NO_MORE_DOCS);
  int freq=termPositions.freq();
  assertEquals(3,freq);
  assertEquals(0,termPositions.nextPosition());
  assertEquals(true,termPositions.hasPayload());
  assertEquals(6,termPositions.nextPosition());
  assertEquals(false,termPositions.hasPayload());
  assertEquals(7,termPositions.nextPosition());
  assertEquals(false,termPositions.hasPayload());
  reader.close();
}
