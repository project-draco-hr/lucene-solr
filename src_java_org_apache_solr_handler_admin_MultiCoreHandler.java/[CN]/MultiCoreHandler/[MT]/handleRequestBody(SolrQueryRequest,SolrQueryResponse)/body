{
  MultiCore manager=getMultiCore();
  if (!manager.isEnabled()) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"MultiCore support must be enabled at startup.");
  }
  boolean do_persist=false;
  SolrParams params=req.getParams();
  SolrParams required=params.required();
  MultiCoreAction action=MultiCoreAction.STATUS;
  String a=params.get(MultiCoreParams.ACTION);
  if (a != null) {
    action=MultiCoreAction.get(a);
    if (action == null) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Unknown 'action' value.  Use: " + MultiCoreAction.values());
    }
  }
  SolrCore core=null;
  if (action == MultiCoreAction.CREATE) {
    CoreDescriptor dcore=new CoreDescriptor(manager);
    dcore.init(params.get(MultiCoreParams.NAME),params.get(MultiCoreParams.INSTANCE_DIR));
    String opts=params.get(MultiCoreParams.CONFIG);
    if (opts != null)     dcore.setConfigName(opts);
    opts=params.get(MultiCoreParams.SCHEMA);
    if (opts != null)     dcore.setSchemaName(opts);
    core=manager.create(dcore);
    rsp.add("core",core.getName());
    do_persist=manager.isPersistent();
  }
 else {
    String cname=params.get(MultiCoreParams.CORE);
    if (cname != null) {
      core=manager.getCore(cname);
      if (core == null) {
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Unknown core: " + cname);
      }
    }
    if (action == MultiCoreAction.STATUS) {
      do_persist=false;
      NamedList<Object> status=new SimpleOrderedMap<Object>();
      if (core == null) {
        for (        CoreDescriptor d : manager.getDescriptors()) {
          status.add(d.getName(),getCoreStatus(d.getCore()));
        }
      }
 else {
        status.add(core.getName(),getCoreStatus(core));
      }
      rsp.add("status",status);
    }
 else     if (core == null) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Action '" + action + "' requires a core name.");
    }
 else {
      do_persist=params.getBool(MultiCoreParams.PERSISTENT,manager.isPersistent());
switch (action) {
case RELOAD:
{
          manager.reload(manager.getDescriptor(core.getName()));
          do_persist=false;
          break;
        }
case SWAP:
{
        String name=required.get(MultiCoreParams.WITH);
        CoreDescriptor swap=manager.getDescriptor(name);
        if (swap == null) {
          throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Unknown core: " + name);
        }
        manager.swap(manager.getDescriptor(core.getName()),swap);
        break;
      }
case PERSIST:
{
      do_persist=true;
      break;
    }
default :
{
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"TODO: IMPLEMENT: " + action);
  }
}
}
}
if (do_persist) {
manager.persist();
rsp.add("saved",manager.getConfigFile().getAbsolutePath());
}
}
