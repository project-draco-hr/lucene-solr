{
  final Directory d=newFSDirectory(createTempDir("CFSManySubFiles"));
  byte id[]=StringHelper.randomId();
  final int FILE_COUNT=atLeast(500);
  for (int fileIdx=0; fileIdx < FILE_COUNT; fileIdx++) {
    IndexOutput out=d.createOutput("file." + fileIdx,newIOContext(random()));
    out.writeByte((byte)fileIdx);
    out.close();
  }
  final CompoundFileDirectory cfd=new CompoundFileDirectory(id,d,"c.cfs",newIOContext(random()),true);
  for (int fileIdx=0; fileIdx < FILE_COUNT; fileIdx++) {
    final String fileName="file." + fileIdx;
    d.copy(cfd,fileName,fileName,newIOContext(random()));
  }
  cfd.close();
  final IndexInput[] ins=new IndexInput[FILE_COUNT];
  final CompoundFileDirectory cfr=new CompoundFileDirectory(id,d,"c.cfs",newIOContext(random()),false);
  for (int fileIdx=0; fileIdx < FILE_COUNT; fileIdx++) {
    ins[fileIdx]=cfr.openInput("file." + fileIdx,newIOContext(random()));
  }
  for (int fileIdx=0; fileIdx < FILE_COUNT; fileIdx++) {
    assertEquals((byte)fileIdx,ins[fileIdx].readByte());
  }
  for (int fileIdx=0; fileIdx < FILE_COUNT; fileIdx++) {
    ins[fileIdx].close();
  }
  cfr.close();
  d.close();
}
