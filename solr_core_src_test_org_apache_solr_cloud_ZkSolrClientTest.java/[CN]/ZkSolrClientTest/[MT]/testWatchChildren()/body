{
  String zkDir=dataDir.getAbsolutePath() + File.separator + "zookeeper/server1/data";
  final AtomicInteger cnt=new AtomicInteger();
  ZkTestServer server=new ZkTestServer(zkDir);
  server.run();
  Thread.sleep(400);
  AbstractZkTestCase.makeSolrZkNode(server.getZkHost());
  final SolrZkClient zkClient=new SolrZkClient(server.getZkAddress(),AbstractZkTestCase.TIMEOUT);
  try {
    zkClient.makePath("/collections");
    zkClient.getChildren("/collections",new Watcher(){
      public void process(      WatchedEvent event){
        if (DEBUG) {
          System.out.println("children changed");
        }
        cnt.incrementAndGet();
        try {
          zkClient.getChildren("/collections",this);
        }
 catch (        KeeperException e) {
          throw new RuntimeException(e);
        }
catch (        InterruptedException e) {
          throw new RuntimeException(e);
        }
      }
    }
);
    zkClient.makePath("/collections/collection99/shards");
    zkClient.makePath("collections/collection99/config=collection1");
    zkClient.makePath("collections/collection99/config=collection3");
    zkClient.makePath("/collections/collection97/shards");
    if (DEBUG) {
      zkClient.printLayoutToStdOut();
    }
    Thread.sleep(700);
    if (cnt.intValue() < 2) {
      Thread.sleep(4000);
    }
    assertEquals(2,cnt.intValue());
  }
  finally {
    if (zkClient != null) {
      zkClient.close();
    }
    if (server != null) {
      server.shutdown();
    }
  }
}
