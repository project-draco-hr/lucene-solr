{
  String zkDir=dataDir.getAbsolutePath() + File.separator + "zookeeper/server1/data";
  final AtomicInteger cnt=new AtomicInteger();
  ZkTestServer server=new ZkTestServer(zkDir);
  server.run();
  Thread.sleep(400);
  AbstractZkTestCase.makeSolrZkNode(server.getZkHost());
  final SolrZkClient zkClient=new SolrZkClient(server.getZkAddress(),AbstractZkTestCase.TIMEOUT);
  try {
    final CountDownLatch latch=new CountDownLatch(1);
    zkClient.makePath("/collections",true);
    zkClient.getChildren("/collections",new Watcher(){
      public void process(      WatchedEvent event){
        if (DEBUG) {
          System.out.println("children changed");
        }
        cnt.incrementAndGet();
        try {
          zkClient.getChildren("/collections",this,true);
          latch.countDown();
        }
 catch (        KeeperException e) {
          throw new RuntimeException(e);
        }
catch (        InterruptedException e) {
          throw new RuntimeException(e);
        }
      }
    }
,true);
    zkClient.makePath("/collections/collection99/shards",true);
    latch.await();
    zkClient.makePath("collections/collection99/config=collection1",true);
    zkClient.makePath("collections/collection99/config=collection3",true);
    zkClient.makePath("/collections/collection97/shards",true);
    if (DEBUG) {
      zkClient.printLayoutToStdOut();
    }
    Thread.sleep(700);
    if (cnt.intValue() < 2) {
      Thread.sleep(4000);
    }
    if (cnt.intValue() < 2) {
      Thread.sleep(4000);
    }
    assertEquals(2,cnt.intValue());
  }
  finally {
    if (zkClient != null) {
      zkClient.close();
    }
    if (server != null) {
      server.shutdown();
    }
  }
}
