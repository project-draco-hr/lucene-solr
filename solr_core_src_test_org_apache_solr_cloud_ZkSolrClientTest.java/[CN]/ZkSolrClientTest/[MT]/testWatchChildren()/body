{
  try (ZkConnection conn=new ZkConnection()){
    final SolrZkClient zkClient=conn.getClient();
    final AtomicInteger cnt=new AtomicInteger();
    final CountDownLatch latch=new CountDownLatch(1);
    zkClient.makePath("/collections",true);
    zkClient.getChildren("/collections",new Watcher(){
      @Override public void process(      WatchedEvent event){
        if (DEBUG) {
          System.out.println("children changed");
        }
        cnt.incrementAndGet();
        try {
          zkClient.getChildren("/collections",this,true);
          latch.countDown();
        }
 catch (        KeeperException|InterruptedException e) {
          throw new RuntimeException(e);
        }
      }
    }
,true);
    zkClient.makePath("/collections/collection99/shards",true);
    latch.await();
    zkClient.makePath("collections/collection99/config=collection1",true);
    zkClient.makePath("collections/collection99/config=collection3",true);
    zkClient.makePath("/collections/collection97/shards",true);
    if (DEBUG) {
      zkClient.printLayoutToStdOut();
    }
    Thread.sleep(700);
    if (cnt.intValue() < 2) {
      Thread.sleep(4000);
    }
    if (cnt.intValue() < 2) {
      Thread.sleep(4000);
    }
    assertEquals(2,cnt.intValue());
  }
 }
