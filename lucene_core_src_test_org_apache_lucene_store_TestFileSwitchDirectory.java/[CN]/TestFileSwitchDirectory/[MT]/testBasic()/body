{
  Set<String> fileExtensions=new HashSet<>();
  fileExtensions.add(Lucene40StoredFieldsWriter.FIELDS_EXTENSION);
  fileExtensions.add(Lucene40StoredFieldsWriter.FIELDS_INDEX_EXTENSION);
  MockDirectoryWrapper primaryDir=new MockDirectoryWrapper(random(),new RAMDirectory());
  primaryDir.setCheckIndexOnClose(false);
  MockDirectoryWrapper secondaryDir=new MockDirectoryWrapper(random(),new RAMDirectory());
  secondaryDir.setCheckIndexOnClose(false);
  FileSwitchDirectory fsd=new FileSwitchDirectory(fileExtensions,primaryDir,secondaryDir,true);
  boolean oldValue=OLD_FORMAT_IMPERSONATION_IS_ACTIVE;
  OLD_FORMAT_IMPERSONATION_IS_ACTIVE=true;
  IndexWriter writer=new IndexWriter(fsd,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setMergePolicy(newLogMergePolicy(false)).setCodec(Codec.forName("Lucene40")).setUseCompoundFile(false));
  TestIndexWriterReader.createIndexNoClose(true,"ram",writer);
  IndexReader reader=DirectoryReader.open(writer,true);
  assertEquals(100,reader.maxDoc());
  writer.commit();
  String[] files=primaryDir.listAll();
  assertTrue(files.length > 0);
  for (int x=0; x < files.length; x++) {
    String ext=FileSwitchDirectory.getExtension(files[x]);
    assertTrue(fileExtensions.contains(ext));
  }
  files=secondaryDir.listAll();
  assertTrue(files.length > 0);
  for (int x=0; x < files.length; x++) {
    String ext=FileSwitchDirectory.getExtension(files[x]);
    assertFalse(fileExtensions.contains(ext));
  }
  reader.close();
  writer.shutdown();
  files=fsd.listAll();
  for (int i=0; i < files.length; i++) {
    assertNotNull(files[i]);
  }
  fsd.close();
  OLD_FORMAT_IMPERSONATION_IS_ACTIVE=oldValue;
}
