{
  Map<FieldInfo,DocFieldConsumerPerField> childFields=new HashMap<FieldInfo,DocFieldConsumerPerField>();
  Collection<DocFieldConsumerPerField> fields=fields();
  for (  DocFieldConsumerPerField f : fields) {
    childFields.put(f.getFieldInfo(),f);
  }
  boolean success=false;
  try {
    fieldsWriter.flush(state);
    success=true;
  }
  finally {
    if (!success) {
      abort();
    }
  }
  consumer.flush(childFields,state);
  final String fileName=IndexFileNames.segmentFileName(state.segmentName,"",IndexFileNames.FIELD_INFOS_EXTENSION);
  state.fieldInfos.write(state.directory,fileName);
}
