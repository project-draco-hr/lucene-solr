{
  Map<FieldInfo,DocFieldConsumerPerField> childFields=new HashMap<FieldInfo,DocFieldConsumerPerField>();
  Collection<DocFieldConsumerPerField> fields=fields();
  for (  DocFieldConsumerPerField f : fields) {
    childFields.put(f.getFieldInfo(),f);
  }
  fieldsWriter.flush(state);
  consumer.flush(childFields,state);
  FieldInfosWriter infosWriter=codec.fieldInfosFormat().getFieldInfosWriter();
  infosWriter.write(state.directory,state.segmentName,state.fieldInfos,IOContext.DEFAULT);
  for (  DocValuesConsumerAndDocID consumers : docValues.values()) {
    consumers.docValuesConsumer.finish(state.numDocs);
  }
  IOUtils.close(perDocConsumers.values());
}
