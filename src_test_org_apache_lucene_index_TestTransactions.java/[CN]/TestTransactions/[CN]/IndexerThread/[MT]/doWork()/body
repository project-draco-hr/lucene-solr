{
  IndexWriter writer1=new IndexWriter(dir1,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.LIMITED);
  writer1.setMaxBufferedDocs(3);
  writer1.setMergeFactor(2);
  ((ConcurrentMergeScheduler)writer1.getMergeScheduler()).setSuppressExceptions();
  IndexWriter writer2=new IndexWriter(dir2,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.LIMITED);
  writer2.setMaxBufferedDocs(2);
  writer2.setMergeFactor(3);
  ((ConcurrentMergeScheduler)writer2.getMergeScheduler()).setSuppressExceptions();
  update(writer1);
  update(writer2);
  TestTransactions.doFail=true;
  try {
synchronized (lock) {
      try {
        writer1.prepareCommit();
      }
 catch (      Throwable t) {
        writer1.rollback();
        writer2.rollback();
        return;
      }
      try {
        writer2.prepareCommit();
      }
 catch (      Throwable t) {
        writer1.rollback();
        writer2.rollback();
        return;
      }
      writer1.commit();
      writer2.commit();
    }
  }
  finally {
    TestTransactions.doFail=false;
  }
  writer1.close();
  writer2.close();
}
