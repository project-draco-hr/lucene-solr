{
  fieldInfos=new FieldInfos();
  fieldInfos.add(doc);
  postingTable.clear();
  fieldLengths=new int[fieldInfos.size()];
  fieldPositions=new int[fieldInfos.size()];
  fieldOffsets=new int[fieldInfos.size()];
  fieldStoresPayloads=new BitSet(fieldInfos.size());
  fieldBoosts=new float[fieldInfos.size()];
  Arrays.fill(fieldBoosts,doc.getBoost());
  invertDocument(doc);
  Posting[] postings=sortPostingTable();
  fieldInfos.write(directory,segment + ".fnm");
  FieldsWriter fieldsWriter=new FieldsWriter(directory,segment,fieldInfos);
  try {
    fieldsWriter.addDocument(doc);
  }
  finally {
    fieldsWriter.close();
  }
  writePostings(postings,segment);
  writeNorms(segment);
}
