{
  fieldInfos=new FieldInfos();
  fieldInfos.add(doc);
  postingTable.clear();
  fieldLengths=new int[fieldInfos.size()];
  fieldPositions=new int[fieldInfos.size()];
  fieldOffsets=new int[fieldInfos.size()];
  fieldStoresPayloads=new BitSet(fieldInfos.size());
  fieldBoosts=new float[fieldInfos.size()];
  Arrays.fill(fieldBoosts,doc.getBoost());
  try {
    invertDocument(doc);
    Posting[] postings=sortPostingTable();
    fieldInfos.write(directory,segment + ".fnm");
    FieldsWriter fieldsWriter=new FieldsWriter(directory,segment,fieldInfos);
    try {
      fieldsWriter.addDocument(doc);
    }
  finally {
      fieldsWriter.close();
    }
    writePostings(postings,segment);
    writeNorms(segment);
  }
  finally {
    IOException ex=null;
    Iterator it=openTokenStreams.iterator();
    while (it.hasNext()) {
      try {
        ((TokenStream)it.next()).close();
      }
 catch (      IOException e) {
        if (ex != null) {
          ex=e;
        }
      }
    }
    openTokenStreams.clear();
    if (ex != null) {
      throw ex;
    }
  }
}
