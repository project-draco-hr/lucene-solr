{
  fieldInfos=new FieldInfos();
  fieldInfos.add(doc);
  fieldInfos.write(directory,segment + ".fnm");
  FieldsWriter fieldsWriter=new FieldsWriter(directory,segment,fieldInfos);
  try {
    fieldsWriter.addDocument(doc);
  }
  finally {
    fieldsWriter.close();
  }
  postingTable.clear();
  fieldLengths=new int[fieldInfos.size()];
  fieldBoosts=new float[fieldInfos.size()];
  Arrays.fill(fieldBoosts,doc.getBoost());
  invertDocument(doc);
  Posting[] postings=sortPostingTable();
  writePostings(postings,segment);
  writeNorms(doc,segment);
}
