{
  Enumeration fields=doc.fields();
  while (fields.hasMoreElements()) {
    Field field=(Field)fields.nextElement();
    String fieldName=field.name();
    int fieldNumber=fieldInfos.fieldNumber(fieldName);
    int length=fieldLengths[fieldNumber];
    int position=fieldPositions[fieldNumber];
    if (field.isIndexed()) {
      if (!field.isTokenized()) {
        addPosition(fieldName,field.stringValue(),position++);
        length++;
      }
 else {
        Reader reader;
        if (field.readerValue() != null)         reader=field.readerValue();
 else         if (field.stringValue() != null)         reader=new StringReader(field.stringValue());
 else         throw new IllegalArgumentException("field must have either String or Reader value");
        TokenStream stream=analyzer.tokenStream(fieldName,reader);
        try {
          for (Token t=stream.next(); t != null; t=stream.next()) {
            position+=(t.getPositionIncrement() - 1);
            addPosition(fieldName,t.termText(),position++);
            if (++length > maxFieldLength)             break;
          }
        }
  finally {
          stream.close();
        }
      }
      fieldLengths[fieldNumber]=length;
      fieldPositions[fieldNumber]=position;
      fieldBoosts[fieldNumber]*=field.getBoost();
    }
  }
}
