{
  log.info("Shutting down CoreContainer instance=" + System.identityHashCode(this));
  if (isZooKeeperAware()) {
    try {
      zkController.publishAndWaitForDownStates();
    }
 catch (    KeeperException e) {
      log.error("",e);
    }
catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      log.warn("",e);
    }
  }
  isShutDown=true;
  if (isZooKeeperAware()) {
    coreMaps.publishCoresAsDown(zkController);
    cancelCoreRecoveries();
  }
  try {
synchronized (coreMaps.getLocker()) {
      coreMaps.getLocker().notifyAll();
    }
    if (backgroundCloser != null) {
      try {
        backgroundCloser.join();
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        if (log.isDebugEnabled()) {
          log.debug("backgroundCloser thread was interrupted before finishing");
        }
      }
    }
    coreMaps.clearMaps(cfg);
synchronized (coreMaps.getLocker()) {
      coreMaps.getLocker().notifyAll();
    }
  }
  finally {
    if (shardHandlerFactory != null) {
      shardHandlerFactory.close();
    }
    if (zkController != null) {
      zkController.close();
    }
    if (zkServer != null) {
      zkServer.stop();
    }
  }
}
