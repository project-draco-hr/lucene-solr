{
  log.info("Shutting down CoreContainer instance=" + System.identityHashCode(this));
  if (isZooKeeperAware()) {
    try {
      zkSys.getZkController().publishAndWaitForDownStates();
    }
 catch (    KeeperException e) {
      log.error("",e);
    }
catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      log.warn("",e);
    }
  }
  isShutDown=true;
  if (isZooKeeperAware()) {
    zkSys.publishCoresAsDown(solrCores.getCores());
    cancelCoreRecoveries();
  }
  try {
synchronized (solrCores.getModifyLock()) {
      solrCores.getModifyLock().notifyAll();
    }
    if (backgroundCloser != null) {
      try {
        backgroundCloser.join();
      }
 catch (      InterruptedException e) {
        Thread.currentThread().interrupt();
        if (log.isDebugEnabled()) {
          log.debug("backgroundCloser thread was interrupted before finishing");
        }
      }
    }
    solrCores.close();
synchronized (solrCores.getModifyLock()) {
      solrCores.getModifyLock().notifyAll();
    }
  }
  finally {
    try {
      if (shardHandlerFactory != null) {
        shardHandlerFactory.close();
      }
    }
  finally {
      try {
        if (updateShardHandler != null) {
          updateShardHandler.close();
        }
      }
  finally {
        zkSys.close();
      }
    }
  }
  org.apache.lucene.util.IOUtils.closeWhileHandlingException(loader);
}
