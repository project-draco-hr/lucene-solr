{
  log.info("Shutting down CoreContainer instance=" + System.identityHashCode(this));
  if (isZooKeeperAware()) {
    try {
      zkController.publishAndWaitForDownStates();
    }
 catch (    KeeperException e) {
      log.error("",e);
    }
catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      log.warn("",e);
    }
  }
  isShutDown=true;
  if (isZooKeeperAware()) {
    cancelCoreRecoveries();
  }
  try {
synchronized (cores) {
      for (      SolrCore core : cores.values()) {
        try {
          core.close();
        }
 catch (        Throwable t) {
          SolrException.log(log,"Error shutting down core",t);
        }
      }
      cores.clear();
    }
synchronized (transientCores) {
      for (      SolrCore core : transientCores.values()) {
        try {
          core.close();
        }
 catch (        Throwable t) {
          SolrException.log(log,"Error shutting down core",t);
        }
      }
      transientCores.clear();
    }
  }
  finally {
    if (shardHandlerFactory != null) {
      shardHandlerFactory.close();
    }
    if (zkController != null) {
      zkController.close();
    }
    if (zkServer != null) {
      zkServer.stop();
    }
  }
}
