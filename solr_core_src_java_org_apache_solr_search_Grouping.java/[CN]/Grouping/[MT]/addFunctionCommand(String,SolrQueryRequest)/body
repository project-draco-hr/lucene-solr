{
  QParser parser=QParser.getParser(groupByStr,"func",request);
  Query q=parser.getQuery();
  final Grouping.Command gc;
  if (q instanceof FunctionQuery) {
    ValueSource valueSource=((FunctionQuery)q).getValueSource();
    if (valueSource instanceof StrFieldSource) {
      String field=((StrFieldSource)valueSource).getField();
      CommandField commandField=new CommandField();
      commandField.groupBy=field;
      gc=commandField;
    }
 else {
      CommandFunc commandFunc=new CommandFunc();
      commandFunc.groupBy=valueSource;
      gc=commandFunc;
    }
  }
 else {
    CommandFunc commandFunc=new CommandFunc();
    commandFunc.groupBy=new QueryValueSource(q,0.0f);
    gc=commandFunc;
  }
  gc.withinGroupSort=withinGroupSort;
  gc.key=groupByStr;
  gc.numGroups=limitDefault;
  gc.docsPerGroup=docsPerGroupDefault;
  gc.groupOffset=groupOffsetDefault;
  gc.offset=cmd.getOffset();
  gc.sort=sort;
  gc.format=defaultFormat;
  gc.totalCount=defaultTotalCount;
  if (main) {
    gc.main=true;
    gc.format=Grouping.Format.simple;
  }
  if (gc.format == Grouping.Format.simple) {
    gc.groupOffset=0;
  }
  commands.add(gc);
}
