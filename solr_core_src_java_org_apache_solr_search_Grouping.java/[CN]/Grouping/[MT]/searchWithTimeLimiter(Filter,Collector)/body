{
  if (cmd.getTimeAllowed() > 0) {
    if (timeLimitingCollector == null) {
      timeLimitingCollector=new TimeLimitingCollector(collector,TimeLimitingCollector.getGlobalCounter(),cmd.getTimeAllowed());
    }
 else {
      timeLimitingCollector.setCollector(collector);
    }
    collector=timeLimitingCollector;
  }
  try {
    Query q=query;
    if (luceneFilter != null) {
      q=new BooleanQuery.Builder().add(q,Occur.MUST).add(luceneFilter,Occur.FILTER).build();
    }
    searcher.search(q,collector);
  }
 catch (  TimeLimitingCollector.TimeExceededException|ExitableDirectoryReader.ExitingReaderException x) {
    logger.warn("Query: " + query + "; "+ x.getMessage());
    qr.setPartialResults(true);
  }
}
