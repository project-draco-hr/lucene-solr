{
  log.info("Create collection {} with numShards {}",collectionName,numShards);
  DocRouter hp=new DocRouter();
  List<DocRouter.Range> ranges=hp.partitionRange(numShards,hp.fullRange());
  Map<String,DocCollection> newCollections=new LinkedHashMap<String,DocCollection>();
  Map<String,Slice> newSlices=new LinkedHashMap<String,Slice>();
  newCollections.putAll(state.getCollectionStates());
  for (int i=0; i < numShards; i++) {
    final String sliceName="shard" + (i + 1);
    Map<String,Object> sliceProps=new LinkedHashMap<String,Object>(1);
    sliceProps.put(Slice.RANGE,ranges.get(i));
    newSlices.put(sliceName,new Slice(sliceName,null,sliceProps));
  }
  Map<String,Object> collectionProps=defaultCollectionProps();
  DocRouter router=DocRouter.DEFAULT;
  DocCollection newCollection=new DocCollection(collectionName,newSlices,collectionProps,router);
  newCollections.put(collectionName,newCollection);
  ClusterState newClusterState=new ClusterState(state.getLiveNodes(),newCollections);
  return newClusterState;
}
