{
  Map<String,DocCollection> newCollections=new LinkedHashMap<>(state.getCollectionStates());
  DocCollection coll=newCollections.get(collectionName);
  Map<String,Slice> slices;
  Map<String,Object> props;
  DocRouter router;
  if (coll == null) {
    slices=new HashMap<>(1);
    props=new HashMap<>(1);
    props.put(DocCollection.DOC_ROUTER,ZkNodeProps.makeMap("name",ImplicitDocRouter.NAME));
    router=new ImplicitDocRouter();
  }
 else {
    props=coll.getProperties();
    router=coll.getRouter();
    slices=new LinkedHashMap<>(coll.getSlicesMap());
  }
  slices.put(slice.getName(),slice);
  DocCollection newCollection=new DocCollection(collectionName,slices,props,router);
  newCollections.put(collectionName,newCollection);
  return new ClusterState(state.getLiveNodes(),newCollections);
}
