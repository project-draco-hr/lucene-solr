{
  final String coreNodeName=message.getStr(ZkStateReader.NODE_NAME_PROP) + "_" + message.getStr(ZkStateReader.CORE_NAME_PROP);
  final String collection=message.getStr(ZkStateReader.COLLECTION_PROP);
  final Map<String,DocCollection> newCollections=new LinkedHashMap<String,DocCollection>(clusterState.getCollectionStates());
  DocCollection coll=newCollections.get(collection);
  if (coll == null) {
    return clusterState;
  }
  Map<String,Slice> newSlices=new LinkedHashMap<String,Slice>();
  for (  Slice slice : coll.getSlices()) {
    Replica replica=slice.getReplica(coreNodeName);
    if (replica != null) {
      Map<String,Replica> newReplicas=slice.getReplicasCopy();
      newReplicas.remove(coreNodeName);
      if (newReplicas.size() == 0) {
        slice=null;
      }
 else {
        slice=new Slice(slice.getName(),newReplicas,slice.getProperties());
      }
    }
    if (slice != null) {
      newSlices.put(slice.getName(),slice);
    }
  }
  if (newSlices.size() == 0) {
    newCollections.remove(coll.getName());
    try {
      zkClient.clean("/collections/" + collection);
    }
 catch (    InterruptedException e) {
      SolrException.log(log,"Cleaning up collection in zk was interrupted:" + collection,e);
      Thread.currentThread().interrupt();
    }
catch (    KeeperException e) {
      SolrException.log(log,"Problem cleaning up collection in zk:" + collection,e);
    }
  }
 else {
    DocCollection newCollection=new DocCollection(coll.getName(),newSlices,coll.getProperties(),coll.getRouter());
    newCollections.put(newCollection.getName(),newCollection);
  }
  ClusterState newState=new ClusterState(clusterState.getLiveNodes(),newCollections);
  return newState;
}
