{
  TimerContext timerContext=stats.time("update_state");
  boolean success=false;
  try {
    if (!updateNodes.isEmpty()) {
      for (      Entry<String,Object> e : updateNodes.entrySet()) {
        if (e.getValue() == null) {
          if (zkClient.exists(e.getKey(),true))           zkClient.delete(e.getKey(),0,true);
        }
 else {
          byte[] data=ZkStateReader.toJSON(e.getValue());
          if (zkClient.exists(e.getKey(),true)) {
            log.info("going to update_collection {}",e.getKey());
            zkClient.setData(e.getKey(),data,true);
          }
 else {
            log.info("going to create_collection {}",e.getKey(),new String(data));
            zkClient.create(e.getKey(),data,CreateMode.PERSISTENT,true);
          }
        }
      }
      updateNodes.clear();
    }
    if (isClusterStateModified) {
      lastUpdatedTime=System.nanoTime();
      zkClient.setData(ZkStateReader.CLUSTER_STATE,ZkStateReader.toJSON(clusterState),true);
      isClusterStateModified=false;
    }
    success=true;
  }
  finally {
    timerContext.stop();
    if (success) {
      stats.success("update_state");
    }
 else {
      stats.error("update_state");
    }
  }
}
