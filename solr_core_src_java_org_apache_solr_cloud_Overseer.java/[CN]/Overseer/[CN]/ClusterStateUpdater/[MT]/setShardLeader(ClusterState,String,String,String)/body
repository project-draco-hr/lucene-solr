{
  final Map<String,Map<String,Slice>> newStates=new LinkedHashMap<String,Map<String,Slice>>(state.getCollectionStates());
  Map<String,Slice> slices=newStates.get(collection);
  if (slices == null) {
    log.error("Could not mark shard leader for non existing collection:" + collection);
    return state;
  }
  slices=new LinkedHashMap<String,Slice>(slices);
  newStates.put(collection,slices);
  Slice slice=slices.get(sliceName);
  if (slice == null) {
    log.error("Could not mark leader for non existing slice:" + sliceName);
    return state;
  }
 else {
    Replica oldLeader=slice.getLeader();
    final Map<String,Replica> newReplicas=new LinkedHashMap<String,Replica>();
    for (    Replica replica : slice.getReplicas()) {
      String coreURL=ZkCoreNodeProps.getCoreUrl(replica.getStr(ZkStateReader.BASE_URL_PROP),replica.getStr(ZkStateReader.CORE_NAME_PROP));
      if (replica == oldLeader && !coreURL.equals(leaderUrl)) {
        Map<String,Object> replicaProps=new LinkedHashMap<String,Object>(replica.getProperties());
        replicaProps.remove(Slice.LEADER);
        replica=new Replica(replica.getName(),replicaProps);
      }
 else       if (coreURL.equals(leaderUrl)) {
        Map<String,Object> replicaProps=new LinkedHashMap<String,Object>(replica.getProperties());
        replicaProps.put(Slice.LEADER,"true");
        replica=new Replica(replica.getName(),replicaProps);
      }
      newReplicas.put(replica.getName(),replica);
    }
    Map<String,Object> newSliceProps=slice.shallowCopy();
    newSliceProps.put(Slice.REPLICAS,newReplicas);
    Slice newSlice=new Slice(slice.getName(),newReplicas,slice.getProperties());
    slices.put(newSlice.getName(),newSlice);
  }
  return new ClusterState(state.getLiveNodes(),newStates);
}
