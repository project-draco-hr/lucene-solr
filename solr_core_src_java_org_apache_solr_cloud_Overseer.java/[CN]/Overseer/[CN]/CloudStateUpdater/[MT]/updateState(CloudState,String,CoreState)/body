{
  String collection=coreState.getCollectionName();
  String zkCoreNodeName=coreState.getCoreNodeName();
  String shardId;
  if (coreState.getProperties().get(ZkStateReader.SHARD_ID_PROP) == null) {
    shardId=AssignShard.assignShard(collection,state);
  }
 else {
    shardId=coreState.getProperties().get(ZkStateReader.SHARD_ID_PROP);
  }
  Map<String,String> props=new HashMap<String,String>();
  for (  Entry<String,String> entry : coreState.getProperties().entrySet()) {
    props.put(entry.getKey(),entry.getValue());
  }
  ZkNodeProps zkProps=new ZkNodeProps(props);
  Slice slice=state.getSlice(collection,shardId);
  Map<String,ZkNodeProps> shardProps;
  if (slice == null) {
    shardProps=new HashMap<String,ZkNodeProps>();
  }
 else {
    shardProps=state.getSlice(collection,shardId).getShardsCopy();
  }
  shardProps.put(zkCoreNodeName,zkProps);
  slice=new Slice(shardId,shardProps);
  CloudState newCloudState=updateSlice(state,collection,slice);
  return newCloudState;
}
