{
  final String coreNodeName=message.get(ZkStateReader.NODE_NAME_PROP) + "_" + message.get(ZkStateReader.CORE_NAME_PROP);
  final String collection=message.get(ZkStateReader.COLLECTION_PROP);
  final LinkedHashMap<String,Map<String,Slice>> newStates=new LinkedHashMap<String,Map<String,Slice>>();
  for (  String collectionName : cloudState.getCollections()) {
    if (collection.equals(collectionName)) {
      Map<String,Slice> slices=cloudState.getSlices(collection);
      LinkedHashMap<String,Slice> newSlices=new LinkedHashMap<String,Slice>();
      for (      Slice slice : slices.values()) {
        if (slice.getShards().containsKey(coreNodeName)) {
          LinkedHashMap<String,ZkNodeProps> newShards=new LinkedHashMap<String,ZkNodeProps>();
          newShards.putAll(slice.getShards());
          newShards.remove(coreNodeName);
          Slice newSlice=new Slice(slice.getName(),newShards);
          newSlices.put(slice.getName(),newSlice);
        }
 else {
          newSlices.put(slice.getName(),slice);
        }
      }
      newStates.put(collectionName,newSlices);
    }
 else {
      newStates.put(collectionName,cloudState.getSlices(collectionName));
    }
  }
  CloudState newState=new CloudState(cloudState.getLiveNodes(),newStates);
  return newState;
}
