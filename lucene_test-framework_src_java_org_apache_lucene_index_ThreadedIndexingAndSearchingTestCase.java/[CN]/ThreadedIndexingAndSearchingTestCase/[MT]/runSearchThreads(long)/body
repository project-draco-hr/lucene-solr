{
  final int numThreads=TestUtil.nextInt(random(),1,5);
  final Thread[] searchThreads=new Thread[numThreads];
  final AtomicInteger totHits=new AtomicInteger();
  final AtomicInteger totTermCount=new AtomicInteger(100);
  for (int thread=0; thread < searchThreads.length; thread++) {
    searchThreads[thread]=new Thread(){
      @Override public void run(){
        if (VERBOSE) {
          System.out.println(Thread.currentThread().getName() + ": launch search thread");
        }
        while (System.currentTimeMillis() < stopTimeMS && !failed.get()) {
          try {
            final IndexSearcher s=getCurrentSearcher();
            try {
              for (              final LeafReaderContext sub : s.getIndexReader().leaves()) {
                SegmentReader segReader=(SegmentReader)sub.reader();
                Map<String,String> diagnostics=segReader.getSegmentInfo().info.getDiagnostics();
                assertNotNull(diagnostics);
                String source=diagnostics.get("source");
                assertNotNull(source);
                if (source.equals("merge")) {
                  assertTrue("sub reader " + sub + " wasn't warmed: warmed="+ warmed+ " diagnostics="+ diagnostics+ " si="+ segReader.getSegmentInfo(),!assertMergedSegmentsWarmed || warmed.containsKey(segReader.core));
                }
              }
              if (s.getIndexReader().numDocs() > 0) {
                smokeTestSearcher(s);
                Fields fields=MultiFields.getFields(s.getIndexReader());
                Terms terms=fields.terms("body");
                if (terms == null) {
                  continue;
                }
                TermsEnum termsEnum=terms.iterator(null);
                int seenTermCount=0;
                int shift;
                int trigger;
                if (totTermCount.get() < 30) {
                  shift=0;
                  trigger=1;
                }
 else {
                  trigger=totTermCount.get() / 30;
                  shift=random().nextInt(trigger);
                }
                while (System.currentTimeMillis() < stopTimeMS) {
                  BytesRef term=termsEnum.next();
                  if (term == null) {
                    totTermCount.set(seenTermCount);
                    break;
                  }
                  seenTermCount++;
                  if ((seenTermCount + shift) % trigger == 0) {
                    totHits.addAndGet(runQuery(s,new TermQuery(new Term("body",BytesRef.deepCopyOf(term)))));
                  }
                }
              }
            }
  finally {
              releaseSearcher(s);
            }
          }
 catch (          Throwable t) {
            System.out.println(Thread.currentThread().getName() + ": hit exc");
            failed.set(true);
            t.printStackTrace(System.out);
            throw new RuntimeException(t);
          }
        }
      }
    }
;
    searchThreads[thread].start();
  }
  for (  Thread thread : searchThreads) {
    thread.join();
  }
  if (VERBOSE) {
    System.out.println("TEST: DONE search: totHits=" + totHits);
  }
}
