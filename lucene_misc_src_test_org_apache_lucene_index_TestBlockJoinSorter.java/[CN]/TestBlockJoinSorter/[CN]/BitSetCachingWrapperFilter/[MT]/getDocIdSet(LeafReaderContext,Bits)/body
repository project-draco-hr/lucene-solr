{
  final LeafReader reader=context.reader();
  final Object key=reader.getCoreCacheKey();
  BitDocIdSet docIdSet=cache.get(key);
  if (docIdSet == null) {
    final DocIdSet uncached=filter.getDocIdSet(context,null);
    final DocIdSetIterator it=uncached == null ? null : uncached.iterator();
    if (it != null) {
      BitDocIdSet.Builder builder=new BitDocIdSet.Builder(context.reader().maxDoc());
      builder.or(it);
      docIdSet=builder.build();
    }
    if (docIdSet == null) {
      docIdSet=new BitDocIdSet(new SparseFixedBitSet(context.reader().maxDoc()));
    }
    cache.put(key,docIdSet);
  }
  return docIdSet == EMPTY ? null : BitsFilteredDocIdSet.wrap(docIdSet,acceptDocs);
}
