{
  try {
    if (!successfulInstall) {
      try {
        logReplicationTimeAndConfFiles(null,successfulInstall);
      }
 catch (      Exception e) {
        LOG.error("caught",e);
      }
    }
    core.getUpdateHandler().getSolrCoreState().setLastReplicateIndexSuccess(successfulInstall);
    filesToDownload=filesDownloaded=confFilesDownloaded=confFilesToDownload=tlogFilesToDownload=tlogFilesDownloaded=null;
    markReplicationStop();
    dirFileFetcher=null;
    localFileFetcher=null;
    if (fsyncService != null && !fsyncService.isShutdown())     fsyncService.shutdown();
    fsyncService=null;
    stop=false;
    fsyncException=null;
  }
  finally {
    if (deleteTmpIdxDir && tmpIndexDir != null) {
      try {
        core.getDirectoryFactory().doneWithDirectory(tmpIndexDir);
        core.getDirectoryFactory().remove(tmpIndexDir);
      }
 catch (      IOException e) {
        SolrException.log(LOG,"Error removing directory " + tmpIndexDir,e);
      }
    }
    if (tmpIndexDir != null) {
      core.getDirectoryFactory().release(tmpIndexDir);
    }
    if (indexDir != null) {
      core.getDirectoryFactory().release(indexDir);
    }
    if (tmpTlogDir != null) {
      delTree(tmpTlogDir);
    }
  }
}
