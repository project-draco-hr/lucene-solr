{
  final Map<String,SearchGroupsFieldCommandResult> result=new HashMap<>(shardResponse.size());
  for (  Map.Entry<String,NamedList> command : shardResponse) {
    List<SearchGroup<BytesRef>> searchGroups=new ArrayList<>();
    NamedList topGroupsAndGroupCount=command.getValue();
    @SuppressWarnings("unchecked") final NamedList<List<Comparable>> rawSearchGroups=(NamedList<List<Comparable>>)topGroupsAndGroupCount.get(TOP_GROUPS);
    if (rawSearchGroups != null) {
      for (      Map.Entry<String,List<Comparable>> rawSearchGroup : rawSearchGroups) {
        SearchGroup<BytesRef> searchGroup=new SearchGroup<>();
        searchGroup.groupValue=rawSearchGroup.getKey() != null ? new BytesRef(rawSearchGroup.getKey()) : null;
        searchGroup.sortValues=rawSearchGroup.getValue().toArray(new Comparable[rawSearchGroup.getValue().size()]);
        for (int i=0; i < searchGroup.sortValues.length; i++) {
          SchemaField field=groupSort.getSort()[i].getField() != null ? searcher.getSchema().getFieldOrNull(groupSort.getSort()[i].getField()) : null;
          if (field != null) {
            FieldType fieldType=field.getType();
            if (searchGroup.sortValues[i] != null) {
              searchGroup.sortValues[i]=fieldType.unmarshalSortValue(searchGroup.sortValues[i]);
            }
          }
        }
        searchGroups.add(searchGroup);
      }
    }
    final Integer groupCount=(Integer)topGroupsAndGroupCount.get(GROUP_COUNT);
    result.put(command.getKey(),new SearchGroupsFieldCommandResult(groupCount,searchGroups));
  }
  return result;
}
