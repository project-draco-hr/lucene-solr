{
  long totalBytes=0;
  long localBytes=0;
  int totalCount=0;
  int localCount=0;
  for (Iterator<HdfsDirectory> iterator=cache.keySet().iterator(); iterator.hasNext(); ) {
    HdfsDirectory hdfsDirectory=iterator.next();
    if (hdfsDirectory.isClosed()) {
      iterator.remove();
    }
 else {
      try {
        refreshDirectory(hdfsDirectory);
        Map<FileStatus,BlockLocation[]> blockMap=cache.get(hdfsDirectory);
        for (        BlockLocation[] locations : blockMap.values()) {
          for (          BlockLocation bl : locations) {
            totalBytes+=bl.getLength();
            totalCount++;
            if (Arrays.asList(bl.getHosts()).contains(hostname)) {
              localBytes+=bl.getLength();
              localCount++;
            }
          }
        }
      }
 catch (      IOException e) {
        logger.warn("Could not retrieve locality information for {} due to exception: {}",hdfsDirectory.getHdfsDirPath(),e);
      }
    }
  }
  return createStatistics(totalBytes,localBytes,totalCount,localCount);
}
