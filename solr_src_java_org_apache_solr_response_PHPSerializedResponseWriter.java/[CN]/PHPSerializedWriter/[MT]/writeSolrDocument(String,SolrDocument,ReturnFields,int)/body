{
  writeKey(idx,false);
  LinkedHashMap<String,Object> single=new LinkedHashMap<String,Object>();
  LinkedHashMap<String,Object> multi=new LinkedHashMap<String,Object>();
  for (  String fname : doc.getFieldNames()) {
    if (!returnFields.wantsField(fname)) {
      continue;
    }
    Object val=doc.getFieldValue(fname);
    if (val instanceof Collection) {
      multi.put(fname,val);
    }
 else {
      single.put(fname,val);
    }
  }
  writeMapOpener(single.size() + multi.size());
  for (  String fname : single.keySet()) {
    Object val=single.get(fname);
    writeKey(fname,true);
    writeVal(fname,val);
  }
  for (  String fname : multi.keySet()) {
    writeKey(fname,true);
    Object val=multi.get(fname);
    if (!(val instanceof Collection)) {
      writeArrayOpener(1);
      writeVal(fname,val);
      writeArrayCloser();
    }
 else {
      writeVal(fname,val);
    }
  }
  writeMapCloser();
}
