{
  conf.setInfoStream(new TestPointInfoStream(conf.getInfoStream(),testPoint));
  DirectoryReader reader=null;
  if (r.nextBoolean() && DirectoryReader.indexExists(dir) && conf.getOpenMode() != IndexWriterConfig.OpenMode.CREATE) {
    if (LuceneTestCase.VERBOSE) {
      System.out.println("RIW: open writer from reader");
    }
    reader=DirectoryReader.open(dir);
    conf.setIndexCommit(reader.getIndexCommit());
  }
  IndexWriter iw;
  boolean success=false;
  try {
    iw=new IndexWriter(dir,conf);
    success=true;
  }
  finally {
    if (reader != null) {
      if (success) {
        IOUtils.close(reader);
      }
 else {
        IOUtils.closeWhileHandlingException(reader);
      }
    }
  }
  iw.enableTestPoints=true;
  return iw;
}
