{
  SchemaField sf=searcher.getSchema().getField(fieldName);
  SortedDocValues si;
  try {
    si=FieldCache.DEFAULT.getTermsIndex(searcher.getAtomicReader(),fieldName);
  }
 catch (  IOException e) {
    throw new RuntimeException("failed to open field cache for: " + fieldName,e);
  }
  StatsValues allstats=StatsValuesFactory.createStatsValues(sf);
  final int nTerms=si.getValueCount();
  if (nTerms <= 0 || docs.size() <= 0)   return allstats.getStatsValues();
  List<FieldFacetStats> facetStats=new ArrayList<FieldFacetStats>();
  SortedDocValues facetTermsIndex;
  for (  String facetField : facet) {
    SchemaField fsf=searcher.getSchema().getField(facetField);
    if (fsf.multiValued()) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Stats can only facet on single-valued fields, not: " + facetField);
    }
    try {
      facetTermsIndex=FieldCache.DEFAULT.getTermsIndex(searcher.getAtomicReader(),facetField);
    }
 catch (    IOException e) {
      throw new RuntimeException("failed to open field cache for: " + facetField,e);
    }
    facetStats.add(new FieldFacetStats(facetField,facetTermsIndex,sf,fsf,nTerms));
  }
  final BytesRef tempBR=new BytesRef();
  DocIterator iter=docs.iterator();
  while (iter.hasNext()) {
    int docID=iter.nextDoc();
    int docOrd=si.getOrd(docID);
    BytesRef raw;
    if (docOrd == -1) {
      allstats.missing();
      tempBR.length=0;
      raw=tempBR;
    }
 else {
      raw=tempBR;
      si.lookupOrd(docOrd,tempBR);
      if (tempBR.length > 0) {
        allstats.accumulate(tempBR);
      }
 else {
        allstats.missing();
      }
    }
    for (    FieldFacetStats f : facetStats) {
      f.facet(docID,raw);
    }
  }
  for (  FieldFacetStats f : facetStats) {
    allstats.addFacet(f.name,f.facetStatsValues);
  }
  return allstats.getStatsValues();
}
