{
  Directory ram=newDirectory();
  PayloadAnalyzer analyzer=new PayloadAnalyzer();
  IndexWriter writer=new IndexWriter(ram,newIndexWriterConfig(TEST_VERSION_CURRENT,analyzer));
  Document d=new Document();
  d.add(newField("f1","This field has no payloads",TextField.TYPE_UNSTORED));
  d.add(newField("f2","This field has payloads in all docs",TextField.TYPE_UNSTORED));
  d.add(newField("f2","This field has payloads in all docs NO PAYLOAD",TextField.TYPE_UNSTORED));
  d.add(newField("f3","This field has payloads in some docs",TextField.TYPE_UNSTORED));
  analyzer.setPayloadData("f2","somedata".getBytes(),0,1);
  writer.addDocument(d);
  writer.close();
  SegmentReader reader=getOnlySegmentReader(DirectoryReader.open(ram));
  FieldInfos fi=reader.getFieldInfos();
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f1").hasPayloads());
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f2").hasPayloads());
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f3").hasPayloads());
  reader.close();
  analyzer=new PayloadAnalyzer();
  writer=new IndexWriter(ram,newIndexWriterConfig(TEST_VERSION_CURRENT,analyzer).setOpenMode(OpenMode.CREATE));
  d=new Document();
  d.add(newField("f1","This field has no payloads",TextField.TYPE_UNSTORED));
  d.add(newField("f2","This field has payloads in all docs",TextField.TYPE_UNSTORED));
  d.add(newField("f2","This field has payloads in all docs",TextField.TYPE_UNSTORED));
  d.add(newField("f3","This field has payloads in some docs",TextField.TYPE_UNSTORED));
  analyzer.setPayloadData("f2","somedata".getBytes(),0,1);
  analyzer.setPayloadData("f3","somedata".getBytes(),0,3);
  writer.addDocument(d);
  writer.forceMerge(1);
  writer.close();
  reader=getOnlySegmentReader(DirectoryReader.open(ram));
  fi=reader.getFieldInfos();
  assertFalse("Payload field bit should not be set.",fi.fieldInfo("f1").hasPayloads());
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f2").hasPayloads());
  assertTrue("Payload field bit should be set.",fi.fieldInfo("f3").hasPayloads());
  reader.close();
  ram.close();
}
