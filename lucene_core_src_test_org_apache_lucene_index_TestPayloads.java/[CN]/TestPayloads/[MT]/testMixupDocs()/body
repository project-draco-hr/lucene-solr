{
  Directory dir=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,null);
  iwc.setMergePolicy(newLogMergePolicy());
  RandomIndexWriter writer=new RandomIndexWriter(random(),dir,iwc);
  Document doc=new Document();
  Field field=new TextField("field","",Field.Store.NO);
  TokenStream ts=new MockTokenizer(new StringReader("here we go"),MockTokenizer.WHITESPACE,true);
  assertFalse(ts.hasAttribute(PayloadAttribute.class));
  field.setTokenStream(ts);
  doc.add(field);
  writer.addDocument(doc);
  Token withPayload=new Token("withPayload",0,11);
  withPayload.setPayload(new BytesRef("test"));
  ts=new CannedTokenStream(withPayload);
  assertTrue(ts.hasAttribute(PayloadAttribute.class));
  field.setTokenStream(ts);
  writer.addDocument(doc);
  ts=new MockTokenizer(new StringReader("another"),MockTokenizer.WHITESPACE,true);
  assertFalse(ts.hasAttribute(PayloadAttribute.class));
  field.setTokenStream(ts);
  writer.addDocument(doc);
  DirectoryReader reader=writer.getReader();
  AtomicReader sr=SlowCompositeReaderWrapper.wrap(reader);
  DocsAndPositionsEnum de=sr.termPositionsEnum(new Term("field","withPayload"));
  de.nextDoc();
  de.nextPosition();
  assertEquals(new BytesRef("test"),de.getPayload());
  writer.close();
  reader.close();
  dir.close();
}
