{
  sreq.params.remove(FacetParams.FACET_HEATMAP);
  for (  Map.Entry<String,HeatmapFacet> entry : heatmapFacets.entrySet()) {
    final String key=entry.getKey();
    final HeatmapFacet facet=entry.getValue();
    if (!key.equals(facet.facetOn)) {
      sreq.params.add(FacetParams.FACET_HEATMAP,"{!" + CommonParams.OUTPUT_KEY + "="+ QueryParsing.encodeLocalParamVal(key)+ "}"+ facet.facetOn);
    }
 else {
      sreq.params.add(FacetParams.FACET_HEATMAP,facet.facetOn);
    }
    if (facet.localParams != null) {
      final Iterator<String> localNameIter=facet.localParams.getParameterNamesIterator();
      while (localNameIter.hasNext()) {
        String pname=localNameIter.next();
        if (!pname.startsWith(FacetParams.FACET_HEATMAP)) {
          continue;
        }
        String pval=facet.localParams.get(pname);
        sreq.params.set("f." + key + "."+ pname,pval);
      }
    }
    sreq.params.set("f." + key + "."+ FacetParams.FACET_HEATMAP_FORMAT,FORMAT_PNG);
  }
}
