{
  Map<Term,TermContext> termContexts=new HashMap<Term,TermContext>();
  TreeSet<Term> terms=new TreeSet<Term>();
  query.extractTerms(terms);
  for (  Term term : terms) {
    termContexts.put(term,TermContext.build(topLevelReaderContext,term,true));
  }
  final List<AtomicReaderContext> leaves=topLevelReaderContext.leaves();
  if (leaves.size() == 1) {
    final AtomicReaderContext ctx=leaves.get(0);
    return query.getSpans(ctx,ctx.reader().getLiveDocs(),termContexts);
  }
  return new MultiSpansWrapper(leaves,query,termContexts);
}
