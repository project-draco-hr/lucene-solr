{
  if (!(query instanceof ToParentBlockJoinQuery)) {
    if (query instanceof BooleanQuery) {
      List<BooleanClause> clauses=((BooleanQuery)query).clauses();
      ToParentBlockJoinQuery once=null;
      for (      BooleanClause clause : clauses) {
        if (clause.getQuery() instanceof ToParentBlockJoinQuery) {
          if (once == null) {
            once=(ToParentBlockJoinQuery)clause.getQuery();
          }
 else {
            throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"can't choose between " + once + " and "+ clause.getQuery());
          }
        }
      }
      if (once != null) {
        return once;
      }
    }
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,NO_TO_PARENT_BJQ_MESSAGE);
  }
 else {
    return (ToParentBlockJoinQuery)query;
  }
}
