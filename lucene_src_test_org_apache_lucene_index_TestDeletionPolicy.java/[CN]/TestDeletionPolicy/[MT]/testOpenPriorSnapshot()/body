{
  KeepAllDeletionPolicy policy=new KeepAllDeletionPolicy();
  Directory dir=newDirectory();
  policy.dir=dir;
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(policy).setMaxBufferedDocs(2));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(10);
  for (int i=0; i < 10; i++) {
    addDoc(writer);
    if ((1 + i) % 2 == 0)     writer.commit();
  }
  writer.close();
  Collection<IndexCommit> commits=IndexReader.listCommits(dir);
  assertEquals(5,commits.size());
  IndexCommit lastCommit=null;
  for (  final IndexCommit commit : commits) {
    if (lastCommit == null || commit.getGeneration() > lastCommit.getGeneration())     lastCommit=commit;
  }
  assertTrue(lastCommit != null);
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(policy));
  addDoc(writer);
  assertEquals(11,writer.numDocs());
  writer.optimize();
  writer.close();
  assertEquals(6,IndexReader.listCommits(dir).size());
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.rollback();
  IndexReader r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(11,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.close();
  assertEquals(7,IndexReader.listCommits(dir).size());
  r=IndexReader.open(dir,true);
  assertTrue(!r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexDeletionPolicy(policy));
  writer.optimize();
  writer.close();
  r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  r=IndexReader.open(dir,true);
  assertTrue(r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  writer.close();
  r=IndexReader.open(dir,true);
  assertTrue(!r.isOptimized());
  assertEquals(10,r.numDocs());
  r.close();
  dir.close();
}
