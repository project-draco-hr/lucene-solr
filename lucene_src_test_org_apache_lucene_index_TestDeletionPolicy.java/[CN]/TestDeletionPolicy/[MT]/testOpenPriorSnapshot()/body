{
  KeepAllDeletionPolicy policy=new KeepAllDeletionPolicy();
  Directory dir=newDirectory();
  policy.dir=dir;
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(policy).setMaxBufferedDocs(2).setMergePolicy(newLogMergePolicy(10)));
  for (int i=0; i < 10; i++) {
    addDoc(writer);
    if ((1 + i) % 2 == 0)     writer.commit();
  }
  writer.close();
  Collection<IndexCommit> commits=IndexReader.listCommits(dir);
  assertEquals(5,commits.size());
  IndexCommit lastCommit=null;
  for (  final IndexCommit commit : commits) {
    if (lastCommit == null || commit.getGeneration() > lastCommit.getGeneration())     lastCommit=commit;
  }
  assertTrue(lastCommit != null);
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(policy));
  addDoc(writer);
  assertEquals(11,writer.numDocs());
  writer.forceMerge(1);
  writer.close();
  assertEquals(6,IndexReader.listCommits(dir).size());
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.rollback();
  IndexReader r=IndexReader.open(dir);
  assertEquals(1,r.getSequentialSubReaders().length);
  assertEquals(11,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(policy).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  writer.close();
  assertEquals(7,IndexReader.listCommits(dir).size());
  r=IndexReader.open(dir);
  assertTrue(r.getSequentialSubReaders().length > 1);
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexDeletionPolicy(policy));
  writer.forceMerge(1);
  writer.close();
  r=IndexReader.open(dir);
  assertEquals(1,r.getSequentialSubReaders().length);
  assertEquals(10,r.numDocs());
  r.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setIndexCommit(lastCommit));
  assertEquals(10,writer.numDocs());
  r=IndexReader.open(dir);
  assertEquals(1,r.getSequentialSubReaders().length);
  assertEquals(10,r.numDocs());
  r.close();
  writer.close();
  r=IndexReader.open(dir);
  assertTrue(r.getSequentialSubReaders().length > 1);
  assertEquals(10,r.numDocs());
  r.close();
  dir.close();
}
