{
  for (int pass=0; pass < 2; pass++) {
    boolean useCompoundFile=(pass % 2) != 0;
    KeepNoneOnInitDeletionPolicy policy=new KeepNoneOnInitDeletionPolicy();
    Directory dir=newDirectory();
    IndexWriterConfig conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setIndexDeletionPolicy(policy).setMaxBufferedDocs(10);
    MergePolicy mp=conf.getMergePolicy();
    if (mp instanceof LogMergePolicy) {
      ((LogMergePolicy)mp).setUseCompoundFile(useCompoundFile);
    }
    IndexWriter writer=new IndexWriter(dir,conf);
    for (int i=0; i < 107; i++) {
      addDoc(writer);
    }
    writer.close();
    conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setIndexDeletionPolicy(policy);
    mp=conf.getMergePolicy();
    if (mp instanceof LogMergePolicy) {
      ((LogMergePolicy)mp).setUseCompoundFile(true);
    }
    writer=new IndexWriter(dir,conf);
    writer.forceMerge(1);
    writer.close();
    assertEquals(1,policy.numOnInit);
    assertEquals(2,policy.numOnCommit);
    IndexReader reader=IndexReader.open(dir,true);
    reader.close();
    dir.close();
  }
}
