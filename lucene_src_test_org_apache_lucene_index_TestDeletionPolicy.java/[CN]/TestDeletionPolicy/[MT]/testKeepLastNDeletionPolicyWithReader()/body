{
  final int N=10;
  for (int pass=0; pass < 2; pass++) {
    boolean useCompoundFile=(pass % 2) != 0;
    KeepLastNDeletionPolicy policy=new KeepLastNDeletionPolicy(N);
    Directory dir=newDirectory();
    IndexWriterConfig conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setIndexDeletionPolicy(policy).setMergePolicy(newLogMergePolicy());
    MergePolicy mp=conf.getMergePolicy();
    if (mp instanceof LogMergePolicy) {
      ((LogMergePolicy)mp).setUseCompoundFile(useCompoundFile);
    }
    IndexWriter writer=new IndexWriter(dir,conf);
    writer.close();
    Term searchTerm=new Term("content","aaa");
    Query query=new TermQuery(searchTerm);
    for (int i=0; i < N + 1; i++) {
      if (VERBOSE) {
        System.out.println("\nTEST: cycle i=" + i);
      }
      conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setIndexDeletionPolicy(policy);
      mp=conf.getMergePolicy();
      if (mp instanceof LogMergePolicy) {
        ((LogMergePolicy)mp).setUseCompoundFile(useCompoundFile);
      }
      writer=new IndexWriter(dir,conf);
      for (int j=0; j < 17; j++) {
        addDoc(writer);
      }
      if (VERBOSE) {
        System.out.println("TEST: close writer");
      }
      writer.close();
      IndexReader reader=IndexReader.open(dir,policy,false);
      reader.deleteDocument(3 * i + 1);
      reader.setNorm(4 * i + 1,"content",conf.getSimilarityProvider().get("content").encodeNormValue(2.0F));
      IndexSearcher searcher=newSearcher(reader);
      ScoreDoc[] hits=searcher.search(query,null,1000).scoreDocs;
      assertEquals(16 * (1 + i),hits.length);
      if (VERBOSE) {
        System.out.println("TEST: close reader numOnCommit=" + policy.numOnCommit);
      }
      reader.close();
      searcher.close();
    }
    conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setIndexDeletionPolicy(policy);
    mp=conf.getMergePolicy();
    if (mp instanceof LogMergePolicy) {
      ((LogMergePolicy)mp).setUseCompoundFile(useCompoundFile);
    }
    IndexReader r=IndexReader.open(dir);
    final boolean wasOptimized=r.isOptimized();
    r.close();
    writer=new IndexWriter(dir,conf);
    writer.optimize();
    writer.close();
    assertEquals(2 * (N + 1) + 1,policy.numOnInit);
    assertEquals(2 * (N + 2) - (wasOptimized ? 1 : 0),policy.numOnCommit);
    IndexSearcher searcher=new IndexSearcher(dir,false);
    ScoreDoc[] hits=searcher.search(query,null,1000).scoreDocs;
    assertEquals(176,hits.length);
    long gen=SegmentInfos.getCurrentSegmentGeneration(dir);
    dir.deleteFile(IndexFileNames.SEGMENTS_GEN);
    int expectedCount=176;
    searcher.close();
    for (int i=0; i < N + 1; i++) {
      try {
        IndexReader reader=IndexReader.open(dir,true);
        searcher=newSearcher(reader);
        hits=searcher.search(query,null,1000).scoreDocs;
        if (i > 1) {
          if (i % 2 == 0) {
            expectedCount+=1;
          }
 else {
            expectedCount-=17;
          }
        }
        assertEquals(expectedCount,hits.length);
        searcher.close();
        reader.close();
        if (i == N) {
          fail("should have failed on commits before last 5");
        }
      }
 catch (      IOException e) {
        if (i != N) {
          throw e;
        }
      }
      if (i < N) {
        dir.deleteFile(IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS,"",gen));
      }
      gen--;
    }
    dir.close();
  }
}
