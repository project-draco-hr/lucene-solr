{
  CloudSolrServer client=createCloudClient(null);
  try {
    client.connect();
    Map<String,Slice> slices=client.getZkStateReader().getClusterState().getCollection(COLLECTION_NAME).getSlicesMap();
    List<String> sliceList=new ArrayList<>(slices.keySet());
    String c1_s1=sliceList.get(0);
    List<String> replicasList=new ArrayList<>(slices.get(c1_s1).getReplicasMap().keySet());
    String c1_s1_r1=replicasList.get(0);
    String c1_s1_r2=replicasList.get(1);
    String c1_s2=sliceList.get(1);
    replicasList=new ArrayList<>(slices.get(c1_s2).getReplicasMap().keySet());
    String c1_s2_r1=replicasList.get(0);
    String c1_s2_r2=replicasList.get(1);
    slices=client.getZkStateReader().getClusterState().getCollection(COLLECTION_NAME1).getSlicesMap();
    sliceList=new ArrayList<>(slices.keySet());
    String c2_s1=sliceList.get(0);
    replicasList=new ArrayList<>(slices.get(c2_s1).getReplicasMap().keySet());
    String c2_s1_r1=replicasList.get(0);
    ModifiableSolrParams params=new ModifiableSolrParams();
    params.set("action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString());
    missingParamsError(client,params);
    params.set("collection",COLLECTION_NAME);
    missingParamsError(client,params);
    params.set("shard",c1_s1);
    missingParamsError(client,params);
    params.set("replica",c1_s1_r1);
    missingParamsError(client,params);
    params.set("property","preferredLeader");
    missingParamsError(client,params);
    params.set("property.value","true");
    SolrRequest request=new QueryRequest(params);
    request.setPath("/admin/collections");
    client.request(request);
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r1,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r2,"preferredLeader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r1,"preferredLeader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredLeader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r2,"property","preferredLeader","property.value","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredLeader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r1,"preferredLeader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredLeader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME,"shard",c1_s2,"replica",c1_s2_r1,"property","preferredLeader","property.value","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredLeader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME1,"shard",c2_s1,"replica",c2_s1_r1,"property","preferredLeader","property.value","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader","true");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.DELETEREPLICAPROP.toString(),"collection",COLLECTION_NAME1,"shard",c2_s1,"replica",c2_s1_r1,"property","preferredLeader");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r1,"property","testprop","property.value","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r1,"testprop","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r2,"property","prop","property.value","silly");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r1,"testprop","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"prop","silly");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toLower(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r1,"property","testprop","property.value","nonsense",SLICE_UNIQUE,"true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r1,"testprop","nonsense");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"prop","silly");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toLower(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r1,"property","testprop","property.value","true",SLICE_UNIQUE,"false");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r1,"testprop","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"prop","silly");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    doPropertyAction(client,"action",CollectionParams.CollectionAction.DELETEREPLICAPROP.toLower(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r1,"property","testprop");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"testprop");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"prop","silly");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    try {
      doPropertyAction(client,"action",CollectionParams.CollectionAction.ADDREPLICAPROP.toString(),"collection",COLLECTION_NAME,"shard",c1_s1,"replica",c1_s1_r1,"property","preferredLeader","property.value","true",SLICE_UNIQUE,"false");
      fail("Should have thrown an exception, setting sliceUnique=false is not allowed for 'preferredLeader'.");
    }
 catch (    SolrException se) {
      assertTrue("Should have received a specific error message",se.getMessage().contains("with the sliceUnique parameter set to something other than 'true'"));
    }
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"preferredleader","true");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s2_r1,"preferredleader","true");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"testprop");
    verifyPropertyVal(client,COLLECTION_NAME,c1_s1_r2,"prop","silly");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME,c1_s2_r2,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
    verifyPropertyNotPresent(client,COLLECTION_NAME1,c2_s1_r1,"preferredleader");
  }
  finally {
    client.shutdown();
  }
}
