{
  try (CloudSolrClient client=createCloudClient(null)){
    client.connect();
    new CollectionAdminRequest.Create().setCollectionName("testClusterStateMigration").setNumShards(1).setReplicationFactor(1).setConfigName("conf1").setStateFormat(1).process(client);
    waitForRecoveriesToFinish("testClusterStateMigration",true);
    assertEquals(1,client.getZkStateReader().getClusterState().getCollection("testClusterStateMigration").getStateFormat());
    for (int i=0; i < 10; i++) {
      SolrInputDocument doc=new SolrInputDocument();
      doc.addField("id","id_" + i);
      client.add("testClusterStateMigration",doc);
    }
    client.commit("testClusterStateMigration");
    new CollectionAdminRequest.MigrateClusterState().setCollectionName("testClusterStateMigration").process(client);
    client.getZkStateReader().forceUpdateCollection("testClusterStateMigration");
    assertEquals(2,client.getZkStateReader().getClusterState().getCollection("testClusterStateMigration").getStateFormat());
    QueryResponse response=client.query("testClusterStateMigration",new SolrQuery("*:*"));
    assertEquals(10,response.getResults().getNumFound());
  }
 }
