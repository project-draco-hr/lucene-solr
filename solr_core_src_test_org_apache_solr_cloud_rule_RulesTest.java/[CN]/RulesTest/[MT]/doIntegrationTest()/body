{
  final long minGB=(random().nextBoolean() ? 1 : 0);
  assumeTrue("doIntegrationTest needs minGB=" + minGB + " usable disk space",ImplicitSnitch.getUsableSpaceInGB(Paths.get("/")) > minGB);
  String rulesColl="rulesColl";
  CollectionAdminRequest.createCollectionWithImplicitRouter(rulesColl,"conf","shard1",2).setRule("cores:<4","node:*,replica:<2","freedisk:>" + minGB).setSnitch("class:ImplicitSnitch").process(cluster.getSolrClient());
  DocCollection rulesCollection=getCollectionState(rulesColl);
  List list=(List)rulesCollection.get("rule");
  assertEquals(3,list.size());
  assertEquals("<4",((Map)list.get(0)).get("cores"));
  assertEquals("<2",((Map)list.get(1)).get("replica"));
  assertEquals(">" + minGB,((Map)list.get(2)).get("freedisk"));
  list=(List)rulesCollection.get("snitch");
  assertEquals(1,list.size());
  assertEquals("ImplicitSnitch",((Map)list.get(0)).get("class"));
  CollectionAdminRequest.createShard(rulesColl,"shard2").process(cluster.getSolrClient());
  CollectionAdminRequest.addReplicaToShard(rulesColl,"shard2").process(cluster.getSolrClient());
}
