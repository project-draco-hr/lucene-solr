{
  Directory dir=newDirectory();
  Directory taxoDir=newDirectory();
  writer=new RandomIndexWriter(random(),dir);
  taxoWriter=new DirectoryTaxonomyWriter(taxoDir,IndexWriterConfig.OpenMode.CREATE);
  facetFields=new FacetFields(taxoWriter);
  add("dim/a/x");
  add("dim/a/y");
  add("dim/a/z");
  add("dim/b");
  add("dim/c");
  add("dim/d");
  IndexSearcher searcher=newSearcher(writer.getReader());
  writer.close();
  TaxonomyReader taxoReader=new DirectoryTaxonomyReader(taxoWriter);
  taxoWriter.close();
  FacetSearchParams fsp=new FacetSearchParams(new CountFacetRequest(new CategoryPath("dim"),10),new CountFacetRequest(new CategoryPath("dim","a"),10));
  DrillDownQuery ddq=new DrillDownQuery(fsp.indexingParams,new MatchAllDocsQuery());
  ddq.add(new CategoryPath("dim","a"));
  DrillSidewaysResult r=new DrillSideways(searcher,taxoReader).search(null,ddq,10,fsp);
  assertEquals(3,r.hits.totalHits);
  assertEquals(2,r.facetResults.size());
  assertEquals("dim: a=3 d=1 c=1 b=1",toString(r.facetResults.get(0)));
  assertEquals("a (3)\n  z (1)\n  y (1)\n  x (1)\n",FacetTestUtils.toSimpleString(r.facetResults.get(1)));
  searcher.getIndexReader().close();
  taxoReader.close();
  dir.close();
  taxoDir.close();
}
