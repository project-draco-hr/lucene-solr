{
  Fields fields=reader.fields();
  if (fields == null) {
    return Collections.emptyMap();
  }
  String currentField=null;
  TermsEnum termsEnum=null;
  DocsEnum docs=null;
  final Map<String,NumericFieldUpdates> result=otherFieldUpdates == null ? new HashMap<String,NumericFieldUpdates>() : otherFieldUpdates;
  for (  NumericUpdate update : updates) {
    Term term=update.term;
    int limit=update.docIDUpto;
    if (!term.field().equals(currentField)) {
      currentField=term.field();
      Terms terms=fields.terms(currentField);
      if (terms != null) {
        termsEnum=terms.iterator(termsEnum);
      }
 else {
        termsEnum=null;
        continue;
      }
    }
    if (termsEnum == null) {
      continue;
    }
    if (termsEnum.seekExact(term.bytes())) {
      DocsEnum docsEnum=termsEnum.docs(rld.getLiveDocs(),docs,DocsEnum.FLAG_NONE);
      NumericFieldUpdates fieldUpdates=result.get(update.field);
      if (fieldUpdates == null) {
        fieldUpdates=new NumericFieldUpdates.PackedNumericFieldUpdates(reader.maxDoc());
        result.put(update.field,fieldUpdates);
      }
      int doc;
      while ((doc=docsEnum.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
        if (doc >= limit) {
          break;
        }
        fieldUpdates.add(doc,update.value);
      }
    }
  }
  return result;
}
