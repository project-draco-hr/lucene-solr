def prepare(root, version, gpgKeyID, gpgPassword):
    print ()
    print 'Prepare release...'
    if os.path.exists(LOG):
        os.remove(LOG)
    os.chdir(root)
    print '  svn up...'
    run('svn up')
    rev = getSVNRev()
    print ('  svn rev: %s' % rev)
    log(('\nSVN rev: %s\n' % rev))
    print '  ant clean test'
    run('ant clean test')
    print '  clean checkout'
    scrubCheckout()
    open('rev.txt', mode='wb').write(rev.encode('UTF-8'))
    print '  lucene prepare-release'
    os.chdir('lucene')
    cmd = ('ant -Dversion=%s' % version)
    if (gpgKeyID is not None):
        cmd += (' -Dgpg.key=%s prepare-release' % gpgKeyID)
    else:
        cmd += ' prepare-release-no-sign'
    if (gpgPassword is not None):
        runAndSendGPGPassword(cmd, gpgPassword)
    else:
        run(cmd)
    print '  solr prepare-release'
    os.chdir('../solr')
    cmd = ('ant -Dversion=%s' % version)
    if (gpgKeyID is not None):
        cmd += (' -Dgpg.key=%s prepare-release' % gpgKeyID)
    else:
        cmd += ' prepare-release-no-sign'
    if (gpgPassword is not None):
        runAndSendGPGPassword(cmd, gpgPassword)
    else:
        run(cmd)
    print '  done!'
    print ()
    return rev
