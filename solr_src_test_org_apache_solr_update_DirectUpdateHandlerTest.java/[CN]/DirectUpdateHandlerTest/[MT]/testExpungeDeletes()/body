{
  assertU(adoc("id","1"));
  assertU(adoc("id","2"));
  assertU(commit());
  assertU(adoc("id","3"));
  assertU(adoc("id","2"));
  assertU(adoc("id","4"));
  assertU(commit());
  SolrQueryRequest sr=req("q","foo");
  SolrIndexReader r=sr.getSearcher().getReader();
  assertTrue(r.maxDoc() > r.numDocs());
  assertFalse(r.getTopReaderContext().isAtomic);
  sr.close();
  assertU(commit("expungeDeletes","true"));
  sr=req("q","foo");
  r=sr.getSearcher().getReader();
  assertEquals(r.maxDoc(),r.numDocs());
  assertEquals(4,r.maxDoc());
  assertFalse(r.getTopReaderContext().isAtomic);
  sr.close();
}
