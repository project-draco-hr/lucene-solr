{
  int docCount=0;
  int rawDocLengths[]=new int[MAX_RAW_MERGE_DOCS];
  int idx=0;
  for (  MergeState.IndexReaderAndLiveDocs reader : mergeState.readers) {
    final SegmentReader matchingSegmentReader=mergeState.matchingSegmentReaders[idx++];
    Lucene40StoredFieldsReader matchingFieldsReader=null;
    if (matchingSegmentReader != null) {
      final StoredFieldsReader fieldsReader=matchingSegmentReader.getFieldsReader();
      if (fieldsReader != null && fieldsReader instanceof Lucene40StoredFieldsReader) {
        matchingFieldsReader=(Lucene40StoredFieldsReader)fieldsReader;
      }
    }
    if (reader.liveDocs != null) {
      docCount+=copyFieldsWithDeletions(mergeState,reader,matchingFieldsReader,rawDocLengths);
    }
 else {
      docCount+=copyFieldsNoDeletions(mergeState,reader,matchingFieldsReader,rawDocLengths);
    }
  }
  finish(mergeState.fieldInfos,docCount);
  return docCount;
}
