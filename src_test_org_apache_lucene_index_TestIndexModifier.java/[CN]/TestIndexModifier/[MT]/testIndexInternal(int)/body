{
  final boolean create=true;
  String tempDir=System.getProperty("java.io.tmpdir");
  if (tempDir == null)   throw new IOException("java.io.tmpdir undefined, cannot run test");
  File indexDir=new File(tempDir,"lucenetestindex");
  Directory rd=FSDirectory.getDirectory(indexDir,null,false);
  IndexThread.id=0;
  IndexThread.idStack.clear();
  IndexModifier index=new IndexModifier(rd,new StandardAnalyzer(),create);
  IndexThread thread1=new IndexThread(index,maxWait,1);
  thread1.start();
  IndexThread thread2=new IndexThread(index,maxWait,2);
  thread2.start();
  while (thread1.isAlive() || thread2.isAlive()) {
    try {
      Thread.sleep(100);
    }
 catch (    InterruptedException e) {
      throw new RuntimeException(e);
    }
  }
  index.optimize();
  int added=thread1.added + thread2.added;
  int deleted=thread1.deleted + thread2.deleted;
  assertEquals(added - deleted,index.docCount());
  index.close();
  try {
    index.close();
    fail();
  }
 catch (  IllegalStateException e) {
  }
  rmDir(indexDir);
}
