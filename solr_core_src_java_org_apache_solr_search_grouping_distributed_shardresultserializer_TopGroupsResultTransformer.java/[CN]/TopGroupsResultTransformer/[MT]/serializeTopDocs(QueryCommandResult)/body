{
  NamedList<Object> queryResult=new NamedList<>();
  queryResult.add("matches",result.getMatches());
  queryResult.add("totalHits",result.getTopDocs().totalHits);
  if (!Float.isNaN(result.getTopDocs().getMaxScore())) {
    queryResult.add("maxScore",result.getTopDocs().getMaxScore());
  }
  List<NamedList> documents=new ArrayList<>();
  queryResult.add("documents",documents);
  final IndexSchema schema=rb.req.getSearcher().getSchema();
  SchemaField uniqueField=schema.getUniqueKeyField();
  for (  ScoreDoc scoreDoc : result.getTopDocs().scoreDocs) {
    NamedList<Object> document=new NamedList<>();
    documents.add(document);
    StoredDocument doc=retrieveDocument(uniqueField,scoreDoc.doc);
    document.add("id",uniqueField.getType().toExternal(doc.getField(uniqueField.getName())));
    if (!Float.isNaN(scoreDoc.score)) {
      document.add("score",scoreDoc.score);
    }
    if (!FieldDoc.class.isInstance(scoreDoc)) {
      continue;
    }
    FieldDoc fieldDoc=(FieldDoc)scoreDoc;
    Object[] convertedSortValues=new Object[fieldDoc.fields.length];
    for (int j=0; j < fieldDoc.fields.length; j++) {
      Object sortValue=fieldDoc.fields[j];
      Sort groupSort=rb.getGroupingSpec().getGroupSort();
      SchemaField field=groupSort.getSort()[j].getField() != null ? schema.getFieldOrNull(groupSort.getSort()[j].getField()) : null;
      if (field != null) {
        FieldType fieldType=field.getType();
        if (sortValue != null) {
          sortValue=fieldType.marshalSortValue(sortValue);
        }
      }
      convertedSortValues[j]=sortValue;
    }
    document.add("sortValues",convertedSortValues);
  }
  return queryResult;
}
