{
  dir=newDirectory();
  numDocs=atLeast(150);
  final int numTerms=TestUtil.nextInt(random(),1,numDocs / 5);
  Set<String> randomTerms=new HashSet<>();
  while (randomTerms.size() < numTerms) {
    randomTerms.add(TestUtil.randomSimpleString(random()));
  }
  terms=new ArrayList<>(randomTerms);
  final long seed=random().nextLong();
  final IndexWriterConfig iwc=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(new Random(seed)));
  iwc.setMergeScheduler(new SerialMergeScheduler());
  iwc.setMergePolicy(TestSortingMergePolicy.newSortingMergePolicy(sort));
  iw=new RandomIndexWriter(new Random(seed),dir,iwc);
  iw.setDoRandomForceMerge(false);
  for (int i=0; i < numDocs; ++i) {
    final Document doc=randomDocument();
    iw.addDocument(doc);
    if (i == numDocs / 2 || (i != numDocs - 1 && random().nextInt(8) == 0)) {
      iw.commit();
    }
    if (random().nextInt(15) == 0) {
      final String term=RandomPicks.randomFrom(random(),terms);
      iw.deleteDocuments(new Term("s",term));
    }
  }
  if (random().nextBoolean()) {
    iw.forceMerge(5);
  }
  reader=iw.getReader();
}
