{
  UpdateRequestProcessor processor=null;
  UpdateRequestProcessor last=null;
  final String distribPhase=req.getParams().get(DistributingUpdateProcessorFactory.DISTRIB_UPDATE_PARAM);
  final boolean skipToDistrib=distribPhase != null;
  boolean afterDistrib=true;
  for (int i=chain.size() - 1; i >= 0; i--) {
    UpdateRequestProcessorFactory factory=chain.get(i);
    if (skipToDistrib) {
      if (afterDistrib) {
        if (factory instanceof DistributingUpdateProcessorFactory) {
          afterDistrib=false;
        }
      }
 else       if (!(factory instanceof UpdateRequestProcessorFactory.RunAlways)) {
        continue;
      }
    }
    processor=factory.getInstance(req,rsp,last);
    last=processor == null ? last : processor;
  }
  return last;
}
