{
  if (cmd.prepareCommit) {
    prepareCommit(cmd);
    return;
  }
  if (cmd.optimize) {
    optimizeCommands.increment();
  }
 else {
    commitCommands.increment();
    if (cmd.expungeDeletes)     expungeDeleteCommands.increment();
  }
  Future[] waitSearcher=null;
  if (cmd.waitSearcher) {
    waitSearcher=new Future[1];
  }
  boolean error=true;
  try {
    if (!cmd.softCommit) {
      solrCoreState.getCommitLock().lock();
    }
    log.info("start " + cmd);
    if (cmd.openSearcher) {
      softCommitTracker.cancelPendingCommit();
    }
    if (!cmd.softCommit && (cmd.openSearcher || !commitTracker.getOpenSearcher())) {
      commitTracker.cancelPendingCommit();
    }
    RefCounted<IndexWriter> iw=solrCoreState.getIndexWriter(core);
    try {
      IndexWriter writer=iw.get();
      if (cmd.optimize) {
        if (cmd.maxOptimizeSegments == 1) {
          log.warn("Starting optimize... Reading and rewriting the entire index! Use with care.");
        }
 else {
          log.warn("Starting optimize... Reading and rewriting a potentially large percent of the entire index, reducing to " + cmd.maxOptimizeSegments + " segments");
        }
        writer.forceMerge(cmd.maxOptimizeSegments);
      }
 else       if (cmd.expungeDeletes) {
        log.warn("Starting expungeDeletes... Reading and rewriting segments with enough deletes, potentially the entire index");
        writer.forceMergeDeletes();
      }
      if (!cmd.softCommit) {
synchronized (solrCoreState.getUpdateLock()) {
          if (ulog != null)           ulog.preCommit(cmd);
        }
        if (writer.hasUncommittedChanges()) {
          SolrIndexWriter.setCommitData(writer);
          writer.commit();
        }
 else {
          log.info("No uncommitted changes. Skipping IW.commit.");
        }
        numDocsPending.reset();
        callPostCommitCallbacks();
      }
    }
  finally {
      iw.decref();
    }
    if (cmd.optimize) {
      callPostOptimizeCallbacks();
    }
    if (cmd.softCommit) {
synchronized (solrCoreState.getUpdateLock()) {
        if (ulog != null)         ulog.preSoftCommit(cmd);
        core.getSearcher(true,false,waitSearcher,true);
        if (ulog != null)         ulog.postSoftCommit(cmd);
      }
      callPostSoftCommitCallbacks();
    }
 else {
synchronized (solrCoreState.getUpdateLock()) {
        if (ulog != null)         ulog.preSoftCommit(cmd);
        if (cmd.openSearcher) {
          core.getSearcher(true,false,waitSearcher);
        }
 else {
          RefCounted<SolrIndexSearcher> searchHolder=core.openNewSearcher(true,true);
          searchHolder.decref();
        }
        if (ulog != null)         ulog.postSoftCommit(cmd);
      }
      if (ulog != null)       ulog.postCommit(cmd);
    }
    if (cmd.softCommit) {
      softCommitTracker.didCommit();
    }
 else {
      commitTracker.didCommit();
    }
    log.info("end_commit_flush");
    error=false;
  }
  finally {
    if (!cmd.softCommit) {
      solrCoreState.getCommitLock().unlock();
    }
    addCommands.reset();
    deleteByIdCommands.reset();
    deleteByQueryCommands.reset();
    if (error)     numErrors.increment();
  }
  if (waitSearcher != null && waitSearcher[0] != null) {
    try {
      waitSearcher[0].get();
    }
 catch (    InterruptedException|ExecutionException e) {
      SolrException.log(log,e);
    }
  }
}
