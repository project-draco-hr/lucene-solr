{
  commitLock.lock();
  try {
    if (!commitOnClose) {
      if (writer != null) {
        writer.rollback();
      }
      if (ulog != null)       ulog.close(false);
      return;
    }
    VersionInfo vinfo=ulog == null ? null : ulog.getVersionInfo();
    if (vinfo != null) {
      vinfo.blockUpdates();
    }
    try {
      boolean succeeded=false;
      try {
        if (writer != null) {
          writer.close();
        }
        succeeded=true;
      }
  finally {
        if (ulog != null)         ulog.close(succeeded);
      }
    }
  finally {
      if (vinfo != null) {
        vinfo.unblockUpdates();
      }
    }
  }
  finally {
    commitLock.unlock();
  }
}
