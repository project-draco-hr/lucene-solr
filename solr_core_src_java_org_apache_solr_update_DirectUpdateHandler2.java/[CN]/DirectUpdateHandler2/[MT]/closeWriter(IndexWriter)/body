{
  commitLock.lock();
  try {
    if (!commitOnClose) {
      if (writer != null) {
        writer.rollback();
      }
      if (ulog != null)       ulog.close(false);
      return;
    }
    if (writer != null) {
      writer.close();
    }
    if (ulog != null)     ulog.close(true);
  }
  finally {
    commitLock.unlock();
  }
}
