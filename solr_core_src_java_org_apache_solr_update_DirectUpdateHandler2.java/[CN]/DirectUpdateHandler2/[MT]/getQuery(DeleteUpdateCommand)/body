{
  Query q;
  try {
    QParser parser=QParser.getParser(cmd.getQuery(),"lucene",cmd.req);
    q=parser.getQuery();
    q=QueryUtils.makeQueryable(q);
    if (ulog != null && cmd.getVersion() != 0 && cmd.getVersion() != -Long.MAX_VALUE) {
      BooleanQuery bq=new BooleanQuery();
      bq.add(q,Occur.MUST);
      SchemaField sf=ulog.getVersionInfo().getVersionField();
      ValueSource vs=sf.getType().getValueSource(sf,null);
      ValueSourceRangeFilter filt=new ValueSourceRangeFilter(vs,null,Long.toString(Math.abs(cmd.getVersion())),true,true);
      FunctionRangeQuery range=new FunctionRangeQuery(filt);
      bq.add(range,Occur.MUST);
      q=bq;
    }
    return q;
  }
 catch (  SyntaxError e) {
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,e);
  }
}
