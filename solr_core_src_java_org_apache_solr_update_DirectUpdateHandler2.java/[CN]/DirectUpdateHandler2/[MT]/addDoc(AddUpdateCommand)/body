{
  IndexWriter writer=solrCoreState.getIndexWriter(core);
  addCommands.incrementAndGet();
  addCommandsCumulative.incrementAndGet();
  int rc=-1;
  if (idField == null) {
    cmd.overwrite=false;
  }
  try {
    if (cmd.overwrite) {
      Term updateTerm;
      Term idTerm=new Term(idField.getName(),cmd.getIndexedId());
      boolean del=false;
      if (cmd.updateTerm == null) {
        updateTerm=idTerm;
      }
 else {
        del=true;
        updateTerm=cmd.updateTerm;
      }
      Document luceneDocument=cmd.getLuceneDocument();
      writer.updateDocument(updateTerm,luceneDocument);
      if (del) {
        BooleanQuery bq=new BooleanQuery();
        bq.add(new BooleanClause(new TermQuery(updateTerm),Occur.MUST_NOT));
        bq.add(new BooleanClause(new TermQuery(idTerm),Occur.MUST));
        writer.deleteDocuments(bq);
      }
    }
 else {
      writer.addDocument(cmd.getLuceneDocument());
    }
    if (ulog != null)     ulog.add(cmd);
    if ((cmd.getFlags() & UpdateCommand.IGNORE_AUTOCOMMIT) == 0) {
      commitTracker.addedDocument(-1);
      softCommitTracker.addedDocument(cmd.commitWithin);
    }
    rc=1;
  }
  finally {
    if (rc != 1) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
 else {
      numDocsPending.incrementAndGet();
    }
  }
  return rc;
}
