{
  int rc=-1;
  addCommands.incrementAndGet();
  addCommandsCumulative.incrementAndGet();
  if (idField == null) {
    cmd.overwrite=false;
  }
  try {
    if (cmd.overwrite) {
      List<UpdateLog.DBQ> deletesAfter=null;
      if (ulog != null && cmd.version > 0) {
        deletesAfter=ulog.getDBQNewer(cmd.version);
      }
      if (deletesAfter != null) {
        addAndDelete(cmd,deletesAfter);
      }
 else {
        doNormalUpdate(cmd);
      }
    }
 else {
      allowDuplicateUpdate(cmd);
    }
    if ((cmd.getFlags() & UpdateCommand.IGNORE_AUTOCOMMIT) == 0) {
      if (commitWithinSoftCommit) {
        commitTracker.addedDocument(-1);
        softCommitTracker.addedDocument(cmd.commitWithin);
      }
 else {
        softCommitTracker.addedDocument(-1);
        commitTracker.addedDocument(cmd.commitWithin);
      }
    }
    rc=1;
  }
  finally {
    if (rc != 1) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
 else {
      numDocsPending.incrementAndGet();
    }
  }
  return rc;
}
