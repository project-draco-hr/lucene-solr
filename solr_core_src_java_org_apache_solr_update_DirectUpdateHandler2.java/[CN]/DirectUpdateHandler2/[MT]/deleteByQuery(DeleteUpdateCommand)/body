{
  deleteByQueryCommands.incrementAndGet();
  deleteByQueryCommandsCumulative.incrementAndGet();
  boolean madeIt=false;
  try {
    Query q=getQuery(cmd);
    boolean delAll=MatchAllDocsQuery.class == q.getClass();
    if (delAll && cmd.getVersion() == -Long.MAX_VALUE) {
synchronized (solrCoreState) {
        deleteAll();
        ulog.deleteAll();
        return;
      }
    }
synchronized (solrCoreState) {
      if (delAll) {
        deleteAll();
      }
 else {
        RefCounted<IndexWriter> iw=solrCoreState.getIndexWriter(core);
        try {
          iw.get().deleteDocuments(q);
        }
  finally {
          iw.decref();
        }
      }
      if (ulog != null)       ulog.deleteByQuery(cmd);
    }
    madeIt=true;
    updateDeleteTrackers(cmd);
  }
  finally {
    if (!madeIt) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
  }
}
