{
  addStatusMessage("Delta Dump started");
  VariableResolverImpl resolver=getVariableResolver(dataImporter);
  if (document.deleteQuery != null) {
    writer.deleteByQuery(document.deleteQuery);
  }
  addStatusMessage("Identifying Delta");
  LOG.info("Starting delta collection.");
  Set<Map<String,Object>> deletedKeys=new HashSet<Map<String,Object>>();
  Set<Map<String,Object>> allPks=collectDelta(root,null,resolver,dataImporter,deletedKeys);
  if (stop.get())   return;
  addStatusMessage("Deltas Obtained");
  addStatusMessage("Building documents");
  if (!deletedKeys.isEmpty()) {
    deleteAll(deletedKeys);
    importStatistics.deletedDocCount.addAndGet(deletedKeys.size());
    allPks.removeAll(deletedKeys);
  }
  deletedKeys=null;
  statusMessages.put("Total Changed Documents",allPks.size());
  VariableResolverImpl vri=getVariableResolver(dataImporter);
  Iterator<Map<String,Object>> pkIter=allPks.iterator();
  while (pkIter.hasNext()) {
    Map<String,Object> map=pkIter.next();
    vri.addNamespace(DataConfig.IMPORTER_NS + ".delta",map);
    buildDocument(vri,null,map,root,true,null);
    pkIter.remove();
  }
  if (!stop.get()) {
    writer.persistIndexStartTime(dataImporter.getIndexStartTime());
    LOG.info("Delta Import completed successfully");
  }
}
