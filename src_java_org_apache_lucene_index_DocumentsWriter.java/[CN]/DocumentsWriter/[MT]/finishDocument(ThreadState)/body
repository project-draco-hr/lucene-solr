{
  if (nextWriteDocID == state.docID) {
    state.isIdle=true;
    nextWriteDocID++;
    state.writeDocument();
    if (numWaiting > 0) {
      while (true) {
        int upto=0;
        for (int i=0; i < numWaiting; i++) {
          ThreadState s=waitingThreadStates[i];
          if (s.docID == nextWriteDocID) {
            s.isIdle=true;
            nextWriteDocID++;
            s.writeDocument();
          }
 else           waitingThreadStates[upto++]=waitingThreadStates[i];
        }
        if (upto == numWaiting)         break;
        numWaiting=upto;
      }
    }
    notifyAll();
  }
 else {
    if (numWaiting == waitingThreadStates.length) {
      ThreadState[] newWaiting=new ThreadState[2 * waitingThreadStates.length];
      System.arraycopy(waitingThreadStates,0,newWaiting,0,numWaiting);
      waitingThreadStates=newWaiting;
    }
    waitingThreadStates[numWaiting++]=state;
  }
}
