{
  this.directory=directory;
  this.writer=writer;
  this.similarity=writer.getSimilarity();
  flushedDocCount=writer.maxDoc();
  final TermsHashConsumer termVectorsWriter=new TermVectorsTermsWriter(this);
  final TermsHashConsumer freqProxWriter=new FreqProxTermsWriter();
  final InvertedDocConsumer termsHash=new TermsHash(this,true,freqProxWriter,new TermsHash(this,false,termVectorsWriter,null));
  final NormsWriter normsWriter=new NormsWriter();
  final DocInverter docInverter=new DocInverter(termsHash,normsWriter);
  final StoredFieldsWriter fieldsWriter=new StoredFieldsWriter(this);
  final DocFieldConsumers docFieldConsumers=new DocFieldConsumers(docInverter,fieldsWriter);
  consumer=new DocFieldProcessor(this,docFieldConsumers);
}
