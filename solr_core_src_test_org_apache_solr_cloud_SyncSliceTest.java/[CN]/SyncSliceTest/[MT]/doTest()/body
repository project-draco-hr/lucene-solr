{
  handle.clear();
  handle.put("QTime",SKIPVAL);
  handle.put("timestamp",SKIPVAL);
  waitForThingsToLevelOut();
  del("*:*");
  List<String> skipServers=new ArrayList<String>();
  indexDoc(skipServers,id,0,i1,50,tlong,50,t1,"to come to the aid of their country.");
  indexDoc(skipServers,id,1,i1,50,tlong,50,t1,"old haven was blue.");
  skipServers.add(shardToJetty.get("shard1").get(1).url + "/");
  indexDoc(skipServers,id,2,i1,50,tlong,50,t1,"but the song was fancy.");
  skipServers.add(shardToJetty.get("shard1").get(2).url + "/");
  indexDoc(skipServers,id,3,i1,50,tlong,50,t1,"under the moon and over the lake");
  commit();
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set("action",CollectionAction.SYNCSHARD.toString());
  params.set("collection","collection1");
  params.set("shard","shard1");
  SolrRequest request=new QueryRequest(params);
  request.setPath("/admin/collections");
  String baseUrl=((HttpSolrServer)shardToJetty.get("shard1").get(2).client.solrClient).getBaseURL();
  baseUrl=baseUrl.substring(0,baseUrl.length() - "collection1".length());
  HttpSolrServer baseServer=new HttpSolrServer(baseUrl);
  baseServer.request(request);
  waitForThingsToLevelOut();
  checkShardConsistency(false,true);
  long cloudClientDocs=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(4,cloudClientDocs);
  skipServers=new ArrayList<String>();
  skipServers.add(shardToJetty.get("shard1").get(random().nextInt(shardCount)).url + "/");
  indexDoc(skipServers,id,4,i1,50,tlong,50,t1,"to come to the aid of their country.");
  CloudJettyRunner leaderJetty=shardToLeaderJetty.get("shard1");
  Set<CloudJettyRunner> jetties=new HashSet<CloudJettyRunner>();
  for (int i=0; i < shardCount; i++) {
    jetties.add(shardToJetty.get("shard1").get(i));
  }
  jetties.remove(leaderJetty);
  chaosMonkey.killJetty(leaderJetty);
  CloudJettyRunner upJetty=jetties.iterator().next();
  assertNotNull(upJetty.jetty.getDispatchFilter());
  assertNotNull(upJetty.jetty.getDispatchFilter());
  assertNotNull(upJetty.jetty.getDispatchFilter().getFilter());
  int tries=0;
  while (((SolrDispatchFilter)upJetty.jetty.getDispatchFilter().getFilter()).getCores().getZkController().getZkStateReader().getCloudState().liveNodesContain(leaderJetty.info.get(ZkStateReader.NODE_NAME_PROP))) {
    if (tries++ == 120) {
      fail("Shard still reported as live in zk");
    }
    Thread.sleep(1000);
  }
  waitForThingsToLevelOut();
  checkShardConsistency(false,true);
  cloudClientDocs=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(5,cloudClientDocs);
}
