{
  for (int i=0; i < 45; i++) {
    Thread.sleep(3000);
    ZkStateReader zkStateReader=cloudClient.getZkStateReader();
    zkStateReader.updateClusterState(true);
    ClusterState clusterState=zkStateReader.getClusterState();
    DocCollection collection1=clusterState.getCollection("collection1");
    Slice slice=collection1.getSlice("shard1");
    Collection<Replica> replicas=slice.getReplicas();
    boolean allActive=true;
    for (    Replica replica : replicas) {
      if (!clusterState.liveNodesContain(replica.getNodeName()) || !replica.get(ZkStateReader.STATE_PROP).equals(ZkStateReader.ACTIVE)) {
        allActive=false;
        break;
      }
    }
    if (allActive) {
      return;
    }
  }
  printLayout();
  fail("timeout waiting to see recovered node");
}
