{
  final Path dataDirPath=new Path(dataDir);
  final Configuration conf=getConf();
  FileSystem fileSystem=null;
  try {
    fileSystem=tmpFsCache.get(dataDir,new Callable<FileSystem>(){
      @Override public FileSystem call() throws IOException {
        return FileSystem.get(dataDirPath.toUri(),conf);
      }
    }
);
  }
 catch (  ExecutionException e) {
    throw new RuntimeException(e);
  }
  boolean pathExists=false;
  try {
    pathExists=fileSystem.exists(dataDirPath);
  }
 catch (  IOException e) {
    LOG.error("Error checking if hdfs path " + dataDir + " exists",e);
  }
  if (!pathExists) {
    LOG.warn("{} does not point to a valid data directory; skipping clean-up of old index directories.",dataDir);
    return;
  }
  final Path currentIndexDirPath=new Path(currentIndexDir);
  final FileSystem fs=fileSystem;
  FileStatus[] oldIndexDirs=null;
  try {
    oldIndexDirs=fileSystem.listStatus(dataDirPath,new PathFilter(){
      @Override public boolean accept(      Path path){
        boolean accept=false;
        String pathName=path.getName();
        try {
          accept=fs.isDirectory(path) && !path.equals(currentIndexDirPath) && (pathName.equals("index") || pathName.matches(INDEX_W_TIMESTAMP_REGEX));
        }
 catch (        IOException e) {
          LOG.error("Error checking if path {} is an old index directory, caused by: {}",path,e);
        }
        return accept;
      }
    }
);
  }
 catch (  IOException ioExc) {
    LOG.error("Error checking for old index directories to clean-up.",ioExc);
  }
  if (oldIndexDirs == null || oldIndexDirs.length == 0)   return;
  Set<String> livePaths=getLivePaths();
  for (  FileStatus oldDir : oldIndexDirs) {
    Path oldDirPath=oldDir.getPath();
    if (livePaths.contains(oldDirPath.toString())) {
      LOG.warn("Cannot delete directory {} because it is still being referenced in the cache.",oldDirPath);
    }
 else {
      try {
        if (fileSystem.delete(oldDirPath,true)) {
          LOG.info("Deleted old index directory {}",oldDirPath);
        }
 else {
          LOG.warn("Failed to delete old index directory {}",oldDirPath);
        }
      }
 catch (      IOException e) {
        LOG.error("Failed to delete old index directory {} due to: {}",oldDirPath,e);
      }
    }
  }
}
