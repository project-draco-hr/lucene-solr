{
  Directory dir=newDirectory();
  RandomIndexWriter writer=new RandomIndexWriter(random(),dir);
  Document doc=new Document();
  doc.add(new DoubleField("latitude",40.759011,Field.Store.NO));
  doc.add(new DoubleField("longitude",-73.9844722,Field.Store.NO));
  writer.addDocument(doc);
  doc=new Document();
  doc.add(new DoubleField("latitude",40.718266,Field.Store.NO));
  doc.add(new DoubleField("longitude",-74.007819,Field.Store.NO));
  writer.addDocument(doc);
  doc=new Document();
  doc.add(new DoubleField("latitude",40.7051157,Field.Store.NO));
  doc.add(new DoubleField("longitude",-74.0088305,Field.Store.NO));
  writer.addDocument(doc);
  Expression distance=JavascriptCompiler.compile("haversin(40.7143528,-74.0059731,latitude,longitude)");
  SimpleBindings bindings=new SimpleBindings();
  bindings.add(new SortField("latitude",SortField.Type.DOUBLE));
  bindings.add(new SortField("longitude",SortField.Type.DOUBLE));
  FacetsCollector fc=new FacetsCollector();
  IndexReader r=writer.getReader();
  IndexSearcher s=newSearcher(r);
  s.search(new MatchAllDocsQuery(),fc);
  Facets facets=new DoubleRangeFacetCounts("field",distance.getValueSource(bindings),fc,new DoubleRange("< 1 km",0.0,true,1.0,false),new DoubleRange("< 2 km",0.0,true,2.0,false),new DoubleRange("< 5 km",0.0,true,5.0,false),new DoubleRange("< 10 km",0.0,true,10.0,false),new DoubleRange("< 20 km",0.0,true,20.0,false),new DoubleRange("< 50 km",0.0,true,50.0,false));
  assertEquals("value=3 childCount=6\n  < 1 km (1)\n  < 2 km (2)\n  < 5 km (2)\n  < 10 km (3)\n  < 20 km (3)\n  < 50 km (3)\n",facets.getTopChildren(10,"field").toString());
  IOUtils.close(r,writer,dir);
}
