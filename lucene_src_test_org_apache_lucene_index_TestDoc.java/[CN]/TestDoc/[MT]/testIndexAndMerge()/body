{
  StringWriter sw=new StringWriter();
  PrintWriter out=new PrintWriter(sw,true);
  Directory directory=newFSDirectory(indexDir,null,false);
  IndexWriter writer=new IndexWriter(directory,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setMaxBufferedDocs(-1).setMergePolicy(newLogMergePolicy(10)));
  SegmentInfo si1=indexDoc(writer,"test.txt");
  printSegment(out,si1);
  SegmentInfo si2=indexDoc(writer,"test2.txt");
  printSegment(out,si2);
  writer.close();
  SegmentInfo siMerge=merge(directory,si1,si2,"merge",false);
  printSegment(out,siMerge);
  SegmentInfo siMerge2=merge(directory,si1,si2,"merge2",false);
  printSegment(out,siMerge2);
  SegmentInfo siMerge3=merge(directory,siMerge,siMerge2,"merge3",false);
  printSegment(out,siMerge3);
  directory.close();
  out.close();
  sw.close();
  String multiFileOutput=sw.getBuffer().toString();
  sw=new StringWriter();
  out=new PrintWriter(sw,true);
  directory=newFSDirectory(indexDir,null,false);
  writer=new IndexWriter(directory,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setMaxBufferedDocs(-1).setMergePolicy(newLogMergePolicy(10)));
  si1=indexDoc(writer,"test.txt");
  printSegment(out,si1);
  si2=indexDoc(writer,"test2.txt");
  printSegment(out,si2);
  writer.close();
  siMerge=merge(directory,si1,si2,"merge",true);
  printSegment(out,siMerge);
  siMerge2=merge(directory,si1,si2,"merge2",true);
  printSegment(out,siMerge2);
  siMerge3=merge(directory,siMerge,siMerge2,"merge3",true);
  printSegment(out,siMerge3);
  directory.close();
  out.close();
  sw.close();
  String singleFileOutput=sw.getBuffer().toString();
  assertEquals(multiFileOutput,singleFileOutput);
}
