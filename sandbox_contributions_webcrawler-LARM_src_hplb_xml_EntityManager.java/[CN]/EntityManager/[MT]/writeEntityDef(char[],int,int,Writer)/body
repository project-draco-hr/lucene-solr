{
  Integer ch;
  if (buf[off] == '#') {
    off++;
    len--;
    if (buf[off] == 'x' || buf[off] == 'X') {
      ch=Integer.valueOf(new String(buf,off + 1,len - 1),16);
    }
 else {
      ch=Integer.valueOf(new String(buf,off,len));
    }
    out.write(ch.intValue());
  }
 else {
    String ent=new String(buf,off,len);
    String val=(String)entities.get(ent);
    if (val != null) {
      out.write(val);
    }
 else {
      out.write("&" + ent + ";");
    }
  }
}
