{
  try {
    int numberToKeep=params.getInt(NUMBER_BACKUPS_TO_KEEP_REQUEST_PARAM,0);
    if (numberToKeep > 0 && numberBackupsToKeep > 0) {
      throw new SolrException(ErrorCode.BAD_REQUEST,"Cannot use " + NUMBER_BACKUPS_TO_KEEP_REQUEST_PARAM + " if "+ NUMBER_BACKUPS_TO_KEEP_INIT_PARAM+ " was specified in the configuration.");
    }
    numberToKeep=Math.max(numberToKeep,numberBackupsToKeep);
    if (numberToKeep < 1) {
      numberToKeep=Integer.MAX_VALUE;
    }
    IndexDeletionPolicyWrapper delPolicy=core.getDeletionPolicy();
    IndexCommit indexCommit=delPolicy.getLatestCommit();
    if (indexCommit == null) {
      indexCommit=req.getSearcher().getIndexReader().getIndexCommit();
    }
    SnapShooter snapShooter=new SnapShooter(core,params.get("location"),params.get(NAME));
    snapShooter.validateCreateSnapshot();
    snapShooter.createSnapAsync(indexCommit,numberToKeep,this);
  }
 catch (  Exception e) {
    LOG.warn("Exception during creating a snapshot",e);
    rsp.add("exception",e);
  }
}
