{
  FacetsAggregator aggregator=getAggregator();
  for (  CategoryListParams clp : getCategoryLists()) {
    for (    MatchingDocs md : matchingDocs) {
      aggregator.aggregate(md,clp,facetArrays);
    }
  }
  ParallelTaxonomyArrays arrays=taxonomyReader.getParallelTaxonomyArrays();
  final int[] children=arrays.children();
  final int[] siblings=arrays.siblings();
  List<FacetResult> res=new ArrayList<FacetResult>();
  for (  FacetRequest fr : searchParams.facetRequests) {
    int rootOrd=taxonomyReader.getOrdinal(fr.categoryPath);
    if (rootOrd == TaxonomyReader.INVALID_ORDINAL) {
      continue;
    }
    CategoryListParams clp=searchParams.indexingParams.getCategoryListParams(fr.categoryPath);
    OrdinalPolicy ordinalPolicy=clp.getOrdinalPolicy(fr.categoryPath.components[0]);
    if (ordinalPolicy == OrdinalPolicy.NO_PARENTS) {
      aggregator.rollupValues(rootOrd,children,siblings,facetArrays);
    }
    FacetResultsHandler frh=createFacetResultsHandler(fr);
    res.add(frh.compute());
  }
  return res;
}
