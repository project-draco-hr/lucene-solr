{
  int docCount=random().nextInt(1313) + 1;
  int cnt=random().nextInt(4) + 1;
  for (int i=0; i < cnt; i++) {
    createCollection(ACOLLECTION + i,2,2,9);
  }
  for (int i=0; i < cnt; i++) {
    waitForRecoveriesToFinish(ACOLLECTION + i,false);
  }
  List<CloudSolrClient> cloudClients=new ArrayList<>();
  List<StoppableIndexingThread> threads=new ArrayList<>();
  for (int i=0; i < cnt; i++) {
    CloudSolrClient client=getCloudSolrClient(zkServer.getZkAddress());
    client.setDefaultCollection(ACOLLECTION + i);
    cloudClients.add(client);
    StoppableIndexingThread indexThread=new StoppableIndexingThread(null,client,"1",true,docCount,1,true);
    threads.add(indexThread);
    indexThread.start();
  }
  int addCnt=0;
  for (  StoppableIndexingThread thread : threads) {
    thread.join();
    addCnt+=thread.getNumAdds() - thread.getNumDeletes();
  }
  long collectionsCount=0;
  for (  CloudSolrClient client : cloudClients) {
    client.commit();
    collectionsCount+=client.query(new SolrQuery("*:*")).getResults().getNumFound();
  }
  IOUtils.close(cloudClients);
  assertEquals(addCnt,collectionsCount);
  BlockCache lastBlockCache=null;
  for (  JettySolrRunner jetty : jettys) {
    CoreContainer cores=jetty.getCoreContainer();
    Collection<SolrCore> solrCores=cores.getCores();
    for (    SolrCore core : solrCores) {
      if (core.getCoreDescriptor().getCloudDescriptor().getCollectionName().startsWith(ACOLLECTION)) {
        assertTrue(core.getDirectoryFactory() instanceof HdfsDirectoryFactory);
        Directory dir=core.getDirectoryFactory().get(core.getDataDir(),null,null);
        try {
          long dataDirSize=core.getDirectoryFactory().size(dir);
          FileSystem fileSystem=null;
          fileSystem=FileSystem.newInstance(new Path(core.getDataDir()).toUri(),new Configuration());
          long size=fileSystem.getContentSummary(new Path(core.getDataDir())).getLength();
          assertEquals(size,dataDirSize);
        }
  finally {
          core.getDirectoryFactory().release(dir);
        }
        RefCounted<IndexWriter> iwRef=core.getUpdateHandler().getSolrCoreState().getIndexWriter(core);
        try {
          IndexWriter iw=iwRef.get();
          NRTCachingDirectory directory=(NRTCachingDirectory)iw.getDirectory();
          BlockDirectory blockDirectory=(BlockDirectory)directory.getDelegate();
          assertTrue(blockDirectory.isBlockCacheReadEnabled());
          assertFalse(blockDirectory.isBlockCacheWriteEnabled());
          Cache cache=blockDirectory.getCache();
          assertTrue(cache instanceof BlockDirectoryCache);
          BlockCache blockCache=((BlockDirectoryCache)cache).getBlockCache();
          if (lastBlockCache != null) {
            if (Boolean.getBoolean(SOLR_HDFS_BLOCKCACHE_GLOBAL)) {
              assertEquals(lastBlockCache,blockCache);
            }
 else {
              assertNotSame(lastBlockCache,blockCache);
            }
          }
          lastBlockCache=blockCache;
        }
  finally {
          iwRef.decref();
        }
      }
    }
  }
}
