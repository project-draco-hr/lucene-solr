{
  log.debug("copyField source='" + source + "' dest='"+ dest+ "' maxChars="+ maxChars);
  DynamicField destDynamicField=null;
  SchemaField destSchemaField=fields.get(dest);
  SchemaField sourceSchemaField=fields.get(source);
  DynamicField sourceDynamicBase=null;
  DynamicField destDynamicBase=null;
  boolean sourceIsDynamicFieldReference=false;
  if (null == destSchemaField || null == sourceSchemaField) {
    for (    DynamicField dynamicField : dynamicFields) {
      if (null == sourceSchemaField && !sourceIsDynamicFieldReference) {
        if (dynamicField.matches(source)) {
          sourceIsDynamicFieldReference=true;
          if (!source.equals(dynamicField.getRegex())) {
            sourceDynamicBase=dynamicField;
          }
        }
      }
      if (null == destSchemaField) {
        if (dest.equals(dynamicField.getRegex())) {
          destDynamicField=dynamicField;
          destSchemaField=dynamicField.prototype;
        }
 else         if (dynamicField.matches(dest)) {
          destSchemaField=dynamicField.makeSchemaField(dest);
          destDynamicField=new DynamicField(destSchemaField);
          destDynamicBase=dynamicField;
        }
      }
      if (null != destSchemaField && (null != sourceSchemaField || sourceIsDynamicFieldReference))       break;
    }
  }
  if (null == sourceSchemaField && !sourceIsDynamicFieldReference) {
    String msg="copyField source :'" + source + "' is not an explicit field and doesn't match a dynamicField.";
    throw new SolrException(ErrorCode.SERVER_ERROR,msg);
  }
  if (null == destSchemaField) {
    String msg="copyField dest :'" + dest + "' is not an explicit field and doesn't match a dynamicField.";
    throw new SolrException(ErrorCode.SERVER_ERROR,msg);
  }
  if (sourceIsDynamicFieldReference) {
    if (null != destDynamicField) {
      registerDynamicCopyField(new DynamicCopy(source,destDynamicField,maxChars,sourceDynamicBase,destDynamicBase));
      incrementCopyFieldTargetCount(destSchemaField);
    }
 else {
      destDynamicField=new DynamicField(destSchemaField);
      registerDynamicCopyField(new DynamicCopy(source,destDynamicField,maxChars,sourceDynamicBase,null));
      incrementCopyFieldTargetCount(destSchemaField);
    }
  }
 else {
    if (null != destDynamicField) {
      if (destDynamicField.pattern instanceof DynamicReplacement.DynamicPattern.NameEquals) {
        registerDynamicCopyField(new DynamicCopy(source,destDynamicField,maxChars,sourceDynamicBase,destDynamicBase));
        incrementCopyFieldTargetCount(destSchemaField);
      }
 else {
        String msg="copyField only supports a dynamic destination with an asterisk " + "if the source is also dynamic with an asterisk";
        throw new SolrException(ErrorCode.SERVER_ERROR,msg);
      }
    }
 else {
      List<CopyField> copyFieldList=copyFieldsMap.get(source);
      if (copyFieldList == null) {
        copyFieldList=new ArrayList<CopyField>();
        copyFieldsMap.put(source,copyFieldList);
      }
      copyFieldList.add(new CopyField(sourceSchemaField,destSchemaField,maxChars));
      incrementCopyFieldTargetCount(destSchemaField);
    }
  }
}
