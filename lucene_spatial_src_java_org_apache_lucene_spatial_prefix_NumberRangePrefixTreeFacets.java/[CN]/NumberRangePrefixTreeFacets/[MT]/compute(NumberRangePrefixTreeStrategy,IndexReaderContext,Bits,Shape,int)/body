{
  Facets facets=new Facets(facetLevel);
  final List<LeafReaderContext> leaves=context.leaves();
  for (  final LeafReaderContext leafCtx : leaves) {
    Bits leafAcceptDocs;
    if (acceptDocs == null) {
      leafAcceptDocs=leafCtx.reader().getLiveDocs();
    }
 else     if (leaves.size() == 1) {
      leafAcceptDocs=acceptDocs;
    }
 else {
      leafAcceptDocs=new Bits(){
        final int docBase=leafCtx.docBase;
        @Override public boolean get(        int index){
          return acceptDocs.get(docBase + index);
        }
        @Override public int length(){
          return leafCtx.reader().maxDoc();
        }
      }
;
    }
    facets=compute(strategy,leafCtx,leafAcceptDocs,queryShape,facets);
  }
  return facets;
}
