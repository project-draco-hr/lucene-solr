{
  Directory dir=newDirectory();
  populateDocs(random(),dir,true);
  verifyPayloadExists(dir,"p",new BytesRef("p1"),NUM_DOCS);
  verifyPayloadExists(dir,"p",new BytesRef("p2"),NUM_DOCS);
  Map<Directory,ReaderPayloadProcessor> processors=new HashMap<Directory,ReaderPayloadProcessor>();
  processors.put(dir,new PerTermPayloadProcessor());
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random(),MockTokenizer.WHITESPACE,false)));
  writer.setPayloadProcessorProvider(new PerDirPayloadProcessor(processors));
  writer.forceMerge(1);
  writer.close();
  verifyPayloadExists(dir,"p",new BytesRef("p1"),0);
  verifyPayloadExists(dir,"p",new BytesRef("p2"),NUM_DOCS);
  dir.close();
}
