{
  final IdsRequsted reqIds=IdsRequsted.parseParams(rb.req);
  if (reqIds.allIds.isEmpty()) {
    return ResponseBuilder.STAGE_DONE;
  }
  SolrParams params=rb.req.getParams();
  ZkController zkController=rb.req.getCore().getCoreDescriptor().getCoreContainer().getZkController();
  if (zkController != null && params.get("shards") == null) {
    CloudDescriptor cloudDescriptor=rb.req.getCore().getCoreDescriptor().getCloudDescriptor();
    String collection=cloudDescriptor.getCollectionName();
    ClusterState clusterState=zkController.getClusterState();
    DocCollection coll=clusterState.getCollection(collection);
    Map<String,List<String>> sliceToId=new HashMap<>();
    for (    String id : reqIds.allIds) {
      Slice slice=coll.getRouter().getTargetSlice(id,null,null,params,coll);
      List<String> idsForShard=sliceToId.get(slice.getName());
      if (idsForShard == null) {
        idsForShard=new ArrayList<>(2);
        sliceToId.put(slice.getName(),idsForShard);
      }
      idsForShard.add(id);
    }
    for (    Map.Entry<String,List<String>> entry : sliceToId.entrySet()) {
      String shard=entry.getKey();
      String shardIdList=StrUtils.join(entry.getValue(),',');
      ShardRequest sreq=new ShardRequest();
      sreq.purpose=1;
      sreq.shards=sliceToShards(rb,collection,shard);
      sreq.actualShards=sreq.shards;
      sreq.params=new ModifiableSolrParams();
      sreq.params.set(ShardParams.SHARDS_QT,"/get");
      sreq.params.set("distrib",false);
      sreq.params.set("ids",shardIdList);
      rb.addRequest(this,sreq);
    }
  }
 else {
    String shardIdList=StrUtils.join(reqIds.allIds,',');
    ShardRequest sreq=new ShardRequest();
    sreq.purpose=1;
    sreq.shards=null;
    sreq.actualShards=sreq.shards;
    sreq.params=new ModifiableSolrParams();
    sreq.params.set(ShardParams.SHARDS_QT,"/get");
    sreq.params.set("distrib",false);
    sreq.params.set("ids",shardIdList);
    rb.addRequest(this,sreq);
  }
  return ResponseBuilder.STAGE_DONE;
}
