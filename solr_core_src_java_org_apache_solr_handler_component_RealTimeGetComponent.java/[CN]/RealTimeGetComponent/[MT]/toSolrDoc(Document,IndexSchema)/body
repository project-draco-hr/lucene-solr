{
  SolrDocument out=new SolrDocument();
  for (  IndexableField f : doc.getFields()) {
    Object existing=out.get(f.name());
    if (existing == null) {
      SchemaField sf=schema.getFieldOrNull(f.name());
      if (sf != null && schema.isCopyFieldTarget(sf))       continue;
      if (sf != null && sf.multiValued()) {
        List<Object> vals=new ArrayList<>();
        vals.add(f);
        out.setField(f.name(),vals);
      }
 else {
        out.setField(f.name(),f);
      }
    }
 else {
      out.addField(f.name(),f);
    }
  }
  return out;
}
