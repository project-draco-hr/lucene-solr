{
synchronized (this) {
    long pos=-1;
    if ((cmd.getFlags() & UpdateCommand.REPLAY) == 0) {
      ensureLog();
      pos=tlog.writeDeleteByQuery(cmd,operationFlags);
    }
    if ((cmd.getFlags() & UpdateCommand.BUFFERING) == 0) {
      if (map != null)       map.clear();
      if (prevMap != null)       prevMap.clear();
      if (prevMap2 != null)       prevMap2.clear();
      trackDeleteByQuery(cmd.getQuery(),cmd.getVersion());
      try {
        RefCounted<SolrIndexSearcher> holder=uhandler.core.openNewSearcher(true,true);
        holder.decref();
      }
 catch (      Exception e) {
        SolrException.log(log,"Error opening realtime searcher for deleteByQuery",e);
      }
    }
    LogPtr ptr=new LogPtr(pos,cmd.getVersion());
    if (trace) {
      log.trace("TLOG: added deleteByQuery " + cmd.query + " to "+ tlog+ " "+ ptr+ " map="+ System.identityHashCode(map));
    }
  }
}
