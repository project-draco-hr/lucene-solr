{
  Directory dir=newDirectory();
  IndexWriter w=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(newLogMergePolicy()));
  Document doc=new Document();
  Field f=newField("field","",Field.Store.NO,Field.Index.NOT_ANALYZED);
  doc.add(f);
  for (int i=0; i < 17; i++) {
    f.setValue("" + i);
    w.addDocument(doc);
    w.commit();
  }
  IndexReader r=IndexReader.open(w,true);
  w.close();
  assertTrue(r.getSequentialSubReaders().length > 1);
  ValueSource s1=new IntFieldSource("field");
  AtomicReaderContext[] leaves=ReaderUtil.leaves(r.getTopReaderContext());
  DocValues v1=null;
  DocValues v2=new MultiValueSource(s1).getValues(r.getTopReaderContext());
  int leafOrd=-1;
  for (int i=0; i < r.maxDoc(); i++) {
    int subIndex=ReaderUtil.subIndex(i,leaves);
    if (subIndex != leafOrd) {
      leafOrd=subIndex;
      v1=s1.getValues(leaves[leafOrd]);
    }
    assertEquals(v1.intVal(i - leaves[leafOrd].docBase),i);
    assertEquals(v2.intVal(i),i);
  }
  FieldCache.DEFAULT.purgeAllCaches();
  r.close();
  dir.close();
}
