{
  if (node.getLevel() == detailLevel) {
    node.setLeaf();
  }
  if (node.isLeaf()) {
    result.add(node);
    return true;
  }
  if (inclParents && node.getLevel() != 0)   result.add(node);
  Collection<Node> subCells=node.getSubCells(shape);
  int leaves=0;
  for (  Node subCell : subCells) {
    if (recursiveGetNodes(subCell,shape,detailLevel,inclParents,simplify,result))     leaves++;
  }
  if (simplify && leaves == node.getSubCellsSize() && node.getLevel() != 0) {
    do {
      result.remove(result.size() - 1);
    }
 while (--leaves > 0);
    node.setLeaf();
    if (!inclParents)     result.add(node);
    return true;
  }
  return false;
}
