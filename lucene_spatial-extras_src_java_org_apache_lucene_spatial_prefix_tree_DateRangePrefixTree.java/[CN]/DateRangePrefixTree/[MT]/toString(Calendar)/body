{
  final int calPrecField=getCalPrecisionField(cal);
  if (calPrecField == -1)   return "*";
  try {
    String pattern="yyyy-MM-dd'T'HH:mm:ss.SSS";
    int ptnLen=0;
switch (calPrecField) {
case Calendar.MILLISECOND:
      ptnLen+=4;
case Calendar.SECOND:
    ptnLen+=3;
case Calendar.MINUTE:
  ptnLen+=3;
case Calendar.HOUR_OF_DAY:
ptnLen+=5;
case Calendar.DAY_OF_MONTH:
ptnLen+=3;
case Calendar.MONTH:
ptnLen+=3;
case Calendar.YEAR:
ptnLen+=4;
break;
default :
throw new IllegalStateException("" + calPrecField);
}
pattern=pattern.substring(0,ptnLen);
SimpleDateFormat format=new SimpleDateFormat(pattern,Locale.ROOT);
format.setTimeZone(cal.getTimeZone());
if (cal.get(Calendar.ERA) == 0) {
final int yearOrig=cal.get(Calendar.YEAR);
cal.set(Calendar.YEAR,yearOrig - 1);
String str;
try {
str=format.format(cal.getTime());
}
  finally {
cal.set(Calendar.ERA,0);
cal.set(Calendar.YEAR,yearOrig);
}
if (yearOrig > 1) return "-" + str;
 else return "0000" + str.substring(4);
}
return format.format(cal.getTime());
}
  finally {
clearFieldsAfter(cal,calPrecField);
}
}
