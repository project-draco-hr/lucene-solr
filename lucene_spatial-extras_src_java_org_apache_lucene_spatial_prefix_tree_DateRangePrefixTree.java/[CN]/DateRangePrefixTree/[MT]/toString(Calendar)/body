{
  final int calPrecField=getCalPrecisionField(cal);
  if (calPrecField == -1)   return "*";
  try {
    StringBuilder builder=new StringBuilder("yyyy-MM-dd'T'HH:mm:ss.SSS".length());
    int year=cal.get(Calendar.YEAR);
    if (cal.get(Calendar.ERA) == 0) {
      year-=1;
      if (year > 0) {
        builder.append('-');
      }
    }
 else     if (year > 9999) {
      builder.append('+');
    }
    appendPadded(builder,year,(short)4);
    if (calPrecField >= Calendar.MONTH) {
      builder.append('-');
      appendPadded(builder,cal.get(Calendar.MONTH) + 1,(short)2);
    }
    if (calPrecField >= Calendar.DAY_OF_MONTH) {
      builder.append('-');
      appendPadded(builder,cal.get(Calendar.DAY_OF_MONTH),(short)2);
    }
    if (calPrecField >= Calendar.HOUR_OF_DAY) {
      builder.append('T');
      appendPadded(builder,cal.get(Calendar.HOUR_OF_DAY),(short)2);
    }
    if (calPrecField >= Calendar.MINUTE) {
      builder.append(':');
      appendPadded(builder,cal.get(Calendar.MINUTE),(short)2);
    }
    if (calPrecField >= Calendar.SECOND) {
      builder.append(':');
      appendPadded(builder,cal.get(Calendar.SECOND),(short)2);
    }
    if (calPrecField >= Calendar.MILLISECOND && cal.get(Calendar.MILLISECOND) > 0) {
      builder.append('.');
      appendPadded(builder,cal.get(Calendar.MILLISECOND),(short)3);
    }
    return builder.toString();
  }
  finally {
    clearFieldsAfter(cal,calPrecField);
  }
}
