{
  RequestHandlerUtils.addExperimentalFormatWarning(rsp);
  SolrParams params=req.getParams();
  UpdateRequestProcessorChain processingChain=req.getCore().getUpdateProcessingChain(params.get(UpdateParams.UPDATE_PROCESSOR));
  UpdateRequestProcessor processor=processingChain.createProcessor(req,rsp);
  Iterable<ContentStream> streams=req.getContentStreams();
  if (streams == null) {
    if (!RequestHandlerUtils.handleCommit(processor,params,false)) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"missing content stream");
    }
  }
 else {
    for (    ContentStream stream : req.getContentStreams()) {
      Reader reader=stream.getReader();
      try {
        XMLStreamReader parser=inputFactory.createXMLStreamReader(reader);
        this.processUpdate(processor,parser);
      }
  finally {
        IOUtils.closeQuietly(reader);
      }
    }
    RequestHandlerUtils.handleCommit(processor,params,false);
  }
  processor.finish();
}
