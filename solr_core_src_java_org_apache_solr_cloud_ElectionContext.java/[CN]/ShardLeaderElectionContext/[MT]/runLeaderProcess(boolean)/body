{
  log.info("Running the leader process.");
  String coreName=leaderProps.getStr(ZkStateReader.CORE_NAME_PROP);
  ZkNodeProps m=new ZkNodeProps(Overseer.QUEUE_OPERATION,"leader",ZkStateReader.SHARD_ID_PROP,shardId,ZkStateReader.COLLECTION_PROP,collection);
  Overseer.getInQueue(zkClient).offer(ZkStateReader.toJSON(m));
  String leaderVoteWait=cc.getZkController().getLeaderVoteWait();
  if (!weAreReplacement && leaderVoteWait != null) {
    waitForReplicasToComeUp(weAreReplacement,leaderVoteWait);
  }
  SolrCore core=null;
  try {
    core=cc.getCore(coreName);
    if (core == null) {
      cancelElection();
      throw new SolrException(ErrorCode.SERVER_ERROR,"Fatal Error, SolrCore not found:" + coreName + " in "+ cc.getCoreNames());
    }
    if (weAreReplacement && !shouldIBeLeader(leaderProps,core,weAreReplacement)) {
      rejoinLeaderElection(leaderSeqPath,core);
      return;
    }
    log.info("I may be the new leader - try and sync");
    core.getUpdateHandler().getSolrCoreState().cancelRecovery();
    boolean success=false;
    try {
      success=syncStrategy.sync(zkController,core,leaderProps);
    }
 catch (    Throwable t) {
      SolrException.log(log,"Exception while trying to sync",t);
      success=false;
    }
    UpdateLog ulog=core.getUpdateHandler().getUpdateLog();
    if (!success && (ulog == null || ulog.getRecentUpdates().getVersions(1).isEmpty())) {
      log.info("We failed sync, but we have no versions - we can't sync in that case - we were active before, so become leader anyway");
      success=true;
    }
    if (!success && !areAnyOtherReplicasActive(zkController,leaderProps,collection,shardId)) {
      log.info("Sync was not a success but no one else is active! I am the leader");
      success=true;
    }
    if (!success) {
      rejoinLeaderElection(leaderSeqPath,core);
      return;
    }
    log.info("I am the new leader: " + ZkCoreNodeProps.getCoreUrl(leaderProps));
    core.getCoreDescriptor().getCloudDescriptor().isLeader=true;
  }
  finally {
    if (core != null) {
      core.close();
    }
  }
  try {
    super.runLeaderProcess(weAreReplacement);
  }
 catch (  Throwable t) {
    try {
      core=cc.getCore(coreName);
      if (core == null) {
        cancelElection();
        throw new SolrException(ErrorCode.SERVER_ERROR,"Fatal Error, SolrCore not found:" + coreName + " in "+ cc.getCoreNames());
      }
      core.getCoreDescriptor().getCloudDescriptor().isLeader=false;
      rejoinLeaderElection(leaderSeqPath,core);
    }
  finally {
      if (core != null) {
        core.close();
      }
    }
  }
}
