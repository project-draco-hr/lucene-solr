{
  log.info("Running the leader process. afterExpiration=" + afterExpiration);
  String coreName=leaderProps.get(ZkStateReader.CORE_NAME_PROP);
  ZkNodeProps m=new ZkNodeProps(Overseer.QUEUE_OPERATION,"leader",ZkStateReader.SHARD_ID_PROP,shardId,ZkStateReader.COLLECTION_PROP,collection);
  Overseer.getInQueue(zkClient).offer(ZkStateReader.toJSON(m));
  String leaderVoteWait=cc.getZkController().getLeaderVoteWait();
  if (leaderVoteWait != null) {
    waitForReplicasToComeUp(weAreReplacement,leaderVoteWait);
  }
  SolrCore core=null;
  try {
    core=cc.getCore(coreName);
    if (core == null) {
      cancelElection();
      throw new SolrException(ErrorCode.SERVER_ERROR,"Fatal Error, SolrCore not found:" + coreName + " in "+ cc.getCoreNames());
    }
    if (weAreReplacement && !shouldIBeLeader(leaderProps,core)) {
      rejoinLeaderElection(leaderSeqPath,core);
      return;
    }
    if (weAreReplacement) {
      log.info("I may be the new leader - try and sync");
      core.getUpdateHandler().getSolrCoreState().cancelRecovery();
      boolean success=syncStrategy.sync(zkController,core,leaderProps);
      if (!success && anyoneElseActive()) {
        rejoinLeaderElection(leaderSeqPath,core);
        return;
      }
    }
    log.info("I am the new leader: " + ZkCoreNodeProps.getCoreUrl(leaderProps));
  }
  finally {
    if (core != null) {
      core.close();
    }
  }
  try {
    super.runLeaderProcess(weAreReplacement);
  }
 catch (  Throwable t) {
    cancelElection();
    try {
      core=cc.getCore(coreName);
      core.getCoreDescriptor().getCloudDescriptor().isLeader=false;
      if (!cc.isShutDown()) {
        rejoinLeaderElection(coreName,core);
      }
    }
  finally {
      if (core != null) {
        core.close();
      }
    }
  }
  try {
    core=cc.getCore(coreName);
    core.getCoreDescriptor().getCloudDescriptor().isLeader=true;
  }
  finally {
    if (core != null) {
      core.close();
    }
  }
}
