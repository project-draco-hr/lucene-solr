{
  String xpseg=paths.remove(0);
  if (paths.isEmpty() && xpseg.startsWith("@")) {
    if (attributes == null) {
      attributes=new ArrayList<Node>();
    }
    xpseg=xpseg.substring(1);
    attributes.add(new Node(xpseg,fieldName,multiValued));
  }
 else   if (xpseg.length() == 0) {
    xpseg=paths.remove(0);
    if (wildCardNodes == null)     wildCardNodes=new ArrayList<Node>();
    Node n=getOrAddNode(xpseg,wildCardNodes);
    if (paths.isEmpty()) {
      n.hasText=true;
      n.fieldName=fieldName;
      n.multiValued=multiValued;
      n.flatten=flags == FLATTEN;
    }
 else {
      n.build(paths,fieldName,multiValued,record,flags);
    }
  }
 else {
    if (childNodes == null)     childNodes=new ArrayList<Node>();
    Node n=getOrAddNode(xpseg,childNodes);
    if (paths.isEmpty()) {
      if (record) {
        n.isRecord=true;
        n.forEachPath=fieldName;
      }
 else {
        n.hasText=true;
        n.fieldName=fieldName;
        n.multiValued=multiValued;
        n.flatten=flags == FLATTEN;
      }
    }
 else {
      n.build(paths,fieldName,multiValued,record,flags);
    }
  }
}
