{
  Set<String> valuesAddedinThisFrame=null;
  if (isRecord) {
    recordStarted=true;
    valuesAddedinThisFrame=new HashSet<String>();
    stack.push(valuesAddedinThisFrame);
  }
 else   if (recordStarted) {
    valuesAddedinThisFrame=stack.peek();
  }
 else {
    if (attributes != null || hasText)     valuesAddedinThisFrame=new HashSet<String>();
    stack.push(valuesAddedinThisFrame);
  }
  try {
    if (attributes != null) {
      for (      Node node : attributes) {
        String value=parser.getAttributeValue(null,node.name);
        if (value != null || (recordStarted && !isRecord)) {
          putText(values,value,node.fieldName,node.multiValued);
          valuesAddedinThisFrame.add(node.fieldName);
        }
      }
    }
    Set<Node> childrenFound=new HashSet<Node>();
    boolean isNextEventFetched=false;
    int event=-1;
    while (true) {
      if (!isNextEventFetched) {
        event=parser.next();
        isNextEventFetched=false;
      }
      if (event == END_DOCUMENT) {
        return;
      }
      if (event == END_ELEMENT) {
        if (isRecord)         handler.handle(getDeepCopy(values),forEachPath);
        if (recordStarted && !isRecord && !childrenFound.containsAll(childNodes)) {
          for (          Node n : childNodes) {
            if (!childrenFound.contains(n))             n.putNulls(values);
          }
        }
        return;
      }
      if ((event == CDATA || event == CHARACTERS || event == SPACE) && hasText) {
        valuesAddedinThisFrame.add(fieldName);
        isNextEventFetched=true;
        StringBuilder text=new StringBuilder(parser.getText());
        event=parser.next();
        while (true) {
          if (event == CDATA || event == CHARACTERS || event == SPACE) {
            text.append(parser.getText());
          }
 else           if (event == START_ELEMENT) {
            if (flatten) {
              int starts=1;
              while (true) {
                event=parser.next();
                if (event == CDATA || event == CHARACTERS || event == SPACE) {
                  text.append(parser.getText());
                }
 else                 if (event == START_ELEMENT) {
                  starts++;
                }
 else                 if (event == END_ELEMENT) {
                  starts--;
                  if (starts == 0)                   break;
                }
              }
            }
 else {
              handleStartElement(parser,childrenFound,handler,values,stack,recordStarted);
            }
          }
 else {
            break;
          }
          event=parser.next();
        }
        putText(values,text.toString(),fieldName,multiValued);
      }
 else       if (event == START_ELEMENT) {
        handleStartElement(parser,childrenFound,handler,values,stack,recordStarted);
      }
    }
  }
  finally {
    Set<String> cleanThis=null;
    if (isRecord || !recordStarted) {
      cleanThis=stack.pop();
    }
 else {
      return;
    }
    if (cleanThis != null) {
      for (      String fld : cleanThis) {
        values.remove(fld);
      }
    }
  }
}
