{
  SolrHighlighter highlighter=req.getCore().getHighlighter();
  if (highlighter.isHighlightingEnabled(req.getParams())) {
    ResponseBuilder builder=SearchHandler.getResponseBuilder(req);
    SolrParams params=req.getParams();
    String[] defaultHighlightFields;
    if (builder.getQparser() != null) {
      defaultHighlightFields=builder.getQparser().getDefaultHighlightFields();
    }
 else {
      defaultHighlightFields=params.getParams(CommonParams.DF);
    }
    if (builder.getHighlightQuery() == null) {
      if (builder.getQparser() != null) {
        try {
          builder.setHighlightQuery(builder.getQparser().getHighlightQuery());
        }
 catch (        Exception e) {
          throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,e);
        }
      }
 else {
        builder.setHighlightQuery(builder.getQuery());
      }
    }
    NamedList sumData=highlighter.doHighlighting(builder.getResults().docList,builder.getHighlightQuery().rewrite(req.getSearcher().getReader()),req,defaultHighlightFields);
    if (sumData != null) {
      rsp.add("highlighting",sumData);
    }
  }
}
