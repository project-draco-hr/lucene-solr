{
  SolrQueryRequest req=rb.req;
  if (rb.doHighlights) {
    SolrHighlighter highlighter=req.getCore().getHighlighter();
    SolrParams params=req.getParams();
    String[] defaultHighlightFields;
    if (rb.getQparser() != null) {
      defaultHighlightFields=rb.getQparser().getDefaultHighlightFields();
    }
 else {
      defaultHighlightFields=params.getParams(CommonParams.DF);
    }
    if (rb.getHighlightQuery() == null) {
      if (rb.getQparser() != null) {
        try {
          rb.setHighlightQuery(rb.getQparser().getHighlightQuery());
        }
 catch (        Exception e) {
          throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,e);
        }
      }
 else {
        rb.setHighlightQuery(rb.getQuery());
      }
    }
    NamedList sumData=highlighter.doHighlighting(rb.getResults().docList,rb.getHighlightQuery().rewrite(req.getSearcher().getReader()),req,defaultHighlightFields);
    if (sumData != null) {
      rb.rsp.add("highlighting",sumData);
    }
  }
}
