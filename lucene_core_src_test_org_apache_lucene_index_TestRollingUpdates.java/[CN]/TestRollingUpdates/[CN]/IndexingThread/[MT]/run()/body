{
  try {
    DirectoryReader open=null;
    for (int i=0; i < num; i++) {
      Document doc=new Document();
      doc.add(newField("id","test",StringField.TYPE_UNSTORED));
      writer.updateDocument(new Term("id","test"),doc);
      if (random().nextInt(3) == 0) {
        if (open == null) {
          open=IndexReader.open(writer,true);
        }
        DirectoryReader reader=DirectoryReader.openIfChanged(open);
        if (reader != null) {
          open.close();
          open=reader;
        }
        assertEquals("iter: " + i + " numDocs: "+ open.numDocs()+ " del: "+ open.numDeletedDocs()+ " max: "+ open.maxDoc(),1,open.numDocs());
      }
    }
    if (open != null) {
      open.close();
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
}
