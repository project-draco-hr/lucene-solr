{
  if (getFilePointer() + length > fileLength) {
    fileLength=getFilePointer() + length;
  }
  if (length <= bufferSize - bufferPosition) {
    if (length > 0) {
      System.arraycopy(b,offset,buffer,bufferPosition,length);
    }
    bufferPosition+=length;
    if (bufferPosition > bufferLength) {
      bufferLength=bufferPosition;
    }
  }
 else {
    int available=bufferSize - bufferPosition;
    if (available > 0) {
      System.arraycopy(b,offset,buffer,bufferPosition,available);
      offset+=available;
      length-=available;
      bufferPosition=bufferSize;
      bufferLength=bufferSize;
    }
    flushBufferToCache();
    if (length < bufferSize) {
      System.arraycopy(b,offset,buffer,0,length);
      bufferPosition=length;
      bufferLength=length;
    }
 else {
      writeInternal(b,offset,length);
      bufferStart+=length;
      bufferPosition=0;
      bufferLength=0;
    }
  }
}
