{
  if (deletedDocsDirty) {
    String oldDelFileName=si.getDelFileName();
    if (oldDelFileName != null) {
      deleter.addPendingFile(oldDelFileName);
    }
    si.advanceDelGen();
    deletedDocs.write(directory(),si.getDelFileName());
  }
  if (undeleteAll && si.hasDeletions()) {
    String oldDelFileName=si.getDelFileName();
    if (oldDelFileName != null) {
      deleter.addPendingFile(oldDelFileName);
    }
    si.clearDelGen();
  }
  if (normsDirty) {
    si.setNumField(fieldInfos.size());
    Enumeration values=norms.elements();
    while (values.hasMoreElements()) {
      Norm norm=(Norm)values.nextElement();
      if (norm.dirty) {
        norm.reWrite(si);
      }
    }
  }
  deletedDocsDirty=false;
  normsDirty=false;
  undeleteAll=false;
}
