{
  segment=si.name;
  this.si=si;
  boolean success=false;
  try {
    Directory cfsDir=directory();
    if (si.getUseCompoundFile()) {
      cfsReader=new CompoundFileReader(directory(),segment + ".cfs",readBufferSize);
      cfsDir=cfsReader;
    }
    fieldInfos=new FieldInfos(cfsDir,segment + ".fnm");
    fieldsReader=new FieldsReader(cfsDir,segment,fieldInfos,readBufferSize);
    if (fieldsReader.size() != si.docCount) {
      throw new CorruptIndexException("doc counts differ for segment " + si.name + ": fieldsReader shows "+ fieldsReader.size()+ " but segmentInfo shows "+ si.docCount);
    }
    tis=new TermInfosReader(cfsDir,segment,fieldInfos,readBufferSize);
    if (hasDeletions(si)) {
      deletedDocs=new BitVector(directory(),si.getDelFileName());
      if (deletedDocs.count() > maxDoc()) {
        throw new CorruptIndexException("number of deletes (" + deletedDocs.count() + ") exceeds max doc ("+ maxDoc()+ ") for segment "+ si.name);
      }
    }
    freqStream=cfsDir.openInput(segment + ".frq",readBufferSize);
    proxStream=cfsDir.openInput(segment + ".prx",readBufferSize);
    openNorms(cfsDir,readBufferSize);
    if (fieldInfos.hasVectors()) {
      termVectorsReaderOrig=new TermVectorsReader(cfsDir,segment,fieldInfos,readBufferSize);
    }
    success=true;
  }
  finally {
    if (!success) {
      doClose();
    }
  }
}
