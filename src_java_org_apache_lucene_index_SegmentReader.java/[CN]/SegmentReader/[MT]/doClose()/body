{
  if (deletedDocsDirty) {
synchronized (directory) {
      new Lock.With(directory.makeLock("commit.lock"),IndexWriter.COMMIT_LOCK_TIMEOUT){
        public Object doBody() throws IOException {
          deletedDocs.write(directory,segment + ".tmp");
          directory.renameFile(segment + ".tmp",segment + ".del");
          directory.touchFile("segments");
          return null;
        }
      }
.run();
    }
    deletedDocsDirty=false;
  }
  fieldsReader.close();
  tis.close();
  if (freqStream != null)   freqStream.close();
  if (proxStream != null)   proxStream.close();
  closeNorms();
  if (cfsReader != null)   cfsReader.close();
  if (closeDirectory)   directory.close();
}
