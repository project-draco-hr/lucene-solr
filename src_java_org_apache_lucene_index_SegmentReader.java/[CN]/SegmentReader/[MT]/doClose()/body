{
  if (deletedDocsDirty || normsDirty) {
synchronized (directory()) {
      new Lock.With(directory().makeLock(IndexWriter.COMMIT_LOCK_NAME),IndexWriter.COMMIT_LOCK_TIMEOUT){
        public Object doBody() throws IOException {
          if (deletedDocsDirty) {
            deletedDocs.write(directory(),segment + ".tmp");
            directory().renameFile(segment + ".tmp",segment + ".del");
          }
          if (normsDirty) {
            Enumeration keys=norms.keys();
            Enumeration values=norms.elements();
            while (values.hasMoreElements()) {
              String field=(String)keys.nextElement();
              Norm norm=(Norm)values.nextElement();
              if (norm.dirty) {
                norm.reWrite(field);
              }
            }
          }
          if (segmentInfos != null)           segmentInfos.write(directory());
 else           directory().touchFile("segments");
          return null;
        }
      }
.run();
    }
    deletedDocsDirty=false;
    normsDirty=false;
  }
  fieldsReader.close();
  tis.close();
  if (freqStream != null)   freqStream.close();
  if (proxStream != null)   proxStream.close();
  closeNorms();
  if (termVectorsReader != null)   termVectorsReader.close();
  if (cfsReader != null)   cfsReader.close();
  if (closeDirectory)   directory().close();
}
