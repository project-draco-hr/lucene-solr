{
  SolrServer s=new HttpSolrServer(masterUrl,myHttpClient,null);
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set(COMMAND,CMD_GET_FILE);
  params.set(GENERATION,Long.toString(indexGen));
  params.set(CommonParams.QT,"/replication");
  if (isConf) {
    params.set(CONF_FILE_SHORT,fileName);
  }
 else {
    params.set(FILE,fileName);
  }
  if (useInternal) {
    params.set(COMPRESSION,"internal");
  }
  if (this.includeChecksum) {
    params.set(CHECKSUM,true);
  }
  params.set(CommonParams.WT,FILE_STREAM);
  if (bytesDownloaded > 0) {
    params.set(OFFSET,Long.toString(bytesDownloaded));
  }
  NamedList response;
  InputStream is=null;
  try {
    QueryRequest req=new QueryRequest(params);
    response=s.request(req);
    is=(InputStream)response.get("stream");
    if (useInternal) {
      is=new InflaterInputStream(is);
    }
    return new FastInputStream(is);
  }
 catch (  Throwable t) {
    IOUtils.closeQuietly(is);
    throw new IOException("Could not download file '" + fileName + "'",t);
  }
}
