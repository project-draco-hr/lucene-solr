{
  successfulInstall=false;
  replicationStartTime=System.currentTimeMillis();
  Directory tmpIndexDir=null;
  String tmpIndex=null;
  Directory indexDir=null;
  boolean deleteTmpIdxDir=true;
  try {
    NamedList response=null;
    try {
      response=getLatestVersion();
    }
 catch (    Exception e) {
      LOG.error("Master at: " + masterUrl + " is not available. Index fetch failed. Exception: "+ e.getMessage());
      return false;
    }
    long latestVersion=(Long)response.get(CMD_INDEX_VERSION);
    long latestGeneration=(Long)response.get(GENERATION);
    IndexCommit commit;
    RefCounted<SolrIndexSearcher> searcherRefCounted=null;
    try {
      searcherRefCounted=core.getNewestSearcher(false);
      if (searcherRefCounted == null) {
        SolrException.log(LOG,"No open searcher found - fetch aborted");
        return false;
      }
      commit=searcherRefCounted.get().getIndexReader().getIndexCommit();
    }
  finally {
      if (searcherRefCounted != null)       searcherRefCounted.decref();
    }
    if (latestVersion == 0L) {
      if (forceReplication && commit.getGeneration() != 0) {
        RefCounted<IndexWriter> iw=core.getUpdateHandler().getSolrCoreState().getIndexWriter(core);
        try {
          iw.get().deleteAll();
        }
  finally {
          iw.decref();
        }
        SolrQueryRequest req=new LocalSolrQueryRequest(core,new ModifiableSolrParams());
        core.getUpdateHandler().commit(new CommitUpdateCommand(req,false));
      }
      successfulInstall=true;
      return true;
    }
    if (!forceReplication && IndexDeletionPolicyWrapper.getCommitTimestamp(commit) == latestVersion) {
      LOG.info("Slave in sync with master.");
      successfulInstall=true;
      return true;
    }
    LOG.info("Master's generation: " + latestGeneration);
    LOG.info("Slave's generation: " + commit.getGeneration());
    LOG.info("Starting replication process");
    fetchFileList(latestGeneration);
    if (filesToDownload.isEmpty())     return false;
    LOG.info("Number of files in latest index in master: " + filesToDownload.size());
    fsyncService=Executors.newSingleThreadExecutor(new DefaultSolrThreadFactory("fsyncService"));
    filesDownloaded=Collections.synchronizedList(new ArrayList<Map<String,Object>>());
    boolean isFullCopyNeeded=IndexDeletionPolicyWrapper.getCommitTimestamp(commit) >= latestVersion || forceReplication;
    String tmpIdxDirName="index." + new SimpleDateFormat(SnapShooter.DATE_FMT,Locale.ROOT).format(new Date());
    tmpIndex=createTempindexDir(core,tmpIdxDirName);
    tmpIndexDir=core.getDirectoryFactory().get(tmpIndex,core.getSolrConfig().indexConfig.lockType);
    indexDir=core.getDirectoryFactory().get(core.getNewIndexDir(),core.getSolrConfig().indexConfig.lockType);
    Directory oldDirectory=null;
    try {
      if (isIndexStale(indexDir)) {
        isFullCopyNeeded=true;
      }
      LOG.info("Starting download to " + tmpIndexDir + " fullCopy="+ isFullCopyNeeded);
      successfulInstall=false;
      downloadIndexFiles(isFullCopyNeeded,tmpIndexDir,latestGeneration);
      LOG.info("Total time taken for download : " + ((System.currentTimeMillis() - replicationStartTime) / 1000) + " secs");
      Collection<Map<String,Object>> modifiedConfFiles=getModifiedConfFiles(confFilesToDownload);
      if (!modifiedConfFiles.isEmpty()) {
        downloadConfFiles(confFilesToDownload,latestGeneration);
        if (isFullCopyNeeded) {
          successfulInstall=modifyIndexProps(tmpIdxDirName);
          deleteTmpIdxDir=false;
        }
 else {
          successfulInstall=moveIndexFiles(tmpIndexDir,indexDir);
        }
        if (successfulInstall) {
          LOG.info("Configuration files are modified, core will be reloaded");
          logReplicationTimeAndConfFiles(modifiedConfFiles,successfulInstall);
          reloadCore();
        }
      }
 else {
        terminateAndWaitFsyncService();
        if (isFullCopyNeeded) {
          successfulInstall=modifyIndexProps(tmpIdxDirName);
          deleteTmpIdxDir=false;
          RefCounted<IndexWriter> iw=core.getUpdateHandler().getSolrCoreState().getIndexWriter(core);
          try {
            oldDirectory=iw.get().getDirectory();
          }
  finally {
            iw.decref();
          }
        }
 else {
          successfulInstall=moveIndexFiles(tmpIndexDir,indexDir);
        }
        if (successfulInstall) {
          logReplicationTimeAndConfFiles(modifiedConfFiles,successfulInstall);
        }
      }
      if (isFullCopyNeeded) {
        final Directory freezeIndexDir=indexDir;
        core.getDirectoryFactory().addCloseListener(oldDirectory,new CloseListener(){
          @Override public void preClose(){
            LOG.info("removing old index files " + freezeIndexDir);
            DirectoryFactory.empty(freezeIndexDir);
          }
          @Override public void postClose(){
            LOG.info("removing old index directory " + freezeIndexDir);
            try {
              core.getDirectoryFactory().remove(freezeIndexDir);
            }
 catch (            IOException e) {
              SolrException.log(LOG,"Error removing directory " + freezeIndexDir,e);
            }
          }
        }
);
      }
      if (successfulInstall) {
        if (isFullCopyNeeded) {
          core.getDirectoryFactory().doneWithDirectory(oldDirectory);
        }
        doCommit(isFullCopyNeeded);
      }
      replicationStartTime=0;
      return successfulInstall;
    }
 catch (    ReplicationHandlerException e) {
      LOG.error("User aborted Replication");
      return false;
    }
catch (    SolrException e) {
      throw e;
    }
catch (    InterruptedException e) {
      throw new InterruptedException("Index fetch interrupted");
    }
catch (    Exception e) {
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Index fetch failed : ",e);
    }
 finally {
      if (deleteTmpIdxDir) {
        LOG.info("removing temporary index download directory files " + tmpIndexDir);
        if (tmpIndex != null && core.getDirectoryFactory().exists(tmpIndex)) {
          DirectoryFactory.empty(tmpIndexDir);
        }
      }
    }
  }
  finally {
    try {
      if (!successfulInstall) {
        logReplicationTimeAndConfFiles(null,successfulInstall);
      }
      filesToDownload=filesDownloaded=confFilesDownloaded=confFilesToDownload=null;
      replicationStartTime=0;
      dirFileFetcher=null;
      localFileFetcher=null;
      if (fsyncService != null && !fsyncService.isShutdown())       fsyncService.shutdownNow();
      fsyncService=null;
      stop=false;
      fsyncException=null;
    }
  finally {
      if (tmpIndexDir != null) {
        core.getDirectoryFactory().release(tmpIndexDir);
      }
      if (deleteTmpIdxDir && tmpIndexDir != null) {
        try {
          core.getDirectoryFactory().remove(tmpIndexDir);
        }
 catch (        IOException e) {
          SolrException.log(LOG,"Error removing directory " + tmpIndexDir,e);
        }
      }
      if (indexDir != null) {
        core.getDirectoryFactory().release(indexDir);
      }
    }
  }
}
