{
  try {
    ZkStateReader zkStateReader=this.connection.getClient().getZkStateReader();
    ClusterState clusterState=zkStateReader.getClusterState();
    Collection<Slice> slices=clusterState.getActiveSlices(this.connection.getCollection());
    if (slices == null) {
      throw new Exception("Collection not found:" + this.connection.getCollection());
    }
    List<Replica> shuffler=new ArrayList<>();
    for (    Slice slice : slices) {
      Collection<Replica> replicas=slice.getReplicas();
      for (      Replica replica : replicas) {
        shuffler.add(replica);
      }
    }
    Collections.shuffle(shuffler,new Random());
    ModifiableSolrParams params=new ModifiableSolrParams();
    params.set(CommonParams.QT,"/sql");
    params.set("stmt",sql);
    for (    String propertyName : this.connection.getProperties().stringPropertyNames()) {
      params.set(propertyName,this.connection.getProperties().getProperty(propertyName));
    }
    Replica rep=shuffler.get(0);
    ZkCoreNodeProps zkProps=new ZkCoreNodeProps(rep);
    String url=zkProps.getCoreUrl();
    return new SolrStream(url,params);
  }
 catch (  Exception e) {
    throw new IOException(e);
  }
}
