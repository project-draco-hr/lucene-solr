{
  log.info("addZkWatch {}",coll);
  final String fullpath=getCollectionPath(coll);
synchronized (getUpdateLock()) {
    cmdExecutor.ensureExists(fullpath,zkClient);
    log.info("Updating collection state at {} from ZooKeeper... ",fullpath);
    Watcher watcher=new Watcher(){
      @Override public void process(      WatchedEvent event){
        if (EventType.None.equals(event.getType())) {
          return;
        }
        log.info("A cluster state change: {}, has occurred - updating... ",(event),ZkStateReader.this.clusterState == null ? 0 : ZkStateReader.this.clusterState.getLiveNodes().size());
        try {
synchronized (ZkStateReader.this.getUpdateLock()) {
            if (!watchedCollections.contains(coll)) {
              log.info("Unwatched collection {}",coll);
              return;
            }
            final Watcher thisWatch=this;
            Stat stat=new Stat();
            byte[] data=zkClient.getData(fullpath,thisWatch,stat,true);
            if (data == null || data.length == 0) {
              log.warn("No value set for collection state : {}",coll);
              return;
            }
            ClusterState clusterState=ClusterState.load(stat.getVersion(),data,Collections.<String>emptySet(),ZkStateReader.this,fullpath);
            DocCollection newState=clusterState.getCollectionStates().get(coll);
            watchedCollectionStates.put(coll,newState);
            log.info("Updating data for {} to ver {} ",coll,newState.getZNodeVersion());
          }
        }
 catch (        KeeperException e) {
          if (e.code() == KeeperException.Code.SESSIONEXPIRED || e.code() == KeeperException.Code.CONNECTIONLOSS) {
            log.warn("ZooKeeper watch triggered, but Solr cannot talk to ZK");
            return;
          }
          log.error("Unwatched collection :" + coll,e);
          throw new ZooKeeperException(ErrorCode.SERVER_ERROR,"",e);
        }
catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          log.error("Unwatched collection :" + coll,e);
          return;
        }
      }
    }
;
    zkClient.exists(fullpath,watcher,true);
  }
  watchedCollectionStates.put(coll,getCollectionLive(this,coll));
}
