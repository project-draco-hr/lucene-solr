{
  Map<String,ClusterState.CollectionRef> result=new LinkedHashMap<>(legacyCollectionStates);
  for (  String coll : interestingCollections) {
    if (!result.containsKey(coll) && !watchedCollectionStates.containsKey(coll)) {
      new StateWatcher(coll).refreshAndWatch(true);
    }
  }
  for (  Map.Entry<String,DocCollection> entry : watchedCollectionStates.entrySet()) {
    result.putIfAbsent(entry.getKey(),new ClusterState.CollectionRef(entry.getValue()));
  }
  for (  Map.Entry<String,LazyCollectionRef> entry : lazyCollectionStates.entrySet()) {
    result.putIfAbsent(entry.getKey(),entry.getValue());
  }
  this.clusterState=new ClusterState(liveNodes,result,legacyClusterStateVersion);
  LOG.debug("clusterStateSet: version [{}] legacy [{}] interesting [{}] watched [{}] lazy [{}] total [{}]",clusterState.getZkClusterStateVersion(),legacyCollectionStates.keySet().size(),interestingCollections.size(),watchedCollectionStates.keySet().size(),lazyCollectionStates.keySet().size(),clusterState.getCollectionStates().size());
  if (LOG.isTraceEnabled()) {
    LOG.trace("clusterStateSet: version [{}] legacy [{}] interesting [{}] watched [{}] lazy [{}] total [{}]",clusterState.getZkClusterStateVersion(),legacyCollectionStates.keySet(),interestingCollections,watchedCollectionStates.keySet(),lazyCollectionStates.keySet(),clusterState.getCollectionStates());
  }
}
