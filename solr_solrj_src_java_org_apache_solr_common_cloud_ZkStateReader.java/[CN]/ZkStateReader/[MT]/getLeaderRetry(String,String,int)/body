{
  long timeoutAt=System.nanoTime() + TimeUnit.NANOSECONDS.convert(timeout,TimeUnit.MILLISECONDS);
  while (System.nanoTime() < timeoutAt && !closed) {
    if (clusterState != null) {
      Replica replica=clusterState.getLeader(collection,shard);
      if (replica != null && getClusterState().liveNodesContain(replica.getNodeName())) {
        return replica;
      }
    }
    Thread.sleep(50);
  }
  throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"No registered leader was found after waiting for " + timeout + "ms "+ ", collection: "+ collection+ " slice: "+ shard);
}
