{
  CloudState cloudState=this.cloudState;
  if (cloudState == null) {
    return null;
  }
  Map<String,Slice> slices=cloudState.getSlices(collection);
  if (slices == null) {
    throw new ZooKeeperException(ErrorCode.BAD_REQUEST,"Could not find collection in zk: " + collection + " "+ cloudState.getCollections());
  }
  Slice replicas=slices.get(shardId);
  if (replicas == null) {
    throw new ZooKeeperException(ErrorCode.BAD_REQUEST,"Could not find shardId in zk: " + shardId);
  }
  Map<String,ZkNodeProps> shardMap=replicas.getShards();
  List<ZkCoreNodeProps> nodes=new ArrayList<ZkCoreNodeProps>(shardMap.size());
  String filterNodeName=thisNodeName + "_" + coreName;
  for (  Entry<String,ZkNodeProps> entry : shardMap.entrySet()) {
    ZkCoreNodeProps nodeProps=new ZkCoreNodeProps(entry.getValue());
    String coreNodeName=nodeProps.getNodeName() + "_" + nodeProps.getCoreName();
    if (cloudState.liveNodesContain(nodeProps.getNodeName()) && !coreNodeName.equals(filterNodeName)) {
      if (stateFilter == null || stateFilter.equals(nodeProps.getState())) {
        nodes.add(nodeProps);
      }
    }
  }
  if (nodes.size() == 0) {
    return null;
  }
  return nodes;
}
