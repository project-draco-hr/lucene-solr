{
  long timeoutAt=System.currentTimeMillis() + timeout;
  while (System.currentTimeMillis() < timeoutAt) {
    if (clusterState != null) {
      final ZkNodeProps nodeProps=clusterState.getLeader(collection,shard);
      if (nodeProps != null && getClusterState().liveNodesContain((String)nodeProps.get(ZkStateReader.NODE_NAME_PROP))) {
        return nodeProps;
      }
    }
    Thread.sleep(50);
  }
  throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"No registered leader was found, collection:" + collection + " slice:"+ shard);
}
