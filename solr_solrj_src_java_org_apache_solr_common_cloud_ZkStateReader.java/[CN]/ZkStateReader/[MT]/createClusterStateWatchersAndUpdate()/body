{
synchronized (getUpdateLock()) {
    cmdExecutor.ensureExists(CLUSTER_STATE,zkClient);
    log.info("Updating cluster state from ZooKeeper... ");
    zkClient.exists(CLUSTER_STATE,new Watcher(){
      @Override public void process(      WatchedEvent event){
        if (EventType.None.equals(event.getType())) {
          return;
        }
        log.info("A cluster state change has occurred - updating...");
        try {
synchronized (ZkStateReader.this.getUpdateLock()) {
            final Watcher thisWatch=this;
            Stat stat=new Stat();
            byte[] data=zkClient.getData(CLUSTER_STATE,thisWatch,stat,true);
            ClusterState clusterState=ClusterState.load(stat.getVersion(),data,ZkStateReader.this.clusterState.getLiveNodes());
            ZkStateReader.this.clusterState=clusterState;
          }
        }
 catch (        KeeperException e) {
          if (e.code() == KeeperException.Code.SESSIONEXPIRED || e.code() == KeeperException.Code.CONNECTIONLOSS) {
            log.warn("ZooKeeper watch triggered, but Solr cannot talk to ZK");
            return;
          }
          log.error("",e);
          throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
        }
catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          log.warn("",e);
          return;
        }
      }
    }
,true);
  }
synchronized (ZkStateReader.this.getUpdateLock()) {
    List<String> liveNodes=zkClient.getChildren(LIVE_NODES_ZKNODE,new Watcher(){
      @Override public void process(      WatchedEvent event){
        if (EventType.None.equals(event.getType())) {
          return;
        }
        log.info("Updating live nodes");
        try {
synchronized (ZkStateReader.this.getUpdateLock()) {
            List<String> liveNodes=zkClient.getChildren(LIVE_NODES_ZKNODE,this,true);
            Set<String> liveNodesSet=new HashSet<String>();
            liveNodesSet.addAll(liveNodes);
            ClusterState clusterState=new ClusterState(ZkStateReader.this.clusterState.getZkClusterStateVersion(),liveNodesSet,ZkStateReader.this.clusterState.getCollectionStates());
            ZkStateReader.this.clusterState=clusterState;
          }
        }
 catch (        KeeperException e) {
          if (e.code() == KeeperException.Code.SESSIONEXPIRED || e.code() == KeeperException.Code.CONNECTIONLOSS) {
            log.warn("ZooKeeper watch triggered, but Solr cannot talk to ZK");
            return;
          }
          log.error("",e);
          throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
        }
catch (        InterruptedException e) {
          Thread.currentThread().interrupt();
          log.warn("",e);
          return;
        }
      }
    }
,true);
    Set<String> liveNodeSet=new HashSet<String>();
    liveNodeSet.addAll(liveNodes);
    ClusterState clusterState=ClusterState.load(zkClient,liveNodeSet);
    this.clusterState=clusterState;
  }
}
