{
  if (immediate) {
    CloudState clusterState;
synchronized (getUpdateLock()) {
      List<String> liveNodes=zkClient.getChildren(LIVE_NODES_ZKNODE,null,true);
      Set<String> liveNodesSet=new HashSet<String>();
      liveNodesSet.addAll(liveNodes);
      if (!onlyLiveNodes) {
        log.info("Updating cloud state from ZooKeeper... ");
        clusterState=CloudState.load(zkClient,liveNodesSet);
      }
 else {
        log.info("Updating live nodes from ZooKeeper... ");
        clusterState=new CloudState(liveNodesSet,ZkStateReader.this.cloudState.getCollectionStates());
      }
    }
    this.cloudState=clusterState;
  }
 else {
    if (cloudStateUpdateScheduled) {
      log.info("Cloud state update for ZooKeeper already scheduled");
      return;
    }
    log.info("Scheduling cloud state update from ZooKeeper...");
    cloudStateUpdateScheduled=true;
    updateCloudExecutor.schedule(new Runnable(){
      public void run(){
        log.info("Updating cluster state from ZooKeeper...");
synchronized (getUpdateLock()) {
          cloudStateUpdateScheduled=false;
          CloudState clusterState;
          try {
            List<String> liveNodes=zkClient.getChildren(LIVE_NODES_ZKNODE,null,true);
            Set<String> liveNodesSet=new HashSet<String>();
            liveNodesSet.addAll(liveNodes);
            if (!onlyLiveNodes) {
              log.info("Updating cloud state from ZooKeeper... ");
              clusterState=CloudState.load(zkClient,liveNodesSet);
            }
 else {
              log.info("Updating live nodes from ZooKeeper... ");
              clusterState=new CloudState(liveNodesSet,ZkStateReader.this.cloudState.getCollectionStates());
            }
            ZkStateReader.this.cloudState=clusterState;
          }
 catch (          KeeperException e) {
            if (e.code() == KeeperException.Code.SESSIONEXPIRED || e.code() == KeeperException.Code.CONNECTIONLOSS) {
              log.warn("ZooKeeper watch triggered, but Solr cannot talk to ZK");
              return;
            }
            log.error("",e);
            throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
          }
catch (          InterruptedException e) {
            Thread.currentThread().interrupt();
            log.error("",e);
            throw new ZooKeeperException(SolrException.ErrorCode.SERVER_ERROR,"",e);
          }
          ZkStateReader.this.cloudState=cloudState;
        }
      }
    }
,SOLRCLOUD_UPDATE_DELAY,TimeUnit.MILLISECONDS);
  }
}
