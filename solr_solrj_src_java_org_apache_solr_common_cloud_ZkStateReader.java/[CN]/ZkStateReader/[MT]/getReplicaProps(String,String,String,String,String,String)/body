{
  ClusterState clusterState=this.clusterState;
  if (clusterState == null) {
    return null;
  }
  Map<String,Slice> slices=clusterState.getSlicesMap(collection);
  if (slices == null) {
    throw new ZooKeeperException(ErrorCode.BAD_REQUEST,"Could not find collection in zk: " + collection + " "+ clusterState.getCollections());
  }
  Slice replicas=slices.get(shardId);
  if (replicas == null) {
    throw new ZooKeeperException(ErrorCode.BAD_REQUEST,"Could not find shardId in zk: " + shardId);
  }
  Map<String,Replica> shardMap=replicas.getReplicasMap();
  List<ZkCoreNodeProps> nodes=new ArrayList<ZkCoreNodeProps>(shardMap.size());
  for (  Entry<String,Replica> entry : shardMap.entrySet()) {
    ZkCoreNodeProps nodeProps=new ZkCoreNodeProps(entry.getValue());
    String coreNodeName=entry.getValue().getName();
    if (clusterState.liveNodesContain(nodeProps.getNodeName()) && !coreNodeName.equals(thisCoreNodeName)) {
      if (mustMatchStateFilter == null || mustMatchStateFilter.equals(nodeProps.getState())) {
        if (mustNotMatchStateFilter == null || !mustNotMatchStateFilter.equals(nodeProps.getState())) {
          nodes.add(nodeProps);
        }
      }
    }
  }
  if (nodes.size() == 0) {
    return null;
  }
  return nodes;
}
