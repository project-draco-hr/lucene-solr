{
synchronized (getUpdateLock()) {
    if (clusterState == null) {
      LOG.info("ClusterState watchers have not been initialized");
      return;
    }
    ClusterState.CollectionRef ref=clusterState.getCollectionRef(collection);
    if (ref == null || legacyCollectionStates.containsKey(collection)) {
      LOG.info("Checking legacy cluster state for collection {}",collection);
      refreshLegacyClusterState(null);
      if (!legacyCollectionStates.containsKey(collection)) {
        LazyCollectionRef tryLazyCollection=new LazyCollectionRef(collection);
        if (tryLazyCollection.get() != null) {
          lazyCollectionStates.putIfAbsent(collection,tryLazyCollection);
        }
      }
    }
 else     if (ref.isLazilyLoaded()) {
      LOG.info("Refreshing lazily-loaded state for collection {}",collection);
      if (ref.get() != null) {
        return;
      }
      refreshLegacyClusterState(null);
    }
 else     if (watchedCollectionStates.containsKey(collection)) {
      LOG.info("Forcing refresh of watched collection state for {}",collection);
      DocCollection newState=fetchCollectionState(collection,null);
      if (updateWatchedCollection(collection,newState)) {
        constructState(Collections.singletonMap(collection,newState));
      }
    }
 else {
      LOG.error("Collection {} is not lazy or watched!",collection);
    }
  }
}
