{
  final CountDownLatch latch=new CountDownLatch(1);
  CollectionStateWatcher watcher=new CollectionStateWatcher(){
    @Override public void onStateChanged(    Set<String> liveNodes,    DocCollection collectionState){
      if (predicate.matches(liveNodes,collectionState)) {
        latch.countDown();
      }
 else {
        registerCollectionStateWatcher(collection,this);
      }
    }
  }
;
  registerCollectionStateWatcher(collection,watcher);
  try {
    DocCollection dc=clusterState.getCollectionOrNull(collection);
    if (predicate.matches(liveNodes,dc))     return;
    if (!latch.await(wait,unit))     throw new TimeoutException();
  }
  finally {
    removeCollectionStateWatcher(collection,watcher);
  }
}
