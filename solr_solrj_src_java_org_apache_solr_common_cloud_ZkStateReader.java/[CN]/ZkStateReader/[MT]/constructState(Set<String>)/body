{
  Set<String> liveNodes=this.liveNodes;
  Map<String,ClusterState.CollectionRef> result=new LinkedHashMap<>(legacyCollectionStates);
  for (  Map.Entry<String,DocCollection> entry : watchedCollectionStates.entrySet()) {
    result.putIfAbsent(entry.getKey(),new ClusterState.CollectionRef(entry.getValue()));
  }
  for (  Map.Entry<String,LazyCollectionRef> entry : lazyCollectionStates.entrySet()) {
    result.putIfAbsent(entry.getKey(),entry.getValue());
  }
  this.clusterState=new ClusterState(liveNodes,result,legacyClusterStateVersion);
  LOG.debug("clusterStateSet: legacy [{}] interesting [{}] watched [{}] lazy [{}] total [{}]",legacyCollectionStates.keySet().size(),collectionWatches.keySet().size(),watchedCollectionStates.keySet().size(),lazyCollectionStates.keySet().size(),clusterState.getCollectionStates().size());
  if (LOG.isTraceEnabled()) {
    LOG.trace("clusterStateSet: legacy [{}] interesting [{}] watched [{}] lazy [{}] total [{}]",legacyCollectionStates.keySet(),collectionWatches.keySet(),watchedCollectionStates.keySet(),lazyCollectionStates.keySet(),clusterState.getCollectionStates());
  }
  for (  String collection : changedCollections) {
    notifyStateWatchers(liveNodes,collection,clusterState.getCollectionOrNull(collection));
  }
}
