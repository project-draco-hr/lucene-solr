{
  MiniSolrCloudCluster target=new MiniSolrCloudCluster(1,createTempDir("cdcr-target"),buildJettyConfig("/solr"));
  try {
    target.waitForAllNodes(30);
    System.out.println("Target zkHost = " + target.getZkServer().getZkAddress());
    System.setProperty("cdcr.target.zkHost",target.getZkServer().getZkAddress());
    MiniSolrCloudCluster source=new MiniSolrCloudCluster(1,createTempDir("cdcr-source"),buildJettyConfig("/solr"));
    try {
      source.waitForAllNodes(30);
      source.uploadConfigSet(configset("cdcr-source-disabled"),"cdcr-source");
      CollectionAdminRequest.createCollection("cdcr-source","cdcr-source",1,1).withProperty("solr.directoryFactory","solr.StandardDirectoryFactory").process(source.getSolrClient());
      CloudSolrClient sourceSolrClient=source.getSolrClient();
      sourceSolrClient.setDefaultCollection("cdcr-source");
      int numDocs=0;
      for (int k=0; k < 100; k++) {
        UpdateRequest req=new UpdateRequest();
        for (; numDocs < (k + 1) * 100; numDocs++) {
          SolrInputDocument doc=new SolrInputDocument();
          doc.addField("id","source_" + numDocs);
          doc.addField("xyz",numDocs);
          req.add(doc);
        }
        req.setAction(AbstractUpdateRequest.ACTION.COMMIT,true,true);
        System.out.println("Adding 100 docs with commit=true, numDocs=" + numDocs);
        req.process(sourceSolrClient);
      }
      QueryResponse response=sourceSolrClient.query(new SolrQuery("*:*"));
      assertEquals("",numDocs,response.getResults().getNumFound());
      long maxVersion=Long.MIN_VALUE;
      ModifiableSolrParams params=new ModifiableSolrParams();
      params.set(CommonParams.QT,"/get");
      params.set("getVersions",numDocs);
      response=sourceSolrClient.query(params);
      List<Long> versions=(List<Long>)response.getResponse().get("versions");
      for (      Long version : versions) {
        maxVersion=Math.max(maxVersion,version);
      }
      source.uploadConfigSet(configset("cdcr-source"),"cdcr-source");
      JettySolrRunner runner=source.stopJettySolrRunner(0);
      source.startJettySolrRunner(runner);
      assertTrue(runner.isRunning());
      AbstractDistribZkTestBase.waitForRecoveriesToFinish("cdcr-source",source.getSolrClient().getZkStateReader(),true,true,330);
      response=sourceSolrClient.query(new SolrQuery("*:*"));
      assertEquals("Document mismatch on source after restart",numDocs,response.getResults().getNumFound());
      target.uploadConfigSet(configset("cdcr-target"),"cdcr-target");
      CollectionAdminRequest.createCollection("cdcr-target","cdcr-target",1,1).process(target.getSolrClient());
      CloudSolrClient targetSolrClient=target.getSolrClient();
      targetSolrClient.setDefaultCollection("cdcr-target");
      Thread.sleep(1000);
      cdcrStart(targetSolrClient);
      cdcrStart(sourceSolrClient);
      response=getCdcrQueue(sourceSolrClient);
      System.out.println("Cdcr queue response: " + response.getResponse());
      long foundDocs=waitForTargetToSync(numDocs,targetSolrClient);
      assertEquals("Document mismatch on target after sync",numDocs,foundDocs);
      params=new ModifiableSolrParams();
      params.set(CommonParams.ACTION,CdcrParams.CdcrAction.COLLECTIONCHECKPOINT.toString());
      params.set(CommonParams.QT,"/cdcr");
      response=targetSolrClient.query(params);
      Long checkpoint=(Long)response.getResponse().get(CdcrParams.CHECKPOINT);
      assertNotNull(checkpoint);
      assertEquals("COLLECTIONCHECKPOINT from target cluster should have returned the maximum " + "version across all updates made to source",maxVersion,checkpoint.longValue());
    }
  finally {
      source.shutdown();
    }
  }
  finally {
    target.shutdown();
  }
}
