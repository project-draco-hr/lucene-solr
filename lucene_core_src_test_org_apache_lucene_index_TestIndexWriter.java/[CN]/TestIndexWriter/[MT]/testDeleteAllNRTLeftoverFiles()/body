{
  Directory d=new MockDirectoryWrapper(random(),new RAMDirectory());
  IndexWriter w=new IndexWriter(d,new IndexWriterConfig(new MockAnalyzer(random())));
  Document doc=new Document();
  for (int i=0; i < 20; i++) {
    for (int j=0; j < 100; ++j) {
      w.addDocument(doc);
    }
    w.commit();
    DirectoryReader.open(w,true).close();
    w.deleteAll();
    w.commit();
    assertTrue(d.listAll().length <= 2);
  }
  w.close();
  d.close();
}
