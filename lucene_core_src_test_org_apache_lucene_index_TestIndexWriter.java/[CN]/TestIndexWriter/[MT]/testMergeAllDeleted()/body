{
  Directory dir=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(new MockAnalyzer(random()));
  final SetOnce<IndexWriter> iwRef=new SetOnce<>();
  iwc.setInfoStream(new RandomIndexWriter.TestPointInfoStream(iwc.getInfoStream(),new RandomIndexWriter.TestPoint(){
    @Override public void apply(    String message){
      if ("startCommitMerge".equals(message)) {
        iwRef.get().setKeepFullyDeletedSegments(false);
      }
 else       if ("startMergeInit".equals(message)) {
        iwRef.get().setKeepFullyDeletedSegments(true);
      }
    }
  }
));
  IndexWriter evilWriter=new IndexWriter(dir,iwc);
  iwRef.set(evilWriter);
  for (int i=0; i < 1000; i++) {
    addDoc(evilWriter);
    if (random().nextInt(17) == 0) {
      evilWriter.commit();
    }
  }
  evilWriter.deleteDocuments(new MatchAllDocsQuery());
  evilWriter.forceMerge(1);
  evilWriter.shutdown();
  dir.close();
}
