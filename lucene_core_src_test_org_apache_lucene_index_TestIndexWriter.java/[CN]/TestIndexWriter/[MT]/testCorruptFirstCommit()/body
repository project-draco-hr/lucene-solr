{
  for (int i=0; i < 6; i++) {
    BaseDirectoryWrapper dir=newDirectory();
    dir.createOutput("segments_0",IOContext.DEFAULT).close();
    IndexWriterConfig iwc=newIndexWriterConfig(new MockAnalyzer(random()));
    int mode=i / 2;
    if (mode == 0) {
      iwc.setOpenMode(OpenMode.CREATE);
    }
 else     if (mode == 1) {
      iwc.setOpenMode(OpenMode.APPEND);
    }
 else     if (mode == 2) {
      iwc.setOpenMode(OpenMode.CREATE_OR_APPEND);
    }
    if (VERBOSE) {
      System.out.println("\nTEST: i=" + i);
    }
    try {
      if ((i & 1) == 0) {
        new IndexWriter(dir,iwc).close();
      }
 else {
        new IndexWriter(dir,iwc).rollback();
      }
      if (mode != 0) {
        fail("expected exception");
      }
    }
 catch (    IOException ioe) {
      if (mode == 0) {
        throw ioe;
      }
    }
    if (VERBOSE) {
      System.out.println("  at close: " + Arrays.toString(dir.listAll()));
    }
    if (mode != 0) {
      dir.setCheckIndexOnClose(false);
    }
    if (dir instanceof MockDirectoryWrapper) {
      MockDirectoryWrapper mdw=(MockDirectoryWrapper)dir;
      String[] files=dir.listAll();
      Arrays.sort(files);
      if ((Arrays.equals(new String[]{"segments_0"},files) || Arrays.equals(new String[]{"segments_0","write.lock"},files)) && mdw.didTryToDelete("segments_0")) {
        dir.setCheckIndexOnClose(false);
      }
    }
    dir.close();
  }
}
