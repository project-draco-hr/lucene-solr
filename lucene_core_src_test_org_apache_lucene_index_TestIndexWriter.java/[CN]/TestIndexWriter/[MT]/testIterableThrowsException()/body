{
  Directory dir=newDirectory();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  int iters=atLeast(100);
  int docCount=0;
  int docId=0;
  Set<String> liveIds=new HashSet<String>();
  for (int i=0; i < iters; i++) {
    List<Document> docs=new ArrayList<Document>();
    FieldType ft=new FieldType(TextField.TYPE_NOT_STORED);
    FieldType idFt=new FieldType(TextField.TYPE_STORED);
    int numDocs=atLeast(4);
    for (int j=0; j < numDocs; j++) {
      Document doc=new Document();
      doc.add(newField("id","" + (docId++),idFt));
      doc.add(newField("foo",_TestUtil.randomSimpleString(random()),ft));
      docs.add(doc);
    }
    boolean success=false;
    try {
      w.addDocuments(new RandomFailingFieldIterable(docs,random()));
      success=true;
    }
 catch (    RuntimeException e) {
      assertEquals("boom",e.getMessage());
    }
 finally {
      if (success) {
        docCount+=docs.size();
        for (        Document indexDocument : docs) {
          liveIds.add(indexDocument.get("id"));
        }
      }
    }
  }
  DirectoryReader reader=w.getReader();
  assertEquals(docCount,reader.numDocs());
  List<AtomicReaderContext> leaves=reader.leaves();
  for (  AtomicReaderContext atomicReaderContext : leaves) {
    AtomicReader ar=atomicReaderContext.reader();
    Bits liveDocs=ar.getLiveDocs();
    int maxDoc=ar.maxDoc();
    for (int i=0; i < maxDoc; i++) {
      if (liveDocs.get(i)) {
        assertTrue(liveIds.remove(ar.document(i).get("id")));
      }
    }
  }
  assertTrue(liveIds.isEmpty());
  IOUtils.close(reader,w,dir);
}
