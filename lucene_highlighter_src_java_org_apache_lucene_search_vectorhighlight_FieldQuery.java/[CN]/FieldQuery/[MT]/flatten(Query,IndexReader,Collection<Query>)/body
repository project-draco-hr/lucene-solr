{
  if (sourceQuery instanceof BooleanQuery) {
    BooleanQuery bq=(BooleanQuery)sourceQuery;
    for (    BooleanClause clause : bq) {
      if (!clause.isProhibited()) {
        flatten(applyParentBoost(clause.getQuery(),bq),reader,flatQueries);
      }
    }
  }
 else   if (sourceQuery instanceof DisjunctionMaxQuery) {
    DisjunctionMaxQuery dmq=(DisjunctionMaxQuery)sourceQuery;
    for (    Query query : dmq) {
      flatten(applyParentBoost(query,dmq),reader,flatQueries);
    }
  }
 else   if (sourceQuery instanceof TermQuery) {
    if (!flatQueries.contains(sourceQuery))     flatQueries.add(sourceQuery);
  }
 else   if (sourceQuery instanceof PhraseQuery) {
    if (!flatQueries.contains(sourceQuery)) {
      PhraseQuery pq=(PhraseQuery)sourceQuery;
      if (pq.getTerms().length > 1)       flatQueries.add(pq);
 else       if (pq.getTerms().length == 1) {
        Query flat=new TermQuery(pq.getTerms()[0]);
        flat.setBoost(pq.getBoost());
        flatQueries.add(flat);
      }
    }
  }
 else   if (sourceQuery instanceof ConstantScoreQuery) {
    final Query q=((ConstantScoreQuery)sourceQuery).getQuery();
    if (q != null) {
      flatten(applyParentBoost(q,sourceQuery),reader,flatQueries);
    }
  }
 else   if (sourceQuery instanceof CustomScoreQuery) {
    final Query q=((CustomScoreQuery)sourceQuery).getSubQuery();
    if (q != null) {
      flatten(applyParentBoost(q,sourceQuery),reader,flatQueries);
    }
  }
 else   if (reader != null) {
    Query query=sourceQuery;
    if (sourceQuery instanceof MultiTermQuery) {
      MultiTermQuery copy=(MultiTermQuery)sourceQuery.clone();
      copy.setRewriteMethod(new MultiTermQuery.TopTermsScoringBooleanQueryRewrite(MAX_MTQ_TERMS));
      query=copy;
    }
    Query rewritten=query.rewrite(reader);
    if (rewritten != query) {
      flatten(rewritten,reader,flatQueries);
    }
  }
}
