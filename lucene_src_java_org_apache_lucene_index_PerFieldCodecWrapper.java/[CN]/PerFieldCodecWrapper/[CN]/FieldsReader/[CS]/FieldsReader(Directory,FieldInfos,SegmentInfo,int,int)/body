{
  final int fieldCount=fieldInfos.size();
  final Map<Codec,FieldsProducer> producers=new HashMap<Codec,FieldsProducer>();
  boolean success=false;
  try {
    for (int i=0; i < fieldCount; i++) {
      FieldInfo fi=fieldInfos.fieldInfo(i);
      if (fi.isIndexed || fi.hasDocValues()) {
        fields.add(fi.name);
        Codec codec=segmentCodecs.codecs[fi.codecId];
        if (!producers.containsKey(codec)) {
          producers.put(codec,codec.fieldsProducer(new SegmentReadState(dir,si,fieldInfos,readBufferSize,indexDivisor,"" + fi.codecId)));
        }
        codecs.put(fi.name,producers.get(codec));
      }
    }
    success=true;
  }
  finally {
    if (!success) {
      for (      FieldsProducer fp : producers.values()) {
        try {
          fp.close();
        }
 catch (        Throwable t) {
        }
      }
    }
  }
}
