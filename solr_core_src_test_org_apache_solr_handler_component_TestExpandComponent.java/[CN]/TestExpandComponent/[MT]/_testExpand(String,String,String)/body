{
  String[] doc={"id","1","term_s","YYYY",group,"1" + floatAppend,"test_ti","5","test_tl","10","test_tf","2000","type_s","parent"};
  assertU(adoc(doc));
  assertU(commit());
  String[] doc1={"id","2","term_s","YYYY",group,"1" + floatAppend,"test_ti","50","test_tl","100","test_tf","200","type_s","child"};
  assertU(adoc(doc1));
  String[] doc2={"id","3","term_s","YYYY","test_ti","5000","test_tl","100","test_tf","200"};
  assertU(adoc(doc2));
  assertU(commit());
  String[] doc3={"id","4","term_s","YYYY","test_ti","500","test_tl","1000","test_tf","2000"};
  assertU(adoc(doc3));
  String[] doc4={"id","5","term_s","YYYY",group,"2" + floatAppend,"test_ti","4","test_tl","10","test_tf","2000","type_s","parent"};
  assertU(adoc(doc4));
  assertU(commit());
  String[] doc5={"id","6","term_s","YYYY",group,"2" + floatAppend,"test_ti","10","test_tl","100","test_tf","200","type_s","child"};
  assertU(adoc(doc5));
  assertU(commit());
  String[] doc6={"id","7","term_s","YYYY",group,"1" + floatAppend,"test_ti","1","test_tl","100000","test_tf","2000","type_s","child"};
  assertU(adoc(doc6));
  assertU(commit());
  String[] doc7={"id","8","term_s","YYYY",group,"2" + floatAppend,"test_ti","2","test_tl","100000","test_tf","200","type_s","child"};
  assertU(adoc(doc7));
  assertU(commit());
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='2.0']","/response/result/doc[2]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='1.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='8.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("rows","1");
  params.add("start","1");
  assertQ(req(params),"*[count(/response/result/doc)=1]","*[count(/response/lst[@name='expanded']/result)=1]","/response/result/doc[1]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='8.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.sort","test_tl desc, sub(1,1) asc");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='2.0']","/response/result/doc[2]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='1.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='5.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ " nullPolicy=collapse}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.sort","test_tl desc");
  assertQ(req(params),"*[count(/response/result/doc)=3]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='3.0']","/response/result/doc[2]/float[@name='id'][.='2.0']","/response/result/doc[3]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='1.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='5.0']");
  params=new ModifiableSolrParams();
  params.add("q","type_s:parent");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.q","type_s:child");
  params.add("expand.field",group);
  params.add("expand.sort","test_tl desc");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='1.0']","/response/result/doc[2]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='2.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='6.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","type_s:parent");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.fq","type_s:child");
  params.add("expand.field",group);
  params.add("expand.sort","test_tl desc");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='1.0']","/response/result/doc[2]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='2.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='6.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","type_s:parent");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.q","type_s:child");
  params.add("expand.fq","*:*");
  params.add("expand.field",group);
  params.add("expand.sort","test_tl desc");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='1.0']","/response/result/doc[2]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='2.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='6.0']");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.sort","test_tl desc");
  params.add("expand.rows","1");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","*[count(/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc)=1]","*[count(/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc)=1]","/response/result/doc[1]/float[@name='id'][.='2.0']","/response/result/doc[2]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='8.0']");
  params=new ModifiableSolrParams();
  params.add("q","test_ti:5");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.sort","test_tl desc");
  params.add("expand.rows","1");
  assertQ(req(params),"*[count(/response/result/doc)=1]","*[count(/response/lst[@name='expanded']/result)=0]");
  params=new ModifiableSolrParams();
  params.add("q","test_ti:5532535");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("expand.sort","test_tl desc");
  params.add("expand.rows","1");
  assertQ(req(params),"*[count(/response/result/doc)=0]","*[count(/response/lst[@name='expanded']/result)=0]");
  params=new ModifiableSolrParams();
  params.add("q","*:*");
  params.add("fq","{!collapse field=" + group + hint+ "}");
  params.add("defType","edismax");
  params.add("bf","field(test_ti)");
  params.add("expand","true");
  params.add("fl","id");
  assertQ(req(params),"*[count(/response/result/doc)=2]","*[count(/response/lst[@name='expanded']/result)=2]","/response/result/doc[1]/float[@name='id'][.='2.0']","/response/result/doc[2]/float[@name='id'][.='6.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[1]/float[@name='id'][.='1.0']","/response/lst[@name='expanded']/result[@name='1" + floatAppend + "']/doc[2]/float[@name='id'][.='7.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[1]/float[@name='id'][.='5.0']","/response/lst[@name='expanded']/result[@name='2" + floatAppend + "']/doc[2]/float[@name='id'][.='8.0']");
}
