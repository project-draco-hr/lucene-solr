{
  boolean success=false;
  final IndexWriter w=new IndexWriter(target,config);
  try {
    final AtomicReaderContext[] leaves=ReaderUtil.leaves(reader.getTopReaderContext());
    final IndexReader[] subReaders=new IndexReader[leaves.length];
    for (int i=0; i < leaves.length; i++) {
      subReaders[i]=new DocumentFilteredAtomicIndexReader(leaves[i],preserveFilter,negateFilter);
    }
    w.addIndexes(subReaders);
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(w);
    }
 else {
      IOUtils.closeWhileHandlingException(w);
    }
  }
}
