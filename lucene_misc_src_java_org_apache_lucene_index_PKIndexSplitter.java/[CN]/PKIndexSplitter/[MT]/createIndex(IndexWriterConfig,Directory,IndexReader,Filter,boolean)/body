{
  boolean success=false;
  final IndexWriter w=new IndexWriter(target,config);
  try {
    final List<AtomicReaderContext> leaves=reader.getTopReaderContext().leaves();
    final IndexReader[] subReaders=new IndexReader[leaves.size()];
    int i=0;
    for (    final AtomicReaderContext ctx : leaves) {
      subReaders[i++]=new DocumentFilteredAtomicIndexReader(ctx,preserveFilter,negateFilter);
    }
    w.addIndexes(subReaders);
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(w);
    }
 else {
      IOUtils.closeWhileHandlingException(w);
    }
  }
}
