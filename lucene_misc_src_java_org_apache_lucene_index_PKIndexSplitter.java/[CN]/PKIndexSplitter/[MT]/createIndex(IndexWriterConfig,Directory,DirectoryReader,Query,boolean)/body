{
  boolean success=false;
  final IndexWriter w=new IndexWriter(target,config);
  try {
    final IndexSearcher searcher=new IndexSearcher(reader);
    searcher.setQueryCache(null);
    final boolean needsScores=false;
    final Weight preserveWeight=searcher.createNormalizedWeight(preserveFilter,needsScores);
    final List<LeafReaderContext> leaves=reader.leaves();
    final CodecReader[] subReaders=new CodecReader[leaves.size()];
    int i=0;
    for (    final LeafReaderContext ctx : leaves) {
      subReaders[i++]=new DocumentFilteredLeafIndexReader(ctx,preserveWeight,negateFilter);
    }
    w.addIndexes(subReaders);
    success=true;
  }
  finally {
    if (success) {
      w.close();
    }
 else {
      IOUtils.closeWhileHandlingException(w);
    }
  }
}
