{
  numRequests++;
  try {
    U.setDefaults(req,defaults);
    SolrParams params=req.getParams();
    int flags=0;
    SolrIndexSearcher s=req.getSearcher();
    IndexSchema schema=req.getSchema();
    Map<String,Float> queryFields=U.parseFieldBoosts(params.get(DMP.QF));
    Map<String,Float> phraseFields=U.parseFieldBoosts(params.get(DMP.PF));
    float tiebreaker=params.getFloat(DMP.TIE,0.0f);
    int pslop=params.getInt(DMP.PS,0);
    QueryParser p=new SolrQueryParser(schema,null);
    U.DisjunctionMaxQueryParser up=new U.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
    up.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,queryFields);
    U.DisjunctionMaxQueryParser pp=new U.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
    pp.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,phraseFields);
    pp.setPhraseSlop(pslop);
    String userQuery=U.partialEscape(U.stripUnbalancedQuotes(params.get(Q))).toString();
    BooleanQuery query=new BooleanQuery(true);
    String minShouldMatch=params.get(DMP.MM,"100%");
    Query dis=up.parse(userQuery);
    if (dis instanceof BooleanQuery) {
      BooleanQuery t=new BooleanQuery();
      U.flattenBooleanQuery(t,(BooleanQuery)dis);
      U.setMinShouldMatch(t,minShouldMatch);
      query.add(t,Occur.MUST);
    }
 else {
      query.add(dis,Occur.MUST);
    }
    String userPhraseQuery=userQuery.replace("\"","");
    Query phrase=pp.parse("\"" + userPhraseQuery + "\"");
    if (null != phrase) {
      query.add(phrase,Occur.SHOULD);
    }
    String boostQuery=params.get(DMP.BQ);
    if (null != boostQuery && !boostQuery.equals("")) {
      Query tmp=p.parse(boostQuery);
      if (1.0f == tmp.getBoost() && tmp instanceof BooleanQuery) {
        for (        BooleanClause c : ((BooleanQuery)tmp).getClauses()) {
          query.add(c);
        }
      }
 else {
        query.add(tmp,BooleanClause.Occur.SHOULD);
      }
    }
    String boostFunc=params.get(DMP.BF);
    if (null != boostFunc && !boostFunc.equals("")) {
      List<Query> funcs=U.parseFuncs(schema,boostFunc);
      for (      Query f : funcs) {
        query.add(f,Occur.SHOULD);
      }
    }
    List<Query> restrictions=new ArrayList<Query>(1);
    String filterQueryString=params.get(DMP.FQ);
    Query filterQuery=null;
    if (null != filterQueryString && !filterQueryString.equals("")) {
      filterQuery=p.parse(filterQueryString);
      restrictions.add(filterQuery);
    }
    flags|=U.setReturnFields(req,rsp);
    DocList results=s.getDocList(query,restrictions,SolrPluginUtils.getSort(req),req.getStart(),req.getLimit(),flags);
    rsp.add("search-results",results);
    try {
      NamedList debug=U.doStandardDebug(req,userQuery,query,results);
      if (null != debug) {
        debug.add("boostquery",boostQuery);
        debug.add("boostfunc",boostFunc);
        debug.add("filterquery",filterQueryString);
        if (null != filterQuery) {
          debug.add("parsedfilterquery",QueryParsing.toString(filterQuery,schema));
        }
        rsp.add("debug",debug);
      }
    }
 catch (    Exception e) {
      SolrException.logOnce(SolrCore.log,"Exception durring debug",e);
      rsp.add("exception_during_debug",SolrException.toStr(e));
    }
    if (HighlightingUtils.isHighlightingEnabled(req)) {
      BooleanQuery highlightQuery=new BooleanQuery();
      U.flattenBooleanQuery(highlightQuery,query);
      NamedList sumData=HighlightingUtils.doHighlighting(results,highlightQuery,req,queryFields.keySet().toArray(new String[0]));
      if (sumData != null)       rsp.add("highlighting",sumData);
    }
  }
 catch (  Exception e) {
    SolrException.log(SolrCore.log,e);
    rsp.setException(e);
    numErrors++;
  }
}
