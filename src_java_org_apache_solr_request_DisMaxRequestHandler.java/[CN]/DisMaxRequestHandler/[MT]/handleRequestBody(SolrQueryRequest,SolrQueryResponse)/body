{
  SolrParams params=req.getParams();
  int flags=0;
  SolrIndexSearcher s=req.getSearcher();
  IndexSchema schema=req.getSchema();
  Map<String,Float> queryFields=U.parseFieldBoosts(params.get(DMP.QF));
  Map<String,Float> phraseFields=U.parseFieldBoosts(params.get(DMP.PF));
  float tiebreaker=params.getFloat(DMP.TIE,0.0f);
  int pslop=params.getInt(DMP.PS,0);
  QueryParser p=new SolrQueryParser(schema,null);
  U.DisjunctionMaxQueryParser up=new U.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
  up.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,queryFields);
  U.DisjunctionMaxQueryParser pp=new U.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
  pp.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,phraseFields);
  pp.setPhraseSlop(pslop);
  BooleanQuery query=new BooleanQuery(true);
  Query parsedUserQuery=null;
  String userQuery=params.get(Q);
  Query altUserQuery=null;
  if (userQuery == null || userQuery.trim().length() < 1) {
    String altQ=params.get(DMP.ALTQ);
    if (altQ != null) {
      altUserQuery=p.parse(altQ);
      query.add(altUserQuery,Occur.MUST);
    }
 else {
      throw new SolrException(400,"missing query string");
    }
  }
 else {
    userQuery=U.partialEscape(U.stripUnbalancedQuotes(userQuery)).toString();
    String minShouldMatch=params.get(DMP.MM,"100%");
    Query dis=up.parse(userQuery);
    parsedUserQuery=dis;
    if (dis instanceof BooleanQuery) {
      BooleanQuery t=new BooleanQuery();
      U.flattenBooleanQuery(t,(BooleanQuery)dis);
      U.setMinShouldMatch(t,minShouldMatch);
      parsedUserQuery=t;
    }
    query.add(parsedUserQuery,Occur.MUST);
    String userPhraseQuery=userQuery.replace("\"","");
    Query phrase=pp.parse("\"" + userPhraseQuery + "\"");
    if (null != phrase) {
      query.add(phrase,Occur.SHOULD);
    }
  }
  String boostQuery=params.get(DMP.BQ);
  if (null != boostQuery && !boostQuery.equals("")) {
    Query tmp=p.parse(boostQuery);
    if (1.0f == tmp.getBoost() && tmp instanceof BooleanQuery) {
      for (      BooleanClause c : ((BooleanQuery)tmp).getClauses()) {
        query.add(c);
      }
    }
 else {
      query.add(tmp,BooleanClause.Occur.SHOULD);
    }
  }
  String boostFunc=params.get(DMP.BF);
  if (null != boostFunc && !boostFunc.equals("")) {
    List<Query> funcs=U.parseFuncs(schema,boostFunc);
    for (    Query f : funcs) {
      query.add(f,Occur.SHOULD);
    }
  }
  List<Query> restrictions=U.parseFilterQueries(req);
  flags|=U.setReturnFields(req,rsp);
  DocListAndSet results=new DocListAndSet();
  NamedList facetInfo=null;
  if (params.getBool(FACET,false)) {
    results=s.getDocListAndSet(query,restrictions,SolrPluginUtils.getSort(req),req.getStart(),req.getLimit(),flags);
    facetInfo=getFacetInfo(req,rsp,results.docSet);
  }
 else {
    results.docList=s.getDocList(query,restrictions,SolrPluginUtils.getSort(req),req.getStart(),req.getLimit(),flags);
  }
  rsp.add("response",results.docList);
  U.optimizePreFetchDocs(results.docList,query,req,rsp);
  if (null != facetInfo)   rsp.add("facet_counts",facetInfo);
  try {
    NamedList debug=U.doStandardDebug(req,userQuery,query,results.docList);
    if (null != debug) {
      debug.add("altquerystring",altUserQuery);
      debug.add("boostquery",boostQuery);
      debug.add("boostfunc",boostFunc);
      if (null != restrictions) {
        debug.add("filter_queries",params.getParams(FQ));
        List<String> fqs=new ArrayList<String>(restrictions.size());
        for (        Query fq : restrictions) {
          fqs.add(QueryParsing.toString(fq,req.getSchema()));
        }
        debug.add("parsed_filter_queries",fqs);
      }
      rsp.add("debug",debug);
    }
  }
 catch (  Exception e) {
    SolrException.logOnce(SolrCore.log,"Exception durring debug",e);
    rsp.add("exception_during_debug",SolrException.toStr(e));
  }
  if (HighlightingUtils.isHighlightingEnabled(req) && parsedUserQuery != null) {
    String[] highFields=queryFields.keySet().toArray(new String[0]);
    NamedList sumData=HighlightingUtils.doHighlighting(results.docList,parsedUserQuery,req,highFields);
    if (sumData != null)     rsp.add("highlighting",sumData);
  }
}
