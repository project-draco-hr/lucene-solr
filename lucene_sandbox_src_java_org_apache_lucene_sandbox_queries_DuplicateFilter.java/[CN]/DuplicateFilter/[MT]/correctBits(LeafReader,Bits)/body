{
  FixedBitSet bits=new FixedBitSet(reader.maxDoc());
  Terms terms=reader.fields().terms(fieldName);
  if (terms == null) {
    return bits;
  }
  TermsEnum termsEnum=terms.iterator(null);
  DocsEnum docs=null;
  while (true) {
    BytesRef currTerm=termsEnum.next();
    if (currTerm == null) {
      break;
    }
 else {
      docs=termsEnum.docs(acceptDocs,docs,DocsEnum.FLAG_NONE);
      int doc=docs.nextDoc();
      if (doc != DocIdSetIterator.NO_MORE_DOCS) {
        if (keepMode == KeepMode.KM_USE_FIRST_OCCURRENCE) {
          bits.set(doc);
        }
 else {
          int lastDoc=doc;
          while (true) {
            lastDoc=doc;
            doc=docs.nextDoc();
            if (doc == DocIdSetIterator.NO_MORE_DOCS) {
              break;
            }
          }
          bits.set(lastDoc);
        }
      }
    }
  }
  return bits;
}
