{
  SparseFixedBitSet bits=new SparseFixedBitSet(reader.maxDoc());
  Terms terms=reader.fields().terms(fieldName);
  if (terms != null) {
    TermsEnum termsEnum=terms.iterator();
    PostingsEnum docs=null;
    while (true) {
      BytesRef currTerm=termsEnum.next();
      if (currTerm == null) {
        break;
      }
 else {
        docs=termsEnum.postings(docs,PostingsEnum.NONE);
        int doc=docs.nextDoc();
        if (doc != DocIdSetIterator.NO_MORE_DOCS) {
          if (keepMode == KeepMode.KM_USE_FIRST_OCCURRENCE) {
            bits.set(doc);
          }
 else {
            int lastDoc=doc;
            while (true) {
              lastDoc=doc;
              doc=docs.nextDoc();
              if (doc == DocIdSetIterator.NO_MORE_DOCS) {
                break;
              }
            }
            bits.set(lastDoc);
          }
        }
      }
    }
  }
  return BitsFilteredDocIdSet.wrap(new BitDocIdSet(bits,bits.approximateCardinality()),acceptDocs);
}
