{
  if (res == null || totalHits <= sampleSize) {
    return res;
  }
  LabelAndValue[] fixedLabelValues=new LabelAndValue[res.labelValues.length];
  IndexReader reader=searcher.getIndexReader();
  DimConfig dimConfig=config.getDimConfig(res.dim);
  String[] childPath=new String[res.path.length + 2];
  childPath[0]=res.dim;
  System.arraycopy(res.path,0,childPath,1,res.path.length);
  for (int i=0; i < res.labelValues.length; i++) {
    childPath[res.path.length + 1]=res.labelValues[i].label;
    String fullPath=FacetsConfig.pathToString(childPath,childPath.length);
    int max=reader.docFreq(new Term(dimConfig.indexFieldName,fullPath));
    int correctedCount=(int)(res.labelValues[i].value.doubleValue() / samplingRate);
    correctedCount=Math.min(max,correctedCount);
    fixedLabelValues[i]=new LabelAndValue(res.labelValues[i].label,correctedCount);
  }
  int correctedTotalCount=res.value.intValue();
  if (correctedTotalCount > 0) {
    correctedTotalCount=Math.min(reader.numDocs(),(int)(res.value.doubleValue() / samplingRate));
  }
  return new FacetResult(res.dim,res.path,correctedTotalCount,fixedLabelValues,res.childCount);
}
