{
  updateLock.lockInterruptibly();
  try {
    if (!knownChildren.isEmpty()) {
      return remove ? knownChildren.pollFirst() : knownChildren.first();
    }
    if (lastWatcher != null && !isDirty) {
      return null;
    }
    ChildWatcher newWatcher=new ChildWatcher();
    knownChildren=fetchZkChildren(newWatcher);
    lastWatcher=newWatcher;
    isDirty=false;
    if (knownChildren.isEmpty()) {
      return null;
    }
    notEmpty.signalAll();
    return remove ? knownChildren.pollFirst() : knownChildren.first();
  }
  finally {
    updateLock.unlock();
  }
}
