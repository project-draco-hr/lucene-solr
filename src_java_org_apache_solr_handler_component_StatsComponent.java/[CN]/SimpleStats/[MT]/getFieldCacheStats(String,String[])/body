{
  FieldType ft=searcher.getSchema().getFieldType(fieldName);
  if (ft.isTokenized() || ft.isMultiValued()) {
    throw new SolrException(ErrorCode.BAD_REQUEST,"Stats are valid for single valued numeric values.  not: " + fieldName + "["+ ft+ "]");
  }
  FieldCache.StringIndex si=null;
  try {
    si=FieldCache.DEFAULT.getStringIndex(searcher.getReader(),fieldName);
  }
 catch (  IOException e) {
    throw new RuntimeException("failed to open field cache for: " + fieldName,e);
  }
  FieldFacetStats all=new FieldFacetStats("all",si,ft);
  if (all.nTerms <= 0 || docs.size() <= 0)   return null;
  StatsValues allstats=new StatsValues();
  int i=0;
  final FieldFacetStats[] finfo=new FieldFacetStats[facet.length];
  for (  String f : facet) {
    ft=searcher.getSchema().getFieldType(f);
    if (ft.isTokenized() || ft.isMultiValued()) {
      throw new SolrException(ErrorCode.BAD_REQUEST,"Stats can only facet on single valued fields, not: " + f + "["+ ft+ "]");
    }
    try {
      si=FieldCache.DEFAULT.getStringIndex(searcher.getReader(),f);
    }
 catch (    IOException e) {
      throw new RuntimeException("failed to open field cache for: " + f,e);
    }
    finfo[i++]=new FieldFacetStats(f,si,ft);
  }
  DocIterator iter=docs.iterator();
  while (iter.hasNext()) {
    int docID=iter.nextDoc();
    String raw=all.getTermText(docID);
    Double v=null;
    if (raw != null) {
      v=Double.parseDouble(all.ft.indexedToReadable(raw));
      allstats.accumulate(v);
    }
 else {
      allstats.missing++;
    }
    for (    FieldFacetStats f : finfo) {
      f.facet(docID,v);
    }
  }
  if (finfo.length > 0) {
    allstats.facets=new HashMap<String,Map<String,StatsValues>>();
    for (    FieldFacetStats f : finfo) {
      allstats.facets.put(f.name,f.facetStatsValues);
    }
  }
  return allstats.getStatsValues();
}
