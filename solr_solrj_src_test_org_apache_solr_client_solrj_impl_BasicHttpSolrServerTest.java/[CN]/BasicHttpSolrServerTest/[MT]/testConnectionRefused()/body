{
  int unusedPort=findUnusedPort();
  HttpSolrServer server=new HttpSolrServer(buildUrl(unusedPort,"/solr"));
  server.setConnectionTimeout(500);
  SolrQuery q=new SolrQuery("*:*");
  try {
    QueryResponse response=server.query(q);
    fail("Should have thrown an exception.");
  }
 catch (  SolrServerException e) {
    assumeFalse("blackholed!",e.getMessage().contains("IOException occured when talking to server"));
    assertTrue(e.getMessage().contains("refused"));
  }
 finally {
    server.shutdown();
  }
}
