{
  MockRAMDirectory dir=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.LIMITED);
  for (int j=0; j < 500; j++) {
    addDocWithIndex(writer,j);
  }
  writer.close();
  long startDiskUsage=0;
  String[] files=dir.listAll();
  for (int i=0; i < files.length; i++) {
    startDiskUsage+=dir.fileLength(files[i]);
  }
  dir.resetMaxUsedSizeInBytes();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(),false,IndexWriter.MaxFieldLength.LIMITED);
  writer.optimize();
  writer.close();
  long maxDiskUsage=dir.getMaxUsedSizeInBytes();
  assertTrue("optimized used too much temporary space: starting usage was " + startDiskUsage + " bytes; max temp usage was "+ maxDiskUsage+ " but should have been "+ (2 * startDiskUsage)+ " (= 2X starting usage)",maxDiskUsage <= 2 * startDiskUsage);
  dir.close();
}
