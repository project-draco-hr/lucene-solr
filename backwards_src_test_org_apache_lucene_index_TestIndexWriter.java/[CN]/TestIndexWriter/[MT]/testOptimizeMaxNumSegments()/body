{
  MockRAMDirectory dir=new MockRAMDirectory();
  final Document doc=new Document();
  doc.add(new Field("content","aaa",Field.Store.YES,Field.Index.ANALYZED));
  for (int numDocs=38; numDocs < 500; numDocs+=38) {
    IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.LIMITED);
    LogDocMergePolicy ldmp=new LogDocMergePolicy(writer);
    ldmp.setMinMergeDocs(1);
    writer.setMergePolicy(ldmp);
    writer.setMergeFactor(5);
    writer.setMaxBufferedDocs(2);
    for (int j=0; j < numDocs; j++)     writer.addDocument(doc);
    writer.close();
    SegmentInfos sis=new SegmentInfos();
    sis.read(dir);
    final int segCount=sis.size();
    writer=new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
    writer.setMergePolicy(ldmp);
    writer.setMergeFactor(5);
    writer.optimize(3);
    writer.close();
    sis=new SegmentInfos();
    sis.read(dir);
    final int optSegCount=sis.size();
    if (segCount < 3)     assertEquals(segCount,optSegCount);
 else     assertEquals(3,optSegCount);
  }
}
