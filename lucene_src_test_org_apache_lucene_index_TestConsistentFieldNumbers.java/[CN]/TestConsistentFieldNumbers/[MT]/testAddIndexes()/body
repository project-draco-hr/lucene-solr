{
  Directory dir1=newDirectory();
  Directory dir2=newDirectory();
  IndexWriter writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(NoMergePolicy.COMPOUND_FILES));
  Document d1=new Document();
  d1.add(new Field("f1","first field",Store.YES,Index.ANALYZED,TermVector.NO));
  d1.add(new Field("f2","second field",Store.YES,Index.ANALYZED,TermVector.NO));
  writer.addDocument(d1);
  writer.close();
  writer=new IndexWriter(dir2,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(NoMergePolicy.COMPOUND_FILES));
  Document d2=new Document();
  d2.add(new Field("f2","second field",Store.YES,Index.ANALYZED,TermVector.NO));
  d2.add(new Field("f1","first field",Store.YES,Index.ANALYZED,TermVector.YES));
  d2.add(new Field("f3","third field",Store.YES,Index.ANALYZED,TermVector.NO));
  d2.add(new Field("f4","fourth field",Store.YES,Index.ANALYZED,TermVector.NO));
  writer.addDocument(d2);
  writer.close();
  writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(NoMergePolicy.COMPOUND_FILES));
  writer.addIndexes(dir2);
  writer.close();
  SegmentInfos sis=new SegmentInfos();
  sis.read(dir1);
  assertEquals(2,sis.size());
  FieldInfos fis1=sis.info(0).getFieldInfos();
  FieldInfos fis2=sis.info(1).getFieldInfos();
  assertEquals("f1",fis1.fieldInfo(0).name);
  assertEquals("f2",fis1.fieldInfo(1).name);
  assertEquals("f2",fis2.fieldInfo(0).name);
  assertEquals("f1",fis2.fieldInfo(1).name);
  assertEquals("f3",fis2.fieldInfo(2).name);
  assertEquals("f4",fis2.fieldInfo(3).name);
  writer=new IndexWriter(dir1,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  writer.optimize();
  writer.close();
  sis=new SegmentInfos();
  sis.read(dir1);
  assertEquals(1,sis.size());
  FieldInfos fis3=sis.info(0).getFieldInfos();
  assertEquals("f1",fis3.fieldInfo(0).name);
  assertEquals("f2",fis3.fieldInfo(1).name);
  assertEquals("f3",fis3.fieldInfo(2).name);
  assertEquals("f4",fis3.fieldInfo(3).name);
  dir1.close();
  dir2.close();
}
