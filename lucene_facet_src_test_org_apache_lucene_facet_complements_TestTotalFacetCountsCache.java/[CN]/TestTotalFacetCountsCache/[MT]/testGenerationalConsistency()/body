{
  Directory indexDir=newDirectory();
  Directory taxoDir=newDirectory();
  IndexWriter indexWriter=new IndexWriter(indexDir,newIndexWriterConfig(TEST_VERSION_CURRENT,null));
  TaxonomyWriter taxoWriter=new DirectoryTaxonomyWriter(taxoDir);
  FacetIndexingParams iParams=FacetIndexingParams.DEFAULT;
  addFacets(iParams,indexWriter,taxoWriter,"a","b");
  indexWriter.commit();
  taxoWriter.commit();
  DirectoryReader indexReader=DirectoryReader.open(indexDir);
  TaxonomyReader taxoReader=new DirectoryTaxonomyReader(taxoDir);
  TotalFacetCounts totalCounts=TFC.getTotalCounts(indexReader,taxoReader,iParams);
  int prevGen=assertRecomputed(totalCounts,0,"after first attempt to get it!");
  assertTrue("Should be obtained from cache at 2nd attempt",totalCounts == TFC.getTotalCounts(indexReader,taxoReader,iParams));
  initCache();
  totalCounts=TFC.getTotalCounts(indexReader,taxoReader,iParams);
  prevGen=assertRecomputed(totalCounts,prevGen,"after cache clear, 3rd attempt to get it!");
  File outputFile=_TestUtil.createTempFile("test","tmp",TEMP_DIR);
  initCache();
  TFC.store(outputFile,indexReader,taxoReader,iParams);
  totalCounts=TFC.getTotalCounts(indexReader,taxoReader,iParams);
  prevGen=assertRecomputed(totalCounts,prevGen,"after cache clear, 4th attempt to get it!");
  initCache();
  TFC.load(outputFile,indexReader,taxoReader,iParams);
  totalCounts=TFC.getTotalCounts(indexReader,taxoReader,iParams);
  prevGen=assertReadFromDisc(totalCounts,prevGen,"after 5th attempt to get it!");
  addFacets(iParams,indexWriter,taxoWriter,"c","d");
  IOUtils.close(indexWriter,taxoWriter);
  TaxonomyReader newTaxoReader=TaxonomyReader.openIfChanged(taxoReader);
  assertNotNull(newTaxoReader);
  assertTrue("should have received more cagtegories in updated taxonomy",newTaxoReader.getSize() > taxoReader.getSize());
  taxoReader.close();
  taxoReader=newTaxoReader;
  DirectoryReader r2=DirectoryReader.openIfChanged(indexReader);
  assertNotNull(r2);
  indexReader.close();
  indexReader=r2;
  totalCounts=TFC.getTotalCounts(indexReader,taxoReader,iParams);
  prevGen=assertRecomputed(totalCounts,prevGen,"after updating the index - 7th attempt!");
  assertTrue("Should be obtained from cache at 8th attempt",totalCounts == TFC.getTotalCounts(indexReader,taxoReader,iParams));
  IOUtils.close(indexReader,taxoReader);
  outputFile.delete();
  IOUtils.close(indexDir,taxoDir);
}
