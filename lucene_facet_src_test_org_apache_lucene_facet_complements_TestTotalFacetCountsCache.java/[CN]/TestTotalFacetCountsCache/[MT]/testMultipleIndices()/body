{
  Directory indexDir1=newDirectory(), indexDir2=newDirectory();
  Directory taxoDir1=newDirectory(), taxoDir2=newDirectory();
  IndexWriter indexWriter1=new IndexWriter(indexDir1,newIndexWriterConfig(TEST_VERSION_CURRENT,null));
  IndexWriter indexWriter2=new IndexWriter(indexDir2,newIndexWriterConfig(TEST_VERSION_CURRENT,null));
  TaxonomyWriter taxoWriter1=new DirectoryTaxonomyWriter(taxoDir1);
  TaxonomyWriter taxoWriter2=new DirectoryTaxonomyWriter(taxoDir2);
  FacetIndexingParams iParams=FacetIndexingParams.DEFAULT;
  addFacets(iParams,indexWriter1,taxoWriter1,"a","b");
  addFacets(iParams,indexWriter1,taxoWriter1,"d","e");
  indexWriter1.commit();
  indexWriter2.commit();
  taxoWriter1.commit();
  taxoWriter2.commit();
  DirectoryReader indexReader1=DirectoryReader.open(indexDir1);
  DirectoryReader indexReader2=DirectoryReader.open(indexDir2);
  TaxonomyReader taxoReader1=new DirectoryTaxonomyReader(taxoDir1);
  TaxonomyReader taxoReader2=new DirectoryTaxonomyReader(taxoDir2);
  TotalFacetCounts totalCounts0=TFC.getTotalCounts(indexReader1,taxoReader1,iParams);
  int prevGen=-1;
  prevGen=assertRecomputed(totalCounts0,prevGen,"after attempt 1");
  assertTrue("attempt 1b for same input [0] shout find it in cache",totalCounts0 == TFC.getTotalCounts(indexReader1,taxoReader1,iParams));
  TotalFacetCounts totalCounts1=TFC.getTotalCounts(indexReader2,taxoReader2,iParams);
  prevGen=assertRecomputed(totalCounts1,prevGen,"after attempt 2");
  assertTrue("attempt 2b for same input [1] shout find it in cache",totalCounts1 == TFC.getTotalCounts(indexReader2,taxoReader2,iParams));
  totalCounts0=TFC.getTotalCounts(indexReader1,taxoReader1,iParams);
  prevGen=assertRecomputed(totalCounts0,prevGen,"after attempt 3");
  totalCounts1=TFC.getTotalCounts(indexReader2,taxoReader2,iParams);
  prevGen=assertRecomputed(totalCounts1,prevGen,"after attempt 4");
  TFC.setCacheSize(2);
  totalCounts0=TFC.getTotalCounts(indexReader1,taxoReader1,iParams);
  prevGen=assertRecomputed(totalCounts0,prevGen,"after attempt 5");
  totalCounts1=TFC.getTotalCounts(indexReader2,taxoReader2,iParams);
  assertTrue("with cache of size 2 res no. 0 should come from cache",totalCounts0 == TFC.getTotalCounts(indexReader1,taxoReader1,iParams));
  assertTrue("with cache of size 2 res no. 1 should come from cache",totalCounts1 == TFC.getTotalCounts(indexReader2,taxoReader2,iParams));
  IOUtils.close(indexWriter1,indexWriter2,taxoWriter1,taxoWriter2);
  IOUtils.close(indexReader1,indexReader2,taxoReader1,taxoReader2);
  IOUtils.close(indexDir1,indexDir2,taxoDir1,taxoDir2);
}
