{
  Directory dir=newDirectory();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMaxBufferedDocs(2));
  for (int j=0; j < 17; j++)   TestIndexWriter.addDoc(w);
  w.close();
  assertEquals(0,IndexReader.getCommitUserData(dir).size());
  IndexReader r=IndexReader.open(dir,true);
  assertEquals(0,r.getCommitUserData().size());
  r.close();
  w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMaxBufferedDocs(2));
  for (int j=0; j < 17; j++)   TestIndexWriter.addDoc(w);
  Map<String,String> data=new HashMap<String,String>();
  data.put("label","test1");
  w.commit(data);
  w.close();
  assertEquals("test1",IndexReader.getCommitUserData(dir).get("label"));
  r=IndexReader.open(dir,true);
  assertEquals("test1",r.getCommitUserData().get("label"));
  r.close();
  w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
  w.forceMerge(1);
  w.close();
  assertEquals("test1",IndexReader.getCommitUserData(dir).get("label"));
  dir.close();
}
