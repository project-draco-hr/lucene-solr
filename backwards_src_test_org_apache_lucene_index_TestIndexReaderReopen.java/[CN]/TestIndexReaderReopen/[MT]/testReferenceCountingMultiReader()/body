{
  for (int mode=0; mode <= 1; mode++) {
    Directory dir1=new MockRAMDirectory();
    createIndex(dir1,false);
    Directory dir2=new MockRAMDirectory();
    createIndex(dir2,true);
    IndexReader reader1=IndexReader.open(dir1,false);
    assertRefCountEquals(1,reader1);
    IndexReader initReader2=IndexReader.open(dir2,false);
    IndexReader multiReader1=new MultiReader(new IndexReader[]{reader1,initReader2},(mode == 0));
    modifyIndex(0,dir2);
    assertRefCountEquals(1 + mode,reader1);
    IndexReader multiReader2=multiReader1.reopen();
    assertRefCountEquals(2 + mode,reader1);
    modifyIndex(0,dir1);
    IndexReader reader2=reader1.reopen();
    assertRefCountEquals(2 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    modifyIndex(1,dir1);
    IndexReader reader3=reader2.reopen();
    assertRefCountEquals(2 + mode,reader1);
    assertRefCountEquals(1,reader2);
    multiReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    multiReader1.close();
    assertRefCountEquals(1 + mode,reader1);
    if (mode == 1) {
      initReader2.close();
    }
    reader1.close();
    assertRefCountEquals(1,reader1);
    multiReader2.close();
    assertRefCountEquals(0,reader1);
    multiReader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,false);
    reader2.close();
    assertRefCountEquals(0,reader1);
    reader3.close();
    assertRefCountEquals(0,reader1);
    assertReaderClosed(reader1,true,true);
    dir1.close();
    dir2.close();
  }
}
