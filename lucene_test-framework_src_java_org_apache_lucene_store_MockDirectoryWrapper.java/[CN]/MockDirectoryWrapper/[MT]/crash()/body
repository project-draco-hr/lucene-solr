{
  crashed=true;
  openFiles=new HashMap<>();
  openFilesForWrite=new HashSet<>();
  openFilesDeleted=new HashSet<>();
  Iterator<String> it=unSyncedFiles.iterator();
  unSyncedFiles=new HashSet<>();
  Map<Closeable,Exception> m=new IdentityHashMap<>(openFileHandles);
  for (  Closeable f : m.keySet()) {
    try {
      f.close();
    }
 catch (    Exception ignored) {
    }
  }
  while (it.hasNext()) {
    String name=it.next();
    int damage=randomState.nextInt(5);
    String action=null;
    if (damage == 0) {
      action="deleted";
      deleteFile(name,true);
    }
 else     if (damage == 1) {
      action="zeroed";
      long length=fileLength(name);
      byte[] zeroes=new byte[256];
      long upto=0;
      IndexOutput out=in.createOutput(name,LuceneTestCase.newIOContext(randomState));
      while (upto < length) {
        final int limit=(int)Math.min(length - upto,zeroes.length);
        out.writeBytes(zeroes,0,limit);
        upto+=limit;
      }
      out.close();
    }
 else     if (damage == 2) {
      action="partially truncated";
      String tempFileName;
      while (true) {
        tempFileName="" + randomState.nextInt();
        if (!in.fileExists(tempFileName)) {
          break;
        }
      }
      final IndexOutput tempOut=in.createOutput(tempFileName,LuceneTestCase.newIOContext(randomState));
      IndexInput ii=in.openInput(name,LuceneTestCase.newIOContext(randomState));
      tempOut.copyBytes(ii,ii.length() / 2);
      tempOut.close();
      ii.close();
      deleteFile(name,true);
      final IndexOutput out=in.createOutput(name,LuceneTestCase.newIOContext(randomState));
      ii=in.openInput(tempFileName,LuceneTestCase.newIOContext(randomState));
      out.copyBytes(ii,ii.length());
      out.close();
      ii.close();
      deleteFile(tempFileName,true);
    }
 else     if (damage == 3) {
      action="didn't change";
    }
 else {
      action="fully truncated";
      deleteFile(name,true);
      IndexOutput out=in.createOutput(name,LuceneTestCase.newIOContext(randomState));
      out.setLength(0);
      out.close();
    }
    if (LuceneTestCase.VERBOSE) {
      System.out.println("MockDirectoryWrapper: " + action + " unsynced file: "+ name);
    }
  }
}
