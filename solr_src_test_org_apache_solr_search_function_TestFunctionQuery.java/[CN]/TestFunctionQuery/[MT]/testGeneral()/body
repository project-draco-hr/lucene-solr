{
  clearIndex();
  assertU(adoc("id","1","a_tdt","2009-08-31T12:10:10.123Z","b_tdt","2009-08-31T12:10:10.124Z"));
  assertU(adoc("id","2","a_t","how now brown cow"));
  assertU(commit());
  assertU(adoc("id","3","a_t","brown cow"));
  assertU(adoc("id","4"));
  assertU(commit());
  assertU(adoc("id","5"));
  assertU(adoc("id","6","a_t","cow cow cow cow cow"));
  assertU(commit());
  assertQ(req("fl","*,score","q","{!func}numdocs()","fq","id:6"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}maxdoc()","fq","id:6"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}docfreq(a_t,cow)","fq","id:6"),"//float[@name='score']='3.0'");
  assertQ(req("fl","*,score","q","{!func}docfreq('a_t','cow')","fq","id:6"),"//float[@name='score']='3.0'");
  assertQ(req("fl","*,score","q","{!func}docfreq($field,$value)","fq","id:6","field","a_t","value","cow"),"//float[@name='score']='3.0'");
  assertQ(req("fl","*,score","q","{!func}termfreq(a_t,cow)","fq","id:6"),"//float[@name='score']='5.0'");
  Similarity similarity=new DefaultSimilarity();
  assertQ(req("fl","*,score","q","{!func}idf(a_t,cow)","fq","id:6"),"//float[@name='score']='" + similarity.idf(3,6) + "'");
  assertQ(req("fl","*,score","q","{!func}tf(a_t,cow)","fq","id:6"),"//float[@name='score']='" + similarity.tf(5) + "'");
  assertQ(req("fl","*,score","q","{!func}norm(a_t)","fq","id:2"),"//float[@name='score']='" + similarity.lengthNorm("a_t",4) + "'");
  assertQ(req("fl","*,score","q","{!func}ord(id)","fq","id:6"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}top(ord(id))","fq","id:6"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}rord(id)","fq","id:1"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}top(rord(id))","fq","id:1"),"//float[@name='score']='6.0'");
  assertQ(req("fl","*,score","q","{!func}ms(a_tdt,b_tdt)","fq","id:1"),"//float[@name='score']='-1.0'");
  assertQ(req("fl","*,score","q","{!func}ms(b_tdt,a_tdt)","fq","id:1"),"//float[@name='score']='1.0'");
  assertQ(req("fl","*,score","q","{!func}ms(2009-08-31T12:10:10.125Z,2009-08-31T12:10:10.124Z)","fq","id:1"),"//float[@name='score']='1.0'");
  assertQ(req("fl","*,score","q","{!func}ms(2009-08-31T12:10:10.124Z,a_tdt)","fq","id:1"),"//float[@name='score']='1.0'");
  assertQ(req("fl","*,score","q","{!func}ms(2009-08-31T12:10:10.125Z,b_tdt)","fq","id:1"),"//float[@name='score']='1.0'");
  assertQ(req("fl","*,score","q","{!func}ms(2009-08-31T12:10:10.125Z/SECOND,2009-08-31T12:10:10.124Z/SECOND)","fq","id:1"),"//float[@name='score']='0.0'");
  for (int i=100; i < 112; i++) {
    assertU(adoc("id","" + i,"text","batman"));
  }
  assertU(commit());
  assertU(adoc("id","120","text","batman superman"));
  assertU(commit());
  String q="{!func}query($qq)";
  String fq="id:120";
  assertQ(req("fl","*,score","q",q,"qq","text:batman","fq",fq),"//float[@name='score']<'1.0'");
  assertQ(req("fl","*,score","q",q,"qq","text:superman","fq",fq),"//float[@name='score']>'1.0'");
  assertQ(req("fl","*,score","q","{!frange l=1 u=10}query($qq)","qq","text:superman"),"//*[@numFound='1']");
  q="{!func}sub(div(sum(0.0,product(1,query($qq))),1),0)";
  assertQ(req("fl","*,score","q",q,"qq","text:batman","fq",fq),"//float[@name='score']<'1.0'");
  assertQ(req("fl","*,score","q",q,"qq","text:superman","fq",fq),"//float[@name='score']>'1.0'");
  assertQ(req("fl","*,score","q","{!func}add($v1,$v2)","v1","add($v3,$v4)","v2","1","v3","2","v4","5","fq","id:1"),"//float[@name='score']='8.0'");
  purgeFieldCache(FieldCache.DEFAULT);
}
