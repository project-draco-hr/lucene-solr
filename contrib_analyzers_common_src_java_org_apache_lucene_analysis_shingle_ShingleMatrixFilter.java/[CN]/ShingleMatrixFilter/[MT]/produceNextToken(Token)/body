{
  if (currentPermuationTokens != null) {
    currentShingleLength++;
    if (currentShingleLength + currentPermutationTokensStartOffset <= currentPermuationTokens.size() && currentShingleLength <= maximumShingleSize) {
      if (ignoringSinglePrefixOrSuffixShingle && currentShingleLength == 1 && (((Matrix.Column.Row)currentPermutationRows.get(currentPermutationTokensStartOffset)).getColumn().isFirst() || ((Matrix.Column.Row)currentPermutationRows.get(currentPermutationTokensStartOffset)).getColumn().isLast())) {
        return next(reusableToken);
      }
      int termLength=0;
      List shingle=new ArrayList();
      for (int i=0; i < currentShingleLength; i++) {
        Token shingleToken=(Token)currentPermuationTokens.get(i + currentPermutationTokensStartOffset);
        termLength+=shingleToken.termLength();
        shingle.add(shingleToken);
      }
      if (spacerCharacter != null) {
        termLength+=currentShingleLength - 1;
      }
      if (!shinglesSeen.add(shingle)) {
        return request_next_token;
      }
      StringBuilder sb=new StringBuilder(termLength + 10);
      for (Iterator iterator=shingle.iterator(); iterator.hasNext(); ) {
        Token shingleToken=(Token)iterator.next();
        if (spacerCharacter != null && sb.length() > 0) {
          sb.append(spacerCharacter);
        }
        sb.append(shingleToken.termBuffer(),0,shingleToken.termLength());
      }
      reusableToken.setTermBuffer(sb.toString());
      updateToken(reusableToken,shingle,currentPermutationTokensStartOffset,currentPermutationRows,currentPermuationTokens);
      return reusableToken;
    }
 else {
      if (currentPermutationTokensStartOffset < currentPermuationTokens.size() - 1) {
        currentPermutationTokensStartOffset++;
        currentShingleLength=minimumShingleSize - 1;
        return request_next_token;
      }
      if (permutations == null) {
        return null;
      }
      if (!permutations.hasNext()) {
        if (input != null && readColumn()) {
        }
        Matrix.Column deletedColumn=(Matrix.Column)matrix.columns.remove(0);
        List deletedColumnTokens=new ArrayList();
        for (Iterator iterator=deletedColumn.getRows().iterator(); iterator.hasNext(); ) {
          Matrix.Column.Row row=(Matrix.Column.Row)iterator.next();
          for (Iterator rowIter=row.getTokens().iterator(); rowIter.hasNext(); ) {
            Object o=rowIter.next();
            deletedColumnTokens.add(o);
          }
        }
        for (Iterator shinglesSeenIterator=shinglesSeen.iterator(); shinglesSeenIterator.hasNext(); ) {
          List shingle=(List)shinglesSeenIterator.next();
          for (Iterator deletedIter=deletedColumnTokens.iterator(); deletedIter.hasNext(); ) {
            Token deletedColumnToken=(Token)deletedIter.next();
            if (shingle.contains(deletedColumnToken)) {
              shinglesSeenIterator.remove();
              break;
            }
          }
        }
        if (matrix.columns.size() < minimumShingleSize) {
          return null;
        }
        permutations=matrix.permutationIterator();
      }
      nextTokensPermutation();
      return request_next_token;
    }
  }
  if (permutations == null) {
    permutations=matrix.permutationIterator();
  }
  if (!permutations.hasNext()) {
    return null;
  }
  nextTokensPermutation();
  return request_next_token;
}
