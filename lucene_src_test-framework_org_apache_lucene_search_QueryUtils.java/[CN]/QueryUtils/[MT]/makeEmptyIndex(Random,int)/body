{
  Directory d=new MockDirectoryWrapper(random,new RAMDirectory());
  IndexWriter w=new IndexWriter(d,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()));
  for (int i=0; i < numDeletedDocs; i++) {
    w.addDocument(new Document());
  }
  w.commit();
  w.deleteDocuments(new MatchAllDocsQuery());
  try {
    Method m=IndexWriter.class.getDeclaredMethod("keepFullyDeletedSegments");
    m.setAccessible(true);
    m.invoke(w);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  w.commit();
  if (0 < numDeletedDocs)   Assert.assertTrue("writer has no deletions",w.hasDeletions());
  Assert.assertEquals("writer is missing some deleted docs",numDeletedDocs,w.maxDoc());
  Assert.assertEquals("writer has non-deleted docs",0,w.numDocs());
  w.close();
  IndexReader r=IndexReader.open(d,true);
  Assert.assertEquals("reader has wrong number of deleted docs",numDeletedDocs,r.numDeletedDocs());
  r.close();
  return d;
}
