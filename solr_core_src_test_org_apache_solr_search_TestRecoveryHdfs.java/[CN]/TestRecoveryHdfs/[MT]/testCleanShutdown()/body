{
  DirectUpdateHandler2.commitOnClose=true;
  final Semaphore logReplay=new Semaphore(0);
  final Semaphore logReplayFinish=new Semaphore(0);
  UpdateLog.testing_logReplayHook=new Runnable(){
    @Override public void run(){
      try {
        assertTrue(logReplay.tryAcquire(timeout,TimeUnit.SECONDS));
      }
 catch (      Exception e) {
        throw new RuntimeException(e);
      }
    }
  }
;
  UpdateLog.testing_logReplayFinishHook=new Runnable(){
    @Override public void run(){
      logReplayFinish.release();
    }
  }
;
  SolrQueryRequest req=req();
  UpdateHandler uhandler=req.getCore().getUpdateHandler();
  UpdateLog ulog=uhandler.getUpdateLog();
  try {
    clearIndex();
    assertU(commit());
    assertU(adoc("id","E1","val_i","1"));
    assertU(adoc("id","E2","val_i","1"));
    logReplay.release(10);
    h.close();
    createCore();
    assertJQ(req("q","*:*"),"/response/numFound==2");
    assertEquals(10,logReplay.availablePermits());
  }
  finally {
    DirectUpdateHandler2.commitOnClose=true;
    UpdateLog.testing_logReplayHook=null;
    UpdateLog.testing_logReplayFinishHook=null;
    req().close();
  }
}
