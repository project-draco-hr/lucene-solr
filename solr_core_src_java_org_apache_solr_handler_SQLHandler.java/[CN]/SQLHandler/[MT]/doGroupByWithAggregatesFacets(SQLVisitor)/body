{
  Set<String> fieldSet=new HashSet();
  Bucket[] buckets=getBuckets(sqlVisitor.groupBy,fieldSet);
  Metric[] metrics=getMetrics(sqlVisitor.fields,fieldSet);
  if (metrics.length == 0) {
    throw new IOException("Group by queries must include at least one aggregate function.");
  }
  TableSpec tableSpec=new TableSpec(sqlVisitor.table,defaultZkhost);
  String zkHost=tableSpec.zkHost;
  String collection=tableSpec.collection;
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set(CommonParams.Q,sqlVisitor.query);
  int limit=sqlVisitor.limit > 0 ? sqlVisitor.limit : 100;
  FieldComparator[] sorts=null;
  if (sqlVisitor.sorts == null) {
    sorts=new FieldComparator[buckets.length];
    for (int i=0; i < sorts.length; i++) {
      sorts[i]=new FieldComparator("index",ComparatorOrder.ASCENDING);
    }
  }
 else {
    sorts=getComps(sqlVisitor.sorts,sqlVisitor.reverseColumnAliases);
  }
  TupleStream tupleStream=new FacetStream(zkHost,collection,params,buckets,metrics,sorts,limit);
  if (sqlVisitor.havingExpression != null) {
    tupleStream=new HavingStream(tupleStream,sqlVisitor.havingExpression,sqlVisitor.reverseColumnAliases);
  }
  if (sqlVisitor.limit > 0) {
    tupleStream=new LimitStream(tupleStream,sqlVisitor.limit);
  }
  if (sqlVisitor.hasColumnAliases) {
    tupleStream=new SelectStream(tupleStream,sqlVisitor.columnAliases);
  }
  return tupleStream;
}
