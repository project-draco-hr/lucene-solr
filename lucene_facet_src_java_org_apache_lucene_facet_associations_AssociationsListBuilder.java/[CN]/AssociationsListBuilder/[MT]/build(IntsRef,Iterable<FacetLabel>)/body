{
  final HashMap<String,BytesRef> res=new HashMap<String,BytesRef>();
  int idx=0;
  for (  FacetLabel cp : categories) {
    CategoryAssociation association=associations.getAssociation(cp);
    BytesRef bytes=res.get(association.getCategoryListID());
    if (bytes == null) {
      bytes=new BytesRef(32);
      res.put(association.getCategoryListID(),bytes);
    }
    int maxBytesNeeded=4 + association.maxBytesNeeded() + bytes.length;
    if (bytes.bytes.length < maxBytesNeeded) {
      bytes.grow(maxBytesNeeded);
    }
    output.reset(bytes.bytes,bytes.length,bytes.bytes.length - bytes.length);
    output.writeInt(ordinals.ints[idx++]);
    association.serialize(output);
    bytes.length=output.getPosition();
  }
  return res;
}
