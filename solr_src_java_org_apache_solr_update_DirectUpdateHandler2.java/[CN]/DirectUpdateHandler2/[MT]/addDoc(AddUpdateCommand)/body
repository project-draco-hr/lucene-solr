{
  addCommands.incrementAndGet();
  addCommandsCumulative.incrementAndGet();
  int rc=-1;
  if (idField == null) {
    cmd.allowDups=true;
    cmd.overwriteCommitted=false;
    cmd.overwritePending=false;
  }
  iwAccess.lock();
  try {
synchronized (this) {
      openWriter();
      tracker.addedDocument(cmd.commitWithin);
    }
    Term updateTerm=null;
    if (cmd.overwriteCommitted || cmd.overwritePending) {
      if (cmd.indexedId == null) {
        cmd.indexedId=getIndexedId(cmd.doc);
      }
      Term idTerm=this.idTerm.createTerm(cmd.indexedId);
      boolean del=false;
      if (cmd.updateTerm == null) {
        updateTerm=idTerm;
      }
 else {
        del=true;
        updateTerm=cmd.updateTerm;
      }
      writer.updateDocument(updateTerm,cmd.getLuceneDocument(schema));
      if (del) {
        BooleanQuery bq=new BooleanQuery();
        bq.add(new BooleanClause(new TermQuery(updateTerm),Occur.MUST_NOT));
        bq.add(new BooleanClause(new TermQuery(idTerm),Occur.MUST));
        writer.deleteDocuments(bq);
      }
    }
 else {
      writer.addDocument(cmd.getLuceneDocument(schema));
    }
    rc=1;
  }
  finally {
    iwAccess.unlock();
    if (rc != 1) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
 else {
      numDocsPending.incrementAndGet();
    }
  }
  return rc;
}
