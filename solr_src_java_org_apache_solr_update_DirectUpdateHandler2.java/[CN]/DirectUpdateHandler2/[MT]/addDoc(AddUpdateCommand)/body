{
  IndexWriter writer=indexWriterProvider.getIndexWriter();
  addCommands.incrementAndGet();
  addCommandsCumulative.incrementAndGet();
  int rc=-1;
  if (idField == null) {
    cmd.overwrite=false;
  }
  try {
    boolean triggered=commitTracker.addedDocument(cmd.commitWithin);
    if (!triggered) {
      softCommitTracker.addedDocument(cmd.commitWithin);
    }
 else {
      softCommitTracker.docsSinceCommit++;
    }
    Term updateTerm=null;
    if (cmd.overwrite) {
      if (cmd.indexedId == null) {
        cmd.indexedId=getIndexedId(cmd.doc);
      }
      Term idTerm=new Term(idField.getName(),cmd.indexedId);
      boolean del=false;
      if (cmd.updateTerm == null) {
        updateTerm=idTerm;
      }
 else {
        del=true;
        updateTerm=cmd.updateTerm;
      }
      writer.updateDocument(updateTerm,cmd.getLuceneDocument(schema));
      if (del) {
        BooleanQuery bq=new BooleanQuery();
        bq.add(new BooleanClause(new TermQuery(updateTerm),Occur.MUST_NOT));
        bq.add(new BooleanClause(new TermQuery(idTerm),Occur.MUST));
        writer.deleteDocuments(bq);
      }
    }
 else {
      writer.addDocument(cmd.getLuceneDocument(schema));
    }
    rc=1;
  }
  finally {
    if (rc != 1) {
      numErrors.incrementAndGet();
      numErrorsCumulative.incrementAndGet();
    }
 else {
      numDocsPending.incrementAndGet();
    }
  }
  return rc;
}
