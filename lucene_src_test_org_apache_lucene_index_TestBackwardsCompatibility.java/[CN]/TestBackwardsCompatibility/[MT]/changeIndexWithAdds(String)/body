{
  String origDirName=dirName;
  dirName=fullDir(dirName);
  Directory dir=FSDirectory.open(new File(dirName));
  IndexWriter writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  for (int i=0; i < 10; i++) {
    addDoc(writer,35 + i);
  }
  final int expected;
  if (compare(origDirName,"24") < 0) {
    expected=45;
  }
 else {
    expected=46;
  }
  assertEquals("wrong doc count",expected,writer.maxDoc());
  writer.close();
  IndexSearcher searcher=new IndexSearcher(dir,true);
  ScoreDoc[] hits=searcher.search(new TermQuery(new Term("content","aaa")),null,1000).scoreDocs;
  Document d=searcher.doc(hits[0].doc);
  assertEquals("wrong first document","21",d.get("id"));
  doTestHits(hits,44,searcher.getIndexReader());
  searcher.close();
  IndexReader reader=IndexReader.open(dir,false);
  Term searchTerm=new Term("id","6");
  int delCount=reader.deleteDocuments(searchTerm);
  assertEquals("wrong delete count",1,delCount);
  reader.setNorm(22,"content",(float)2.0);
  reader.close();
  searcher=new IndexSearcher(dir,true);
  hits=searcher.search(new TermQuery(new Term("content","aaa")),null,1000).scoreDocs;
  assertEquals("wrong number of hits",43,hits.length);
  d=searcher.doc(hits[0].doc);
  assertEquals("wrong first document","22",d.get("id"));
  doTestHits(hits,43,searcher.getIndexReader());
  searcher.close();
  writer=new IndexWriter(dir,new IndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND));
  writer.optimize();
  writer.close();
  searcher=new IndexSearcher(dir,true);
  hits=searcher.search(new TermQuery(new Term("content","aaa")),null,1000).scoreDocs;
  assertEquals("wrong number of hits",43,hits.length);
  d=searcher.doc(hits[0].doc);
  doTestHits(hits,43,searcher.getIndexReader());
  assertEquals("wrong first document","22",d.get("id"));
  searcher.close();
  dir.close();
}
