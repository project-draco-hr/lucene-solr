{
  rmDir(dirName);
  dirName=fullDir(dirName);
  Directory dir=FSDirectory.open(new File(dirName));
  IndexWriterConfig conf=newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(10);
  ((LogMergePolicy)conf.getMergePolicy()).setUseCompoundFile(doCFS);
  ((LogMergePolicy)conf.getMergePolicy()).setUseCompoundDocStore(doCFS);
  IndexWriter writer=new IndexWriter(dir,conf);
  for (int i=0; i < 35; i++) {
    addDoc(writer,i);
  }
  assertEquals("wrong doc count",35,writer.maxDoc());
  writer.close();
  conf=newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(10);
  ((LogMergePolicy)conf.getMergePolicy()).setUseCompoundFile(doCFS);
  ((LogMergePolicy)conf.getMergePolicy()).setUseCompoundDocStore(doCFS);
  writer=new IndexWriter(dir,conf);
  addNoProxDoc(writer);
  writer.close();
  IndexReader reader=IndexReader.open(dir,false);
  Term searchTerm=new Term("id","7");
  int delCount=reader.deleteDocuments(searchTerm);
  assertEquals("didn't delete the right number of documents",1,delCount);
  reader.setNorm(21,"content",(float)1.5);
  reader.close();
}
