{
  Directory dir=newDirectory();
  byte[] bin=new byte[]{0,1,2,3,4,5,6,7,8,9};
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setMergePolicy(newLogMergePolicy()));
  for (int i=0; i < 10; i++) {
    addDoc(writer,"document number " + (i + 1));
    addDocumentWithFields(writer);
    addDocumentWithDifferentFields(writer);
    addDocumentWithTermVectorFields(writer);
  }
  writer.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setMergePolicy(newLogMergePolicy()));
  Document doc=new Document();
  doc.add(new BinaryField("bin1",bin));
  doc.add(new TextField("junk","junk text"));
  writer.addDocument(doc);
  writer.close();
  IndexReader reader=IndexReader.open(dir,false);
  Document doc2=reader.document(reader.maxDoc() - 1);
  IndexableField[] fields=doc2.getFields("bin1");
  assertNotNull(fields);
  assertEquals(1,fields.length);
  Field b1=(Field)fields[0];
  assertTrue(b1.isBinary());
  BytesRef bytesRef=b1.binaryValue();
  assertEquals(bin.length,bytesRef.length);
  for (int i=0; i < bin.length; i++) {
    assertEquals(bin[i],bytesRef.bytes[i + bytesRef.offset]);
  }
  Set<String> lazyFields=new HashSet<String>();
  lazyFields.add("bin1");
  FieldSelector sel=new SetBasedFieldSelector(new HashSet<String>(),lazyFields);
  doc2=getDocument(reader,reader.maxDoc() - 1,sel);
  fields=doc2.getFields("bin1");
  assertNotNull(fields);
  assertEquals(1,fields.length);
  IndexableField fb1=fields[0];
  assertTrue(fb1.binaryValue() != null);
  bytesRef=fb1.binaryValue();
  assertEquals(bin.length,bytesRef.bytes.length);
  assertEquals(bin.length,bytesRef.length);
  for (int i=0; i < bin.length; i++) {
    assertEquals(bin[i],bytesRef.bytes[i + bytesRef.offset]);
  }
  reader.close();
  writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.APPEND).setMergePolicy(newLogMergePolicy()));
  writer.optimize();
  writer.close();
  reader=IndexReader.open(dir,false);
  doc2=reader.document(reader.maxDoc() - 1);
  fields=doc2.getFields("bin1");
  assertNotNull(fields);
  assertEquals(1,fields.length);
  b1=(Field)fields[0];
  assertTrue(b1.isBinary());
  bytesRef=b1.binaryValue();
  assertEquals(bin.length,bytesRef.length);
  for (int i=0; i < bin.length; i++) {
    assertEquals(bin[i],bytesRef.bytes[i + bytesRef.offset]);
  }
  reader.close();
  dir.close();
}
