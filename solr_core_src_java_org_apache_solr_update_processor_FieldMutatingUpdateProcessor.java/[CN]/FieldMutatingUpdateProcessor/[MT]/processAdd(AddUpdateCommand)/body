{
  final SolrInputDocument doc=cmd.getSolrInputDocument();
  final Collection<String> fieldNames=new ArrayList<String>(doc.getFieldNames());
  for (  final String fname : fieldNames) {
    if (!selector.shouldMutate(fname))     continue;
    final SolrInputField src=doc.get(fname);
    SolrInputField dest=null;
    try {
      dest=mutate(src);
    }
 catch (    SolrException e) {
      String msg="Unable to mutate field '" + fname + "': "+ e.getMessage();
      SolrException.log(log,msg,e);
      throw new SolrException(BAD_REQUEST,msg,e);
    }
    if (null == dest) {
      doc.remove(fname);
    }
 else {
      if (!fname.equals(dest.getName())) {
        throw new SolrException(SERVER_ERROR,"mutate returned field with different name: " + fname + " => "+ dest.getName());
      }
      doc.put(dest.getName(),dest);
    }
  }
  super.processAdd(cmd);
}
