{
  MDCUtils.clearMDC();
  if (abortErrorMessage != null) {
    sendError((HttpServletResponse)response,500,abortErrorMessage);
    return;
  }
  if (this.cores == null) {
    sendError((HttpServletResponse)response,503,"Server is shutting down or failed to initialize");
    return;
  }
  CoreContainer cores=this.cores;
  SolrCore core=null;
  SolrQueryRequest solrReq=null;
  Aliases aliases=null;
  Map<String,Integer> invalidStates=null;
  if (request instanceof HttpServletRequest) {
    HttpServletRequest req=(HttpServletRequest)request;
    HttpServletResponse resp=(HttpServletResponse)response;
    SolrRequestHandler handler=null;
    String corename="";
    String origCorename=null;
    try {
      req.setAttribute(SolrRequestParsers.REQUEST_TIMER_SERVLET_ATTRIBUTE,new RTimer());
      req.setAttribute("org.apache.solr.CoreContainer",cores);
      String path=req.getServletPath();
      if (req.getPathInfo() != null) {
        path+=req.getPathInfo();
      }
      if (pathPrefix != null && path.startsWith(pathPrefix)) {
        path=path.substring(pathPrefix.length());
      }
      String alternate=cores.getManagementPath();
      if (alternate != null && path.startsWith(alternate)) {
        path=path.substring(0,alternate.length());
      }
      int idx=path.indexOf(':');
      if (idx > 0) {
        path=path.substring(0,idx);
      }
      boolean usingAliases=false;
      List<String> collectionsList=null;
      handler=cores.getRequestHandler(path);
      if (handler != null) {
        solrReq=SolrRequestParsers.DEFAULT.parse(null,path,req);
        handleAdminRequest(req,response,handler,solrReq);
        return;
      }
 else {
        idx=path.indexOf("/",1);
        if (idx > 1) {
          corename=path.substring(1,idx);
          if (cores.isZooKeeperAware()) {
            origCorename=corename;
            ZkStateReader reader=cores.getZkController().getZkStateReader();
            aliases=reader.getAliases();
            if (aliases != null && aliases.collectionAliasSize() > 0) {
              usingAliases=true;
              String alias=aliases.getCollectionAlias(corename);
              if (alias != null) {
                collectionsList=StrUtils.splitSmart(alias,",",true);
                corename=collectionsList.get(0);
              }
            }
          }
          core=cores.getCore(corename);
          if (core != null) {
            path=path.substring(idx);
            MDCUtils.setCore(core.getName());
          }
        }
        if (core == null) {
          if (!cores.isZooKeeperAware()) {
            core=cores.getCore("");
            if (core != null)             MDCUtils.setCore(core.getName());
          }
        }
      }
      if (core == null && cores.isZooKeeperAware()) {
        core=getCoreByCollection(cores,corename);
        if (core != null) {
          path=path.substring(idx);
          MDCUtils.setCore(core.getName());
        }
        if (core == null && idx > 0) {
          String coreUrl=getRemotCoreUrl(cores,corename,origCorename);
          SolrParams queryParams=SolrRequestParsers.parseQueryString(req.getQueryString());
          invalidStates=checkStateIsValid(cores,queryParams.get(CloudSolrClient.STATE_VERSION));
          if (coreUrl != null && queryParams.get(DistributingUpdateProcessorFactory.DISTRIB_UPDATE_PARAM) == null) {
            path=path.substring(idx);
            if (invalidStates != null) {
              throw new SolrException(ErrorCode.INVALID_STATE,new String(ZkStateReader.toJSON(invalidStates),org.apache.lucene.util.IOUtils.UTF_8));
            }
            remoteQuery(coreUrl + path,req,solrReq,resp);
            return;
          }
 else {
            if (!retry) {
              ZkStateReader reader=cores.getZkController().getZkStateReader();
              reader.updateAliases();
              doFilter(request,response,chain,true);
              return;
            }
          }
        }
        if (core == null) {
          core=cores.getCore("");
          MDCUtils.setCore(core.getName());
        }
      }
      if (core != null) {
        final SolrConfig config=core.getSolrConfig();
        SolrRequestParsers parser=config.getRequestParsers();
        if (handler == null && path.length() > 1) {
          handler=core.getRequestHandler(path);
          if (handler == null) {
            if (path.equals("/schema") || path.startsWith("/schema/")) {
              solrReq=parser.parse(core,path,req);
              SolrRequestInfo.setRequestInfo(new SolrRequestInfo(solrReq,new SolrQueryResponse()));
              if (path.equals(req.getServletPath())) {
                chain.doFilter(request,response);
              }
 else {
                req.getRequestDispatcher(path).forward(request,response);
              }
              return;
            }
          }
          if (handler == null && parser.isHandleSelect()) {
            if ("/select".equals(path) || "/select/".equals(path)) {
              solrReq=parser.parse(core,path,req);
              invalidStates=checkStateIsValid(cores,solrReq.getParams().get(CloudSolrClient.STATE_VERSION));
              String qt=solrReq.getParams().get(CommonParams.QT);
              handler=core.getRequestHandler(qt);
              if (handler == null) {
                throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"unknown handler: " + qt);
              }
              if (qt != null && qt.startsWith("/") && (handler instanceof ContentStreamHandlerBase)) {
                throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Invalid Request Handler ('qt').  Do not use /select to access: " + qt);
              }
            }
          }
        }
        if (handler != null) {
          if (solrReq == null) {
            solrReq=parser.parse(core,path,req);
          }
          if (usingAliases) {
            processAliases(solrReq,aliases,collectionsList);
          }
          final Method reqMethod=Method.getMethod(req.getMethod());
          HttpCacheHeaderUtil.setCacheControlHeader(config,resp,reqMethod);
          if (config.getHttpCachingConfig().isNever304() || !HttpCacheHeaderUtil.doCacheHeaderValidation(solrReq,req,reqMethod,resp)) {
            SolrQueryResponse solrRsp=new SolrQueryResponse();
            SolrRequestInfo.setRequestInfo(new SolrRequestInfo(solrReq,solrRsp));
            this.execute(req,handler,solrReq,solrRsp);
            HttpCacheHeaderUtil.checkHttpCachingVeto(solrRsp,resp,reqMethod);
            Iterator<Entry<String,String>> headers=solrRsp.httpHeaders();
            while (headers.hasNext()) {
              Entry<String,String> entry=headers.next();
              resp.addHeader(entry.getKey(),entry.getValue());
            }
            QueryResponseWriter responseWriter=core.getQueryResponseWriter(solrReq);
            if (invalidStates != null)             solrReq.getContext().put(CloudSolrClient.STATE_VERSION,invalidStates);
            writeResponse(solrRsp,response,responseWriter,solrReq,reqMethod);
          }
          return;
        }
      }
      log.debug("no handler or core retrieved for " + path + ", follow through...");
    }
 catch (    Throwable ex) {
      sendError(core,solrReq,request,(HttpServletResponse)response,ex);
      Throwable t=ex;
      while (t != null) {
        if (t instanceof Error) {
          if (t != ex) {
            log.error("An Error was wrapped in another exception - please report complete stacktrace on SOLR-6161",ex);
          }
          throw (Error)t;
        }
        t=t.getCause();
      }
      return;
    }
 finally {
      try {
        if (solrReq != null) {
          log.debug("Closing out SolrRequest: {}",solrReq);
          solrReq.close();
        }
      }
  finally {
        try {
          if (core != null) {
            core.close();
          }
        }
  finally {
          SolrRequestInfo.clearRequestInfo();
        }
      }
    }
  }
  chain.doFilter(request,response);
}
