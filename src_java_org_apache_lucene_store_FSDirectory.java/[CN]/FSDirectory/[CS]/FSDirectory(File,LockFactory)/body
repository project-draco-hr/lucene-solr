{
  path=getCanonicalPath(path);
  if (lockFactory == null) {
    lockFactory=new NativeFSLockFactory();
  }
  directory=path;
  if (directory.exists() && !directory.isDirectory())   throw new NoSuchDirectoryException("file '" + directory + "' exists but is not a directory");
  setLockFactory(lockFactory);
  if (lockFactory instanceof FSLockFactory) {
    final FSLockFactory lf=(FSLockFactory)lockFactory;
    final File dir=lf.getLockDir();
    if (dir == null) {
      lf.setLockDir(this.directory);
      lf.setLockPrefix(null);
    }
 else     if (dir.getCanonicalPath().equals(this.directory.getCanonicalPath())) {
      lf.setLockPrefix(null);
    }
  }
}
