{
  file=new File(file.getCanonicalPath());
  FSDirectory dir;
synchronized (DIRECTORIES) {
    dir=(FSDirectory)DIRECTORIES.get(file);
    if (dir == null) {
      try {
        dir=(FSDirectory)IMPL.newInstance();
      }
 catch (      Exception e) {
        throw new RuntimeException("cannot load FSDirectory class: " + e.toString());
      }
      dir.init(file,create);
      DIRECTORIES.put(file,dir);
    }
 else     if (create) {
      dir.create();
    }
  }
synchronized (dir) {
    dir.refCount++;
  }
  return dir;
}
