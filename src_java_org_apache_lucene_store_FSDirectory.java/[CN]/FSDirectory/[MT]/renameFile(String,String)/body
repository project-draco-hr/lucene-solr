{
  File old=new File(directory,from);
  File nu=new File(directory,to);
  if (nu.exists())   if (!nu.delete())   throw new IOException("Cannot delete " + nu);
  if (!old.renameTo(nu)) {
    java.io.InputStream in=null;
    java.io.OutputStream out=null;
    try {
      in=new FileInputStream(old);
      out=new FileOutputStream(nu);
      if (buffer == null) {
        buffer=new byte[1024];
      }
      int len;
      while ((len=in.read(buffer)) >= 0) {
        out.write(buffer,0,len);
      }
      old.delete();
    }
 catch (    IOException ioe) {
      IOException newExc=new IOException("Cannot rename " + old + " to "+ nu);
      newExc.initCause(ioe);
      throw newExc;
    }
 finally {
      if (in != null) {
        try {
          in.close();
        }
 catch (        IOException e) {
          throw new RuntimeException("Cannot close input stream: " + e.toString(),e);
        }
      }
      if (out != null) {
        try {
          out.close();
        }
 catch (        IOException e) {
          throw new RuntimeException("Cannot close output stream: " + e.toString(),e);
        }
      }
    }
  }
}
