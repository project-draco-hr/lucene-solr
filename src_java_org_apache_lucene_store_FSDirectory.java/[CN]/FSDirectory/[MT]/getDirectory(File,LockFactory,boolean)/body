{
  file=new File(file.getCanonicalPath());
  if (file.exists() && !file.isDirectory())   throw new IOException(file + " not a directory");
  if (!file.exists())   if (!file.mkdirs())   throw new IOException("Cannot create directory: " + file);
  FSDirectory dir;
synchronized (DIRECTORIES) {
    dir=(FSDirectory)DIRECTORIES.get(file);
    if (dir == null) {
      try {
        dir=(FSDirectory)IMPL.newInstance();
      }
 catch (      Exception e) {
        throw new RuntimeException("cannot load FSDirectory class: " + e.toString(),e);
      }
      dir.init(file,lockFactory,doSync);
      DIRECTORIES.put(file,dir);
    }
 else {
      if (lockFactory != null && lockFactory != dir.getLockFactory()) {
        throw new IOException("Directory was previously created with a different LockFactory instance; please pass null as the lockFactory instance and use setLockFactory to change it");
      }
    }
  }
synchronized (dir) {
    dir.refCount++;
  }
  return dir;
}
