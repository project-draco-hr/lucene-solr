{
  if (tag.isWildCard()) {
    if (!shard.isWildCard() && shardName.equals(shard.val))     return NOT_APPLICABLE;
    Object tagValueForThisNode=nodeVsTags.get(testNode).get(tag.name);
    int v=getNumberOfNodesWithSameTagVal(shard,nodeVsTags,shardVsNodeSet,shardName,new Condition(tag.name,tagValueForThisNode,EQUAL),phase);
    if (phase == Phase.ASSIGN || phase == Phase.FUZZY_ASSIGN)     v++;
    return replica.canMatch(v,phase) ? NODE_CAN_BE_ASSIGNED : CANNOT_ASSIGN_FAIL;
  }
 else {
    if (!shard.isWildCard() && !shardName.equals(shard.val))     return NOT_APPLICABLE;
    if (replica.isWildCard()) {
      Map<String,Object> tags=nodeVsTags.get(testNode);
      if (tag.canMatch(tags == null ? null : tags.get(tag.name),phase))       return NODE_CAN_BE_ASSIGNED;
 else       return CANNOT_ASSIGN_FAIL;
    }
 else {
      int v=getNumberOfNodesWithSameTagVal(shard,nodeVsTags,shardVsNodeSet,shardName,tag,phase);
      return replica.canMatch(v,phase) ? NODE_CAN_BE_ASSIGNED : CANNOT_ASSIGN_FAIL;
    }
  }
}
