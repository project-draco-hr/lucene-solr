{
  int countMatchingThisTagValue=0;
  for (  Map.Entry<String,Map<String,Integer>> entry : shardVsNodeSet.entrySet()) {
    if (shardCondition.val.equals(WILD_WILD_CARD) || entry.getKey().equals(shardName)) {
      Map<String,Integer> nodesInThisShard=shardVsNodeSet.get(shardCondition.val.equals(WILD_WILD_CARD) ? entry.getKey() : shardName);
      if (nodesInThisShard != null) {
        for (        Map.Entry<String,Integer> aNode : nodesInThisShard.entrySet()) {
          Map<String,Object> tagValues=nodeVsTags.get(aNode.getKey());
          if (tagValues == null)           continue;
          Object obj=tagValues.get(tag.name);
          if (tagCondition.canMatch(obj,phase))           countMatchingThisTagValue+=aNode.getValue();
        }
      }
    }
  }
  return countMatchingThisTagValue;
}
