{
  final Bits liveDocs=canIgnoreDeletedDocs ? null : reader.getLiveDocs();
  if (liveDocs == null) {
    return new DocIdSetIterator(){
      private int doc=-1;
      @Override public int docID(){
        return doc;
      }
      @Override public int nextDoc(){
        try {
          do {
            doc++;
          }
 while (!matchDoc(doc));
          return doc;
        }
 catch (        ArrayIndexOutOfBoundsException e) {
          return doc=NO_MORE_DOCS;
        }
      }
      @Override public int advance(      int target){
        try {
          doc=target;
          while (!matchDoc(doc)) {
            doc++;
          }
          return doc;
        }
 catch (        ArrayIndexOutOfBoundsException e) {
          return doc=NO_MORE_DOCS;
        }
      }
    }
;
  }
 else {
    final int maxDoc=reader.maxDoc();
    return new DocIdSetIterator(){
      private int doc=-1;
      @Override public int docID(){
        return doc;
      }
      @Override public int nextDoc(){
        do {
          doc++;
          if (doc >= maxDoc) {
            return doc=NO_MORE_DOCS;
          }
        }
 while (!liveDocs.get(doc) || !matchDoc(doc));
        return doc;
      }
      @Override public int advance(      int target){
        for (doc=target; doc < maxDoc; doc++) {
          if (liveDocs.get(doc) && matchDoc(doc)) {
            return doc;
          }
        }
        return doc=NO_MORE_DOCS;
      }
    }
;
  }
}
