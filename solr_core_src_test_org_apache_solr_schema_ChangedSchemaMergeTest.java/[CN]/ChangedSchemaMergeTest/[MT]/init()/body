{
  if (solrHomeDirectory.exists()) {
    FileUtils.deleteDirectory(solrHomeDirectory);
  }
  assertTrue("Failed to mkdirs workDir",solrHomeDirectory.mkdirs());
  File changed=new File(solrHomeDirectory,"changed");
  copyMinConf(changed,"name=changed");
  schemaFile=new File(new File(changed,"conf"),"schema.xml");
  FileUtils.writeStringToFile(schemaFile,withWhich,Charsets.UTF_8.toString());
  String discoveryXml="<solr></solr>";
  File solrXml=new File(solrHomeDirectory,"solr.xml");
  FileUtils.write(solrXml,discoveryXml,Charsets.UTF_8.toString());
  final CoreContainer cores=new CoreContainer(solrHomeDirectory.getAbsolutePath());
  cores.load();
  return cores;
}
