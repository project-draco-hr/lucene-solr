{
  ensureOpen();
  if (refCount.getAndDecrement() == 1) {
    boolean success=false;
    try {
      commit();
      doClose();
      success=true;
    }
  finally {
      if (!success) {
        refCount.incrementAndGet();
      }
    }
    readerFinished();
  }
}
