{
  final String fileName=IndexFileNames.segmentFileName(si.name,"",Lucene40SegmentInfoFormat.SI_EXTENSION);
  si.addFile(fileName);
  final IndexOutput output=dir.createOutput(fileName,ioContext);
  boolean success=false;
  try {
    CodecUtil.writeHeader(output,Lucene40SegmentInfoFormat.CODEC_NAME,Lucene40SegmentInfoFormat.VERSION_CURRENT);
    output.writeString(si.getVersion().toString());
    output.writeInt(si.getDocCount());
    output.writeByte((byte)(si.getUseCompoundFile() ? SegmentInfo.YES : SegmentInfo.NO));
    output.writeStringStringMap(si.getDiagnostics());
    output.writeStringStringMap(Collections.<String,String>emptyMap());
    output.writeStringSet(si.files());
    success=true;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(output);
      IOUtils.deleteFilesIgnoringExceptions(si.dir,fileName);
    }
 else {
      output.close();
    }
  }
}
