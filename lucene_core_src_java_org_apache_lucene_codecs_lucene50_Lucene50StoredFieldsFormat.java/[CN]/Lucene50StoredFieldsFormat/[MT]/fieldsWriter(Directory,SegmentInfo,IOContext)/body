{
  String previous=si.putAttribute(MODE_KEY,mode.name());
  if (previous != null) {
    throw new IllegalStateException("found existing value for " + MODE_KEY + " for segment: "+ si.name+ "old="+ previous+ ", new="+ mode.name());
  }
  return impl(mode).fieldsWriter(directory,si,context);
}
