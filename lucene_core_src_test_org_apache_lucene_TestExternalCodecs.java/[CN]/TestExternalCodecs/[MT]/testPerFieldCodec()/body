{
  final int NUM_DOCS=atLeast(173);
  if (VERBOSE) {
    System.out.println("TEST: NUM_DOCS=" + NUM_DOCS);
  }
  BaseDirectoryWrapper dir=newDirectory();
  dir.setCheckIndexOnClose(false);
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setCodec(new CustomPerFieldCodec()).setMergePolicy(newLogMergePolicy(3)));
  Document doc=new Document();
  doc.add(newTextField("field1","this field uses the standard codec as the test",Field.Store.NO));
  Field field2=newTextField("field2","this field uses the pulsing codec as the test",Field.Store.NO);
  doc.add(field2);
  Field idField=newStringField("id","",Field.Store.NO);
  doc.add(idField);
  for (int i=0; i < NUM_DOCS; i++) {
    idField.setStringValue("" + i);
    w.addDocument(doc);
    if ((i + 1) % 10 == 0) {
      w.commit();
    }
  }
  if (VERBOSE) {
    System.out.println("TEST: now delete id=77");
  }
  w.deleteDocuments(new Term("id","77"));
  IndexReader r=DirectoryReader.open(w,true);
  assertEquals(NUM_DOCS - 1,r.numDocs());
  IndexSearcher s=newSearcher(r);
  assertEquals(NUM_DOCS - 1,s.search(new TermQuery(new Term("field1","standard")),1).totalHits);
  assertEquals(NUM_DOCS - 1,s.search(new TermQuery(new Term("field2","pulsing")),1).totalHits);
  r.close();
  if (VERBOSE) {
    System.out.println("\nTEST: now delete 2nd doc");
  }
  w.deleteDocuments(new Term("id","44"));
  if (VERBOSE) {
    System.out.println("\nTEST: now force merge");
  }
  w.forceMerge(1);
  if (VERBOSE) {
    System.out.println("\nTEST: now open reader");
  }
  r=DirectoryReader.open(w,true);
  assertEquals(NUM_DOCS - 2,r.maxDoc());
  assertEquals(NUM_DOCS - 2,r.numDocs());
  s=newSearcher(r);
  assertEquals(NUM_DOCS - 2,s.search(new TermQuery(new Term("field1","standard")),1).totalHits);
  assertEquals(NUM_DOCS - 2,s.search(new TermQuery(new Term("field2","pulsing")),1).totalHits);
  assertEquals(1,s.search(new TermQuery(new Term("id","76")),1).totalHits);
  assertEquals(0,s.search(new TermQuery(new Term("id","77")),1).totalHits);
  assertEquals(0,s.search(new TermQuery(new Term("id","44")),1).totalHits);
  if (VERBOSE) {
    System.out.println("\nTEST: now close NRT reader");
  }
  r.close();
  w.shutdown();
  dir.close();
}
