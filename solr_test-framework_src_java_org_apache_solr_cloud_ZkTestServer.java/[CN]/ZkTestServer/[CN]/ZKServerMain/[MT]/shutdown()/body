{
  zooKeeperServer.shutdown();
  ZKDatabase zkDb=zooKeeperServer.getZKDatabase();
  if (cnxnFactory != null && cnxnFactory.getLocalPort() != 0) {
    waitForServerDown(getZkHost() + ":" + getPort(),5000);
  }
  if (cnxnFactory != null) {
    cnxnFactory.shutdown();
    try {
      cnxnFactory.join();
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
    }
  }
  if (zkDb != null) {
    zkDb.close();
  }
}
