{
  if (DEBUG) {
    System.out.println("\nFPR.nextDoc");
  }
  while (true) {
    if (DEBUG) {
      System.out.println("  docUpto=" + docUpto + " (of df="+ docFreq+ ") docBufferUpto="+ docBufferUpto);
    }
    if (docUpto == docFreq) {
      if (DEBUG) {
        System.out.println("  return doc=END");
      }
      return doc=NO_MORE_DOCS;
    }
    if (docBufferUpto == BLOCK_SIZE) {
      refillDocs();
    }
    if (DEBUG) {
      System.out.println("    accum=" + accum + " docDeltaBuffer["+ docBufferUpto+ "]="+ docDeltaBuffer[docBufferUpto]);
    }
    accum+=docDeltaBuffer[docBufferUpto];
    docUpto++;
    if (liveDocs == null || liveDocs.get(accum)) {
      doc=accum;
      freq=(int)freqBuffer[docBufferUpto];
      docBufferUpto++;
      if (DEBUG) {
        System.out.println("  return doc=" + doc + " freq="+ freq);
      }
      return doc;
    }
    if (DEBUG) {
      System.out.println("  doc=" + accum + " is deleted; try next doc");
    }
    docBufferUpto++;
  }
}
