{
  Directory directory=newDirectory();
  RandomIndexWriter writer=new RandomIndexWriter(random(),directory,newIndexWriterConfig(new MockAnalyzer(random())));
  int docs=atLeast(10);
  int[] docStates=buildIndex(writer,docs);
  int numDocsWithValue=0;
  for (int i=0; i < docStates.length; i++) {
    if (docStates[i] == 1) {
      numDocsWithValue++;
    }
  }
  IndexReader reader=DirectoryReader.open(directory);
  IndexSearcher searcher=newSearcher(reader);
  TopDocs search=searcher.search(new TermQuery(new Term("all","test")),new FieldValueFilter("some"),docs);
  assertEquals(search.totalHits,numDocsWithValue);
  ScoreDoc[] scoreDocs=search.scoreDocs;
  for (  ScoreDoc scoreDoc : scoreDocs) {
    assertEquals("value",reader.document(scoreDoc.doc).get("some"));
  }
  reader.close();
  directory.close();
}
