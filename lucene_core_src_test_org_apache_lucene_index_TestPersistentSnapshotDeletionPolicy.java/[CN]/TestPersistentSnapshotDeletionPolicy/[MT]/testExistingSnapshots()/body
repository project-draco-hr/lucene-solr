{
  int numSnapshots=3;
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,getConfig(random(),getDeletionPolicy()));
  PersistentSnapshotDeletionPolicy psdp=(PersistentSnapshotDeletionPolicy)writer.getConfig().getIndexDeletionPolicy();
  prepareIndexAndSnapshots(psdp,writer,numSnapshots);
  writer.close();
  psdp.close();
  psdp=new PersistentSnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy(),snapshotDir,OpenMode.APPEND,TEST_VERSION_CURRENT);
  IndexWriter iw=new IndexWriter(dir,getConfig(random(),psdp));
  psdp=(PersistentSnapshotDeletionPolicy)iw.getConfig().getIndexDeletionPolicy();
  iw.close();
  assertSnapshotExists(dir,psdp,numSnapshots,false);
  psdp.close();
  dir.close();
}
