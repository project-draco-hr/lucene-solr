{
  int numSnapshots=1;
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,getConfig(random(),getDeletionPolicy()));
  PersistentSnapshotDeletionPolicy psdp=(PersistentSnapshotDeletionPolicy)writer.getConfig().getIndexDeletionPolicy();
  prepareIndexAndSnapshots(psdp,writer,numSnapshots,"snapshot");
  writer.close();
  dir.close();
  try {
    new PersistentSnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy(),snapshotDir,OpenMode.APPEND,TEST_VERSION_CURRENT);
    fail("should not have reached here - the snapshots directory should be locked!");
  }
 catch (  LockObtainFailedException e) {
  }
 finally {
    psdp.close();
  }
  Map<String,String> snapshots=PersistentSnapshotDeletionPolicy.readSnapshotsInfo(snapshotDir);
  assertEquals("expected " + numSnapshots + " snapshots, got "+ snapshots.size(),numSnapshots,snapshots.size());
}
