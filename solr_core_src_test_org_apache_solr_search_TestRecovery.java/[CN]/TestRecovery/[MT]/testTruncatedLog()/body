{
  try {
    DirectUpdateHandler2.commitOnClose=false;
    final Semaphore logReplay=new Semaphore(0);
    final Semaphore logReplayFinish=new Semaphore(0);
    UpdateLog.testing_logReplayHook=new Runnable(){
      @Override public void run(){
        try {
          assertTrue(logReplay.tryAcquire(timeout,TimeUnit.SECONDS));
        }
 catch (        Exception e) {
          throw new RuntimeException(e);
        }
      }
    }
;
    UpdateLog.testing_logReplayFinishHook=new Runnable(){
      @Override public void run(){
        logReplayFinish.release();
      }
    }
;
    File logDir=h.getCore().getUpdateHandler().getUpdateLog().getLogDir();
    clearIndex();
    assertU(commit());
    assertU(adoc("id","1"));
    assertU(adoc("id","2"));
    assertU(adoc("id","3"));
    h.close();
    String[] files=UpdateLog.getLogList(logDir);
    Arrays.sort(files);
    RandomAccessFile raf=new RandomAccessFile(new File(logDir,files[files.length - 1]),"rw");
    raf.seek(raf.length());
    raf.writeLong(0xffffffffffffffffL);
    raf.writeChars("This should be appended to a good log file, representing a bad partially written record.");
    raf.close();
    logReplay.release(1000);
    logReplayFinish.drainPermits();
    ignoreException("OutOfBoundsException");
    createCore();
    assertTrue(logReplayFinish.tryAcquire(timeout,TimeUnit.SECONDS));
    resetExceptionIgnores();
    assertJQ(req("q","*:*"),"/response/numFound==3");
    updateJ(jsonAdd(sdoc("id","4","_version_","104")),params(SEEN_LEADER,SEEN_LEADER_VAL));
    updateJ(jsonAdd(sdoc("id","5","_version_","105")),params(SEEN_LEADER,SEEN_LEADER_VAL));
    updateJ(jsonAdd(sdoc("id","6","_version_","106")),params(SEEN_LEADER,SEEN_LEADER_VAL));
    assertJQ(req("qt","/get","getVersions","3"),"/versions==[106,105,104]");
  }
  finally {
    DirectUpdateHandler2.commitOnClose=true;
    UpdateLog.testing_logReplayHook=null;
    UpdateLog.testing_logReplayFinishHook=null;
  }
}
