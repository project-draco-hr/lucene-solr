{
  final LockFactory lf=dir.getLockFactory();
  String[] startFiles;
  try {
    dir.setLockFactory(new NoLockFactory());
    startFiles=dir.listAll();
    new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.UNLIMITED).close();
  }
  finally {
    dir.setLockFactory(lf);
  }
  String[] endFiles=dir.listAll();
  Arrays.sort(startFiles);
  Arrays.sort(endFiles);
  if (!Arrays.equals(startFiles,endFiles)) {
    fail(message + ": before delete:\n    " + arrayToString(startFiles)+ "\n  after delete:\n    "+ arrayToString(endFiles));
  }
}
