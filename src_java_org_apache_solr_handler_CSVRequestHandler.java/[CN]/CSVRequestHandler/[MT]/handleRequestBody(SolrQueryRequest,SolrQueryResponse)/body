{
  SolrParams params=req.getParams();
  UpdateRequestProcessorChain processorChain=req.getCore().getUpdateProcessingChain(params.get(UpdateParams.UPDATE_PROCESSOR));
  UpdateRequestProcessor processor=processorChain.createProcessor(req,rsp);
  try {
    CSVLoader loader=new SingleThreadedCSVLoader(req,processor);
    Iterable<ContentStream> streams=req.getContentStreams();
    if (streams == null) {
      if (!RequestHandlerUtils.handleCommit(processor,params,false)) {
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"missing content stream");
      }
    }
 else {
      for (      ContentStream stream : streams) {
        Reader reader=stream.getReader();
        try {
          loader.errHeader="CSVLoader: input=" + stream.getSourceInfo();
          loader.load(reader);
        }
  finally {
          IOUtils.closeQuietly(reader);
        }
      }
      RequestHandlerUtils.handleCommit(processor,params,false);
    }
  }
  finally {
    processor.finish();
  }
}
