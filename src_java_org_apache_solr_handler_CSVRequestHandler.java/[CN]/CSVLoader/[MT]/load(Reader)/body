{
  Reader reader=input;
  if (skipLines > 0) {
    if (!(reader instanceof BufferedReader)) {
      reader=new BufferedReader(reader);
    }
    BufferedReader r=(BufferedReader)reader;
    for (int i=0; i < skipLines; i++) {
      r.readLine();
    }
  }
  CSVParser parser=new CSVParser(reader,strategy);
  if (fieldnames == null) {
    fieldnames=parser.getLine();
    if (fieldnames == null) {
      throw new SolrException(400,"Expected fieldnames in CSV input");
    }
    prepareFields();
  }
  for (; ; ) {
    int line=parser.getLineNumber();
    String[] vals=parser.getLine();
    if (vals == null)     break;
    if (vals.length != fields.length) {
      input_err("expected " + fields.length + " values but got "+ vals.length,vals,line);
    }
    addDoc(line,vals);
  }
  if (params.getBool(COMMIT,true)) {
    handler.commit(new CommitUpdateCommand(false));
  }
}
