{
  boolean doExorcise=false;
  boolean doCrossCheckTermVectors=false;
  boolean verbose=false;
  boolean doChecksumsOnly=false;
  List<String> onlySegments=new ArrayList<>();
  String indexPath=null;
  String dirImpl=null;
  int i=0;
  while (i < args.length) {
    String arg=args[i];
    if ("-fast".equals(arg)) {
      doChecksumsOnly=true;
    }
 else     if ("-exorcise".equals(arg)) {
      doExorcise=true;
    }
 else     if ("-crossCheckTermVectors".equals(arg)) {
      doCrossCheckTermVectors=true;
    }
 else     if (arg.equals("-verbose")) {
      verbose=true;
    }
 else     if (arg.equals("-segment")) {
      if (i == args.length - 1) {
        System.out.println("ERROR: missing name for -segment option");
        return 1;
      }
      i++;
      onlySegments.add(args[i]);
    }
 else     if ("-dir-impl".equals(arg)) {
      if (i == args.length - 1) {
        System.out.println("ERROR: missing value for -dir-impl option");
        return 1;
      }
      i++;
      dirImpl=args[i];
    }
 else {
      if (indexPath != null) {
        System.out.println("ERROR: unexpected extra argument '" + args[i] + "'");
        return 1;
      }
      indexPath=args[i];
    }
    i++;
  }
  if (indexPath == null) {
    System.out.println("\nERROR: index path not specified");
    System.out.println("\nUsage: java org.apache.lucene.index.CheckIndex pathToIndex [-exorcise] [-crossCheckTermVectors] [-segment X] [-segment Y] [-dir-impl X]\n" + "\n" + "  -exorcise: actually write a new segments_N file, removing any problematic segments\n"+ "  -fast: just verify file checksums, omitting logical integrity checks\n"+ "  -crossCheckTermVectors: verifies that term vectors match postings; THIS IS VERY SLOW!\n"+ "  -codec X: when exorcising, codec to write the new segments_N file with\n"+ "  -verbose: print additional details\n"+ "  -segment X: only check the specified segments.  This can be specified multiple\n"+ "              times, to check more than one segment, eg '-segment _2 -segment _a'.\n"+ "              You can't use this with the -exorcise option\n"+ "  -dir-impl X: use a specific " + FSDirectory.class.getSimpleName() + " implementation. "+ "If no package is specified the "+ FSDirectory.class.getPackage().getName()+ " package will be used.\n"+ "\n"+ "**WARNING**: -exorcise *LOSES DATA*. This should only be used on an emergency basis as it will cause\n"+ "documents (perhaps many) to be permanently removed from the index.  Always make\n"+ "a backup copy of your index before running this!  Do not run this tool on an index\n"+ "that is actively being written to.  You have been warned!\n"+ "\n"+ "Run without -exorcise, this tool will open the index, report version information\n"+ "and report any exceptions it hits and what action it would take if -exorcise were\n"+ "specified.  With -exorcise, this tool will remove any segments that have issues and\n"+ "write a new segments_N file.  This means all documents contained in the affected\n"+ "segments will be removed.\n"+ "\n"+ "This tool exits with exit code 1 if the index cannot be opened or has any\n"+ "corruption, else 0.\n");
    return 1;
  }
  if (!assertsOn())   System.out.println("\nNOTE: testing will be more thorough if you run java with '-ea:org.apache.lucene...', so assertions are enabled");
  if (onlySegments.size() == 0)   onlySegments=null;
 else   if (doExorcise) {
    System.out.println("ERROR: cannot specify both -exorcise and -segment");
    return 1;
  }
  if (doChecksumsOnly && doCrossCheckTermVectors) {
    System.out.println("ERROR: cannot specify both -fast and -crossCheckTermVectors");
    return 1;
  }
  System.out.println("\nOpening index @ " + indexPath + "\n");
  Directory directory=null;
  Path path=Paths.get(indexPath);
  try {
    if (dirImpl == null) {
      directory=FSDirectory.open(path);
    }
 else {
      directory=CommandLineUtil.newFSDirectory(dirImpl,path);
    }
  }
 catch (  Throwable t) {
    System.out.println("ERROR: could not open directory \"" + indexPath + "\"; exiting");
    t.printStackTrace(System.out);
    return 1;
  }
  try (Directory dir=directory;CheckIndex checker=new CheckIndex(dir)){
    checker.setCrossCheckTermVectors(doCrossCheckTermVectors);
    checker.setChecksumsOnly(doChecksumsOnly);
    checker.setInfoStream(System.out,verbose);
    Status result=checker.checkIndex(onlySegments);
    if (result.missingSegments) {
      return 1;
    }
    if (!result.clean) {
      if (!doExorcise) {
        System.out.println("WARNING: would write new segments file, and " + result.totLoseDocCount + " documents would be lost, if -exorcise were specified\n");
      }
 else {
        System.out.println("WARNING: " + result.totLoseDocCount + " documents will be lost\n");
        System.out.println("NOTE: will write new segments file in 5 seconds; this will remove " + result.totLoseDocCount + " docs from the index. YOU WILL LOSE DATA. THIS IS YOUR LAST CHANCE TO CTRL+C!");
        for (int s=0; s < 5; s++) {
          Thread.sleep(1000);
          System.out.println("  " + (5 - s) + "...");
        }
        System.out.println("Writing...");
        checker.exorciseIndex(result);
        System.out.println("OK");
        System.out.println("Wrote new segments file \"" + result.newSegments.getSegmentsFileName() + "\"");
      }
    }
    System.out.println("");
    if (result.clean == true) {
      return 0;
    }
 else {
      return 1;
    }
  }
 }
