{
  if (!DirectoryReader.indexExists(dir)) {
    throw new IndexNotFoundException(dir.toString());
  }
  if (!deletePriorCommits) {
    final Collection<IndexCommit> commits=DirectoryReader.listCommits(dir);
    if (commits.size() > 1) {
      throw new IllegalArgumentException("This tool was invoked to not delete prior commit points, but the following commits were found: " + commits);
    }
  }
  iwc.setMergePolicy(new UpgradeIndexMergePolicy(iwc.getMergePolicy()));
  iwc.setIndexDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy());
  final IndexWriter w=new IndexWriter(dir,iwc);
  try {
    InfoStream infoStream=iwc.getInfoStream();
    if (infoStream.isEnabled("IndexUpgrader")) {
      infoStream.message("IndexUpgrader","Upgrading all pre-" + Version.LATEST + " segments of index directory '"+ dir+ "' to version "+ Version.LATEST+ "...");
    }
    w.forceMerge(1);
    if (infoStream.isEnabled("IndexUpgrader")) {
      infoStream.message("IndexUpgrader","All segments upgraded to version " + Version.LATEST);
    }
  }
  finally {
    w.close();
  }
}
