{
  int maxDoc=searcher.getIndexReader().maxDoc();
  TopDocs all;
  int pageSize=TestUtil.nextInt(random(),1,maxDoc * 2);
  if (VERBOSE) {
    System.out.println("\nassertQuery " + (iter++) + ": query="+ query+ " sort="+ sort+ " pageSize="+ pageSize);
  }
  final boolean doMaxScore=random().nextBoolean();
  final boolean doScores=random().nextBoolean();
  if (sort == null) {
    all=searcher.search(query,maxDoc);
  }
 else   if (sort == Sort.RELEVANCE) {
    all=searcher.search(query,maxDoc,sort,true,doMaxScore);
  }
 else {
    all=searcher.search(query,maxDoc,sort,doScores,doMaxScore);
  }
  if (VERBOSE) {
    System.out.println("  all.totalHits=" + all.totalHits);
    int upto=0;
    for (    ScoreDoc scoreDoc : all.scoreDocs) {
      System.out.println("    hit " + (upto++) + ": id="+ searcher.doc(scoreDoc.doc).get("id")+ " "+ scoreDoc);
    }
  }
  int pageStart=0;
  ScoreDoc lastBottom=null;
  while (pageStart < all.totalHits) {
    TopDocs paged;
    if (sort == null) {
      if (VERBOSE) {
        System.out.println("  iter lastBottom=" + lastBottom);
      }
      paged=searcher.searchAfter(lastBottom,query,pageSize);
    }
 else {
      if (VERBOSE) {
        System.out.println("  iter lastBottom=" + lastBottom);
      }
      if (sort == Sort.RELEVANCE) {
        paged=searcher.searchAfter(lastBottom,query,pageSize,sort,true,doMaxScore);
      }
 else {
        paged=searcher.searchAfter(lastBottom,query,pageSize,sort,doScores,doMaxScore);
      }
    }
    if (VERBOSE) {
      System.out.println("    " + paged.scoreDocs.length + " hits on page");
    }
    if (paged.scoreDocs.length == 0) {
      break;
    }
    assertPage(pageStart,all,paged);
    pageStart+=paged.scoreDocs.length;
    lastBottom=paged.scoreDocs[paged.scoreDocs.length - 1];
  }
  assertEquals(all.scoreDocs.length,pageStart);
}
