{
  numRequests.incrementAndGet();
  TimerContext timer=requestTimes.time();
  try {
    if (pluginInfo != null && pluginInfo.attributes.containsKey(USEPARAM))     req.getContext().put(USEPARAM,pluginInfo.attributes.get(USEPARAM));
    SolrPluginUtils.setDefaults(this,req,defaults,appends,invariants);
    req.getContext().remove(USEPARAM);
    rsp.setHttpCaching(httpCaching);
    handleRequestBody(req,rsp);
    NamedList header=rsp.getResponseHeader();
    if (header != null) {
      Object partialResults=header.get("partialResults");
      boolean timedOut=partialResults == null ? false : (Boolean)partialResults;
      if (timedOut) {
        numTimeouts.incrementAndGet();
        rsp.setHttpCaching(false);
      }
    }
  }
 catch (  Exception e) {
    if (e instanceof SolrException) {
      SolrException se=(SolrException)e;
      if (se.code() == SolrException.ErrorCode.CONFLICT.code) {
      }
 else {
        SolrException.log(log,e);
      }
    }
 else {
      SolrException.log(log,e);
      if (e instanceof SyntaxError) {
        e=new SolrException(SolrException.ErrorCode.BAD_REQUEST,e);
      }
    }
    rsp.setException(e);
    numErrors.incrementAndGet();
  }
 finally {
    timer.stop();
  }
}
