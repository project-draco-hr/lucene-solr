{
  TimerContext time=stats.time(dir + "_offer");
  try {
    String path=createData(dir + "/" + PREFIX,data,CreateMode.PERSISTENT_SEQUENTIAL);
    String watchID=createData(dir + "/" + response_prefix+ path.substring(path.lastIndexOf("-") + 1),null,CreateMode.EPHEMERAL);
    Object lock=new Object();
    LatchWatcher watcher=new LatchWatcher(lock);
synchronized (lock) {
      if (zookeeper.exists(watchID,watcher,true) != null) {
        watcher.await(timeout);
      }
    }
    byte[] bytes=zookeeper.getData(watchID,null,null,true);
    zookeeper.delete(watchID,-1,true);
    return new QueueEvent(watchID,bytes,watcher.getWatchedEvent());
  }
  finally {
    time.stop();
  }
}
