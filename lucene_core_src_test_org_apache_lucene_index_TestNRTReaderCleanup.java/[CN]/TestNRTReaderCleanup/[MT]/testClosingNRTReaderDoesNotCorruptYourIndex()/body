{
  assumeFalse("this test can't run on Windows",Constants.WINDOWS);
  MockDirectoryWrapper dir=newMockDirectory();
  dir.setPreventDoubleWrite(false);
  IndexWriterConfig iwc=newIndexWriterConfig(new MockAnalyzer(random()));
  LogMergePolicy lmp=new LogDocMergePolicy();
  lmp.setMergeFactor(2);
  iwc.setMergePolicy(lmp);
  RandomIndexWriter w=new RandomIndexWriter(random(),dir,iwc);
  Document doc=new Document();
  doc.add(new TextField("a","foo",Field.Store.NO));
  w.addDocument(doc);
  w.commit();
  w.addDocument(doc);
  IndexReader r=w.getReader();
  w.close();
  dir.deleteFiles(Arrays.asList(dir.listAll()));
  w=new RandomIndexWriter(random(),dir);
  w.addDocument(doc);
  w.close();
  r.close();
  dir.close();
}
