{
  Scorer scorer=weight.scorer(reader);
  if (scorer == null)   return new TopFieldDocs(0,new ScoreDoc[0],sort.fields,Float.NEGATIVE_INFINITY);
  final BitSet bits=filter != null ? filter.bits(reader) : null;
  final FieldSortedHitQueue hq=new FieldSortedHitQueue(reader,sort.fields,nDocs);
  final int[] totalHits=new int[1];
  scorer.score(new HitCollector(){
    public final void collect(    int doc,    float score){
      if (score > 0.0f && (bits == null || bits.get(doc))) {
        totalHits[0]++;
        hq.insert(new FieldDoc(doc,score));
      }
    }
  }
);
  ScoreDoc[] scoreDocs=new ScoreDoc[hq.size()];
  for (int i=hq.size() - 1; i >= 0; i--)   scoreDocs[i]=hq.fillFields((FieldDoc)hq.pop());
  return new TopFieldDocs(totalHits[0],scoreDocs,hq.getFields(),hq.getMaxScore());
}
