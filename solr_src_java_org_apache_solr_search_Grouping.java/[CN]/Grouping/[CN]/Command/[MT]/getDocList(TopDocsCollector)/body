{
  int max=collector.getTotalHits();
  int off=groupOffset;
  int len=docsPerGroup;
  if (format == Format.Simple) {
    off=offset;
    len=numGroups;
  }
  int docsToCollect=getMax(off,len,max);
  TopDocs topDocs=collector.topDocs(0,Math.max(docsToCollect,1));
  int docsCollected=Math.min(docsToCollect,topDocs.scoreDocs.length);
  int ids[]=new int[docsCollected];
  float[] scores=needScores ? new float[docsCollected] : null;
  for (int i=0; i < ids.length; i++) {
    ids[i]=topDocs.scoreDocs[i].doc;
    if (scores != null)     scores[i]=topDocs.scoreDocs[i].score;
  }
  float score=topDocs.getMaxScore();
  maxScore=Math.max(maxScore,score);
  DocSlice docs=new DocSlice(off,Math.max(0,ids.length - off),ids,scores,topDocs.totalHits,score);
  if (getDocList) {
    DocIterator iter=docs.iterator();
    while (iter.hasNext())     idSet.add(iter.nextDoc());
  }
  return docs;
}
