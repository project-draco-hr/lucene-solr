{
  if (isLocked()) {
    return false;
  }
  if (!lockDir.exists()) {
    if (!lockDir.mkdirs())     throw new IOException("Cannot create directory: " + lockDir.getAbsolutePath());
  }
 else   if (!lockDir.isDirectory()) {
    throw new IOException("Found regular file where directory expected: " + lockDir.getAbsolutePath());
  }
  f=new RandomAccessFile(path,"rw");
  try {
    channel=f.getChannel();
    try {
      try {
        lock=channel.tryLock();
      }
 catch (      IOException e) {
        failureReason=e;
      }
    }
  finally {
      if (lock == null) {
        try {
          channel.close();
        }
  finally {
          channel=null;
        }
      }
    }
  }
  finally {
    if (channel == null) {
      try {
        f.close();
      }
  finally {
        f=null;
      }
    }
  }
  return lock != null;
}
