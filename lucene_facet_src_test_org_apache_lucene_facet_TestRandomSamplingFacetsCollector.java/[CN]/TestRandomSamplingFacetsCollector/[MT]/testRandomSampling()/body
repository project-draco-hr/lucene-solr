{
  Directory dir=newDirectory();
  Directory taxoDir=newDirectory();
  DirectoryTaxonomyWriter taxoWriter=new DirectoryTaxonomyWriter(taxoDir);
  RandomIndexWriter writer=new RandomIndexWriter(random(),dir);
  FacetsConfig config=new FacetsConfig();
  int numDocs=atLeast(10000);
  for (int i=0; i < numDocs; i++) {
    Document doc=new Document();
    doc.add(new StringField("EvenOdd",(i % 2 == 0) ? "even" : "odd",Store.NO));
    doc.add(new FacetField("iMod10",String.valueOf(i % 10)));
    writer.addDocument(config.build(taxoWriter,doc));
  }
  Random random=random();
  IndexSearcher searcher=newSearcher(writer.getReader());
  TaxonomyReader taxoReader=new DirectoryTaxonomyReader(taxoWriter);
  writer.close();
  IOUtils.close(taxoWriter);
  RandomSamplingFacetsCollector collectRandomZeroResults=new RandomSamplingFacetsCollector(numDocs / 10,random.nextLong());
  searcher.search(new TermQuery(new Term("EvenOdd","NeverMatches")),collectRandomZeroResults);
  assertNotNull(collectRandomZeroResults.getMatchingDocs());
  for (  MatchingDocs doc : collectRandomZeroResults.getMatchingDocs()) {
    assertEquals(0,doc.totalHits);
  }
  TermQuery query=new TermQuery(new Term("EvenOdd","even"));
  int maxNumChildren=5;
  RandomSamplingFacetsCollector random100Percent=new RandomSamplingFacetsCollector(numDocs,random.nextLong());
  RandomSamplingFacetsCollector random10Percent=new RandomSamplingFacetsCollector(numDocs / 10,random.nextLong());
  FacetsCollector fc=new FacetsCollector();
  searcher.search(query,MultiCollector.wrap(fc,random100Percent,random10Percent));
  FastTaxonomyFacetCounts random10FacetCounts=new FastTaxonomyFacetCounts(taxoReader,config,random10Percent);
  FastTaxonomyFacetCounts random100FacetCounts=new FastTaxonomyFacetCounts(taxoReader,config,random100Percent);
  FastTaxonomyFacetCounts exactFacetCounts=new FastTaxonomyFacetCounts(taxoReader,config,fc);
  FacetResult random10Result=random10Percent.amortizeFacetCounts(random10FacetCounts.getTopChildren(10,"iMod10"),config,searcher);
  FacetResult random100Result=random100FacetCounts.getTopChildren(10,"iMod10");
  FacetResult exactResult=exactFacetCounts.getTopChildren(10,"iMod10");
  assertEquals(random100Result,exactResult);
  assertTrue(random10Result.childCount <= maxNumChildren);
  assertTrue(random10Result.childCount >= 1);
  int sum=0;
  for (  LabelAndValue lav : random10Result.labelValues) {
    sum+=lav.value.intValue();
  }
  float mu=(float)sum / (float)maxNumChildren;
  float variance=0;
  for (  LabelAndValue lav : random10Result.labelValues) {
    variance+=Math.pow((mu - lav.value.intValue()),2);
  }
  variance=variance / maxNumChildren;
  float sigma=(float)Math.sqrt(variance);
  float targetMu=numDocs / (5.0f * 2.0f);
  assertTrue(sigma < 200);
  assertTrue(targetMu - 3 * sigma < mu && mu < targetMu + 3 * sigma);
  IOUtils.close(searcher.getIndexReader(),taxoReader,dir,taxoDir);
}
