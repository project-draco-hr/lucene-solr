{
  OpenBitSet bits=new OpenBitSet(reader.maxDoc());
  bits.set(0,reader.maxDoc());
  final Bits delDocs=MultiFields.getDeletedDocs(reader);
  Terms terms=reader.fields().terms(fieldName);
  if (terms != null) {
    TermsEnum termsEnum=terms.iterator();
    DocsEnum docs=null;
    while (true) {
      BytesRef currTerm=termsEnum.next();
      if (currTerm == null) {
        break;
      }
 else {
        if (termsEnum.docFreq() > 1) {
          docs=termsEnum.docs(delDocs,docs);
          int doc=docs.nextDoc();
          if (doc != DocsEnum.NO_MORE_DOCS) {
            if (keepMode == KM_USE_FIRST_OCCURRENCE) {
              doc=docs.nextDoc();
            }
          }
          int lastDoc=-1;
          while (true) {
            lastDoc=doc;
            bits.clear(lastDoc);
            doc=docs.nextDoc();
            if (doc == DocsEnum.NO_MORE_DOCS) {
              break;
            }
          }
          if (keepMode == KM_USE_LAST_OCCURRENCE) {
            bits.set(lastDoc);
          }
        }
      }
    }
  }
  return bits;
}
