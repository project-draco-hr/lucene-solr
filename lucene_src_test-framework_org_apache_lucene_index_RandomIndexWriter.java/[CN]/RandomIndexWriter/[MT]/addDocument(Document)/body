{
  if (doDocValues) {
    randomPerDocFieldValues(r,doc);
  }
  if (r.nextInt(5) == 3) {
    w.addDocuments(new Iterable<Document>(){
      @Override public Iterator<Document> iterator(){
        return new Iterator<Document>(){
          boolean done;
          @Override public boolean hasNext(){
            return !done;
          }
          @Override public void remove(){
            throw new UnsupportedOperationException();
          }
          @Override public Document next(){
            if (done) {
              throw new IllegalStateException();
            }
            done=true;
            return doc;
          }
        }
;
      }
    }
);
  }
 else {
    w.addDocument(doc);
  }
  maybeCommit();
}
