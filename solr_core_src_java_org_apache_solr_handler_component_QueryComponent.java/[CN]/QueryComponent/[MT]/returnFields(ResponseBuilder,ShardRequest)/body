{
  if ((sreq.purpose & ShardRequest.PURPOSE_GET_FIELDS) != 0) {
    boolean returnScores=(rb.getFieldFlags() & SolrIndexSearcher.GET_SCORES) != 0;
    String keyFieldName=rb.req.getSchema().getUniqueKeyField().getName();
    boolean removeKeyField=!rb.rsp.getReturnFields().wantsField(keyFieldName);
    for (    ShardResponse srsp : sreq.responses) {
      SolrDocumentList docs=(SolrDocumentList)srsp.getSolrResponse().getResponse().get("response");
      for (      SolrDocument doc : docs) {
        Object id=doc.getFieldValue(keyFieldName);
        ShardDoc sdoc=rb.resultIds.get(id.toString());
        if (sdoc != null) {
          if (returnScores && sdoc.score != null) {
            doc.setField("score",sdoc.score);
          }
          if (removeKeyField) {
            doc.removeFields(keyFieldName);
          }
          rb._responseDocs.set(sdoc.positionInResponse,doc);
        }
      }
    }
  }
}
