{
  ShardRequest sreq=new ShardRequest();
  sreq.purpose=ShardRequest.PURPOSE_GET_TOP_IDS;
  String keyFieldName=rb.req.getSchema().getUniqueKeyField().getName();
  ReturnFields fields=rb.rsp.getReturnFields();
  boolean distribSinglePass=rb.req.getParams().getBool(ShardParams.DISTRIB_SINGLE_PASS,false);
  if (distribSinglePass || (fields != null && fields.wantsField(keyFieldName) && fields.getRequestedFieldNames() != null && (!fields.hasPatternMatching() && Arrays.asList(keyFieldName,"score").containsAll(fields.getRequestedFieldNames())))) {
    sreq.purpose|=ShardRequest.PURPOSE_GET_FIELDS;
    rb.onePassDistributedQuery=true;
  }
  sreq.params=new ModifiableSolrParams(rb.req.getParams());
  sreq.params.remove(ShardParams.SHARDS);
  if (rb.shards_start > -1) {
    sreq.params.set(CommonParams.START,rb.shards_start);
  }
 else {
    sreq.params.set(CommonParams.START,"0");
  }
  if (rb.shards_rows > -1) {
    sreq.params.set(CommonParams.ROWS,rb.shards_rows);
  }
 else {
    sreq.params.set(CommonParams.ROWS,rb.getSortSpec().getOffset() + rb.getSortSpec().getCount());
  }
  sreq.params.set(ResponseBuilder.FIELD_SORT_VALUES,"true");
  boolean shardQueryIncludeScore=(rb.getFieldFlags() & SolrIndexSearcher.GET_SCORES) != 0 || rb.getSortSpec().includesScore();
  if (shardQueryIncludeScore) {
    sreq.params.set(CommonParams.FL,rb.req.getSchema().getUniqueKeyField().getName() + ",score");
    StatsCache statsCache=rb.req.getCore().getStatsCache();
    statsCache.sendGlobalStats(rb,sreq);
  }
 else {
    sreq.params.set(CommonParams.FL,rb.req.getSchema().getUniqueKeyField().getName());
  }
  if (distribSinglePass) {
    String[] fls=rb.req.getParams().getParams(CommonParams.FL);
    if (fls != null && fls.length > 0 && (fls.length != 1 || !fls[0].isEmpty())) {
      sreq.params.set(CommonParams.FL,fls);
    }
 else {
      sreq.params.set(CommonParams.FL,"*");
    }
  }
  StringBuilder additionalFL=new StringBuilder();
  boolean additionalAdded=false;
  if (!distribSinglePass || !fields.wantsField(keyFieldName))   additionalAdded=addFL(additionalFL,keyFieldName,additionalAdded);
  if ((!distribSinglePass || !fields.wantsScore()) && shardQueryIncludeScore)   additionalAdded=addFL(additionalFL,"score",additionalAdded);
  if (additionalAdded)   sreq.params.add(CommonParams.FL,additionalFL.toString());
  rb.addRequest(this,sreq);
}
