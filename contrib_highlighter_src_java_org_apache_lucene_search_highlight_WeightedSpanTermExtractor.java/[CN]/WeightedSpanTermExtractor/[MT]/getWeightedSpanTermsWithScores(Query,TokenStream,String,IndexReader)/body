{
  this.fieldName=fieldName;
  this.tokenStream=tokenStream;
  Map terms=new PositionCheckingMap();
  extract(query,terms);
  int totalNumDocs=reader.numDocs();
  Set weightedTerms=terms.keySet();
  Iterator it=weightedTerms.iterator();
  try {
    while (it.hasNext()) {
      WeightedSpanTerm weightedSpanTerm=(WeightedSpanTerm)terms.get(it.next());
      int docFreq=reader.docFreq(new Term(fieldName,weightedSpanTerm.term));
      if (totalNumDocs < docFreq) {
        docFreq=totalNumDocs;
      }
      float idf=(float)(Math.log((float)totalNumDocs / (double)(docFreq + 1)) + 1.0);
      weightedSpanTerm.weight*=idf;
    }
  }
  finally {
    closeReaders();
  }
  return terms;
}
