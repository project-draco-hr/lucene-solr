{
  final File workDir=createTempDir().toFile();
  final CoreContainer cores=h.getCoreContainer();
  final CoreAdminHandler admin=new CoreAdminHandler(cores);
  Path instDir;
  try (SolrCore template=cores.getCore("collection1")){
    assertNotNull(template);
    instDir=template.getCoreDescriptor().getInstanceDir();
  }
   assertTrue("instDir doesn't exist: " + instDir,Files.exists(instDir));
  final File instPropFile=new File(workDir,"instProp");
  FileUtils.copyDirectory(instDir.toFile(),instPropFile);
  SolrQueryResponse resp=new SolrQueryResponse();
  try {
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.CREATE.toString(),CoreAdminParams.INSTANCE_DIR,instPropFile.getAbsolutePath(),CoreAdminParams.NAME,"ugly$core=name"),resp);
  }
 catch (  SolrException se) {
    assertTrue("Expected error message for bad core name.",se.toString().contains("Invalid name"));
  }
  CoreDescriptor cd=cores.getCoreDescriptor("ugly$core=name");
  assertNull("Should NOT have added this core!",cd);
  admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.CREATE.toString(),CoreAdminParams.INSTANCE_DIR,instPropFile.getAbsolutePath(),CoreAdminParams.NAME,"props",CoreAdminParams.PROPERTY_PREFIX + "hoss","man",CoreAdminParams.PROPERTY_PREFIX + "foo","baz"),resp);
  assertNull("Exception on create",resp.getException());
  cd=cores.getCoreDescriptor("props");
  assertNotNull("Core not added!",cd);
  assertEquals(cd.getCoreProperty("hoss",null),"man");
  assertEquals(cd.getCoreProperty("foo",null),"baz");
  ignoreException("Could not load config");
  try {
    resp=new SolrQueryResponse();
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.CREATE.toString(),CoreAdminParams.NAME,"bogus_dir_core",CoreAdminParams.INSTANCE_DIR,"dir_does_not_exist_127896"),resp);
    fail("bogus collection created ok");
  }
 catch (  SolrException e) {
  }
  unIgnoreException("Could not load config");
  resp=new SolrQueryResponse();
  admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.STATUS.toString(),CoreAdminParams.CORE,"bogus_dir_core"),resp);
  Map<String,Exception> failures=(Map<String,Exception>)resp.getValues().get("initFailures");
  assertNotNull("core failures is null",failures);
  NamedList<Object> status=(NamedList<Object>)resp.getValues().get("status");
  assertNotNull("core status is null",status);
  assertEquals("wrong number of core failures",1,failures.size());
  Exception fail=failures.get("bogus_dir_core");
  assertNotNull("null failure for test core",fail);
  assertTrue("init failure doesn't mention problem: " + fail.getCause().getMessage(),0 < fail.getCause().getMessage().indexOf("dir_does_not_exist"));
  assertEquals("bogus_dir_core status isn't empty",0,((NamedList)status.get("bogus_dir_core")).size());
  cd=cores.getCoreDescriptor("props");
  assertNotNull("Core disappeared!",cd);
  admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.RENAME.toString(),CoreAdminParams.CORE,"props",CoreAdminParams.OTHER,"rename_me"),resp);
  cd=cores.getCoreDescriptor("rename_me");
  assertNotNull("Core should have been renamed!",cd);
  try {
    admin.handleRequestBody(req(CoreAdminParams.ACTION,CoreAdminParams.CoreAdminAction.RENAME.toString(),CoreAdminParams.CORE,"rename_me",CoreAdminParams.OTHER,"bad$name"),resp);
  }
 catch (  SolrException e) {
    assertTrue("Expected error message for bad core name.",e.getMessage().contains("Invalid name"));
  }
  cd=cores.getCoreDescriptor("bad$name");
  assertNull("Core should NOT exist!",cd);
  cd=cores.getCoreDescriptor("rename_me");
  assertNotNull("Core should have been renamed!",cd);
}
