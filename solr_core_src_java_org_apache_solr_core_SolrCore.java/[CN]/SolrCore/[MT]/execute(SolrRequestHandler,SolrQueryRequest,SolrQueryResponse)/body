{
  if (handler == null) {
    String msg="Null Request Handler '" + req.getParams().get(CommonParams.QT) + "'";
    if (log.isWarnEnabled())     log.warn(logid + msg + ":"+ req);
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,msg);
  }
  final NamedList<Object> responseHeader=new SimpleOrderedMap<Object>();
  rsp.add("responseHeader",responseHeader);
  NamedList<Object> toLog=rsp.getToLog();
  if (!isTestLoggingFormat) {
    toLog.add("webapp",req.getContext().get("webapp"));
  }
  toLog.add(isTestLoggingFormat ? null : "path",req.getContext().get("path"));
  toLog.add(isTestLoggingFormat ? null : "params","{" + req.getParamString() + "}");
  handler.handleRequest(req,rsp);
  setResponseHeaderValues(handler,req,rsp);
  if (log.isInfoEnabled() && toLog.size() > 0) {
    StringBuilder sb=new StringBuilder();
    for (int i=0; i < toLog.size(); i++) {
      String name=toLog.getName(i);
      Object val=toLog.getVal(i);
      if (name != null) {
        sb.append(name).append('=');
      }
      sb.append(val).append(' ');
    }
    log.info(sb.toString());
  }
}
