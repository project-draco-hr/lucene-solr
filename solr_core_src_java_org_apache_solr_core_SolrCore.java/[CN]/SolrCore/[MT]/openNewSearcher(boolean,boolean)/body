{
  SolrIndexSearcher tmp;
  RefCounted<SolrIndexSearcher> newestSearcher=null;
  boolean nrt=solrConfig.reopenReaders && updateHandlerReopens;
  openSearcherLock.lock();
  try {
    String newIndexDir=getNewIndexDir();
    String indexDirFile=null;
    String newIndexDirFile=null;
    if (!nrt) {
      indexDirFile=getDirectoryFactory().normalize(getIndexDir());
      newIndexDirFile=getDirectoryFactory().normalize(newIndexDir);
    }
synchronized (searcherLock) {
      newestSearcher=realtimeSearcher;
      if (newestSearcher != null) {
        newestSearcher.incref();
      }
    }
    if (newestSearcher != null && solrConfig.reopenReaders && (nrt || indexDirFile.equals(newIndexDirFile))) {
      DirectoryReader newReader;
      DirectoryReader currentReader=newestSearcher.get().getIndexReader();
      if (updateHandlerReopens) {
        RefCounted<IndexWriter> writer=getUpdateHandler().getSolrCoreState().getIndexWriter(this);
        try {
          newReader=DirectoryReader.openIfChanged(currentReader,writer.get(),true);
        }
  finally {
          writer.decref();
        }
      }
 else {
        newReader=DirectoryReader.openIfChanged(currentReader);
      }
      if (newReader == null) {
        if (realtime) {
          newestSearcher.incref();
          return newestSearcher;
        }
        currentReader.incRef();
        newReader=currentReader;
      }
      tmp=new SolrIndexSearcher(this,schema,(realtime ? "realtime" : "main"),newReader,true,!realtime,true,directoryFactory);
    }
 else {
      if (newReaderCreator != null) {
        DirectoryReader newReader=newReaderCreator.call();
        tmp=new SolrIndexSearcher(this,schema,(realtime ? "realtime" : "main"),newReader,true,!realtime,true,directoryFactory);
      }
 else {
        tmp=new SolrIndexSearcher(this,newIndexDir,schema,getSolrConfig().indexConfig,"main",true,directoryFactory);
      }
    }
    List<RefCounted<SolrIndexSearcher>> searcherList=realtime ? _realtimeSearchers : _searchers;
    RefCounted<SolrIndexSearcher> newSearcher=newHolder(tmp,searcherList);
    newSearcher.incref();
synchronized (searcherLock) {
      if (realtimeSearcher != null) {
        realtimeSearcher.decref();
      }
      realtimeSearcher=newSearcher;
      searcherList.add(realtimeSearcher);
    }
    return newSearcher;
  }
 catch (  Exception e) {
    throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Error opening new searcher",e);
  }
 finally {
    openSearcherLock.unlock();
    if (newestSearcher != null) {
      newestSearcher.decref();
    }
  }
}
