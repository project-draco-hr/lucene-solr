{
  for (int i=0; i < 2 * RANDOM_MULTIPLIER; i++) {
    Set<String> fieldNames=new HashSet<String>();
    final int numFields=2 + (TEST_NIGHTLY ? random.nextInt(200) : random.nextInt(20));
    for (int j=0; j < numFields; j++) {
      fieldNames.add("field_" + j);
    }
    Directory base=buildRandomIndex(fieldNames.toArray(new String[0]),20 + random.nextInt(100),newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
    IndexWriter writer=new IndexWriter(base,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
    FieldNumberBiMap globalFieldMap=writer.segmentInfos.getOrLoadGlobalFieldNumberMap(base);
    Set<Entry<String,Integer>> entries=globalFieldMap.entries();
    writer.optimize();
    writer.commit();
    writer.close();
    Set<Entry<String,Integer>> afterOptmize=globalFieldMap.entries();
    assertEquals(entries,afterOptmize);
    base.close();
  }
}
