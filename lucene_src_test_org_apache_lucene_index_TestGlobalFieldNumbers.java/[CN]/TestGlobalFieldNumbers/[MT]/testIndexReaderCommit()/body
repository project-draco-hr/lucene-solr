{
  for (int i=0; i < (TEST_NIGHTLY ? 39 : 3); i++) {
    Directory dir=newDirectory();
{
      IndexWriterConfig config=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random));
      IndexWriter writer=new IndexWriter(dir,config);
      Document d=new Document();
      d.add(new Field("f1","d1 first field",Store.YES,Index.ANALYZED,TermVector.NO));
      d.add(new Field("f2","d1 second field",Store.YES,Index.ANALYZED,TermVector.NO));
      writer.addDocument(d);
      writer.commit();
      assertFNXFiles(dir,"1.fnx");
      d=new Document();
      d.add(new Field("f1","d2 first field",Store.YES,Index.ANALYZED,TermVector.NO));
      d.add(new Field("f3",new byte[]{1,2,3}));
      writer.addDocument(d);
      writer.commit();
      assertFNXFiles(dir,"2.fnx");
      writer.close();
      assertFNXFiles(dir,"2.fnx");
    }
    IndexReader reader=IndexReader.open(dir,false);
    reader.deleteDocument(0);
    reader.commit();
    reader.close();
    assertFNXFiles(dir,"2.fnx");
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
    writer.optimize();
    assertFalse(" field numbers got mixed up",writer.anyNonBulkMerges);
    writer.close();
    assertFNXFiles(dir,"2.fnx");
    dir.close();
  }
}
