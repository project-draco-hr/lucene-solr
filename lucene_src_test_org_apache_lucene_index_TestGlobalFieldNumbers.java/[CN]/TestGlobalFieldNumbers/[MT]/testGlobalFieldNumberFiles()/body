{
  int num=atLeast(3);
  for (int i=0; i < num; i++) {
    Directory dir=newDirectory();
{
      IndexWriterConfig config=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random));
      IndexWriter writer=new IndexWriter(dir,config);
      Document d=new Document();
      d.add(new Field("f1","d1 first field",TextField.TYPE_STORED));
      d.add(new Field("f2","d1 second field",TextField.TYPE_STORED));
      writer.addDocument(d);
      for (      String string : writer.getIndexFileNames()) {
        assertFalse(string.endsWith(".fnx"));
      }
      writer.commit();
      Collection<String> files=writer.getIndexFileNames();
      files.remove("_1.fnx");
      for (      String string : files) {
        assertFalse(string.endsWith(".fnx"));
      }
      assertFNXFiles(dir,"_1.fnx");
      d=new Document();
      d.add(new Field("f1","d2 first field",TextField.TYPE_STORED));
      d.add(new BinaryField("f3",new byte[]{1,2,3}));
      writer.addDocument(d);
      writer.commit();
      files=writer.getIndexFileNames();
      files.remove("_2.fnx");
      for (      String string : files) {
        assertFalse(string.endsWith(".fnx"));
      }
      writer.close();
      assertFNXFiles(dir,"_2.fnx");
    }
{
      IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
      Document d=new Document();
      d.add(new Field("f1","d3 first field",TextField.TYPE_STORED));
      d.add(new Field("f2","d3 second field",TextField.TYPE_STORED));
      d.add(new BinaryField("f3",new byte[]{1,2,3,4,5}));
      writer.addDocument(d);
      writer.close();
      Collection<String> files=writer.getIndexFileNames();
      files.remove("_2.fnx");
      for (      String string : files) {
        assertFalse(string.endsWith(".fnx"));
      }
      assertFNXFiles(dir,"_2.fnx");
    }
    IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setInfoStream(new FailOnNonBulkMergesInfoStream()));
    writer.forceMerge(1);
    writer.close();
    assertFNXFiles(dir,"_2.fnx");
    dir.close();
  }
}
