{
  crashed=true;
  openFiles=new HashMap<String,Integer>();
  Iterator<String> it=unSyncedFiles.iterator();
  unSyncedFiles=new HashSet<String>();
  int count=0;
  if (!(delegate instanceof RAMDirectory)) {
    while (it.hasNext()) {
      String name=it.next();
      if (count % 3 == 0) {
        deleteFile(name,true);
      }
 else       if (count % 3 == 1) {
        long length=fileLength(name);
        byte[] zeroes=new byte[256];
        long upto=0;
        IndexOutput out=delegate.createOutput(name);
        while (upto < length) {
          final int limit=(int)Math.min(length - upto,zeroes.length);
          out.writeBytes(zeroes,0,limit);
          upto+=limit;
        }
        out.close();
      }
 else       if (count % 3 == 2) {
        IndexOutput out=delegate.createOutput(name);
        out.setLength(fileLength(name) / 2);
        out.close();
      }
      count++;
    }
  }
 else {
    RAMDirectory ramDir=(RAMDirectory)delegate;
    while (it.hasNext()) {
      String name=it.next();
      RAMFile file=ramDir.fileMap.get(name);
      if (count % 3 == 0) {
        deleteFile(name,true);
      }
 else       if (count % 3 == 1) {
        final int numBuffers=file.numBuffers();
        for (int i=0; i < numBuffers; i++) {
          byte[] buffer=file.getBuffer(i);
          Arrays.fill(buffer,(byte)0);
        }
      }
 else       if (count % 3 == 2) {
        file.setLength(file.getLength() / 2);
      }
      count++;
    }
  }
}
