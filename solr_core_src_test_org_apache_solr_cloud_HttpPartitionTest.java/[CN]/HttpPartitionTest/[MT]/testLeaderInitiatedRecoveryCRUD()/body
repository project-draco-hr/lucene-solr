{
  String testCollectionName="c8n_crud_1x2";
  String shardId="shard1";
  createCollectionRetry(testCollectionName,1,2,1);
  cloudClient.setDefaultCollection(testCollectionName);
  Replica leader=cloudClient.getZkStateReader().getLeaderRetry(testCollectionName,shardId);
  JettySolrRunner leaderJetty=getJettyOnPort(getReplicaPort(leader));
  CoreContainer cores=((SolrDispatchFilter)leaderJetty.getDispatchFilter().getFilter()).getCores();
  ZkController zkController=cores.getZkController();
  assertNotNull("ZkController is null",zkController);
  Replica notLeader=ensureAllReplicasAreActive(testCollectionName,shardId,1,2,maxWaitSecsToSeeAllActive).get(0);
  ZkCoreNodeProps replicaCoreNodeProps=new ZkCoreNodeProps(notLeader);
  String replicaUrl=replicaCoreNodeProps.getCoreUrl();
  assertTrue(!zkController.isReplicaInRecoveryHandling(replicaUrl));
  assertTrue(zkController.ensureReplicaInLeaderInitiatedRecovery(testCollectionName,shardId,replicaCoreNodeProps,leader.getName(),false,true));
  assertTrue(zkController.isReplicaInRecoveryHandling(replicaUrl));
  Map<String,Object> lirStateMap=zkController.getLeaderInitiatedRecoveryStateObject(testCollectionName,shardId,notLeader.getName());
  assertNotNull(lirStateMap);
  assertSame(Replica.State.DOWN,Replica.State.getState((String)lirStateMap.get(ZkStateReader.STATE_PROP)));
  zkController.removeReplicaFromLeaderInitiatedRecoveryHandling(replicaUrl);
  assertTrue(!zkController.isReplicaInRecoveryHandling(replicaUrl));
  SolrZkClient zkClient=zkController.getZkClient();
  String znodePath=zkController.getLeaderInitiatedRecoveryZnodePath(testCollectionName,shardId,notLeader.getName());
  zkClient.setData(znodePath,"down".getBytes(StandardCharsets.UTF_8),true);
  lirStateMap=zkController.getLeaderInitiatedRecoveryStateObject(testCollectionName,shardId,notLeader.getName());
  assertNotNull(lirStateMap);
  assertSame(Replica.State.DOWN,Replica.State.getState((String)lirStateMap.get(ZkStateReader.STATE_PROP)));
  zkClient.delete(znodePath,-1,false);
  try {
    new CollectionAdminRequest.Delete().setCollectionName(testCollectionName).process(cloudClient);
  }
 catch (  Exception e) {
    log.warn("Could not delete collection {} after test completed",testCollectionName);
  }
}
