{
  if (rewrittenQuery != null) {
    return rewrittenQuery;
  }
  for (Iterator<FieldVals> iter=fieldVals.iterator(); iter.hasNext(); ) {
    FieldVals f=iter.next();
    addTerms(reader,f);
  }
  fieldVals.clear();
  BooleanQuery.Builder bq=new BooleanQuery.Builder();
  HashMap<Term,ArrayList<ScoreTerm>> variantQueries=new HashMap<>();
  int size=q.size();
  for (int i=0; i < size; i++) {
    ScoreTerm st=q.pop();
    ArrayList<ScoreTerm> l=variantQueries.get(st.fuzziedSourceTerm);
    if (l == null) {
      l=new ArrayList<>();
      variantQueries.put(st.fuzziedSourceTerm,l);
    }
    l.add(st);
  }
  for (Iterator<ArrayList<ScoreTerm>> iter=variantQueries.values().iterator(); iter.hasNext(); ) {
    ArrayList<ScoreTerm> variants=iter.next();
    if (variants.size() == 1) {
      ScoreTerm st=variants.get(0);
      Query tq=newTermQuery(reader,st.term);
      tq.setBoost(st.score);
      bq.add(tq,BooleanClause.Occur.SHOULD);
    }
 else {
      BooleanQuery.Builder termVariants=new BooleanQuery.Builder();
      termVariants.setDisableCoord(true);
      for (Iterator<ScoreTerm> iterator2=variants.iterator(); iterator2.hasNext(); ) {
        ScoreTerm st=iterator2.next();
        Query tq=newTermQuery(reader,st.term);
        tq.setBoost(st.score);
        termVariants.add(tq,BooleanClause.Occur.SHOULD);
      }
      bq.add(termVariants.build(),BooleanClause.Occur.SHOULD);
    }
  }
  Query q=bq.build();
  q.setBoost(getBoost());
  this.rewrittenQuery=q;
  return q;
}
