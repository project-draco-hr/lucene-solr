{
  Properties p=dataSourceProps.get(name);
  if (p == null)   p=config.dataSources.get(name);
  if (p == null)   p=dataSourceProps.get(null);
  if (p == null)   p=config.dataSources.get(null);
  if (p == null)   throw new DataImportHandlerException(DataImportHandlerException.SEVERE,"No dataSource :" + name + " available for entity :"+ key.name);
  String impl=p.getProperty(TYPE);
  DataSource dataSrc=null;
  if (impl == null) {
    dataSrc=new JdbcDataSource();
  }
 else {
    try {
      dataSrc=(DataSource)DocBuilder.loadClass(impl,getCore()).newInstance();
    }
 catch (    Exception e) {
      throw new DataImportHandlerException(DataImportHandlerException.SEVERE,"Invalid type for data source: " + impl,e);
    }
  }
  try {
    Properties copyProps=new Properties();
    copyProps.putAll(p);
    if (ctx == null)     ctx=new ContextImpl(key,null,dataSrc,0,Collections.EMPTY_MAP,new HashMap(),null,this);
    dataSrc.init(ctx,copyProps);
  }
 catch (  Exception e) {
    throw new DataImportHandlerException(DataImportHandlerException.SEVERE,"Failed to initialize DataSource: " + key.dataSource,e);
  }
  return dataSrc;
}
