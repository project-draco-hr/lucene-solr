{
  log.info("Creating new IndexWriter...");
  String coreName=core.getName();
synchronized (writerPauseLock) {
    if (closed) {
      throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"Already closed");
    }
    pauseWriter=true;
    log.info("Waiting until IndexWriter is unused... core=" + coreName);
    while (!writerFree) {
      try {
        writerPauseLock.wait(100);
      }
 catch (      InterruptedException e) {
      }
      if (closed) {
        throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"SolrCoreState already closed");
      }
    }
    try {
      if (indexWriter != null) {
        if (!rollback) {
          try {
            log.info("Closing old IndexWriter... core=" + coreName);
            indexWriter.close();
          }
 catch (          Exception e) {
            SolrException.log(log,"Error closing old IndexWriter. core=" + coreName,e);
          }
        }
 else {
          try {
            log.info("Rollback old IndexWriter... core=" + coreName);
            indexWriter.rollback();
          }
 catch (          Exception e) {
            SolrException.log(log,"Error rolling back old IndexWriter. core=" + coreName,e);
          }
        }
      }
      indexWriter=createMainIndexWriter(core,"DirectUpdateHandler2");
      log.info("New IndexWriter is ready to be used.");
      refCntWriter=null;
    }
  finally {
      pauseWriter=false;
      writerPauseLock.notifyAll();
    }
  }
}
