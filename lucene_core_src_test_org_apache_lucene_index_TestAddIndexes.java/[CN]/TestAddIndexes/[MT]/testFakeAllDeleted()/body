{
  Directory src=newDirectory(), dest=newDirectory();
  RandomIndexWriter w=new RandomIndexWriter(random(),src);
  w.addDocument(new Document());
  IndexReader allDeletedReader=new FilterAtomicReader(w.getReader().leaves().get(0).reader()){
    @Override public Bits getLiveDocs(){
      return new Bits.MatchNoBits(in.maxDoc());
    }
    @Override public boolean hasDeletions(){
      return true;
    }
    @Override public int numDocs(){
      return 0;
    }
  }
;
  w.close();
  w=new RandomIndexWriter(random(),dest);
  w.addIndexes(allDeletedReader);
  w.close();
  DirectoryReader dr=DirectoryReader.open(src);
  for (  AtomicReaderContext ctx : dr.leaves()) {
    assertTrue("empty segments should be dropped by addIndexes",ctx.reader().maxDoc() > 0);
  }
  dr.close();
  allDeletedReader.close();
  src.close();
  dest.close();
}
