{
  final State child=state.lastChild();
  if (child.hasChildren())   replaceOrRegister(child);
  final State registered=register.get(child);
  if (registered != null) {
    state.replaceLastChild(registered);
  }
 else {
    register.put(child,child);
  }
}
