{
  int startOffset=offsetAtt.startOffset();
  int minTokNum=gramSize.getValue() - 1;
  if (gramSize.getValue() == minShingleSize) {
    shingleBuilder.setLength(0);
    minTokNum=0;
  }
  for (int tokNum=minTokNum; tokNum < gramSize.getValue(); ++tokNum) {
    if (tokNum > 0) {
      shingleBuilder.append(tokenSeparator);
    }
    restoreState(inputWindow.get(tokNum));
    shingleBuilder.append(termAtt.termBuffer(),0,termAtt.termLength());
  }
  char[] termBuffer=termAtt.termBuffer();
  int termLength=shingleBuilder.length();
  if (termBuffer.length < termLength) {
    termBuffer=termAtt.resizeTermBuffer(termLength);
  }
  shingleBuilder.getChars(0,termLength,termBuffer,0);
  termAtt.setTermLength(termLength);
  posIncrAtt.setPositionIncrement(gramSize.atMinValue() ? 1 : 0);
  typeAtt.setType(tokenType);
  offsetAtt.setOffset(startOffset,offsetAtt.endOffset());
}
