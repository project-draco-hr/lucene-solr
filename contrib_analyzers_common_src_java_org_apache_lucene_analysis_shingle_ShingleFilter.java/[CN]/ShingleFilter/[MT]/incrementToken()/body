{
  while (true) {
    if (nextToken == null) {
      if (!fillShingleBuffer()) {
        return false;
      }
    }
    nextToken=(AttributeSource.State)shingleBuf.getFirst();
    if (shingleBufferPosition == 0 && (!shingleBuf.isEmpty()) && outputUnigrams) {
      restoreState(nextToken);
      posIncrAtt.setPositionIncrement(1);
      shingleBufferPosition++;
      return true;
    }
    if (shingleBufferPosition < shingleBuf.size()) {
      restoreState(nextToken);
      typeAtt.setType(tokenType);
      offsetAtt.setOffset(offsetAtt.startOffset(),endOffsets[shingleBufferPosition]);
      StringBuffer buf=shingles[shingleBufferPosition];
      int termLength=buf.length();
      char[] termBuffer=termAtt.termBuffer();
      if (termBuffer.length < termLength)       termBuffer=termAtt.resizeTermBuffer(termLength);
      buf.getChars(0,termLength,termBuffer,0);
      termAtt.setTermLength(termLength);
      if ((!outputUnigrams) && shingleBufferPosition == 1) {
        posIncrAtt.setPositionIncrement(1);
      }
 else {
        posIncrAtt.setPositionIncrement(0);
      }
      shingleBufferPosition++;
      if (shingleBufferPosition == shingleBuf.size()) {
        nextToken=null;
        shingleBufferPosition=0;
      }
      return true;
    }
 else {
      nextToken=null;
      shingleBufferPosition=0;
    }
  }
}
