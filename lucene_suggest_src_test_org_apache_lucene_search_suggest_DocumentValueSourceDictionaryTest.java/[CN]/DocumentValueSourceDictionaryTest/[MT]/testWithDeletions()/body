{
  Directory dir=newDirectory();
  IndexWriterConfig iwc=newIndexWriterConfig(new MockAnalyzer(random()));
  iwc.setMergePolicy(newLogMergePolicy());
  RandomIndexWriter writer=new RandomIndexWriter(random(),dir,iwc);
  Map<String,Document> docs=generateIndexDocuments(atLeast(100));
  Random rand=random();
  List<String> termsToDel=new ArrayList<>();
  for (  Document doc : docs.values()) {
    if (rand.nextBoolean() && termsToDel.size() < docs.size() - 1) {
      termsToDel.add(doc.get(FIELD_NAME));
    }
    writer.addDocument(doc);
  }
  writer.commit();
  Term[] delTerms=new Term[termsToDel.size()];
  for (int i=0; i < termsToDel.size(); i++) {
    delTerms[i]=new Term(FIELD_NAME,termsToDel.get(i));
  }
  for (  Term delTerm : delTerms) {
    writer.deleteDocuments(delTerm);
  }
  writer.commit();
  writer.close();
  for (  String termToDel : termsToDel) {
    assertTrue(null != docs.remove(termToDel));
  }
  IndexReader ir=DirectoryReader.open(dir);
  assertTrue("NumDocs should be > 0 but was " + ir.numDocs(),ir.numDocs() > 0);
  assertEquals(ir.numDocs(),docs.size());
  ValueSource[] toAdd=new ValueSource[]{new LongFieldSource(WEIGHT_FIELD_NAME_1),new LongFieldSource(WEIGHT_FIELD_NAME_2)};
  Dictionary dictionary=new DocumentValueSourceDictionary(ir,FIELD_NAME,new SumFloatFunction(toAdd),PAYLOAD_FIELD_NAME);
  InputIterator inputIterator=dictionary.getEntryIterator();
  BytesRef f;
  while ((f=inputIterator.next()) != null) {
    Document doc=docs.remove(f.utf8ToString());
    long w1=doc.getField(WEIGHT_FIELD_NAME_1).numericValue().longValue();
    long w2=doc.getField(WEIGHT_FIELD_NAME_2).numericValue().longValue();
    assertTrue(f.equals(new BytesRef(doc.get(FIELD_NAME))));
    assertEquals(inputIterator.weight(),w2 + w1);
    assertTrue(inputIterator.payload().equals(doc.getField(PAYLOAD_FIELD_NAME).binaryValue()));
  }
  assertTrue(docs.isEmpty());
  ir.close();
  dir.close();
}
