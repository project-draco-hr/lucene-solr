{
  a.expandSingleton();
  HashMap<State,HashSet<Transition>> m=new HashMap<>();
  State[] states=a.getNumberedStates();
  Set<State> accept=new HashSet<>();
  for (  State s : states)   if (s.isAccept())   accept.add(s);
  for (  State r : states) {
    m.put(r,new HashSet<Transition>());
    r.accept=false;
  }
  for (  State r : states)   for (  Transition t : r.getTransitions())   m.get(t.to).add(new Transition(t.min,t.max,r));
  for (  State r : states) {
    Set<Transition> tr=m.get(r);
    r.setTransitions(tr.toArray(new Transition[tr.size()]));
  }
  a.initial.accept=true;
  a.initial=new State();
  for (  State r : accept)   a.initial.addEpsilon(r);
  a.deterministic=false;
  a.clearNumberedStates();
  return accept;
}
