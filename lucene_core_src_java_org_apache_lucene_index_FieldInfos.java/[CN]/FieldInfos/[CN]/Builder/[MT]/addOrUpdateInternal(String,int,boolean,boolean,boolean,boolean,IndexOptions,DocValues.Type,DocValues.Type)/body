{
  FieldInfo fi=fieldInfo(name);
  if (fi == null) {
    final int fieldNumber=globalFieldNumbers.addOrGet(name,preferredFieldNumber,docValues);
    fi=addInternal(name,fieldNumber,isIndexed,storeTermVector,omitNorms,storePayloads,indexOptions,docValues,normType);
  }
 else {
    if (docValues != null) {
      DocValues.Type currentDVType=fi.getDocValuesType();
      if (currentDVType == null) {
        fi.setDocValuesType(docValues);
      }
 else       if (currentDVType != docValues) {
        throw new IllegalArgumentException("cannot change DocValues type from " + currentDVType + " to "+ docValues+ " for field \""+ name+ "\"");
      }
    }
    fi.update(isIndexed,storeTermVector,omitNorms,storePayloads,indexOptions);
    if (docValues != null) {
      fi.setDocValuesType(docValues);
    }
    if (!fi.omitsNorms() && normType != null) {
      fi.setNormValueType(normType);
    }
  }
  return fi;
}
