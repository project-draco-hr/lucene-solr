{
  ManagedIndexSchema newSchema=null;
  if (isMutable) {
    boolean success=false;
synchronized (getSchemaUpdateLock()) {
      newSchema=shallowCopy(true);
      for (      Map.Entry<String,Collection<String>> entry : copyFields.entrySet()) {
        for (        String destination : entry.getValue()) {
          newSchema.registerCopyField(entry.getKey(),destination);
        }
      }
      for (      SchemaAware aware : newSchema.schemaAware) {
        aware.inform(newSchema);
      }
      newSchema.refreshAnalyzers();
      success=newSchema.persistManagedSchema(false);
      if (success) {
        log.debug("Added copy fields for {} sources",copyFields.size());
      }
 else {
        log.error("Failed to add copy fields for {} sources",copyFields.size());
      }
    }
  }
  return newSchema;
}
