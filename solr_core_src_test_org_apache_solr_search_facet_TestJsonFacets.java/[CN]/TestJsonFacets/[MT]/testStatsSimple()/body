{
  assertU(delQ("*:*"));
  assertU(add(doc("id","1","cat_s","A","where_s","NY","num_d","4","num_i","2","val_b","true","sparse_s","one")));
  assertU(add(doc("id","2","cat_s","B","where_s","NJ","num_d","-9","num_i","-5","val_b","false")));
  assertU(add(doc("id","3")));
  assertU(commit());
  assertU(add(doc("id","4","cat_s","A","where_s","NJ","num_d","2","num_i","3")));
  assertU(add(doc("id","5","cat_s","B","where_s","NJ","num_d","11","num_i","7","sparse_s","two")));
  assertU(commit());
  assertU(add(doc("id","6","cat_s","B","where_s","NY","num_d","-5","num_i","-5")));
  assertU(commit());
  assertJQ(req("q","*:*","rows","0","json.facet","{x:'sum(num_d)'}","json.facet","{y:'min(num_d)'}"),"facets=={count:6 , x:3.0, y:-9.0 }");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream }}" + ", cat2:{terms:{field:'cat_s', method:stream, sort:'index asc' }}" + ", cat3:{terms:{field:'cat_s', method:stream, mincount:3 }}"+ ", cat4:{terms:{field:'cat_s', method:stream, prefix:B }}"+ ", cat5:{terms:{field:'cat_s', method:stream, offset:1 }}"+ " }"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2},{val:B, count:3}]}" + ", cat2:{buckets:[{val:A, count:2},{val:B, count:3}]}"+ ", cat3:{buckets:[{val:B, count:3}]}"+ ", cat4:{buckets:[{val:B, count:3}]}"+ ", cat5:{buckets:[{val:B, count:3}]}"+ " }");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', sort:'index asc', facet:{where:{terms:{field:where_s,method:stream}}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1},{val:NY,count:1}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2},{val:NY,count:1}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream, facet:{where:{terms:{field:where_s,method:stream}}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1},{val:NY,count:1}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2},{val:NY,count:1}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream, facet:{  where:{terms:{field:where_s,method:stream, facet:{x:'max(num_d)'}     }}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1,x:2.0},{val:NY,count:1,x:4.0}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2,x:11.0},{val:NY,count:1,x:-5.0}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","facet","true","json.facet","{   cat:{terms:{field:'cat_s', method:stream, facet:{ y:'min(num_d)',  where:{terms:{field:where_s,method:stream, facet:{x:'max(num_d)'}     }}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, y:2.0, where:{buckets:[{val:NJ,count:1,x:2.0},{val:NY,count:1,x:4.0}]}   },{val:B, count:3, y:-9.0, where:{buckets:[{val:NJ,count:2,x:11.0},{val:NY,count:1,x:-5.0}]}    }]}" + "}");
  assertJQ(req("q","*:*","fq","cat_s:A"),"response/numFound==2");
}
