{
  Client client=Client.localClient();
  indexSimple(client);
  assertJQ(req("q","*:*","rows","0","json.facet","{x:'sum(num_d)'}","json.facet","{y:'min(num_d)'}"),"facets=={count:6 , x:3.0, y:-9.0 }");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream }}" + ", cat2:{terms:{field:'cat_s', method:stream, sort:'index asc' }}" + ", cat3:{terms:{field:'cat_s', method:stream, sort:'index asc', mincount:3 }}"+ ", cat4:{terms:{field:'cat_s', method:stream, sort:'index asc', prefix:B }}"+ ", cat5:{terms:{field:'cat_s', method:stream, sort:'index asc', offset:1 }}"+ " }"),"facets=={count:6 " + ", cat :{buckets:[{val:B, count:3},{val:A, count:2}]}" + ", cat2:{buckets:[{val:A, count:2},{val:B, count:3}]}"+ ", cat3:{buckets:[{val:B, count:3}]}"+ ", cat4:{buckets:[{val:B, count:3}]}"+ ", cat5:{buckets:[{val:B, count:3}]}"+ " }");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', sort:'index asc', facet:{where:{terms:{field:where_s,method:stream,sort:'index asc'}}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1},{val:NY,count:1}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2},{val:NY,count:1}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream,sort:'index asc', facet:{where:{terms:{field:where_s,method:stream,sort:'index asc'}}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1},{val:NY,count:1}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2},{val:NY,count:1}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","json.facet","{   cat:{terms:{field:'cat_s', method:stream,sort:'index asc', facet:{  where:{terms:{field:where_s,method:stream,sort:'index asc',sort:'index asc', facet:{x:'max(num_d)'}     }}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, where:{buckets:[{val:NJ,count:1,x:2.0},{val:NY,count:1,x:4.0}]}   },{val:B, count:3, where:{buckets:[{val:NJ,count:2,x:11.0},{val:NY,count:1,x:-5.0}]}    }]}" + "}");
  assertJQ(req("q","*:*","rows","0","facet","true","json.facet","{   cat:{terms:{field:'cat_s', method:stream,sort:'index asc', facet:{ y:'min(num_d)',  where:{terms:{field:where_s,method:stream,sort:'index asc', facet:{x:'max(num_d)'}     }}}   }}}"),"facets=={count:6 " + ", cat :{buckets:[{val:A, count:2, y:2.0, where:{buckets:[{val:NJ,count:1,x:2.0},{val:NY,count:1,x:4.0}]}   },{val:B, count:3, y:-9.0, where:{buckets:[{val:NJ,count:2,x:11.0},{val:NY,count:1,x:-5.0}]}    }]}" + "}");
  assertJQ(req("q","*:*","fq","cat_s:A"),"response/numFound==2");
}
