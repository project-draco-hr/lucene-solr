{
  int numSnapshots=3;
  SnapshotDeletionPolicy sdp=getDeletionPolicy();
  Directory dir=newDirectory();
  IndexWriter writer=new IndexWriter(dir,getConfig(random,sdp));
  prepareIndexAndSnapshots(sdp,writer,numSnapshots,"snapshot");
  writer.close();
  assertSnapshotExists(dir,sdp,numSnapshots);
  IndexReader.open(sdp.getSnapshot("snapshot0")).close();
  sdp=getDeletionPolicy();
  writer=new IndexWriter(dir,getConfig(random,sdp));
  writer.deleteUnusedFiles();
  writer.close();
  assertEquals("no snapshots should exist",1,DirectoryReader.listCommits(dir).size());
  for (int i=0; i < numSnapshots; i++) {
    try {
      sdp.getSnapshot("snapshot" + i);
      fail("snapshot shouldn't have existed, but did: snapshot" + i);
    }
 catch (    IllegalStateException e) {
    }
  }
  dir.close();
}
