{
  Spans includeSpans=include.getSpans(context,acceptDocs,termContexts);
  if (includeSpans == null) {
    return null;
  }
  Spans excludeSpans=exclude.getSpans(context,acceptDocs,termContexts);
  if (excludeSpans == null) {
    return includeSpans;
  }
  TwoPhaseIterator excludeTwoPhase=excludeSpans.asTwoPhaseIterator();
  DocIdSetIterator excludeApproximation=excludeTwoPhase == null ? null : excludeTwoPhase.approximation();
  return new FilterSpans(includeSpans){
    int lastNonMatchingDoc=-1;
    @Override protected AcceptStatus accept(    Spans candidate) throws IOException {
      int doc=candidate.docID();
      if (doc > excludeSpans.docID()) {
        if (excludeTwoPhase != null) {
          if (excludeApproximation.advance(doc) == doc) {
            if (!excludeTwoPhase.matches()) {
              lastNonMatchingDoc=doc;
            }
          }
        }
 else {
          excludeSpans.advance(doc);
        }
      }
      if (doc == lastNonMatchingDoc || doc != excludeSpans.docID()) {
        return AcceptStatus.YES;
      }
      if (excludeSpans.startPosition() == -1) {
        excludeSpans.nextStartPosition();
      }
      while (excludeSpans.endPosition() <= candidate.startPosition() - pre) {
        if (excludeSpans.nextStartPosition() == NO_MORE_POSITIONS) {
          return AcceptStatus.YES;
        }
      }
      if (candidate.endPosition() + post <= excludeSpans.startPosition()) {
        return AcceptStatus.YES;
      }
 else {
        return AcceptStatus.NO;
      }
    }
  }
;
}
