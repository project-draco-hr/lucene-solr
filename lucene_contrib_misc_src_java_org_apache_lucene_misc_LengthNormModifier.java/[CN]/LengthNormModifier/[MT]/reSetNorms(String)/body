{
  String fieldName=StringHelper.intern(field);
  int[] termCounts=new int[0];
  IndexReader reader=IndexReader.open(dir,false);
  try {
    termCounts=new int[reader.maxDoc()];
    Bits delDocs=MultiFields.getDeletedDocs(reader);
    DocsEnum docs=null;
    Terms terms=MultiFields.getTerms(reader,field);
    if (terms != null) {
      TermsEnum termsEnum=terms.iterator();
      while (termsEnum.next() != null) {
        docs=termsEnum.docs(delDocs,docs);
        int doc;
        while ((doc=docs.nextDoc()) != DocsEnum.NO_MORE_DOCS) {
          termCounts[doc]+=docs.freq();
        }
      }
    }
    for (int d=0; d < termCounts.length; d++) {
      if (!reader.isDeleted(d)) {
        byte norm=Similarity.encodeNorm(sim.lengthNorm(fieldName,termCounts[d]));
        reader.setNorm(d,fieldName,norm);
      }
    }
  }
  finally {
    reader.close();
  }
}
