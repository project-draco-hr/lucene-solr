{
  final String fileName=IndexFileNames.segmentFileName(segment,"",segmentSuffix);
  IndexOutput output=dir.createOutput(fileName,ctx);
  boolean success=false;
  BytesRef spare=new BytesRef();
  try {
    SimpleTextUtil.write(output,getHeader());
    SimpleTextUtil.writeNewline(output);
    SimpleTextUtil.write(output,VALUE_SIZE);
    SimpleTextUtil.write(output,Integer.toString(this.fixedSize),scratch);
    SimpleTextUtil.writeNewline(output);
    prepareFlush(docCount);
    for (int i=0; i < docCount; i++) {
      SimpleTextUtil.write(output,DOC);
      SimpleTextUtil.write(output,Integer.toString(i),scratch);
      SimpleTextUtil.writeNewline(output);
      SimpleTextUtil.write(output,VALUE);
      writeDoc(output,i,spare);
      SimpleTextUtil.writeNewline(output);
    }
    SimpleTextUtil.write(output,END);
    SimpleTextUtil.writeNewline(output);
    success=true;
  }
  finally {
    hash.close();
    if (success) {
      IOUtils.close(output);
    }
 else {
      IOUtils.closeWhileHandlingException(output);
    }
  }
}
