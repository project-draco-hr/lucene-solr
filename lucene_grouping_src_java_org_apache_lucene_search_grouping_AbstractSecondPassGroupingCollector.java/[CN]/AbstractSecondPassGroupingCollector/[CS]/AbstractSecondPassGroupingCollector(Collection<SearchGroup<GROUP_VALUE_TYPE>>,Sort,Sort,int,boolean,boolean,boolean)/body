{
  if (groups.isEmpty()) {
    throw new IllegalArgumentException("no groups to collect (groups is empty)");
  }
  this.groups=Objects.requireNonNull(groups);
  this.groupSort=Objects.requireNonNull(groupSort);
  this.withinGroupSort=Objects.requireNonNull(withinGroupSort);
  this.maxDocsPerGroup=maxDocsPerGroup;
  this.needsScores=getScores || getMaxScores || withinGroupSort.needsScores();
  this.groupMap=new HashMap<>(groups.size());
  for (  SearchGroup<GROUP_VALUE_TYPE> group : groups) {
    final TopDocsCollector<?> collector;
    if (withinGroupSort.equals(Sort.RELEVANCE)) {
      collector=TopScoreDocCollector.create(maxDocsPerGroup);
    }
 else {
      collector=TopFieldCollector.create(withinGroupSort,maxDocsPerGroup,fillSortFields,getScores,getMaxScores);
    }
    groupMap.put(group.groupValue,new SearchGroupDocs<>(group.groupValue,collector));
  }
}
