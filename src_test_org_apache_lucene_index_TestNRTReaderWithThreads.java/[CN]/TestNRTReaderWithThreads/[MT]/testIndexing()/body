{
  Directory mainDir=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(mainDir,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)).setMaxBufferedDocs(10));
  ((LogMergePolicy)writer.getMergePolicy()).setMergeFactor(2);
  ((LogMergePolicy)writer.getMergePolicy()).setUseCompoundFile(false);
  ((LogMergePolicy)writer.getMergePolicy()).setUseCompoundDocStore(false);
  IndexReader reader=writer.getReader();
  reader.close();
  RunThread[] indexThreads=new RunThread[4];
  for (int x=0; x < indexThreads.length; x++) {
    indexThreads[x]=new RunThread(x % 2,writer);
    indexThreads[x].setName("Thread " + x);
    indexThreads[x].start();
  }
  long startTime=System.currentTimeMillis();
  long duration=1000;
  while ((System.currentTimeMillis() - startTime) < duration) {
    Thread.sleep(100);
  }
  int delCount=0;
  int addCount=0;
  for (int x=0; x < indexThreads.length; x++) {
    indexThreads[x].run=false;
    assertNull("Exception thrown: " + indexThreads[x].ex,indexThreads[x].ex);
    addCount+=indexThreads[x].addCount;
    delCount+=indexThreads[x].delCount;
  }
  for (int x=0; x < indexThreads.length; x++) {
    indexThreads[x].join();
  }
  for (int x=0; x < indexThreads.length; x++) {
    assertNull("Exception thrown: " + indexThreads[x].ex,indexThreads[x].ex);
  }
  writer.close();
  mainDir.close();
}
