{
  List<String> missingFields=new ArrayList<String>(schema.getRequiredFields().size());
  for (  SchemaField field : schema.getRequiredFields()) {
    if (doc.getField(field.getName()) == null) {
      if (field.getDefaultValue() != null) {
        doc.add(field.createField(field.getDefaultValue(),1.0f));
      }
 else {
        missingFields.add(field.getName());
      }
    }
  }
  if (missingFields.size() > 0) {
    StringBuilder builder=new StringBuilder();
    if (schema.getUniqueKeyField() != null) {
      String n=schema.getUniqueKeyField().getName();
      String v=doc.get(n);
      builder.append("Document [" + n + "="+ v+ "] ");
    }
    builder.append("missing required fields: ");
    for (    String field : missingFields) {
      builder.append(field);
      builder.append(" ");
    }
    throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,builder.toString());
  }
  Document ret=doc;
  doc=null;
  return ret;
}
