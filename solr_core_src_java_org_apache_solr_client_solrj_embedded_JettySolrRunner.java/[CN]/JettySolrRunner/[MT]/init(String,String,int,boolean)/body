{
  this.context=context;
  server=new Server(port);
  this.solrHome=solrHome;
  this.stopAtShutdown=stopAtShutdown;
  server.setStopAtShutdown(stopAtShutdown);
  if (!stopAtShutdown) {
    server.setGracefulShutdown(0);
  }
  System.setProperty("solr.solr.home",solrHome);
  if (System.getProperty("jetty.testMode") != null) {
    final String connectorName=System.getProperty("tests.jettyConnector","SelectChannel");
    final boolean useSsl=sslConfig == null ? false : sslConfig.isSSLMode();
    final SslContextFactory sslcontext=new SslContextFactory(false);
    sslInit(useSsl,sslcontext);
    final Connector connector;
    if ("SelectChannel".equals(connectorName)) {
      final SelectChannelConnector c=useSsl ? new SslSelectChannelConnector(sslcontext) : new SelectChannelConnector();
      c.setReuseAddress(true);
      c.setLowResourcesMaxIdleTime(1500);
      c.setSoLingerTime(0);
      connector=c;
    }
 else     if ("Socket".equals(connectorName)) {
      final SocketConnector c=useSsl ? new SslSocketConnector(sslcontext) : new SocketConnector();
      c.setReuseAddress(true);
      c.setSoLingerTime(0);
      connector=c;
    }
 else {
      throw new IllegalArgumentException("Illegal value for system property 'tests.jettyConnector': " + connectorName);
    }
    connector.setPort(port);
    connector.setHost("127.0.0.1");
    QueuedThreadPool qtp=new QueuedThreadPool();
    qtp.setMaxThreads(10000);
    qtp.setMaxIdleTimeMs((int)TimeUnit.SECONDS.toMillis(5));
    qtp.setMaxStopTimeMs((int)TimeUnit.MINUTES.toMillis(1));
    server.setThreadPool(qtp);
    server.setConnectors(new Connector[]{connector});
    server.setSessionIdManager(new HashSessionIdManager(new Random()));
  }
 else {
    if (server.getThreadPool() == null) {
      QueuedThreadPool qtp=new QueuedThreadPool();
      qtp.setMaxThreads(10000);
      qtp.setMaxIdleTimeMs((int)TimeUnit.SECONDS.toMillis(5));
      qtp.setMaxStopTimeMs((int)TimeUnit.SECONDS.toMillis(1));
      server.setThreadPool(qtp);
    }
  }
  final ServletContextHandler root=new ServletContextHandler(server,context,ServletContextHandler.SESSIONS);
  root.setHandler(new GzipHandler());
  server.addLifeCycleListener(new LifeCycle.Listener(){
    @Override public void lifeCycleStopping(    LifeCycle arg0){
      System.clearProperty("hostPort");
    }
    @Override public void lifeCycleStopped(    LifeCycle arg0){
    }
    @Override public void lifeCycleStarting(    LifeCycle arg0){
synchronized (JettySolrRunner.this) {
        waitOnSolr=true;
        JettySolrRunner.this.notify();
      }
    }
    @Override public void lifeCycleStarted(    LifeCycle arg0){
      lastPort=getFirstConnectorPort();
      System.setProperty("hostPort",Integer.toString(lastPort));
      if (solrConfigFilename != null)       System.setProperty("solrconfig",solrConfigFilename);
      if (schemaFilename != null)       System.setProperty("schema",schemaFilename);
      debugFilter=root.addFilter(DebugFilter.class,"*",EnumSet.of(DispatcherType.REQUEST));
      if (extraRequestFilters != null) {
        extraFilters=new LinkedList<>();
        for (        Class filterClass : extraRequestFilters.keySet()) {
          extraFilters.add(root.addFilter(filterClass,extraRequestFilters.get(filterClass),EnumSet.of(DispatcherType.REQUEST)));
        }
      }
      dispatchFilter=root.addFilter(SolrDispatchFilter.class,"*",EnumSet.of(DispatcherType.REQUEST));
      for (      ServletHolder servletHolder : extraServlets.keySet()) {
        String pathSpec=extraServlets.get(servletHolder);
        root.addServlet(servletHolder,pathSpec);
      }
      if (solrConfigFilename != null)       System.clearProperty("solrconfig");
      if (schemaFilename != null)       System.clearProperty("schema");
      System.clearProperty("solr.solr.home");
    }
    @Override public void lifeCycleFailure(    LifeCycle arg0,    Throwable arg1){
      System.clearProperty("hostPort");
    }
  }
);
  root.addServlet(Servlet404.class,"/*");
}
