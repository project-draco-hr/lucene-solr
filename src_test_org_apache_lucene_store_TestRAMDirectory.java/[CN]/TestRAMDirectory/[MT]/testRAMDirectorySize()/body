{
  final MockRAMDirectory ramDir=new MockRAMDirectory(indexDir.getCanonicalPath());
  final IndexWriter writer=new IndexWriter(ramDir,new WhitespaceAnalyzer(),false,IndexWriter.MaxFieldLength.LIMITED);
  writer.optimize();
  assertEquals(ramDir.sizeInBytes(),ramDir.getRecomputedSizeInBytes());
  Thread[] threads=new Thread[numThreads];
  for (int i=0; i < numThreads; i++) {
    final int num=i;
    threads[i]=new Thread(){
      public void run(){
        for (int j=1; j < docsPerThread; j++) {
          Document doc=new Document();
          doc.add(new Field("sizeContent",English.intToEnglish(num * docsPerThread + j).trim(),Field.Store.YES,Field.Index.NOT_ANALYZED));
          try {
            writer.addDocument(doc);
          }
 catch (          IOException e) {
            throw new RuntimeException(e);
          }
synchronized (ramDir) {
            assertEquals(ramDir.sizeInBytes(),ramDir.getRecomputedSizeInBytes());
          }
        }
      }
    }
;
  }
  for (int i=0; i < numThreads; i++)   threads[i].start();
  for (int i=0; i < numThreads; i++)   threads[i].join();
  writer.optimize();
  assertEquals(ramDir.sizeInBytes(),ramDir.getRecomputedSizeInBytes());
  writer.close();
}
