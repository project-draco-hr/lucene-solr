{
  if (batchPool != null) {
    context.setStatus("Waiting for batches to complete");
    batchPool.shutdown();
    while (!batchPool.isTerminated()) {
      LOG.info(String.format(Locale.ENGLISH,"Waiting for %d items and %d threads to finish executing",batchPool.getQueue().size(),batchPool.getActiveCount()));
      batchPool.awaitTermination(5,TimeUnit.SECONDS);
    }
  }
  context.setStatus("Committing Solr Phase 1");
  solr.commit(true,false);
  context.setStatus("Optimizing Solr");
  int maxSegments=context.getConfiguration().getInt(SolrOutputFormat.SOLR_RECORD_WRITER_MAX_SEGMENTS,1);
  LOG.info("Optimizing Solr: forcing merge down to {} segments",maxSegments);
  long start=System.nanoTime();
  solr.optimize(true,false,maxSegments);
  context.getCounter(SolrCounters.class.getName(),SolrCounters.PHYSICAL_REDUCER_MERGE_TIME.toString()).increment(System.nanoTime() - start);
  float secs=(System.nanoTime() - start) / (float)(10 ^ 9);
  LOG.info("Optimizing Solr: done forcing merge down to {} segments in {} secs",maxSegments,secs);
  context.setStatus("Committing Solr Phase 2");
  solr.commit(true,false);
  context.setStatus("Shutting down Solr");
  solr.close();
}
