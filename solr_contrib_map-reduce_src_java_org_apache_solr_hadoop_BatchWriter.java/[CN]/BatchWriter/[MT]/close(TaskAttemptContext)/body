{
  if (batchPool != null) {
    context.setStatus("Waiting for batches to complete");
    batchPool.shutdown();
    while (!batchPool.isTerminated()) {
      LOG.info(String.format(Locale.ENGLISH,"Waiting for %d items and %d threads to finish executing",batchPool.getQueue().size(),batchPool.getActiveCount()));
      batchPool.awaitTermination(5,TimeUnit.SECONDS);
    }
  }
  context.setStatus("Optimizing Solr");
  int maxSegments=context.getConfiguration().getInt(SolrOutputFormat.SOLR_RECORD_WRITER_MAX_SEGMENTS,1);
  LOG.info("Optimizing Solr: forcing merge down to {} segments",maxSegments);
  long start=System.currentTimeMillis();
  solr.optimize(true,false,maxSegments);
  context.getCounter(SolrCounters.class.getName(),SolrCounters.PHYSICAL_REDUCER_MERGE_TIME.toString()).increment(System.currentTimeMillis() - start);
  float secs=(System.currentTimeMillis() - start) / 1000.0f;
  LOG.info("Optimizing Solr: done forcing merge down to {} segments in {} secs",maxSegments,secs);
  context.setStatus("Shutting down Solr");
  solr.shutdown();
}
