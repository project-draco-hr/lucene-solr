{
  Directory indexDir=newDirectory();
  Directory taxoDir=newDirectory();
  TaxonomyWriter taxonomyWriter=new DirectoryTaxonomyWriter(taxoDir);
  IndexWriter iw=new IndexWriter(indexDir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())));
  FacetIndexingParams fip=new PerDimensionIndexingParams(Collections.singletonMap(new CategoryPath("b"),new CategoryListParams("$b")));
  FacetFields facetFields=new FacetFields(taxonomyWriter,fip);
  for (int i=atLeast(30); i > 0; --i) {
    Document doc=new Document();
    doc.add(new StringField("f","v",Store.NO));
    List<CategoryPath> cats=new ArrayList<CategoryPath>();
    cats.add(new CategoryPath("a"));
    cats.add(new CategoryPath("b"));
    facetFields.addFields(doc,cats);
    iw.addDocument(doc);
  }
  taxonomyWriter.close();
  iw.close();
  DirectoryReader r=DirectoryReader.open(indexDir);
  DirectoryTaxonomyReader taxo=new DirectoryTaxonomyReader(taxoDir);
  FacetSearchParams sParams=new FacetSearchParams(fip,new CountFacetRequest(new CategoryPath("a"),10),new SumScoreFacetRequest(new CategoryPath("b"),10));
  final Map<CategoryListParams,FacetsAggregator> clpAggregator=new HashMap<CategoryListParams,FacetsAggregator>();
  clpAggregator.put(fip.getCategoryListParams(new CategoryPath("a")),new FastCountingFacetsAggregator());
  clpAggregator.put(fip.getCategoryListParams(new CategoryPath("b")),new SumScoreFacetsAggregator());
  FacetsAccumulator fa=new FacetsAccumulator(sParams,r,taxo){
    @Override public FacetsAggregator getAggregator(){
      return new FacetsAggregator(){
        @Override public void rollupValues(        int ordinal,        int[] children,        int[] siblings,        FacetArrays facetArrays){
          throw new UnsupportedOperationException("not supported yet");
        }
        @Override public boolean requiresDocScores(){
          for (          FacetsAggregator aggregator : clpAggregator.values()) {
            if (aggregator.requiresDocScores()) {
              return true;
            }
          }
          return false;
        }
        @Override public void aggregate(        MatchingDocs matchingDocs,        CategoryListParams clp,        FacetArrays facetArrays) throws IOException {
          clpAggregator.get(clp).aggregate(matchingDocs,clp,facetArrays);
        }
      }
;
    }
  }
;
  FacetsCollector fc=FacetsCollector.create(fa);
  TopScoreDocCollector topDocs=TopScoreDocCollector.create(10,false);
  new IndexSearcher(r).search(new MatchAllDocsQuery(),MultiCollector.wrap(fc,topDocs));
  List<FacetResult> facetResults=fc.getFacetResults();
  FacetResult fresA=facetResults.get(0);
  assertEquals("unexpected count for " + fresA,r.maxDoc(),(int)fresA.getFacetResultNode().value);
  FacetResult fresB=facetResults.get(1);
  double expected=topDocs.topDocs().getMaxScore() * r.numDocs();
  assertEquals("unexpected value for " + fresB,expected,fresB.getFacetResultNode().value,1E-10);
  IOUtils.close(taxo,taxoDir,r,indexDir);
}
