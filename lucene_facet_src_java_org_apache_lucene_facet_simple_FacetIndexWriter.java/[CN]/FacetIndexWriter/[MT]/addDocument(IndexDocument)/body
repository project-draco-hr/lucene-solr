{
  Map<String,List<FacetField>> byField=new HashMap<String,List<FacetField>>();
  Map<String,List<SortedSetDocValuesFacetField>> dvByField=new HashMap<String,List<SortedSetDocValuesFacetField>>();
  Map<String,List<AssociationFacetField>> assocByField=new HashMap<String,List<AssociationFacetField>>();
  for (  IndexableField field : doc.indexableFields()) {
    if (field.fieldType() == FacetField.TYPE) {
      FacetField facetField=(FacetField)field;
      FacetsConfig.DimConfig dimConfig=config.getDimConfig(facetField.dim);
      String indexFieldName=dimConfig.indexFieldName;
      List<FacetField> fields=byField.get(indexFieldName);
      if (fields == null) {
        fields=new ArrayList<FacetField>();
        byField.put(indexFieldName,fields);
      }
      fields.add(facetField);
    }
    if (field.fieldType() == SortedSetDocValuesFacetField.TYPE) {
      SortedSetDocValuesFacetField facetField=(SortedSetDocValuesFacetField)field;
      FacetsConfig.DimConfig dimConfig=config.getDimConfig(facetField.dim);
      String indexFieldName=dimConfig.indexFieldName;
      List<SortedSetDocValuesFacetField> fields=dvByField.get(indexFieldName);
      if (fields == null) {
        fields=new ArrayList<SortedSetDocValuesFacetField>();
        dvByField.put(indexFieldName,fields);
      }
      fields.add(facetField);
    }
    if (field.fieldType() == AssociationFacetField.TYPE) {
      AssociationFacetField facetField=(AssociationFacetField)field;
      FacetsConfig.DimConfig dimConfig=config.getDimConfig(facetField.dim);
      String indexFieldName=dimConfig.indexFieldName;
      List<AssociationFacetField> fields=assocByField.get(indexFieldName);
      if (fields == null) {
        fields=new ArrayList<AssociationFacetField>();
        assocByField.put(indexFieldName,fields);
      }
      fields.add(facetField);
    }
  }
  List<Field> addedIndexedFields=new ArrayList<Field>();
  List<Field> addedStoredFields=new ArrayList<Field>();
  processFacetFields(byField,addedIndexedFields,addedStoredFields);
  processSSDVFacetFields(dvByField,addedIndexedFields,addedStoredFields);
  processAssocFacetFields(assocByField,addedIndexedFields,addedStoredFields);
  final List<IndexableField> allIndexedFields=new ArrayList<IndexableField>();
  for (  IndexableField field : doc.indexableFields()) {
    IndexableFieldType ft=field.fieldType();
    if (ft != FacetField.TYPE && ft != SortedSetDocValuesFacetField.TYPE && ft != AssociationFacetField.TYPE) {
      allIndexedFields.add(field);
    }
  }
  allIndexedFields.addAll(addedIndexedFields);
  final List<StorableField> allStoredFields=new ArrayList<StorableField>();
  for (  StorableField field : doc.storableFields()) {
    allStoredFields.add(field);
  }
  allStoredFields.addAll(addedStoredFields);
  super.addDocument(new IndexDocument(){
    @Override public Iterable<IndexableField> indexableFields(){
      return allIndexedFields;
    }
    @Override public Iterable<StorableField> storableFields(){
      return allStoredFields;
    }
  }
);
}
