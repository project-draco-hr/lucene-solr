{
  String name=message.get("name");
  ModifiableSolrParams params=new ModifiableSolrParams();
  params.set(CoreAdminParams.ACTION,CoreAdminAction.UNLOAD.toString());
  Map<String,Slice> slices=cloudState.getCollectionStates().get(name);
  if (slices == null) {
    throw new SolrException(ErrorCode.BAD_REQUEST,"Could not find collection:" + name);
  }
  for (  Map.Entry<String,Slice> entry : slices.entrySet()) {
    Slice slice=entry.getValue();
    Map<String,ZkNodeProps> shards=slice.getShards();
    Set<Map.Entry<String,ZkNodeProps>> shardEntries=shards.entrySet();
    for (    Map.Entry<String,ZkNodeProps> shardEntry : shardEntries) {
      final ZkNodeProps node=shardEntry.getValue();
      if (cloudState.liveNodesContain(node.get(ZkStateReader.NODE_NAME_PROP))) {
        params.set(CoreAdminParams.CORE,name);
        params.set(CoreAdminParams.DELETE_INSTANCE_DIR,true);
        String replica=node.get(ZkStateReader.BASE_URL_PROP);
        ShardRequest sreq=new ShardRequest();
        params.set("qt",adminPath);
        sreq.purpose=1;
        if (replica.startsWith("http://"))         replica=replica.substring(7);
        sreq.shards=new String[]{replica};
        sreq.actualShards=sreq.shards;
        sreq.params=params;
        shardHandler.submit(sreq,replica,sreq.params);
      }
    }
  }
  int failed=0;
  ShardResponse srsp;
  do {
    srsp=shardHandler.takeCompletedOrError();
    if (srsp != null) {
      Throwable e=srsp.getException();
      if (e != null) {
        failed++;
        log.error("Error talking to shard: " + srsp.getShard(),e);
      }
    }
  }
 while (srsp != null);
  if (failed > 0) {
    return false;
  }
  return true;
}
