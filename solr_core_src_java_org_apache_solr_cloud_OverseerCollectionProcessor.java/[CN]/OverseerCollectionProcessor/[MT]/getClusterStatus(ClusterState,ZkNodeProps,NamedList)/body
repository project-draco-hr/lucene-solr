{
  String collection=message.getStr(ZkStateReader.COLLECTION_PROP);
  Aliases aliases=zkStateReader.getAliases();
  Map<String,List<String>> collectionVsAliases=new HashMap<>();
  Map<String,String> aliasVsCollections=aliases.getCollectionAliasMap();
  if (aliasVsCollections != null) {
    for (    Map.Entry<String,String> entry : aliasVsCollections.entrySet()) {
      List<String> colls=StrUtils.splitSmart(entry.getValue(),',');
      String alias=entry.getKey();
      for (      String coll : colls) {
        if (collection == null || collection.equals(coll)) {
          List<String> list=collectionVsAliases.get(coll);
          if (list == null) {
            list=new ArrayList<>();
            collectionVsAliases.put(coll,list);
          }
          list.add(alias);
        }
      }
    }
  }
  Map roles=null;
  if (zkStateReader.getZkClient().exists(ZkStateReader.ROLES,true)) {
    roles=(Map)ZkStateReader.fromJSON(zkStateReader.getZkClient().getData(ZkStateReader.ROLES,null,null,true));
  }
  byte[] bytes=ZkStateReader.toJSON(clusterState);
  Map<String,Object> stateMap=(Map<String,Object>)ZkStateReader.fromJSON(bytes);
  Set<String> collections=new HashSet<>();
  String routeKey=message.getStr(ShardParams._ROUTE_);
  String shard=message.getStr(ZkStateReader.SHARD_ID_PROP);
  if (collection == null) {
    collections=new HashSet<>(clusterState.getCollections());
  }
 else {
    collections=Collections.singleton(collection);
  }
  NamedList<Object> collectionProps=new SimpleOrderedMap<Object>();
  for (  String name : collections) {
    Map<String,Object> collectionStatus=null;
    DocCollection clusterStateCollection=clusterState.getCollection(name);
    Set<String> requestedShards=new HashSet<>();
    if (routeKey != null) {
      DocRouter router=clusterStateCollection.getRouter();
      Collection<Slice> slices=router.getSearchSlices(routeKey,null,clusterStateCollection);
      for (      Slice slice : slices) {
        requestedShards.add(slice.getName());
      }
    }
    if (shard != null) {
      requestedShards.add(shard);
    }
    if (clusterStateCollection.getStateFormat() > 1) {
      bytes=ZkStateReader.toJSON(clusterStateCollection);
      Map<String,Object> docCollection=(Map<String,Object>)ZkStateReader.fromJSON(bytes);
      collectionStatus=getCollectionStatus(docCollection,name,requestedShards);
    }
 else {
      collectionStatus=getCollectionStatus((Map<String,Object>)stateMap.get(name),name,requestedShards);
    }
    collectionStatus.put("znodeVersion",clusterStateCollection.getZNodeVersion());
    if (collectionVsAliases.containsKey(name) && !collectionVsAliases.get(name).isEmpty()) {
      collectionStatus.put("aliases",collectionVsAliases.get(name));
    }
    String configName=zkStateReader.readConfigName(name);
    collectionStatus.put("configName",configName);
    collectionProps.add(name,collectionStatus);
  }
  List<String> liveNodes=zkStateReader.getZkClient().getChildren(ZkStateReader.LIVE_NODES_ZKNODE,null,true);
  crossCheckReplicaStateWithLiveNodes(liveNodes,collectionProps);
  NamedList<Object> clusterStatus=new SimpleOrderedMap<>();
  clusterStatus.add("collections",collectionProps);
  Map clusterProps=zkStateReader.getClusterProps();
  if (clusterProps != null && !clusterProps.isEmpty()) {
    clusterStatus.add("properties",clusterProps);
  }
  if (aliasVsCollections != null && !aliasVsCollections.isEmpty()) {
    clusterStatus.add("aliases",aliasVsCollections);
  }
  if (roles != null) {
    clusterStatus.add("roles",roles);
  }
  clusterStatus.add("live_nodes",liveNodes);
  results.add("cluster",clusterStatus);
}
