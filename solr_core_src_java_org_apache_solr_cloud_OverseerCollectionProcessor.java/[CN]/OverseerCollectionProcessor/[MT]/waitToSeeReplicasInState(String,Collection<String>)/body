{
  Map<String,Replica> result=new HashMap<>();
  long endTime=System.nanoTime() + TimeUnit.NANOSECONDS.convert(30,TimeUnit.SECONDS);
  while (true) {
    DocCollection coll=zkStateReader.getClusterState().getCollection(collectionName);
    for (    String coreName : coreNames) {
      if (result.containsKey(coreName))       continue;
      for (      Slice slice : coll.getSlices()) {
        for (        Replica replica : slice.getReplicas()) {
          if (coreName.equals(replica.getStr(ZkStateReader.CORE_NAME_PROP))) {
            result.put(coreName,replica);
            break;
          }
        }
      }
    }
    if (result.size() == coreNames.size()) {
      return result;
    }
    if (System.nanoTime() > endTime) {
      throw new SolrException(ErrorCode.SERVER_ERROR,"Timed out waiting to see all replicas in cluster state.");
    }
    Thread.sleep(100);
  }
}
