{
  String collectionName=message.getStr("name");
  if (clusterState.getCollections().contains(collectionName)) {
    SolrException.log(log,"collection already exists: " + collectionName);
    return false;
  }
  try {
    int numReplica=msgStrToInt(message,REPLICATION_FACTOR,0);
    int numSlices=msgStrToInt(message,NUM_SLICES,0);
    int maxShardsPerNode=msgStrToInt(message,MAX_SHARDS_PER_NODE,1);
    if (numReplica < 0) {
      SolrException.log(log,REPLICATION_FACTOR + " must be > 0");
      return false;
    }
    if (numSlices < 0) {
      SolrException.log(log,NUM_SLICES + " must be > 0");
      return false;
    }
    String configName=message.getStr("collection.configName");
    Set<String> nodes=clusterState.getLiveNodes();
    List<String> nodeList=new ArrayList<String>(nodes.size());
    nodeList.addAll(nodes);
    Collections.shuffle(nodeList);
    if (nodeList.size() <= 0) {
      log.error("Cannot create collection " + collectionName + ". No live Solr-instaces");
      return false;
    }
    int numShardsPerSlice=numReplica + 1;
    if (numShardsPerSlice > nodeList.size()) {
      log.warn("Specified " + REPLICATION_FACTOR + " of "+ numReplica+ " on collection "+ collectionName+ " is higher than or equal to the number of Solr instances currently live ("+ nodeList.size()+ "). Its unusual to run two replica of the same slice on the same Solr-instance.");
    }
    int maxShardsAllowedToCreate=maxShardsPerNode * nodeList.size();
    int requestedShardsToCreate=numSlices * numShardsPerSlice;
    if (maxShardsAllowedToCreate < requestedShardsToCreate) {
      log.error("Cannot create collection " + collectionName + ". Value of "+ MAX_SHARDS_PER_NODE+ " is "+ maxShardsPerNode+ ", and the number of live nodes is "+ nodeList.size()+ ". This allows a maximum of "+ maxShardsAllowedToCreate+ " to be created. Value of "+ NUM_SLICES+ " is "+ numSlices+ " and value of "+ REPLICATION_FACTOR+ " is "+ numReplica+ ". This requires "+ requestedShardsToCreate+ " shards to be created (higher than the allowed number)");
      return false;
    }
    for (int i=1; i <= numSlices; i++) {
      for (int j=1; j <= numShardsPerSlice; j++) {
        String nodeName=nodeList.get(((i - 1) + (j - 1)) % nodeList.size());
        String sliceName="shard" + i;
        String shardName=collectionName + "_" + sliceName+ "_replica"+ j;
        log.info("Creating shard " + shardName + " as part of slice "+ sliceName+ " of collection "+ collectionName+ " on "+ nodeName);
        ModifiableSolrParams params=new ModifiableSolrParams();
        params.set(CoreAdminParams.ACTION,CoreAdminAction.CREATE.toString());
        params.set(CoreAdminParams.NAME,shardName);
        params.set("collection.configName",configName);
        params.set(CoreAdminParams.COLLECTION,collectionName);
        params.set(CoreAdminParams.SHARD,sliceName);
        params.set(ZkStateReader.NUM_SHARDS_PROP,numSlices);
        ShardRequest sreq=new ShardRequest();
        params.set("qt",adminPath);
        sreq.purpose=1;
        String replica=nodeName.replaceAll("_","/");
        if (replica.startsWith("http://"))         replica=replica.substring(7);
        sreq.shards=new String[]{replica};
        sreq.actualShards=sreq.shards;
        sreq.params=params;
        shardHandler.submit(sreq,replica,sreq.params);
      }
    }
    int failed=0;
    ShardResponse srsp;
    do {
      srsp=shardHandler.takeCompletedOrError();
      if (srsp != null) {
        Throwable e=srsp.getException();
        if (e != null) {
          failed++;
          log.error("Error talking to shard: " + srsp.getShard(),e);
        }
      }
    }
 while (srsp != null);
    if (failed > 0) {
      return false;
    }
    log.info("Successfully created all shards for collection " + collectionName);
    return true;
  }
 catch (  Exception ex) {
    return false;
  }
}
