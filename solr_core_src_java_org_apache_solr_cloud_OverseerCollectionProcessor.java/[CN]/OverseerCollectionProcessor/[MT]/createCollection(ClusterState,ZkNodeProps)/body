{
  String collectionName=message.getStr("name");
  if (clusterState.getCollections().contains(collectionName)) {
    SolrException.log(log,"collection already exists: " + collectionName);
    return false;
  }
  String numReplicasString=message.getStr(REPLICATION_FACTOR);
  int numReplicas;
  try {
    numReplicas=numReplicasString == null ? 0 : Integer.parseInt(numReplicasString);
  }
 catch (  Exception ex) {
    SolrException.log(log,"Could not parse " + REPLICATION_FACTOR,ex);
    return false;
  }
  String numShardsString=message.getStr("numShards");
  int numShards;
  try {
    numShards=numShardsString == null ? 0 : Integer.parseInt(numShardsString);
  }
 catch (  Exception ex) {
    SolrException.log(log,"Could not parse numShards",ex);
    return false;
  }
  if (numReplicas < 0) {
    SolrException.log(log,REPLICATION_FACTOR + " must be > 0");
    return false;
  }
  if (numShards < 0) {
    SolrException.log(log,"numShards must be > 0");
    return false;
  }
  String name=message.getStr("name");
  String configName=message.getStr("collection.configName");
  Set<String> nodes=clusterState.getLiveNodes();
  List<String> nodeList=new ArrayList<String>(nodes.size());
  nodeList.addAll(nodes);
  Collections.shuffle(nodeList);
  int numNodes=numShards * (numReplicas + 1);
  if (nodeList.size() < numNodes) {
    log.warn("Not enough nodes available to satisfy create collection request for collection:" + collectionName + " nodes needed:"+ numNodes+ " nodes available:"+ nodeList.size()+ " - using nodes available");
  }
  List<String> createOnNodes=nodeList.subList(0,Math.min(nodeList.size(),numNodes));
  log.info("Create collection " + name + " on "+ createOnNodes);
  for (  String replica : createOnNodes) {
    ModifiableSolrParams params=new ModifiableSolrParams();
    params.set(CoreAdminParams.ACTION,CoreAdminAction.CREATE.toString());
    replica=replica.replaceAll("_","/");
    params.set(CoreAdminParams.NAME,name);
    params.set("collection.configName",configName);
    params.set("numShards",numShards);
    ShardRequest sreq=new ShardRequest();
    params.set("qt",adminPath);
    sreq.purpose=1;
    if (replica.startsWith("http://"))     replica=replica.substring(7);
    sreq.shards=new String[]{replica};
    sreq.actualShards=sreq.shards;
    sreq.params=params;
    shardHandler.submit(sreq,replica,sreq.params);
  }
  int failed=0;
  ShardResponse srsp;
  do {
    srsp=shardHandler.takeCompletedOrError();
    if (srsp != null) {
      Throwable e=srsp.getException();
      if (e != null) {
        failed++;
        log.error("Error talking to shard: " + srsp.getShard(),e);
      }
    }
  }
 while (srsp != null);
  if (failed > 0) {
    return false;
  }
  return true;
}
