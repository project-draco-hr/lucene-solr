{
  final CoreContainer cc=init();
  try {
    copyMinConf(new File(solrHomeDirectory,"core1"));
    copyMinConf(new File(solrHomeDirectory,"core2"));
    copyMinConf(new File(solrHomeDirectory,"core3"));
    copyMinConf(new File(solrHomeDirectory,"core4"));
    cc.setPersistent(true);
    CoreDescriptor d1=new CoreDescriptor(cc,"core1","./core1");
    d1.setTransient(true);
    d1.setLoadOnStartup(true);
    d1.setSchemaName("schema.xml");
    d1.setConfigName("solrconfig.xml");
    SolrCore core1=cc.create(d1);
    CoreDescriptor d2=new CoreDescriptor(cc,"core2","./core2");
    d2.setTransient(true);
    d2.setLoadOnStartup(false);
    d2.setSchemaName("schema.xml");
    d2.setConfigName("solrconfig.xml");
    SolrCore core2=cc.create(d2);
    CoreDescriptor d3=new CoreDescriptor(cc,"core3","./core3");
    d3.setTransient(false);
    d3.setLoadOnStartup(true);
    d3.setSchemaName("schema.xml");
    d3.setConfigName("solrconfig.xml");
    SolrCore core3=cc.create(d3);
    CoreDescriptor d4=new CoreDescriptor(cc,"core4","./core4");
    d4.setTransient(false);
    d4.setLoadOnStartup(false);
    d4.setSchemaName("schema.xml");
    d4.setConfigName("solrconfig.xml");
    SolrCore core4=cc.create(d4);
    final File oneXml=new File(solrHomeDirectory,"lazy1.solr.xml");
    cc.persistFile(oneXml);
    assertXmlFile(oneXml,"/solr/cores/core[@name='collection1']","/solr/cores/core[@name='collectionLazy2']","/solr/cores/core[@name='collectionLazy3']","/solr/cores/core[@name='collectionLazy4']","/solr/cores/core[@name='collectionLazy5']","/solr/cores/core[@name='collectionLazy6']","/solr/cores/core[@name='collectionLazy7']","/solr/cores/core[@name='collectionLazy8']","/solr/cores/core[@name='collectionLazy9']","/solr/cores/core[@name='core1']","/solr/cores/core[@name='core2']","/solr/cores/core[@name='core3']","/solr/cores/core[@name='core4']");
    assertXmlFile(oneXml,"13=count(/solr/cores/core)");
    removeOne(cc,"collectionLazy2");
    removeOne(cc,"collectionLazy3");
    removeOne(cc,"collectionLazy4");
    removeOne(cc,"collectionLazy5");
    removeOne(cc,"collectionLazy6");
    removeOne(cc,"collectionLazy7");
    removeOne(cc,"core1");
    removeOne(cc,"core2");
    removeOne(cc,"core3");
    removeOne(cc,"core4");
    final File twoXml=new File(solrHomeDirectory,"lazy2.solr.xml");
    cc.persistFile(twoXml);
    assertXmlFile(twoXml,"3=count(/solr/cores/core)");
  }
  finally {
    cc.shutdown();
  }
}
