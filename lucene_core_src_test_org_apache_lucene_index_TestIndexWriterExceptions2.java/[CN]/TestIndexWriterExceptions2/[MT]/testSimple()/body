{
  Directory dir=newDirectory();
  ByteArrayOutputStream exceptionLog=new ByteArrayOutputStream();
  PrintStream exceptionStream=new PrintStream(exceptionLog,true,"UTF-8");
  final long analyzerSeed=random().nextLong();
  Analyzer analyzer=new Analyzer(){
    @Override protected TokenStreamComponents createComponents(    String fieldName){
      MockTokenizer tokenizer=new MockTokenizer(MockTokenizer.SIMPLE,false);
      tokenizer.setEnableChecks(false);
      TokenStream stream=new CrankyTokenFilter(tokenizer,new Random(analyzerSeed));
      return new TokenStreamComponents(tokenizer,stream);
    }
  }
;
  Codec codec=new CrankyCodec(Codec.getDefault(),new Random(random().nextLong()));
  IndexWriterConfig conf=newIndexWriterConfig(TEST_VERSION_CURRENT,analyzer);
  conf.setMergeScheduler(new SerialMergeScheduler());
  conf.setCodec(codec);
  int numDocs=RANDOM_MULTIPLIER * 1000;
  IndexWriter iw=new IndexWriter(dir,conf);
  try {
    for (int i=0; i < numDocs; i++) {
      Document doc=new Document();
      doc.add(newStringField("id",Integer.toString(i),Field.Store.NO));
      doc.add(new NumericDocValuesField("dv",i));
      doc.add(newTextField("text1",TestUtil.randomAnalysisString(random(),20,true),Field.Store.NO));
      try {
        iw.addDocument(doc);
      }
 catch (      Exception e) {
        if (e.getMessage() != null && e.getMessage().startsWith("Fake IOException")) {
          System.out.println("\nTEST: got expected fake exc:" + e.getMessage());
          e.printStackTrace(exceptionStream);
        }
 else {
          Rethrow.rethrow(e);
        }
      }
      if (random().nextInt(10) == 0) {
        try {
          iw.commit();
          if (DirectoryReader.indexExists(dir)) {
            TestUtil.checkIndex(dir);
          }
        }
 catch (        Exception e) {
          if (e.getMessage() != null && e.getMessage().startsWith("Fake IOException")) {
            System.out.println("\nTEST: got expected fake exc:" + e.getMessage());
            e.printStackTrace(exceptionStream);
          }
 else {
            Rethrow.rethrow(e);
          }
        }
      }
    }
    try {
      iw.shutdown();
    }
 catch (    Exception e) {
      if (e.getMessage() != null && e.getMessage().startsWith("Fake IOException")) {
        System.out.println("\nTEST: got expected fake exc:" + e.getMessage());
        e.printStackTrace(exceptionStream);
        try {
          iw.rollback();
        }
 catch (        Throwable t) {
        }
      }
 else {
        Rethrow.rethrow(e);
      }
    }
    dir.close();
  }
 catch (  Throwable t) {
    System.out.println("Unexpected exception: dumping fake-exception-log:...");
    exceptionStream.flush();
    System.out.println(exceptionLog.toString("UTF-8"));
    System.out.flush();
    Rethrow.rethrow(t);
  }
  if (VERBOSE) {
    System.out.println("TEST PASSED: dumping fake-exception-log:...");
    System.out.println(exceptionLog.toString("UTF-8"));
  }
}
