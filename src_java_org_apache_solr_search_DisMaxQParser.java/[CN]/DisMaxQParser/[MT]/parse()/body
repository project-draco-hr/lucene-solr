{
  SolrParams solrParams=localParams == null ? params : new DefaultSolrParams(localParams,params);
  IndexSchema schema=req.getSchema();
  queryFields=SolrPluginUtils.parseFieldBoosts(solrParams.getParams(DisMaxParams.QF));
  Map<String,Float> phraseFields=SolrPluginUtils.parseFieldBoosts(solrParams.getParams(DisMaxParams.PF));
  float tiebreaker=solrParams.getFloat(DisMaxParams.TIE,0.0f);
  int pslop=solrParams.getInt(DisMaxParams.PS,0);
  int qslop=solrParams.getInt(DisMaxParams.QS,0);
  QueryParser p=schema.getSolrQueryParser(null);
  SolrPluginUtils.DisjunctionMaxQueryParser up=new SolrPluginUtils.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
  up.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,queryFields);
  up.setPhraseSlop(qslop);
  SolrPluginUtils.DisjunctionMaxQueryParser pp=new SolrPluginUtils.DisjunctionMaxQueryParser(schema,IMPOSSIBLE_FIELD_NAME);
  pp.addAlias(IMPOSSIBLE_FIELD_NAME,tiebreaker,phraseFields);
  pp.setPhraseSlop(pslop);
  BooleanQuery query=new BooleanQuery(true);
  parsedUserQuery=null;
  String userQuery=getString();
  altUserQuery=null;
  if (userQuery == null || userQuery.trim().length() < 1) {
    String altQ=solrParams.get(DisMaxParams.ALTQ);
    if (altQ != null) {
      altQParser=subQuery(altQ,null);
      altUserQuery=altQParser.parse();
      query.add(altUserQuery,BooleanClause.Occur.MUST);
    }
 else {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"missing query string");
    }
  }
 else {
    userQuery=SolrPluginUtils.partialEscape(SolrPluginUtils.stripUnbalancedQuotes(userQuery)).toString();
    userQuery=SolrPluginUtils.stripIllegalOperators(userQuery).toString();
    String minShouldMatch=solrParams.get(DisMaxParams.MM,"100%");
    Query dis=up.parse(userQuery);
    parsedUserQuery=dis;
    if (dis instanceof BooleanQuery) {
      BooleanQuery t=new BooleanQuery();
      SolrPluginUtils.flattenBooleanQuery(t,(BooleanQuery)dis);
      SolrPluginUtils.setMinShouldMatch(t,minShouldMatch);
      parsedUserQuery=t;
    }
    query.add(parsedUserQuery,BooleanClause.Occur.MUST);
    String userPhraseQuery=userQuery.replace("\"","");
    Query phrase=pp.parse("\"" + userPhraseQuery + "\"");
    if (null != phrase) {
      query.add(phrase,BooleanClause.Occur.SHOULD);
    }
  }
  boostParams=solrParams.getParams(DisMaxParams.BQ);
  boostQueries=null;
  if (boostParams != null && boostParams.length > 0) {
    boostQueries=new ArrayList<Query>();
    for (    String qs : boostParams) {
      if (qs.trim().length() == 0)       continue;
      Query q=subQuery(qs,null).parse();
      boostQueries.add(q);
    }
  }
  if (null != boostQueries) {
    if (1 == boostQueries.size() && 1 == boostParams.length) {
      Query f=boostQueries.get(0);
      if (1.0f == f.getBoost() && f instanceof BooleanQuery) {
        for (        Object c : ((BooleanQuery)f).clauses()) {
          query.add((BooleanClause)c);
        }
      }
 else {
        query.add(f,BooleanClause.Occur.SHOULD);
      }
    }
 else {
      for (      Query f : boostQueries) {
        query.add(f,BooleanClause.Occur.SHOULD);
      }
    }
  }
  String[] boostFuncs=solrParams.getParams(DisMaxParams.BF);
  if (null != boostFuncs && 0 != boostFuncs.length) {
    for (    String boostFunc : boostFuncs) {
      if (null == boostFunc || "".equals(boostFunc))       continue;
      Map<String,Float> ff=SolrPluginUtils.parseFieldBoosts(boostFunc);
      for (      String f : ff.keySet()) {
        Query fq=subQuery(f,FunctionQParserPlugin.NAME).parse();
        Float b=ff.get(f);
        if (null != b) {
          fq.setBoost(b);
        }
        query.add(fq,BooleanClause.Occur.SHOULD);
      }
    }
  }
  return query;
}
