{
  int numSnapshots=3;
  Directory dir=newDirectory(random);
  PersistentSnapshotDeletionPolicy psdp=(PersistentSnapshotDeletionPolicy)getDeletionPolicy();
  IndexWriter writer=new IndexWriter(dir,getConfig(random,psdp));
  prepareIndexAndSnapshots(psdp,writer,numSnapshots,"snapshot");
  writer.close();
  psdp.close();
  psdp=new PersistentSnapshotDeletionPolicy(new KeepOnlyLastCommitDeletionPolicy(),snapshotDir,OpenMode.APPEND,TEST_VERSION_CURRENT);
  new IndexWriter(dir,getConfig(random,psdp)).close();
  assertSnapshotExists(dir,psdp,numSnapshots);
  assertEquals(numSnapshots,psdp.getSnapshots().size());
  psdp.close();
  dir.close();
}
