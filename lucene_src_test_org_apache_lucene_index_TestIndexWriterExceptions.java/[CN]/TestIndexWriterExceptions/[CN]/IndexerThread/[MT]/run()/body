{
  final Document doc=new Document();
  doc.add(newField(r,"content1","aaa bbb ccc ddd",Field.Store.YES,Field.Index.ANALYZED));
  doc.add(newField(r,"content6","aaa bbb ccc ddd",Field.Store.NO,Field.Index.ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
  doc.add(newField(r,"content2","aaa bbb ccc ddd",Field.Store.YES,Field.Index.NOT_ANALYZED));
  doc.add(newField(r,"content3","aaa bbb ccc ddd",Field.Store.YES,Field.Index.NO));
  doc.add(newField(r,"content4","aaa bbb ccc ddd",Field.Store.NO,Field.Index.ANALYZED));
  doc.add(newField(r,"content5","aaa bbb ccc ddd",Field.Store.NO,Field.Index.NOT_ANALYZED));
  doc.add(newField(r,"content7","aaa bbb ccc ddd",Field.Store.NO,Field.Index.NOT_ANALYZED,Field.TermVector.WITH_POSITIONS_OFFSETS));
  final Field idField=newField("id","",Field.Store.YES,Field.Index.NOT_ANALYZED);
  doc.add(idField);
  final long stopTime=System.currentTimeMillis() + 500;
  do {
    if (VERBOSE) {
      System.out.println(Thread.currentThread().getName() + ": TEST: IndexerThread: cycle");
    }
    doFail.set(this);
    final String id="" + r.nextInt(50);
    idField.setValue(id);
    Term idTerm=new Term("id",id);
    try {
      if (r.nextBoolean()) {
        writer.updateDocuments(idTerm,new DocCopyIterator(doc,_TestUtil.nextInt(r,1,20)));
      }
 else {
        writer.updateDocument(idTerm,doc);
      }
    }
 catch (    RuntimeException re) {
      if (VERBOSE) {
        System.out.println(Thread.currentThread().getName() + ": EXC: ");
        re.printStackTrace(System.out);
      }
      try {
        _TestUtil.checkIndex(writer.getDirectory());
      }
 catch (      IOException ioe) {
        System.out.println(Thread.currentThread().getName() + ": unexpected exception1");
        ioe.printStackTrace(System.out);
        failure=ioe;
        break;
      }
    }
catch (    Throwable t) {
      System.out.println(Thread.currentThread().getName() + ": unexpected exception2");
      t.printStackTrace(System.out);
      failure=t;
      break;
    }
    doFail.set(null);
    try {
      writer.updateDocument(idTerm,doc);
    }
 catch (    Throwable t) {
      System.out.println(Thread.currentThread().getName() + ": unexpected exception3");
      t.printStackTrace(System.out);
      failure=t;
      break;
    }
  }
 while (System.currentTimeMillis() < stopTime);
}
