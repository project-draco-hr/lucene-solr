{
  FailOnlyInCommit[] failures=new FailOnlyInCommit[]{new FailOnlyInCommit(false,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(true,FailOnlyInCommit.PREPARE_STAGE),new FailOnlyInCommit(false,FailOnlyInCommit.FINISH_STAGE)};
  for (  FailOnlyInCommit failure : failures) {
    MockDirectoryWrapper dir=newDirectory();
    IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
    Document doc=new Document();
    doc.add(newField("field","a field",TextField.TYPE_STORED));
    w.addDocument(doc);
    dir.failOn(failure);
    try {
      w.close();
      fail();
    }
 catch (    IOException ioe) {
      fail("expected only RuntimeException");
    }
catch (    RuntimeException re) {
    }
    assertTrue(dir.fileExists("_1.fnx"));
    assertTrue(failure.failOnCommit && failure.failOnDeleteFile);
    w.rollback();
    assertFalse(dir.fileExists("_1.fnx"));
    assertEquals(0,dir.listAll().length);
    dir.close();
  }
}
