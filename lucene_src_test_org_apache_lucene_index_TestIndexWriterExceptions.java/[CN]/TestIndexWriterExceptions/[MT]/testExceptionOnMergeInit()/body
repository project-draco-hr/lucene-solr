{
  Directory dir=newDirectory();
  IndexWriterConfig conf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setMaxBufferedDocs(2).setMergeScheduler(new ConcurrentMergeScheduler()).setMergePolicy(newLogMergePolicy());
  ((LogMergePolicy)conf.getMergePolicy()).setMergeFactor(2);
  MockIndexWriter3 w=new MockIndexWriter3(dir,conf);
  w.doFail=true;
  Document doc=new Document();
  doc.add(newField("field","a field",Field.Store.YES,Field.Index.ANALYZED));
  for (int i=0; i < 10; i++)   try {
    w.addDocument(doc);
  }
 catch (  RuntimeException re) {
    break;
  }
  ((ConcurrentMergeScheduler)w.getConfig().getMergeScheduler()).sync();
  assertTrue(w.failed);
  w.close();
  dir.close();
}
