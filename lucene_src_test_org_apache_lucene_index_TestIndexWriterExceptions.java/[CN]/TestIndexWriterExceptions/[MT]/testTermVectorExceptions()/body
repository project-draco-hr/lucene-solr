{
  FailOnTermVectors[] failures=new FailOnTermVectors[]{new FailOnTermVectors(FailOnTermVectors.AFTER_INIT_STAGE),new FailOnTermVectors(FailOnTermVectors.INIT_STAGE)};
  int num=atLeast(3);
  for (int j=0; j < num; j++) {
    for (    FailOnTermVectors failure : failures) {
      MockDirectoryWrapper dir=newDirectory();
      IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)));
      dir.failOn(failure);
      int numDocs=10 + random.nextInt(30);
      for (int i=0; i < numDocs; i++) {
        Document doc=new Document();
        Field field=newField(random,"field","a field",Field.Store.YES,Field.Index.ANALYZED);
        doc.add(field);
        try {
          w.addDocument(doc);
          assertFalse(field.isTermVectorStored());
        }
 catch (        RuntimeException e) {
          assertTrue(e.getMessage().startsWith(FailOnTermVectors.EXC_MSG));
        }
        if (random.nextInt(20) == 0) {
          w.commit();
          _TestUtil.checkIndex(dir);
        }
      }
      Document document=new Document();
      document.add(new Field("field","a field",Field.Store.YES,Field.Index.ANALYZED));
      w.addDocument(document);
      for (int i=0; i < numDocs; i++) {
        Document doc=new Document();
        Field field=newField(random,"field","a field",Field.Store.YES,Field.Index.ANALYZED);
        doc.add(field);
        try {
          w.addDocument(doc);
          assertFalse(field.isTermVectorStored());
        }
 catch (        RuntimeException e) {
          assertTrue(e.getMessage().startsWith(FailOnTermVectors.EXC_MSG));
        }
        if (random.nextInt(20) == 0) {
          w.commit();
          _TestUtil.checkIndex(dir);
        }
      }
      document=new Document();
      document.add(new Field("field","a field",Field.Store.YES,Field.Index.ANALYZED));
      w.addDocument(document);
      w.close();
      IndexReader reader=IndexReader.open(dir);
      assertTrue(reader.numDocs() > 0);
      reader.close();
      SegmentInfos sis=new SegmentInfos();
      sis.read(dir);
      for (      SegmentInfo segmentInfo : sis) {
        assertFalse(segmentInfo.getHasVectors());
      }
      dir.close();
    }
  }
}
