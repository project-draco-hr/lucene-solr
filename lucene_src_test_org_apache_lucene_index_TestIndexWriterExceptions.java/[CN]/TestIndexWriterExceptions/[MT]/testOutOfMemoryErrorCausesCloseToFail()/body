{
  final List<Throwable> thrown=new ArrayList<Throwable>();
  final Directory dir=newDirectory();
  final IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random))){
    @Override public void message(    final String message){
      if (message.startsWith("now flush at close") && 0 == thrown.size()) {
        thrown.add(null);
        throw new OutOfMemoryError("fake OOME at " + message);
      }
    }
  }
;
  writer.setInfoStream(new PrintStream(new ByteArrayOutputStream()));
  try {
    writer.close();
    fail("OutOfMemoryError expected");
  }
 catch (  final OutOfMemoryError expected) {
  }
  writer.close();
  dir.close();
}
