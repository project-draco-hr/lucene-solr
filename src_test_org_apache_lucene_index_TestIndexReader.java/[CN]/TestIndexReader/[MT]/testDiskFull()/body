{
  boolean debug=false;
  Term searchTerm=new Term("content","aaa");
  int START_COUNT=157;
  int END_COUNT=144;
  RAMDirectory startDir=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(startDir,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)));
  for (int i=0; i < 157; i++) {
    Document d=new Document();
    d.add(new Field("id",Integer.toString(i),Field.Store.YES,Field.Index.NOT_ANALYZED));
    d.add(new Field("content","aaa " + i,Field.Store.NO,Field.Index.ANALYZED));
    writer.addDocument(d);
  }
  writer.close();
  long diskUsage=startDir.sizeInBytes();
  long diskFree=diskUsage + 100;
  IOException err=null;
  boolean done=false;
  while (!done) {
    MockRAMDirectory dir=new MockRAMDirectory(startDir);
    dir.setPreventDoubleWrite(false);
    IndexReader reader=IndexReader.open(dir,false);
    boolean success=false;
    for (int x=0; x < 2; x++) {
      double rate=0.05;
      double diskRatio=((double)diskFree) / diskUsage;
      long thisDiskFree;
      String testName;
      if (0 == x) {
        thisDiskFree=diskFree;
        if (diskRatio >= 2.0) {
          rate/=2;
        }
        if (diskRatio >= 4.0) {
          rate/=2;
        }
        if (diskRatio >= 6.0) {
          rate=0.0;
        }
        if (debug) {
          System.out.println("\ncycle: " + diskFree + " bytes");
        }
        testName="disk full during reader.close() @ " + thisDiskFree + " bytes";
      }
 else {
        thisDiskFree=0;
        rate=0.0;
        if (debug) {
          System.out.println("\ncycle: same writer: unlimited disk space");
        }
        testName="reader re-use after disk full";
      }
      dir.setMaxSizeInBytes(thisDiskFree);
      dir.setRandomIOExceptionRate(rate,diskFree);
      try {
        if (0 == x) {
          int docId=12;
          for (int i=0; i < 13; i++) {
            reader.deleteDocument(docId);
            reader.setNorm(docId,"contents",(float)2.0);
            docId+=12;
          }
        }
        reader.close();
        success=true;
        if (0 == x) {
          done=true;
        }
      }
 catch (      IOException e) {
        if (debug) {
          System.out.println("  hit IOException: " + e);
          e.printStackTrace(System.out);
        }
        err=e;
        if (1 == x) {
          e.printStackTrace();
          fail(testName + " hit IOException after disk space was freed up");
        }
      }
      String[] startFiles=dir.listAll();
      SegmentInfos infos=new SegmentInfos();
      infos.read(dir);
      new IndexFileDeleter(dir,new KeepOnlyLastCommitDeletionPolicy(),infos,null,null);
      String[] endFiles=dir.listAll();
      Arrays.sort(startFiles);
      Arrays.sort(endFiles);
      if (!Arrays.equals(startFiles,endFiles)) {
        String successStr;
        if (success) {
          successStr="success";
        }
 else {
          successStr="IOException";
          err.printStackTrace();
        }
        fail("reader.close() failed to delete unreferenced files after " + successStr + " ("+ diskFree+ " bytes): before delete:\n    "+ arrayToString(startFiles)+ "\n  after delete:\n    "+ arrayToString(endFiles));
      }
      IndexReader newReader=null;
      try {
        newReader=IndexReader.open(dir,false);
      }
 catch (      IOException e) {
        e.printStackTrace();
        fail(testName + ":exception when creating IndexReader after disk full during close: " + e);
      }
      IndexSearcher searcher=new IndexSearcher(newReader);
      ScoreDoc[] hits=null;
      try {
        hits=searcher.search(new TermQuery(searchTerm),null,1000).scoreDocs;
      }
 catch (      IOException e) {
        e.printStackTrace();
        fail(testName + ": exception when searching: " + e);
      }
      int result2=hits.length;
      if (success) {
        if (result2 != END_COUNT) {
          fail(testName + ": method did not throw exception but hits.length for search on term 'aaa' is " + result2+ " instead of expected "+ END_COUNT);
        }
      }
 else {
        if (result2 != START_COUNT && result2 != END_COUNT) {
          err.printStackTrace();
          fail(testName + ": method did throw exception but hits.length for search on term 'aaa' is " + result2+ " instead of expected "+ START_COUNT);
        }
      }
      searcher.close();
      newReader.close();
      if (result2 == END_COUNT) {
        break;
      }
    }
    dir.close();
    diskFree+=10;
  }
  startDir.close();
}
