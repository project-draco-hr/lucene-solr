{
  int docCount=state.segmentInfo.getDocCount();
  DocValuesConsumer dvConsumer=null;
  boolean success=false;
  try {
    for (int i=0; i < fieldHash.length; i++) {
      PerField perField=fieldHash[i];
      while (perField != null) {
        if (perField.docValuesWriter != null) {
          if (dvConsumer == null) {
            DocValuesFormat fmt=state.segmentInfo.getCodec().docValuesFormat();
            dvConsumer=fmt.fieldsConsumer(state);
          }
          perField.docValuesWriter.finish(docCount);
          perField.docValuesWriter.flush(state,dvConsumer);
          perField.docValuesWriter=null;
        }
        perField=perField.next;
      }
    }
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(dvConsumer);
    }
 else {
      IOUtils.closeWhileHandlingException(dvConsumer);
    }
  }
}
