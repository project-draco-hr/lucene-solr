{
  DimensionalWriter dimensionalWriter=null;
  boolean success=false;
  try {
    for (int i=0; i < fieldHash.length; i++) {
      PerField perField=fieldHash[i];
      while (perField != null) {
        if (perField.dimensionalValuesWriter != null) {
          if (perField.fieldInfo.getDimensionCount() == 0) {
            throw new AssertionError("segment=" + state.segmentInfo + ": field=\""+ perField.fieldInfo.name+ "\" has no dimensional values but wrote them");
          }
          if (dimensionalWriter == null) {
            DimensionalFormat fmt=state.segmentInfo.getCodec().dimensionalFormat();
            if (fmt == null) {
              throw new IllegalStateException("field=\"" + perField.fieldInfo.name + "\" was indexed dimensionally but codec does not support dimensional formats");
            }
            dimensionalWriter=fmt.fieldsWriter(state);
          }
          perField.dimensionalValuesWriter.flush(state,dimensionalWriter);
          perField.dimensionalValuesWriter=null;
        }
 else         if (perField.fieldInfo.getDimensionCount() != 0) {
          throw new AssertionError("segment=" + state.segmentInfo + ": field=\""+ perField.fieldInfo.name+ "\" has dimensional values but did not write them");
        }
        perField=perField.next;
      }
    }
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(dimensionalWriter);
    }
 else {
      IOUtils.closeWhileHandlingException(dimensionalWriter);
    }
  }
}
