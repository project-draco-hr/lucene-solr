{
  int maxDoc=state.segmentInfo.maxDoc();
  writeNorms(state);
  writeDocValues(state);
  writePoints(state);
  initStoredFieldsWriter();
  fillStoredFields(maxDoc);
  storedFieldsWriter.finish(state.fieldInfos,maxDoc);
  storedFieldsWriter.close();
  Map<String,TermsHashPerField> fieldsToFlush=new HashMap<>();
  for (int i=0; i < fieldHash.length; i++) {
    PerField perField=fieldHash[i];
    while (perField != null) {
      if (perField.invertState != null) {
        fieldsToFlush.put(perField.fieldInfo.name,perField.termsHashPerField);
      }
      perField=perField.next;
    }
  }
  termsHash.flush(fieldsToFlush,state);
  docWriter.codec.fieldInfosFormat().write(state.directory,state.segmentInfo,"",state.fieldInfos,IOContext.DEFAULT);
}
