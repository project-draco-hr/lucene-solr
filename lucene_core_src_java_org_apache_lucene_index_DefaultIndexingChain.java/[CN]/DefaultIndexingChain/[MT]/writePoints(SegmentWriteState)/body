{
  PointsWriter pointsWriter=null;
  boolean success=false;
  try {
    for (int i=0; i < fieldHash.length; i++) {
      PerField perField=fieldHash[i];
      while (perField != null) {
        if (perField.pointValuesWriter != null) {
          if (perField.fieldInfo.getPointDimensionCount() == 0) {
            throw new AssertionError("segment=" + state.segmentInfo + ": field=\""+ perField.fieldInfo.name+ "\" has no points but wrote them");
          }
          if (pointsWriter == null) {
            PointsFormat fmt=state.segmentInfo.getCodec().pointsFormat();
            if (fmt == null) {
              throw new IllegalStateException("field=\"" + perField.fieldInfo.name + "\" was indexed as points but codec does not support points");
            }
            pointsWriter=fmt.fieldsWriter(state);
          }
          perField.pointValuesWriter.flush(state,pointsWriter);
          perField.pointValuesWriter=null;
        }
 else         if (perField.fieldInfo.getPointDimensionCount() != 0) {
          throw new AssertionError("segment=" + state.segmentInfo + ": field=\""+ perField.fieldInfo.name+ "\" has points but did not write them");
        }
        perField=perField.next;
      }
    }
    if (pointsWriter != null) {
      pointsWriter.finish();
    }
    success=true;
  }
  finally {
    if (success) {
      IOUtils.close(pointsWriter);
    }
 else {
      IOUtils.closeWhileHandlingException(pointsWriter);
    }
  }
}
