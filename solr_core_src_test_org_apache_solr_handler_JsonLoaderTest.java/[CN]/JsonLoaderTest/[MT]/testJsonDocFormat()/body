{
  String doc="\n" + "\n" + "{\"bool\": true,\n"+ " \"f0\": \"v0\",\n"+ " \"f2\": {\n"+ "    \t  \"boost\": 2.3,\n"+ "    \t  \"value\": \"test\"\n"+ "    \t   },\n"+ "\"array\": [ \"aaa\", \"bbb\" ],\n"+ "\"boosted\": {\n"+ "    \t      \"boost\": 6.7,\n"+ "    \t      \"value\": [ \"aaa\", \"bbb\" ]\n"+ "    \t    }\n"+ " }\n"+ "\n"+ "\n"+ " {\"f1\": \"v1\",\n"+ "  \"f1\": \"v2\",\n"+ "   \"f2\": null\n"+ "  }\n";
  SolrQueryRequest req=req("srcField","_src_");
  req.getContext().put("path","/update/json/docs");
  SolrQueryResponse rsp=new SolrQueryResponse();
  BufferingRequestProcessor p=new BufferingRequestProcessor(null);
  JsonLoader loader=new JsonLoader();
  loader.load(req,rsp,new ContentStreamBase.StringStream(doc),p);
  assertEquals(2,p.addCommands.size());
  doc="\n" + "\n" + "{\"bool\": true,\n"+ " \"f0\": \"v0\",\n"+ " \"f2\": {\n"+ "    \t  \"boost\": 2.3,\n"+ "    \t  \"value\": \"test\"\n"+ "    \t   },\n"+ "\"array\": [ \"aaa\", \"bbb\" ],\n"+ "\"boosted\": {\n"+ "    \t      \"boost\": 6.7,\n"+ "    \t      \"value\": [ \"aaa\", \"bbb\" ]\n"+ "    \t    }\n"+ " }\n"+ "\n"+ "\n"+ " {\"f1\": \"v1\",\n"+ "  \"f2\": \"v2\",\n"+ "   \"f3\": null\n"+ "  }\n";
  req=req("srcField","_src_");
  req.getContext().put("path","/update/json/docs");
  rsp=new SolrQueryResponse();
  p=new BufferingRequestProcessor(null);
  loader=new JsonLoader();
  loader.load(req,rsp,new ContentStreamBase.StringStream(doc),p);
  assertEquals(2,p.addCommands.size());
  String content=(String)p.addCommands.get(0).solrDoc.getFieldValue("_src_");
  assertNotNull(content);
  Map obj=(Map)ObjectBuilder.fromJSON(content);
  assertEquals(Boolean.TRUE,obj.get("bool"));
  assertEquals("v0",obj.get("f0"));
  assertNotNull(obj.get("f0"));
  assertNotNull(obj.get("array"));
  assertNotNull(obj.get("boosted"));
  content=(String)p.addCommands.get(1).solrDoc.getFieldValue("_src_");
  assertNotNull(content);
  obj=(Map)ObjectBuilder.fromJSON(content);
  assertEquals("v1",obj.get("f1"));
  assertEquals("v2",obj.get("f2"));
  assertTrue(obj.containsKey("f3"));
  doc="[{'id':'1'},{'id':'2'}]".replace('\'','"');
  req=req("srcField","_src_");
  req.getContext().put("path","/update/json/docs");
  rsp=new SolrQueryResponse();
  p=new BufferingRequestProcessor(null);
  loader=new JsonLoader();
  loader.load(req,rsp,new ContentStreamBase.StringStream(doc),p);
  assertEquals(2,p.addCommands.size());
  content=(String)p.addCommands.get(0).solrDoc.getFieldValue("_src_");
  assertNotNull(content);
  obj=(Map)ObjectBuilder.fromJSON(content);
  assertEquals("1",obj.get("id"));
  content=(String)p.addCommands.get(1).solrDoc.getFieldValue("_src_");
  assertNotNull(content);
  obj=(Map)ObjectBuilder.fromJSON(content);
  assertEquals("2",obj.get("id"));
  String json="{a:{" + "b:[{c:c1, e:e1},{c:c2, e :e2, d:{p:q}}]," + "x:y"+ "}}";
  req=req("split","/|/a/b");
  req.getContext().put("path","/update/json/docs");
  rsp=new SolrQueryResponse();
  p=new BufferingRequestProcessor(null);
  loader=new JsonLoader();
  loader.load(req,rsp,new ContentStreamBase.StringStream(json),p);
  assertEquals(1,p.addCommands.size());
  assertEquals("y",p.addCommands.get(0).solrDoc.getFieldValue("a.x"));
  List<SolrInputDocument> children=p.addCommands.get(0).solrDoc.getChildDocuments();
  assertEquals(2,children.size());
  SolrInputDocument d=children.get(0);
  assertEquals(d.getFieldValue("c"),"c1");
  assertEquals(d.getFieldValue("e"),"e1");
  d=children.get(1);
  assertEquals(d.getFieldValue("c"),"c2");
  assertEquals(d.getFieldValue("e"),"e2");
  assertEquals(d.getFieldValue("d.p"),"q");
  json="{\n" + "  \"id\": \"1\",\n" + "  \"name\": \"i am the parent\",\n"+ "  \"cat\": \"parent\",\n"+ "  \"children\": [\n"+ "    {\n"+ "      \"id\": \"1.1\",\n"+ "      \"name\": \"i am the 1st child\",\n"+ "      \"cat\": \"child\"\n"+ "    },\n"+ "    {\n"+ "      \"id\": \"1.2\",\n"+ "      \"name\": \"i am the 2nd child\",\n"+ "      \"cat\": \"child\",\n"+ "      \"grandchildren\": [\n"+ "        {\n"+ "          \"id\": \"1.2.1\",\n"+ "          \"name\": \"i am the grandchild\",\n"+ "          \"cat\": \"grandchild\"\n"+ "        }\n"+ "      ]\n"+ "    }\n"+ "  ]\n"+ "}";
  req=req("split","/|/children|/children/grandchildren","f","$FQN:/**","f","id:/children/id","f","/name","f","/children/name","f","cat:/children/cat","f","id:/children/grandchildren/id","f","name:/children/grandchildren/name","f","cat:/children/grandchildren/cat");
  req.getContext().put("path","/update/json/docs");
  rsp=new SolrQueryResponse();
  p=new BufferingRequestProcessor(null);
  loader=new JsonLoader();
  loader.load(req,rsp,new ContentStreamBase.StringStream(json),p);
  assertEquals(2,p.addCommands.get(0).solrDoc.getChildDocuments().size());
  assertEquals(1,p.addCommands.get(0).solrDoc.getChildDocuments().get(1).getChildDocuments().size());
}
