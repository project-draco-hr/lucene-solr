{
  String segFileName=IndexFileNames.segmentFileName(si.name,"",SimpleTextSegmentInfoFormat.SI_EXTENSION);
  si.addFile(segFileName);
  boolean success=false;
  IndexOutput output=dir.createOutput(segFileName,ioContext);
  try {
    BytesRefBuilder scratch=new BytesRefBuilder();
    SimpleTextUtil.write(output,SI_VERSION);
    SimpleTextUtil.write(output,si.getVersion(),scratch);
    SimpleTextUtil.writeNewline(output);
    SimpleTextUtil.write(output,SI_DOCCOUNT);
    SimpleTextUtil.write(output,Integer.toString(si.getDocCount()),scratch);
    SimpleTextUtil.writeNewline(output);
    SimpleTextUtil.write(output,SI_USECOMPOUND);
    SimpleTextUtil.write(output,Boolean.toString(si.getUseCompoundFile()),scratch);
    SimpleTextUtil.writeNewline(output);
    Map<String,String> diagnostics=si.getDiagnostics();
    int numDiagnostics=diagnostics == null ? 0 : diagnostics.size();
    SimpleTextUtil.write(output,SI_NUM_DIAG);
    SimpleTextUtil.write(output,Integer.toString(numDiagnostics),scratch);
    SimpleTextUtil.writeNewline(output);
    if (numDiagnostics > 0) {
      for (      Map.Entry<String,String> diagEntry : diagnostics.entrySet()) {
        SimpleTextUtil.write(output,SI_DIAG_KEY);
        SimpleTextUtil.write(output,diagEntry.getKey(),scratch);
        SimpleTextUtil.writeNewline(output);
        SimpleTextUtil.write(output,SI_DIAG_VALUE);
        SimpleTextUtil.write(output,diagEntry.getValue(),scratch);
        SimpleTextUtil.writeNewline(output);
      }
    }
    Set<String> files=si.files();
    int numFiles=files == null ? 0 : files.size();
    SimpleTextUtil.write(output,SI_NUM_FILES);
    SimpleTextUtil.write(output,Integer.toString(numFiles),scratch);
    SimpleTextUtil.writeNewline(output);
    if (numFiles > 0) {
      for (      String fileName : files) {
        SimpleTextUtil.write(output,SI_FILE);
        SimpleTextUtil.write(output,fileName,scratch);
        SimpleTextUtil.writeNewline(output);
      }
    }
    SimpleTextUtil.writeChecksum(output,scratch);
    success=true;
  }
  finally {
    if (!success) {
      IOUtils.closeWhileHandlingException(output);
      try {
        dir.deleteFile(segFileName);
      }
 catch (      Throwable t) {
      }
    }
 else {
      output.close();
    }
  }
}
