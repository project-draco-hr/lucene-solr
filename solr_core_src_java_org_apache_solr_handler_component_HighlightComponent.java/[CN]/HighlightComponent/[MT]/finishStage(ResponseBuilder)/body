{
  if (rb.doHighlights && rb.stage == ResponseBuilder.STAGE_GET_FIELDS) {
    NamedList.NamedListEntry[] arr=new NamedList.NamedListEntry[rb.resultIds.size()];
    for (    ShardRequest sreq : rb.finished) {
      if ((sreq.purpose & ShardRequest.PURPOSE_GET_HIGHLIGHTS) == 0)       continue;
      for (      ShardResponse srsp : sreq.responses) {
        if (srsp.getException() != null) {
          continue;
        }
        NamedList hl=(NamedList)srsp.getSolrResponse().getResponse().get("highlighting");
        SolrPluginUtils.copyNamedListIntoArrayByDocPosInResponse(hl,rb.resultIds,arr);
      }
    }
    rb.rsp.add("highlighting",SolrPluginUtils.removeNulls(arr,new SimpleOrderedMap<>()));
  }
}
