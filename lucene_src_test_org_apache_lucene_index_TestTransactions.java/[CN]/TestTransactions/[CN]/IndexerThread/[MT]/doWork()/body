{
  IndexWriter writer1=new IndexWriter(dir1,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)).setMaxBufferedDocs(3));
  ((LogMergePolicy)writer1.getConfig().getMergePolicy()).setMergeFactor(2);
  ((ConcurrentMergeScheduler)writer1.getConfig().getMergeScheduler()).setSuppressExceptions();
  IndexWriter writer2=new IndexWriter(dir2,new IndexWriterConfig(TEST_VERSION_CURRENT,new WhitespaceAnalyzer(TEST_VERSION_CURRENT)).setMaxBufferedDocs(2));
  ((LogMergePolicy)writer2.getConfig().getMergePolicy()).setMergeFactor(3);
  ((ConcurrentMergeScheduler)writer2.getConfig().getMergeScheduler()).setSuppressExceptions();
  update(writer1);
  update(writer2);
  TestTransactions.doFail=true;
  try {
synchronized (lock) {
      try {
        writer1.prepareCommit();
      }
 catch (      Throwable t) {
        writer1.rollback();
        writer2.rollback();
        return;
      }
      try {
        writer2.prepareCommit();
      }
 catch (      Throwable t) {
        writer1.rollback();
        writer2.rollback();
        return;
      }
      writer1.commit();
      writer2.commit();
    }
  }
  finally {
    TestTransactions.doFail=false;
  }
  writer1.close();
  writer2.close();
}
