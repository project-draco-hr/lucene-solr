{
  ZkCoreNodeProps leaderCNodeProps=new ZkCoreNodeProps(leaderprops);
  String leaderUrl=leaderCNodeProps.getCoreUrl();
  log.info("Attempting to replicate from " + leaderUrl + ". core="+ coreName);
  commitOnLeader(leaderUrl);
  SolrRequestHandler handler=core.getRequestHandler(REPLICATION_HANDLER);
  if (handler instanceof LazyRequestHandlerWrapper) {
    handler=((LazyRequestHandlerWrapper)handler).getWrappedHandler();
  }
  ReplicationHandler replicationHandler=(ReplicationHandler)handler;
  if (replicationHandler == null) {
    throw new SolrException(ErrorCode.SERVICE_UNAVAILABLE,"Skipping recovery, no " + REPLICATION_HANDLER + " handler found");
  }
  ModifiableSolrParams solrParams=new ModifiableSolrParams();
  solrParams.set(ReplicationHandler.MASTER_URL,leaderUrl);
  if (isClosed())   return;
  boolean success=replicationHandler.doFetch(solrParams,false);
  if (!success) {
    throw new SolrException(ErrorCode.SERVER_ERROR,"Replication for recovery failed.");
  }
  if (log.isDebugEnabled()) {
    try {
      RefCounted<SolrIndexSearcher> searchHolder=core.getNewestSearcher(false);
      SolrIndexSearcher searcher=searchHolder.get();
      Directory dir=core.getDirectoryFactory().get(core.getIndexDir(),DirContext.META_DATA,null);
      try {
        log.debug(core.getCoreDescriptor().getCoreContainer().getZkController().getNodeName() + " replicated " + searcher.search(new MatchAllDocsQuery(),1).totalHits+ " from "+ leaderUrl+ " gen:"+ core.getDeletionPolicy().getLatestCommit().getGeneration()+ " data:"+ core.getDataDir()+ " index:"+ core.getIndexDir()+ " newIndex:"+ core.getNewIndexDir()+ " files:"+ Arrays.asList(dir.listAll()));
      }
  finally {
        core.getDirectoryFactory().release(dir);
        searchHolder.decref();
      }
    }
 catch (    Exception e) {
      throw new SolrException(ErrorCode.SERVER_ERROR,null,e);
    }
  }
}
