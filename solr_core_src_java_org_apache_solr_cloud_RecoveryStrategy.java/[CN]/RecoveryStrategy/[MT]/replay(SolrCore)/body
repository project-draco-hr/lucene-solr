{
  Future<RecoveryInfo> future=core.getUpdateHandler().getUpdateLog().applyBufferedUpdates();
  if (future == null) {
    log.info("No replay needed. core=" + coreName);
  }
 else {
    log.info("Replaying buffered documents. core=" + coreName);
    RecoveryInfo report=future.get();
    if (report.failed) {
      SolrException.log(log,"Replay failed");
      throw new SolrException(ErrorCode.SERVER_ERROR,"Replay failed");
    }
  }
  if (Boolean.getBoolean("solr.cloud.debug")) {
    try {
      RefCounted<SolrIndexSearcher> searchHolder=core.getNewestSearcher(false);
      SolrIndexSearcher searcher=searchHolder.get();
      try {
        System.out.println(core.getCoreDescriptor().getCoreContainer().getZkController().getNodeName() + " replayed " + searcher.search(new MatchAllDocsQuery(),1).totalHits);
      }
  finally {
        searchHolder.decref();
      }
    }
 catch (    Exception e) {
      throw new SolrException(ErrorCode.SERVER_ERROR,null,e);
    }
  }
  return future;
}
