{
  SolrQuery query=new SolrQuery("*:*");
  query.set("distrib",false);
  commit();
  long deadShardCount=shardToClient.get(SHARD2).get(0).query(query).getResults().getNumFound();
  System.err.println("dsc:" + deadShardCount);
  query("q","*:*","sort","n_tl1 desc");
  JettySolrRunner deadShard=chaosMonkey.stopShard(SHARD2,0);
  cloudClient.connect();
  int tries=0;
  while (cloudClient.getZkStateReader().getCloudState().liveNodesContain(clientToInfo.get(new CloudSolrServerClient(shardToClient.get(SHARD2).get(0))).get(ZkStateReader.NODE_NAME_PROP))) {
    if (tries++ == 60) {
      fail("Shard still reported as live in zk");
    }
    Thread.sleep(1000);
  }
  try {
    index_specific(shardToClient.get(SHARD2).get(0),id,999,i1,107,t1,"specific doc!");
    fail("This server should be down and this update should have failed");
  }
 catch (  SolrServerException e) {
  }
  commit();
  query("q","*:*","sort","n_tl1 desc");
  tries=0;
  while (((SolrDispatchFilter)shardToJetty.get(SHARD2).get(1).jetty.getDispatchFilter().getFilter()).getCores().getZkController().getZkStateReader().getCloudState().liveNodesContain(clientToInfo.get(new CloudSolrServerClient(shardToClient.get(SHARD2).get(0))).get(ZkStateReader.NODE_NAME_PROP))) {
    if (tries++ == 60) {
      fail("Shard still reported as live in zk");
    }
    Thread.sleep(1000);
  }
  long numFound1=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  index_specific(shardToClient.get(SHARD2).get(1),id,1000,i1,108,t1,"specific doc!");
  commit();
  checkShardConsistency(true,false);
  query("q","*:*","sort","n_tl1 desc");
  cloudClient.setDefaultCollection(DEFAULT_COLLECTION);
  long numFound2=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(numFound1 + 1,numFound2);
  SolrInputDocument doc=new SolrInputDocument();
  doc.addField("id",1001);
  controlClient.add(doc);
  UpdateRequest ureq=new UpdateRequest();
  ureq.add(doc);
  ureq.process(cloudClient);
  commit();
  query("q","*:*","sort","n_tl1 desc");
  long numFound3=cloudClient.query(new SolrQuery("*:*")).getResults().getNumFound();
  assertEquals(numFound2 + 1,numFound3);
  testDebugQueries();
  if (VERBOSE) {
    System.err.println(controlClient.query(new SolrQuery("*:*")).getResults().getNumFound());
    for (    SolrServer client : clients) {
      try {
        SolrQuery q=new SolrQuery("*:*");
        q.set("distrib",false);
        System.err.println(client.query(q).getResults().getNumFound());
      }
 catch (      Exception e) {
      }
    }
  }
  deadShard.start(true);
  Thread.sleep(1500);
  waitForRecoveriesToFinish(false);
  deadShardCount=shardToClient.get(SHARD2).get(0).query(query).getResults().getNumFound();
  checkShardConsistency(true,false);
  deadShard=chaosMonkey.stopShard(SHARD2,0);
  for (int i=0; i < 226; i++) {
    doc=new SolrInputDocument();
    doc.addField("id",2000 + i);
    controlClient.add(doc);
    ureq=new UpdateRequest();
    ureq.add(doc);
    ureq.process(cloudClient);
  }
  commit();
  deadShard.start(true);
  Thread.sleep(1500);
  waitForRecoveriesToFinish(false);
  checkShardConsistency(true,false);
}
