{
  Directory dir=newDirectory();
  CodecProvider provider=new MockCodecProvider();
  if (VERBOSE) {
    System.out.println("TEST: make new index");
  }
  IndexWriterConfig iwconf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.CREATE).setCodecProvider(provider);
  iwconf.setMaxBufferedDocs(IndexWriterConfig.DISABLE_AUTO_FLUSH);
  IndexWriter writer=newWriter(dir,iwconf);
  addDocs(writer,10);
  writer.commit();
  assertQuery(new Term("content","aaa"),dir,10,provider);
  if (VERBOSE) {
    System.out.println("TEST: addDocs3");
  }
  addDocs3(writer,10);
  writer.commit();
  writer.close();
  assertQuery(new Term("content","ccc"),dir,10,provider);
  assertQuery(new Term("content","aaa"),dir,10,provider);
  assertCodecPerField(_TestUtil.checkIndex(dir,provider),"content",provider.lookup("MockSep"));
  iwconf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer()).setOpenMode(OpenMode.APPEND).setCodecProvider(provider);
  iwconf.setMaxBufferedDocs(IndexWriterConfig.DISABLE_AUTO_FLUSH);
  provider=new MockCodecProvider2();
  iwconf.setCodecProvider(provider);
  writer=newWriter(dir,iwconf);
  if (VERBOSE) {
    System.out.println("TEST: add docs w/ Standard codec for content field");
  }
  addDocs2(writer,10);
  writer.commit();
  Codec origContentCodec=provider.lookup("MockSep");
  Codec newContentCodec=provider.lookup("Standard");
  assertHybridCodecPerField(_TestUtil.checkIndex(dir,provider),"content",origContentCodec,origContentCodec,newContentCodec);
  assertEquals(30,writer.maxDoc());
  assertQuery(new Term("content","bbb"),dir,10,provider);
  assertQuery(new Term("content","ccc"),dir,10,provider);
  assertQuery(new Term("content","aaa"),dir,10,provider);
  if (VERBOSE) {
    System.out.println("TEST: add more docs w/ new codec");
  }
  addDocs2(writer,10);
  writer.commit();
  assertQuery(new Term("content","ccc"),dir,10,provider);
  assertQuery(new Term("content","bbb"),dir,20,provider);
  assertQuery(new Term("content","aaa"),dir,10,provider);
  assertEquals(40,writer.maxDoc());
  if (VERBOSE) {
    System.out.println("TEST: now optimize");
  }
  writer.optimize();
  assertEquals(40,writer.maxDoc());
  writer.close();
  assertCodecPerFieldOptimized(_TestUtil.checkIndex(dir,provider),"content",newContentCodec);
  assertQuery(new Term("content","ccc"),dir,10,provider);
  assertQuery(new Term("content","bbb"),dir,20,provider);
  assertQuery(new Term("content","aaa"),dir,10,provider);
  dir.close();
}
