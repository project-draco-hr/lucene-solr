{
  Directory dir=newDirectory(random);
  final int docsPerRound=97;
  int numRounds=atLeast(1);
  for (int i=0; i < numRounds; i++) {
    CodecProvider provider=new CodecProvider();
    Codec[] codecs=new Codec[]{new StandardCodec(),new SimpleTextCodec(),new MockSepCodec(),new PulsingCodec(1 + random.nextInt(20)),new MockVariableIntBlockCodec(1 + random.nextInt(10)),new MockFixedIntBlockCodec(1 + random.nextInt(10))};
    for (    Codec codec : codecs) {
      provider.register(codec);
    }
    int num=_TestUtil.nextInt(random,30,60);
    for (int j=0; j < num; j++) {
      provider.setFieldCodec("" + j,codecs[random.nextInt(codecs.length)].name);
    }
    IndexWriterConfig config=newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer(random));
    config.setOpenMode(OpenMode.CREATE_OR_APPEND);
    config.setCodecProvider(provider);
    IndexWriter writer=newWriter(dir,config);
    for (int j=0; j < docsPerRound; j++) {
      final Document doc=new Document();
      for (int k=0; k < num; k++) {
        FieldType customType=new FieldType(TextField.TYPE_UNSTORED);
        customType.setTokenized(random.nextBoolean());
        customType.setOmitNorms(random.nextBoolean());
        Field field=newField("" + k,_TestUtil.randomRealisticUnicodeString(random,128),customType);
        doc.add(field);
      }
      writer.addDocument(doc);
    }
    if (random.nextBoolean()) {
      writer.optimize();
    }
    writer.commit();
    assertEquals((i + 1) * docsPerRound,writer.maxDoc());
    writer.close();
  }
  dir.close();
}
