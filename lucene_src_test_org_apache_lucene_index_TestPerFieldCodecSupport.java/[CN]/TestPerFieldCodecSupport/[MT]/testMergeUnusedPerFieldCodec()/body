{
  Directory dir=newDirectory();
  CodecProvider provider=new MockCodecProvider();
  IndexWriterConfig iwconf=newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setCodecProvider(provider);
  IndexWriter writer=newWriter(dir,iwconf);
  addDocs(writer,10);
  writer.commit();
  addDocs3(writer,10);
  writer.commit();
  addDocs2(writer,10);
  writer.commit();
  assertEquals(30,writer.maxDoc());
  _TestUtil.checkIndex(dir,provider);
  writer.optimize();
  assertEquals(30,writer.maxDoc());
  writer.close();
  dir.close();
}
