{
  if (branch != null) {
    if (state.not % 2 == 1) {
      BooleanQuery.Builder nq=new BooleanQuery.Builder();
      nq.add(branch,BooleanClause.Occur.MUST_NOT);
      nq.add(new MatchAllDocsQuery(),BooleanClause.Occur.SHOULD);
      branch=nq.build();
    }
    if (state.top == null) {
      state.top=branch;
    }
 else {
      if (state.currentOperation == null) {
        state.currentOperation=defaultOperator;
      }
      if (state.previousOperation != state.currentOperation) {
        BooleanQuery.Builder bq=new BooleanQuery.Builder();
        bq.add(state.top,state.currentOperation);
        state.top=bq.build();
      }
      state.top=addClause((BooleanQuery)state.top,branch,state.currentOperation);
      state.previousOperation=state.currentOperation;
    }
    state.currentOperation=null;
  }
}
