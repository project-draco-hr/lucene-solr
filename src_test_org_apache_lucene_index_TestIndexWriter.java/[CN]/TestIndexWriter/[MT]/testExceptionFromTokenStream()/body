{
  RAMDirectory dir=new MockRAMDirectory();
  IndexWriterConfig conf=new IndexWriterConfig(TEST_VERSION_CURRENT);
  conf.setAnalyzer(new Analyzer(){
    @Override public TokenStream tokenStream(    String fieldName,    Reader reader){
      return new TokenFilter(new StandardTokenizer(TEST_VERSION_CURRENT,reader)){
        private int count=0;
        @Override public boolean incrementToken() throws IOException {
          if (count++ == 5) {
            throw new IOException();
          }
          return input.incrementToken();
        }
      }
;
    }
  }
);
  IndexWriter writer=new IndexWriter(dir,conf);
  Document doc=new Document();
  String contents="aa bb cc dd ee ff gg hh ii jj kk";
  doc.add(new Field("content",contents,Field.Store.NO,Field.Index.ANALYZED));
  try {
    writer.addDocument(doc);
    fail("did not hit expected exception");
  }
 catch (  Exception e) {
  }
  doc=new Document();
  doc.add(new Field("content","aa bb cc dd",Field.Store.NO,Field.Index.ANALYZED));
  writer.addDocument(doc);
  doc=new Document();
  doc.add(new Field("content","aa bb cc dd",Field.Store.NO,Field.Index.ANALYZED));
  writer.addDocument(doc);
  writer.close();
  IndexReader reader=IndexReader.open(dir,true);
  final Term t=new Term("content","aa");
  assertEquals(reader.docFreq(t),3);
  TermDocs tdocs=reader.termDocs(t);
  int count=0;
  while (tdocs.next()) {
    count++;
  }
  assertEquals(2,count);
  assertEquals(reader.docFreq(new Term("content","gg")),0);
  reader.close();
  dir.close();
}
