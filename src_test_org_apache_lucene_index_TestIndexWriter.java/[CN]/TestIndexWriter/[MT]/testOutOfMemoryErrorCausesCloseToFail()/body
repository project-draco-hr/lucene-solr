{
  final List thrown=new ArrayList();
  final IndexWriter writer=new IndexWriter(new MockRAMDirectory(),new StandardAnalyzer(org.apache.lucene.util.Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.UNLIMITED){
    public void message(    final String message){
      if (message.startsWith("now flush at close") && 0 == thrown.size()) {
        thrown.add(null);
        throw new OutOfMemoryError("fake OOME at " + message);
      }
    }
  }
;
  writer.setInfoStream(new PrintStream(new ByteArrayOutputStream()));
  try {
    writer.close();
    fail("OutOfMemoryError expected");
  }
 catch (  final OutOfMemoryError expected) {
  }
  writer.close();
}
