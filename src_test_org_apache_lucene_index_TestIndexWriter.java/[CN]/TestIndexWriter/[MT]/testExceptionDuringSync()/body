{
  MockRAMDirectory dir=new MockRAMDirectory();
  FailOnlyInSync failure=new FailOnlyInSync();
  dir.failOn(failure);
  IndexWriter writer=new IndexWriter(dir,true,new WhitespaceAnalyzer());
  failure.setDoFail();
  ConcurrentMergeScheduler cms=new ConcurrentMergeScheduler();
  cms.setSuppressExceptions();
  writer.setMergeScheduler(cms);
  writer.setMaxBufferedDocs(2);
  writer.setMergeFactor(5);
  for (int i=0; i < 23; i++)   addDoc(writer);
  cms.sync();
  assertTrue(failure.didFail);
  failure.clearDoFail();
  writer.close();
  IndexReader reader=IndexReader.open(dir);
  assertEquals(23,reader.numDocs());
  reader.close();
  dir.close();
}
