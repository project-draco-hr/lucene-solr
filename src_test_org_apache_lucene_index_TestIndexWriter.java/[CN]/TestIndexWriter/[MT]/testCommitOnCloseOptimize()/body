{
  RAMDirectory dir=new RAMDirectory();
  IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.LIMITED);
  writer.setMaxBufferedDocs(10);
  for (int j=0; j < 17; j++) {
    addDocWithIndex(writer,j);
  }
  writer.close();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(),false,IndexWriter.MaxFieldLength.LIMITED);
  writer.optimize();
  IndexReader reader=IndexReader.open(dir);
  assertFalse("Reader incorrectly sees that the index is optimized",reader.isOptimized());
  reader.close();
  writer.abort();
  assertNoUnreferencedFiles(dir,"aborted writer after optimize");
  reader=IndexReader.open(dir);
  assertFalse("Reader incorrectly sees that the index is optimized",reader.isOptimized());
  reader.close();
  writer=new IndexWriter(dir,new WhitespaceAnalyzer(),false,IndexWriter.MaxFieldLength.LIMITED);
  writer.optimize();
  writer.close();
  assertNoUnreferencedFiles(dir,"aborted writer after optimize");
  reader=IndexReader.open(dir);
  assertTrue("Reader incorrectly sees that the index is unoptimized",reader.isOptimized());
  reader.close();
}
