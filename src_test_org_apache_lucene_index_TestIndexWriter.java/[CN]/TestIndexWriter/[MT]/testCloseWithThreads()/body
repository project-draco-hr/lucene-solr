{
  int NUM_THREADS=3;
  for (int iter=0; iter < 20; iter++) {
    MockRAMDirectory dir=new MockRAMDirectory();
    IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
    ConcurrentMergeScheduler cms=new ConcurrentMergeScheduler();
    cms.setSuppressExceptions();
    writer.setMergeScheduler(cms);
    writer.setMaxBufferedDocs(10);
    writer.setMergeFactor(4);
    IndexerThread[] threads=new IndexerThread[NUM_THREADS];
    for (int i=0; i < NUM_THREADS; i++)     threads[i]=new IndexerThread(writer,false);
    for (int i=0; i < NUM_THREADS; i++)     threads[i].start();
    boolean done=false;
    while (!done) {
      Thread.sleep(100);
      for (int i=0; i < NUM_THREADS; i++)       if (threads[i].addCount > 0) {
        done=true;
        break;
      }
    }
    writer.close(false);
    for (int i=0; i < NUM_THREADS; i++) {
      threads[i].join();
      if (threads[i].isAlive())       fail("thread seems to be hung");
    }
    IndexReader reader=IndexReader.open(dir);
    TermDocs tdocs=reader.termDocs(new Term("field","aaa"));
    int count=0;
    while (tdocs.next()) {
      count++;
    }
    assertTrue(count > 0);
    reader.close();
    dir.close();
  }
}
