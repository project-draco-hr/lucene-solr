{
  RAMDirectory startDir=new MockRAMDirectory();
  IndexWriter w=new IndexWriter(startDir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.UNLIMITED);
  w.setMaxBufferedDocs(2);
  w.setMergeFactor(100);
  for (int i=0; i < 27; i++)   addDoc(w);
  w.close();
  for (int i=0; i < 200; i++) {
    MockRAMDirectory dir=new MockRAMDirectory(startDir);
    w=new IndexWriter(dir,new WhitespaceAnalyzer(Version.LUCENE_CURRENT),IndexWriter.MaxFieldLength.UNLIMITED);
    ((ConcurrentMergeScheduler)w.getMergeScheduler()).setSuppressExceptions();
    dir.setRandomIOExceptionRate(0.5,100);
    try {
      w.optimize();
    }
 catch (    IOException ioe) {
      if (ioe.getCause() == null)       fail("optimize threw IOException without root cause");
    }
    w.close();
    dir.close();
  }
}
