{
  Directory dir=new MockRAMDirectory();
  IndexWriter w=new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  w.setMaxBufferedDocs(2);
  for (int j=0; j < 17; j++)   addDoc(w);
  w.close();
  assertEquals(0,IndexReader.getCommitUserData(dir).size());
  IndexReader r=IndexReader.open(dir);
  assertEquals(0,r.getCommitUserData().size());
  r.close();
  w=new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  w.setMaxBufferedDocs(2);
  for (int j=0; j < 17; j++)   addDoc(w);
  Map data=new HashMap();
  data.put("label","test1");
  w.commit(data);
  w.close();
  assertEquals("test1",IndexReader.getCommitUserData(dir).get("label"));
  r=IndexReader.open(dir);
  assertEquals("test1",r.getCommitUserData().get("label"));
  r.close();
  w=new IndexWriter(dir,new WhitespaceAnalyzer(),IndexWriter.MaxFieldLength.LIMITED);
  w.optimize();
  w.close();
  assertEquals("test1",IndexReader.getCommitUserData(dir).get("label"));
  dir.close();
}
