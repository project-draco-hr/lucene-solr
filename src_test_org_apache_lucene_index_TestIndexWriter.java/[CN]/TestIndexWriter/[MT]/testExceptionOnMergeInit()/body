{
  MockRAMDirectory dir=new MockRAMDirectory();
  MockIndexWriter2 w=new MockIndexWriter2(dir,new WhitespaceAnalyzer(TEST_VERSION_CURRENT),true,IndexWriter.MaxFieldLength.UNLIMITED);
  w.setMaxBufferedDocs(2);
  w.setMergeFactor(2);
  w.doFail=true;
  w.setMergeScheduler(new ConcurrentMergeScheduler());
  Document doc=new Document();
  doc.add(new Field("field","a field",Field.Store.YES,Field.Index.ANALYZED));
  for (int i=0; i < 10; i++)   try {
    w.addDocument(doc);
  }
 catch (  RuntimeException re) {
    break;
  }
  ((ConcurrentMergeScheduler)w.getMergeScheduler()).sync();
  assertTrue(w.failed);
  w.close();
  dir.close();
}
