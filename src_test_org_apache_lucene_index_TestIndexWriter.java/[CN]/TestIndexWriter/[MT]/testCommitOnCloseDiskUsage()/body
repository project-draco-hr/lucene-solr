{
  MockRAMDirectory dir=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(dir,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.LIMITED);
  for (int j=0; j < 30; j++) {
    addDocWithIndex(writer,j);
  }
  writer.close();
  dir.resetMaxUsedSizeInBytes();
  long startDiskUsage=dir.getMaxUsedSizeInBytes();
  writer=new IndexWriter(dir,false,new WhitespaceAnalyzer(),false,IndexWriter.MaxFieldLength.LIMITED);
  for (int j=0; j < 1470; j++) {
    addDocWithIndex(writer,j);
  }
  long midDiskUsage=dir.getMaxUsedSizeInBytes();
  dir.resetMaxUsedSizeInBytes();
  writer.optimize();
  writer.close();
  long endDiskUsage=dir.getMaxUsedSizeInBytes();
  assertTrue("writer used to much space while adding documents when autoCommit=false",midDiskUsage < 100 * startDiskUsage);
  assertTrue("writer used to much space after close when autoCommit=false",endDiskUsage < 100 * startDiskUsage);
}
