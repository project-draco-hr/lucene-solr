{
  MockRAMDirectory dir=new MockRAMDirectory();
  MockIndexWriter w=new MockIndexWriter(dir,false,new WhitespaceAnalyzer(),true,IndexWriter.MaxFieldLength.UNLIMITED);
  w.setMaxBufferedDocs(2);
  Document doc=new Document();
  doc.add(new Field("field","a field",Field.Store.YES,Field.Index.TOKENIZED));
  w.addDocument(doc);
  Analyzer analyzer=new Analyzer(){
    public TokenStream tokenStream(    String fieldName,    Reader reader){
      return new CrashingFilter(fieldName,new WhitespaceTokenizer(reader));
    }
  }
;
  Document crashDoc=new Document();
  crashDoc.add(new Field("crash","do it on token 4",Field.Store.YES,Field.Index.TOKENIZED));
  try {
    w.addDocument(crashDoc,analyzer);
    fail("did not hit expected exception");
  }
 catch (  IOException ioe) {
  }
  w.addDocument(doc);
  w.close();
  dir.close();
}
