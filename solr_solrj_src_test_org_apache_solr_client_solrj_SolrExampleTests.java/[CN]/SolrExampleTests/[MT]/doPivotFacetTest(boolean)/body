{
  SolrServer server=getSolrServer();
  server.deleteByQuery("*:*");
  server.commit();
  assertNumFound("*:*",0);
  int id=1;
  ArrayList<SolrInputDocument> docs=new ArrayList<>();
  docs.add(makeTestDoc("id",id++,"features","aaa","cat","a","inStock",true));
  docs.add(makeTestDoc("id",id++,"features","aaa","cat","a","inStock",false));
  docs.add(makeTestDoc("id",id++,"features","aaa","cat","a","inStock",true));
  docs.add(makeTestDoc("id",id++,"features","aaa","cat","b","inStock",false));
  docs.add(makeTestDoc("id",id++,"features","aaa","cat","b","inStock",true));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","a","inStock",false));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","a","inStock",true));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","b","inStock",false));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","b","inStock",true));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","b","inStock",false));
  docs.add(makeTestDoc("id",id++,"features","bbb","cat","b","inStock",true));
  docs.add(makeTestDoc("id",id++,"cat","b"));
  server.add(docs);
  server.commit();
  SolrQuery query=new SolrQuery("*:*");
  query.addFacetPivotField("features,cat","cat,features","features,cat,inStock");
  query.setFacetMinCount(0);
  query.setFacetMissing(missing);
  query.setRows(0);
  QueryResponse rsp=server.query(query);
  assertEquals(docs.size(),rsp.getResults().getNumFound());
  NamedList<List<PivotField>> pivots=rsp.getFacetPivot();
  assertEquals(3,pivots.size());
  assertEquals("features,cat",pivots.getName(0));
  List<PivotField> pivot=pivots.getVal(0);
  assertEquals(missing ? 3 : 2,pivot.size());
  PivotField ff=pivot.get(0);
  assertEquals("features",ff.getField());
  assertEquals("bbb",ff.getValue());
  assertEquals(6,ff.getCount());
  List<PivotField> counts=ff.getPivot();
  assertEquals(2,counts.size());
  assertEquals("cat",counts.get(0).getField());
  assertEquals("b",counts.get(0).getValue());
  assertEquals(4,counts.get(0).getCount());
  assertEquals("a",counts.get(1).getValue());
  assertEquals(2,counts.get(1).getCount());
  ff=pivot.get(1);
  assertEquals("features",ff.getField());
  assertEquals("aaa",ff.getValue());
  assertEquals(5,ff.getCount());
  counts=ff.getPivot();
  assertEquals(2,counts.size());
  assertEquals("cat",counts.get(0).getField());
  assertEquals("a",counts.get(0).getValue());
  assertEquals(3,counts.get(0).getCount());
  assertEquals("b",counts.get(1).getValue());
  assertEquals(2,counts.get(1).getCount());
  if (missing) {
    ff=pivot.get(2);
    assertEquals("features",ff.getField());
    assertEquals(null,ff.getValue());
    assertEquals(1,ff.getCount());
    counts=ff.getPivot();
    assertEquals(1,counts.size());
    assertEquals("cat",counts.get(0).getField());
    assertEquals("b",counts.get(0).getValue());
    assertEquals(1,counts.get(0).getCount());
  }
  assertEquals("cat,features",pivots.getName(1));
  pivot=pivots.getVal(1);
  assertEquals(2,pivot.size());
  ff=pivot.get(0);
  assertEquals("cat",ff.getField());
  assertEquals("b",ff.getValue());
  assertEquals(7,ff.getCount());
  counts=ff.getPivot();
  assertEquals(missing ? 3 : 2,counts.size());
  assertEquals("features",counts.get(0).getField());
  assertEquals("bbb",counts.get(0).getValue());
  assertEquals(4,counts.get(0).getCount());
  assertEquals("aaa",counts.get(1).getValue());
  assertEquals(2,counts.get(1).getCount());
  if (missing) {
    assertEquals(null,counts.get(2).getValue());
    assertEquals(1,counts.get(2).getCount());
  }
  ff=pivot.get(1);
  assertEquals("cat",ff.getField());
  assertEquals("a",ff.getValue());
  assertEquals(5,ff.getCount());
  counts=ff.getPivot();
  assertEquals(2,counts.size());
  assertEquals("features",counts.get(0).getField());
  assertEquals("aaa",counts.get(0).getValue());
  assertEquals(3,counts.get(0).getCount());
  assertEquals("bbb",counts.get(1).getValue());
  assertEquals(2,counts.get(1).getCount());
  assertEquals("features,cat,inStock",pivots.getName(2));
  pivot=pivots.getVal(2);
  assertEquals(missing ? 3 : 2,pivot.size());
  PivotField p=pivot.get(1).getPivot().get(0);
  assertEquals("cat",p.getField());
  assertEquals("a",p.getValue());
  counts=p.getPivot();
  assertEquals(2,counts.size());
  assertEquals("inStock",counts.get(0).getField());
  assertEquals(Boolean.TRUE,counts.get(0).getValue());
  assertEquals(2,counts.get(0).getCount());
  if (missing) {
    p=pivot.get(2);
    assertEquals("features",p.getField());
    assertEquals(null,p.getValue());
    assertEquals(1,p.getCount());
    assertEquals(1,p.getPivot().size());
    p=p.getPivot().get(0);
    assertEquals("cat",p.getField());
    assertEquals("b",p.getValue());
    assertEquals(1,p.getCount());
    assertEquals(1,p.getPivot().size());
    p=p.getPivot().get(0);
    assertEquals("inStock",p.getField());
    assertEquals(null,p.getValue());
    assertEquals(1,p.getCount());
    assertEquals(null,p.getPivot());
  }
  query=new SolrQuery("*:*");
  query.addFacetPivotField("{!ex=mytag key=mykey}features,cat");
  query.addFilterQuery("{!tag=mytag}-(features:bbb AND cat:a AND inStock:true)");
  query.setFacetMinCount(0);
  query.setRows(0);
  rsp=server.query(query);
  assertEquals(docs.size() - 1,rsp.getResults().getNumFound());
  pivots=rsp.getFacetPivot();
  pivot=pivots.getVal(0);
  assertEquals("mykey",pivots.getName(0));
  assertEquals(2,pivot.size());
  ff=pivot.get(0);
  assertEquals("features",ff.getField());
  assertEquals("bbb",ff.getValue());
  assertEquals(6,ff.getCount());
  counts=ff.getPivot();
  assertEquals(2,counts.size());
  assertEquals("cat",counts.get(0).getField());
  assertEquals("b",counts.get(0).getValue());
  assertEquals(4,counts.get(0).getCount());
  assertEquals("a",counts.get(1).getValue());
  assertEquals(2,counts.get(1).getCount());
}
