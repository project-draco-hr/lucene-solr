{
  Directory indexDir=newDirectory();
  Directory taxoDir=newDirectory();
  index100Docs(indexDir,taxoDir);
  DirectoryReader r=DirectoryReader.open(indexDir);
  TaxonomyReader tr=new DirectoryTaxonomyReader(taxoDir);
  FacetSearchParams fsp=new FacetSearchParams();
  CountFacetRequest facetRequest=new CountFacetRequest(new CategoryPath("root"),10);
  facetRequest.setDepth(2);
  facetRequest.setResultMode(ResultMode.PER_NODE_IN_TREE);
  fsp.addFacetRequest(facetRequest);
  final SamplingParams params=new SamplingParams();
  params.setMinSampleSize(2);
  params.setMaxSampleSize(50);
  params.setOversampleFactor(5);
  params.setSampingThreshold(60);
  params.setSampleRatio(0.1);
  FacetResult res=searchWithFacets(r,tr,fsp,params);
  FacetRequest req=res.getFacetRequest();
  assertEquals(facetRequest,req);
  FacetResultNode rootNode=res.getFacetResultNode();
  for (  FacetResultNode node : rootNode.getSubResults()) {
    assertTrue("node " + node.getLabel() + " should have had children as the requested depth was '2'",node.getNumSubResults() > 0);
  }
  IOUtils.close(r,tr,indexDir,taxoDir);
}
