{
  assertU(adoc("id","42","trait_s","Tool","trait_s","Obnoxious","name","Zapp Brannigan"));
  assertU(adoc("id","43","title","Democratic Order of Planets"));
  assertU(commit());
  assertU(adoc("id","44","trait_s","Tool","name","The Zapper"));
  assertU(adoc("id","45","trait_s","Chauvinist","title","25 star General"));
  assertU(adoc("id","46","trait_s","Obnoxious","subject","Defeated the pacifists of the Gandhi nebula"));
  assertU(commit());
  assertU(adoc("id","47","trait_s","Pig","text","line up and fly directly at the enemy death cannons, clogging them with wreckage!"));
  assertU(commit());
  assertQ("standard request handler returns all matches",req("id:[42 TO 47]"),"*[count(//doc)=6]");
  assertQ("filter results using fq",req("q","id:[42 TO 46]","fq","id:[43 TO 47]"),"*[count(//doc)=4]");
  assertQ("don't filter results using blank fq",req("q","id:[42 TO 46]","fq"," "),"*[count(//doc)=5]");
  assertQ("filter results using multiple fq params",req("q","id:[42 TO 46]","fq","trait_s:Obnoxious","fq","id:[43 TO 47]"),"*[count(//doc)=1]");
  assertQ("check counts for facet queries",req("q","id:[42 TO 47]","facet","true","facet.query","trait_s:Obnoxious","facet.query","id:[42 TO 45]","facet.query","id:[43 TO 47]","facet.field","trait_s"),"*[count(//doc)=6]","//lst[@name='facet_counts']/lst[@name='facet_queries']","//lst[@name='facet_queries']/int[@name='trait_s:Obnoxious'][.='2']","//lst[@name='facet_queries']/int[@name='id:[42 TO 45]'][.='4']","//lst[@name='facet_queries']/int[@name='id:[43 TO 47]'][.='5']","//lst[@name='facet_counts']/lst[@name='facet_fields']","//lst[@name='facet_fields']/lst[@name='trait_s']","*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='2']","//lst[@name='trait_s']/int[@name='Pig'][.='1']");
  assertQ("check multi-select facets with naming",req("q","id:[42 TO 47]","facet","true","facet.query","{!ex=1}trait_s:Obnoxious","facet.query","{!ex=2 key=foo}id:[42 TO 45]","facet.query","{!ex=3,4 key=bar}id:[43 TO 47]","facet.field","{!ex=3,1}trait_s","fq","{!tag=1,2}id:47"),"*[count(//doc)=1]","//lst[@name='facet_counts']/lst[@name='facet_queries']","//lst[@name='facet_queries']/int[@name='{!ex=1}trait_s:Obnoxious'][.='2']","//lst[@name='facet_queries']/int[@name='foo'][.='4']","//lst[@name='facet_queries']/int[@name='bar'][.='1']","//lst[@name='facet_counts']/lst[@name='facet_fields']","//lst[@name='facet_fields']/lst[@name='trait_s']","*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='2']","//lst[@name='trait_s']/int[@name='Pig'][.='1']");
  assertQ("check counts for applied facet queries using filtering (fq)",req("q","id:[42 TO 47]","facet","true","fq","id:[42 TO 45]","facet.field","trait_s","facet.query","id:[42 TO 45]","facet.query","id:[43 TO 47]"),"*[count(//doc)=4]","//lst[@name='facet_counts']/lst[@name='facet_queries']","//lst[@name='facet_queries']/int[@name='id:[42 TO 45]'][.='4']","//lst[@name='facet_queries']/int[@name='id:[43 TO 47]'][.='3']","*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='1']","//lst[@name='trait_s']/int[@name='Chauvinist'][.='1']","//lst[@name='trait_s']/int[@name='Pig'][.='0']");
  assertQ("check counts with facet.zero=false&facet.missing=true using fq",req("q","id:[42 TO 47]","facet","true","facet.zeros","false","f.trait_s.facet.missing","true","fq","id:[42 TO 45]","facet.field","trait_s"),"*[count(//doc)=4]","*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='1']","//lst[@name='trait_s']/int[@name='Chauvinist'][.='1']","//lst[@name='trait_s']/int[not(@name)][.='1']");
  assertQ("check counts with facet.mincount=1&facet.missing=true using fq",req("q","id:[42 TO 47]","facet","true","facet.mincount","1","f.trait_s.facet.missing","true","fq","id:[42 TO 45]","facet.field","trait_s"),"*[count(//doc)=4]","*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='1']","//lst[@name='trait_s']/int[@name='Chauvinist'][.='1']","//lst[@name='trait_s']/int[not(@name)][.='1']");
  assertQ("check counts with facet.mincount=2&facet.missing=true using fq",req("q","id:[42 TO 47]","facet","true","facet.mincount","2","f.trait_s.facet.missing","true","fq","id:[42 TO 45]","facet.field","trait_s"),"*[count(//doc)=4]","*[count(//lst[@name='trait_s']/int)=2]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[not(@name)][.='1']");
  assertQ("check sorted paging",req("q","id:[42 TO 47]","facet","true","fq","id:[42 TO 45]","facet.field","trait_s","facet.mincount","0","facet.offset","0","facet.limit","4"),"*[count(//lst[@name='trait_s']/int)=4]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='1']","//lst[@name='trait_s']/int[@name='Chauvinist'][.='1']","//lst[@name='trait_s']/int[@name='Pig'][.='0']");
  assertQ("check sorted paging",req("q","id:[42 TO 47]","facet","true","fq","id:[42 TO 45]","facet.field","trait_s","facet.mincount","0","facet.offset","0","facet.limit","3"),"*[count(//lst[@name='trait_s']/int)=3]","//lst[@name='trait_s']/int[@name='Tool'][.='2']","//lst[@name='trait_s']/int[@name='Obnoxious'][.='1']","//lst[@name='trait_s']/int[@name='Chauvinist'][.='1']");
}
