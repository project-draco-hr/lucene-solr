{
  Version version=Version.valueOf(config.get("writer.version",Version.LUCENE_50.toString()));
  IndexWriterConfig iwConf=new IndexWriterConfig(version,runData.getAnalyzer());
  iwConf.setOpenMode(mode);
  IndexDeletionPolicy indexDeletionPolicy=getIndexDeletionPolicy(config);
  iwConf.setIndexDeletionPolicy(indexDeletionPolicy);
  if (commit != null)   iwConf.setIndexCommit(commit);
  final String mergeScheduler=config.get("merge.scheduler","org.apache.lucene.index.ConcurrentMergeScheduler");
  if (mergeScheduler.equals(NoMergeScheduler.class.getName())) {
    iwConf.setMergeScheduler(NoMergeScheduler.INSTANCE);
  }
 else {
    try {
      iwConf.setMergeScheduler(Class.forName(mergeScheduler).asSubclass(MergeScheduler.class).newInstance());
    }
 catch (    Exception e) {
      throw new RuntimeException("unable to instantiate class '" + mergeScheduler + "' as merge scheduler",e);
    }
    if (mergeScheduler.equals("org.apache.lucene.index.ConcurrentMergeScheduler")) {
      ConcurrentMergeScheduler cms=(ConcurrentMergeScheduler)iwConf.getMergeScheduler();
      int maxThreadCount=config.get("concurrent.merge.scheduler.max.thread.count",ConcurrentMergeScheduler.DEFAULT_MAX_THREAD_COUNT);
      int maxMergeCount=config.get("concurrent.merge.scheduler.max.merge.count",ConcurrentMergeScheduler.DEFAULT_MAX_MERGE_COUNT);
      cms.setMaxMergesAndThreads(maxMergeCount,maxThreadCount);
    }
  }
  final String defaultCodec=config.get("default.codec",null);
  if (defaultCodec != null) {
    try {
      Class<? extends Codec> clazz=Class.forName(defaultCodec).asSubclass(Codec.class);
      Codec.setDefault(clazz.newInstance());
    }
 catch (    Exception e) {
      throw new RuntimeException("Couldn't instantiate Codec: " + defaultCodec,e);
    }
  }
  final String mergePolicy=config.get("merge.policy","org.apache.lucene.index.LogByteSizeMergePolicy");
  boolean isCompound=config.get("compound",true);
  if (mergePolicy.equals(NoMergePolicy.class.getName())) {
    iwConf.setMergePolicy(isCompound ? NoMergePolicy.COMPOUND_FILES : NoMergePolicy.NO_COMPOUND_FILES);
  }
 else {
    try {
      iwConf.setMergePolicy(Class.forName(mergePolicy).asSubclass(MergePolicy.class).newInstance());
    }
 catch (    Exception e) {
      throw new RuntimeException("unable to instantiate class '" + mergePolicy + "' as merge policy",e);
    }
    iwConf.getMergePolicy().setNoCFSRatio(isCompound ? 1.0 : 0.0);
    if (iwConf.getMergePolicy() instanceof LogMergePolicy) {
      LogMergePolicy logMergePolicy=(LogMergePolicy)iwConf.getMergePolicy();
      logMergePolicy.setMergeFactor(config.get("merge.factor",OpenIndexTask.DEFAULT_MERGE_PFACTOR));
    }
  }
  final double ramBuffer=config.get("ram.flush.mb",OpenIndexTask.DEFAULT_RAM_FLUSH_MB);
  final int maxBuffered=config.get("max.buffered",OpenIndexTask.DEFAULT_MAX_BUFFERED);
  if (maxBuffered == IndexWriterConfig.DISABLE_AUTO_FLUSH) {
    iwConf.setRAMBufferSizeMB(ramBuffer);
    iwConf.setMaxBufferedDocs(maxBuffered);
  }
 else {
    iwConf.setMaxBufferedDocs(maxBuffered);
    iwConf.setRAMBufferSizeMB(ramBuffer);
  }
  return iwConf;
}
