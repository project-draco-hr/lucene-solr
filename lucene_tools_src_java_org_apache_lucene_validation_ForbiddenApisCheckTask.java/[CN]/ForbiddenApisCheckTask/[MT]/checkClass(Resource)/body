{
  final InputStream stream=res.getInputStream();
  try {
    final int[] violations=new int[1];
    new ClassReader(stream).accept(new ClassVisitor(Opcodes.ASM4){
      String className=null, source=null;
      @Override public void visit(      int version,      int access,      String name,      String signature,      String superName,      String[] interfaces){
        this.className=Type.getObjectType(name).getClassName();
      }
      @Override public void visitSource(      String source,      String debug){
        this.source=source;
      }
      @Override public MethodVisitor visitMethod(      int access,      String name,      String desc,      String signature,      String[] exceptions){
        return new MethodVisitor(Opcodes.ASM4){
          private int lineNo=-1;
          @Override public void visitMethodInsn(          int opcode,          String owner,          String name,          String desc){
            boolean found=false;
            String printout=forbiddenClasses.get(owner);
            if (printout != null) {
              found=true;
              log("Forbidden class use: " + printout,Project.MSG_ERR);
            }
 else {
              printout=forbiddenMethods.get(owner + '\000' + new Method(name,desc));
              if (printout != null) {
                found=true;
                log("Forbidden method invocation: " + printout,Project.MSG_ERR);
              }
            }
            if (found) {
              violations[0]++;
              final StringBuilder sb=new StringBuilder("  in ").append(className);
              if (source != null && lineNo >= 0) {
                new Formatter(sb,Locale.ENGLISH).format(" (%s:%d)",source,lineNo).flush();
              }
              log(sb.toString(),Project.MSG_ERR);
            }
          }
          @Override public void visitLineNumber(          int lineNo,          Label start){
            this.lineNo=lineNo;
          }
        }
;
      }
    }
,ClassReader.SKIP_FRAMES);
    return violations[0];
  }
  finally {
    stream.close();
  }
}
