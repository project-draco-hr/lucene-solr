{
  IOContext context=newIOContext(random());
  SegmentReader r1=new SegmentReader(si1,context);
  SegmentReader r2=new SegmentReader(si2,context);
  final Codec codec=Codec.getDefault();
  TrackingDirectoryWrapper trackingDir=new TrackingDirectoryWrapper(si1.info.dir);
  final SegmentInfo si=new SegmentInfo(si1.info.dir,Constants.LUCENE_MAIN_VERSION,merged,-1,false,codec,null,null);
  SegmentMerger merger=new SegmentMerger(Arrays.<AtomicReader>asList(r1,r2),si,InfoStream.getDefault(),trackingDir,MergeState.CheckAbort.NONE,new FieldInfos.FieldNumbers(),context);
  MergeState mergeState=merger.merge();
  r1.close();
  r2.close();
  final SegmentInfo info=new SegmentInfo(si1.info.dir,Constants.LUCENE_MAIN_VERSION,merged,si1.info.getDocCount() + si2.info.getDocCount(),false,codec,null,null);
  info.setFiles(new HashSet<String>(trackingDir.getCreatedFiles()));
  if (useCompoundFile) {
    Collection<String> filesToDelete=IndexWriter.createCompoundFile(InfoStream.getDefault(),dir,MergeState.CheckAbort.NONE,info,newIOContext(random()));
    info.setUseCompoundFile(true);
    for (    final String fileToDelete : filesToDelete) {
      si1.info.dir.deleteFile(fileToDelete);
    }
  }
  return new SegmentInfoPerCommit(info,0,-1L);
}
