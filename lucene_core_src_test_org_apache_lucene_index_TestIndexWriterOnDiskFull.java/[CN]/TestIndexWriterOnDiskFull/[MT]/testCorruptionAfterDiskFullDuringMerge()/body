{
  MockDirectoryWrapper dir=newMockDirectory();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMergeScheduler(new SerialMergeScheduler()).setReaderPooling(true).setMergePolicy(newLogMergePolicy(2)));
  w.setKeepFullyDeletedSegments(true);
  Document doc=new Document();
  doc.add(newTextField("f","doctor who",Field.Store.NO));
  w.addDocument(doc);
  w.commit();
  w.deleteDocuments(new Term("f","who"));
  w.addDocument(doc);
  FailTwiceDuringMerge ftdm=new FailTwiceDuringMerge();
  ftdm.setDoFail();
  dir.failOn(ftdm);
  try {
    w.commit();
    fail("fake disk full IOExceptions not hit");
  }
 catch (  IOException ioe) {
    assertTrue(ftdm.didFail1 || ftdm.didFail2);
  }
  TestUtil.checkIndex(dir);
  ftdm.clearDoFail();
  w.addDocument(doc);
  w.shutdown();
  dir.close();
}
