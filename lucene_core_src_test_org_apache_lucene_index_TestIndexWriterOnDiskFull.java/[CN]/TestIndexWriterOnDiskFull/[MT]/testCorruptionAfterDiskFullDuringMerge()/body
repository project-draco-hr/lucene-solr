{
  MockDirectoryWrapper dir=newDirectory();
  IndexWriter w=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random())).setMergeScheduler(new SerialMergeScheduler()).setReaderPooling(true).setMergePolicy(newLogMergePolicy(2)));
  _TestUtil.keepFullyDeletedSegments(w);
  Document doc=new Document();
  doc.add(newField("f","doctor who",TextField.TYPE_UNSTORED));
  w.addDocument(doc);
  w.commit();
  w.deleteDocuments(new Term("f","who"));
  w.addDocument(doc);
  FailTwiceDuringMerge ftdm=new FailTwiceDuringMerge();
  ftdm.setDoFail();
  dir.failOn(ftdm);
  try {
    w.commit();
    fail("fake disk full IOExceptions not hit");
  }
 catch (  IOException ioe) {
    assertTrue(ftdm.didFail1 || ftdm.didFail2);
  }
  _TestUtil.checkIndex(dir);
  ftdm.clearDoFail();
  w.addDocument(doc);
  w.close();
  dir.close();
}
