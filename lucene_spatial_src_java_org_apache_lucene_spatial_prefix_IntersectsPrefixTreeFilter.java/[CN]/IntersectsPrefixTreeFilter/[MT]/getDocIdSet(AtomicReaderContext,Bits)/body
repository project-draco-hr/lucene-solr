{
  return new VisitorTemplate(context,acceptDocs,hasIndexedLeaves){
    private FixedBitSet results;
    @Override protected void start(){
      results=new FixedBitSet(maxDoc);
    }
    @Override protected DocIdSet finish(){
      return results;
    }
    @Override protected boolean visit(    Node cell) throws IOException {
      if (cell.getShapeRel() == SpatialRelation.WITHIN || cell.getLevel() == detailLevel) {
        collectDocs(results);
        return false;
      }
      return true;
    }
    @Override protected void visitLeaf(    Node cell) throws IOException {
      collectDocs(results);
    }
    @Override protected void visitScanned(    Node cell) throws IOException {
      Shape cShape;
      if (cell.getLevel() == grid.getMaxLevels() && !cell.isLeaf())       cShape=cell.getCenter();
 else       cShape=cell.getShape();
      if (queryShape.relate(cShape).intersects())       collectDocs(results);
    }
  }
.getDocIdSet();
}
