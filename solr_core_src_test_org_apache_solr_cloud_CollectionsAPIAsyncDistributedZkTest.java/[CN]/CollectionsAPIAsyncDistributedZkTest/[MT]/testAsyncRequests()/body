{
  String collection="testAsyncOperations";
  Create createCollectionRequest=new Create().setCollectionName(collection).setNumShards(1).setRouterName("implicit").setShards("shard1").setConfigName("conf1").setAsyncId("42");
  CollectionAdminResponse response=createCollectionRequest.process(cloudClient);
  assertEquals("42",response.getResponse().get("requestid"));
  RequestStatusState state=getRequestStateAfterCompletion("42",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("CreateCollection task did not complete!",RequestStatusState.COMPLETED,state);
  int numDocs=TestUtil.nextInt(random(),10,100);
  List<SolrInputDocument> docs=new ArrayList<>(numDocs);
  for (int i=0; i < numDocs; i++) {
    SolrInputDocument doc=new SolrInputDocument();
    doc.addField("id",i);
    doc.addField("_route_","shard1");
    docs.add(doc);
  }
  cloudClient.add(collection,docs);
  cloudClient.commit(collection);
  SolrQuery query=new SolrQuery("*:*");
  query.set("shards","shard1");
  assertEquals(numDocs,cloudClient.query(collection,query).getResults().getNumFound());
  CollectionAdminRequest.Reload reloadCollection=new CollectionAdminRequest.Reload();
  reloadCollection.setCollectionName(collection).setAsyncId("43");
  response=reloadCollection.process(cloudClient);
  assertEquals("43",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("43",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("ReloadCollection did not complete",RequestStatusState.COMPLETED,state);
  CollectionAdminRequest.CreateShard createShard=new CollectionAdminRequest.CreateShard().setCollectionName(collection).setShardName("shard2").setAsyncId("44");
  response=createShard.process(cloudClient);
  assertEquals("44",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("44",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("CreateShard did not complete",RequestStatusState.COMPLETED,state);
  SolrInputDocument doc=new SolrInputDocument();
  doc.addField("id",numDocs + 1);
  doc.addField("_route_","shard2");
  cloudClient.add(collection,doc);
  cloudClient.commit(collection);
  query=new SolrQuery("*:*");
  query.set("shards","shard2");
  assertEquals(1,cloudClient.query(collection,query).getResults().getNumFound());
  CollectionAdminRequest.DeleteShard deleteShard=new CollectionAdminRequest.DeleteShard().setCollectionName(collection).setShardName("shard2").setAsyncId("45");
  response=deleteShard.process(cloudClient);
  assertEquals("45",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("45",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("DeleteShard did not complete",RequestStatusState.COMPLETED,state);
  CollectionAdminRequest.AddReplica addReplica=new CollectionAdminRequest.AddReplica().setCollectionName(collection).setShardName("shard1").setAsyncId("46");
  response=addReplica.process(cloudClient);
  assertEquals("46",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("46",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("AddReplica did not complete",RequestStatusState.COMPLETED,state);
  Slice shard1=cloudClient.getZkStateReader().getClusterState().getSlice(collection,"shard1");
  int count=0;
  while (shard1.getReplicas().size() != 2) {
    if (count++ > 1000) {
      fail("2nd Replica not reflecting in the cluster state");
    }
    Thread.sleep(100);
  }
  CollectionAdminRequest.CreateAlias createAlias=new CollectionAdminRequest.CreateAlias().setAliasName("myalias").setAliasedCollections(collection).setAsyncId("47");
  response=createAlias.process(cloudClient);
  assertEquals("47",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("47",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("CreateAlias did not complete",RequestStatusState.COMPLETED,state);
  query=new SolrQuery("*:*");
  query.set("shards","shard1");
  assertEquals(numDocs,cloudClient.query("myalias",query).getResults().getNumFound());
  CollectionAdminRequest.DeleteAlias deleteAlias=new CollectionAdminRequest.DeleteAlias().setAliasName("myalias").setAsyncId("48");
  response=deleteAlias.process(cloudClient);
  assertEquals("48",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("48",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("DeleteAlias did not complete",RequestStatusState.COMPLETED,state);
  try {
    cloudClient.query("myalias",query);
    fail("Alias should not exist");
  }
 catch (  SolrException e) {
  }
  String replica=shard1.getReplicas().iterator().next().getName();
  CollectionAdminRequest.DeleteReplica deleteReplica=new CollectionAdminRequest.DeleteReplica().setCollectionName(collection).setShardName("shard1").setReplica(replica).setAsyncId("47");
  response=deleteReplica.process(cloudClient);
  assertEquals("47",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("47",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("DeleteReplica did not complete",RequestStatusState.COMPLETED,state);
  CollectionAdminRequest.Delete deleteCollection=new CollectionAdminRequest.Delete().setCollectionName(collection).setAsyncId("48");
  response=deleteCollection.process(cloudClient);
  assertEquals("48",response.getResponse().get("requestid"));
  state=getRequestStateAfterCompletion("48",MAX_TIMEOUT_SECONDS,cloudClient);
  assertSame("DeleteCollection did not complete",RequestStatusState.COMPLETED,state);
}
