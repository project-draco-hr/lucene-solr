{
  Random random=random();
  final boolean wasOriginallyAtomic=r instanceof LeafReader;
  for (int i=0, c=random.nextInt(6) + 1; i < c; i++) {
switch (random.nextInt(6)) {
case 0:
      r=SlowCompositeReaderWrapper.wrap(r);
    break;
case 1:
  r=(r instanceof LeafReader) ? new ParallelLeafReader((LeafReader)r) : new ParallelCompositeReader((CompositeReader)r);
break;
case 2:
r=new FCInvisibleMultiReader(r);
break;
case 3:
final LeafReader ar=SlowCompositeReaderWrapper.wrap(r);
final List<String> allFields=new ArrayList<>();
for (FieldInfo fi : ar.getFieldInfos()) {
allFields.add(fi.name);
}
Collections.shuffle(allFields,random);
final int end=allFields.isEmpty() ? 0 : random.nextInt(allFields.size());
final Set<String> fields=new HashSet<>(allFields.subList(0,end));
r=new ParallelLeafReader(new FieldFilterLeafReader(ar,fields,false),new FieldFilterLeafReader(ar,fields,true));
break;
case 4:
if (r instanceof LeafReader) {
r=new AssertingLeafReader((LeafReader)r);
}
 else if (r instanceof DirectoryReader) {
r=new AssertingDirectoryReader((DirectoryReader)r);
}
break;
case 5:
if (r instanceof LeafReader) {
r=new MismatchedLeafReader((LeafReader)r,random);
}
 else if (r instanceof DirectoryReader) {
r=new MismatchedDirectoryReader((DirectoryReader)r,random);
}
break;
default :
fail("should not get here");
}
}
if (wasOriginallyAtomic) {
r=SlowCompositeReaderWrapper.wrap(r);
}
 else if ((r instanceof CompositeReader) && !(r instanceof FCInvisibleMultiReader)) {
r=new FCInvisibleMultiReader(r);
}
if (VERBOSE) {
System.out.println("wrapReader wrapped: " + r);
}
return r;
}
