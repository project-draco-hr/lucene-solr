{
  Random random=newRandom();
  int num=100;
  Directory indexA=new MockRAMDirectory();
  Directory indexB=new MockRAMDirectory();
  fillIndex(random,indexA,0,num);
  boolean fail=verifyIndex(indexA,0);
  if (fail) {
    fail("Index a is invalid");
  }
  fillIndex(random,indexB,num,num);
  fail=verifyIndex(indexB,num);
  if (fail) {
    fail("Index b is invalid");
  }
  Directory merged=new MockRAMDirectory();
  IndexWriter writer=new IndexWriter(merged,newIndexWriterConfig(random,TEST_VERSION_CURRENT,new MockAnalyzer()));
  ((LogMergePolicy)writer.getConfig().getMergePolicy()).setMergeFactor(2);
  writer.addIndexes(new Directory[]{indexA,indexB});
  writer.optimize();
  writer.close();
  fail=verifyIndex(merged,0);
  merged.close();
  assertFalse("The merged index is invalid",fail);
}
