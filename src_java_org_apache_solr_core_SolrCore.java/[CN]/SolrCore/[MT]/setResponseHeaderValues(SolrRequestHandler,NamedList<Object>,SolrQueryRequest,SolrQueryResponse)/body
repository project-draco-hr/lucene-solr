{
  final int qtime=(int)(rsp.getEndTime() - req.getStartTime());
  responseHeader.add("status",rsp.getException() == null ? 0 : 500);
  responseHeader.add("QTime",qtime);
  SolrParams params=req.getParams();
  if (params.getBool(CommonParams.HEADER_ECHO_HANDLER,false)) {
    responseHeader.add("handler",handler.getName());
  }
  String ep=params.get(CommonParams.HEADER_ECHO_PARAMS,null);
  if (ep != null) {
    EchoParamStyle echoParams=EchoParamStyle.get(ep);
    if (echoParams == null) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"Invalid value '" + ep + "' for "+ CommonParams.HEADER_ECHO_PARAMS+ " parameter, use '"+ EchoParamStyle.EXPLICIT+ "' or '"+ EchoParamStyle.ALL+ "'");
    }
    if (echoParams == EchoParamStyle.EXPLICIT) {
      responseHeader.add("params",req.getOriginalParams().toNamedList());
    }
 else     if (echoParams == EchoParamStyle.ALL) {
      responseHeader.add("params",req.getParams().toNamedList());
    }
  }
}
