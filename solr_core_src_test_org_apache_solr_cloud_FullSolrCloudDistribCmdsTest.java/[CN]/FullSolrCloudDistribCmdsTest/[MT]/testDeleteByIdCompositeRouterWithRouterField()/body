{
  SolrClient server=createNewSolrClient("",getBaseUrl((HttpSolrClient)clients.get(0)));
  CollectionAdminResponse response;
  Map<String,NamedList<Integer>> coresStatus;
  CollectionAdminRequest.Create createCollectionRequest=new CollectionAdminRequest.Create();
  createCollectionRequest.setCollectionName("compositeid_collection_with_routerfield");
  createCollectionRequest.setRouterName("compositeId");
  createCollectionRequest.setRouterField("routefield_s");
  createCollectionRequest.setNumShards(2);
  createCollectionRequest.setShards("shard1,shard2");
  createCollectionRequest.setReplicationFactor(2);
  createCollectionRequest.setConfigName("conf1");
  response=createCollectionRequest.process(server);
  assertEquals(0,response.getStatus());
  assertTrue(response.isSuccess());
  coresStatus=response.getCollectionCoresStatus();
  assertEquals(4,coresStatus.size());
  for (int i=0; i < 4; i++) {
    NamedList<Integer> status=coresStatus.get("compositeid_collection_with_routerfield_shard" + (i / 2 + 1) + "_replica"+ (i % 2 + 1));
    assertEquals(0,(int)status.get("status"));
    assertTrue(status.get("QTime") > 0);
  }
  SolrClient shard1=createNewSolrClient("compositeid_collection_with_routerfield_shard1_replica1",getBaseUrl((HttpSolrClient)clients.get(0)));
  SolrClient shard2=createNewSolrClient("compositeid_collection_with_routerfield_shard2_replica1",getBaseUrl((HttpSolrClient)clients.get(0)));
  SolrInputDocument doc=new SolrInputDocument();
  int docCounts1=0, docCounts2=0;
  doc.clear();
  doc.addField("id","1");
  doc.addField("title","s1 one");
  doc.addField("routefield_s","europe");
  shard1.add(doc);
  shard1.commit();
  doc.clear();
  doc.addField("id","2");
  doc.addField("title","s1 two");
  doc.addField("routefield_s","europe");
  shard1.add(doc);
  shard1.commit();
  doc.clear();
  doc.addField("id","3");
  doc.addField("title","s1 three");
  doc.addField("routefield_s","europe");
  shard1.add(doc);
  shard1.commit();
  docCounts1=3;
  doc.clear();
  doc.addField("id","4");
  doc.addField("title","s2 four");
  doc.addField("routefield_s","africa");
  shard2.add(doc);
  doc.clear();
  doc.addField("id","5");
  doc.addField("title","s2 five");
  doc.addField("routefield_s","africa");
  shard2.add(doc);
  shard2.commit();
  docCounts2=2;
  ModifiableSolrParams query=new ModifiableSolrParams();
  query.set("q","*:*");
  QueryResponse respAll=shard1.query(query);
  assertEquals(docCounts1 + docCounts2,respAll.getResults().getNumFound());
  query.set("shards","shard1");
  QueryResponse resp1=shard1.query(query);
  assertEquals(docCounts1,resp1.getResults().getNumFound());
  query.set("shards","shard2");
  QueryResponse resp2=shard2.query(query);
  assertEquals(docCounts2,resp2.getResults().getNumFound());
  UpdateRequest deleteRequest=new UpdateRequest();
  deleteRequest.deleteById("4","africa");
  deleteRequest.setCommitWithin(1);
  shard1.request(deleteRequest);
  shard1.commit();
  query.set("shards","shard2");
  resp2=shard2.query(query);
  --docCounts2;
  assertEquals(docCounts2,resp2.getResults().getNumFound());
  deleteRequest.clear();
  deleteRequest.deleteById("2","europe");
  deleteRequest.deleteById("3","europe");
  deleteRequest.setCommitWithin(1);
  query.set("shards","shard1");
  shard1.request(deleteRequest);
  shard1.commit();
  Thread.sleep(1000);
  resp1=shard1.query(query);
  --docCounts1;
  --docCounts1;
  assertEquals(docCounts1,resp1.getResults().getNumFound());
  deleteRequest.clear();
  deleteRequest.deleteById("1","europe");
  deleteRequest.setCommitWithin(1);
  shard2.request(deleteRequest);
  query.set("shards","shard1");
  resp1=shard1.query(query);
  --docCounts1;
  assertEquals(docCounts1,resp1.getResults().getNumFound());
}
