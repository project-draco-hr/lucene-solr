{
  long freeSpace=dir.maxSize == 0 ? 0 : dir.maxSize - dir.sizeInBytes();
  long realUsage=0;
  if (dir.maxSize != 0 && freeSpace <= len) {
    realUsage=dir.getRecomputedActualSizeInBytes();
    freeSpace=dir.maxSize - realUsage;
  }
  if (dir.maxSize != 0 && freeSpace <= len) {
    if (freeSpace > 0) {
      realUsage+=freeSpace;
      if (b != null) {
        delegate.writeBytes(b,offset,(int)freeSpace);
      }
 else {
        delegate.copyBytes(in,len);
      }
    }
    if (realUsage > dir.maxUsedSize) {
      dir.maxUsedSize=realUsage;
    }
    String message="fake disk full at " + dir.getRecomputedActualSizeInBytes() + " bytes when writing "+ name+ " (file length="+ delegate.getFilePointer();
    if (freeSpace > 0) {
      message+="; wrote " + freeSpace + " of "+ len+ " bytes";
    }
    message+=")";
    if (LuceneTestCase.VERBOSE) {
      System.out.println(Thread.currentThread().getName() + ": MDW: now throw fake disk full");
      new Throwable().printStackTrace(System.out);
    }
    throw new IOException(message);
  }
}
