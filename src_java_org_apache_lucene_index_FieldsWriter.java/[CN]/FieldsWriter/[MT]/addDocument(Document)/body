{
  indexStream.writeLong(fieldsStream.getFilePointer());
  int storedCount=0;
  Enumeration fields=doc.fields();
  while (fields.hasMoreElements()) {
    Field field=(Field)fields.nextElement();
    if (field.isStored())     storedCount++;
  }
  fieldsStream.writeVInt(storedCount);
  fields=doc.fields();
  while (fields.hasMoreElements()) {
    Field field=(Field)fields.nextElement();
    if (field.isStored()) {
      fieldsStream.writeVInt(fieldInfos.fieldNumber(field.name()));
      byte bits=0;
      if (field.isTokenized())       bits|=1;
      if (field.isBinary())       bits|=2;
      fieldsStream.writeByte(bits);
      if (field.isBinary()) {
        byte[] data=field.binaryValue();
        final int len=data.length;
        fieldsStream.writeVInt(len);
        fieldsStream.writeBytes(data,len);
      }
 else {
        fieldsStream.writeString(field.stringValue());
      }
    }
  }
}
