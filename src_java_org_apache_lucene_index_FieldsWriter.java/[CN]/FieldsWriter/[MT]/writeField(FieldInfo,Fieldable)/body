{
  boolean disableCompression=(field instanceof FieldsReader.FieldForMerge);
  fieldsStream.writeVInt(fi.number);
  byte bits=0;
  if (field.isTokenized())   bits|=FieldsWriter.FIELD_IS_TOKENIZED;
  if (field.isBinary())   bits|=FieldsWriter.FIELD_IS_BINARY;
  if (field.isCompressed())   bits|=FieldsWriter.FIELD_IS_COMPRESSED;
  fieldsStream.writeByte(bits);
  if (field.isCompressed()) {
    final byte[] data;
    final int len;
    final int offset;
    if (disableCompression) {
      data=field.getBinaryValue();
      len=field.getBinaryLength();
      offset=field.getBinaryOffset();
    }
 else {
      if (field.isBinary()) {
        data=compress(field.getBinaryValue(),field.getBinaryOffset(),field.getBinaryLength());
      }
 else {
        byte x[]=field.stringValue().getBytes("UTF-8");
        data=compress(x,0,x.length);
      }
      len=data.length;
      offset=0;
    }
    fieldsStream.writeVInt(len);
    fieldsStream.writeBytes(data,offset,len);
  }
 else {
    if (field.isBinary()) {
      final byte[] data;
      final int len;
      final int offset;
      data=field.getBinaryValue();
      len=field.getBinaryLength();
      offset=field.getBinaryOffset();
      fieldsStream.writeVInt(len);
      fieldsStream.writeBytes(data,offset,len);
    }
 else {
      fieldsStream.writeString(field.stringValue());
    }
  }
}
