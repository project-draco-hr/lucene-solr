{
  boolean disableCompression=(field instanceof FieldsReader.FieldForMerge);
  fieldsStream.writeVInt(fi.number);
  byte bits=0;
  if (field.isTokenized())   bits|=FieldsWriter.FIELD_IS_TOKENIZED;
  if (field.isBinary())   bits|=FieldsWriter.FIELD_IS_BINARY;
  if (field.isCompressed())   bits|=FieldsWriter.FIELD_IS_COMPRESSED;
  fieldsStream.writeByte(bits);
  if (field.isCompressed()) {
    byte[] data=null;
    if (disableCompression) {
      data=field.binaryValue();
    }
 else {
      if (field.isBinary()) {
        data=compress(field.binaryValue());
      }
 else {
        data=compress(field.stringValue().getBytes("UTF-8"));
      }
    }
    final int len=data.length;
    fieldsStream.writeVInt(len);
    fieldsStream.writeBytes(data,len);
  }
 else {
    if (field.isBinary()) {
      byte[] data=field.binaryValue();
      final int len=data.length;
      fieldsStream.writeVInt(len);
      fieldsStream.writeBytes(data,len);
    }
 else {
      fieldsStream.writeString(field.stringValue());
    }
  }
}
