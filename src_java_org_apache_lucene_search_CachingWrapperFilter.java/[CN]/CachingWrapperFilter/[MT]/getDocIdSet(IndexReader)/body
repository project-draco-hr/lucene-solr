{
  lock.lock();
  try {
    if (cache == null) {
      cache=new WeakHashMap<IndexReader,DocIdSet>();
    }
    final DocIdSet cached=cache.get(reader);
    if (cached != null)     return cached;
  }
  finally {
    lock.unlock();
  }
  final DocIdSet docIdSet=docIdSetToCache(filter.getDocIdSet(reader),reader);
  if (docIdSet != null) {
    lock.lock();
    try {
      cache.put(reader,docIdSet);
    }
  finally {
      lock.unlock();
    }
  }
  return docIdSet;
}
