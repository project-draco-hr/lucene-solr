{
  responseWriter.start();
  NamedList nl=response.getValues();
  for (int i=0; i < nl.size(); i++) {
    String name=nl.getName(i);
    Object val=nl.getVal(i);
    if (RESPONSE_HEADER.equals(name)) {
      Boolean omitHeader=request.getParams().getBool(CommonParams.OMIT_HEADER);
      if (omitHeader == null || !omitHeader)       responseWriter.writeResponseHeader((NamedList)val);
    }
 else     if (val instanceof SolrDocumentList) {
      SolrDocumentList list=(SolrDocumentList)val;
      DocListInfo info=new DocListInfo(list.getNumFound(),list.getStart(),list.getMaxScore());
      if (responseWriter.isStreamingDocs()) {
        responseWriter.startDocumentList(info);
        for (        SolrDocument solrDocument : list)         responseWriter.writeDoc(solrDocument);
        responseWriter.endDocumentList();
      }
 else {
        responseWriter.writeAllDocs(info,list);
      }
    }
 else     if (val instanceof DocList) {
      DocList docList=(DocList)val;
      int sz=docList.size();
      IdxInfo idxInfo=new IdxInfo(request.getSchema(),request.getSearcher(),response.getReturnFields());
      DocListInfo info=new DocListInfo(docList.matches(),docList.offset(),docList.maxScore());
      DocIterator iterator=docList.iterator();
      if (responseWriter.isStreamingDocs()) {
        responseWriter.startDocumentList(info);
        for (int j=0; j < sz; j++) {
          SolrDocument sdoc=getDoc(iterator.nextDoc(),idxInfo);
          if (idxInfo.includeScore && docList.hasScores()) {
            sdoc.addField(SCORE_FIELD,iterator.score());
          }
          responseWriter.writeDoc(sdoc);
        }
        responseWriter.end();
      }
 else {
        ArrayList<SolrDocument> list=new ArrayList<SolrDocument>(docList.size());
        for (int j=0; j < sz; j++) {
          SolrDocument sdoc=getDoc(iterator.nextDoc(),idxInfo);
          if (idxInfo.includeScore && docList.hasScores()) {
            sdoc.addField(SCORE_FIELD,iterator.score());
          }
        }
        responseWriter.writeAllDocs(info,list);
      }
    }
 else {
      responseWriter.writeOther(name,val);
    }
  }
  responseWriter.end();
}
