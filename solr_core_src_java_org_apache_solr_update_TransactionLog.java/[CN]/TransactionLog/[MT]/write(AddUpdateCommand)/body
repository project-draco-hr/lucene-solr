{
  LogCodec codec=new LogCodec();
  long pos=0;
synchronized (this) {
    try {
      pos=fos.size();
      SolrInputDocument sdoc=cmd.getSolrInputDocument();
      if (pos == 0) {
        addGlobalStrings(sdoc.getFieldNames());
        writeLogHeader(codec);
        pos=fos.size();
      }
      codec.init(fos);
      codec.writeTag(JavaBinCodec.ARR,3);
      codec.writeInt(UpdateLog.ADD);
      codec.writeLong(cmd.getVersion());
      codec.writeSolrInputDocument(cmd.getSolrInputDocument());
      endRecord(pos);
      return pos;
    }
 catch (    IOException e) {
      throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,"Error logging add",e);
    }
  }
}
