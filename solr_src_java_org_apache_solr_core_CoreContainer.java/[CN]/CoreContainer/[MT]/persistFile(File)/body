{
  log.info("Persisting cores config to " + (file == null ? configFile : file));
  File tmpFile=null;
  try {
    if (file == null) {
      file=tmpFile=File.createTempFile("solr",".xml",configFile.getParentFile());
    }
    java.io.FileOutputStream out=new java.io.FileOutputStream(file);
    Writer writer=new BufferedWriter(new OutputStreamWriter(out,"UTF-8"));
    persist(writer);
    writer.flush();
    writer.close();
    out.close();
    if (tmpFile != null) {
      if (tmpFile.renameTo(configFile))       tmpFile=null;
 else       fileCopy(tmpFile,configFile);
    }
  }
 catch (  java.io.FileNotFoundException xnf) {
    throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,xnf);
  }
catch (  java.io.IOException xio) {
    throw new SolrException(SolrException.ErrorCode.SERVER_ERROR,xio);
  }
 finally {
    if (tmpFile != null) {
      if (!tmpFile.delete())       tmpFile.deleteOnExit();
    }
  }
}
