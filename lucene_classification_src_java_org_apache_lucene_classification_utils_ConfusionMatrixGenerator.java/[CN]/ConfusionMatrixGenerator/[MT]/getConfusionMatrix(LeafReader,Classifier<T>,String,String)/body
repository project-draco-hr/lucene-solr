{
  Map<String,Map<String,Long>> counts=new HashMap<>();
  for (int i=0; i < reader.maxDoc(); i++) {
    StoredDocument doc=reader.document(i);
    String correctAnswer=doc.get(classFieldName);
    if (correctAnswer != null && correctAnswer.length() > 0) {
      ClassificationResult<T> result=classifier.assignClass(doc.get(textFieldName));
      T assignedClass=result.getAssignedClass();
      String classified=assignedClass instanceof BytesRef ? ((BytesRef)assignedClass).utf8ToString() : assignedClass.toString();
      Map<String,Long> stringLongMap=counts.get(correctAnswer);
      if (stringLongMap != null) {
        Long aLong=stringLongMap.get(classified);
        if (aLong != null) {
          stringLongMap.put(classified,aLong + 1);
        }
 else {
          stringLongMap.put(classified,1l);
        }
      }
 else {
        stringLongMap=new HashMap<>();
        stringLongMap.put(classified,1l);
        counts.put(correctAnswer,stringLongMap);
      }
    }
  }
  return new ConfusionMatrix(counts);
}
