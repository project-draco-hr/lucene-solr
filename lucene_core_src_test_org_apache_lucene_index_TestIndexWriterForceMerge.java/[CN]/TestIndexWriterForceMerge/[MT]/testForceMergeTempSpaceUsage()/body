{
  final MockDirectoryWrapper dir=newMockDirectory();
  dir.setEnableVirusScanner(false);
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setMaxBufferedDocs(10).setMergePolicy(newLogMergePolicy()));
  if (VERBOSE) {
    System.out.println("TEST: config1=" + writer.getConfig());
  }
  for (int j=0; j < 500; j++) {
    TestIndexWriter.addDocWithIndex(writer,j);
  }
  writer.commit();
  TestIndexWriter.addDocWithIndex(writer,500);
  writer.close();
  long startDiskUsage=0;
  for (  String f : dir.listAll()) {
    startDiskUsage+=dir.fileLength(f);
    if (VERBOSE) {
      System.out.println(f + ": " + dir.fileLength(f));
    }
  }
  if (VERBOSE) {
    System.out.println("TEST: start disk usage = " + startDiskUsage);
  }
  dir.resetMaxUsedSizeInBytes();
  dir.setTrackDiskUsage(true);
  writer=new IndexWriter(dir,newIndexWriterConfig(new MockAnalyzer(random())).setOpenMode(OpenMode.APPEND).setMergePolicy(newLogMergePolicy()));
  if (VERBOSE) {
    System.out.println("TEST: config2=" + writer.getConfig());
  }
  writer.forceMerge(1);
  writer.close();
  long finalDiskUsage=0;
  for (  String f : dir.listAll()) {
    finalDiskUsage+=dir.fileLength(f);
    if (VERBOSE) {
      System.out.println(f + ": " + dir.fileLength(f));
    }
  }
  if (VERBOSE) {
    System.out.println("TEST: final disk usage = " + finalDiskUsage);
  }
  long maxStartFinalDiskUsage=Math.max(startDiskUsage,finalDiskUsage);
  long maxDiskUsage=dir.getMaxUsedSizeInBytes();
  assertTrue("forceMerge used too much temporary space: starting usage was " + startDiskUsage + " bytes; final usage was "+ finalDiskUsage+ " bytes; max temp usage was "+ maxDiskUsage+ " but should have been "+ (3 * maxStartFinalDiskUsage)+ " (= 3X starting usage)",maxDiskUsage <= 3 * maxStartFinalDiskUsage);
  dir.close();
}
