{
  final int limit=Math.max(1,reader.maxDoc());
  if (after != null && after.doc >= limit) {
    throw new IllegalArgumentException("after.doc exceeds the number of documents in the reader: after.doc=" + after.doc + " limit="+ limit);
  }
  final int cappedNumHits=Math.min(numHits,limit);
  final CollectorManager<TopFieldCollector,TopFieldDocs> manager=new CollectorManager<TopFieldCollector,TopFieldDocs>(){
    @Override public TopFieldCollector newCollector() throws IOException {
      final boolean fillFields=true;
      return TopFieldCollector.create(sort,cappedNumHits,after,fillFields,doDocScores,doMaxScore);
    }
    @Override public TopFieldDocs reduce(    Collection<TopFieldCollector> collectors) throws IOException {
      final TopFieldDocs[] topDocs=new TopFieldDocs[collectors.size()];
      int i=0;
      for (      TopFieldCollector collector : collectors) {
        topDocs[i++]=collector.topDocs();
      }
      return TopDocs.merge(sort,cappedNumHits,topDocs);
    }
  }
;
  return search(query,manager);
}
