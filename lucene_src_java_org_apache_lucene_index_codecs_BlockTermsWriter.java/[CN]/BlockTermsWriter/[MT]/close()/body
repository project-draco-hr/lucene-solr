{
  try {
    int nonZeroCount=0;
    for (    TermsWriter field : fields) {
      if (field.numTerms > 0) {
        nonZeroCount++;
      }
    }
    final long dirStart=out.getFilePointer();
    out.writeVInt(nonZeroCount);
    for (    TermsWriter field : fields) {
      if (field.numTerms > 0) {
        out.writeVInt(field.fieldInfo.number);
        out.writeVLong(field.numTerms);
        out.writeVLong(field.termsStartPointer);
        if (!field.fieldInfo.omitTermFreqAndPositions) {
          out.writeVLong(field.sumTotalTermFreq);
        }
      }
    }
    writeTrailer(dirStart);
  }
  finally {
    try {
      out.close();
    }
  finally {
      try {
        postingsWriter.close();
      }
  finally {
        termsIndexWriter.close();
      }
    }
  }
}
