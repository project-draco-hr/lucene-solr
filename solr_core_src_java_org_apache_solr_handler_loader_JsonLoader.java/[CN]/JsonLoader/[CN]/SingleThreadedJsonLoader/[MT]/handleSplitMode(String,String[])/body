{
  if (split == null)   split="/";
  if (fields == null || fields.length == 0)   fields=new String[]{"/*"};
  final boolean echo="true".equals(req.getParams().get("echo"));
  JsonRecordReader jsonRecordReader=JsonRecordReader.getInst(split,Arrays.asList(fields));
  jsonRecordReader.streamRecords(parser,new JsonRecordReader.Handler(){
    ArrayList docs=null;
    @Override public void handle(    Map<String,Object> record,    String path){
      if (echo) {
        if (docs == null) {
          docs=new ArrayList();
          rsp.add("docs",docs);
        }
        docs.add(record);
      }
 else {
        AddUpdateCommand cmd=new AddUpdateCommand(req);
        cmd.commitWithin=commitWithin;
        cmd.overwrite=overwrite;
        cmd.solrDoc=new SolrInputDocument();
        for (        Map.Entry<String,Object> entry : record.entrySet()) {
          cmd.solrDoc.setField(entry.getKey(),entry.getValue());
        }
        try {
          processor.processAdd(cmd);
        }
 catch (        IOException e) {
          throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,"error inserting doc",e);
        }
      }
    }
  }
);
}
