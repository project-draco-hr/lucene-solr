{
  checkOpen(true);
  checkReadOnly();
  if (rec == null || rec.size() == 0) {
    return;
  }
  if (primaryKeyName == null) {
    primaryKeyName=rec.keySet().iterator().next();
  }
  Object pk=rec.get(primaryKeyName);
  if (pk instanceof Collection<?>) {
    Collection<Object> c=(Collection<Object>)pk;
    if (c.size() != 1) {
      throw new RuntimeException("The primary key must have exactly 1 element.");
    }
    pk=c.iterator().next();
  }
  if (pk == null) {
    return;
  }
  List<Map<String,Object>> thisKeysRecs=theMap.get(pk);
  if (thisKeysRecs == null) {
    thisKeysRecs=new ArrayList<Map<String,Object>>();
    theMap.put(pk,thisKeysRecs);
  }
  thisKeysRecs.add(rec);
}
