{
  Directory dir=newDirectory();
  if (dir instanceof MockDirectoryWrapper) {
    ((MockDirectoryWrapper)dir).setEnableVirusScanner(false);
  }
  IndexWriterConfig iwConf=newIndexWriterConfig(new MockAnalyzer(random()));
  iwConf.setMaxBufferedDocs(RandomInts.randomIntBetween(random(),2,30));
  iwConf.setCodec(CompressingCodec.randomInstance(random()));
  iwConf.setMergePolicy(newLogMergePolicy(false));
  iwConf.setUseCompoundFile(false);
  IndexWriter iw=new IndexWriter(dir,iwConf);
  final Document validDoc=new Document();
  validDoc.add(new IntPoint("id",0));
  validDoc.add(new StoredField("id",0));
  iw.addDocument(validDoc);
  iw.commit();
  final Document invalidDoc=new Document();
  FieldType fieldType=new FieldType();
  fieldType.setStored(true);
  invalidDoc.add(new Field("invalid",fieldType){
    @Override public String stringValue(){
      return null;
    }
  }
);
  try {
    iw.addDocument(invalidDoc);
    iw.commit();
  }
 catch (  IllegalArgumentException iae) {
    assertEquals(iae,iw.getTragicException());
  }
  assertFalse(iw.isOpen());
  dir.close();
}
