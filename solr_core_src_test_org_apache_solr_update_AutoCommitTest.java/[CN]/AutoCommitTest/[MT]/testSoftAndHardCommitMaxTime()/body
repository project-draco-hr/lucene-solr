{
  SolrCore core=h.getCore();
  NewSearcherListener softTrigger=new NewSearcherListener(TriggerOn.Soft);
  NewSearcherListener hardTrigger=new NewSearcherListener(TriggerOn.Hard);
  core.registerNewSearcherListener(softTrigger);
  core.registerNewSearcherListener(hardTrigger);
  DirectUpdateHandler2 updater=(DirectUpdateHandler2)core.getUpdateHandler();
  updater.registerCommitCallback(softTrigger);
  updater.registerSoftCommitCallback(softTrigger);
  updater.registerCommitCallback(hardTrigger);
  updater.registerSoftCommitCallback(hardTrigger);
  CommitTracker hardTracker=updater.commitTracker;
  CommitTracker softTracker=updater.softCommitTracker;
  softTracker.setTimeUpperBound(300);
  softTracker.setDocsUpperBound(-1);
  hardTracker.setTimeUpperBound(1200);
  hardTracker.setDocsUpperBound(-1);
  XmlUpdateRequestHandler handler=new XmlUpdateRequestHandler();
  handler.init(null);
  MapSolrParams params=new MapSolrParams(new HashMap<String,String>());
  SolrQueryResponse rsp=new SolrQueryResponse();
  SolrQueryRequestBase req=new SolrQueryRequestBase(core,params){
  }
;
  req.setContentStreams(toContentStreams(adoc("id","529","field_t","what's inside?","subject","info"),null));
  handler.handleRequest(req,rsp);
  assertQ("shouldn't find any",req("id:529"),"//result[@numFound=0]");
  assertTrue(softTrigger.waitForNewSearcher(30000));
  softTrigger.reset();
  req.setContentStreams(toContentStreams(adoc("id","530","field_t","what's inside?","subject","info"),null));
  handler.handleRequest(req,rsp);
  assertQ("should find one",req("id:529"),"//result[@numFound=1]");
  assertQ("should find none",req("id:530"),"//result[@numFound=0]");
  assertU(delI("529"));
  assertQ("deleted, but should still be there",req("id:529"),"//result[@numFound=1]");
  assertTrue(softTrigger.waitForNewSearcher(15000));
  softTrigger.reset();
  req.setContentStreams(toContentStreams(adoc("id","550","field_t","what's inside?","subject","info"),null));
  handler.handleRequest(req,rsp);
  int totalCommits=softTracker.getCommitCount() + hardTracker.getCommitCount();
  assertTrue("expected:>=2 but got " + totalCommits,totalCommits >= 2);
  assertQ("deleted and time has passed",req("id:529"),"//result[@numFound=0]");
  req.setContentStreams(toContentStreams(adoc("id","500"),null));
  for (int i=0; i < 5; i++) {
    handler.handleRequest(req,rsp);
  }
  assertQ("should not be there yet",req("id:500"),"//result[@numFound=0]");
  assertTrue(softTrigger.waitForNewSearcher(15000));
  softTrigger.reset();
  req.setContentStreams(toContentStreams(adoc("id","531","field_t","what's inside?","subject","info"),null));
  handler.handleRequest(req,rsp);
  int softCommitCnt=softTracker.getCommitCount();
  assertTrue("commit cnt:" + softCommitCnt,softCommitCnt == 2 || softCommitCnt == 3);
  assertTrue(hardTrigger.waitForNewSearcher(15000));
  hardTrigger.reset();
  int hardCommitCnt=hardTracker.getCommitCount();
  assertTrue("commit cnt:" + hardCommitCnt,hardCommitCnt == 1 || hardCommitCnt == 2);
  assertTrue(softTrigger.waitForNewSearcher(15000));
  softTrigger.reset();
  assertQ("now it should",req("id:500"),"//result[@numFound=1]");
  assertQ("but not this",req("id:531"),"//result[@numFound=1]");
}
