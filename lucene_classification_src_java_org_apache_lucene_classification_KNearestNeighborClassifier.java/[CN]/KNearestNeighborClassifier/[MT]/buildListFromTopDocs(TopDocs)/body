{
  Map<BytesRef,Integer> classCounts=new HashMap<>();
  Map<BytesRef,Double> classBoosts=new HashMap<>();
  float maxScore=topDocs.getMaxScore();
  for (  ScoreDoc scoreDoc : topDocs.scoreDocs) {
    IndexableField storableField=indexSearcher.doc(scoreDoc.doc).getField(classFieldName);
    if (storableField != null) {
      BytesRef cl=new BytesRef(storableField.stringValue());
      Integer count=classCounts.get(cl);
      if (count != null) {
        classCounts.put(cl,count + 1);
      }
 else {
        classCounts.put(cl,1);
      }
      Double totalBoost=classBoosts.get(cl);
      double singleBoost=scoreDoc.score / maxScore;
      if (totalBoost != null) {
        classBoosts.put(cl,totalBoost + singleBoost);
      }
 else {
        classBoosts.put(cl,singleBoost);
      }
    }
  }
  List<ClassificationResult<BytesRef>> returnList=new ArrayList<>();
  List<ClassificationResult<BytesRef>> temporaryList=new ArrayList<>();
  int sumdoc=0;
  for (  Map.Entry<BytesRef,Integer> entry : classCounts.entrySet()) {
    Integer count=entry.getValue();
    Double normBoost=classBoosts.get(entry.getKey()) / count;
    temporaryList.add(new ClassificationResult<>(entry.getKey().clone(),(count * normBoost) / (double)k));
    sumdoc+=count;
  }
  if (sumdoc < k) {
    for (    ClassificationResult<BytesRef> cr : temporaryList) {
      returnList.add(new ClassificationResult<>(cr.getAssignedClass(),cr.getScore() * k / (double)sumdoc));
    }
  }
 else {
    returnList=temporaryList;
  }
  return returnList;
}
