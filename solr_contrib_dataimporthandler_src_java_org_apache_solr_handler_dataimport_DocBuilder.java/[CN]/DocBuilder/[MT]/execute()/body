{
  List<EntityProcessorWrapper> epwList=null;
  try {
    dataImporter.store(DataImporter.STATUS_MSGS,statusMessages);
    config=dataImporter.getConfig();
    final AtomicLong startTime=new AtomicLong(System.currentTimeMillis());
    statusMessages.put(TIME_ELAPSED,new Object(){
      @Override public String toString(){
        return getTimeElapsedSince(startTime.get());
      }
    }
);
    statusMessages.put(DataImporter.MSG.TOTAL_QUERIES_EXECUTED,importStatistics.queryCount);
    statusMessages.put(DataImporter.MSG.TOTAL_ROWS_EXECUTED,importStatistics.rowsCount);
    statusMessages.put(DataImporter.MSG.TOTAL_DOC_PROCESSED,importStatistics.docCount);
    statusMessages.put(DataImporter.MSG.TOTAL_DOCS_SKIPPED,importStatistics.skipDocCount);
    List<String> entities=reqParams.getEntitiesToRun();
    if (config.getOnImportStart() != null) {
      invokeEventListener(config.getOnImportStart());
    }
    AtomicBoolean fullCleanDone=new AtomicBoolean(false);
    Map<String,Object> lastIndexTimeProps=new HashMap<String,Object>();
    lastIndexTimeProps.put(LAST_INDEX_KEY,dataImporter.getIndexStartTime());
    epwList=new ArrayList<EntityProcessorWrapper>(config.getEntities().size());
    for (    Entity e : config.getEntities()) {
      epwList.add(getEntityProcessorWrapper(e));
    }
    for (    EntityProcessorWrapper epw : epwList) {
      if (entities != null && !entities.contains(epw.getEntity().getName()))       continue;
      lastIndexTimeProps.put(epw.getEntity().getName() + "." + LAST_INDEX_KEY,propWriter.getCurrentTimestamp());
      currentEntityProcessorWrapper=epw;
      String delQuery=epw.getEntity().getAllAttributes().get("preImportDeleteQuery");
      if (dataImporter.getStatus() == DataImporter.Status.RUNNING_DELTA_DUMP) {
        cleanByQuery(delQuery,fullCleanDone);
        doDelta();
        delQuery=epw.getEntity().getAllAttributes().get("postImportDeleteQuery");
        if (delQuery != null) {
          fullCleanDone.set(false);
          cleanByQuery(delQuery,fullCleanDone);
        }
      }
 else {
        cleanByQuery(delQuery,fullCleanDone);
        doFullDump();
        delQuery=epw.getEntity().getAllAttributes().get("postImportDeleteQuery");
        if (delQuery != null) {
          fullCleanDone.set(false);
          cleanByQuery(delQuery,fullCleanDone);
        }
      }
      statusMessages.remove(DataImporter.MSG.TOTAL_DOC_PROCESSED);
    }
    if (stop.get()) {
      statusMessages.put("Aborted",new SimpleDateFormat("yyyy-MM-dd HH:mm:ss",Locale.ROOT).format(new Date()));
      rollback();
    }
 else {
      if (!reqParams.isClean()) {
        if (importStatistics.docCount.get() > 0 || importStatistics.deletedDocCount.get() > 0) {
          finish(lastIndexTimeProps);
        }
      }
 else {
        finish(lastIndexTimeProps);
      }
      if (config.getOnImportEnd() != null) {
        invokeEventListener(config.getOnImportEnd());
      }
    }
    statusMessages.remove(TIME_ELAPSED);
    statusMessages.put(DataImporter.MSG.TOTAL_DOC_PROCESSED,"" + importStatistics.docCount.get());
    if (importStatistics.failedDocCount.get() > 0)     statusMessages.put(DataImporter.MSG.TOTAL_FAILED_DOCS,"" + importStatistics.failedDocCount.get());
    statusMessages.put("Time taken",getTimeElapsedSince(startTime.get()));
    LOG.info("Time taken = " + getTimeElapsedSince(startTime.get()));
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
 finally {
    if (writer != null) {
      writer.close();
    }
    if (epwList != null) {
      closeEntityProcessorWrappers(epwList);
    }
    if (reqParams.isDebug()) {
      reqParams.getDebugInfo().debugVerboseOutput=getDebugLogger().output;
    }
  }
}
