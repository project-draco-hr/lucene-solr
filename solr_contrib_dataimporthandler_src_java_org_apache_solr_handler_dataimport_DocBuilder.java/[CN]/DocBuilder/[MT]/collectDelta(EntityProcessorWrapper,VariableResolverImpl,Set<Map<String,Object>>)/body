{
  if (stop.get())   return new HashSet();
  ContextImpl context1=new ContextImpl(epw,resolver,null,Context.FIND_DELTA,session,null,this);
  epw.init(context1);
  Set<Map<String,Object>> myModifiedPks=new HashSet<Map<String,Object>>();
  for (  EntityProcessorWrapper childEpw : epw.getChildren()) {
    myModifiedPks.addAll(collectDelta(childEpw,resolver,deletedRows));
    if (stop.get())     return new HashSet();
  }
  Map<String,Map<String,Object>> deltaSet=new HashMap<String,Map<String,Object>>();
  LOG.info("Running ModifiedRowKey() for Entity: " + epw.getEntity().getName());
  String pk=epw.getEntity().getPk();
  while (true) {
    Map<String,Object> row=epw.nextModifiedRowKey();
    if (row == null)     break;
    Object pkValue=row.get(pk);
    if (pkValue == null) {
      pk=findMatchingPkColumn(pk,row);
      pkValue=row.get(pk);
    }
    deltaSet.put(pkValue.toString(),row);
    importStatistics.rowsCount.incrementAndGet();
    if (stop.get())     return new HashSet();
  }
  Set<Map<String,Object>> deletedSet=new HashSet<Map<String,Object>>();
  while (true) {
    Map<String,Object> row=epw.nextDeletedRowKey();
    if (row == null)     break;
    deletedSet.add(row);
    Object pkValue=row.get(pk);
    if (pkValue == null) {
      pk=findMatchingPkColumn(pk,row);
      pkValue=row.get(pk);
    }
    String deletedRowPk=pkValue.toString();
    if (deltaSet.containsKey(deletedRowPk)) {
      deltaSet.remove(deletedRowPk);
    }
    importStatistics.rowsCount.incrementAndGet();
    if (stop.get())     return new HashSet();
  }
  LOG.info("Completed ModifiedRowKey for Entity: " + epw.getEntity().getName() + " rows obtained : "+ deltaSet.size());
  LOG.info("Completed DeletedRowKey for Entity: " + epw.getEntity().getName() + " rows obtained : "+ deletedSet.size());
  myModifiedPks.addAll(deltaSet.values());
  Set<Map<String,Object>> parentKeyList=new HashSet<Map<String,Object>>();
  if (epw.getEntity().getParentEntity() != null) {
    for (    Map<String,Object> row : myModifiedPks) {
      getModifiedParentRows(resolver.addNamespace(epw.getEntity().getName(),row),epw.getEntity().getName(),epw,parentKeyList);
      if (stop.get())       return new HashSet();
    }
    for (    Map<String,Object> row : deletedSet) {
      getModifiedParentRows(resolver.addNamespace(epw.getEntity().getName(),row),epw.getEntity().getName(),epw,parentKeyList);
      if (stop.get())       return new HashSet();
    }
  }
  LOG.info("Completed parentDeltaQuery for Entity: " + epw.getEntity().getName());
  if (epw.getEntity().isDocRoot())   deletedRows.addAll(deletedSet);
  return epw.getEntity().getParentEntity() == null ? myModifiedPks : new HashSet<Map<String,Object>>(parentKeyList);
}
