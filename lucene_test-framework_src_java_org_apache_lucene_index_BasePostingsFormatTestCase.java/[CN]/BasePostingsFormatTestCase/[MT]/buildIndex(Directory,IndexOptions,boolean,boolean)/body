{
  Codec codec=getCodec();
  SegmentInfo segmentInfo=new SegmentInfo(dir,Constants.LUCENE_MAIN_VERSION,"_0",maxDoc,false,codec,null);
  int maxIndexOption=Arrays.asList(IndexOptions.values()).indexOf(maxAllowed);
  if (VERBOSE) {
    System.out.println("\nTEST: now build index");
  }
  int maxIndexOptionNoOffsets=Arrays.asList(IndexOptions.values()).indexOf(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
  FieldInfo[] newFieldInfoArray=new FieldInfo[fields.size()];
  for (int fieldUpto=0; fieldUpto < fields.size(); fieldUpto++) {
    FieldInfo oldFieldInfo=fieldInfos.fieldInfo(fieldUpto);
    String pf=_TestUtil.getPostingsFormat(codec,oldFieldInfo.name);
    int fieldMaxIndexOption;
    if (doesntSupportOffsets.contains(pf)) {
      fieldMaxIndexOption=Math.min(maxIndexOptionNoOffsets,maxIndexOption);
    }
 else {
      fieldMaxIndexOption=maxIndexOption;
    }
    IndexOptions indexOptions=IndexOptions.values()[alwaysTestMax ? fieldMaxIndexOption : random().nextInt(1 + fieldMaxIndexOption)];
    boolean doPayloads=indexOptions.compareTo(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS) >= 0 && allowPayloads;
    newFieldInfoArray[fieldUpto]=new FieldInfo(oldFieldInfo.name,true,fieldUpto,false,false,doPayloads,indexOptions,null,DocValuesType.NUMERIC,null);
  }
  FieldInfos newFieldInfos=new FieldInfos(newFieldInfoArray);
  long bytes=totalPostings * 8 + totalPayloadBytes;
  SegmentWriteState writeState=new SegmentWriteState(null,dir,segmentInfo,newFieldInfos,null,new IOContext(new FlushInfo(maxDoc,bytes)));
  Fields seedFields=new SeedFields(fields,newFieldInfos,maxAllowed,allowPayloads);
  codec.postingsFormat().fieldsConsumer(writeState).write(seedFields);
  if (VERBOSE) {
    System.out.println("TEST: after indexing: files=");
    for (    String file : dir.listAll()) {
      System.out.println("  " + file + ": "+ dir.fileLength(file)+ " bytes");
    }
  }
  currentFieldInfos=newFieldInfos;
  SegmentReadState readState=new SegmentReadState(dir,segmentInfo,newFieldInfos,IOContext.READ);
  return codec.postingsFormat().fieldsProducer(readState);
}
