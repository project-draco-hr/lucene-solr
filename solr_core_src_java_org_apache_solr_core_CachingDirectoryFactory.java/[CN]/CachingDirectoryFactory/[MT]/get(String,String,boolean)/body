{
  String fullPath=new File(path).getAbsolutePath();
synchronized (this) {
    CacheValue cacheValue=byPathCache.get(fullPath);
    Directory directory=null;
    if (cacheValue != null) {
      directory=cacheValue.directory;
      if (forceNew) {
        cacheValue.doneWithDir=true;
        if (cacheValue.refCnt == 0) {
          close(cacheValue.directory);
        }
      }
    }
    if (directory == null || forceNew) {
      directory=create(fullPath);
      CacheValue newCacheValue=new CacheValue();
      newCacheValue.directory=directory;
      newCacheValue.path=fullPath;
      injectLockFactory(directory,path,rawLockType);
      byDirectoryCache.put(directory,newCacheValue);
      byPathCache.put(fullPath,newCacheValue);
      log.info("return new directory for " + fullPath + " forceNew:"+ forceNew);
    }
 else {
      cacheValue.refCnt++;
    }
    return directory;
  }
}
