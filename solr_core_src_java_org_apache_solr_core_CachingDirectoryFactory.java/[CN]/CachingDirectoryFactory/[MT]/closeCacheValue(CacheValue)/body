{
  log.info("looking to close " + cacheValue.path + " "+ cacheValue.closeEntries.toString());
  List<CloseListener> listeners=closeListeners.remove(cacheValue.directory);
  if (listeners != null) {
    for (    CloseListener listener : listeners) {
      try {
        listener.preClose();
      }
 catch (      Exception e) {
        SolrException.log(log,"Error executing preClose for directory",e);
      }
    }
  }
  cacheValue.closeCacheValueCalled=true;
  if (cacheValue.deleteOnClose) {
    Collection<CacheValue> values=byPathCache.values();
    Collection<CacheValue> cacheValues=new ArrayList<CacheValue>(values);
    cacheValues.remove(cacheValue);
    for (    CacheValue otherCacheValue : cacheValues) {
      if (isSubPath(cacheValue,otherCacheValue) && !otherCacheValue.closeCacheValueCalled) {
        if (!otherCacheValue.deleteAfterCoreClose && cacheValue.deleteAfterCoreClose) {
          otherCacheValue.deleteAfterCoreClose=true;
        }
        otherCacheValue.removeEntries.addAll(cacheValue.removeEntries);
        otherCacheValue.closeEntries.addAll(cacheValue.closeEntries);
        cacheValue.closeEntries.clear();
        cacheValue.removeEntries.clear();
        return false;
      }
    }
  }
  boolean cl=false;
  for (  CacheValue val : cacheValue.closeEntries) {
    close(val);
    if (val == cacheValue) {
      cl=true;
    }
  }
  for (  CacheValue val : cacheValue.removeEntries) {
    if (!val.deleteAfterCoreClose) {
      log.info("Removing directory before core close: " + val.path);
      try {
        removeDirectory(val);
      }
 catch (      Exception e) {
        SolrException.log(log,"Error removing directory",e);
      }
    }
 else {
      removeEntries.add(val);
    }
  }
  if (listeners != null) {
    for (    CloseListener listener : listeners) {
      try {
        listener.postClose();
      }
 catch (      Exception e) {
        SolrException.log(log,"Error executing postClose for directory",e);
      }
    }
  }
  return cl;
}
