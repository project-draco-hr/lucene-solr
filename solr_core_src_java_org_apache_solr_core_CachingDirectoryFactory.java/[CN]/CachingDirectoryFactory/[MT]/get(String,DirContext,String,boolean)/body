{
  String fullPath=new File(path).getAbsolutePath();
synchronized (this) {
    if (closed) {
      throw new RuntimeException("Already closed");
    }
    final CacheValue cacheValue=byPathCache.get(fullPath);
    Directory directory=null;
    if (cacheValue != null) {
      directory=cacheValue.directory;
      if (forceNew) {
        cacheValue.doneWithDir=true;
        if (cacheValue.refCnt == 0) {
          try {
            cacheValue.refCnt++;
            close(cacheValue.directory);
          }
 catch (          IOException e) {
            SolrException.log(log,"Error closing directory",e);
          }
        }
      }
    }
    if (directory == null || forceNew) {
      directory=create(fullPath,dirContext);
      directory=rateLimit(directory);
      CacheValue newCacheValue=new CacheValue();
      newCacheValue.directory=directory;
      newCacheValue.path=fullPath;
      injectLockFactory(directory,path,rawLockType);
      byDirectoryCache.put(directory,newCacheValue);
      byPathCache.put(fullPath,newCacheValue);
      log.info("return new directory for " + fullPath + " forceNew:"+ forceNew);
    }
 else {
      cacheValue.refCnt++;
    }
    return directory;
  }
}
