{
synchronized (this) {
    if (closed) {
      throw new RuntimeException("Already closed");
    }
    CacheValue cacheValue=byDirectoryCache.get(directory);
    if (cacheValue == null) {
      throw new IllegalArgumentException("Unknown directory: " + directory + " "+ byDirectoryCache);
    }
    log.info("Releasing directory:" + cacheValue.path);
    cacheValue.refCnt--;
    if (cacheValue.refCnt == 0 && cacheValue.doneWithDir) {
      log.info("Closing directory:" + cacheValue.path);
      List<CloseListener> listeners=closeListeners.remove(directory);
      if (listeners != null) {
        for (        CloseListener listener : listeners) {
          listener.preClose();
        }
      }
      try {
        log.info("Closing directory:" + cacheValue.path);
        directory.close();
      }
 catch (      Throwable t) {
        SolrException.log(log,"Error closing directory",t);
      }
      if (listeners != null) {
        for (        CloseListener listener : listeners) {
          listener.postClose();
        }
        closeListeners.remove(directory);
      }
      byDirectoryCache.remove(directory);
      byPathCache.remove(cacheValue.path);
    }
  }
}
