import subprocess
import sys
DIFF_FLAGS = '-ruN'
if ('-skipWhitespace' in sys.argv):
    sys.argv.remove('-skipWhitespace')
    DIFF_FLAGS += 'bBw'
if (len(sys.argv) != 3):
    print 
    print 'Usage: python -u diffSources.py <dir1> <dir2> [-skipWhitespace]'
    print 
    print 'This tool creates an applying patch between two directories.\n\nWhile you could use this to make a committable patch from a branch, that approach loses\nthe svn history from the branch (better to use "svn merge --reintegrate", for example).  This\ndiff output should not be considered "authoritative" from a merging standpoint as it does\nnot reflect what svn will do on merge.\n'
    print 
    sys.exit(0)
p = subprocess.Popen(['diff', DIFF_FLAGS, '-x', '.svn', '-x', 'build', sys.argv[1], sys.argv[2]], shell=False, stdout=subprocess.PIPE)
keep = False
while True:
    l = p.stdout.readline()
    if (l == ''):
        break
    if l.endswith('\r\n'):
        l = l[:(-2)]
    elif l.endswith('\n'):
        l = l[:(-1)]
    if (l.startswith('diff ') or l.startswith('Binary files ')):
        keep = ((l.lower().find('/build/') == (-1)) and (l.lower().startswith('Only in') or ((l.lower().endswith('.java') or l.lower().endswith('.txt') or l.lower().endswith('.xml') or l.lower().endswith('.iml')) and (l.find('/.svn/') == (-1)))))
        if keep:
            print 
            print 
            print l.strip()
    elif keep:
        print l
    elif l.startswith('Only in'):
        print l.strip()
