{
  Automaton automaton=null;
  try {
    final TokenStreamToAutomaton tsta;
    if (preserveSep) {
      tsta=new EscapingTokenStreamToAutomaton((char)SEP_LABEL);
    }
 else {
      tsta=new TokenStreamToAutomaton();
    }
    tsta.setPreservePositionIncrements(preservePositionIncrements);
    tsta.setUnicodeArcs(unicodeAware);
    automaton=tsta.toAutomaton(inputTokenStream);
  }
  finally {
    IOUtils.closeWhileHandlingException(inputTokenStream);
  }
  automaton=replaceSep(automaton,preserveSep,SEP_LABEL);
  return Operations.determinize(automaton,maxGraphExpansions);
}
