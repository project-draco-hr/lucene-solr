{
  if (cmd.groupCommands != null) {
    groupBy(qr,cmd);
    return;
  }
  DocListAndSet out=new DocListAndSet();
  qr.setDocListAndSet(out);
  QueryResultKey key=null;
  int maxDocRequested=cmd.getOffset() + cmd.getLen();
  if (maxDocRequested < 0 || maxDocRequested > maxDoc())   maxDocRequested=maxDoc();
  int supersetMaxDoc=maxDocRequested;
  DocList superset;
  if (queryResultCache != null && cmd.getFilter() == null) {
    key=new QueryResultKey(cmd.getQuery(),cmd.getFilterList(),cmd.getSort(),cmd.getFlags());
    if ((cmd.getFlags() & NO_CHECK_QCACHE) == 0) {
      superset=(DocList)queryResultCache.get(key);
      if (superset != null) {
        if ((cmd.getFlags() & GET_SCORES) == 0 || superset.hasScores()) {
          out.docList=superset.subset(cmd.getOffset(),cmd.getLen());
        }
      }
      if (out.docList != null) {
        if (out.docSet == null && ((cmd.getFlags() & GET_DOCSET) != 0)) {
          if (cmd.getFilterList() == null) {
            out.docSet=getDocSet(cmd.getQuery());
          }
 else {
            List<Query> newList=new ArrayList<Query>(cmd.getFilterList().size() + 1);
            newList.add(cmd.getQuery());
            newList.addAll(cmd.getFilterList());
            out.docSet=getDocSet(newList);
          }
        }
        return;
      }
    }
    if (maxDocRequested < queryResultWindowSize) {
      supersetMaxDoc=queryResultWindowSize;
    }
 else {
      supersetMaxDoc=((maxDocRequested - 1) / queryResultWindowSize + 1) * queryResultWindowSize;
      if (supersetMaxDoc < 0)       supersetMaxDoc=maxDocRequested;
    }
  }
  boolean useFilterCache=false;
  if ((cmd.getFlags() & (GET_SCORES | NO_CHECK_FILTERCACHE)) == 0 && useFilterForSortedQuery && cmd.getSort() != null && filterCache != null) {
    useFilterCache=true;
    SortField[] sfields=cmd.getSort().getSort();
    for (    SortField sf : sfields) {
      if (sf.getType() == SortField.SCORE) {
        useFilterCache=false;
        break;
      }
    }
  }
  if (useFilterCache) {
    if (out.docSet == null) {
      out.docSet=getDocSet(cmd.getQuery(),cmd.getFilter());
      DocSet bigFilt=getDocSet(cmd.getFilterList());
      if (bigFilt != null)       out.docSet=out.docSet.intersection(bigFilt);
    }
    superset=sortDocSet(out.docSet,cmd.getSort(),supersetMaxDoc);
    out.docList=superset.subset(cmd.getOffset(),cmd.getLen());
  }
 else {
    cmd.setSupersetMaxDoc(supersetMaxDoc);
    if ((cmd.getFlags() & GET_DOCSET) != 0) {
      DocSet qDocSet=getDocListAndSetNC(qr,cmd);
      if (qDocSet != null && filterCache != null && !qr.isPartialResults())       filterCache.put(cmd.getQuery(),qDocSet);
    }
 else {
      getDocListNC(qr,cmd);
    }
    superset=out.docList;
    out.docList=superset.subset(cmd.getOffset(),cmd.getLen());
  }
  if (key != null && superset.size() <= queryResultMaxDocsCached && !qr.isPartialResults()) {
    queryResultCache.put(key,superset);
  }
}
