{
  boolean inOrder=set instanceof BitDocSet || set instanceof SortedIntDocSet;
  TopDocsCollector topCollector=TopFieldCollector.create(weightSort(sort),nDocs,false,false,false,inOrder);
  DocIterator iter=set.iterator();
  int base=0;
  int end=0;
  int readerIndex=-1;
  AtomicReaderContext leaf=null;
  for (int i=0; i < leafContexts.length; i++) {
    int doc=iter.nextDoc();
    while (doc >= end) {
      leaf=leafContexts[i++];
      base=leaf.docBase;
      end=base + leaf.reader.maxDoc();
      topCollector.setNextReader(leaf);
    }
    topCollector.collect(doc - base);
  }
  TopDocs topDocs=topCollector.topDocs(0,nDocs);
  int nDocsReturned=topDocs.scoreDocs.length;
  int[] ids=new int[nDocsReturned];
  for (int i=0; i < nDocsReturned; i++) {
    ScoreDoc scoreDoc=topDocs.scoreDocs[i];
    ids[i]=scoreDoc.doc;
  }
  return new DocSlice(0,nDocsReturned,ids,null,topDocs.totalHits,0.0f);
}
