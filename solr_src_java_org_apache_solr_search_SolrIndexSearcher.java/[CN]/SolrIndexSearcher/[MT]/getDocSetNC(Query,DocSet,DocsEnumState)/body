{
  if (filter != null)   return getDocSetNC(query,filter,null);
  int smallSetSize=maxDoc() >> 6;
  int largestPossible=deState.termsEnum.docFreq();
  int[] docs=new int[Math.min(smallSetSize,largestPossible)];
  int upto=0;
  int bitsSet=0;
  OpenBitSet obs=null;
  DocsEnum docsEnum=deState.termsEnum.docs(deState.deletedDocs,deState.reuse);
  if (deState.reuse == null) {
    deState.reuse=docsEnum;
  }
  if (docsEnum instanceof MultiDocsEnum) {
    MultiDocsEnum.EnumWithSlice[] subs=((MultiDocsEnum)docsEnum).getSubs();
    int numSubs=((MultiDocsEnum)docsEnum).getNumSubs();
    for (int subindex=0; subindex < numSubs; subindex++) {
      MultiDocsEnum.EnumWithSlice sub=subs[subindex];
      if (sub.docsEnum == null)       continue;
      DocsEnum.BulkReadResult bulk=sub.docsEnum.getBulkResult();
      int base=sub.slice.start;
      for (; ; ) {
        int nDocs=sub.docsEnum.read();
        if (nDocs == 0)         break;
        int[] docArr=bulk.docs.ints;
        int end=bulk.docs.offset + nDocs;
        if (upto + nDocs > docs.length) {
          if (obs == null)           obs=new OpenBitSet(maxDoc());
          for (int i=bulk.docs.offset; i < end; i++) {
            obs.fastSet(docArr[i] + base);
          }
          bitsSet+=nDocs;
        }
 else {
          for (int i=bulk.docs.offset; i < end; i++) {
            docs[upto++]=docArr[i] + base;
          }
        }
      }
    }
  }
 else {
    DocsEnum.BulkReadResult bulk=docsEnum.getBulkResult();
    for (; ; ) {
      int nDocs=docsEnum.read();
      if (nDocs == 0)       break;
      int[] docArr=bulk.docs.ints;
      int end=bulk.docs.offset + nDocs;
      if (upto + nDocs > docs.length) {
        if (obs == null)         obs=new OpenBitSet(maxDoc());
        for (int i=bulk.docs.offset; i < end; i++) {
          obs.fastSet(docArr[i]);
        }
        bitsSet+=nDocs;
      }
 else {
        for (int i=bulk.docs.offset; i < end; i++) {
          docs[upto++]=docArr[i];
        }
      }
    }
  }
  if (obs != null) {
    for (int i=0; i < upto; i++) {
      obs.fastSet(docs[i]);
    }
    bitsSet+=upto;
    return new BitDocSet(obs,bitsSet);
  }
  return new SortedIntDocSet(docs,upto);
}
