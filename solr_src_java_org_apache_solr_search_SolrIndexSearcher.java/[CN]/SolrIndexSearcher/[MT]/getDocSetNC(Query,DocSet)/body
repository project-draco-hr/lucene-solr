{
  DocSetCollector collector=new DocSetCollector(maxDoc() >> 6,maxDoc());
  if (filter == null) {
    if (query instanceof TermQuery) {
      Term t=((TermQuery)query).getTerm();
      SolrIndexReader[] readers=reader.getLeafReaders();
      int[] offsets=reader.getLeafOffsets();
      for (int i=0; i < readers.length; i++) {
        SolrIndexReader sir=readers[i];
        int offset=offsets[i];
        collector.setNextReader(sir,offset);
        Fields fields=sir.fields();
        Terms terms=fields.terms(t.field());
        BytesRef termBytes=new BytesRef(t.text());
        Bits skipDocs=sir.getDeletedDocs();
        DocsEnum docsEnum=terms == null ? null : terms.docs(skipDocs,termBytes,null);
        if (docsEnum != null) {
          DocsEnum.BulkReadResult readResult=docsEnum.getBulkResult();
          for (; ; ) {
            int n=docsEnum.read();
            if (n == 0)             break;
            int[] arr=readResult.docs.ints;
            int end=readResult.docs.offset + n;
            for (int j=readResult.docs.offset; j < end; j++) {
              collector.collect(arr[j]);
            }
          }
        }
      }
    }
 else {
      super.search(query,null,collector);
    }
    return collector.getDocSet();
  }
 else {
    Filter luceneFilter=filter.getTopFilter();
    super.search(query,luceneFilter,collector);
    return collector.getDocSet();
  }
}
