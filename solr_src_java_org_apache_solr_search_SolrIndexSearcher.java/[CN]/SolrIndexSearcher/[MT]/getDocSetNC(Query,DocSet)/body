{
  DocSetCollector collector=new DocSetCollector(maxDoc() >> 6,maxDoc());
  if (filter == null) {
    if (query instanceof TermQuery) {
      Term t=((TermQuery)query).getTerm();
      final AtomicReaderContext[] leaves=leafContexts;
      for (int i=0; i < leaves.length; i++) {
        final AtomicReaderContext leaf=leaves[i];
        final IndexReader reader=leaf.reader;
        collector.setNextReader(leaf);
        Fields fields=reader.fields();
        Terms terms=fields.terms(t.field());
        BytesRef termBytes=t.bytes();
        Bits skipDocs=reader.getDeletedDocs();
        DocsEnum docsEnum=terms == null ? null : terms.docs(skipDocs,termBytes,null);
        if (docsEnum != null) {
          DocsEnum.BulkReadResult readResult=docsEnum.getBulkResult();
          for (; ; ) {
            int n=docsEnum.read();
            if (n == 0)             break;
            int[] arr=readResult.docs.ints;
            int end=readResult.docs.offset + n;
            for (int j=readResult.docs.offset; j < end; j++) {
              collector.collect(arr[j]);
            }
          }
        }
      }
    }
 else {
      super.search(query,null,collector);
    }
    return collector.getDocSet();
  }
 else {
    Filter luceneFilter=filter.getTopFilter();
    super.search(query,luceneFilter,collector);
    return collector.getDocSet();
  }
}
