{
  DocList ids=res.docs;
  int sz=ids.size();
  codec.writeTag(JavaBinCodec.ARR,sz);
  if (searcher == null)   searcher=solrQueryRequest.getSearcher();
  if (schema == null)   schema=solrQueryRequest.getSchema();
  DocTransformer transformer=returnFields.getTransformer();
  TransformContext context=new TransformContext();
  context.query=res.query;
  context.wantsScores=returnFields.wantsScore() && ids.hasScores();
  context.req=solrQueryRequest;
  context.searcher=searcher;
  if (transformer != null) {
    transformer.setContext(context);
  }
  Set<String> fnames=returnFields.getLuceneFieldNames();
  context.iterator=ids.iterator();
  for (int i=0; i < sz; i++) {
    int id=context.iterator.nextDoc();
    StoredDocument doc=searcher.doc(id,fnames);
    SolrDocument sdoc=getDoc(doc);
    if (transformer != null) {
      transformer.transform(sdoc,id);
    }
    codec.writeSolrDocument(sdoc);
  }
  if (transformer != null) {
    transformer.setContext(null);
  }
}
