{
  SolrDocument solrDoc=new SolrDocument();
  for (  IndexableField f : doc) {
    String fieldName=f.name();
    if (!returnFields.wantsField(fieldName))     continue;
    SchemaField sf=schema.getFieldOrNull(fieldName);
    FieldType ft=null;
    if (sf != null)     ft=sf.getType();
    Object val;
    if (ft == null) {
      BytesRef bytesRef=f.binaryValue();
      if (bytesRef != null) {
        if (bytesRef.offset == 0 && bytesRef.length == bytesRef.bytes.length) {
          val=bytesRef.bytes;
        }
 else {
          final byte[] bytes=new byte[bytesRef.length];
          val=bytes;
          System.arraycopy(bytesRef.bytes,bytesRef.offset,bytes,0,bytesRef.length);
        }
      }
 else       val=f.stringValue();
    }
 else {
      try {
        if (useFieldObjects && KNOWN_TYPES.contains(ft.getClass())) {
          val=ft.toObject(f);
        }
 else {
          val=ft.toExternal(f);
        }
      }
 catch (      Exception e) {
        LOG.warn("Error reading a field from document : " + solrDoc,e);
        continue;
      }
    }
    if (sf != null && sf.multiValued() && !solrDoc.containsKey(fieldName)) {
      ArrayList l=new ArrayList();
      l.add(val);
      solrDoc.addField(fieldName,l);
    }
 else {
      solrDoc.addField(fieldName,val);
    }
  }
  return solrDoc;
}
