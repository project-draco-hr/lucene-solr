{
  Directory dir=newDirectory();
  populateDocs(random,dir,true);
  verifyPayloadExists(dir,"p",new BytesRef("p1"),NUM_DOCS);
  verifyPayloadExists(dir,"p",new BytesRef("p2"),NUM_DOCS);
  Map<Directory,DirPayloadProcessor> processors=new HashMap<Directory,DirPayloadProcessor>();
  processors.put(dir,new PerTermPayloadProcessor());
  IndexWriter writer=new IndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(MockTokenizer.WHITESPACE,false)));
  writer.setPayloadProcessorProvider(new PerDirPayloadProcessor(processors));
  writer.optimize();
  writer.close();
  verifyPayloadExists(dir,"p",new BytesRef("p1"),0);
  verifyPayloadExists(dir,"p",new BytesRef("p2"),NUM_DOCS);
  dir.close();
}
