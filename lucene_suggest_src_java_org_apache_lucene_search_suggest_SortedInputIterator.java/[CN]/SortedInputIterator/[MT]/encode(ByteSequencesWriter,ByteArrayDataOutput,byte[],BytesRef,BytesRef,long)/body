{
  int requiredLength=spare.length + 8 + ((hasPayloads) ? 2 + payload.length : 0);
  if (requiredLength >= buffer.length) {
    buffer=ArrayUtil.grow(buffer,requiredLength);
  }
  output.reset(buffer);
  output.writeBytes(spare.bytes,spare.offset,spare.length);
  if (hasPayloads) {
    output.writeBytes(payload.bytes,payload.offset,payload.length);
    output.writeShort((short)payload.length);
  }
  output.writeLong(weight);
  writer.write(buffer,0,output.getPosition());
}
