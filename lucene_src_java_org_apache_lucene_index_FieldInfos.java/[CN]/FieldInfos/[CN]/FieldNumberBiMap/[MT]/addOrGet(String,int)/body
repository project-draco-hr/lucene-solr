{
  Integer fieldNumber=nameToNumber.get(fieldName);
  if (fieldNumber == null) {
    final Integer preferredBoxed=Integer.valueOf(preferredFieldNumber);
    if (preferredFieldNumber != -1 && !numberToName.containsKey(preferredBoxed)) {
      fieldNumber=preferredBoxed;
    }
 else {
      while (numberToName.containsKey(++lowestUnassignedFieldNumber)) {
      }
      fieldNumber=lowestUnassignedFieldNumber;
    }
    version++;
    numberToName.put(fieldNumber,fieldName);
    nameToNumber.put(fieldName,fieldNumber);
  }
  return fieldNumber.intValue();
}
