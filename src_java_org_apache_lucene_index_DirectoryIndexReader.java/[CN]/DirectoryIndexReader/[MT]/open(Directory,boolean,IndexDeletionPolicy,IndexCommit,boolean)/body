{
  SegmentInfos.FindSegmentsFile finder=new SegmentInfos.FindSegmentsFile(directory){
    protected Object doBody(    String segmentFileName) throws CorruptIndexException, IOException {
      SegmentInfos infos=new SegmentInfos();
      infos.read(directory,segmentFileName);
      DirectoryIndexReader reader;
      if (infos.size() == 1) {
        reader=SegmentReader.get(readOnly,infos,infos.info(0),false);
      }
 else       if (readOnly) {
        reader=new ReadOnlyMultiSegmentReader(directory,infos,false);
      }
 else {
        reader=new MultiSegmentReader(directory,infos,false,false);
      }
      reader.setDeletionPolicy(deletionPolicy);
      reader.closeDirectory=closeDirectory;
      return reader;
    }
  }
;
  DirectoryIndexReader reader=null;
  try {
    if (commit == null)     reader=(DirectoryIndexReader)finder.run();
 else {
      if (directory != commit.getDirectory())       throw new IOException("the specified commit does not match the specified Directory");
      reader=(DirectoryIndexReader)finder.doBody(commit.getSegmentsFileName());
    }
  }
  finally {
    if (reader == null && closeDirectory) {
      try {
        directory.close();
      }
 catch (      IOException ioe) {
      }
    }
  }
  return reader;
}
