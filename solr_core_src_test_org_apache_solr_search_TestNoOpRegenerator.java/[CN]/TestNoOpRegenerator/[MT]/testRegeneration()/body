{
  assertU(adoc("id","1"));
  assertU(adoc("id","2"));
  assertU(commit());
  RefCounted<SolrIndexSearcher> ref=h.getCore().getSearcher();
  try {
    SolrIndexSearcher searcher=ref.get();
    assertEquals(2,searcher.maxDoc());
    SolrCache<Object,Object> cache=searcher.getCache("myPerSegmentCache");
    assertEquals(0,cache.size());
    cache.put("key1","value1");
    cache.put("key2","value2");
    assertEquals(2,cache.size());
  }
  finally {
    ref.decref();
  }
  assertU(adoc("id","3"));
  assertU(commit());
  ref=h.getCore().getSearcher();
  try {
    SolrIndexSearcher searcher=ref.get();
    assertEquals(3,searcher.maxDoc());
    SolrCache<Object,Object> cache=searcher.getCache("myPerSegmentCache");
    assertEquals(2,cache.size());
    assertEquals("value1",cache.get("key1"));
    assertEquals("value2",cache.get("key2"));
  }
  finally {
    ref.decref();
  }
}
