{
  if (rb.doFacets) {
    SolrParams params=rb.req.getParams();
    SimpleFacets f=new SimpleFacets(rb.req,rb.getResults().docSet,params,rb);
    NamedList<Object> counts=f.getFacetCounts();
    String[] pivots=params.getParams(FacetParams.FACET_PIVOT);
    if (pivots != null && pivots.length > 0) {
      PivotFacetProcessor pivotProcessor=new PivotFacetProcessor(rb.req,rb.getResults().docSet,params,rb);
      SimpleOrderedMap<List<NamedList<Object>>> v=pivotProcessor.process(pivots);
      if (v != null) {
        counts.add(PIVOT_KEY,v);
      }
    }
    rb.rsp.add("facet_counts",counts);
  }
}
