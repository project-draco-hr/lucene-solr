{
  if (rb.doFacets) {
    ModifiableSolrParams params=new ModifiableSolrParams();
    SolrParams origParams=rb.req.getParams();
    Iterator<String> iter=origParams.getParameterNamesIterator();
    while (iter.hasNext()) {
      String paramName=iter.next();
      if (paramName.startsWith(FacetParams.FACET) == false) {
        params.add(paramName,origParams.getParams(paramName));
        continue;
      }
      HashSet<String> deDupe=new LinkedHashSet<>(Arrays.asList(origParams.getParams(paramName)));
      params.add(paramName,deDupe.toArray(new String[deDupe.size()]));
    }
    SimpleFacets f=new SimpleFacets(rb.req,rb.getResults().docSet,params,rb);
    NamedList<Object> counts=f.getFacetCounts();
    String[] pivots=params.getParams(FacetParams.FACET_PIVOT);
    if (pivots != null && pivots.length > 0) {
      PivotFacetProcessor pivotProcessor=new PivotFacetProcessor(rb.req,rb.getResults().docSet,params,rb);
      SimpleOrderedMap<List<NamedList<Object>>> v=pivotProcessor.process(pivots);
      if (v != null) {
        counts.add(PIVOT_KEY,v);
      }
    }
    rb.rsp.add("facet_counts",counts);
  }
}
