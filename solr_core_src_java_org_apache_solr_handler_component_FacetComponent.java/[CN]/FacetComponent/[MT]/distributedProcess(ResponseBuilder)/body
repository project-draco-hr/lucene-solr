{
  if (!rb.doFacets) {
    return ResponseBuilder.STAGE_DONE;
  }
  if (rb.stage != ResponseBuilder.STAGE_GET_FIELDS) {
    return ResponseBuilder.STAGE_DONE;
  }
  for (int shardNum=0; shardNum < rb.shards.length; shardNum++) {
    List<String> distribFieldFacetRefinements=null;
    for (    DistribFieldFacet dff : rb._facetInfo.facets.values()) {
      if (!dff.needRefinements)       continue;
      List<String> refList=dff._toRefine[shardNum];
      if (refList == null || refList.size() == 0)       continue;
      String key=dff.getKey();
      String termsKey=key + "__terms";
      String termsVal=StrUtils.join(refList,',');
      String facetCommand;
      String termsKeyEncoded=QueryParsing.encodeLocalParamVal(termsKey);
      if (dff.localParams != null) {
        facetCommand=commandPrefix + termsKeyEncoded + " "+ dff.facetStr.substring(2);
      }
 else {
        facetCommand=commandPrefix + termsKeyEncoded + '}'+ dff.field;
      }
      if (distribFieldFacetRefinements == null) {
        distribFieldFacetRefinements=new ArrayList<>();
      }
      distribFieldFacetRefinements.add(facetCommand);
      distribFieldFacetRefinements.add(termsKey);
      distribFieldFacetRefinements.add(termsVal);
    }
    if (distribFieldFacetRefinements != null) {
      String shard=rb.shards[shardNum];
      ShardRequest shardsRefineRequest=null;
      boolean newRequest=false;
      for (      ShardRequest sreq : rb.outgoing) {
        if ((sreq.purpose & ShardRequest.PURPOSE_GET_FIELDS) != 0 && sreq.shards != null && sreq.shards.length == 1 && sreq.shards[0].equals(shard)) {
          shardsRefineRequest=sreq;
          break;
        }
      }
      if (shardsRefineRequest == null) {
        newRequest=true;
        shardsRefineRequest=new ShardRequest();
        shardsRefineRequest.shards=new String[]{rb.shards[shardNum]};
        shardsRefineRequest.params=new ModifiableSolrParams(rb.req.getParams());
        shardsRefineRequest.params.remove(CommonParams.START);
        shardsRefineRequest.params.set(CommonParams.ROWS,"0");
      }
      shardsRefineRequest.purpose|=ShardRequest.PURPOSE_REFINE_FACETS;
      shardsRefineRequest.params.set(FacetParams.FACET,"true");
      removeMainFacetTypeParams(shardsRefineRequest);
      for (int i=0; i < distribFieldFacetRefinements.size(); ) {
        String facetCommand=distribFieldFacetRefinements.get(i++);
        String termsKey=distribFieldFacetRefinements.get(i++);
        String termsVal=distribFieldFacetRefinements.get(i++);
        shardsRefineRequest.params.add(FacetParams.FACET_FIELD,facetCommand);
        shardsRefineRequest.params.set(termsKey,termsVal);
      }
      if (newRequest) {
        rb.addRequest(this,shardsRefineRequest);
      }
    }
    if (doAnyPivotFacetRefinementRequestsExistForShard(rb._facetInfo,shardNum)) {
      enqueuePivotFacetShardRequests(rb,shardNum);
    }
  }
  return ResponseBuilder.STAGE_DONE;
}
