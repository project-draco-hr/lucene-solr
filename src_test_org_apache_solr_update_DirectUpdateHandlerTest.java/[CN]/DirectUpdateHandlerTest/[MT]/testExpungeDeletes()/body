{
  for (int x=0; x < 3000; x++) {
    addSimpleDoc(x + "");
  }
  SolrCore core=h.getCore();
  UpdateHandler updater=core.getUpdateHandler();
  CommitUpdateCommand cmtCmd=new CommitUpdateCommand(false);
  cmtCmd.waitSearcher=true;
  updater.commit(cmtCmd);
  List<String> todelete=new ArrayList<String>();
  Set<String> segsdel=new HashSet<String>();
  SegmentReader[] sirs=getSegmentReaders(core);
  assertTrue(sirs.length > 6);
  todelete.add(getNthIDTerm(2,sirs[0]));
  segsdel.add(sirs[0].getSegmentName());
  todelete.add(getNthIDTerm(7,sirs[2]));
  segsdel.add(sirs[2].getSegmentName());
  todelete.add(getNthIDTerm(4,sirs[5]));
  segsdel.add(sirs[5].getSegmentName());
  for (  String id : todelete) {
    deleteSimpleDoc(id);
  }
  cmtCmd=new CommitUpdateCommand(false);
  cmtCmd.waitSearcher=true;
  updater.commit(cmtCmd);
  cmtCmd=new CommitUpdateCommand(false);
  cmtCmd.waitSearcher=true;
  cmtCmd.expungeDeletes=true;
  updater.commit(cmtCmd);
  SegmentReader[] sirs2=getSegmentReaders(core);
  assertTrue(sirs.length > sirs2.length);
  for (  SegmentReader sr : sirs2) {
    assertTrue(!segsdel.contains(sr.getSegmentName()));
  }
}
