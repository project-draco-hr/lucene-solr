{
  Directory dir=newDirectory();
  if (dir instanceof MockDirectoryWrapper) {
    ((MockDirectoryWrapper)dir).setEnableVirusScanner(false);
  }
  IndexWriterConfig conf=new IndexWriterConfig(null);
  conf.setIndexDeletionPolicy(new SnapshotDeletionPolicy(conf.getIndexDeletionPolicy()));
  IndexWriter writer=new IndexWriter(dir,conf);
  try {
    writer.addDocument(new Document());
    writer.commit();
    Revision rev1=new IndexRevision(writer);
    rev1.release();
    assertTrue(slowFileExists(dir,IndexFileNames.SEGMENTS + "_1"));
    rev1=new IndexRevision(writer);
    writer.addDocument(new Document());
    writer.commit();
    assertNotNull(new IndexRevision(writer));
    rev1.release();
    assertFalse(slowFileExists(dir,IndexFileNames.SEGMENTS + "_1"));
  }
  finally {
    IOUtils.close(writer,dir);
  }
}
