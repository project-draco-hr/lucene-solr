{
  if (null == core) {
    throw new IllegalStateException("SchemaSimilarityFactory can not be used until SolrCoreAware.inform has been called");
  }
  if (null == similarity) {
    Similarity defaultSim=null;
    if (null == defaultSimFromFieldType) {
      defaultSim=this.core.getSolrConfig().luceneMatchVersion.onOrAfter(Version.LUCENE_6_0_0) ? new BM25Similarity() : new ClassicSimilarity();
    }
 else {
      FieldType defSimFT=core.getLatestSchema().getFieldTypeByName(defaultSimFromFieldType);
      if (null == defSimFT) {
        throw new SolrException(ErrorCode.SERVER_ERROR,"SchemaSimilarityFactory configured with " + INIT_OPT + "='"+ defaultSimFromFieldType+ "' but that <fieldType> does not exist");
      }
      defaultSim=defSimFT.getSimilarity();
      if (null == defaultSim) {
        throw new SolrException(ErrorCode.SERVER_ERROR,"SchemaSimilarityFactory configured with " + INIT_OPT + "='"+ defaultSimFromFieldType+ "' but that <fieldType> does not define a <similarity>");
      }
    }
    similarity=new SchemaSimilarity(defaultSim);
  }
  return similarity;
}
