{
  Directory dir=newDirectory();
  IndexWriterConfig iwc=new IndexWriterConfig(null);
  IndexWriter iw=new IndexWriter(dir,iwc);
  Document doc=new Document();
  Token token1=new Token("bar",0,3);
  token1.setPayload(new BytesRef("pay1"));
  Token token2=new Token("bar",4,7);
  token2.setPayload(new BytesRef("pay2"));
  FieldType ft=new FieldType(TextField.TYPE_NOT_STORED);
  ft.setStoreTermVectors(true);
  ft.setStoreTermVectorPositions(true);
  ft.setStoreTermVectorPayloads(true);
  ft.setStoreTermVectorOffsets(true);
  doc.add(new Field("foo",new CannedTokenStream(token1,token2),ft));
  iw.addDocument(doc);
  DirectoryReader reader=DirectoryReader.open(iw);
  Terms terms=getOnlySegmentReader(reader).getTermVector(0,"foo");
  TermsEnum termsEnum=terms.iterator();
  assertNotNull(termsEnum);
  assertEquals(new BytesRef("bar"),termsEnum.next());
  PostingsEnum postings=termsEnum.postings(null);
  assertEquals(-1,postings.docID());
  assertEquals(0,postings.nextDoc());
  assertEquals(2,postings.freq());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,postings.nextDoc());
  PostingsEnum postings2=termsEnum.postings(postings);
  assertNotNull(postings2);
  assertEquals(-1,postings2.docID());
  assertEquals(0,postings2.nextDoc());
  assertEquals(2,postings2.freq());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,postings2.nextDoc());
  PostingsEnum docsOnly=termsEnum.postings(null,PostingsEnum.NONE);
  assertEquals(-1,docsOnly.docID());
  assertEquals(0,docsOnly.nextDoc());
  assertTrue(docsOnly.freq() == 1 || docsOnly.freq() == 2);
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsOnly.nextDoc());
  PostingsEnum docsOnly2=termsEnum.postings(docsOnly,PostingsEnum.NONE);
  assertNotNull(docsOnly2);
  assertEquals(-1,docsOnly2.docID());
  assertEquals(0,docsOnly2.nextDoc());
  assertTrue(docsOnly2.freq() == 1 || docsOnly2.freq() == 2);
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsOnly2.nextDoc());
  PostingsEnum docsAndPositionsEnum=termsEnum.postings(null,PostingsEnum.POSITIONS);
  assertEquals(-1,docsAndPositionsEnum.docID());
  assertEquals(0,docsAndPositionsEnum.nextDoc());
  assertEquals(2,docsAndPositionsEnum.freq());
  assertEquals(0,docsAndPositionsEnum.nextPosition());
  assertTrue(docsAndPositionsEnum.startOffset() == -1 || docsAndPositionsEnum.startOffset() == 0);
  assertTrue(docsAndPositionsEnum.endOffset() == -1 || docsAndPositionsEnum.endOffset() == 3);
  assertTrue(docsAndPositionsEnum.getPayload() == null || new BytesRef("pay1").equals(docsAndPositionsEnum.getPayload()));
  assertEquals(1,docsAndPositionsEnum.nextPosition());
  assertTrue(docsAndPositionsEnum.startOffset() == -1 || docsAndPositionsEnum.startOffset() == 4);
  assertTrue(docsAndPositionsEnum.endOffset() == -1 || docsAndPositionsEnum.endOffset() == 7);
  assertTrue(docsAndPositionsEnum.getPayload() == null || new BytesRef("pay2").equals(docsAndPositionsEnum.getPayload()));
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum.nextDoc());
  PostingsEnum docsAndPositionsEnum2=termsEnum.postings(docsAndPositionsEnum,PostingsEnum.POSITIONS);
  assertEquals(-1,docsAndPositionsEnum2.docID());
  assertEquals(0,docsAndPositionsEnum2.nextDoc());
  assertEquals(2,docsAndPositionsEnum2.freq());
  assertEquals(0,docsAndPositionsEnum2.nextPosition());
  assertTrue(docsAndPositionsEnum2.startOffset() == -1 || docsAndPositionsEnum2.startOffset() == 0);
  assertTrue(docsAndPositionsEnum2.endOffset() == -1 || docsAndPositionsEnum2.endOffset() == 3);
  assertTrue(docsAndPositionsEnum2.getPayload() == null || new BytesRef("pay1").equals(docsAndPositionsEnum2.getPayload()));
  assertEquals(1,docsAndPositionsEnum2.nextPosition());
  assertTrue(docsAndPositionsEnum2.startOffset() == -1 || docsAndPositionsEnum2.startOffset() == 4);
  assertTrue(docsAndPositionsEnum2.endOffset() == -1 || docsAndPositionsEnum2.endOffset() == 7);
  assertTrue(docsAndPositionsEnum2.getPayload() == null || new BytesRef("pay2").equals(docsAndPositionsEnum2.getPayload()));
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum2.nextDoc());
  docsAndPositionsEnum=termsEnum.postings(null,PostingsEnum.PAYLOADS);
  assertNotNull(docsAndPositionsEnum);
  assertEquals(-1,docsAndPositionsEnum.docID());
  assertEquals(0,docsAndPositionsEnum.nextDoc());
  assertEquals(2,docsAndPositionsEnum.freq());
  assertEquals(0,docsAndPositionsEnum.nextPosition());
  assertTrue(docsAndPositionsEnum.startOffset() == -1 || docsAndPositionsEnum.startOffset() == 0);
  assertTrue(docsAndPositionsEnum.endOffset() == -1 || docsAndPositionsEnum.endOffset() == 3);
  assertEquals(new BytesRef("pay1"),docsAndPositionsEnum.getPayload());
  assertEquals(1,docsAndPositionsEnum.nextPosition());
  assertTrue(docsAndPositionsEnum.startOffset() == -1 || docsAndPositionsEnum.startOffset() == 4);
  assertTrue(docsAndPositionsEnum.endOffset() == -1 || docsAndPositionsEnum.endOffset() == 7);
  assertEquals(new BytesRef("pay2"),docsAndPositionsEnum.getPayload());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum.nextDoc());
  docsAndPositionsEnum2=termsEnum.postings(docsAndPositionsEnum,PostingsEnum.PAYLOADS);
  assertEquals(-1,docsAndPositionsEnum2.docID());
  assertEquals(0,docsAndPositionsEnum2.nextDoc());
  assertEquals(2,docsAndPositionsEnum2.freq());
  assertEquals(0,docsAndPositionsEnum2.nextPosition());
  assertTrue(docsAndPositionsEnum2.startOffset() == -1 || docsAndPositionsEnum2.startOffset() == 0);
  assertTrue(docsAndPositionsEnum2.endOffset() == -1 || docsAndPositionsEnum2.endOffset() == 3);
  assertEquals(new BytesRef("pay1"),docsAndPositionsEnum2.getPayload());
  assertEquals(1,docsAndPositionsEnum2.nextPosition());
  assertTrue(docsAndPositionsEnum2.startOffset() == -1 || docsAndPositionsEnum2.startOffset() == 4);
  assertTrue(docsAndPositionsEnum2.endOffset() == -1 || docsAndPositionsEnum2.endOffset() == 7);
  assertEquals(new BytesRef("pay2"),docsAndPositionsEnum2.getPayload());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum2.nextDoc());
  docsAndPositionsEnum=termsEnum.postings(null,PostingsEnum.OFFSETS);
  assertNotNull(docsAndPositionsEnum);
  assertEquals(-1,docsAndPositionsEnum.docID());
  assertEquals(0,docsAndPositionsEnum.nextDoc());
  assertEquals(2,docsAndPositionsEnum.freq());
  assertEquals(0,docsAndPositionsEnum.nextPosition());
  assertEquals(0,docsAndPositionsEnum.startOffset());
  assertEquals(3,docsAndPositionsEnum.endOffset());
  assertTrue(docsAndPositionsEnum.getPayload() == null || new BytesRef("pay1").equals(docsAndPositionsEnum.getPayload()));
  assertEquals(1,docsAndPositionsEnum.nextPosition());
  assertEquals(4,docsAndPositionsEnum.startOffset());
  assertEquals(7,docsAndPositionsEnum.endOffset());
  assertTrue(docsAndPositionsEnum.getPayload() == null || new BytesRef("pay2").equals(docsAndPositionsEnum.getPayload()));
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum.nextDoc());
  docsAndPositionsEnum2=termsEnum.postings(docsAndPositionsEnum,PostingsEnum.OFFSETS);
  assertEquals(-1,docsAndPositionsEnum2.docID());
  assertEquals(0,docsAndPositionsEnum2.nextDoc());
  assertEquals(2,docsAndPositionsEnum2.freq());
  assertEquals(0,docsAndPositionsEnum2.nextPosition());
  assertEquals(0,docsAndPositionsEnum2.startOffset());
  assertEquals(3,docsAndPositionsEnum2.endOffset());
  assertTrue(docsAndPositionsEnum2.getPayload() == null || new BytesRef("pay1").equals(docsAndPositionsEnum2.getPayload()));
  assertEquals(1,docsAndPositionsEnum2.nextPosition());
  assertEquals(4,docsAndPositionsEnum2.startOffset());
  assertEquals(7,docsAndPositionsEnum2.endOffset());
  assertTrue(docsAndPositionsEnum2.getPayload() == null || new BytesRef("pay2").equals(docsAndPositionsEnum2.getPayload()));
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum2.nextDoc());
  docsAndPositionsEnum=termsEnum.postings(null,PostingsEnum.ALL);
  assertNotNull(docsAndPositionsEnum);
  assertEquals(-1,docsAndPositionsEnum.docID());
  assertEquals(0,docsAndPositionsEnum.nextDoc());
  assertEquals(2,docsAndPositionsEnum.freq());
  assertEquals(0,docsAndPositionsEnum.nextPosition());
  assertEquals(0,docsAndPositionsEnum.startOffset());
  assertEquals(3,docsAndPositionsEnum.endOffset());
  assertEquals(new BytesRef("pay1"),docsAndPositionsEnum.getPayload());
  assertEquals(1,docsAndPositionsEnum.nextPosition());
  assertEquals(4,docsAndPositionsEnum.startOffset());
  assertEquals(7,docsAndPositionsEnum.endOffset());
  assertEquals(new BytesRef("pay2"),docsAndPositionsEnum.getPayload());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum.nextDoc());
  docsAndPositionsEnum2=termsEnum.postings(docsAndPositionsEnum,PostingsEnum.ALL);
  assertEquals(-1,docsAndPositionsEnum2.docID());
  assertEquals(0,docsAndPositionsEnum2.nextDoc());
  assertEquals(2,docsAndPositionsEnum2.freq());
  assertEquals(0,docsAndPositionsEnum2.nextPosition());
  assertEquals(0,docsAndPositionsEnum2.startOffset());
  assertEquals(3,docsAndPositionsEnum2.endOffset());
  assertEquals(new BytesRef("pay1"),docsAndPositionsEnum2.getPayload());
  assertEquals(1,docsAndPositionsEnum2.nextPosition());
  assertEquals(4,docsAndPositionsEnum2.startOffset());
  assertEquals(7,docsAndPositionsEnum2.endOffset());
  assertEquals(new BytesRef("pay2"),docsAndPositionsEnum2.getPayload());
  assertEquals(DocIdSetIterator.NO_MORE_DOCS,docsAndPositionsEnum2.nextDoc());
  iw.close();
  reader.close();
  dir.close();
}
