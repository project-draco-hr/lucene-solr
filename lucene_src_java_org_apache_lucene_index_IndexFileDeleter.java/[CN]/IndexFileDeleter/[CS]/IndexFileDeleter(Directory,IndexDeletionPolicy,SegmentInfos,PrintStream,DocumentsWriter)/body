{
  this.docWriter=docWriter;
  this.infoStream=infoStream;
  if (infoStream != null)   message("init: current segments file is \"" + segmentInfos.getCurrentSegmentFileName() + "\"; deletionPolicy="+ policy);
  this.policy=policy;
  this.directory=directory;
  long currentGen=segmentInfos.getGeneration();
  IndexFileNameFilter filter=IndexFileNameFilter.getFilter();
  String[] files=directory.listAll();
  CommitPoint currentCommitPoint=null;
  for (int i=0; i < files.length; i++) {
    String fileName=files[i];
    if (filter.accept(null,fileName) && !fileName.equals(IndexFileNames.SEGMENTS_GEN)) {
      getRefCount(fileName);
      if (fileName.startsWith(IndexFileNames.SEGMENTS)) {
        if (SegmentInfos.generationFromSegmentsFileName(fileName) <= currentGen) {
          if (infoStream != null) {
            message("init: load commit \"" + fileName + "\"");
          }
          SegmentInfos sis=new SegmentInfos();
          try {
            sis.read(directory,fileName);
          }
 catch (          FileNotFoundException e) {
            if (infoStream != null) {
              message("init: hit FileNotFoundException when loading commit \"" + fileName + "\"; skipping this commit point");
            }
            sis=null;
          }
          if (sis != null) {
            CommitPoint commitPoint=new CommitPoint(commitsToDelete,directory,sis);
            if (sis.getGeneration() == segmentInfos.getGeneration()) {
              currentCommitPoint=commitPoint;
            }
            commits.add(commitPoint);
            incRef(sis,true);
          }
        }
      }
    }
  }
  if (currentCommitPoint == null) {
    SegmentInfos sis=new SegmentInfos();
    try {
      sis.read(directory,segmentInfos.getCurrentSegmentFileName());
    }
 catch (    IOException e) {
      throw new CorruptIndexException("failed to locate current segments_N file");
    }
    if (infoStream != null)     message("forced open of current segments file " + segmentInfos.getCurrentSegmentFileName());
    currentCommitPoint=new CommitPoint(commitsToDelete,directory,sis);
    commits.add(currentCommitPoint);
    incRef(sis,true);
  }
  Collections.sort(commits);
  for (  Map.Entry<String,RefCount> entry : refCounts.entrySet()) {
    RefCount rc=entry.getValue();
    final String fileName=entry.getKey();
    if (0 == rc.count) {
      if (infoStream != null) {
        message("init: removing unreferenced file \"" + fileName + "\"");
      }
      deleteFile(fileName);
    }
  }
  policy.onInit(commits);
  checkpoint(segmentInfos,false);
  startingCommitDeleted=currentCommitPoint.isDeleted();
  deleteCommits();
}
