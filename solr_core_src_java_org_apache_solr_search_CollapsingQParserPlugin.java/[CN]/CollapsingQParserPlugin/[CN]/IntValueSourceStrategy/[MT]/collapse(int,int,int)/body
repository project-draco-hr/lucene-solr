{
  if (boosts && mergeBoost.boost(globalDoc)) {
    boostDocs.add(globalDoc);
    boostKeys.add(collapseKey);
    return;
  }
  if (needsScores || cscore) {
    this.score=scorer.score();
    this.collapseScore.score=score;
  }
  float currentVal=functionValues.floatVal(contextDoc);
  if (collapseKey != nullValue) {
    final int idx;
    if ((idx=cmap.indexOf(collapseKey)) >= 0) {
      int pointer=cmap.indexGet(idx);
      if (comp.test(currentVal,testValues[pointer])) {
        testValues[pointer]=currentVal;
        docs[pointer]=globalDoc;
        if (needsScores) {
          scores[pointer]=score;
        }
      }
    }
 else {
      ++index;
      cmap.put(collapseKey,index);
      if (index == testValues.length) {
        testValues=ArrayUtil.grow(testValues);
        docs=ArrayUtil.grow(docs);
        if (needsScores) {
          scores=ArrayUtil.grow(scores);
        }
      }
      docs[index]=globalDoc;
      testValues[index]=currentVal;
      if (needsScores) {
        scores[index]=score;
      }
    }
  }
 else   if (this.nullPolicy == CollapsingPostFilter.NULL_POLICY_COLLAPSE) {
    if (comp.test(currentVal,nullCompVal)) {
      nullCompVal=currentVal;
      nullDoc=globalDoc;
      if (needsScores) {
        nullScore=scorer.score();
      }
    }
  }
 else   if (this.nullPolicy == CollapsingPostFilter.NULL_POLICY_EXPAND) {
    this.collapsedSet.set(globalDoc);
    if (needsScores) {
      nullScores.add(scorer.score());
    }
  }
}
