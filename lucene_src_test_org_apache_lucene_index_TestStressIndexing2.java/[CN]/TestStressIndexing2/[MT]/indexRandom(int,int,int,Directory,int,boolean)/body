{
  Map<String,Document> docs=new HashMap<String,Document>();
  IndexWriter w=new MockIndexWriter(dir,newIndexWriterConfig(TEST_VERSION_CURRENT,new MockAnalyzer(random)).setOpenMode(OpenMode.CREATE).setRAMBufferSizeMB(0.1).setMaxBufferedDocs(maxBufferedDocs).setIndexerThreadPool(new ThreadAffinityDocumentsWriterThreadPool(maxThreadStates)).setReaderPooling(doReaderPooling).setMergePolicy(newLogMergePolicy()));
  w.setInfoStream(VERBOSE ? System.out : null);
  LogMergePolicy lmp=(LogMergePolicy)w.getConfig().getMergePolicy();
  lmp.setUseCompoundFile(false);
  lmp.setMergeFactor(mergeFactor);
  threads=new IndexingThread[nThreads];
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=new IndexingThread();
    th.w=w;
    th.base=1000000 * i;
    th.range=range;
    th.iterations=iterations;
    threads[i]=th;
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].start();
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].join();
  }
  w.close();
  for (int i=0; i < threads.length; i++) {
    IndexingThread th=threads[i];
synchronized (th) {
      docs.putAll(th.docs);
    }
  }
  _TestUtil.checkIndex(dir);
  return docs;
}
