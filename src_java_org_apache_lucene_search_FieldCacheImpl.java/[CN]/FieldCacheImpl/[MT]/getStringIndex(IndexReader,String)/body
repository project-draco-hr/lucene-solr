{
  field=field.intern();
  Object ret=lookup(reader,field,STRING_INDEX);
  if (ret == null) {
    final int[] retArray=new int[reader.maxDoc()];
    String[] mterms=new String[reader.maxDoc()];
    if (retArray.length > 0) {
      TermDocs termDocs=reader.termDocs();
      TermEnum termEnum=reader.terms(new Term(field,""));
      int t=0;
      try {
        if (termEnum.term() == null) {
          throw new RuntimeException("no terms in field " + field);
        }
        do {
          Term term=termEnum.term();
          if (term.field() != field)           break;
          if (t >= mterms.length)           throw new RuntimeException("there are more terms than documents in field \"" + field + "\"");
          mterms[t]=term.text();
          termDocs.seek(termEnum);
          while (termDocs.next()) {
            retArray[termDocs.doc()]=t;
          }
          t++;
        }
 while (termEnum.next());
      }
  finally {
        termDocs.close();
        termEnum.close();
      }
      if (t == 0) {
        mterms=new String[1];
      }
 else       if (t < mterms.length) {
        String[] terms=new String[t];
        System.arraycopy(mterms,0,terms,0,t);
        mterms=terms;
      }
    }
    StringIndex value=new StringIndex(retArray,mterms);
    store(reader,field,STRING_INDEX,value);
    return value;
  }
  return (StringIndex)ret;
}
