{
  int domainSize=fcontext.base.size();
  if (nTerms <= 0 || domainSize < effectiveMincount) {
    return;
  }
  boolean countOnly=collectAcc == null && allBucketsAcc == null;
  boolean fullRange=startTermIndex == 0 && endTermIndex == si.getValueCount();
  long domainMultiplier=multiValuedField ? 4L : 2L;
  boolean manyHitsPerBucket=domainSize * domainMultiplier > (si.getValueCount() + 3);
  boolean canDoPerSeg=countOnly && fullRange;
  boolean accumSeg=manyHitsPerBucket && canDoPerSeg;
  if (freq.perSeg != null)   accumSeg=canDoPerSeg && freq.perSeg;
  final List<LeafReaderContext> leaves=fcontext.searcher.getIndexReader().leaves();
  Filter filter=fcontext.base.getTopFilter();
  for (int subIdx=0; subIdx < leaves.size(); subIdx++) {
    LeafReaderContext subCtx=leaves.get(subIdx);
    setNextReaderFirstPhase(subCtx);
    DocIdSet dis=filter.getDocIdSet(subCtx,null);
    DocIdSetIterator disi=dis.iterator();
    SortedDocValues singleDv=null;
    SortedSetDocValues multiDv=null;
    if (multiValuedField) {
      multiDv=subCtx.reader().getSortedSetDocValues(sf.getName());
      if (multiDv == null) {
        multiDv=DocValues.emptySortedSet();
      }
      if (unwrap_singleValued_multiDv) {
        singleDv=DocValues.unwrapSingleton(multiDv);
      }
    }
 else {
      singleDv=subCtx.reader().getSortedDocValues(sf.getName());
      if (singleDv == null) {
        singleDv=DocValues.emptySorted();
      }
    }
    LongValues toGlobal=ordinalMap == null ? null : ordinalMap.getGlobalOrds(subIdx);
    if (singleDv != null) {
      if (accumSeg) {
        collectPerSeg(singleDv,disi,toGlobal);
      }
 else {
        if (canDoPerSeg && toGlobal != null) {
          collectCounts(singleDv,disi,toGlobal);
        }
 else {
          collectDocs(singleDv,disi,toGlobal);
        }
      }
    }
 else {
      if (accumSeg) {
        collectPerSeg(multiDv,disi,toGlobal);
      }
 else {
        if (canDoPerSeg && toGlobal != null) {
          collectCounts(multiDv,disi,toGlobal);
        }
 else {
          collectDocs(multiDv,disi,toGlobal);
        }
      }
    }
  }
  reuse=null;
}
