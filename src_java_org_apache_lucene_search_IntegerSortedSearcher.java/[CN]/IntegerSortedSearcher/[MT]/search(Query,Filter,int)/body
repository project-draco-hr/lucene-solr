{
  Scorer scorer=query.weight(this).scorer(reader);
  if (scorer == null) {
    return new TopDocs(0,new ScoreDoc[0]);
  }
  final BitSet bits=filter != null ? filter.bits(reader) : null;
  final FieldSortedHitQueue hq=new FieldSortedHitQueue(reader,field,nDocs);
  final int[] totalHits=new int[1];
  scorer.score(new HitCollector(){
    public final void collect(    int doc,    float score){
      if (score > 0.0f && (bits == null || bits.get(doc))) {
        totalHits[0]++;
        hq.insert(new ScoreDoc(doc,score));
      }
    }
  }
);
  ScoreDoc[] scoreDocs=new ScoreDoc[hq.size()];
  for (int i=hq.size() - 1; i >= 0; i--) {
    scoreDocs[i]=(ScoreDoc)hq.pop();
  }
  return new TopDocs(totalHits[0],scoreDocs);
}
