{
  try {
    if (!getSchema().isMutable()) {
      final String message="This IndexSchema is not mutable.";
      throw new SolrException(ErrorCode.BAD_REQUEST,message);
    }
 else {
      if (null == entity.getMediaType()) {
        entity.setMediaType(MediaType.APPLICATION_JSON);
      }
      if (!entity.getMediaType().equals(MediaType.APPLICATION_JSON,true)) {
        String message="Only media type " + MediaType.APPLICATION_JSON.toString() + " is accepted."+ "  Request has media type "+ entity.getMediaType().toString()+ ".";
        log.error(message);
        throw new SolrException(ErrorCode.BAD_REQUEST,message);
      }
 else {
        Object object=ObjectBuilder.fromJSON(entity.getText());
        if (!(object instanceof List)) {
          String message="Invalid JSON type " + object.getClass().getName() + ", expected List of the form"+ " (ignore the backslashes): [{\"name\":\"*_foo\",\"type\":\"text_general\", ...}, {...}, ...]";
          log.error(message);
          throw new SolrException(ErrorCode.BAD_REQUEST,message);
        }
 else {
          List<Map<String,Object>> list=(List<Map<String,Object>>)object;
          List<SchemaField> newDynamicFields=new ArrayList<>();
          List<NewFieldArguments> newDynamicFieldArguments=new ArrayList<>();
          ManagedIndexSchema oldSchema=(ManagedIndexSchema)getSchema();
          Map<String,Collection<String>> copyFields=new HashMap<>();
          for (          Map<String,Object> map : list) {
            String fieldNamePattern=(String)map.remove(IndexSchema.NAME);
            if (null == fieldNamePattern) {
              String message="Missing '" + IndexSchema.NAME + "' mapping.";
              log.error(message);
              throw new SolrException(ErrorCode.BAD_REQUEST,message);
            }
            String fieldType=(String)map.remove(IndexSchema.TYPE);
            if (null == fieldType) {
              String message="Missing '" + IndexSchema.TYPE + "' mapping.";
              log.error(message);
              throw new SolrException(ErrorCode.BAD_REQUEST,message);
            }
            Object copies=map.get(IndexSchema.COPY_FIELDS);
            List<String> copyTo=null;
            if (copies != null) {
              if (copies instanceof List) {
                copyTo=(List<String>)copies;
              }
 else               if (copies instanceof String) {
                copyTo=Collections.singletonList(copies.toString());
              }
 else {
                String message="Invalid '" + IndexSchema.COPY_FIELDS + "' type.";
                log.error(message);
                throw new SolrException(ErrorCode.BAD_REQUEST,message);
              }
            }
            if (copyTo != null) {
              map.remove(IndexSchema.COPY_FIELDS);
              copyFields.put(fieldNamePattern,copyTo);
            }
            newDynamicFields.add(oldSchema.newDynamicField(fieldNamePattern,fieldType,map));
            newDynamicFieldArguments.add(new NewFieldArguments(fieldNamePattern,fieldType,map));
          }
          IndexSchema newSchema=null;
          boolean firstAttempt=true;
          boolean success=false;
          while (!success) {
            try {
              if (!firstAttempt) {
                newDynamicFields.clear();
                for (                NewFieldArguments args : newDynamicFieldArguments) {
                  newDynamicFields.add(oldSchema.newDynamicField(args.getName(),args.getType(),args.getMap()));
                }
              }
              firstAttempt=false;
synchronized (oldSchema.getSchemaUpdateLock()) {
                newSchema=oldSchema.addDynamicFields(newDynamicFields,copyFields);
                if (null != newSchema) {
                  getSolrCore().setLatestSchema(newSchema);
                  success=true;
                }
 else {
                  throw new SolrException(ErrorCode.SERVER_ERROR,"Failed to add dynamic fields.");
                }
              }
            }
 catch (            ManagedIndexSchema.SchemaChangedInZkException e) {
              log.debug("Schema changed while processing request, retrying");
              oldSchema=(ManagedIndexSchema)getSolrCore().getLatestSchema();
            }
          }
          waitForSchemaUpdateToPropagate(newSchema);
        }
      }
    }
  }
 catch (  Exception e) {
    getSolrResponse().setException(e);
  }
  handlePostExecution(log);
  return new SolrOutputRepresentation();
}
