{
  LOG.info("Creating backup snapshot " + (snapshotName == null ? "<not named>" : snapshotName) + " at "+ snapDir);
  boolean success=false;
  try {
    NamedList<Object> details=new NamedList<>();
    details.add("startTime",new Date().toString());
    Collection<String> files=indexCommit.getFileNames();
    Directory dir=solrCore.getDirectoryFactory().get(solrCore.getIndexDir(),DirContext.DEFAULT,solrCore.getSolrConfig().indexConfig.lockType);
    try {
      copyFiles(dir,files,snapShotDir);
    }
  finally {
      solrCore.getDirectoryFactory().release(dir);
    }
    details.add("fileCount",files.size());
    details.add("status","success");
    details.add("snapshotCompletedAt",new Date().toString());
    details.add("snapshotName",snapshotName);
    LOG.info("Done creating backup snapshot: " + (snapshotName == null ? "<not named>" : snapshotName) + " at "+ snapDir);
    success=true;
    return details;
  }
  finally {
    if (!success) {
      IndexFetcher.delTree(snapShotDir);
    }
  }
}
