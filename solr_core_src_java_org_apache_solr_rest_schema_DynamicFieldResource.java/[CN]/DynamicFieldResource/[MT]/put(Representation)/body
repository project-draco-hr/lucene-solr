{
  try {
    if (!getSchema().isMutable()) {
      final String message="This IndexSchema is not mutable.";
      throw new SolrException(ErrorCode.BAD_REQUEST,message);
    }
 else {
      if (null == entity.getMediaType()) {
        entity.setMediaType(MediaType.APPLICATION_JSON);
      }
      if (!entity.getMediaType().equals(MediaType.APPLICATION_JSON,true)) {
        String message="Only media type " + MediaType.APPLICATION_JSON.toString() + " is accepted."+ "  Request has media type "+ entity.getMediaType().toString()+ ".";
        log.error(message);
        throw new SolrException(ErrorCode.BAD_REQUEST,message);
      }
 else {
        Object object=ObjectBuilder.fromJSON(entity.getText());
        if (!(object instanceof Map)) {
          String message="Invalid JSON type " + object.getClass().getName() + ", expected Map of the form"+ " (ignore the backslashes): {\"type\":\"text_general\", ...}, either with or"+ " without a \"name\" mapping.  If the \"name\" is specified, it must match the"+ " name given in the request URL: /schema/dynamicfields/(name)";
          log.error(message);
          throw new SolrException(ErrorCode.BAD_REQUEST,message);
        }
 else {
          Map<String,Object> map=(Map<String,Object>)object;
          if (1 == map.size() && map.containsKey(IndexSchema.DYNAMIC_FIELD)) {
            map=(Map<String,Object>)map.get(IndexSchema.DYNAMIC_FIELD);
          }
          String bodyFieldName;
          if (null != (bodyFieldName=(String)map.remove(IndexSchema.NAME)) && !fieldNamePattern.equals(bodyFieldName)) {
            String message="Dynamic field name in the request body '" + bodyFieldName + "' doesn't match dynamic field name in the request URL '"+ fieldNamePattern+ "'";
            log.error(message);
            throw new SolrException(ErrorCode.BAD_REQUEST,message);
          }
 else {
            String fieldType;
            if (null == (fieldType=(String)map.remove(IndexSchema.TYPE))) {
              String message="Missing '" + IndexSchema.TYPE + "' mapping.";
              log.error(message);
              throw new SolrException(ErrorCode.BAD_REQUEST,message);
            }
 else {
              ManagedIndexSchema oldSchema=(ManagedIndexSchema)getSchema();
              Object copies=map.get(IndexSchema.COPY_FIELDS);
              List<String> copyFieldNames=null;
              if (copies != null) {
                if (copies instanceof List) {
                  copyFieldNames=(List<String>)copies;
                }
 else                 if (copies instanceof String) {
                  copyFieldNames=Collections.singletonList(copies.toString());
                }
 else {
                  String message="Invalid '" + IndexSchema.COPY_FIELDS + "' type.";
                  log.error(message);
                  throw new SolrException(ErrorCode.BAD_REQUEST,message);
                }
              }
              if (copyFieldNames != null) {
                map.remove(IndexSchema.COPY_FIELDS);
              }
              IndexSchema newSchema=null;
              boolean success=false;
              while (!success) {
                try {
                  SchemaField newDynamicField=oldSchema.newDynamicField(fieldNamePattern,fieldType,map);
synchronized (oldSchema.getSchemaUpdateLock()) {
                    newSchema=oldSchema.addDynamicField(newDynamicField,copyFieldNames);
                    if (null != newSchema) {
                      getSolrCore().setLatestSchema(newSchema);
                      success=true;
                    }
 else {
                      throw new SolrException(ErrorCode.SERVER_ERROR,"Failed to add dynamic field.");
                    }
                  }
                }
 catch (                ManagedIndexSchema.SchemaChangedInZkException e) {
                  log.debug("Schema changed while processing request, retrying");
                  oldSchema=(ManagedIndexSchema)getSolrCore().getLatestSchema();
                }
              }
              waitForSchemaUpdateToPropagate(newSchema);
            }
          }
        }
      }
    }
  }
 catch (  Exception e) {
    getSolrResponse().setException(e);
  }
  handlePostExecution(log);
  return new SolrOutputRepresentation();
}
